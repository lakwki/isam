using System;
using System.IO;
using System.Linq;
using System.Diagnostics;
using System.Data;
using System.Collections;
using System.Collections.Generic;
using System.Text.RegularExpressions;
using com.next.common.datafactory.model.general;
using com.next.common.datafactory.worker;
using com.next.common.datafactory.worker.industry;
using com.next.infra.persistency.dataaccess;
using com.next.infra.persistency.transactions;
using com.next.isam.dataserver.model.account;
using com.next.isam.domain.types;
using com.next.isam.domain.account;
using com.next.isam.domain.claim;
using com.next.isam.domain.shipping;
using com.next.isam.domain.common;
using com.next.isam.domain.ils;
using com.next.isam.domain.order;
using com.next.isam.domain.product;
using com.next.common.domain.types;
using com.next.common.domain;
using com.next.common.domain.industry.vendor;
using com.next.infra.util;
using com.next.isam.domain.nontrade;
using com.next.common.domain.epicor;
using com.next.isam.dataserver.model.common;

namespace com.next.isam.dataserver.worker
{
    public class AccountWorker : Worker
    {
        private static AccountWorker _instance;
        private GeneralWorker generalWorker;
        private CommonWorker commonWorker;
        private VendorWorker vendorWorker;
        private AdvancePaymentWorker advancePaymentWorker;

        // suggested to disable auto-epicor upload on epicor server. rename groupid for wk53, IS -> IX, RL -> RX
        private static DateTime WK53_FROM_DATE = new DateTime(2021, 1, 24);
        private static DateTime WK53_END_DATE = new DateTime(2021, 1, 30);
        private static DateTime WK53_APPLY_DATE = new DateTime(2021, 1, 24);
        private static bool WK53_HANDLING = false;
        // remind mock shop dn date should be within 52

        private int[] dailySunInterfaceTypeCheckList;
        /*
        private int[] dailySunInterfaceOfficeCheckList;
        */
        decimal totalBaseAmt = 0;
        decimal totalReverseBaseAmt = 0;
        decimal totalFBHKBaseAmt = 0;
        decimal totalFBHKReverseBaseAmt = 0;
        decimal totalFBSHBaseAmt = 0;
        decimal totalFBSHReverseBaseAmt = 0;
        decimal totalFBVNBaseAmt = 0;
        decimal totalFBVNReverseBaseAmt = 0;
        decimal totalHKFBBaseAmt = 0;
        decimal totalHKFBReverseBaseAmt = 0;
        decimal totalSHFBBaseAmt = 0;
        decimal totalSHFBReverseBaseAmt = 0;
        decimal totalVNFBBaseAmt = 0;
        decimal totalVNFBReverseBaseAmt = 0;

        decimal totalDiscountBaseAmt = 0;
        decimal totalReverseDiscountBaseAmt = 0;
        /*
        decimal totalMockShopBaseAmt = 0;
        decimal totalMockShopOtherAmt = 0;
        decimal totalReverseMockShopBaseAmt = 0;
        decimal totalReverseMockShopOtherAmt = 0;
        */
        Hashtable htUniqueKeyList = new Hashtable();
        Hashtable paymentGrpTbl = new Hashtable();
        Hashtable receiptGrpTbl = new Hashtable();
        /*
        Hashtable mockShopSummary = new Hashtable();
        Hashtable reverseMockShopSummary = new Hashtable();
        */
        Hashtable devCostSummary = new Hashtable();

        protected AccountWorker()
        {
            generalWorker = GeneralWorker.Instance;
            commonWorker = CommonWorker.Instance;
            vendorWorker = VendorWorker.Instance;
            advancePaymentWorker = AdvancePaymentWorker.Instance;

            dailySunInterfaceTypeCheckList = new int[4] { 1, 2, 3, 5 };
            /*
            dailySunInterfaceTypeCheckList = new int[6] { 1, 2, 3, 5, 31, 32};
            dailySunInterfaceOfficeCheckList = new int[9] { 1, 2, 3, 4, 7, 8, 9, 13, 14 };
            */
        }

        public static AccountWorker Instance
        {
            get
            {
                if (_instance == null)
                    _instance = new AccountWorker();
                
                return _instance;
            }
        }

        /*
        public void submitDailySunInterfaces(int suninterfaceTypeId, int userId)
        {
            TransactionContext ctx = TransactionContextFactory.GetContext(TransactionAffinity.Required);
            try
            {
                ctx.Enter();
                TransactionContext currentCtx = TransactionContextFactory.GetCurrentContext();
                SunInterfaceQueueDef def = null;

                for (int i = 0; i <= dailySunInterfaceOfficeCheckList.GetUpperBound(0); i++)
                {
                    def = new SunInterfaceQueueDef();
                    def.QueueId = -1;
                    def.Office = generalWorker.getOfficeRefByKey(dailySunInterfaceOfficeCheckList[i]);
                    def.SunInterfaceTypeId = suninterfaceTypeId;
                    def.CategoryType = CategoryType.DAILY;
                    def.User = generalWorker.getUserByKey(userId); 
                    def.SourceId = 1;
                    def.SubmitTime = DateTime.Now;
                    def.FiscalYear = 0;
                    def.Period = 0;
                    def.PurchaseTerm = 0;
                    def.UTurn = 0;
                    this.updateSunInterfaceQueue(def);
                }

                ctx.VoteCommit();
            }
            catch (Exception e)
            {
                Console.WriteLine("ERROR " + e.Message);
                ctx.VoteRollback();
                throw e;
            }
            finally
            {
                ctx.Exit();
            }
        }
        */

        public void createDailySunInterfaceEntries(int shipmentId, int splitShipmentId)
        {
            TransactionContext ctx = TransactionContextFactory.GetContext(TransactionAffinity.Required);
            try
            {
                ctx.Enter();
                TransactionContext currentCtx = TransactionContextFactory.GetCurrentContext();

                IDataSetAdapter ad = getDataSetAdapter("DailySunInterfaceApt", "GetDailySunInterfaceByKey");
                ad.SelectCommand.Parameters["@ShipmentId"].Value = shipmentId;
                ad.SelectCommand.Parameters["@SplitShipmentId"].Value = splitShipmentId;
                ad.SelectCommand.Parameters["@SunInterfaceTypeId"].Value = -1;
                DailySunInterfaceDs dataSet = new DailySunInterfaceDs();
                DailySunInterfaceDs.DailySunInterfaceRow row = null;
                ad.SelectCommand.DbCommand.CommandTimeout = 120;
                ad.PopulateCommands();
                int recordsAffected = ad.Fill(dataSet);

                if (splitShipmentId == 0)
                {
                    for (int i = 0; i <= dailySunInterfaceTypeCheckList.GetUpperBound(0); i++)
                    {
                        row = dataSet.DailySunInterface.NewDailySunInterfaceRow();
                        row.ShipmentId = shipmentId;
                        row.SplitShipmentId = splitShipmentId;
                        row.SunInterfaceTypeId = dailySunInterfaceTypeCheckList[i];
                        row.IsActive = false;
                        row.CreatedOn = DateTime.Now;
                        dataSet.DailySunInterface.AddDailySunInterfaceRow(row);
                    }
                }
                else
                {
                    row = dataSet.DailySunInterface.NewDailySunInterfaceRow();
                    row.ShipmentId = shipmentId;
                    row.SplitShipmentId = splitShipmentId;
                    row.SunInterfaceTypeId = SunInterfaceTypeRef.Id.Purchase.GetHashCode();
                    row.IsActive = false;
                    row.CreatedOn = DateTime.Now;
                    dataSet.DailySunInterface.AddDailySunInterfaceRow(row);

                    row = dataSet.DailySunInterface.NewDailySunInterfaceRow();
                    row.ShipmentId = shipmentId;
                    row.SplitShipmentId = splitShipmentId;
                    row.SunInterfaceTypeId = SunInterfaceTypeRef.Id.AccountPayable.GetHashCode();
                    row.IsActive = false;
                    row.CreatedOn = DateTime.Now;
                    dataSet.DailySunInterface.AddDailySunInterfaceRow(row);
                }
                recordsAffected = ad.Update(dataSet);
                ctx.VoteCommit();
            }
            catch (Exception e)
            {
                Console.WriteLine("ERROR " + e.Message);
                ctx.VoteRollback();
                throw e;
            }
            finally
            {
                ctx.Exit();
            }
        }

        public void createEInvoiceBatch(EInvoiceBatchDef def, int userId)
        {
            TransactionContext ctx = TransactionContextFactory.GetContext(TransactionAffinity.Required);
            try
            {
                ctx.Enter();
                TransactionContext currentCtx = TransactionContextFactory.GetCurrentContext();
                IDataSetAdapter ad = getDataSetAdapter("EInvoiceBatchApt", "GetEInvoiceBatchByKey");
                ad.PopulateCommands();
                EInvoiceBatchDs dataSet = new EInvoiceBatchDs();
                EInvoiceBatchDs.eInvoiceBatchRow row = null;

                row = dataSet.eInvoiceBatch.NeweInvoiceBatchRow();
                def.EInvoiceBatchId = this.getMaxEInvoiceBatchId() + 1;
                this.EInvoiceBatchMapping(def, row);
                sealStamp(row, userId, Stamp.INSERT);
                dataSet.eInvoiceBatch.AddeInvoiceBatchRow(row);
                ad.Update(dataSet);

                ctx.VoteCommit();
            }
            catch (Exception e)
            {
                Console.WriteLine("ERROR " + e.Message);
                ctx.VoteRollback();
                throw e;
            }
            finally
            {
                ctx.Exit();
            }
        }

        private ArrayList getSunInterfaceTypeListByAmendmentTypes(TypeCollector amendmentTypeIdList)
        {
            IDataSetAdapter ad = getDataSetAdapter("SunInterfaceTypeApt", "GetSunInterfaceTypeByAmendmentTypes");
            SunInterfaceTypeDs dataSet = new SunInterfaceTypeDs();

            ad.SelectCommand.CustomParameters["@AmendmentTypeIdList"] = CustomDataParameter.parse(amendmentTypeIdList.IsInclusive, amendmentTypeIdList.Values);
            int recordsAffected = ad.Fill(dataSet);

            ArrayList list = new ArrayList();

            foreach (SunInterfaceTypeDs.SunInterfaceTypeRow row in dataSet.SunInterfaceType)
            {
                SunInterfaceTypeRef def = new SunInterfaceTypeRef();
                def.SunInterfaceTypeId = row.SunInterfaceTypeId;
                def.Description = SunInterfaceTypeRef.getDescription(row.SunInterfaceTypeId);
                list.Add(def);
            }
            return list;
        }

        public ArrayList getLogoInterfaceRequestList()
        {
            IDataSetAdapter ad = getDataSetAdapter("LogoInterfaceRequestApt", "GetLogoInterfaceRequestList");
            LogoInterfaceRequestDs dataSet = new LogoInterfaceRequestDs();

            ad.SelectCommand.DbCommand.CommandTimeout = 120;
            int recordsAffected = ad.Fill(dataSet);

            ArrayList list = new ArrayList();

            foreach (LogoInterfaceRequestDs.LogoInterfaceRequestRow row in dataSet.LogoInterfaceRequest)
            {
                LogoInterfaceRequestDef def = new LogoInterfaceRequestDef();
                LogoInterfaceRequestMapping(row, def);
                list.Add(def);
            }
            return list;
        }

        public ArrayList getSunInterfaceQueueList()
        {
            IDataSetAdapter ad = getDataSetAdapter("SunInterfaceQueueApt", "GetSunInterfaceQueueList");
            SunInterfaceQueueDs dataSet = new SunInterfaceQueueDs();

            ad.SelectCommand.DbCommand.CommandTimeout = 120;
            int recordsAffected = ad.Fill(dataSet);

            ArrayList list = new ArrayList();

            foreach (SunInterfaceQueueDs.SunInterfaceQueueRow row in dataSet.SunInterfaceQueue)
            {
                SunInterfaceQueueDef def = new SunInterfaceQueueDef();
                SunInterfaceQueueMapping(row, def);
                list.Add(def);
            }
            return list;
        }

        public ArrayList getSunInterfaceQueueList(int officeId, int fiscalYear, int period, int sunInterfaceTypeId, int categoryId, int uTurn, int sourceId)
        {
            IDataSetAdapter ad = getDataSetAdapter("SunInterfaceQueueApt", "GetSunInterfaceQueueByCriteria");
            SunInterfaceQueueDs dataSet = new SunInterfaceQueueDs();

            ad.SelectCommand.DbCommand.CommandTimeout = 120;
            ad.SelectCommand.Parameters["@OfficeId"].Value = officeId;
            ad.SelectCommand.Parameters["@FiscalYear"].Value = fiscalYear;
            ad.SelectCommand.Parameters["@Period"].Value = period;
            ad.SelectCommand.Parameters["@CategoryId"].Value = categoryId;
            ad.SelectCommand.Parameters["@SunInterfaceTypeId"].Value = sunInterfaceTypeId;
            ad.SelectCommand.Parameters["@UTurn"].Value = uTurn;
            ad.SelectCommand.Parameters["@SourceId"].Value = sourceId;

            int recordsAffected = ad.Fill(dataSet);

            ArrayList list = new ArrayList();

            foreach (SunInterfaceQueueDs.SunInterfaceQueueRow row in dataSet.SunInterfaceQueue)
            {
                SunInterfaceQueueDef def = new SunInterfaceQueueDef();
                SunInterfaceQueueMapping(row, def);
                list.Add(def);
            }
            return list;
        }

        public ArrayList getRecentSunInterfaceQueueList()
        {
            IDataSetAdapter ad = getDataSetAdapter("SunInterfaceQueueApt", "GetRecentSunInterfaceQueueList");
            SunInterfaceQueueDs dataSet = new SunInterfaceQueueDs();

            ad.SelectCommand.DbCommand.CommandTimeout = 120;
            int recordsAffected = ad.Fill(dataSet);

            ArrayList list = new ArrayList();

            foreach (SunInterfaceQueueDs.SunInterfaceQueueRow row in dataSet.SunInterfaceQueue)
            {
                SunInterfaceQueueDef def = new SunInterfaceQueueDef();
                SunInterfaceQueueMapping(row, def);
                list.Add(def);
            }
            return list;
        }

        public SunInterfaceQueueDef getSunInterfaceQueueByKey(int queueId)
        {
            IDataSetAdapter ad = getDataSetAdapter("SunInterfaceQueueApt", "GetSunInterfaceQueueByKey");
            ad.SelectCommand.Parameters["@QueueId"].Value = queueId;
            SunInterfaceQueueDs dataSet = new SunInterfaceQueueDs();

            ad.SelectCommand.DbCommand.CommandTimeout = 120;
            int recordsAffected = ad.Fill(dataSet);
            if (recordsAffected > 0)
            {
                SunInterfaceQueueDs.SunInterfaceQueueRow row = dataSet.SunInterfaceQueue[0];
                SunInterfaceQueueDef def = new SunInterfaceQueueDef();
                this.SunInterfaceQueueMapping(row, def);
                return def;
            }
            else
                return null;
        }

        public void updateLogoInterfaceRequest(LogoInterfaceRequestDef def)
        {

            TransactionContext ctx = TransactionContextFactory.GetContext(TransactionAffinity.Required);
            try
            {
                ctx.Enter();
                TransactionContext currentCtx = TransactionContextFactory.GetCurrentContext();

                IDataSetAdapter ad = getDataSetAdapter("LogoInterfaceRequestApt", "GetLogoInterfaceRequestByKey");
                ad.SelectCommand.Parameters["@RequestId"].Value = def.RequestId;
                ad.PopulateCommands();

                LogoInterfaceRequestDs dataSet = new LogoInterfaceRequestDs();
                LogoInterfaceRequestDs.LogoInterfaceRequestRow row = null;

                int recordsAffected = ad.Fill(dataSet);
                if (recordsAffected > 0)
                {
                    row = dataSet.LogoInterfaceRequest[0];
                    this.LogoInterfaceRequestMapping(def, row);
                }
                else
                {
                    row = dataSet.LogoInterfaceRequest.NewLogoInterfaceRequestRow();
                    def.RequestId = this.getMaxLogoInterfaceRequestId() + 1;
                    this.LogoInterfaceRequestMapping(def, row);

                    dataSet.LogoInterfaceRequest.AddLogoInterfaceRequestRow(row);
                }
                recordsAffected = ad.Update(dataSet);
                if (recordsAffected < 1)
                    throw new DataAccessException("Update LogoInterfaceRequest ERROR");
                ctx.VoteCommit();

            }
            catch (Exception e)
            {
                Console.WriteLine("ERROR " + e.Message);
                ctx.VoteRollback();
                throw e;
            }
            finally
            {
                ctx.Exit();
            }
        }

        public void updateSunInterfaceQueue(SunInterfaceQueueDef def)
        {
            TransactionContext ctx = TransactionContextFactory.GetContext(TransactionAffinity.Required);
            try
            {
                ctx.Enter();
                TransactionContext currentCtx = TransactionContextFactory.GetCurrentContext();

                IDataSetAdapter ad = getDataSetAdapter("SunInterfaceQueueApt", "GetSunInterfaceQueueByKey");
                ad.SelectCommand.Parameters["@QueueId"].Value = def.QueueId;
                ad.PopulateCommands();

                SunInterfaceQueueDs dataSet = new SunInterfaceQueueDs();
                SunInterfaceQueueDs.SunInterfaceQueueRow row = null;

                int recordsAffected = ad.Fill(dataSet);
                if (recordsAffected > 0)
                {
                    row = dataSet.SunInterfaceQueue[0];
                    this.SunInterfaceQueueMapping(def, row);
                }
                else
                {
                    row = dataSet.SunInterfaceQueue.NewSunInterfaceQueueRow();
                    def.QueueId = this.getMaxQueueId() + 1;
                    this.SunInterfaceQueueMapping(def, row);
                    dataSet.SunInterfaceQueue.AddSunInterfaceQueueRow(row);
                }
                recordsAffected = ad.Update(dataSet);
                if (recordsAffected < 1)
                    throw new DataAccessException("Update Sun Interface Queue ERROR");
                ctx.VoteCommit();
            }
            catch (Exception e)
            {
                Console.WriteLine("ERROR " + e.Message);
                ctx.VoteRollback();
                throw e;
            }
            finally
            {
                ctx.Exit();
            }
        }



        public void markDMSComplete(int officeId)
        {
            TransactionContext ctx = TransactionContextFactory.GetContext(TransactionAffinity.Required);
            try
            {
                ctx.Enter();
                TransactionContext currentCtx = TransactionContextFactory.GetCurrentContext();

                IDataSetAdapter ad = getDataSetAdapter("PaymentStatusEnquiryApt", "MarkDMSComplete");
                ad.SelectCommand.Parameters["@OfficeId"].Value = officeId;
                ad.SelectCommand.ExecuteNonQuery();
                ctx.VoteCommit();
            }
            catch (Exception e)
            {
                Console.WriteLine("ERROR " + e.Message);
                ctx.VoteRollback();
                throw e;
            }
            finally
            {
                ctx.Exit();
            }
        }

        public void updateDailySunInterface(DailySunInterfaceDef def)
        {
            TransactionContext ctx = TransactionContextFactory.GetContext(TransactionAffinity.Required);
            try
            {
                ctx.Enter();
                TransactionContext currentCtx = TransactionContextFactory.GetCurrentContext();

                IDataSetAdapter ad = getDataSetAdapter("DailySunInterfaceApt", "GetDailySunInterfaceByKey");
                ad.SelectCommand.Parameters["@ShipmentId"].Value = def.ShipmentId;
                ad.SelectCommand.Parameters["@SplitShipmentId"].Value = def.SplitShipmentId;
                ad.SelectCommand.Parameters["@SunInterfaceTypeId"].Value = def.SunInterfaceTypeId;
                ad.PopulateCommands();

                DailySunInterfaceDs dataSet = new DailySunInterfaceDs();
                DailySunInterfaceDs.DailySunInterfaceRow row = null;

                int recordsAffected = ad.Fill(dataSet);

                if (recordsAffected > 0)
                {
                    row = dataSet.DailySunInterface[0];
                    row.ShipmentId = def.ShipmentId;
                    row.SplitShipmentId = def.SplitShipmentId;
                    row.SunInterfaceTypeId = def.SunInterfaceTypeId;
                    row.IsActive = def.IsActive;
                    if (def.ExtractedDate != DateTime.MinValue)
                        row.ExtractedDate = def.ExtractedDate;
                    else
                        row.SetExtractedDateNull();
                    row.ModifiedOn = DateTime.Now;
                }
                recordsAffected = ad.Update(dataSet);
                if (recordsAffected < 1)
                    throw new DataAccessException("Update Daily Sun Interface ERROR");
                ctx.VoteCommit();
            }
            catch (Exception e)
            {
                Console.WriteLine("ERROR " + e.Message);
                ctx.VoteRollback();
                throw e;
            }
            finally
            {
                ctx.Exit();
            }
        }

        public ArrayList getBankReconciliationRequestList(int status)
        {
            IDataSetAdapter ad = getDataSetAdapter("BankReconciliationRequestApt", "GetBankReconciliationRequestList");
            BankReconciliationRequestDs dataSet = new BankReconciliationRequestDs();

            ad.SelectCommand.DbCommand.CommandTimeout = 120;
            int recordsAffected = ad.Fill(dataSet);

            ArrayList list = new ArrayList();

            foreach (BankReconciliationRequestDs.BankReconciliationRequestRow row in dataSet.BankReconciliationRequest)
            {
                BankReconciliationRequestDef def = new BankReconciliationRequestDef();
                BankReconciliationRequestMapping(row, def);
                list.Add(def);
            }
            return list;
        }

        public DailySunInterfaceDef getDailySunInterface(int shipmentId, int splitShipmentId, int sunInterfaceTypeId)
        {
            IDataSetAdapter ad = getDataSetAdapter("DailySunInterfaceApt", "GetDailySunInterfaceByKey");
            ad.SelectCommand.Parameters["@ShipmentId"].Value = shipmentId;
            ad.SelectCommand.Parameters["@SplitShipmentId"].Value = splitShipmentId;
            ad.SelectCommand.Parameters["@SunInterfaceTypeId"].Value = sunInterfaceTypeId;

            DailySunInterfaceDs dataSet = new DailySunInterfaceDs();
            int recordsAffected = ad.Fill(dataSet);

            if (recordsAffected < 1) return null;

            DailySunInterfaceDef def = new DailySunInterfaceDef();
            DailySunInterfaceDs.DailySunInterfaceRow row = dataSet.DailySunInterface[0];
            def.ShipmentId = row.ShipmentId;
            def.SplitShipmentId = row.SplitShipmentId;
            def.SunInterfaceTypeId = row.SunInterfaceTypeId;
            def.IsActive = row.IsActive;
            if (!row.IsExtractedDateNull())
                def.ExtractedDate = row.ExtractedDate;
            else
                def.ExtractedDate = DateTime.MinValue;
            return def;
        }

        public bool isSunInterfaceLogExists(int sunInterfaceTypeId, int shipmentId, int splitShipmentId)
        {
            IDataSetAdapter ad = getDataSetAdapter("SunInterfaceLogApt", "GetInterfacedLogByShipmentId");
            ad.SelectCommand.Parameters["@SunInterfaceTypeId"].Value = sunInterfaceTypeId;
            ad.SelectCommand.Parameters["@ShipmentId"].Value = shipmentId;
            ad.SelectCommand.Parameters["@SplitShipmentId"].Value = splitShipmentId;

            SunInterfaceLogDs dataSet = new SunInterfaceLogDs();
            int recordsAffected = ad.Fill(dataSet);

            if (recordsAffected < 1)
                return false;
            else
                return true;
        }

        public string getSupplierInvoiceNoSuffix(string supplierInvoiceNo)
        {
            string s = string.Empty;
            IDataSetAdapter ad = getDataSetAdapter("SunInterfaceLogApt", "GetInterfacedPurchaseBySupplierInvoiceNo");
            ad.SelectCommand.Parameters["@SupplierInvoiceNo"].Value = supplierInvoiceNo;

            SunInterfaceLogDs dataSet = new SunInterfaceLogDs();
            int recordsAffected = ad.Fill(dataSet);

            if (recordsAffected > 1)
                s = "#" + (recordsAffected + 2).ToString();

            return s;
        }

        public SunInterfaceLogDef getReversalLogByShipmentId(int sunInterfaceTypeId, int shipmentId, int splitShipmentId)
        {
            IDataSetAdapter ad = getDataSetAdapter("SunInterfaceLogApt", "GetReversalLogByShipmentId");
            ad.SelectCommand.Parameters["@SunInterfaceTypeId"].Value = sunInterfaceTypeId;
            ad.SelectCommand.Parameters["@ShipmentId"].Value = shipmentId;
            ad.SelectCommand.Parameters["@SplitShipmentId"].Value = splitShipmentId;

            SunInterfaceLogDs dataSet = new SunInterfaceLogDs();
            int recordsAffected = ad.Fill(dataSet);

            if (recordsAffected < 1) return null;

            SunInterfaceLogDef def = new SunInterfaceLogDef();
            this.SunInterfaceLogMapping(dataSet.SunInterfaceLog[0], def);
            return def;
        }

        public ArrayList getReversalLogListByShipmentId(int sunInterfaceTypeId, int shipmentId)
        {
            IDataSetAdapter ad = getDataSetAdapter("SunInterfaceLogApt", "GetReversalLogListByShipmentId");
            ad.SelectCommand.Parameters["@ShipmentId"].Value = shipmentId;
            ad.SelectCommand.Parameters["@SunInterfaceTypeId"].Value = sunInterfaceTypeId;

            SunInterfaceLogDs dataSet = new SunInterfaceLogDs();
            int recordsAffected = ad.Fill(dataSet);

            ArrayList list = new ArrayList();

            foreach (SunInterfaceLogDs.SunInterfaceLogRow row in dataSet.SunInterfaceLog)
            {
                SunInterfaceLogDef def = new SunInterfaceLogDef();
                SunInterfaceLogMapping(row, def);
                list.Add(def);
            }
            return list;
        }

        public SunInterfaceLogDef getReversalLogHistoryByShipmentId(int sunInterfaceTypeId, int shipmentId, int splitShipmentId, int sunInterfaceLogId)
        {
            IDataSetAdapter ad = getDataSetAdapter("SunInterfaceLogApt", "GetReversalLogHistoryByShipmentId");
            ad.SelectCommand.Parameters["@ShipmentId"].Value = shipmentId;
            ad.SelectCommand.Parameters["@SplitShipmentId"].Value = splitShipmentId;
            ad.SelectCommand.Parameters["@SunInterfaceTypeId"].Value = sunInterfaceTypeId;
            ad.SelectCommand.Parameters["@SunInterfaceLogId"].Value = sunInterfaceLogId;

            SunInterfaceLogDs dataSet = new SunInterfaceLogDs();
            int recordsAffected = ad.Fill(dataSet);

            if (recordsAffected < 1) return null;

            SunInterfaceLogDef def = new SunInterfaceLogDef();
            this.SunInterfaceLogMapping(dataSet.SunInterfaceLog[0], def);
            return def;
        }

        public string getReversalSuffix(int sunInterfaceLogId)
        {
            IDataSetAdapter ad = getDataSetAdapter("SunInterfaceLogApt", "GetReversalLogHistory");
            ad.SelectCommand.Parameters["@SunInterfaceLogId"].Value = sunInterfaceLogId;

            SunInterfaceLogDs dataSet = new SunInterfaceLogDs();
            int recordsAffected = ad.Fill(dataSet);

            if (recordsAffected < 1) return "~";
            int i = 0;

            foreach (SunInterfaceLogDs.SunInterfaceLogRow row in dataSet.SunInterfaceLog.Rows)
            {
                if (row.SunInterfaceLogId == sunInterfaceLogId)
                    break;
                i += 1;
            }
            /*
            return i == 0 ? string.Empty : OpenXmlUtil.getColumnLetter(i);
            */
            return i == 0 ? string.Empty : i.ToString();
        }

        public int getReversalSuffixForUKClaimRecharge(int sunInterfaceLogId)
        {
            IDataSetAdapter ad = getDataSetAdapter("SunInterfaceLogApt", "GetReversalLogHistoryForUKClaimRecharge");
            ad.SelectCommand.Parameters["@SunInterfaceLogId"].Value = sunInterfaceLogId;

            SunInterfaceLogDs dataSet = new SunInterfaceLogDs();
            int recordsAffected = ad.Fill(dataSet);

            int i = 1;

            foreach (SunInterfaceLogDs.SunInterfaceLogRow row in dataSet.SunInterfaceLog.Rows)
            {
                if (row.SunInterfaceLogId == sunInterfaceLogId)
                    break;
                i += 1;
            }
            /*
            return i == 0 ? string.Empty : OpenXmlUtil.getColumnLetter(i);
            */
            return i;
        }

        public SunInterfaceLogDef getLatestLogByShipmentId(int sunInterfaceTypeId, int shipmentId, int splitShipmentId)
        {
            IDataSetAdapter ad = getDataSetAdapter("SunInterfaceLogApt", "GetInterfacedLogByShipmentId");
            ad.SelectCommand.Parameters["@ShipmentId"].Value = shipmentId;
            ad.SelectCommand.Parameters["@SplitShipmentId"].Value = splitShipmentId;
            ad.SelectCommand.Parameters["@SunInterfaceTypeId"].Value = sunInterfaceTypeId;

            SunInterfaceLogDs dataSet = new SunInterfaceLogDs();
            int recordsAffected = ad.Fill(dataSet);

            if (recordsAffected < 1) return null;

            SunInterfaceLogDef def = new SunInterfaceLogDef();
            this.SunInterfaceLogMapping(dataSet.SunInterfaceLog[0], def);
            return def;
        }

        public SunInterfaceLogDef getInitialLogByShipmentId(int sunInterfaceTypeId, int shipmentId, int splitShipmentId)
        {
            IDataSetAdapter ad = getDataSetAdapter("SunInterfaceLogApt", "GetInitialInterfacedLogByShipmentId");
            ad.SelectCommand.Parameters["@ShipmentId"].Value = shipmentId;
            ad.SelectCommand.Parameters["@SplitShipmentId"].Value = splitShipmentId;
            ad.SelectCommand.Parameters["@SunInterfaceTypeId"].Value = sunInterfaceTypeId;

            SunInterfaceLogDs dataSet = new SunInterfaceLogDs();
            int recordsAffected = ad.Fill(dataSet);

            if (recordsAffected < 1) return null;

            SunInterfaceLogDef def = new SunInterfaceLogDef();
            this.SunInterfaceLogMapping(dataSet.SunInterfaceLog[0], def);
            return def;
        }

        public SunInterfaceLogDef getReversalInterfaceDataByShipmentId(int sunInterfaceTypeId, int shipmentId, int splitShipmentId)
        {
            string commandName = SunInterfaceTypeRef.getReversalDataCommandName(sunInterfaceTypeId, splitShipmentId > 0 ? true : false);

            if (commandName == "N/A")
            {
                throw new ApplicationException("Sun Interface Data Command was not specified");
            }

            IDataSetAdapter ad = getDataSetAdapter("SunInterfaceLogApt", commandName);
            ad.SelectCommand.Parameters["@SunInterfaceTypeId"].Value = sunInterfaceTypeId;
            ad.SelectCommand.Parameters["@ShipmentId"].Value = shipmentId;
            ad.SelectCommand.Parameters["@SplitShipmentId"].Value = splitShipmentId;

            SunInterfaceLogDs dataSet = new SunInterfaceLogDs();
            int recordsAffected = ad.Fill(dataSet);

            if (recordsAffected == 0) return null;

            SunInterfaceLogDef def = new SunInterfaceLogDef();

            this.SunInterfaceLogMapping(dataSet.SunInterfaceLog[0], def);

            return def;
        }

        private void resetReversalEntry(SunInterfaceLogDef def, bool isReversalEntry)
        {
            CutOffStatusRef cutOffRef = this.getCutOffStatus(def.ShipmentId);
            ArrayList list = this.getSunInterfaceQueueList(def.OfficeId, cutOffRef.FiscalYear, cutOffRef.Period, def.SunInterfaceTypeId, CategoryType.ACTUAL.Id, 0, -1);
            foreach (SunInterfaceQueueDef queueDef in list)
            {
                def.QueueId = queueDef.QueueId;
                def.FiscalYear = queueDef.FiscalYear;
                def.Period = queueDef.Period;
                break;
            }
            def.CategoryId = CategoryType.ACTUAL.Id;
            def.BaseAmount = 0;
            def.OtherAmount = 0;
            def.FullBaseAmount = 0;
            def.FullOtherAmount = 0;
            def.IsReversalEntry = false;
            def.SunInterfaceLogId = -1;
            def.CreatedOn = DateTime.Now;

            if (isReversalEntry)
            {
                AccountFinancialCalenderDef calDef = generalWorker.getAccountPeriodByDate(AppId.ISAM.Code, DateTime.Today);
                def.FiscalYear = calDef.BudgetYear;
                def.Period = calDef.Period;
                def.IsReversalEntry = true;
                def.QueueId = -1;
            }

        }

        public BankReconciliationRequestDef getBankReconciliationRequestByFileName(string fileName)
        {
            IDataSetAdapter ad = getDataSetAdapter("BankReconciliationRequestApt", "GetBankReconciliationRequestByFileName");
            ad.SelectCommand.Parameters["@FileName"].Value = fileName;

            BankReconciliationRequestDs dataSet = new BankReconciliationRequestDs();
            int recordsAffected = ad.Fill(dataSet);

            if (recordsAffected < 1) return null;

            BankReconciliationRequestDef def = new BankReconciliationRequestDef();
            this.BankReconciliationRequestMapping(dataSet.BankReconciliationRequest[0], def);
            return def;
        }

        public EInvoiceBatchDef getEInvoiceBatchByKey(int batchId)
        {
            IDataSetAdapter ad = getDataSetAdapter("EInvoiceBatchApt", "GetEInvoiceBatchByKey");
            ad.SelectCommand.Parameters["@eInvoiceBatchId"].Value = batchId;

            EInvoiceBatchDs dataSet = new EInvoiceBatchDs();
            int recordsAffected = ad.Fill(dataSet);

            if (recordsAffected < 1) return null;

            EInvoiceBatchDef def = new EInvoiceBatchDef();

            this.EInvoiceBatchMapping(dataSet.eInvoiceBatch[0], def);
            return def;
        }


        public bool isSupplierPaymentHold(int vendorId)
        {
            IDataSetAdapter ad = getDataSetAdapter("SupplierPaymentStatusApt", "GetSupplierPaymentStatusByKey");
            ad.SelectCommand.Parameters["@VendorId"].Value = vendorId;

            SupplierPaymentStatusDs dataSet = new SupplierPaymentStatusDs();
            int recordsAffected = ad.Fill(dataSet);

            if (recordsAffected < 1) return false;

            return dataSet.SupplierPaymentStatus[0].IsHold;
        }

        public string getSupplierPaymentHoldRemark(int vendorId)
        {
            IDataSetAdapter ad = getDataSetAdapter("SupplierPaymentStatusApt", "GetSupplierPaymentStatusByKey");
            ad.SelectCommand.Parameters["@VendorId"].Value = vendorId;

            SupplierPaymentStatusDs dataSet = new SupplierPaymentStatusDs();
            int recordsAffected = ad.Fill(dataSet);

            if (recordsAffected < 1) return "N/A";

            if (dataSet.SupplierPaymentStatus[0].IsRemarkNull())
                return "N/A";
            else
                return dataSet.SupplierPaymentStatus[0].Remark;
        }

        public void updateSupplierPaymentStatus(int vendorId, bool isHold, string remark, int userId)
        {
            TransactionContext ctx = TransactionContextFactory.GetContext(TransactionAffinity.Required);
            try
            {
                ctx.Enter();
                TransactionContext currentCtx = TransactionContextFactory.GetCurrentContext();

                IDataSetAdapter ad = getDataSetAdapter("SupplierPaymentStatusApt", "GetSupplierPaymentStatusByKey");
                ad.SelectCommand.Parameters["@VendorId"].Value = vendorId;
                ad.PopulateCommands();

                SupplierPaymentStatusDs dataSet = new SupplierPaymentStatusDs();
                SupplierPaymentStatusDs.SupplierPaymentStatusRow row = null;

                int recordsAffected = ad.Fill(dataSet);
                if (recordsAffected > 0)
                {
                    row = dataSet.SupplierPaymentStatus[0];
                    row.IsHold = isHold;
                    if (remark.Trim() == string.Empty)
                        row.SetRemarkNull();
                    else
                        row.Remark = remark;
                    this.sealStamp(row, userId, Stamp.UPDATE);
                }
                else
                {
                    row = dataSet.SupplierPaymentStatus.NewSupplierPaymentStatusRow();
                    row.VendorId = vendorId;
                    row.IsHold = isHold;
                    if (remark.Trim() == string.Empty)
                        row.SetRemarkNull();
                    else
                        row.Remark = remark;
                    this.sealStamp(row, userId, Stamp.INSERT);
                    dataSet.SupplierPaymentStatus.AddSupplierPaymentStatusRow(row);
                }
                recordsAffected = ad.Update(dataSet);
                if (recordsAffected < 1)
                    throw new DataAccessException("Update Supplier Payment Status ERROR");
                ctx.VoteCommit();
            }
            catch (Exception e)
            {
                Console.WriteLine("ERROR " + e.Message);
                ctx.VoteRollback();
                throw e;
            }
            finally
            {
                ctx.Exit();
            }
        }

        public void updateBankReconciliationRequest(BankReconciliationRequestDef def)
        {
            TransactionContext ctx = TransactionContextFactory.GetContext(TransactionAffinity.Required);
            try
            {
                ctx.Enter();
                TransactionContext currentCtx = TransactionContextFactory.GetCurrentContext();

                IDataSetAdapter ad = getDataSetAdapter("BankReconciliationRequestApt", "GetBankReconciliationRequestByKey");
                ad.SelectCommand.Parameters["@RequestId"].Value = def.RequestId;
                ad.PopulateCommands();

                BankReconciliationRequestDs dataSet = new BankReconciliationRequestDs();
                BankReconciliationRequestDs.BankReconciliationRequestRow row = null;

                int recordsAffected = ad.Fill(dataSet);
                if (recordsAffected > 0)
                {
                    row = dataSet.BankReconciliationRequest[0];
                    this.BankReconciliationRequestMapping(def, row);
                }
                else
                {
                    row = dataSet.BankReconciliationRequest.NewBankReconciliationRequestRow();
                    def.RequestId = this.getMaxBankReconciliationRequestId() + 1;
                    this.BankReconciliationRequestMapping(def, row);
                    dataSet.BankReconciliationRequest.AddBankReconciliationRequestRow(row);
                }
                recordsAffected = ad.Update(dataSet);
                if (recordsAffected < 1)
                    throw new DataAccessException("Update Bank Reconciliation Request ERROR");
                ctx.VoteCommit();
            }
            catch (Exception e)
            {
                Console.WriteLine("ERROR " + e.Message);
                ctx.VoteRollback();
                throw e;
            }
            finally
            {
                ctx.Exit();
            }
        }

        public AdjustmentDetailDef getAdjustmentDetailByKey(int key)
        {
            IDataSetAdapter ad = getDataSetAdapter("AdjustmentDetailApt", "GetAdjustmentDetailByKey");
            ad.SelectCommand.Parameters["@AdjustmentDetailId"].Value = key;

            AdjustmentDetailDs dataSet = new AdjustmentDetailDs();
            int recordsAffected = ad.Fill(dataSet);

            if (recordsAffected < 1) return null;

            AdjustmentDetailDef def = new AdjustmentDetailDef();

            this.AdjustmentDetailMapping(dataSet.AdjustmentDetail[0], def);
            return def;
        }

        public AdjustmentDetailDef getAdjustmentDetail(AdjustmentType adjustmentType, int shipmentId, int splitShipmentId)
        {
            IDataSetAdapter ad = getDataSetAdapter("AdjustmentDetailApt", "GetAdjustmentDetail");
            ad.SelectCommand.Parameters["@AdjustmentTypeId"].Value = adjustmentType.Id;
            ad.SelectCommand.Parameters["@ShipmentId"].Value = shipmentId;
            ad.SelectCommand.Parameters["@SplitShipmentId"].Value = splitShipmentId;

            AdjustmentDetailDs dataSet = new AdjustmentDetailDs();
            int recordsAffected = ad.Fill(dataSet);

            if (recordsAffected < 1) return null;

            AdjustmentDetailDef def = new AdjustmentDetailDef();

            this.AdjustmentDetailMapping(dataSet.AdjustmentDetail[0], def);
            return def;
        }

        public AdjustmentDetailDef getAdjustmentDetailByAdjustmentNoteId(int key)
        {
            IDataSetAdapter ad = getDataSetAdapter("AdjustmentDetailApt", "GetAdjustmentDetailByAdjustmentNoteId");
            ad.SelectCommand.Parameters["@AdjustmentNoteId"].Value = key;

            AdjustmentDetailDs dataSet = new AdjustmentDetailDs();
            int recordsAffected = ad.Fill(dataSet);

            if (recordsAffected < 1) return null;

            AdjustmentDetailDef def = new AdjustmentDetailDef();

            this.AdjustmentDetailMapping(dataSet.AdjustmentDetail[0], def);
            return def;
        }

        public AdjustmentDetailDef getOutstandingAdjustmentDetail(int shipmentId, int splitShipmentId, int adjustmentTypeId)
        {
            IDataSetAdapter ad = getDataSetAdapter("AdjustmentDetailApt", "GetOutstandingAdjustmentDetail");
            ad.SelectCommand.Parameters["@ShipmentId"].Value = shipmentId;
            ad.SelectCommand.Parameters["@SplitShipmentId"].Value = splitShipmentId;
            ad.SelectCommand.Parameters["@AdjustmentTypeId"].Value = adjustmentTypeId;

            AdjustmentDetailDs dataSet = new AdjustmentDetailDs();
            int recordsAffected = ad.Fill(dataSet);

            if (recordsAffected < 1) return null;

            AdjustmentDetailDef def = new AdjustmentDetailDef();

            this.AdjustmentDetailMapping(dataSet.AdjustmentDetail[0], def);
            return def;
        }

        public ArrayList getOutstandingAdjustmentDetailList(int officeGroupId, int adjustmentTypeId, int vendorId, int currencyId, int shipmentId, int splitShipmentId)
        {
            IDataSetAdapter ad = getDataSetAdapter("AdjustmentDetailApt", "GetOutstandingAdjustmentDetailList");
            ad.SelectCommand.Parameters["@OfficeGroupId"].Value = officeGroupId;
            ad.SelectCommand.Parameters["@AdjustmentTypeId"].Value = adjustmentTypeId;
            ad.SelectCommand.Parameters["@VendorId"].Value = vendorId;
            ad.SelectCommand.Parameters["@CurrencyId"].Value = currencyId;
            ad.SelectCommand.Parameters["@ShipmentId"].Value = shipmentId;
            ad.SelectCommand.Parameters["@SplitShipmentId"].Value = splitShipmentId;
            ad.SelectCommand.DbCommand.CommandTimeout = 120;

            AdjustmentDetailDs dataSet = new AdjustmentDetailDs();
            int recordsAffected = ad.Fill(dataSet);

            ArrayList list = new ArrayList();

            foreach (AdjustmentDetailDs.AdjustmentDetailRow row in dataSet.AdjustmentDetail)
            {
                AdjustmentDetailDef def = new AdjustmentDetailDef();
                AdjustmentDetailMapping(row, def);
                list.Add(def);
            }
            return list;
        }

        public ArrayList getOutstandingAdjustmentNoteList(int officeGroupId, int adjustmentTypeId)
        {
            IDataSetAdapter ad = null;
            ad = getDataSetAdapter("AdjustmentNoteApt", "GetOutstandingAdjustmentNoteList");

            ad.SelectCommand.Parameters["@OfficeGroupId"].Value = officeGroupId;
            ad.SelectCommand.Parameters["@AdjustmentTypeId"].Value = adjustmentTypeId;
            ad.SelectCommand.DbCommand.CommandTimeout = 120;

            AdjustmentNoteDs dataSet = new AdjustmentNoteDs();
            int recordsAffected = ad.Fill(dataSet);

            ArrayList list = new ArrayList();

            foreach (AdjustmentNoteDs.AdjustmentNoteRow row in dataSet.AdjustmentNote)
            {
                AdjustmentNoteDef def = new AdjustmentNoteDef();
                AdjustmentNoteMapping(row, def);
                list.Add(def);
            }
            return list;
        }

        public AdjustmentNoteDef GetAdjustmentNoteByKey(int adjustmentNoteId)
        {

            IDataSetAdapter ad = null;
            ad = getDataSetAdapter("AdjustmentNoteApt", "GetAdjustmentNoteByKey");
            ad.SelectCommand.Parameters["@AdjustmentNoteId"].Value = adjustmentNoteId;
            ad.SelectCommand.DbCommand.CommandTimeout = 120;

            AdjustmentNoteDs dataSet = new AdjustmentNoteDs();
            int recordsAffected = ad.Fill(dataSet);


            //foreach (AdjustmentNoteDs.AdjustmentNoteRow row in dataSet.AdjustmentNote)
            AdjustmentNoteDef def = new AdjustmentNoteDef();
            AdjustmentNoteMapping(dataSet.AdjustmentNote.Rows[0], def);

            return def;
        }

        public ArrayList getAdjustmentNoteList(TypeCollector officeList, int adjustmentTypeId, DateTime fromDate, DateTime toDate)
        {
            IDataSetAdapter ad = null;
            ad = getDataSetAdapter("AdjustmentNoteApt", "GetAdjustmentNoteList");
            ad.SelectCommand.CustomParameters["@OfficeList"] = CustomDataParameter.parse(officeList.IsInclusive, officeList.Values);
            ad.SelectCommand.Parameters["@AdjustmentTypeId"].Value = adjustmentTypeId;
            ad.SelectCommand.Parameters["@FromDate"].Value = fromDate;
            ad.SelectCommand.Parameters["@ToDate"].Value = toDate;
            ad.SelectCommand.DbCommand.CommandTimeout = 120;

            AdjustmentNoteDs dataSet = new AdjustmentNoteDs();
            int recordsAffected = ad.Fill(dataSet);

            ArrayList list = new ArrayList();

            foreach (AdjustmentNoteDs.AdjustmentNoteRow row in dataSet.AdjustmentNote)
            {
                AdjustmentNoteDef def = new AdjustmentNoteDef();
                AdjustmentNoteMapping(row, def);
                list.Add(def);
            }
            return list;
        }

        public ArrayList getClosedAdjustmentDetailList(int shipmentId, int splitShipmentId, int adjustmentTypeId)
        {
            IDataSetAdapter ad = getDataSetAdapter("AdjustmentDetailApt", "GetClosedAdjustmentDetailList");
            ad.SelectCommand.Parameters["@ShipmentId"].Value = shipmentId;
            ad.SelectCommand.Parameters["@SplitShipmentId"].Value = splitShipmentId;
            ad.SelectCommand.Parameters["@AdjustmentTypeId"].Value = adjustmentTypeId;
            ad.SelectCommand.DbCommand.CommandTimeout = 120;

            AdjustmentDetailDs dataSet = new AdjustmentDetailDs();
            int recordsAffected = ad.Fill(dataSet);

            ArrayList list = new ArrayList();

            foreach (AdjustmentDetailDs.AdjustmentDetailRow row in dataSet.AdjustmentDetail)
            {
                AdjustmentDetailDef def = new AdjustmentDetailDef();
                AdjustmentDetailMapping(row, def);
                list.Add(def);
            }
            return list;
        }

        public void updateAdjustmentNote(AdjustmentNoteDef def, int userId)
        {
            TransactionContext ctx = TransactionContextFactory.GetContext(TransactionAffinity.Required);
            try
            {
                ctx.Enter();
                TransactionContext currentCtx = TransactionContextFactory.GetCurrentContext();

                IDataSetAdapter ad = getDataSetAdapter("AdjustmentNoteApt", "GetAdjustmentNoteByKey");
                ad.SelectCommand.Parameters["@AdjustmentNoteId"].Value = def.AdjustmentNoteId;
                ad.PopulateCommands();

                AdjustmentNoteDs dataSet = new AdjustmentNoteDs();
                AdjustmentNoteDs.AdjustmentNoteRow row = null;

                int recordsAffected = ad.Fill(dataSet);
                if (recordsAffected > 0)
                {
                    row = dataSet.AdjustmentNote[0];
                    this.AdjustmentNoteMapping(def, row);
                    sealStamp(row, userId, Stamp.UPDATE);
                }
                else
                {
                    row = dataSet.AdjustmentNote.NewAdjustmentNoteRow();
                    def.AdjustmentNoteId = this.getMaxAdjustmentNoteId() + 1;
                    this.AdjustmentNoteMapping(def, row);
                    sealStamp(row, userId, Stamp.INSERT);
                    dataSet.AdjustmentNote.AddAdjustmentNoteRow(row);
                }
                recordsAffected = ad.Update(dataSet);
                if (recordsAffected < 1)
                    throw new DataAccessException("Update Adjustment Note ERROR");
                ctx.VoteCommit();
            }
            catch (Exception e)
            {
                Console.WriteLine("ERROR " + e.Message);
                ctx.VoteRollback();
                throw e;
            }
            finally
            {
                ctx.Exit();
            }
        }

        public string fillNextAdjustmentNoteNo(AdjustmentType adjType, DateTime issueDate, int officeId, string debitCreditIndicator)
        {
            TransactionContext ctx = TransactionContextFactory.GetContext(TransactionAffinity.Required);
            try
            {
                ctx.Enter();
                TransactionContext currentCtx = TransactionContextFactory.GetCurrentContext();

                string noteNo = string.Empty;
                if (issueDate == DateTime.MinValue)
                    throw new ApplicationException("Invalid issue date, please assign an issue date before calling fillNextAdjustmentNoteNo()");

                AccountFinancialCalenderDef calenderDef = generalWorker.getAccountPeriodByDate(9, issueDate);

                IDataSetAdapter ad = getDataSetAdapter("AdjustmentNoteNoParamApt", "GetAdjustmentNoteNoParamByKey");
                ad.SelectCommand.Parameters["@AdjustmentNoteYear"].Value = calenderDef.BudgetYear;
                ad.SelectCommand.Parameters["@Period"].Value = (calenderDef.BudgetYear < 2013 ? 12 : calenderDef.Period);

                /*
                if (officeId == 16)
                    ad.SelectCommand.Parameters["@OfficeId"].Value = 4;
                else if (officeId == 17)
                    ad.SelectCommand.Parameters["@OfficeId"].Value = 1;
                else if (officeId == 18)
                    ad.SelectCommand.Parameters["@OfficeId"].Value = 9;
                else
                    ad.SelectCommand.Parameters["@OfficeId"].Value = officeId;
                */
                ad.SelectCommand.Parameters["@OfficeId"].Value = officeId;
                ad.SelectCommand.Parameters["@DebitCreditIndicator"].Value = debitCreditIndicator;

                AdjustmentNoteNoParamDs dataSet = new AdjustmentNoteNoParamDs();
                ad.SelectCommand.DbCommand.CommandTimeout = 120;
                ad.PopulateCommands();
                int recordsAffected = ad.Fill(dataSet);

                if (recordsAffected < 1)
                    throw new ApplicationException("Missing Adjustment Note No. Param");

                AdjustmentNoteNoParamDs.AdjustmentNoteNoParamRow row = dataSet.AdjustmentNoteNoParam[0];

                if (calenderDef.BudgetYear > 2012)
                {
                    noteNo = row.OfficePrefix + debitCreditIndicator + row.AdjustmentNoteYear.ToString().Substring(2) + row.Period.ToString().PadLeft(2, '0') + row.SeqNo.ToString().PadLeft(3, '0');
                    if (adjType.Id == AdjustmentType.PURCHASE_ADJUSTMENT.Id)
                        noteNo = noteNo + "P";
                    else if (adjType.Id == AdjustmentType.ADVANCE_PAYMENT_INTEREST.Id)
                        noteNo = noteNo + "I";
                    else if (adjType.Id == AdjustmentType.OTHER_CHARGE.Id)
                        noteNo = noteNo + "O";
                }
                else
                    noteNo = row.OfficePrefix + debitCreditIndicator + row.SeqNo.ToString().PadLeft(5, '0') + "/" + row.AdjustmentNoteYear.ToString().Substring(2);

                row.SeqNo += 1;
                sealStamp(row, 99999, Stamp.UPDATE);

                recordsAffected = ad.Update(dataSet);
                ctx.VoteCommit();

                return noteNo;
            }
            catch (Exception e)
            {
                Console.WriteLine("ERROR " + e.Message);
                ctx.VoteRollback();
                throw e;
            }
            finally
            {
                ctx.Exit();
            }
        }

        public void updateAdjustmentDetail(AdjustmentDetailDef def, int userId)
        {
            TransactionContext ctx = TransactionContextFactory.GetContext(TransactionAffinity.Required);
            try
            {
                ctx.Enter();
                TransactionContext currentCtx = TransactionContextFactory.GetCurrentContext();

                IDataSetAdapter ad = getDataSetAdapter("AdjustmentDetailApt", "GetAdjustmentDetailByKey");
                ad.SelectCommand.Parameters["@AdjustmentDetailId"].Value = def.AdjustmentDetailId;
                ad.PopulateCommands();

                AdjustmentDetailDs dataSet = new AdjustmentDetailDs();
                AdjustmentDetailDs.AdjustmentDetailRow row = null;

                int recordsAffected = ad.Fill(dataSet);
                if (recordsAffected > 0)
                {
                    row = dataSet.AdjustmentDetail[0];
                    this.AdjustmentDetailMapping(def, row);
                    sealStamp(row, userId, Stamp.UPDATE);
                }
                else
                {
                    row = dataSet.AdjustmentDetail.NewAdjustmentDetailRow();
                    def.AdjustmentDetailId = this.getMaxAdjustmentDetailId() + 1;
                    this.AdjustmentDetailMapping(def, row);
                    sealStamp(row, userId, Stamp.INSERT);
                    dataSet.AdjustmentDetail.AddAdjustmentDetailRow(row);
                }
                recordsAffected = ad.Update(dataSet);
                if (recordsAffected < 1)
                    throw new DataAccessException("Update Adjustment Detail ERROR");
                ctx.VoteCommit();
            }
            catch (Exception e)
            {
                Console.WriteLine("ERROR " + e.Message);
                ctx.VoteRollback();
                throw e;
            }
            finally
            {
                ctx.Exit();
            }
        }

        public void updateSunInterfaceLog(SunInterfaceLogDef def)
        {
            TransactionContext ctx = TransactionContextFactory.GetContext(TransactionAffinity.Required);
            try
            {
                ctx.Enter();
                TransactionContext currentCtx = TransactionContextFactory.GetCurrentContext();

                IDataSetAdapter ad = getDataSetAdapter("SunInterfaceLogApt", "GetSunInterfaceLogByKey");
                ad.SelectCommand.Parameters["@SunInterfaceLogId"].Value = def.SunInterfaceLogId;
                ad.PopulateCommands();

                SunInterfaceLogDs dataSet = new SunInterfaceLogDs();
                SunInterfaceLogDs.SunInterfaceLogRow row = null;

                int recordsAffected = ad.Fill(dataSet);
                if (recordsAffected > 0)
                {
                    row = dataSet.SunInterfaceLog[0];
                    this.SunInterfaceLogMapping(def, row);
                }
                else
                {
                    row = dataSet.SunInterfaceLog.NewSunInterfaceLogRow();
                    def.SunInterfaceLogId = this.getMaxSunInterfaceLogId() + 1;
                    row.CreatedOn = DateTime.Now;
                    this.SunInterfaceLogMapping(def, row);
                    dataSet.SunInterfaceLog.AddSunInterfaceLogRow(row);
                }
                recordsAffected = ad.Update(dataSet);
                if (recordsAffected < 1)
                    throw new DataAccessException("Update Sun Interface Log ERROR");
                ctx.VoteCommit();
            }
            catch (Exception e)
            {
                Console.WriteLine("ERROR " + e.Message);
                ctx.VoteRollback();
                throw e;
            }
            finally
            {
                ctx.Exit();
            }
        }

        public void removeSunInterfaceLog(SunInterfaceLogDef def)
        {
            TransactionContext ctx = TransactionContextFactory.GetContext(TransactionAffinity.Required);
            try
            {
                ctx.Enter();
                TransactionContext currentCtx = TransactionContextFactory.GetCurrentContext();

                IDataSetAdapter ad = getDataSetAdapter("SunInterfaceLogApt", "GetSunInterfaceLogByKey");
                ad.SelectCommand.Parameters["@SunInterfaceLogId"].Value = def.SunInterfaceLogId;
                ad.PopulateCommands();

                SunInterfaceLogDs dataSet = new SunInterfaceLogDs();
                SunInterfaceLogDs.SunInterfaceLogRow row = null;

                int recordsAffected = ad.Fill(dataSet);
                if (recordsAffected > 0)
                {
                    row = dataSet.SunInterfaceLog[0];
                    row.Delete();
                    recordsAffected = ad.Update(dataSet);
                }
                if (recordsAffected < 1)
                    throw new DataAccessException("Remove Sun Interface Log ERROR");
                ctx.VoteCommit();
            }
            catch (Exception e)
            {
                Console.WriteLine("ERROR " + e.Message);
                ctx.VoteRollback();
                throw e;
            }
            finally
            {
                ctx.Exit();
            }
        }

        public void removeAdjustmentDetail(AdjustmentDetailDef def)
        {
            TransactionContext ctx = TransactionContextFactory.GetContext(TransactionAffinity.Required);
            try
            {
                ctx.Enter();
                TransactionContext currentCtx = TransactionContextFactory.GetCurrentContext();

                IDataSetAdapter ad = getDataSetAdapter("AdjustmentDetailApt", "GetAdjustmentDetailByKey");
                ad.SelectCommand.Parameters["@AdjustmentDetailId"].Value = def.AdjustmentDetailId;
                ad.PopulateCommands();

                AdjustmentDetailDs dataSet = new AdjustmentDetailDs();
                AdjustmentDetailDs.AdjustmentDetailRow row = null;

                int recordsAffected = ad.Fill(dataSet);
                if (recordsAffected > 0)
                {
                    row = dataSet.AdjustmentDetail[0];
                    row.Delete();
                    recordsAffected = ad.Update(dataSet);
                }
                if (recordsAffected < 1)
                    throw new DataAccessException("Remove Adjustment Detail ERROR");
                ctx.VoteCommit();
            }
            catch (Exception e)
            {
                Console.WriteLine("ERROR " + e.Message);
                ctx.VoteRollback();
                throw e;
            }
            finally
            {
                ctx.Exit();
            }
        }

        public AccountFinancialCalenderDef getLatestCutOffPeriod()
        {
            IDataSetAdapter ad = getDataSetAdapter("CutOffSalesApt", "GetLatestCutOffPeriod");

            DataSet dataSet = new DataSet();
            int recordsAffected = ad.Fill(dataSet);
            string period = (string)(dataSet.Tables[0].Rows[0][0]);
            return generalWorker.getAccountPeriodByYearPeriod(AppId.NSS.Code, int.Parse(period.Substring(0, 5)), int.Parse(period.Substring(5)));
        }

        public CutOffStatusRef getCutOffStatus(int shipmentId)
        {
            IDataSetAdapter ad = getDataSetAdapter("CutOffSalesApt", "GetCutOffSalesStatus");
            ad.SelectCommand.Parameters["@ShipmentId"].Value = shipmentId;

            CutOffStatusRef def = new CutOffStatusRef();
            def.FiscalYear = 0;
            def.Period = 0;
            def.AccruedSince = String.Empty;

            DataSet dataSet = new DataSet();
            int recordsAffected = ad.Fill(dataSet);
            if (dataSet.Tables[0].Rows.Count == 0)
                def.CutOffStatusId = CutOffStatus.UNDEFINED.GetHashCode();
            else
            {
                def.FiscalYear = (int)(dataSet.Tables[0].Rows[0][1]);
                def.Period = (int)(dataSet.Tables[0].Rows[0][2]);
                def.AccruedSince = (string)(dataSet.Tables[0].Rows[0][3]);
                if ((bool)(dataSet.Tables[0].Rows[0][0]))
                    def.CutOffStatusId = CutOffStatus.ACCRUAL.GetHashCode();
                else
                    def.CutOffStatusId = CutOffStatus.ACTUAL.GetHashCode();
            }

            return def;
        }

        public ArrayList getThirdPartyCommissionInvoiceToUK(int fiscalYear, int period)
        {
            IDataSetAdapter ad = getDataSetAdapter("CutOffSalesApt", "GetThirdPartyCommissionInvoiceToUK");
            ad.SelectCommand.Parameters["@FiscalYear"].Value = fiscalYear;
            ad.SelectCommand.Parameters["@Period"].Value = period;

            ArrayList list = new ArrayList();
            DataSet dataSet = new DataSet();
            int recordsAffected = ad.Fill(dataSet);
            if (recordsAffected > 0)
            {
                foreach (DataRow r in dataSet.Tables[0].Rows)
                {
                    ThirdPartyCustomerDNToUKDef def = new ThirdPartyCustomerDNToUKDef();
                    def.ShipmentId = int.Parse(r[0].ToString());
                    def.OfficeId = int.Parse(r[1].ToString());
                    def.ContractNo = r[2].ToString();
                    def.DeliveryNo = int.Parse(r[3].ToString());
                    def.InvoiceNo = ShippingWorker.getInvoiceNo(r[4].ToString(), int.Parse(r[5].ToString()), int.Parse(r[6].ToString()));
                    def.Currency = CurrencyId.getCommonName(int.Parse(r[7].ToString()));
                    def.InvoiceAmt = decimal.Parse(r[8].ToString());
                    def.CommissionAmt = decimal.Parse(r[9].ToString());
                    def.InvoiceDate = DateTime.Parse(r[10].ToString());
                    list.Add(def);
                }
            }
            return list;
        }

        private void getDaysAmountsByInvoiceNo(string invoicePrefix, int invoiceSeq, int invoiceYear, out decimal baseAmt, out decimal otherAmt)
        {
            IDataSetAdapter ad = getDataSetAdapter("CutOffSalesApt", "GetDaysAmounts");
            ad.SelectCommand.Parameters["@invoicePrefix"].Value = invoicePrefix;
            ad.SelectCommand.Parameters["@invoiceSeq"].Value = invoiceSeq;
            ad.SelectCommand.Parameters["@invoiceYear"].Value = invoiceYear;

            DataSet dataSet = new DataSet();
            int recordsAffected = ad.Fill(dataSet);
            if (Convert.IsDBNull(dataSet.Tables[0].Rows[0][0]))
            {
                baseAmt = 0;
                otherAmt = 0;
            }
            else
            {
                baseAmt = (decimal)(dataSet.Tables[0].Rows[0][1]);
                otherAmt = (decimal)(dataSet.Tables[0].Rows[0][0]);
            }
        }


        private int getMaxLogoInterfaceRequestId()
        {
            IDataSetAdapter ad = getDataSetAdapter("LogoInterfaceRequestApt", "GetMaxRequestId");
            DataSet dataSet = new DataSet();
            int recordsAffected = ad.Fill(dataSet);
            if (Convert.IsDBNull(dataSet.Tables[0].Rows[0][0]))
                return 0;
            else
                return (int)(dataSet.Tables[0].Rows[0][0]);
        }

        private int getMaxQueueId()
        {
            IDataSetAdapter ad = getDataSetAdapter("SunInterfaceQueueApt", "GetMaxQueueId");
            DataSet dataSet = new DataSet();
            int recordsAffected = ad.Fill(dataSet);
            if (Convert.IsDBNull(dataSet.Tables[0].Rows[0][0]))
                return 0;
            else
                return (int)(dataSet.Tables[0].Rows[0][0]);
        }

        private int getMaxAdjustmentDetailLineId()
        {
            IDataSetAdapter ad = getDataSetAdapter("AdjustmentDetailLineApt", "GetMaxAdjustmentDetailLineId");
            DataSet dataSet = new DataSet();
            int recordsAffected = ad.Fill(dataSet);
            if (Convert.IsDBNull(dataSet.Tables[0].Rows[0][0]))
                return 0;
            else
                return (int)(dataSet.Tables[0].Rows[0][0]);
        }

        private int getMaxSunInterfaceLogId()
        {
            IDataSetAdapter ad = getDataSetAdapter("SunInterfaceLogApt", "GetMaxSunInterfaceLogId");
            DataSet dataSet = new DataSet();
            int recordsAffected = ad.Fill(dataSet);
            if (Convert.IsDBNull(dataSet.Tables[0].Rows[0][0]))
                return 0;
            else
                return (int)(dataSet.Tables[0].Rows[0][0]);
        }

        private int getMaxAdjustmentNoteId()
        {
            IDataSetAdapter ad = getDataSetAdapter("AdjustmentNoteApt", "GetMaxAdjustmentNoteId");
            DataSet dataSet = new DataSet();
            int recordsAffected = ad.Fill(dataSet);
            if (Convert.IsDBNull(dataSet.Tables[0].Rows[0][0]))
                return 0;
            else
                return (int)(dataSet.Tables[0].Rows[0][0]);
        }

        private int getMaxAdjustmentDetailId()
        {
            IDataSetAdapter ad = getDataSetAdapter("AdjustmentDetailApt", "GetMaxAdjustmentDetailId");
            DataSet dataSet = new DataSet();
            int recordsAffected = ad.Fill(dataSet);
            if (Convert.IsDBNull(dataSet.Tables[0].Rows[0][0]))
                return 0;
            else
                return (int)(dataSet.Tables[0].Rows[0][0]);
        }

        private int getMaxEInvoiceBatchId()
        {
            IDataSetAdapter ad = getDataSetAdapter("EInvoiceBatchApt", "GetMaxEInvoiceBatchId");
            DataSet dataSet = new DataSet();
            int recordsAffected = ad.Fill(dataSet);
            if (Convert.IsDBNull(dataSet.Tables[0].Rows[0][0]))
                return 0;
            else
                return (int)(dataSet.Tables[0].Rows[0][0]);
        }

        private int getMaxBankReconciliationRequestId()
        {
            IDataSetAdapter ad = getDataSetAdapter("BankReconciliationRequestApt", "GetMaxBankReconciliationRequestId");
            DataSet dataSet = new DataSet();
            int recordsAffected = ad.Fill(dataSet);
            if (Convert.IsDBNull(dataSet.Tables[0].Rows[0][0]))
                return 0;
            else
                return (int)(dataSet.Tables[0].Rows[0][0]);
        }

        private int getMaxMockShopDCNoteShipmentId()
        {
            IDataSetAdapter ad = getDataSetAdapter("MockShopDCNoteShipmentApt", "GetMaxDebitNoteShipmentId");
            DataSet dataSet = new DataSet();
            int recordsAffected = ad.Fill(dataSet);
            if (Convert.IsDBNull(dataSet.Tables[0].Rows[0][0]))
                return 0;
            else
                return (int)(dataSet.Tables[0].Rows[0][0]);
        }

        private int getMaxStudioDCNoteShipmentId()
        {
            IDataSetAdapter ad = getDataSetAdapter("StudioDCNoteShipmentApt", "GetMaxDebitNoteShipmentId");
            DataSet dataSet = new DataSet();
            int recordsAffected = ad.Fill(dataSet);
            if (Convert.IsDBNull(dataSet.Tables[0].Rows[0][0]))
                return 0;
            else
                return (int)(dataSet.Tables[0].Rows[0][0]);
        }

        private int getMaxMockShopDCNoteShipmentDetailId()
        {
            IDataSetAdapter ad = getDataSetAdapter("MockShopDCNoteShipmentDetailApt", "GetMaxDCNoteShipmentDetailId");
            DataSet dataSet = new DataSet();
            int recordsAffected = ad.Fill(dataSet);
            if (Convert.IsDBNull(dataSet.Tables[0].Rows[0][0]))
                return 0;
            else
                return (int)(dataSet.Tables[0].Rows[0][0]);
        }

        private int getMaxStudioDCNoteShipmentDetailId()
        {
            IDataSetAdapter ad = getDataSetAdapter("StudioDCNoteShipmentDetailApt", "GetMaxDCNoteShipmentDetailId");
            DataSet dataSet = new DataSet();
            int recordsAffected = ad.Fill(dataSet);
            if (Convert.IsDBNull(dataSet.Tables[0].Rows[0][0]))
                return 0;
            else
                return (int)(dataSet.Tables[0].Rows[0][0]);
        }

        private int getMaxUTContractDCNoteShipmentId()
        {
            IDataSetAdapter ad = getDataSetAdapter("UTContractDCNoteShipmentApt", "GetMaxDebitNoteShipmentId");
            DataSet dataSet = new DataSet();
            int recordsAffected = ad.Fill(dataSet);
            if (Convert.IsDBNull(dataSet.Tables[0].Rows[0][0]))
                return 0;
            else
                return (int)(dataSet.Tables[0].Rows[0][0]);
        }

        private string getDCNoteNoByQueueId(int queueId)
        {
            IDataSetAdapter ad = getDataSetAdapter("SunInterfaceLogApt", "GetDCNoteNoByQueueId");
            ad.SelectCommand.Parameters["@QueueId"].Value = queueId;

            DataSet dataSet = new DataSet();
            int recordsAffected = ad.Fill(dataSet);
            if (Convert.IsDBNull(dataSet.Tables[0].Rows[0][0]))
                return string.Empty;
            else
                return (string)(dataSet.Tables[0].Rows[0][0]);
        }

        private int getMaxClaimId()
        {
            IDataSetAdapter ad = getDataSetAdapter("ClaimApt", "GetMaxClaimId");
            DataSet dataSet = new DataSet();
            int recordsAffected = ad.Fill(dataSet);
            if (Convert.IsDBNull(dataSet.Tables[0].Rows[0][0]))
                return 0;
            else
                return (int)(dataSet.Tables[0].Rows[0][0]);
        }

        private int getMaxClaimDetailId()
        {
            IDataSetAdapter ad = getDataSetAdapter("ClaimDetailApt", "GetMaxClaimDetailId");
            DataSet dataSet = new DataSet();
            int recordsAffected = ad.Fill(dataSet);
            if (Convert.IsDBNull(dataSet.Tables[0].Rows[0][0]))
                return 0;
            else
                return (int)(dataSet.Tables[0].Rows[0][0]);
        }

        private int getMaxILSDiffDCNoteShipmentId()
        {
            IDataSetAdapter ad = getDataSetAdapter("ILSDiffDCNoteShipmentApt", "GetMaxDebitNoteShipmentId");
            DataSet dataSet = new DataSet();
            int recordsAffected = ad.Fill(dataSet);
            if (Convert.IsDBNull(dataSet.Tables[0].Rows[0][0]))
                return 0;
            else
                return (int)(dataSet.Tables[0].Rows[0][0]);
        }

        public ArrayList getBankInfo()
        {
            IDataSetAdapter ad = getDataSetAdapter("BankAccountApt", "getFullBankInfoCmd");

            BankAccountDs dataSet = new BankAccountDs();
            int recordsAffected = ad.Fill(dataSet);

            if (recordsAffected < 1) return null;

            ArrayList list = new ArrayList();
            foreach (BankAccountDs.BankAccountRow row in dataSet.BankAccount)
            {
                BankAccountDef def = new BankAccountDef();
                BankAccountMapping(row, def);
                list.Add(def);
            }
            return list;
        }

        public ArrayList getPaymentReferenceCodeList()
        {
            IDataSetAdapter ad = getDataSetAdapter("BankAccountApt", "getPaymentReferenceCodeList");

            DataSet dataSet = new DataSet();
            int recordsAffected = ad.Fill(dataSet);

            if (recordsAffected < 1) return null;

            ArrayList list = new ArrayList();
            foreach (DataRow row in dataSet.Tables[0].Rows)
            {
                list.Add(row[0].ToString());
            }
            return list;
        }


        private TypeCollector getTermOfPurchaseTypeCollector(SunInterfaceQueueDef queueDef)
        {
            TypeCollector termOfPurchaseTypeCollector = TypeCollector.Inclusive;

            if (queueDef.PurchaseTerm == 0 || commonWorker.IsInReportOfficeGroup(queueDef.OfficeGroup.OfficeGroupId, OfficeId.TR.Id) || commonWorker.IsInReportOfficeGroup(queueDef.OfficeGroup.OfficeGroupId, OfficeId.UK.Id) || commonWorker.IsInReportOfficeGroup(queueDef.OfficeGroup.OfficeGroupId, OfficeId.EG.Id))
            {
                termOfPurchaseTypeCollector.append(TermOfPurchaseRef.Id.FOB.GetHashCode());
                termOfPurchaseTypeCollector.append(TermOfPurchaseRef.Id.CM.GetHashCode());
                termOfPurchaseTypeCollector.append(TermOfPurchaseRef.Id.CMT.GetHashCode());
                termOfPurchaseTypeCollector.append(TermOfPurchaseRef.Id.VMTrading.GetHashCode());
                termOfPurchaseTypeCollector.append(TermOfPurchaseRef.Id.FOB_UT.GetHashCode());
            }
            else if (queueDef.PurchaseTerm == 1)
            {
                termOfPurchaseTypeCollector.append(TermOfPurchaseRef.Id.FOB.GetHashCode());
            }
            else if (queueDef.PurchaseTerm == 2)
            {
                termOfPurchaseTypeCollector.append(TermOfPurchaseRef.Id.CM.GetHashCode());
                termOfPurchaseTypeCollector.append(TermOfPurchaseRef.Id.CMT.GetHashCode());
                termOfPurchaseTypeCollector.append(TermOfPurchaseRef.Id.VMTrading.GetHashCode());
            }

            return termOfPurchaseTypeCollector;
        }

        private TypeCollector getTradingAgencyTypeCollector(SunInterfaceQueueDef queueDef)
        {
            TypeCollector tradingAgencyTypeCollector = TypeCollector.Inclusive;

            if (queueDef.PurchaseTerm == 0 || (!commonWorker.IsInReportOfficeGroup(queueDef.OfficeGroup.OfficeGroupId, OfficeId.TR.Id) && !commonWorker.IsInReportOfficeGroup(queueDef.OfficeGroup.OfficeGroupId, OfficeId.UK.Id) && !commonWorker.IsInReportOfficeGroup(queueDef.OfficeGroup.OfficeGroupId, OfficeId.EG.Id)))
            {
                tradingAgencyTypeCollector.append(TradingAgencyId.NSL.AgencyId);
                tradingAgencyTypeCollector.append(TradingAgencyId.NSLVM.AgencyId);
                tradingAgencyTypeCollector.append(TradingAgencyId.NSLUK.AgencyId);
                tradingAgencyTypeCollector.append(TradingAgencyId.NSLVMOT.AgencyId);
            }
            else if (queueDef.PurchaseTerm == 1)
            {
                tradingAgencyTypeCollector.append(TradingAgencyId.NSL.AgencyId);
                tradingAgencyTypeCollector.append(TradingAgencyId.NSLUK.AgencyId);
            }
            else if (queueDef.PurchaseTerm == 2)
            {
                tradingAgencyTypeCollector.append(TradingAgencyId.NSLVM.AgencyId);
                tradingAgencyTypeCollector.append(TradingAgencyId.NSLVMOT.AgencyId);
            }
            return tradingAgencyTypeCollector;
        }


        private TypeCollector getCustomerDestinationTypeCollector(SunInterfaceQueueDef queueDef)
        {
            TypeCollector customerDestinationTypeCollector = null;

            if (queueDef.UTurn == 1)
                customerDestinationTypeCollector = CustomerDestinationDef.getCollectionForChina();
            else if (queueDef.UTurn == 2)
                customerDestinationTypeCollector = CustomerDestinationDef.getCollectionForNonChina();
            else if (queueDef.UTurn == 0)
            {
                customerDestinationTypeCollector = CustomerDestinationDef.getCollectionForNonChina();
                /*
                customerDestinationTypeCollector = CustomerDestinationDef.getCollection();
                */
            }
            return customerDestinationTypeCollector;
        }

        public ArrayList getInterfaceData(SunInterfaceQueueDef queueDef)
        {
            string commandName = null;

            if (queueDef.CategoryType.Id == CategoryType.ACTUAL.Id)
                commandName = SunInterfaceTypeRef.getActualDataCommandName(queueDef.SunInterfaceTypeId);
            else if (queueDef.CategoryType.Id == CategoryType.ACCRUAL.Id)
                commandName = SunInterfaceTypeRef.getAccrualDataCommandName(queueDef.SunInterfaceTypeId);
            else if (queueDef.CategoryType.Id == CategoryType.REALIZED.Id)
                commandName = SunInterfaceTypeRef.getRealizedDataCommandName(queueDef.SunInterfaceTypeId);
            else if (queueDef.CategoryType.Id == CategoryType.DAILY.Id)
                commandName = SunInterfaceTypeRef.getDailyDataCommandName(queueDef.SunInterfaceTypeId);
            else if (queueDef.CategoryType.Id == CategoryType.REVERSAL.Id)
                commandName = "GetReversalLog";
            else if (queueDef.CategoryType.Id == CategoryType.CONSOLIDATED.Id)
                commandName = "GetConsolidatedLog";

            if (commandName == "N/A")
            {
                throw new ApplicationException("Sun Interface Data Command was not specified");
            }

            TypeCollector termOfPurchaseTypeCollector = this.getTermOfPurchaseTypeCollector(queueDef);
            TypeCollector tradingAgencyTypeCollector = this.getTradingAgencyTypeCollector(queueDef);
            TypeCollector customerDestinationTypeCollector = this.getCustomerDestinationTypeCollector(queueDef);

            IDataSetAdapter ad = getDataSetAdapter("SunInterfaceLogApt", commandName);
            SunInterfaceLogDs dataSet = new SunInterfaceLogDs();
            ad.SelectCommand.MailSQL = true;
            ad.SelectCommand.Parameters["@OfficeGroupId"].Value = queueDef.OfficeGroup.OfficeGroupId;
            ad.SelectCommand.Parameters["@SunInterfaceTypeId"].Value = queueDef.SunInterfaceTypeId;

            if (queueDef.CategoryType.Id == CategoryType.REVERSAL.Id)
                ad.SelectCommand.CustomParameters["@CustomerDestinationIdList"] = CustomDataParameter.parse(customerDestinationTypeCollector.IsInclusive, customerDestinationTypeCollector.Values);
            else
            {
                ad.SelectCommand.Parameters["@FiscalYear"].Value = queueDef.FiscalYear;
                ad.SelectCommand.Parameters["@Period"].Value = queueDef.Period;
                ad.SelectCommand.Parameters["@CategoryId"].Value = queueDef.CategoryType.Id;
                ad.SelectCommand.CustomParameters["@TermOfPurchaseIdList"] = CustomDataParameter.parse(termOfPurchaseTypeCollector.IsInclusive, termOfPurchaseTypeCollector.Values);
                ad.SelectCommand.CustomParameters["@TradingAgencyIdList"] = CustomDataParameter.parse(tradingAgencyTypeCollector.IsInclusive, tradingAgencyTypeCollector.Values);
                ad.SelectCommand.CustomParameters["@CustomerDestinationIdList"] = CustomDataParameter.parse(customerDestinationTypeCollector.IsInclusive, customerDestinationTypeCollector.Values);
            }

            ad.SelectCommand.DbCommand.CommandTimeout = 120;
            int recordsAffected = ad.Fill(dataSet);

            ArrayList list = new ArrayList();

            foreach (SunInterfaceLogDs.SunInterfaceLogRow row in dataSet.SunInterfaceLog)
            {
                SunInterfaceLogDef def = new SunInterfaceLogDef();
                SunInterfaceLogMapping(row, def);
                list.Add(def);
            }
            return list;
        }

        public string getJournalPrefix(int officeId, int tradingAgencyId)
        {
            if (officeId == OfficeId.TR.Id || officeId == OfficeId.UK.Id)
            {
                if (tradingAgencyId == TradingAgencyId.NSLVM.AgencyId)
                    return "V";
                else
                    return "K";
            }
            else
                return OfficeId.getJournalPrefix(officeId);
        }

        public bool isLDPSuppliers(string ukSupplierCode)
        {
            return (ukSupplierCode == "A64960" || ukSupplierCode == "D62560" || ukSupplierCode == "A64950" || ukSupplierCode == "D62530" || ukSupplierCode == "D61090" || ukSupplierCode == "D62540");
        }

        private string getT0Code(SunInterfaceLogDef logDef)
        {
            string t0;
            /*
            string ukSupplierCode = String.Empty;
            ContractDef contractDef = OrderSelectWorker.Instance.getContractByShipmentId(logDef.ShipmentId);
            if (contractDef != null)
                ukSupplierCode = contractDef.UKSupplierCode;
            */

            string productCode = String.Empty;
            ProductCodeRef productCodeRef = generalWorker.getProductCodeRefByKey(logDef.ProductTeamId);
            if (productCodeRef != null)
                productCode = productCodeRef.Code;

            if (logDef.OfficeId == OfficeId.EG.Id)
                t0 = "TK5F"; // "TKEF" 2014-01-28
            else if (logDef.OfficeId == OfficeId.TR.Id || logDef.OfficeId == OfficeId.UK.Id)
            {
                t0 = "TK1F";

                if (isLDPSuppliers(logDef.UKSupplierCode) && logDef.TermOfPurchaseId != TermOfPurchaseRef.Id.FOB.GetHashCode())
                {
                    if (logDef.CountryOfOriginId == CountryOfOriginRef.eCountryId.Morocco.GetHashCode())
                    {
                        t0 = "MO1" + (logDef.TermOfPurchaseId == TermOfPurchaseRef.Id.VMTrading.GetHashCode() ? "F" : "V");
                    }
                    else if (logDef.CountryOfOriginId == CountryOfOriginRef.eCountryId.Egypt.GetHashCode())
                    {
                        t0 = "EG1" + (logDef.TermOfPurchaseId == TermOfPurchaseRef.Id.VMTrading.GetHashCode() ? "F" : "V");
                    }
                }
                else if ((logDef.OfficeId == OfficeId.TR.Id) && logDef.TermOfPurchaseId == TermOfPurchaseRef.Id.FOB.GetHashCode())
                {
                    if (logDef.SunInterfaceTypeId != SunInterfaceTypeRef.Id.AccountReceivable.GetHashCode()
                        && logDef.SunInterfaceTypeId != SunInterfaceTypeRef.Id.AccountPayable.GetHashCode()
                        && logDef.SunInterfaceTypeId != SunInterfaceTypeRef.Id.APAdjustment.GetHashCode()
                        && logDef.SunInterfaceTypeId != SunInterfaceTypeRef.Id.SalesCommissionSettlement.GetHashCode())
                    {
                        if (logDef.CountryOfOriginId == CountryOfOriginRef.eCountryId.Morocco.GetHashCode())
                            t0 = "TKMF";
                        /*
                        else if (logDef.CountryOfOriginId == CountryOfOriginRef.eCountryId.Egypt.GetHashCode())
                            t0 = "TK5F"; // "TKEF" 2014-01-28
                        */
                    }
                }
                else if (logDef.CountryOfOriginId == CountryOfOriginRef.eCountryId.Pakistan.GetHashCode() && logDef.TradingAgencyId == TradingAgencyId.NSL.AgencyId)
                {
                    t0 = "PA1F";
                }
                else if (logDef.TradingAgencyId == TradingAgencyId.NSLVM.AgencyId)
                {
                    if (logDef.TermOfPurchaseId == TermOfPurchaseRef.Id.FOB.GetHashCode())
                        t0 = "VM1F";
                    else
                        t0 = "VM2V";
                }
                else if (logDef.TradingAgencyId == TradingAgencyId.NSLVMOT.AgencyId)
                    t0 = "VM1L";

                /*
                if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.Sales.GetHashCode())
                {
                    if (logDef.CustomerId == CustomerDef.Id.lipsy.GetHashCode() && logDef.TermOfPurchaseId != TermOfPurchaseRef.Id.FOB.GetHashCode())
                    {
                        if (logDef.CountryOfOriginId == CountryOfOriginRef.eCountryId.Morocco.GetHashCode())
                            t0 = "MO1" + (logDef.TermOfPurchaseId == TermOfPurchaseRef.Id.FOB.GetHashCode() ? "F" : "V");
                        else if (logDef.CountryOfOriginId == CountryOfOriginRef.eCountryId.Egypt.GetHashCode() && logDef.TermOfPurchaseId == TermOfPurchaseRef.Id.FOB.GetHashCode())
                            t0 = "EG1" + (logDef.TermOfPurchaseId == TermOfPurchaseRef.Id.FOB.GetHashCode() ? "F" : "V");
                    }
                }
                */
            }
            /*
            else if ((logDef.OfficeId == OfficeId.TH.Id) && logDef.CountryOfOriginId == CountryOfOriginRef.eCountryId.Vietnam.GetHashCode() && (logDef.FiscalYear > 2009 || (logDef.Period > 4 && logDef.FiscalYear == 2009)))
            */
            else if (logDef.OfficeId == OfficeId.VN.Id) // 2011-02-14 Michael Lau
                t0 = "THV2";
            else if (logDef.OfficeId == OfficeId.SH.Id && (productCode == "WT" || productCode == "WST") && logDef.IsNextManufacturingOrder == 1)
                t0 = "SH2T";
            /*
            else if (logDef.OfficeId == OfficeId.SL.Id && logDef.CountryOfOriginId == CountryOfOriginRef.eCountryId.Bangladesh.GetHashCode())
                t0 = "SL2B";
            */
            else if (logDef.OfficeId == OfficeId.BD.Id)
                t0 = "BA1F";
            else if (logDef.OfficeId == OfficeId.DG.Id)
            {
                t0 = "HK1G";

                ShipmentDef shipmentDef = null;
                shipmentDef = OrderSelectWorker.Instance.getShipmentByKey(logDef.ShipmentId);

                if (shipmentDef != null && ((logDef.FiscalYear == 2012 && logDef.Period >= 3) || (logDef.FiscalYear > 2012)))
                {
                    if (shipmentDef.SalesForecastSpecialGroupId == OfficeId.HK.Id)
                        t0 = "FBHK";
                    else if (shipmentDef.SalesForecastSpecialGroupId == OfficeId.SH.Id)
                        t0 = "FBSH";
                    else if (shipmentDef.SalesForecastSpecialGroupId == OfficeId.VN.Id)
                        t0 = "FBVN";
                }
            }
            else if (logDef.OfficeId == OfficeId.SH.Id && logDef.CountryOfOriginId == CountryOfOriginRef.eCountryId.Myanmar.GetHashCode() && logDef.SunInterfaceTypeId != SunInterfaceTypeRef.Id.QCC.GetHashCode() && logDef.SunInterfaceTypeId != SunInterfaceTypeRef.Id.QCCMyanmar.GetHashCode())
            {
                t0 = "SHMY";
            }
            else if (logDef.OfficeId == OfficeId.SH.Id && logDef.CountryOfOriginId == CountryOfOriginRef.eCountryId.Cambodia.GetHashCode() && logDef.SunInterfaceTypeId != SunInterfaceTypeRef.Id.QCC.GetHashCode() && logDef.SunInterfaceTypeId != SunInterfaceTypeRef.Id.QCCMyanmar.GetHashCode())
            {
                t0 = "SHCA";
            }
            else if (logDef.OfficeId == OfficeId.HK.Id && logDef.CountryOfOriginId == CountryOfOriginRef.eCountryId.Myanmar.GetHashCode() && logDef.SunInterfaceTypeId != SunInterfaceTypeRef.Id.QCC.GetHashCode() && logDef.SunInterfaceTypeId != SunInterfaceTypeRef.Id.QCCMyanmar.GetHashCode())
            {
                t0 = "HKMY";
            }
            else if (logDef.OfficeId == OfficeId.HK.Id && logDef.CountryOfOriginId == CountryOfOriginRef.eCountryId.Vietnam.GetHashCode())
            {
                t0 = "HKVM";
            }
            else
            {
                ShipmentDef shipmentDef = null;
                shipmentDef = OrderSelectWorker.Instance.getShipmentByKey(logDef.ShipmentId);

                if (logDef.OfficeId == OfficeId.HK.Id && shipmentDef != null && shipmentDef.SalesForecastSpecialGroupId == OfficeId.DG.Id)
                    t0 = "HKFB";
                else if (logDef.OfficeId == OfficeId.SH.Id && shipmentDef != null && shipmentDef.SalesForecastSpecialGroupId == OfficeId.DG.Id)
                {
                    //t0 = "SHFB"; // 2014-03-03
                    t0 = "SH2F";
                }
                else if (logDef.OfficeId == OfficeId.SH.Id && shipmentDef != null && shipmentDef.SalesForecastSpecialGroupId == OfficeId.DG.Id)
                    t0 = "VNFB";
                else if (logDef.UKSupplierCode == "D68730" || logDef.UKSupplierCode == "D68740" || logDef.UKSupplierCode == "D69380" || logDef.UKSupplierCode == "D68720" || logDef.UKSupplierCode == "D69430") // Tailoring
                {
                    if (logDef.SunInterfaceTypeId != SunInterfaceTypeRef.Id.SalesCommission.GetHashCode())
                        t0 = "HK1T";
                    else
                        t0 = "HK1F";
                }
                /*
                else if ((logDef.OfficeId == OfficeId.HK.Id) && 
                         (productCode == "NCFB" ||
                          productCode == "NCFG" ||
                          productCode == "NCFM" ||
                          productCode == "NCFWC" ||
                          productCode == "NCFWF" ||
                          productCode == "NCFBL" ||
                          productCode == "NCFWB"))
                {
                    t0 = "HK1G";
                }
                */
                else if (logDef.TermOfPurchaseId == TermOfPurchaseRef.Id.FOB.GetHashCode() || logDef.TermOfPurchaseId == TermOfPurchaseRef.Id.FOB_UT.GetHashCode() || logDef.TermOfPurchaseId == TermOfPurchaseRef.Id.CM.GetHashCode())
                {
                    if ((logDef.CustomerId == CustomerDef.Id.japan.GetHashCode()
                        || logDef.CustomerId == CustomerDef.Id.middleeast.GetHashCode()
                        || logDef.CustomerId == CustomerDef.Id.gt.GetHashCode()
                        || logDef.CustomerId == CustomerDef.Id.days.GetHashCode()
                        || logDef.CustomerId == CustomerDef.Id.ezibuy.GetHashCode()
                        || logDef.CustomerId == CustomerDef.Id.bravado.GetHashCode())
                        && (logDef.OfficeId == OfficeId.HK.Id || logDef.OfficeId == OfficeId.SH.Id || logDef.OfficeId == OfficeId.TH.Id))
                        t0 = OfficeId.getTCode(logDef.OfficeId) + "F";
                    else
                        t0 = OfficeId.getTCode(logDef.OfficeId) + "F";
                }
                else
                {
                    if ((logDef.TermOfPurchaseId == TermOfPurchaseRef.Id.VMTrading.GetHashCode() || logDef.TermOfPurchaseId == TermOfPurchaseRef.Id.CMT.GetHashCode()) && logDef.OfficeId == OfficeId.SH.Id)
                        t0 = "SHV2";
                    else if ((logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.SalesCommission.GetHashCode() || logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.SalesCommissionSettlement.GetHashCode()) && (logDef.OfficeId == OfficeId.HK.Id))
                        t0 = "HK1F";
                    else if ((logDef.CustomerId == CustomerDef.Id.directory.GetHashCode()
                        || logDef.CustomerId == CustomerDef.Id.retail.GetHashCode()
                        || logDef.CustomerId == CustomerDef.Id.ntn_retail.GetHashCode()
                        || logDef.CustomerId == CustomerDef.Id.ntn_directory.GetHashCode()
                        || logDef.CustomerId == CustomerDef.Id.lime.GetHashCode()) && logDef.OfficeId == OfficeId.SH.Id && (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.SalesCommission.GetHashCode() || logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.SalesCommissionSettlement.GetHashCode()))
                        t0 = "HK1F";
                    else if ((logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.ILSSalesCommissionDiscrepancy.GetHashCode()
                        || logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.ILSSalesDiscrepancy.GetHashCode()) && (logDef.OfficeId == OfficeId.SH.Id || logDef.OfficeId == OfficeId.HK.Id))
                        t0 = "HK1F";
                    else if (logDef.IsSampleOrder && (logDef.OfficeId == OfficeId.HK.Id || logDef.OfficeId == OfficeId.SH.Id))
                        t0 = OfficeId.getTCode(logDef.OfficeId) + "F";
                    else
                        t0 = OfficeId.getTCode(logDef.OfficeId) + "V";
                }
            }
            return t0;
        }

        private string getT5Code(int seasonId)
        {
            string seasonCode = generalWorker.getSeasonByKey(seasonId).Code;
            return seasonCode.Substring(0, 1) + seasonCode.Substring(6);
        }

        private string getSeasonSegmentValue(int seasonId)
        {
            string seasonCode = generalWorker.getSeasonByKey(seasonId).Code;
            return seasonCode.Substring(0, 3).Replace("/", string.Empty) + seasonCode.Substring(6);
        }

        private string getT6Code(int paymentTermId)
        {
            return PaymentTermRef.getDescriptionForSAF(paymentTermId).Substring(0, 1);
        }

        private string getT8Code(int productId)
        {
            return ProductWorker.Instance.getProductByKey(productId).ItemNo;
        }

        private string getT9Code(SunInterfaceLogDef logDef)
        {
            /*
            CutOffStatusRef cutOffDef = this.getCutOffStatus(logDef.ShipmentId);

            if (cutOffDef.CutOffStatusId == CutOffStatus.UNDEFINED.GetHashCode() || cutOffDef.FiscalYear > 2009)
            {
                if (logDef.SequenceNo == 0)
                    return ShippingWorker.getInvoiceNo(logDef.InvoicePrefix, logDef.InvoiceSequence, logDef.InvoiceYear);
                else
                    return ShippingWorker.getInvoiceNo(logDef.InvoicePrefix, logDef.InvoiceSequence, logDef.InvoiceYear) + "-" + logDef.SequenceNo.ToString();
            }
            else
            {
                if (logDef.SequenceNo == 0)
                    return logDef.InvoicePrefix + logDef.InvoiceSequence.ToString().PadLeft(5, '0') + "/" + logDef.InvoiceYear.ToString().Substring(2);
                else
                    return logDef.InvoicePrefix + logDef.InvoiceSequence.ToString().PadLeft(5, '0') + "/" + logDef.InvoiceYear.ToString().Substring(2) + "-" + logDef.SequenceNo.ToString();
            }
            */

            if (logDef.InvoiceYear > 2009)
            {
                /*
                if (logDef.SequenceNo == 0)
                    return ShippingWorker.getInvoiceNo(logDef.InvoicePrefix, logDef.InvoiceSequence, logDef.InvoiceYear);
                else
                    return ShippingWorker.getInvoiceNo(logDef.InvoicePrefix, logDef.InvoiceSequence, logDef.InvoiceYear) + "-" + logDef.SequenceNo.ToString();
                */
                return ShippingWorker.getInvoiceNo(logDef.InvoicePrefix, logDef.InvoiceSequence, logDef.InvoiceYear);
            }
            else
            {
                if (logDef.SequenceNo == 0)
                    return logDef.InvoicePrefix + logDef.InvoiceSequence.ToString().PadLeft(5, '0') + "/" + logDef.InvoiceYear.ToString().Substring(2);
                else
                    return logDef.InvoicePrefix + logDef.InvoiceSequence.ToString().PadLeft(5, '0') + "/" + logDef.InvoiceYear.ToString().Substring(2) + "-" + logDef.SequenceNo.ToString();
            }
        }

        private bool isDGOfficeOrder(SunInterfaceLogDef logDef)
        {
            if (logDef.OfficeId == OfficeId.HK.Id)
            {
                ProductCodeDef def = generalWorker.getProductCodeDefByKey(logDef.ProductTeamId);
                if (def.Code == "NCFB" ||
                    def.Code == "NCFG" ||
                    def.Code == "NCFM" ||
                    def.Code == "NCFWC" ||
                    def.Code == "NCFWF" ||
                    def.Code == "NCFBL" ||
                    def.Code == "NCFWB")
                    return true;
            }
            return false;
        }

        private bool isNextLEDOrder(SunInterfaceLogDef logDef)
        {
            ProductCodeDef def = generalWorker.getProductCodeDefByKey(logDef.ProductTeamId);
            if (def.Code == "WNEXT")
                return true;
            return false;
        }

        private string getT1Code(SunInterfaceLogDef logDef)
        {
            string s = String.Empty;

            s = generalWorker.getT1CodeByKey(logDef.ProductTeamId);

            if (logDef.DesignSourceId == DesignSourceRef.SourceId.RR.GetHashCode())
            {
                if ((logDef.OfficeId == OfficeId.HK.Id || logDef.OfficeId == OfficeId.SH.Id) &&
                (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.Purchase.GetHashCode() ||
                logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.Sales.GetHashCode() ||
                logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.SalesCommission.GetHashCode()))
                    s = "222";
            }

            /*
            if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.Purchase.GetHashCode())
            {
                ProductCodeDef def = generalWorker.getProductCodeDefByKey(logDef.ProductTeamId);
                if (def.Code == "NCBBC" ||
                    def.Code == "NCGBC" ||
                    def.Code == "NCWBC" ||
                    def.Code == "NCBTB" ||
                    def.Code == "NCBF" ||
                    def.Code == "NCBC" ||
                    def.Code == "NCMBC")
                    s = "267";
            }
            */

            if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.SalesCommission.GetHashCode())
            {
                if (logDef.OfficeId == OfficeId.SL.Id
                    && (logDef.CustomerId == CustomerDef.Id.ntn_retail.GetHashCode() || logDef.CustomerId == CustomerDef.Id.ntn_directory.GetHashCode())
                    && logDef.VendorId == 3154) // NEXT MANUFACTURING (PVT.) LTD
                    s = "520";
            }

            if (logDef.ProductTeamId != 0 && s.Trim() == String.Empty)
                throw new ApplicationException("Missing T1 Code");
            else
                return s;
        }

        private void addAccrualSalesToSAFList(SunInterfaceLogDef logDef, ArrayList safList)
        {
            if (logDef.BaseAmount == 0) return;
            string t0 = getT0Code(logDef); ;
            GLInterfaceEntry entry = new GLInterfaceEntry();

            #region sales debit entry

            entry.Reverse = true;
            entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
            entry.GroupId = EpicorInterfaceWorker.Instance.GLInterfaceFile.getSourceString();
            entry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
            entry.ApplyDate = entry.GroupApplyDate;
            entry.DocumentType = GLDocumentTypeEnum.ISAM_ACCRUAL_SALES;
            entry.COA = generalWorker.getEpicorCOA("1307999");
            entry.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
            entry.DC = DCFlag.Debit;
            entry.Amount = logDef.OtherAmount;
            entry.BaseAmount = logDef.BaseAmount;
            entry.Qty = logDef.Quantity * logDef.PiecesPerPack;
            entry.LineDescription = logDef.ContractNo + "-" + logDef.DeliveryNo.ToString() + " #" + ProductWorker.Instance.getProductByKey(logDef.ProductId).ItemNo;
            if (t0 == "TK5F") entry.Office = "TK1F";
            else if (t0 == "TKMF") entry.Office = "TK1F";
            else entry.Office = t0;
            EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);

            #endregion

            #region sales credit entry

            entry = (GLInterfaceEntry)entry.Clone();
            entry.COA = generalWorker.getEpicorCOA("2101901");
            entry.Office = t0;
            entry.DC = DCFlag.Credit;
            entry.SegmentValue3 = getT1Code(logDef);
            entry.SegmentValue4 = generalWorker.getProductCodeDefByKey(logDef.ProductTeamId).Code;
            entry.SegmentValue5 = getSeasonSegmentValue(logDef.SeasonId);
            entry.IsRecordComplete = true;
            EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);

            #endregion
        }

        private DateTime getLastDayOfCalendarMonthByPeriod(int fiscalYear, int period)
        {
            DateTime d;
            if (period == 12)
                d = (new DateTime(fiscalYear + 1, 2, 1)).AddDays(-1);
            else if (period == 11)
                d = (new DateTime(fiscalYear + 1, 1, 1)).AddDays(-1);
            else
                d = (new DateTime(fiscalYear, period + 2, 1)).AddDays(-1);
            return d;
        }

        private bool isEnableWeek53Handling(SunInterfaceLogDef logDef, bool isReversal)
        {
            return (WK53_HANDLING
                    && ((logDef.CategoryId != CategoryType.REVERSAL.Id && logDef.TransactionDate >= WK53_FROM_DATE && logDef.TransactionDate <= WK53_END_DATE)
                         || ((isReversal || logDef.CategoryId == CategoryType.REVERSAL.Id) && logDef.Period == 12 && DateTime.Today >= WK53_FROM_DATE)));
        }

        private void addActualSalesToSAFList(SunInterfaceLogDef logDef, ArrayList safList, bool isReversal, bool settled)
        {
            if (logDef.BaseAmount == 0) return;
            string t0 = getT0Code(logDef);
            decimal daysARBaseAmt = 0;
            decimal daysAROtherAmt = 0;
            SAFDef def = null;
            GLInterfaceEntry glEntry = new GLInterfaceEntry();
            bool isILS = false;
            string salesCOA = string.Empty;

            ShipmentDef shipmentDef = OrderSelectWorker.Instance.getShipmentByKey(logDef.ShipmentId);
            ContractDef contractDef = OrderSelectWorker.Instance.getContractByKey(shipmentDef.ContractId);

            #region sales debit entry
            if ((logDef.CustomerId != CustomerDef.Id.days.GetHashCode() && (!logDef.IsSampleOrder || (logDef.IsSampleOrder && (logDef.CategoryId == CategoryType.REVERSAL.Id || isReversal))))
                || (logDef.CustomerId == CustomerDef.Id.days.GetHashCode() &&
                    !htUniqueKeyList.ContainsKey(ShippingWorker.getInvoiceNo(logDef.InvoicePrefix, logDef.InvoiceSequence, logDef.InvoiceYear))))
            {
                if (logDef.CustomerId == CustomerDef.Id.days.GetHashCode())
                {
                    this.getDaysAmountsByInvoiceNo(logDef.InvoicePrefix, logDef.InvoiceSequence, logDef.InvoiceYear, out daysARBaseAmt, out daysAROtherAmt);
                    htUniqueKeyList.Add(ShippingWorker.getInvoiceNo(logDef.InvoicePrefix, logDef.InvoiceSequence, logDef.InvoiceYear), daysARBaseAmt);
                }
                def = new SAFDef();
                if (logDef.CustomerId == CustomerDef.Id.japan.GetHashCode())
                    def.AccountCode = "1306401";
                else if (logDef.CustomerId == CustomerDef.Id.middleeast.GetHashCode())
                    def.AccountCode = "1303001";
                else if (logDef.CustomerId == CustomerDef.Id.choice.GetHashCode())
                    def.AccountCode = "1320301";
                else if (logDef.CustomerId == CustomerDef.Id.gt.GetHashCode())
                    def.AccountCode = "1303701";
                else if (logDef.CustomerId == CustomerDef.Id.lipsy.GetHashCode())
                    def.AccountCode = "1320117";
                else if (logDef.CustomerId == CustomerDef.Id.days.GetHashCode())
                    def.AccountCode = "1303401";
                else if (logDef.CustomerId == CustomerDef.Id.ezibuy.GetHashCode())
                {
                    if (contractDef.PhaseId >= 3)
                        def.AccountCode = "1303403";
                    else
                        def.AccountCode = "1303402";
                }
                else if (logDef.CustomerId == CustomerDef.Id.bravado.GetHashCode())
                    def.AccountCode = "1303801";
                else if (logDef.CustomerId == CustomerDef.Id.smithbrooks.GetHashCode())
                {
                    if (logDef.IsSampleOrder)
                        def.AccountCode = "1320111";
                    else
                        def.AccountCode = "1303404";
                }
                else if (logDef.CustomerId == CustomerDef.Id.fashionUK.GetHashCode())
                    def.AccountCode = "1303405";
                else if (logDef.CustomerId == CustomerDef.Id.misirli.GetHashCode())
                    def.AccountCode = "1303407";
                else if (logDef.CustomerId == CustomerDef.Id.global_licensing.GetHashCode())
                {
                    if (logDef.IsSampleOrder)
                        def.AccountCode = "1320111";
                    else
                        def.AccountCode = "1303406";
                }
                else if (logDef.CustomerId == CustomerDef.Id.hempel.GetHashCode() && logDef.CurrencyId == CurrencyId.USD.Id)
                    def.AccountCode = "1320182";
                //else if (CustomerDestinationDef.isUTurnOrder(logDef.CustomerDestinationId))
                else if (logDef.TermOfPurchaseId == TermOfPurchaseRef.Id.FOB_UT.GetHashCode())
                    def.AccountCode = "1320182";
                else
                    def.AccountCode = "1320111";
                def.FiscalYear = logDef.FiscalYear;
                def.Period = logDef.Period;
                def.TransactionDate = logDef.TransactionDate;
                def.DebitCreditIndicator = !isReversal ? "D" : "C";
                def.IsMockShopSample = (logDef.IsSampleOrder ? true : false);

                //if (CustomerDestinationDef.isUTurnOrder(logDef.CustomerDestinationId))
                if (logDef.TermOfPurchaseId == TermOfPurchaseRef.Id.FOB_UT.GetHashCode())
                {
                    def.BaseAmount = logDef.UTTotalShippedAmount + logDef.UTImportDuty + logDef.UTSalesCommission;
                    def.JournalType = "Y" + "IS";
                }
                else
                {
                    def.JournalType = getJournalPrefix(logDef.OfficeId, logDef.TradingAgencyId) + "IS";
                    def.BaseAmount = (logDef.CustomerId == CustomerDef.Id.days.GetHashCode()) ? daysARBaseAmt : logDef.BaseAmount;
                }
                def.Description = (logDef.ContractNo.Length <= 15 ? logDef.ContractNo : logDef.ContractNo.Substring(0, 15)) + " " + (logDef.Quantity * logDef.PiecesPerPack).ToString() + " PCS";
                def.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
                def.OtherAmount = (logDef.CustomerId == CustomerDef.Id.days.GetHashCode()) ? daysAROtherAmt : logDef.OtherAmount;
                //if (CustomerDestinationDef.isUTurnOrder(logDef.CustomerDestinationId))
                if (logDef.TermOfPurchaseId == TermOfPurchaseRef.Id.FOB_UT.GetHashCode())
                    def.T0 = "FY1U";
                else
                {
                    if (t0 == "TKMF") def.T0 = "TK1F";
                    else if (t0 == "TK5F") def.T0 = "TK1F";
                    /*
                    else if (t0 == "THV2") def.T0 = "TH2F";
                    */
                    else if (t0 == "THV2" && logDef.OfficeId != OfficeId.VN.Id) def.T0 = "TH2F";
                    else if (t0 == "THV2" && logDef.OfficeId == OfficeId.VN.Id && logDef.CurrencyId == CurrencyId.GBP.Id) def.T0 = "THV2";
                    else if (t0 == "HK1G" || t0 == "FBHK" || t0 == "HKFB") def.T0 = "HK1F";
                    else if (t0 == "FBSH" || t0 == "SHFB") def.T0 = "SH2F";
                    else if (t0 == "FBVN" || t0 == "VNFB") def.T0 = "THV2";
                    else def.T0 = t0;
                }
                def.T1 = getT1Code(logDef);
                def.T2 = generalWorker.getProductCodeDefByKey(logDef.ProductTeamId).Code;
                def.T5 = getT5Code(logDef.SeasonId);
                def.T8 = getT8Code(logDef.ProductId);
                def.T9 = getT9Code(logDef);
                def.OfficeCode = OfficeId.getName(logDef.OfficeId);
                def.TradingAgency = TradingAgencyId.getName(logDef.TradingAgencyId);
                def.PaymentTerm = PaymentTermRef.getDescriptionForSAF(logDef.PaymentTermId);

                /*
                if (settled & isReversal == false)
                */
                if (settled)
                {
                    /*
                    AccountFinancialCalenderDef logCalDef = generalWorker.getAccountPeriodByDate(9, logDef.CreatedOn.Date);
                    */
                    InvoiceDef invoiceDef = ShippingWorker.Instance.getInvoiceByKey(logDef.ShipmentId);

                    AccountFinancialCalenderDef settledCalDef = null;
                    if (invoiceDef.ARDate != DateTime.MinValue)
                        settledCalDef = generalWorker.getAccountPeriodByDate(9, invoiceDef.ARDate);

                    //if (invoiceDef.ARDate == DateTime.MinValue || (settledCalDef.BudgetYear == logDef.FiscalYear && settledCalDef.Period == logDef.Period)) 
                    if (invoiceDef.ARDate == DateTime.MinValue) // Modified By Michael Lau @2016-06-07
                        def.AccountCode = "1320111";
                    else
                    {
                        isILS = true;
                        def.AccountCode = "1411132";

                        if ((logDef.CustomerId == CustomerDef.Id.ns_led.GetHashCode() || logDef.CustomerId == CustomerDef.Id.manu_led.GetHashCode()) && commonWorker.getNSLedSelfBilledSupplierCodeList().Contains(contractDef.UKSupplierCode))
                        {
                            def.AccountCode = "1450070";
                        }
                    }
                    /*
                    if (logCalDef.BudgetYear > settledCalDef.BudgetYear || (logCalDef.BudgetYear == settledCalDef.BudgetYear && logCalDef.Period > settledCalDef.Period))
                        def.AccountCode = "1411132";
                    else
                        def.AccountCode = "1320111";                                        
                    */

                    /*
                    def.AccountCode = "1411132";
                    */
                    if (def.IsMockShopSample)
                        def.Description = "DIFF ON MS " + getT9Code(logDef);
                    else
                        def.Description = "DIFF ON " + getT9Code(logDef);

                    /* TODO:EPICOR */
                    if (isILS)
                    {
                        glEntry = new GLInterfaceEntry();
                        glEntry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
                        glEntry.GroupId = EpicorInterfaceWorker.Instance.GLInterfaceFile.getSourceString();
                        glEntry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                        glEntry.ApplyDate = glEntry.GroupApplyDate;

                        if (isEnableWeek53Handling(logDef, isReversal))
                        {
                            glEntry.GroupApplyDate = WK53_APPLY_DATE;
                            glEntry.ApplyDate = WK53_APPLY_DATE;
                        }

                        glEntry.DocumentType = GLDocumentTypeEnum.GL;
                        glEntry.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
                        glEntry.DC = !isReversal ? DCFlag.Debit : DCFlag.Credit;
                        glEntry.Qty = logDef.Quantity * logDef.PiecesPerPack;
                        glEntry.Amount = logDef.OtherAmount;
                        glEntry.BaseAmount = logDef.BaseAmount;
                        glEntry.LineDescription = getT9Code(logDef);
                        glEntry.LineComment = DateTimeUtility.getDateString(logDef.TransactionDate) + "|" + ProductWorker.Instance.getProductByKey(logDef.ProductId).ItemNo + "|" + generalWorker.getProductCodeDefByKey(logDef.ProductTeamId).Code + "|" + logDef.ContractNo + "|" + logDef.Quantity.ToString() + "|Sales Correction|";
                        glEntry.Office = def.T0;
                        glEntry.COA = generalWorker.getEpicorCOA(def.AccountCode);
                        glEntry.IsRecordComplete = false;
                        EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);
                    }

                }
                safList.Add(def);

                /*
                if (!(isReversal == false && (logDef.IsSelfBilledOrder || logDef.IsSampleOrder) && diffAmt != 0))
                    safList.Add(def);
                else if (isReversal && (logDef.IsSelfBilledOrder || logDef.IsSampleOrder) && diffAmt != 0)
                {
                    InvoiceDef invoiceDef = ShippingWorker.Instance.getInvoiceByKey(logDef.ShipmentId);
                    if (invoiceDef.ARDate != DateTime.MinValue) 
                        def.AccountCode = "1411132";
                    if (def.IsMockShopSample)
                        def.Description = "DIFF ON MS " + getT9Code(logDef);
                    else
                        def.Description = "DIFF ON " + getT9Code(logDef);
                    safList.Add(def);
                }
                */
            #endregion
            }

            #region sales credit entry
            def = new SAFDef();
            def.CreateDate = DateTime.Now;
            //if (CustomerDestinationDef.isUTurnOrder(logDef.CustomerDestinationId))
            if (logDef.TermOfPurchaseId == TermOfPurchaseRef.Id.FOB_UT.GetHashCode())
                def.AccountCode = "2101601";
            else if (logDef.CustomerId == CustomerDef.Id.hempel.GetHashCode() && logDef.CurrencyId == CurrencyId.USD.Id)
                def.AccountCode = "2101601";
            else if (CustomerDef.isNextRetail(logDef.CustomerId))
                def.AccountCode = "2101101";
            else if (logDef.CustomerId == CustomerDef.Id.directory.GetHashCode() || logDef.CustomerId == CustomerDef.Id.ntn_directory.GetHashCode())
                def.AccountCode = "2101102";
            else if (logDef.CustomerId == CustomerDef.Id.japan.GetHashCode())
                def.AccountCode = "2101401";
            else if (logDef.CustomerId == CustomerDef.Id.middleeast.GetHashCode())
                def.AccountCode = "2101402";
            else if (logDef.CustomerId == CustomerDef.Id.choice.GetHashCode())
                def.AccountCode = "2101301";
            else if (logDef.CustomerId == CustomerDef.Id.lipsy.GetHashCode())
                def.AccountCode = "2101105";
            else if (logDef.CustomerId == CustomerDef.Id.gt.GetHashCode())
                def.AccountCode = "2101403";
            else if (logDef.CustomerId == CustomerDef.Id.days.GetHashCode())
                def.AccountCode = "2101404";
            else if (logDef.CustomerId == CustomerDef.Id.ezibuy.GetHashCode())
                def.AccountCode = "2101405";
            else if (logDef.CustomerId == CustomerDef.Id.bravado.GetHashCode())
                def.AccountCode = "2101406";
            else if (logDef.CustomerId == CustomerDef.Id.global_licensing.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    def.AccountCode = "2101101";
                else
                    def.AccountCode = "2101411";
            }
            else if (logDef.CustomerId == CustomerDef.Id.fashionUK.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    def.AccountCode = "2101101";
                else
                    def.AccountCode = "2102409";
            }
            else if (logDef.CustomerId == CustomerDef.Id.misirli.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    def.AccountCode = "2101101";
                else
                    def.AccountCode = "2101412";
            }
            else if (logDef.CustomerId == CustomerDef.Id.smithbrooks.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    def.AccountCode = "2101101";
                else
                    def.AccountCode = "2101408";
            }
            else if (t0 == "HK1G" || t0 == "FBHK" || t0 == "FBSH" || t0 == "FBVN" || t0 == "HKFB" || t0 == "SHFB" || t0 == "VNFB")
                def.AccountCode = "2102101";
            def.FiscalYear = logDef.FiscalYear;
            def.Period = logDef.Period;
            def.TransactionDate = logDef.TransactionDate;
            def.BaseAmount = logDef.BaseAmount;
            def.OtherAmount = logDef.OtherAmount;

            //if (CustomerDestinationDef.isUTurnOrder(logDef.CustomerDestinationId))
            if (logDef.TermOfPurchaseId == TermOfPurchaseRef.Id.FOB_UT.GetHashCode())
            {
                def.BaseAmount = logDef.UTTotalShippedAmount;
                def.JournalType = "Y" + "IS";
            }
            else
                def.JournalType = getJournalPrefix(logDef.OfficeId, logDef.TradingAgencyId) + "IS";

            if (logDef.CustomerId == CustomerDef.Id.days.GetHashCode())
            {
                def.BaseAmount = Math.Round(logDef.BaseAmount / Convert.ToDecimal(1.08), 2, MidpointRounding.AwayFromZero);
                def.OtherAmount = Math.Round(logDef.OtherAmount / Convert.ToDecimal(1.08), 2, MidpointRounding.AwayFromZero);
            }
            def.DebitCreditIndicator = !isReversal ? "C" : "D";
            def.Description = (logDef.ContractNo.Length <= 15 ? logDef.ContractNo : logDef.ContractNo.Substring(0, 15)) + " " + (logDef.Quantity * logDef.PiecesPerPack).ToString() + " PCS";
            def.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
            def.IsMockShopSample = (logDef.IsSampleOrder ? true : false);

            //if (CustomerDestinationDef.isUTurnOrder(logDef.CustomerDestinationId))
            if (logDef.TermOfPurchaseId == TermOfPurchaseRef.Id.FOB_UT.GetHashCode())
                def.T0 = "FY1U";
            else def.T0 = t0;

            if (t0 == "TK4F" && !isReversal) totalBaseAmt += def.BaseAmount;
            if (t0 == "TK4F" && isReversal) totalReverseBaseAmt += def.BaseAmount;
            /*
            if ((t0 == "THV2" || t0 == "HK1G") && !isReversal && !CustomerDestinationDef.isUTurnOrder(logDef.CustomerDestinationId)) totalBaseAmt += def.BaseAmount;
            */
            //if ((t0 == "HK1G") && !isReversal && !CustomerDestinationDef.isUTurnOrder(logDef.CustomerDestinationId)) totalBaseAmt += def.BaseAmount;
            if ((t0 == "HK1G") && !isReversal && logDef.TermOfPurchaseId != TermOfPurchaseRef.Id.FOB_UT.GetHashCode()) totalBaseAmt += def.BaseAmount;
            if ((t0 == "FBHK") && !isReversal) totalFBHKBaseAmt += def.BaseAmount;
            if ((t0 == "FBSH") && !isReversal) totalFBSHBaseAmt += def.BaseAmount;
            if ((t0 == "FBVN") && !isReversal) totalFBVNBaseAmt += def.BaseAmount;
            if ((t0 == "HKFB") && !isReversal) totalHKFBBaseAmt += def.BaseAmount;
            if ((t0 == "SHFB") && !isReversal) totalSHFBBaseAmt += def.BaseAmount;
            if ((t0 == "VNFB") && !isReversal) totalVNFBBaseAmt += def.BaseAmount;

            //if (t0 == "THV2" && !isReversal && !CustomerDestinationDef.isUTurnOrder(logDef.CustomerDestinationId) && logDef.OfficeId != OfficeId.VN.Id) totalBaseAmt += def.BaseAmount;
            //if (t0 == "THV2" && !isReversal && !CustomerDestinationDef.isUTurnOrder(logDef.CustomerDestinationId) && logDef.OfficeId == OfficeId.VN.Id && logDef.CurrencyId == CurrencyId.GBP.Id) totalBaseAmt += def.BaseAmount;

            if (t0 == "THV2" && !isReversal && logDef.TermOfPurchaseId != TermOfPurchaseRef.Id.FOB_UT.GetHashCode() && logDef.OfficeId != OfficeId.VN.Id) totalBaseAmt += def.BaseAmount;
            if (t0 == "THV2" && !isReversal && logDef.TermOfPurchaseId != TermOfPurchaseRef.Id.FOB_UT.GetHashCode() && logDef.OfficeId == OfficeId.VN.Id && logDef.CurrencyId == CurrencyId.GBP.Id) totalBaseAmt += def.BaseAmount;

            /*
            if ((t0 == "THV2" || t0 == "HK1G") && isReversal && !CustomerDestinationDef.isUTurnOrder(logDef.CustomerDestinationId)) totalReverseBaseAmt += def.BaseAmount;
            */
            //if (t0 == "HK1G" && isReversal && !CustomerDestinationDef.isUTurnOrder(logDef.CustomerDestinationId)) totalReverseBaseAmt += def.BaseAmount;
            if (t0 == "HK1G" && isReversal && logDef.TermOfPurchaseId != TermOfPurchaseRef.Id.FOB_UT.GetHashCode()) totalReverseBaseAmt += def.BaseAmount;
            if (t0 == "FBHK" && isReversal) totalFBHKReverseBaseAmt += def.BaseAmount;
            if (t0 == "FBSH" && isReversal) totalFBSHReverseBaseAmt += def.BaseAmount;
            if (t0 == "FBVN" && isReversal) totalFBVNReverseBaseAmt += def.BaseAmount;
            if (t0 == "HKFB" && isReversal) totalHKFBReverseBaseAmt += def.BaseAmount;
            if (t0 == "SHFB" && isReversal) totalSHFBReverseBaseAmt += def.BaseAmount;
            if (t0 == "VNFB" && isReversal) totalVNFBReverseBaseAmt += def.BaseAmount;

            //if (t0 == "THV2" && isReversal && !CustomerDestinationDef.isUTurnOrder(logDef.CustomerDestinationId) && logDef.OfficeId != OfficeId.VN.Id) totalReverseBaseAmt += def.BaseAmount;
            //if (t0 == "THV2" && isReversal && !CustomerDestinationDef.isUTurnOrder(logDef.CustomerDestinationId) && logDef.OfficeId == OfficeId.VN.Id && logDef.CurrencyId == CurrencyId.GBP.Id) totalReverseBaseAmt += def.BaseAmount;

            if (t0 == "THV2" && isReversal && logDef.TermOfPurchaseId != TermOfPurchaseRef.Id.FOB_UT.GetHashCode() && logDef.OfficeId != OfficeId.VN.Id) totalReverseBaseAmt += def.BaseAmount;
            if (t0 == "THV2" && isReversal && logDef.TermOfPurchaseId != TermOfPurchaseRef.Id.FOB_UT.GetHashCode() && logDef.OfficeId == OfficeId.VN.Id && logDef.CurrencyId == CurrencyId.GBP.Id) totalReverseBaseAmt += def.BaseAmount;

            def.T1 = getT1Code(logDef);
            def.T2 = generalWorker.getProductCodeDefByKey(logDef.ProductTeamId).Code;
            def.T5 = getT5Code(logDef.SeasonId);
            def.T8 = getT8Code(logDef.ProductId);
            def.T9 = getT9Code(logDef);
            def.OfficeCode = OfficeId.getName(logDef.OfficeId);
            def.TradingAgency = TradingAgencyId.getName(logDef.TradingAgencyId);
            def.PaymentTerm = PaymentTermRef.getDescriptionForSAF(logDef.PaymentTermId);
            safList.Add(def);
            #endregion

            /*
            //if (diffAmt != 0 && isReversal == false)
            if (isReversal == false && (logDef.IsSelfBilledOrder || logDef.IsSampleOrder) && diffAmt != 0)
            {
                #region ILS Adjustment
                def = (SAFDef)def.Clone();
                def.CreateDate = DateTime.Now;
                def.AccountCode = "1411132";
                def.DebitCreditIndicator = "D";
                if (def.IsMockShopSample)
                    def.Description = "DIFF ON MS " + getT9Code(logDef);
                else
                    def.Description = "DIFF ON " + getT9Code(logDef);
                safList.Add(def);
                #endregion
            }
            */

            if (logDef.CustomerId == CustomerDef.Id.days.GetHashCode())
            {
                #region days commission credit entry
                def = (SAFDef)def.Clone();
                def.CreateDate = DateTime.Now;
                def.AccountCode = "2102107";
                def.DebitCreditIndicator = !isReversal ? "C" : "D";
                def.BaseAmount = logDef.BaseAmount - Math.Round(logDef.BaseAmount / Convert.ToDecimal(1.08), 2, MidpointRounding.AwayFromZero);
                def.OtherAmount = logDef.OtherAmount - Math.Round(logDef.OtherAmount / Convert.ToDecimal(1.08), 2, MidpointRounding.AwayFromZero);
                safList.Add(def);
                #endregion
            }

            #region qty dummy entry
            def = (SAFDef)def.Clone();
            def.CreateDate = DateTime.Now;
            //if (CustomerDestinationDef.isUTurnOrder(logDef.CustomerDestinationId))
            if (logDef.TermOfPurchaseId == TermOfPurchaseRef.Id.FOB_UT.GetHashCode())
                def.AccountCode = "7001109";
            else if (logDef.CustomerId == CustomerDef.Id.hempel.GetHashCode() && logDef.CurrencyId == CurrencyId.USD.Id)
                def.AccountCode = "7001109";
            else if (CustomerDef.isNextRetail(logDef.CustomerId))
                def.AccountCode = "7001101";
            else if (logDef.CustomerId == CustomerDef.Id.directory.GetHashCode() || logDef.CustomerId == CustomerDef.Id.ntn_directory.GetHashCode())
                def.AccountCode = "7001102";
            else if (logDef.CustomerId == CustomerDef.Id.lipsy.GetHashCode())
                def.AccountCode = "7001110";
            else if (logDef.CustomerId == CustomerDef.Id.choice.GetHashCode())
                def.AccountCode = "7001111";
            else if (logDef.CustomerId == CustomerDef.Id.japan.GetHashCode())
                def.AccountCode = "7001112";
            else if (logDef.CustomerId == CustomerDef.Id.middleeast.GetHashCode())
                def.AccountCode = "7001113";
            else if (logDef.CustomerId == CustomerDef.Id.gt.GetHashCode())
                def.AccountCode = "7001114";
            else if (logDef.CustomerId == CustomerDef.Id.days.GetHashCode())
                def.AccountCode = "7001115";
            else if (logDef.CustomerId == CustomerDef.Id.ezibuy.GetHashCode())
                def.AccountCode = "7001116";
            else if (logDef.CustomerId == CustomerDef.Id.bravado.GetHashCode())
                def.AccountCode = "7001118";
            else if (logDef.CustomerId == CustomerDef.Id.global_licensing.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    def.AccountCode = "7001101";
                else
                    def.AccountCode = "7001121";
            }
            else if (logDef.CustomerId == CustomerDef.Id.fashionUK.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    def.AccountCode = "7001101";
                else
                    def.AccountCode = "7001120";
            }
            else if (logDef.CustomerId == CustomerDef.Id.misirli.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    def.AccountCode = "7001101";
                else
                    def.AccountCode = "7001122";
            }
            else if (logDef.CustomerId == CustomerDef.Id.smithbrooks.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    def.AccountCode = "7001101";
                else
                    def.AccountCode = "7001119";
            }
            def.DebitCreditIndicator = !isReversal ? "D" : "C";
            def.BaseAmount = logDef.Quantity * logDef.PiecesPerPack;
            def.Description = (logDef.ContractNo.Length <= 15 ? logDef.ContractNo : logDef.ContractNo.Substring(0, 15)) + " " + (logDef.Quantity * logDef.PiecesPerPack).ToString() + " PCS";
            def.CurrencyCode = String.Empty;
            def.OtherAmount = 0;
            //if (CustomerDestinationDef.isUTurnOrder(logDef.CustomerDestinationId))
            if (logDef.TermOfPurchaseId == TermOfPurchaseRef.Id.FOB_UT.GetHashCode())
                def.T0 = "FY1U";
            else
                def.T0 = t0;
            safList.Add(def);
            #endregion

            //if (CustomerDestinationDef.isUTurnOrder(logDef.CustomerDestinationId))
            if (logDef.TermOfPurchaseId == TermOfPurchaseRef.Id.FOB_UT.GetHashCode())
            {
                #region commission credit entry
                def = (SAFDef)def.Clone();
                def.AccountCode = "2101601";
                def.DebitCreditIndicator = !isReversal ? "C" : "D";
                def.BaseAmount = logDef.UTSalesCommission;
                def.Description = "Com inc " + logDef.Period.ToString().PadLeft(2, '0') + "/" + logDef.FiscalYear.ToString().Substring(2);
                def.CurrencyCode = "CNY";
                def.OtherAmount = logDef.SalesCommission;
                safList.Add(def);
                #endregion

                #region vat debit entry
                def = (SAFDef)def.Clone();
                def.AccountCode = "1320182";
                def.DebitCreditIndicator = !isReversal ? "D" : "C";
                def.BaseAmount = logDef.UTOutputVATAmount;
                def.Description = "VAT Output";
                def.CurrencyCode = "CNY";
                def.OtherAmount = logDef.UTOutputVATAmount;
                safList.Add(def);
                #endregion

                #region vat credit entry
                def = (SAFDef)def.Clone();
                def.AccountCode = "1506106";
                def.DebitCreditIndicator = !isReversal ? "C" : "D";
                def.BaseAmount = logDef.UTOutputVATAmount;
                def.Description = "VAT Payable";
                def.CurrencyCode = "CNY";
                def.OtherAmount = logDef.UTOutputVATAmount;
                safList.Add(def);
                #endregion

                #region import duty credit entry
                def = (SAFDef)def.Clone();
                def.AccountCode = "2101601";
                def.DebitCreditIndicator = !isReversal ? "C" : "D";
                def.BaseAmount = logDef.UTImportDuty;
                def.Description = "Import Duty " + logDef.ContractNo;
                def.CurrencyCode = "CNY";
                def.OtherAmount = logDef.UTImportDuty;
                safList.Add(def);
                #endregion
            }

            if (logDef.CustomerId == CustomerDef.Id.hempel.GetHashCode() && logDef.CurrencyId == CurrencyId.USD.Id)
            {
                #region commission credit entry
                def = (SAFDef)def.Clone();
                def.AccountCode = "2101601";
                def.DebitCreditIndicator = !isReversal ? "C" : "D";
                def.BaseAmount = logDef.SalesCommission;
                def.Description = "Com inc " + logDef.Period.ToString().PadLeft(2, '0') + "/" + logDef.FiscalYear.ToString().Substring(2);
                def.OtherAmount = logDef.SalesCommission;
                safList.Add(def);
                #endregion
            }

            /* TODO:EPICOR  */
            ARInvoiceInterfaceEntry coreEntry = new ARInvoiceInterfaceEntry();
            ARInvoiceInterfaceEntry entry = new ARInvoiceInterfaceEntry();
            if (logDef.CustomerId == CustomerDef.Id.japan.GetHashCode())
                entry.CustomerId = "UNDEFINED";
            else if (logDef.CustomerId == CustomerDef.Id.middleeast.GetHashCode())
                entry.CustomerId = "NAR006";
            else if (logDef.CustomerId == CustomerDef.Id.choice.GetHashCode())
                entry.CustomerId = "NAR005";
            else if (logDef.CustomerId == CustomerDef.Id.gt.GetHashCode())
                entry.CustomerId = "UNDEFINED";
            else if (logDef.CustomerId == CustomerDef.Id.ns_led.GetHashCode() || logDef.CustomerId == CustomerDef.Id.manu_led.GetHashCode())
                entry.CustomerId = "NAR001";
            else if (logDef.CustomerId == CustomerDef.Id.lipsy.GetHashCode())
                entry.CustomerId = "NAR004";
            else if (logDef.CustomerId == CustomerDef.Id.days.GetHashCode())
                entry.CustomerId = "UNDEFINED";
            else if (logDef.CustomerId == CustomerDef.Id.blues_clothing.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.CustomerId = "NAR001";
                else
                    entry.CustomerId = "NAR018";
            }
            else if (logDef.CustomerId == CustomerDef.Id.william_lamb.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.CustomerId = "NAR001";
                else
                    entry.CustomerId = "NAR019";
            }
            else if (logDef.CustomerId == CustomerDef.Id.fabric_flavours.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.CustomerId = "NAR001";
                else
                    entry.CustomerId = "NAR020";
            }
            else if (logDef.CustomerId == CustomerDef.Id.arnold_wills.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.CustomerId = "NAR001";
                else
                    entry.CustomerId = "NAR022";
            }
            else if (logDef.CustomerId == CustomerDef.Id.tvm_fashion.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.CustomerId = "NAR001";
                else
                    entry.CustomerId = "NAR023";
            }
            else if (logDef.CustomerId == CustomerDef.Id.ezibuy.GetHashCode())
            {
                if (contractDef.PhaseId >= 3)
                    entry.CustomerId = "UNDEFINED";
                else
                    entry.CustomerId = "UNDEFINED";
            }
            else if (logDef.CustomerId == CustomerDef.Id.bravado.GetHashCode())
                entry.CustomerId = "NAR015";
            else if (logDef.CustomerId == CustomerDef.Id.smithbrooks.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.CustomerId = "NAR001";
                else
                    entry.CustomerId = "NAR010";
            }
            else if (logDef.CustomerId == CustomerDef.Id.aykroyd_sons.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.CustomerId = "NAR001";
                else
                    entry.CustomerId = "NAR016";
            }
            else if (logDef.CustomerId == CustomerDef.Id.fashionUK.GetHashCode())
                entry.CustomerId = "NAR007";
            else if (logDef.CustomerId == CustomerDef.Id.misirli.GetHashCode())
                entry.CustomerId = "NAR009";
            else if (logDef.CustomerId == CustomerDef.Id.global_licensing.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.CustomerId = "NAR001";
                else
                    entry.CustomerId = "NAR008";
            }
            else if (logDef.CustomerId == CustomerDef.Id.bioworld.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.CustomerId = "NAR001";
                else
                    entry.CustomerId = "NAR024";
            }
            else if (logDef.CustomerId == CustomerDef.Id.paul_dennicci.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.CustomerId = "NAR001";
                else
                    entry.CustomerId = "NAR025";
            }
            else if (logDef.CustomerId == CustomerDef.Id.cortina.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.CustomerId = "NAR001";
                else
                    entry.CustomerId = "NAR030";
            }
            else if (logDef.CustomerId == CustomerDef.Id.sicem.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.CustomerId = "NAR001";
                else
                    entry.CustomerId = "NAR031";
            }
            else if (logDef.CustomerId == CustomerDef.Id.cooneen.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.CustomerId = "NAR001";
                else
                    entry.CustomerId = "NAR032";
            }
            else if (logDef.CustomerId == CustomerDef.Id.forever_new.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.CustomerId = "NAR001";
                else
                    entry.CustomerId = "NAR029";
            }
            else if (logDef.CustomerId == CustomerDef.Id.difuzed.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.CustomerId = "NAR001";
                else
                    entry.CustomerId = "NAR026";
            }
            else if (logDef.CustomerId == CustomerDef.Id.brand_design.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.CustomerId = "NAR001";
                else
                    entry.CustomerId = "NAR027";
            }
            else if (logDef.CustomerId == CustomerDef.Id.poetic_brands.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.CustomerId = "NAR001";
                else
                    entry.CustomerId = "NAR028";
            }
            else if (logDef.CustomerId == CustomerDef.Id.brand_international.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.CustomerId = "NAR001";
                else
                    entry.CustomerId = "NAR014";
            }
            else if (logDef.CustomerId == CustomerDef.Id.brand_alliance.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.CustomerId = "NAR001";
                else
                    entry.CustomerId = "NAR017";
            }
            else if (logDef.CustomerId == CustomerDef.Id.hempel.GetHashCode() && logDef.CurrencyId == CurrencyId.USD.Id)
                entry.CustomerId = "UNDEFINED";
            //else if (CustomerDestinationDef.isUTurnOrder(logDef.CustomerDestinationId))
            else if (logDef.TermOfPurchaseId == TermOfPurchaseRef.Id.FOB_UT.GetHashCode())
                entry.CustomerId = "UNDEFINED";
            else
                entry.CustomerId = "NAR001"; // also applied to LM orders

            //if (CustomerDestinationDef.isUTurnOrder(logDef.CustomerDestinationId))
            if (logDef.TermOfPurchaseId == TermOfPurchaseRef.Id.FOB_UT.GetHashCode())
                entry.COA = "2101601";
            else if (logDef.CustomerId == CustomerDef.Id.hempel.GetHashCode() && logDef.CurrencyId == CurrencyId.USD.Id)
                entry.COA = "2101601";
            else if (this.isNextLEDOrder(logDef))
                entry.COA = "2201030";
            else if (CustomerDef.isNextRetail(logDef.CustomerId))
                entry.COA = "2101101";
            else if (logDef.CustomerId == CustomerDef.Id.directory.GetHashCode() || logDef.CustomerId == CustomerDef.Id.ntn_directory.GetHashCode())
                entry.COA = "2101102";
            else if (logDef.CustomerId == CustomerDef.Id.japan.GetHashCode())
                entry.COA = "2101401";
            else if (logDef.CustomerId == CustomerDef.Id.middleeast.GetHashCode())
                entry.COA = "2101402";
            else if (logDef.CustomerId == CustomerDef.Id.choice.GetHashCode())
                entry.COA = "2101301";
            else if (logDef.CustomerId == CustomerDef.Id.lipsy.GetHashCode())
                entry.COA = "2101105";
            else if (logDef.CustomerId == CustomerDef.Id.gt.GetHashCode())
                entry.COA = "2101403";
            else if (logDef.CustomerId == CustomerDef.Id.days.GetHashCode())
                entry.COA = "2101404";
            else if (logDef.CustomerId == CustomerDef.Id.blues_clothing.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "2101101";
                else
                    entry.COA = "2101160";
            }
            else if (logDef.CustomerId == CustomerDef.Id.william_lamb.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "2101101";
                else
                    entry.COA = "2101170";
            }
            else if (logDef.CustomerId == CustomerDef.Id.fabric_flavours.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "2101101";
                else
                    entry.COA = "2101180";
            }
            else if (logDef.CustomerId == CustomerDef.Id.arnold_wills.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "2101101";
                else
                    entry.COA = "2101200";
            }
            else if (logDef.CustomerId == CustomerDef.Id.tvm_fashion.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "2101101";
                else
                    entry.COA = "2101190";
            }
            else if (logDef.CustomerId == CustomerDef.Id.ezibuy.GetHashCode())
                entry.COA = "2101405";
            else if (logDef.CustomerId == CustomerDef.Id.bravado.GetHashCode())
                entry.COA = "2101406";
            else if (logDef.CustomerId == CustomerDef.Id.ns_led.GetHashCode() || logDef.CustomerId == CustomerDef.Id.manu_led.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "2101101";
                else
                    entry.COA = "2517051";
            }

            else if (logDef.CustomerId == CustomerDef.Id.global_licensing.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "2101101";
                else
                    entry.COA = "2101411";
            }
            else if (logDef.CustomerId == CustomerDef.Id.brand_international.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "2101101";
                else
                    entry.COA = "2101120";
            }
            else if (logDef.CustomerId == CustomerDef.Id.brand_alliance.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "2101101";
                else
                    entry.COA = "2101150";
            }
            else if (logDef.CustomerId == CustomerDef.Id.brand_design.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "2101101";
                else
                    entry.COA = "2101240";
            }
            else if (logDef.CustomerId == CustomerDef.Id.poetic_brands.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "2101101";
                else
                    entry.COA = "2101250";
            }
            else if (logDef.CustomerId == CustomerDef.Id.fashionUK.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "2101101";
                else
                    entry.COA = "2102409";
            }
            else if (logDef.CustomerId == CustomerDef.Id.misirli.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "2101101";
                else
                    entry.COA = "2101412";
            }
            else if (logDef.CustomerId == CustomerDef.Id.smithbrooks.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "2101101";
                else
                    entry.COA = "2101408";
            }
            else if (logDef.CustomerId == CustomerDef.Id.aykroyd_sons.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "2101101";
                else
                    entry.COA = "2101140";
            }
            else if (logDef.CustomerId == CustomerDef.Id.bioworld.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "2101101";
                else
                    entry.COA = "2101210";
            }
            else if (logDef.CustomerId == CustomerDef.Id.paul_dennicci.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "2101101";
                else
                    entry.COA = "2101220";
            }
            else if (logDef.CustomerId == CustomerDef.Id.cortina.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "2101101";
                else
                    entry.COA = "2101270";
            }
            else if (logDef.CustomerId == CustomerDef.Id.sicem.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "2101101";
                else
                    entry.COA = "2101280";
            }
            else if (logDef.CustomerId == CustomerDef.Id.cooneen.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "2101101";
                else
                    entry.COA = "2101290";
            }
            else if (logDef.CustomerId == CustomerDef.Id.forever_new.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "2101101";
                else
                    entry.COA = "2101260";
            }
            else if (logDef.CustomerId == CustomerDef.Id.difuzed.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "2101101";
                else
                    entry.COA = "2101230";
            }
            else if (logDef.CustomerId == CustomerDef.Id.lm_ted_baker.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "2101101";
                else
                    entry.COA = "2201050";
            }
            else if (logDef.CustomerId == CustomerDef.Id.lm_oasis.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "2101101";
                else
                    entry.COA = "2201051";
            }
            else if (logDef.CustomerId == CustomerDef.Id.lm_label_mix.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "2101101";
                else
                    entry.COA = "2201052";
            }
            else if (logDef.CustomerId == CustomerDef.Id.lm_little_bird.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "2101101";
                else
                    entry.COA = "2201053";
            }
            else if (logDef.CustomerId == CustomerDef.Id.lm_myleene_klass.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "2101101";
                else
                    entry.COA = "2201054";
            }
            else if (logDef.CustomerId == CustomerDef.Id.lm_nine.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "2101101";
                else
                    entry.COA = "2201055";
            }
            else if (logDef.CustomerId == CustomerDef.Id.lm_mintie.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "2101101";
                else
                    entry.COA = "2201056";
            }
            else if (logDef.CustomerId == CustomerDef.Id.lm_fat_face.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "2101101";
                else
                    entry.COA = "2201057";
            }
            else if (logDef.CustomerId == CustomerDef.Id.lm_laura_ashley.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "2101101";
                else
                    entry.COA = "2201058";
            }
            else if (logDef.CustomerId == CustomerDef.Id.lm_mint_velvet.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "2101101";
                else
                    entry.COA = "2201060";
            }
            else if (logDef.CustomerId == CustomerDef.Id.lm_hype.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "2101101";
                else
                    entry.COA = "2201059";
            }
            else if (t0 == "HK1G" || t0 == "FBHK" || t0 == "FBSH" || t0 == "FBVN" || t0 == "HKFB" || t0 == "SHFB" || t0 == "VNFB")
                entry.COA = "2102101";

            MockShopDCNoteDef mcDef = null;
            StudioDCNoteDef studioDef = null;
            if (logDef.IsMockShopSample == 1)
                mcDef = this.getMockShopDCNoteByShipmentId(logDef.ShipmentId);
            if (logDef.IsStudioSample == 1)
                studioDef = this.getStudioDCNoteByShipmentId(logDef.ShipmentId);

            entry.COA = generalWorker.getEpicorCOA(entry.COA);
            entry.GroupId = EpicorInterfaceWorker.Instance.ARInvoiceInterfaceFile.getSourceString();
            entry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
            entry.ApplyDate = entry.GroupApplyDate;

            if (isEnableWeek53Handling(logDef, isReversal))
            {
                entry.GroupApplyDate = WK53_APPLY_DATE;
                entry.ApplyDate = WK53_APPLY_DATE;
            }

            entry.DocumentType = ARInvoiceDocumentTypeEnum.ISAM_SALES;
            //if (CustomerDestinationDef.isUTurnOrder(logDef.CustomerDestinationId))
            if (logDef.TermOfPurchaseId == TermOfPurchaseRef.Id.FOB_UT.GetHashCode())
                entry.Office = "FY1U";
            else entry.Office = t0;

            /*
            if (t0 == "THV2" && logDef.OfficeId == OfficeId.VN.Id && logDef.CurrencyId == CurrencyId.GBP.Id) 
            {
                salesCOA = entry.COA;
                entry.Office = "HK1F";
                entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, OfficeId.HK.Id).EpicorCompanyId;
                entry.COA = "1302013";
            }
            */
            if (t0 == "CA1F" && logDef.OfficeId == OfficeId.CA.Id && logDef.CurrencyId == CurrencyId.GBP.Id)
            {
                salesCOA = entry.COA;
                entry.Office = "HK1F";
                entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, OfficeId.HK.Id).EpicorCompanyId;
                entry.COA = "1302010";
            }
            else
                entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;

            entry.LineDescription = logDef.ContractNo + "-" + logDef.DeliveryNo.ToString();
            entry.Currency = CurrencyId.getCommonName(logDef.CurrencyId);
            entry.UnitCost = logDef.OtherAmount;
            if (logDef.IsMockShopSample == 1)
                entry.Amount = mcDef.TotalShippedAmt;
            else if (logDef.IsStudioSample == 1)
                entry.Amount = studioDef.TotalShippedAmt;
            else
                entry.Amount = logDef.OtherAmount;
            entry.Qty = logDef.Quantity * logDef.PiecesPerPack;
            entry.ItemNo = ProductWorker.Instance.getProductByKey(logDef.ProductId).ItemNo;
            entry.SegmentValue3 = getT1Code(logDef);
            entry.SegmentValue4 = generalWorker.getProductCodeDefByKey(logDef.ProductTeamId).Code;
            entry.SegmentValue5 = getSeasonSegmentValue(logDef.SeasonId);
            if (logDef.IsMockShopSample == 1)
                entry.RealInvoiceNo = mcDef.DCNoteNo + "S";
            if (logDef.IsStudioSample == 1)
                entry.RealInvoiceNo = studioDef.DCNoteNo + "S";
            else
                entry.RealInvoiceNo = getT9Code(logDef);
            entry.InvoiceDate = logDef.TransactionDate;

            string reverseSuffix = getReversalSuffix(logDef.SunInterfaceLogId);

            if (isReversal)
            {
                entry.DocumentType = ARInvoiceDocumentTypeEnum.ISAM_RELEASE_LOCK;
                entry.InvoiceNo = getT9Code(logDef) + (reverseSuffix != string.Empty ? "-" + reverseSuffix : string.Empty) + "D";
                entry.LegalNumber = getT9Code(logDef) + (reverseSuffix != string.Empty ? "-" + reverseSuffix : string.Empty) + "D";
                entry.RealLegalNumber = getT9Code(logDef) + (reverseSuffix != string.Empty ? "-" + reverseSuffix : string.Empty);
                entry.IsCreditNote = true;
                entry.ExchangeRate = Math.Round(logDef.BaseAmount / logDef.OtherAmount, 10, MidpointRounding.AwayFromZero);
                entry.Qty = entry.Qty * -1;
            }
            else
            {
                if (logDef.IsMockShopSample == 1)
                {
                    entry.InvoiceDate = mcDef.DCNoteDate;
                    entry.InvoiceNo = mcDef.DCNoteNo + "S";
                    entry.LegalNumber = mcDef.DCNoteNo + "S";
                    entry.LineOriginalInvoiceNo = getT9Code(logDef);
                    entry.LineDescription = "Mock Shop For P" + logDef.Period.ToString();
                }
                else if (logDef.IsStudioSample == 1)
                {
                    entry.InvoiceDate = studioDef.DCNoteDate;
                    entry.InvoiceNo = studioDef.DCNoteNo + "S";
                    entry.LegalNumber = studioDef.DCNoteNo + "S";
                    entry.LineOriginalInvoiceNo = getT9Code(logDef);
                    entry.LineDescription = "Studio Sample For P" + logDef.Period.ToString();
                }
                else
                {
                    entry.InvoiceNo = getT9Code(logDef) + (logDef.CategoryId == CategoryType.REVERSAL.Id ? "-" + reverseSuffix : string.Empty);
                    entry.LegalNumber = getT9Code(logDef) + (logDef.CategoryId == CategoryType.REVERSAL.Id ? "-" + reverseSuffix : string.Empty);
                }
            }
            entry.IsRecordComplete = false;
            coreEntry = entry;

            if (isILS)
            {
                glEntry = (GLInterfaceEntry)glEntry.Clone();
                glEntry.COA = entry.COA;
                glEntry.DC = !isReversal ? DCFlag.Credit : DCFlag.Debit;
                glEntry.SegmentValue3 = getT1Code(logDef);
                glEntry.SegmentValue4 = generalWorker.getProductCodeDefByKey(logDef.ProductTeamId).Code;
                glEntry.SegmentValue5 = getSeasonSegmentValue(logDef.SeasonId);
                if (CustomerDef.isNextRetail(logDef.CustomerId) ||
                    (logDef.IsSampleOrder && (logDef.CustomerId == CustomerDef.Id.global_licensing.GetHashCode()
                                                || logDef.CustomerId == CustomerDef.Id.fashionUK.GetHashCode()
                                                || logDef.CustomerId == CustomerDef.Id.tvm_fashion.GetHashCode()
                                                || logDef.CustomerId == CustomerDef.Id.misirli.GetHashCode()
                                                || logDef.CustomerId == CustomerDef.Id.smithbrooks.GetHashCode()
                                                || logDef.CustomerId == CustomerDef.Id.brand_international.GetHashCode()
                                                || logDef.CustomerId == CustomerDef.Id.brand_alliance.GetHashCode()
                                                || logDef.CustomerId == CustomerDef.Id.manu_led.GetHashCode()
                                                || logDef.CustomerId == CustomerDef.Id.ns_led.GetHashCode())))
                    glEntry.SegmentValue8 = "R";
                else if (logDef.CustomerId == CustomerDef.Id.directory.GetHashCode() || logDef.CustomerId == CustomerDef.Id.ntn_directory.GetHashCode())
                    glEntry.SegmentValue8 = "D";
                else if (logDef.CustomerId == CustomerDef.Id.smithbrooks.GetHashCode())
                    glEntry.SegmentValue8 = "B";
                else
                    glEntry.SegmentValue8 = "R";
                glEntry.IsRecordComplete = true;
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);
            }
            else
            {
                if (!isReversal && !logDef.IsSampleOrder) coreEntry.IsRecordComplete = true;
                EpicorInterfaceWorker.Instance.ARInvoiceInterfaceFile.Entries.Add((IEpicorInterfaceEntry)coreEntry);
            }

            /*
            if (t0 == "THV2" && logDef.OfficeId == OfficeId.VN.Id && logDef.CurrencyId == CurrencyId.GBP.Id)
            {
                glEntry = new GLInterfaceEntry();
                glEntry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, OfficeId.VN.Id).EpicorCompanyId;
                glEntry.GroupId = EpicorInterfaceWorker.Instance.GLInterfaceFile.getSourceString();
                glEntry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                glEntry.ApplyDate = glEntry.GroupApplyDate;

                if (isEnableWeek53Handling(logDef, isReversal))
                {
                    glEntry.GroupApplyDate = WK53_APPLY_DATE;
                    glEntry.ApplyDate = WK53_APPLY_DATE;
                }

                glEntry.DocumentType = GLDocumentTypeEnum.GL;
                glEntry.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
                glEntry.DC = !isReversal ? DCFlag.Debit : DCFlag.Credit;
                glEntry.Qty = logDef.Quantity * logDef.PiecesPerPack;
                glEntry.Amount = logDef.OtherAmount;
                glEntry.BaseAmount = logDef.BaseAmount;
                glEntry.LineDescription = logDef.ContractNo + "-" + logDef.DeliveryNo.ToString();
                glEntry.Office = "THV2";
                glEntry.COA = "1302013";
                glEntry.IsRecordComplete = false;
                glEntry.SegmentValue3 = getT1Code(logDef);
                glEntry.SegmentValue4 = generalWorker.getProductCodeDefByKey(logDef.ProductTeamId).Code;
                glEntry.SegmentValue5 = getSeasonSegmentValue(logDef.SeasonId);
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                glEntry = (GLInterfaceEntry)glEntry.Clone();
                glEntry.DC = !isReversal ? DCFlag.Credit : DCFlag.Debit;
                glEntry.COA = salesCOA;
                glEntry.IsRecordComplete = true;
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);
            }
            */
            if (t0 == "CA1F" && logDef.OfficeId == OfficeId.CA.Id && logDef.CurrencyId == CurrencyId.GBP.Id)
            {
                glEntry = new GLInterfaceEntry();
                glEntry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, OfficeId.CA.Id).EpicorCompanyId;
                glEntry.GroupId = EpicorInterfaceWorker.Instance.GLInterfaceFile.getSourceString();
                glEntry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                glEntry.ApplyDate = glEntry.GroupApplyDate;

                if (isEnableWeek53Handling(logDef, isReversal))
                {
                    glEntry.GroupApplyDate = WK53_APPLY_DATE;
                    glEntry.ApplyDate = WK53_APPLY_DATE;
                }

                glEntry.DocumentType = GLDocumentTypeEnum.GL;
                glEntry.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
                glEntry.DC = !isReversal ? DCFlag.Debit : DCFlag.Credit;
                glEntry.Qty = logDef.Quantity * logDef.PiecesPerPack;
                glEntry.Amount = logDef.OtherAmount;
                glEntry.BaseAmount = logDef.BaseAmount;
                glEntry.LineDescription = logDef.ContractNo + "-" + logDef.DeliveryNo.ToString();
                glEntry.Office = "CA1F";
                glEntry.COA = "1302010";
                glEntry.IsRecordComplete = false;
                glEntry.SegmentValue3 = getT1Code(logDef);
                glEntry.SegmentValue4 = generalWorker.getProductCodeDefByKey(logDef.ProductTeamId).Code;
                glEntry.SegmentValue5 = getSeasonSegmentValue(logDef.SeasonId);
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                glEntry = (GLInterfaceEntry)glEntry.Clone();
                glEntry.DC = !isReversal ? DCFlag.Credit : DCFlag.Debit;
                glEntry.COA = salesCOA;
                glEntry.IsRecordComplete = true;
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);
            }


            if ((logDef.CustomerId == CustomerDef.Id.ns_led.GetHashCode() || logDef.CustomerId == CustomerDef.Id.manu_led.GetHashCode()) && commonWorker.getNSLedSelfBilledSupplierCodeList().Contains(contractDef.UKSupplierCode))
            {
                glEntry = new GLInterfaceEntry();
                glEntry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
                glEntry.GroupId = EpicorInterfaceWorker.Instance.GLInterfaceFile.getSourceString();
                glEntry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                glEntry.ApplyDate = glEntry.GroupApplyDate;

                if (isEnableWeek53Handling(logDef, false))
                {
                    glEntry.GroupApplyDate = WK53_APPLY_DATE;
                    glEntry.ApplyDate = WK53_APPLY_DATE;
                }

                glEntry.DocumentType = GLDocumentTypeEnum.GL;
                glEntry.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
                glEntry.DC = !isReversal ? DCFlag.Debit : DCFlag.Credit;
                glEntry.Qty = logDef.Quantity * logDef.PiecesPerPack;
                glEntry.Amount = logDef.OtherAmount;
                glEntry.BaseAmount = logDef.BaseAmount;
                glEntry.LineDescription = entry.ItemNo + "#" + logDef.ContractNo + "-" + logDef.DeliveryNo.ToString();
                glEntry.Office = entry.Office;
                glEntry.COA = "2517052";
                glEntry.IsRecordComplete = false;
                glEntry.SegmentValue3 = getT1Code(logDef);
                glEntry.SegmentValue4 = generalWorker.getProductCodeDefByKey(logDef.ProductTeamId).Code;
                glEntry.SegmentValue5 = getSeasonSegmentValue(logDef.SeasonId);
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                glEntry = (GLInterfaceEntry)glEntry.Clone();
                glEntry.DC = !isReversal ? DCFlag.Credit : DCFlag.Debit;
                glEntry.COA = "1450070";
                glEntry.IsRecordComplete = true;
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);
            }
        }

        private void addActualSalesCommissionToSAFList(SunInterfaceLogDef logDef, ArrayList safList, bool isReversal, bool settled)
        {
            if (logDef.BaseAmount == 0) return;
            string t0 = getT0Code(logDef);
            bool isILS = false;
            GLInterfaceEntry glEntry = new GLInterfaceEntry();
            string salesCOA = string.Empty;

            SAFDef def = new SAFDef();
            def.FiscalYear = logDef.FiscalYear;
            def.Period = logDef.Period;
            def.TransactionDate = logDef.TransactionDate;
            def.DebitCreditIndicator = !isReversal ? "D" : "C";
            def.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
            if (logDef.CustomerId == CustomerDef.Id.smithbrooks.GetHashCode())
                def.Description = "Comm Inc - S&B P" + logDef.TransactionDate.Month.ToString().PadLeft(2, '0') + "/" + logDef.TransactionDate.Year.ToString().Substring(2);
            else
                def.Description = "Com inc " + logDef.TransactionDate.Month.ToString().PadLeft(2, '0') + "/" + logDef.TransactionDate.Year.ToString().Substring(2);
            //if (CustomerDestinationDef.isUTurnOrder(logDef.CustomerDestinationId))
            if (logDef.TermOfPurchaseId == TermOfPurchaseRef.Id.FOB_UT.GetHashCode())
            {
                def.JournalType = "Z" + "IS";
                def.T0 = "NSSU";
                if (CustomerDef.isNextRetail(logDef.CustomerId) || logDef.CustomerId == CustomerDef.Id.smithbrooks.GetHashCode() || logDef.CustomerId == CustomerDef.Id.fashionUK.GetHashCode() || logDef.CustomerId == CustomerDef.Id.misirli.GetHashCode() || logDef.CustomerId == CustomerDef.Id.global_licensing.GetHashCode())
                    def.T6 = "R";
                else if (logDef.CustomerId == CustomerDef.Id.directory.GetHashCode() || logDef.CustomerId == CustomerDef.Id.ntn_directory.GetHashCode())
                    def.T6 = "D";
            }
            else
            {
                def.JournalType = getJournalPrefix(logDef.OfficeId, logDef.TradingAgencyId) + "IS";
                /*
                if (t0 == "THV2") def.T0 = "TH2F";
                */

                if (t0 == "THV2" && logDef.OfficeId != OfficeId.VN.Id) def.T0 = "TH2F";
                else if (t0 == "THV2" && logDef.OfficeId == OfficeId.VN.Id && logDef.CurrencyId == CurrencyId.GBP.Id) def.T0 = "THV2";
                else if (t0 == "TKMF") def.T0 = "TK1F";
                else if (t0 == "TK5F") def.T0 = "TK1F";
                else if (t0 == "HK1G" || t0 == "FBHK" || t0 == "HKFB") def.T0 = "HK1F";
                else if (t0 == "FBSH" || t0 == "SHFB") def.T0 = "SH2F";
                else if (t0 == "FBVN" || t0 == "VNFB") def.T0 = "THV2";
                else def.T0 = t0;
                def.T6 = String.Empty;
            }
            def.T1 = getT1Code(logDef);
            def.T2 = generalWorker.getProductCodeDefByKey(logDef.ProductTeamId).Code;
            def.T5 = getT5Code(logDef.SeasonId);
            def.T6 = String.Empty;
            def.T8 = getT8Code(logDef.ProductId);
            /*
            def.T9 = getT9Code(logDef) + (logDef.CustomerId == CustomerDef.Id.choice.GetHashCode() ? "C" : String.Empty);
            */
            def.T9 = getT9Code(logDef) + "C";
            def.OfficeCode = OfficeId.getName(logDef.OfficeId);
            def.TradingAgency = TradingAgencyId.getName(logDef.TradingAgencyId);
            def.PaymentTerm = PaymentTermRef.getDescriptionForSAF(logDef.PaymentTermId);
            def.IsMockShopSample = (logDef.IsSampleOrder ? true : false);

            ShipmentDef shipmentDef = OrderSelectWorker.Instance.getShipmentByKey(logDef.ShipmentId);
            ContractDef contractDef = OrderSelectWorker.Instance.getContractByKey(shipmentDef.ContractId);

            if (((logDef.OfficeId == OfficeId.HK.Id || logDef.OfficeId == OfficeId.DG.Id || logDef.OfficeId == OfficeId.VN.Id || logDef.OfficeId == OfficeId.TH.Id || logDef.OfficeId == OfficeId.SH.Id) &&
                (logDef.CustomerId == CustomerDef.Id.lipsy.GetHashCode() || logDef.CustomerId == CustomerDef.Id.fashionUK.GetHashCode() || logDef.CustomerId == CustomerDef.Id.misirli.GetHashCode() || logDef.CustomerId == CustomerDef.Id.global_licensing.GetHashCode() || logDef.CustomerId == CustomerDef.Id.choice.GetHashCode() || logDef.CustomerId == CustomerDef.Id.brand_international.GetHashCode() || logDef.CustomerId == CustomerDef.Id.brand_alliance.GetHashCode() || CustomerDef.isNextUK(logDef.CustomerId)))
                || logDef.TermOfPurchaseId == TermOfPurchaseRef.Id.FOB_UT.GetHashCode() || (logDef.CustomerId == CustomerDef.Id.hempel.GetHashCode() && logDef.CurrencyId == CurrencyId.USD.Id))
            //|| CustomerDestinationDef.isUTurnOrder(logDef.CustomerDestinationId) || (logDef.CustomerId == CustomerDef.Id.hempel.GetHashCode() && logDef.CurrencyId == CurrencyId.USD.Id))
            {
                if (!logDef.IsSampleOrder || (logDef.IsSampleOrder && (logDef.CategoryId == CategoryType.REVERSAL.Id || isReversal)))
                {
                    #region sales commission debit entry
                    //if (CustomerDestinationDef.isUTurnOrder(logDef.CustomerDestinationId))
                    if (logDef.TermOfPurchaseId == TermOfPurchaseRef.Id.FOB_UT.GetHashCode())
                        def.AccountCode = "2101601";
                    else if (logDef.CustomerId == CustomerDef.Id.hempel.GetHashCode() && logDef.CurrencyId == CurrencyId.USD.Id)
                        def.AccountCode = "2101601";
                    else if (logDef.CustomerId == CustomerDef.Id.choice.GetHashCode())
                        def.AccountCode = "1320301";
                    else if (logDef.CustomerId == CustomerDef.Id.fashionUK.GetHashCode())
                        def.AccountCode = "1303405";
                    else if (logDef.CustomerId == CustomerDef.Id.misirli.GetHashCode())
                        def.AccountCode = "1303407";
                    else if (logDef.CustomerId == CustomerDef.Id.global_licensing.GetHashCode())
                        def.AccountCode = "1320112";
                    else if (logDef.CustomerId == CustomerDef.Id.lipsy.GetHashCode())
                        def.AccountCode = "1320117";
                    else if (CustomerDef.isNextUK(logDef.CustomerId))
                    {
                        def.AccountCode = "1320112";
                        /*
                        if (logDef.OfficeId == OfficeId.TH.Id)
                            def.AccountCode = "1320112";
                        else
                            def.AccountCode = "1321902";
                        */
                    }
                    def.BaseAmount = logDef.BaseAmount;
                    def.OtherAmount = logDef.OtherAmount;
                    /*
                    & isReversal == false
                    */
                    if (settled)
                    {
                        /*
                        AccountFinancialCalenderDef logCalDef = generalWorker.getAccountPeriodByDate(9, logDef.CreatedOn.Date);
                        InvoiceDef invoiceDef = ShippingWorker.Instance.getInvoiceByKey(logDef.ShipmentId);
                        AccountFinancialCalenderDef settledCalDef = generalWorker.getAccountPeriodByDate(9, invoiceDef.NSLCommissionSettlementDate);

                        if (logCalDef.BudgetYear > settledCalDef.BudgetYear || (logCalDef.BudgetYear == settledCalDef.BudgetYear && logCalDef.Period > settledCalDef.Period))
                            def.AccountCode = "1411132";
                        else
                            def.AccountCode = "1320112";                                        
                        */

                        InvoiceDef invoiceDef = ShippingWorker.Instance.getInvoiceByKey(logDef.ShipmentId);

                        AccountFinancialCalenderDef settledCalDef = null;
                        if (invoiceDef.NSLCommissionSettlementDate != DateTime.MinValue)
                            settledCalDef = generalWorker.getAccountPeriodByDate(9, invoiceDef.NSLCommissionSettlementDate);

                        //if (invoiceDef.NSLCommissionSettlementDate == DateTime.MinValue || (settledCalDef.BudgetYear == logDef.FiscalYear && settledCalDef.Period == logDef.Period))
                        if (invoiceDef.NSLCommissionSettlementDate == DateTime.MinValue) // Modified By Michael Lau @2016-06-07
                            def.AccountCode = "1320112";
                        else
                        {
                            isILS = true;
                            def.AccountCode = "1411132";

                            if ((logDef.CustomerId == CustomerDef.Id.ns_led.GetHashCode() || logDef.CustomerId == CustomerDef.Id.manu_led.GetHashCode()) && commonWorker.getNSLedSelfBilledSupplierCodeList().Contains(contractDef.UKSupplierCode))
                            {
                                def.AccountCode = "1450070";
                            }
                        }

                        /*
                        def.AccountCode = "1411132";
                        */
                        if (def.IsMockShopSample)
                            def.Description = "COMM MS " + getT9Code(logDef);
                        else
                            def.Description = "COMM DIFF " + getT9Code(logDef);

                        /* TODO:EPICOR */
                        if (isILS)
                        {
                            glEntry = new GLInterfaceEntry();
                            glEntry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
                            glEntry.GroupId = EpicorInterfaceWorker.Instance.GLInterfaceFile.getSourceString();
                            glEntry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                            glEntry.ApplyDate = glEntry.GroupApplyDate;

                            if (isEnableWeek53Handling(logDef, isReversal))
                            {
                                glEntry.GroupApplyDate = WK53_APPLY_DATE;
                                glEntry.ApplyDate = WK53_APPLY_DATE;
                            }

                            glEntry.DocumentType = GLDocumentTypeEnum.GL;
                            glEntry.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
                            glEntry.DC = !isReversal ? DCFlag.Debit : DCFlag.Credit;
                            glEntry.Qty = logDef.Quantity * logDef.PiecesPerPack;
                            glEntry.Amount = logDef.OtherAmount;
                            glEntry.BaseAmount = logDef.BaseAmount;
                            glEntry.LineDescription = getT9Code(logDef) + "C";
                            glEntry.LineComment = DateTimeUtility.getDateString(logDef.TransactionDate) + "|" + ProductWorker.Instance.getProductByKey(logDef.ProductId).ItemNo + "|" + generalWorker.getProductCodeDefByKey(logDef.ProductTeamId).Code + "|" + logDef.ContractNo + "|" + logDef.Quantity.ToString() + "|Comm Correction|";
                            glEntry.Office = def.T0;
                            glEntry.COA = generalWorker.getEpicorCOA(def.AccountCode);
                            glEntry.IsRecordComplete = false;
                            EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);
                        }

                    }

                    safList.Add(def);
                    #endregion
                }
            }

            if (logDef.OfficeId != OfficeId.HK.Id && logDef.OfficeId != OfficeId.DG.Id && logDef.OfficeId != OfficeId.TH.Id && logDef.OfficeId != OfficeId.VN.Id && logDef.OfficeId != OfficeId.SH.Id && logDef.OfficeId != OfficeId.PH.Id)
            {
                if (!logDef.IsSampleOrder || (logDef.IsSampleOrder && (logDef.CategoryId == CategoryType.REVERSAL.Id || isReversal)))
                {
                    #region sales commission debit entry
                    /*
                    def.AccountCode = "1311302";
                    */
                    if (logDef.CustomerId == CustomerDef.Id.choice.GetHashCode())
                        def.AccountCode = "1320301";
                    else if (logDef.CustomerId == CustomerDef.Id.fashionUK.GetHashCode()) // michael lau @2013-03-06
                        def.AccountCode = "1303405";
                    else if (logDef.CustomerId == CustomerDef.Id.misirli.GetHashCode())
                        def.AccountCode = "1303407";
                    else if (logDef.CustomerId == CustomerDef.Id.global_licensing.GetHashCode())
                        def.AccountCode = "1320112";
                    else if (logDef.CustomerId == CustomerDef.Id.lipsy.GetHashCode()) // michael lau @2013-03-06
                        def.AccountCode = "1320117";
                    else
                    {
                        def.AccountCode = "1320112";
                    }

                    def.BaseAmount = logDef.BaseAmount;
                    def.OtherAmount = logDef.OtherAmount;
                    if (settled)
                    {
                        /*
                        AccountFinancialCalenderDef logCalDef = generalWorker.getAccountPeriodByDate(9, logDef.CreatedOn.Date);
                        InvoiceDef invoiceDef = ShippingWorker.Instance.getInvoiceByKey(logDef.ShipmentId);
                        AccountFinancialCalenderDef settledCalDef = generalWorker.getAccountPeriodByDate(9, invoiceDef.NSLCommissionSettlementDate);

                        if (logCalDef.BudgetYear > settledCalDef.BudgetYear || (logCalDef.BudgetYear == settledCalDef.BudgetYear && logCalDef.Period > settledCalDef.Period))
                            def.AccountCode = "1411132";
                        else
                            def.AccountCode = "1320112";                                        
                        */

                        InvoiceDef invoiceDef = ShippingWorker.Instance.getInvoiceByKey(logDef.ShipmentId);

                        AccountFinancialCalenderDef settledCalDef = null;
                        if (invoiceDef.NSLCommissionSettlementDate != DateTime.MinValue)
                            settledCalDef = generalWorker.getAccountPeriodByDate(9, invoiceDef.NSLCommissionSettlementDate);

                        if (invoiceDef.NSLCommissionSettlementDate == DateTime.MinValue || (settledCalDef.BudgetYear == logDef.FiscalYear && settledCalDef.Period == logDef.Period))
                            def.AccountCode = "1320112";
                        else
                        {
                            def.AccountCode = "1411132";
                            if ((logDef.CustomerId == CustomerDef.Id.ns_led.GetHashCode() || logDef.CustomerId == CustomerDef.Id.manu_led.GetHashCode()) && commonWorker.getNSLedSelfBilledSupplierCodeList().Contains(contractDef.UKSupplierCode))
                            {
                                def.AccountCode = "1450070";
                            }

                            isILS = true;
                        }

                        /*
                        def.AccountCode = "1411132";
                        */
                        if (def.IsMockShopSample)
                            def.Description = "COMM MS " + getT9Code(logDef);
                        else
                            def.Description = "COMM DIFF " + getT9Code(logDef);

                        /* TODO:EPICOR */
                        if (isILS)
                        {
                            glEntry = new GLInterfaceEntry();
                            glEntry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
                            glEntry.GroupId = EpicorInterfaceWorker.Instance.GLInterfaceFile.getSourceString();
                            glEntry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                            glEntry.ApplyDate = glEntry.GroupApplyDate;

                            if (isEnableWeek53Handling(logDef, isReversal))
                            {
                                glEntry.GroupApplyDate = WK53_APPLY_DATE;
                                glEntry.ApplyDate = WK53_APPLY_DATE;
                            }

                            glEntry.DocumentType = GLDocumentTypeEnum.GL;
                            glEntry.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
                            glEntry.DC = !isReversal ? DCFlag.Debit : DCFlag.Credit;
                            glEntry.Qty = logDef.Quantity * logDef.PiecesPerPack;
                            glEntry.Amount = logDef.OtherAmount;
                            glEntry.BaseAmount = logDef.BaseAmount;
                            glEntry.LineDescription = getT9Code(logDef) + "C";
                            glEntry.LineComment = DateTimeUtility.getDateString(logDef.TransactionDate) + "|" + ProductWorker.Instance.getProductByKey(logDef.ProductId).ItemNo + "|" + generalWorker.getProductCodeDefByKey(logDef.ProductTeamId).Code + "|" + logDef.ContractNo + "|" + logDef.Quantity.ToString() + "|Comm Correction|";
                            glEntry.Office = def.T0;
                            glEntry.COA = generalWorker.getEpicorCOA(def.AccountCode);
                            glEntry.IsRecordComplete = false;
                            EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);
                        }

                    }
                    safList.Add(def);
                    #endregion
                }
            }

            #region sales commission credit entry
            def = (SAFDef)def.Clone();
            //if (CustomerDestinationDef.isUTurnOrder(logDef.CustomerDestinationId))
            if (logDef.TermOfPurchaseId == TermOfPurchaseRef.Id.FOB_UT.GetHashCode())
                def.AccountCode = "2102106";
            else if (logDef.CustomerId == CustomerDef.Id.hempel.GetHashCode() && logDef.CurrencyId == CurrencyId.USD.Id)
                def.AccountCode = "2102106";
            else if (logDef.CustomerId == CustomerDef.Id.choice.GetHashCode())
                def.AccountCode = "2102105";
            else if (logDef.CustomerId == CustomerDef.Id.global_licensing.GetHashCode())
                def.AccountCode = "2102113";
            else if (logDef.CustomerId == CustomerDef.Id.fashionUK.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    def.AccountCode = "2102101";
                else
                    def.AccountCode = "2102109";
            }
            else if (logDef.CustomerId == CustomerDef.Id.misirli.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    def.AccountCode = "2102101";
                else
                    def.AccountCode = "2102117";
            }
            else if (logDef.CustomerId == CustomerDef.Id.lipsy.GetHashCode())
                def.AccountCode = "2102110";
            else
                def.AccountCode = "2102101";
            def.FiscalYear = logDef.FiscalYear;
            def.Period = logDef.Period;
            def.TransactionDate = logDef.TransactionDate;
            def.DebitCreditIndicator = !isReversal ? "C" : "D";
            def.BaseAmount = logDef.BaseAmount;
            //if (CustomerDestinationDef.isUTurnOrder(logDef.CustomerDestinationId))
            if (logDef.TermOfPurchaseId == TermOfPurchaseRef.Id.FOB_UT.GetHashCode())
                def.JournalType = "Z" + "IS";
            else
                def.JournalType = getJournalPrefix(logDef.OfficeId, logDef.TradingAgencyId) + "IS";
            if (logDef.CustomerId == CustomerDef.Id.smithbrooks.GetHashCode())
                def.Description = "Comm Inc - S&B P" + logDef.TransactionDate.Month.ToString().PadLeft(2, '0') + "/" + logDef.TransactionDate.Year.ToString().Substring(2);
            else
                def.Description = "Com inc " + logDef.TransactionDate.Month.ToString().PadLeft(2, '0') + "/" + logDef.TransactionDate.Year.ToString().Substring(2);
            def.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
            def.OtherAmount = logDef.OtherAmount;
            //if (CustomerDestinationDef.isUTurnOrder(logDef.CustomerDestinationId))
            if (logDef.TermOfPurchaseId == TermOfPurchaseRef.Id.FOB_UT.GetHashCode())
                def.T0 = "NSSU";
            else
            {
                def.T0 = t0;
                if (t0 == "TK4F" && !isReversal) totalBaseAmt += def.BaseAmount;
                if (t0 == "TK4F" && isReversal) totalReverseBaseAmt += def.BaseAmount;
                /*
                if ((t0 == "THV2" || t0 == "HK1G") && !isReversal && !CustomerDestinationDef.isUTurnOrder(logDef.CustomerDestinationId)) totalBaseAmt += def.BaseAmount;
                if ((t0 == "THV2" || t0 == "HK1G") && isReversal && !CustomerDestinationDef.isUTurnOrder(logDef.CustomerDestinationId)) totalReverseBaseAmt += def.BaseAmount;
                */

                //if (t0 == "HK1G" && !isReversal && !CustomerDestinationDef.isUTurnOrder(logDef.CustomerDestinationId)) totalBaseAmt += def.BaseAmount;
                if (t0 == "HK1G" && !isReversal && logDef.TermOfPurchaseId != TermOfPurchaseRef.Id.FOB_UT.GetHashCode()) totalBaseAmt += def.BaseAmount;

                if (t0 == "FBHK" && !isReversal) totalFBHKBaseAmt += def.BaseAmount;
                if (t0 == "FBSH" && !isReversal) totalFBSHBaseAmt += def.BaseAmount;
                if (t0 == "FBVN" && !isReversal) totalFBVNBaseAmt += def.BaseAmount;
                if (t0 == "HKFB" && !isReversal) totalHKFBBaseAmt += def.BaseAmount;
                if (t0 == "SHFB" && !isReversal) totalSHFBBaseAmt += def.BaseAmount;
                if (t0 == "VNFB" && !isReversal) totalVNFBBaseAmt += def.BaseAmount;

                //if (t0 == "THV2" && !isReversal && !CustomerDestinationDef.isUTurnOrder(logDef.CustomerDestinationId) && (logDef.OfficeId != OfficeId.VN.Id || (logDef.OfficeId == OfficeId.VN.Id && logDef.CurrencyId != CurrencyId.USD.Id))) totalBaseAmt += def.BaseAmount;
                if (t0 == "THV2" && !isReversal && logDef.TermOfPurchaseId != TermOfPurchaseRef.Id.FOB_UT.GetHashCode() && (logDef.OfficeId != OfficeId.VN.Id || (logDef.OfficeId == OfficeId.VN.Id && logDef.CurrencyId == CurrencyId.GBP.Id))) totalBaseAmt += def.BaseAmount;

                //if (t0 == "HK1G" && isReversal && !CustomerDestinationDef.isUTurnOrder(logDef.CustomerDestinationId)) totalReverseBaseAmt += def.BaseAmount;
                if (t0 == "HK1G" && isReversal && logDef.TermOfPurchaseId != TermOfPurchaseRef.Id.FOB_UT.GetHashCode()) totalReverseBaseAmt += def.BaseAmount;
                if (t0 == "FBHK" && isReversal) totalFBHKReverseBaseAmt += def.BaseAmount;
                if (t0 == "FBSH" && isReversal) totalFBSHReverseBaseAmt += def.BaseAmount;
                if (t0 == "FBVN" && isReversal) totalFBVNReverseBaseAmt += def.BaseAmount;
                if (t0 == "HKFB" && isReversal) totalHKFBReverseBaseAmt += def.BaseAmount;
                if (t0 == "SHFB" && isReversal) totalSHFBReverseBaseAmt += def.BaseAmount;
                if (t0 == "VNFB" && isReversal) totalVNFBReverseBaseAmt += def.BaseAmount;

                //if (t0 == "THV2" && isReversal && !CustomerDestinationDef.isUTurnOrder(logDef.CustomerDestinationId) && (logDef.OfficeId != OfficeId.VN.Id || (logDef.OfficeId == OfficeId.VN.Id && logDef.CurrencyId != CurrencyId.USD.Id))) totalReverseBaseAmt += def.BaseAmount;
                if (t0 == "THV2" && isReversal && logDef.TermOfPurchaseId != TermOfPurchaseRef.Id.FOB_UT.GetHashCode() && (logDef.OfficeId != OfficeId.VN.Id || (logDef.OfficeId == OfficeId.VN.Id && logDef.CurrencyId == CurrencyId.GBP.Id))) totalReverseBaseAmt += def.BaseAmount;

            }
            def.T1 = getT1Code(logDef);
            def.T2 = generalWorker.getProductCodeDefByKey(logDef.ProductTeamId).Code;
            def.T5 = getT5Code(logDef.SeasonId);
            //if (!CustomerDestinationDef.isUTurnOrder(logDef.CustomerDestinationId))
            if (logDef.TermOfPurchaseId != TermOfPurchaseRef.Id.FOB_UT.GetHashCode())
            {
                if (CustomerDef.isNextRetail(logDef.CustomerId) || logDef.CustomerId == CustomerDef.Id.smithbrooks.GetHashCode() || logDef.CustomerId == CustomerDef.Id.fashionUK.GetHashCode() || logDef.CustomerId == CustomerDef.Id.misirli.GetHashCode())
                    def.T6 = "R";
                else if (logDef.CustomerId == CustomerDef.Id.directory.GetHashCode() || logDef.CustomerId == CustomerDef.Id.ntn_directory.GetHashCode())
                    def.T6 = "D";
            }
            def.T8 = getT8Code(logDef.ProductId);
            /*
            def.T9 = getT9Code(logDef) + (logDef.CustomerId == CustomerDef.Id.choice.GetHashCode() ? "C" : String.Empty);
            */
            def.T9 = getT9Code(logDef);
            def.OfficeCode = OfficeId.getName(logDef.OfficeId);
            def.TradingAgency = TradingAgencyId.getName(logDef.TradingAgencyId);
            def.PaymentTerm = PaymentTermRef.getDescriptionForSAF(logDef.PaymentTermId);
            safList.Add(def);
            #endregion

            /*
            if (diffAmt != 0 && isReversal == false)
            {
                #region ILS Adjustment
                def = (SAFDef)def.Clone();
                def.CreateDate = DateTime.Now;
                //def.AccountCode = (logDef.OfficeId == OfficeId.HK.Id || logDef.OfficeId == OfficeId.SH.Id || logDef.OfficeId == OfficeId.TH.Id) ? "1320112" : "1311302";
                def.AccountCode = "1320112";
                def.DebitCreditIndicator = "D";
                def.Description = "ILS ADJ";
                def.BaseAmount = logDef.BaseAmount;
                def.OtherAmount = logDef.OtherAmount;
                safList.Add(def);

                def = (SAFDef)def.Clone();
                def.CreateDate = DateTime.Now;
                //def.AccountCode = (logDef.OfficeId == OfficeId.HK.Id || logDef.OfficeId == OfficeId.SH.Id || logDef.OfficeId == OfficeId.TH.Id) ? "1320112" : "1311302";
                def.AccountCode = "1320112";
                def.DebitCreditIndicator = "C";
                def.Description = "ILS ADJ";
                def.BaseAmount = logDef.BaseAmount - diffAmt;
                def.OtherAmount = logDef.OtherAmount - diffAmt;
                safList.Add(def);
                #endregion
            }
            */

            //if (CustomerDestinationDef.isUTurnOrder(logDef.CustomerDestinationId))
            if (logDef.TermOfPurchaseId == TermOfPurchaseRef.Id.FOB_UT.GetHashCode())
            {
                #region import duty debit entry
                def = (SAFDef)def.Clone();
                def.FiscalYear = logDef.FiscalYear;
                def.Period = logDef.Period;
                def.AccountCode = "2101601";
                def.DebitCreditIndicator = !isReversal ? "D" : "C";
                def.BaseAmount = logDef.UTImportDutyInBaseCurrency;
                def.JournalType = "ZIR";
                def.Description = "Import Duty " + logDef.ContractNo;
                def.CurrencyCode = "CNY";
                def.OtherAmount = logDef.UTImportDuty;
                def.T0 = "NSSU";
                def.T1 = getT1Code(logDef);
                def.T2 = generalWorker.getProductCodeDefByKey(logDef.ProductTeamId).Code;
                def.T5 = getT5Code(logDef.SeasonId);
                if (CustomerDef.isNextRetail(logDef.CustomerId) || logDef.CustomerId == CustomerDef.Id.smithbrooks.GetHashCode())
                    def.T6 = "R";
                else if (logDef.CustomerId == CustomerDef.Id.directory.GetHashCode() || logDef.CustomerId == CustomerDef.Id.ntn_directory.GetHashCode())
                    def.T6 = "D";
                def.T8 = getT8Code(logDef.ProductId);
                /*
                def.T9 = getT9Code(logDef) + (logDef.CustomerId == CustomerDef.Id.choice.GetHashCode() ? "C" : String.Empty);
                */
                def.T9 = getT9Code(logDef) + "C";
                def.OfficeCode = OfficeId.getName(logDef.OfficeId);
                def.TradingAgency = TradingAgencyId.getName(logDef.TradingAgencyId);
                def.PaymentTerm = PaymentTermRef.getDescriptionForSAF(logDef.PaymentTermId);
                safList.Add(def);
                #endregion

                #region import duty credit entry
                def = (SAFDef)def.Clone();
                def.AccountCode = "3106306";
                def.DebitCreditIndicator = !isReversal ? "C" : "D";
                safList.Add(def);
                #endregion
            }

            /* TODO:EPICOR  */
            ARInvoiceInterfaceEntry coreEntry = new ARInvoiceInterfaceEntry();
            ARInvoiceInterfaceEntry entry = new ARInvoiceInterfaceEntry();
            //if (CustomerDestinationDef.isUTurnOrder(logDef.CustomerDestinationId))
            if (logDef.TermOfPurchaseId == TermOfPurchaseRef.Id.FOB_UT.GetHashCode())
                entry.CustomerId = "UNDEFINED";
            else if (logDef.CustomerId == CustomerDef.Id.hempel.GetHashCode() && logDef.CurrencyId == CurrencyId.USD.Id)
                entry.CustomerId = "UNDEFINED";
            else if (logDef.CustomerId == CustomerDef.Id.choice.GetHashCode())
                entry.CustomerId = "NAR005";
            else if (logDef.CustomerId == CustomerDef.Id.fashionUK.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.CustomerId = "NAR002";
                else
                {
                    //if (logDef.TransactionDate >= new DateTime(2020, 9, 27))
                    if (logDef.FiscalYear > 2020 || (logDef.FiscalYear == 2020 && logDef.Period >= 9))
                        entry.CustomerId = "NAR002";
                    else
                        entry.CustomerId = "NAR007";
                }
            }
            else if (logDef.CustomerId == CustomerDef.Id.misirli.GetHashCode())
                entry.CustomerId = "NAR009";
            else if (logDef.CustomerId == CustomerDef.Id.global_licensing.GetHashCode())
                entry.CustomerId = "NAR002";
            else if (logDef.CustomerId == CustomerDef.Id.brand_international.GetHashCode())
                entry.CustomerId = "NAR002";
            else if (logDef.CustomerId == CustomerDef.Id.bioworld.GetHashCode())
                entry.CustomerId = "NAR002";
            else if (logDef.CustomerId == CustomerDef.Id.paul_dennicci.GetHashCode())
                entry.CustomerId = "NAR002";
            else if (logDef.CustomerId == CustomerDef.Id.difuzed.GetHashCode())
                entry.CustomerId = "NAR002";
            else if (logDef.CustomerId == CustomerDef.Id.brand_alliance.GetHashCode())
                entry.CustomerId = "NAR002";
            else if (logDef.CustomerId == CustomerDef.Id.lipsy.GetHashCode())
                entry.CustomerId = "NAR004";
            else if (logDef.CustomerId == CustomerDef.Id.fabric_flavours.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.CustomerId = "NAR002";
                else
                    entry.CustomerId = "NAR020";
            }
            else if (logDef.CustomerId == CustomerDef.Id.arnold_wills.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.CustomerId = "NAR002";
                else
                    entry.CustomerId = "NAR022";
            }
            else if (logDef.CustomerId == CustomerDef.Id.ns_led.GetHashCode() || logDef.CustomerId == CustomerDef.Id.manu_led.GetHashCode())
                entry.CustomerId = "NAR002";
            else if (CustomerDef.isLM(logDef.CustomerId))
                entry.CustomerId = "NAR002";
            else if (CustomerDef.isNextUK(logDef.CustomerId))
                entry.CustomerId = "NAR002";
            else
                entry.CustomerId = "NAR002"; // includes TVM, Brand Design, Poetic Brands, Cortina, Sicem, cooneen

            //if (CustomerDestinationDef.isUTurnOrder(logDef.CustomerDestinationId))
            if (logDef.TermOfPurchaseId == TermOfPurchaseRef.Id.FOB_UT.GetHashCode())
                entry.COA = "2102106";
            else if (logDef.CustomerId == CustomerDef.Id.hempel.GetHashCode() && logDef.CurrencyId == CurrencyId.USD.Id)
                entry.COA = "2102106";
            else if (logDef.CustomerId == CustomerDef.Id.choice.GetHashCode())
                entry.COA = "2102105";
            /*
            else if (logDef.CustomerId == CustomerDef.Id.global_licensing.GetHashCode())
                entry.COA = "2102113";
            */
            /* 2020-10-05 , commission paid by uk. */
            else if (logDef.CustomerId == CustomerDef.Id.fashionUK.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "2102101";
                else
                {
                    if (logDef.FiscalYear > 2020 || (logDef.FiscalYear == 2020 && logDef.Period >= 9))
                        entry.COA = "2102101";
                    else
                        entry.COA = "2102109";
                }
            }
            else if (logDef.CustomerId == CustomerDef.Id.misirli.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "2102101";
                else
                    entry.COA = "2102117";
            }
            else if (logDef.CustomerId == CustomerDef.Id.lipsy.GetHashCode())
                entry.COA = "2102110";
            else if (logDef.CustomerId == CustomerDef.Id.fabric_flavours.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "2102101";
                else
                    entry.COA = "2502070";
            }
            else if (logDef.CustomerId == CustomerDef.Id.bioworld.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "2102101";
                else
                    entry.COA = "2502100";
            }
            else if (logDef.CustomerId == CustomerDef.Id.arnold_wills.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "2102101";
                else
                    entry.COA = "2502090";
            }
            else if (logDef.CustomerId == CustomerDef.Id.lm_ted_baker.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "2102101";
                else
                    entry.COA = "2501060";
            }
            else if (logDef.CustomerId == CustomerDef.Id.lm_oasis.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "2102101";
                else
                    entry.COA = "2501061";
            }
            else if (logDef.CustomerId == CustomerDef.Id.lm_label_mix.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "2102101";
                else
                    entry.COA = "2501062";
            }
            else if (logDef.CustomerId == CustomerDef.Id.lm_little_bird.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "2102101";
                else
                    entry.COA = "2501063";
            }
            else if (logDef.CustomerId == CustomerDef.Id.lm_myleene_klass.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "2102101";
                else
                    entry.COA = "2501064";
            }
            else if (logDef.CustomerId == CustomerDef.Id.lm_nine.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "2102101";
                else
                    entry.COA = "2501065";
            }
            else if (logDef.CustomerId == CustomerDef.Id.lm_mintie.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "2102101";
                else
                    entry.COA = "2501066";
            }
            else if (logDef.CustomerId == CustomerDef.Id.lm_fat_face.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "2102101";
                else
                    entry.COA = "2501067";
            }
            else if (logDef.CustomerId == CustomerDef.Id.lm_laura_ashley.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "2102101";
                else
                    entry.COA = "2501068";
            }
            else if (logDef.CustomerId == CustomerDef.Id.lm_mint_velvet.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "2102101";
                else
                    entry.COA = "2501070";
            }
            else if (logDef.CustomerId == CustomerDef.Id.lm_hype.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "2102101";
                else
                    entry.COA = "2501069";
            }
            else if (this.isNextLEDOrder(logDef))
                entry.COA = "2501020";
            else if (logDef.CustomerId == CustomerDef.Id.ns_led.GetHashCode() || logDef.CustomerId == CustomerDef.Id.manu_led.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "2102101";
                else
                    entry.COA = "2501050";
            }
            else
                entry.COA = "2102101"; // includes TVM, Brand Design, Poetic Brands, Cortina, Sicem, cooneen

            MockShopDCNoteDef mcDef = null;
            StudioDCNoteDef studioDef = null;
            if (logDef.IsMockShopSample == 1)
                mcDef = this.getMockShopDCNoteByShipmentId(logDef.ShipmentId);
            if (logDef.IsStudioSample == 1)
                studioDef = this.getStudioDCNoteByShipmentId(logDef.ShipmentId);

            entry.COA = generalWorker.getEpicorCOA(entry.COA);
            entry.GroupId = EpicorInterfaceWorker.Instance.ARInvoiceInterfaceFile.getSourceString();
            entry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
            entry.ApplyDate = entry.GroupApplyDate;

            if (isEnableWeek53Handling(logDef, isReversal))
            {
                entry.GroupApplyDate = WK53_APPLY_DATE;
                entry.ApplyDate = WK53_APPLY_DATE;
            }

            entry.DocumentType = ARInvoiceDocumentTypeEnum.ISAM_SALES;

            //if (CustomerDestinationDef.isUTurnOrder(logDef.CustomerDestinationId))
            if (logDef.TermOfPurchaseId == TermOfPurchaseRef.Id.FOB_UT.GetHashCode())
                entry.Office = "NSSU";
            else entry.Office = t0;

            /*
            if (t0 == "THV2" && logDef.OfficeId == OfficeId.VN.Id && logDef.CurrencyId == CurrencyId.GBP.Id)
            {
                salesCOA = entry.COA;
                entry.Office = "HK1F";
                entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, OfficeId.HK.Id).EpicorCompanyId;
                entry.COA = "1302013";
            }
            */
            if (t0 == "CA1F" && logDef.OfficeId == OfficeId.CA.Id && logDef.CurrencyId == CurrencyId.GBP.Id)
            {
                salesCOA = entry.COA;
                entry.Office = "HK1F";
                entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, OfficeId.HK.Id).EpicorCompanyId;
                entry.COA = "1302010";
            }
            else
                entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;

            entry.LineDescription = logDef.ContractNo + "-" + logDef.DeliveryNo.ToString();
            entry.Currency = CurrencyId.getCommonName(logDef.CurrencyId);
            entry.UnitCost = logDef.OtherAmount;
            if (logDef.IsMockShopSample == 1)
                entry.Amount = mcDef.TotalNSLCommissionAmt;
            else if (logDef.IsStudioSample == 1)
                entry.Amount = studioDef.TotalNSLCommissionAmt;
            else
                entry.Amount = logDef.OtherAmount;
            entry.Qty = logDef.Quantity * logDef.PiecesPerPack;
            entry.ItemNo = ProductWorker.Instance.getProductByKey(logDef.ProductId).ItemNo;
            entry.SegmentValue3 = getT1Code(logDef);
            entry.SegmentValue4 = generalWorker.getProductCodeDefByKey(logDef.ProductTeamId).Code;
            entry.SegmentValue5 = getSeasonSegmentValue(logDef.SeasonId);
            if (CustomerDef.isNextRetail(logDef.CustomerId) || logDef.CustomerId == CustomerDef.Id.smithbrooks.GetHashCode() || logDef.CustomerId == CustomerDef.Id.aykroyd_sons.GetHashCode()
                || logDef.CustomerId == CustomerDef.Id.fabric_flavours.GetHashCode()
                || logDef.CustomerId == CustomerDef.Id.fashionUK.GetHashCode()
                || logDef.CustomerId == CustomerDef.Id.blues_clothing.GetHashCode()
                || logDef.CustomerId == CustomerDef.Id.global_licensing.GetHashCode()
                || (logDef.IsSampleOrder && (logDef.CustomerId == CustomerDef.Id.global_licensing.GetHashCode()
                                            || logDef.CustomerId == CustomerDef.Id.fashionUK.GetHashCode()
                                            || logDef.CustomerId == CustomerDef.Id.misirli.GetHashCode()
                                            || logDef.CustomerId == CustomerDef.Id.smithbrooks.GetHashCode()
                                            || logDef.CustomerId == CustomerDef.Id.brand_international.GetHashCode()
                                            || logDef.CustomerId == CustomerDef.Id.brand_alliance.GetHashCode()
                                            || logDef.CustomerId == CustomerDef.Id.blues_clothing.GetHashCode()
                                            || logDef.CustomerId == CustomerDef.Id.tvm_fashion.GetHashCode()
                                            || logDef.CustomerId == CustomerDef.Id.difuzed.GetHashCode()
                                            || logDef.CustomerId == CustomerDef.Id.fabric_flavours.GetHashCode()
                                            || logDef.CustomerId == CustomerDef.Id.william_lamb.GetHashCode())))
                entry.SegmentValue8 = "R";
            else if (logDef.CustomerId == CustomerDef.Id.directory.GetHashCode() || logDef.CustomerId == CustomerDef.Id.ntn_directory.GetHashCode())
                entry.SegmentValue8 = "D";
            else
                entry.SegmentValue8 = "R";

            if (logDef.IsMockShopSample == 1)
                entry.RealInvoiceNo = mcDef.DCNoteNo + "C";
            else if (logDef.IsStudioSample == 1)
                entry.RealInvoiceNo = studioDef.DCNoteNo + "C";
            else
                entry.RealInvoiceNo = getT9Code(logDef) + "C";
            entry.InvoiceDate = logDef.TransactionDate;

            string reverseSuffix = getReversalSuffix(logDef.SunInterfaceLogId);

            if (isReversal)
            {
                entry.DocumentType = ARInvoiceDocumentTypeEnum.ISAM_RELEASE_LOCK;
                entry.InvoiceNo = getT9Code(logDef) + "C" + (reverseSuffix != string.Empty ? "-" + reverseSuffix : string.Empty) + "D";
                entry.LegalNumber = getT9Code(logDef) + "C" + (reverseSuffix != string.Empty ? "-" + reverseSuffix : string.Empty) + "D";
                entry.RealLegalNumber = getT9Code(logDef) + "C" + (reverseSuffix != string.Empty ? "-" + reverseSuffix : string.Empty);
                entry.IsCreditNote = true;
                entry.ExchangeRate = Math.Round(logDef.BaseAmount / logDef.OtherAmount, 10, MidpointRounding.AwayFromZero);
                entry.Qty = entry.Qty * -1;
            }
            else
            {
                if (logDef.IsSampleOrder)
                {
                    if (logDef.IsMockShopSample == 1)
                    {
                        entry.InvoiceDate = mcDef.DCNoteDate;
                        entry.InvoiceNo = mcDef.DCNoteNo + "C";
                        entry.LegalNumber = mcDef.DCNoteNo + "C";
                        entry.LineOriginalInvoiceNo = getT9Code(logDef);
                        entry.LineDescription = "Mock Shop Comm for P" + logDef.Period.ToString();
                    }
                    else if (logDef.IsStudioSample == 1)
                    {
                        entry.InvoiceDate = studioDef.DCNoteDate;
                        entry.InvoiceNo = studioDef.DCNoteNo + "C";
                        entry.LegalNumber = studioDef.DCNoteNo + "C";
                        entry.LineOriginalInvoiceNo = getT9Code(logDef);
                        entry.LineDescription = "Studio Sample Comm for P" + logDef.Period.ToString();
                    }
                }
                else
                {
                    entry.InvoiceNo = getT9Code(logDef) + "C" + (logDef.CategoryId == CategoryType.REVERSAL.Id ? "-" + reverseSuffix : string.Empty);
                    entry.LegalNumber = getT9Code(logDef) + "C" + (logDef.CategoryId == CategoryType.REVERSAL.Id ? "-" + reverseSuffix : string.Empty);
                }
            }
            entry.IsRecordComplete = false;
            coreEntry = entry;

            if (isILS)
            {
                glEntry = (GLInterfaceEntry)glEntry.Clone();
                glEntry.COA = entry.COA;
                glEntry.DC = !isReversal ? DCFlag.Credit : DCFlag.Debit;
                glEntry.SegmentValue3 = getT1Code(logDef);
                glEntry.SegmentValue4 = generalWorker.getProductCodeDefByKey(logDef.ProductTeamId).Code;
                glEntry.SegmentValue5 = getSeasonSegmentValue(logDef.SeasonId);
                if (CustomerDef.isNextRetail(logDef.CustomerId)
                    || logDef.CustomerId == CustomerDef.Id.global_licensing.GetHashCode()
                    || logDef.CustomerId == CustomerDef.Id.smithbrooks.GetHashCode()
                    || (logDef.IsSampleOrder && (logDef.CustomerId == CustomerDef.Id.global_licensing.GetHashCode()
                                                || logDef.CustomerId == CustomerDef.Id.fashionUK.GetHashCode()
                                                || logDef.CustomerId == CustomerDef.Id.misirli.GetHashCode()
                                                || logDef.CustomerId == CustomerDef.Id.smithbrooks.GetHashCode()
                                                || logDef.CustomerId == CustomerDef.Id.brand_international.GetHashCode()
                                                || logDef.CustomerId == CustomerDef.Id.brand_alliance.GetHashCode()
                                                || logDef.CustomerId == CustomerDef.Id.blues_clothing.GetHashCode()
                                                || logDef.CustomerId == CustomerDef.Id.tvm_fashion.GetHashCode()
                                                || logDef.CustomerId == CustomerDef.Id.difuzed.GetHashCode()
                                                || logDef.CustomerId == CustomerDef.Id.fabric_flavours.GetHashCode()
                                                || logDef.CustomerId == CustomerDef.Id.william_lamb.GetHashCode())))
                    glEntry.SegmentValue8 = "R";
                else if (logDef.CustomerId == CustomerDef.Id.directory.GetHashCode() || logDef.CustomerId == CustomerDef.Id.ntn_directory.GetHashCode())
                    glEntry.SegmentValue8 = "D";
                else
                    glEntry.SegmentValue8 = "R";
                glEntry.IsRecordComplete = true;
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);
            }
            else
            {
                if (!isReversal && !logDef.IsSampleOrder) coreEntry.IsRecordComplete = true;
                EpicorInterfaceWorker.Instance.ARInvoiceInterfaceFile.Entries.Add((IEpicorInterfaceEntry)coreEntry);
            }

            /*
            if (t0 == "THV2" && logDef.OfficeId == OfficeId.VN.Id && logDef.CurrencyId == CurrencyId.GBP.Id)
            {
                glEntry = new GLInterfaceEntry();
                glEntry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, OfficeId.VN.Id).EpicorCompanyId;
                glEntry.GroupId = EpicorInterfaceWorker.Instance.GLInterfaceFile.getSourceString();
                glEntry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                glEntry.ApplyDate = glEntry.GroupApplyDate;

                if (isEnableWeek53Handling(logDef, isReversal))
                {
                    glEntry.GroupApplyDate = WK53_APPLY_DATE;
                    glEntry.ApplyDate = WK53_APPLY_DATE;
                }

                glEntry.DocumentType = GLDocumentTypeEnum.GL;
                glEntry.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
                glEntry.DC = !isReversal ? DCFlag.Debit : DCFlag.Credit;
                glEntry.Qty = logDef.Quantity * logDef.PiecesPerPack;
                glEntry.Amount = logDef.OtherAmount;
                glEntry.BaseAmount = logDef.BaseAmount;
                glEntry.LineDescription = logDef.ContractNo + "-" + logDef.DeliveryNo.ToString();
                glEntry.Office = "THV2";
                glEntry.COA = "1302013";
                glEntry.IsRecordComplete = false;
                glEntry.SegmentValue3 = getT1Code(logDef);
                glEntry.SegmentValue4 = generalWorker.getProductCodeDefByKey(logDef.ProductTeamId).Code;
                glEntry.SegmentValue5 = getSeasonSegmentValue(logDef.SeasonId);
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                glEntry = (GLInterfaceEntry)glEntry.Clone();
                glEntry.DC = !isReversal ? DCFlag.Credit : DCFlag.Debit;
                glEntry.COA = salesCOA;
                if (CustomerDef.isNextRetail(logDef.CustomerId) || logDef.CustomerId == CustomerDef.Id.global_licensing.GetHashCode() || logDef.CustomerId == CustomerDef.Id.smithbrooks.GetHashCode() || (logDef.IsSampleOrder && (logDef.CustomerId == CustomerDef.Id.global_licensing.GetHashCode() || logDef.CustomerId == CustomerDef.Id.fashionUK.GetHashCode() || logDef.CustomerId == CustomerDef.Id.misirli.GetHashCode() || logDef.CustomerId == CustomerDef.Id.smithbrooks.GetHashCode() || logDef.CustomerId == CustomerDef.Id.brand_international.GetHashCode() || logDef.CustomerId == CustomerDef.Id.brand_alliance.GetHashCode())))
                    glEntry.SegmentValue8 = "R";
                else if (logDef.CustomerId == CustomerDef.Id.directory.GetHashCode() || logDef.CustomerId == CustomerDef.Id.ntn_directory.GetHashCode())
                    glEntry.SegmentValue8 = "D";
                glEntry.IsRecordComplete = true;
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);
            }
            */
            if (t0 == "CA1F" && logDef.OfficeId == OfficeId.CA.Id && logDef.CurrencyId == CurrencyId.GBP.Id)
            {
                glEntry = new GLInterfaceEntry();
                glEntry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, OfficeId.CA.Id).EpicorCompanyId;
                glEntry.GroupId = EpicorInterfaceWorker.Instance.GLInterfaceFile.getSourceString();
                glEntry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                glEntry.ApplyDate = glEntry.GroupApplyDate;

                if (isEnableWeek53Handling(logDef, isReversal))
                {
                    glEntry.GroupApplyDate = WK53_APPLY_DATE;
                    glEntry.ApplyDate = WK53_APPLY_DATE;
                }

                glEntry.DocumentType = GLDocumentTypeEnum.GL;
                glEntry.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
                glEntry.DC = !isReversal ? DCFlag.Debit : DCFlag.Credit;
                glEntry.Qty = logDef.Quantity * logDef.PiecesPerPack;
                glEntry.Amount = logDef.OtherAmount;
                glEntry.BaseAmount = logDef.BaseAmount;
                glEntry.LineDescription = logDef.ContractNo + "-" + logDef.DeliveryNo.ToString();
                glEntry.Office = "CA1F";
                glEntry.COA = "1302010";
                glEntry.IsRecordComplete = false;
                glEntry.SegmentValue3 = getT1Code(logDef);
                glEntry.SegmentValue4 = generalWorker.getProductCodeDefByKey(logDef.ProductTeamId).Code;
                glEntry.SegmentValue5 = getSeasonSegmentValue(logDef.SeasonId);
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                glEntry = (GLInterfaceEntry)glEntry.Clone();
                glEntry.DC = !isReversal ? DCFlag.Credit : DCFlag.Debit;
                glEntry.COA = salesCOA;
                if (CustomerDef.isNextRetail(logDef.CustomerId)
                    || logDef.CustomerId == CustomerDef.Id.global_licensing.GetHashCode()
                    || logDef.CustomerId == CustomerDef.Id.smithbrooks.GetHashCode()
                    || (logDef.IsSampleOrder && (logDef.CustomerId == CustomerDef.Id.global_licensing.GetHashCode()
                                                || logDef.CustomerId == CustomerDef.Id.fashionUK.GetHashCode()
                                                || logDef.CustomerId == CustomerDef.Id.misirli.GetHashCode()
                                                || logDef.CustomerId == CustomerDef.Id.smithbrooks.GetHashCode()
                                                || logDef.CustomerId == CustomerDef.Id.brand_international.GetHashCode()
                                                || logDef.CustomerId == CustomerDef.Id.brand_alliance.GetHashCode()
                                                || logDef.CustomerId == CustomerDef.Id.blues_clothing.GetHashCode()
                                                || logDef.CustomerId == CustomerDef.Id.tvm_fashion.GetHashCode()
                                                || logDef.CustomerId == CustomerDef.Id.difuzed.GetHashCode()
                                                || logDef.CustomerId == CustomerDef.Id.fabric_flavours.GetHashCode()
                                                || logDef.CustomerId == CustomerDef.Id.william_lamb.GetHashCode())))
                    glEntry.SegmentValue8 = "R";
                else if (logDef.CustomerId == CustomerDef.Id.directory.GetHashCode() || logDef.CustomerId == CustomerDef.Id.ntn_directory.GetHashCode())
                    glEntry.SegmentValue8 = "D";
                else
                    glEntry.SegmentValue8 = "R";
                glEntry.IsRecordComplete = true;
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);
            }

        }

        private void addAccrualSalesCommissionToSAFList(SunInterfaceLogDef logDef, ArrayList safList)
        {
            if (logDef.BaseAmount == 0) return;
            string t0 = getT0Code(logDef);
            GLInterfaceEntry entry = new GLInterfaceEntry();

            #region sales commission debit entry

            entry.Reverse = true;
            entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
            entry.GroupId = EpicorInterfaceWorker.Instance.GLInterfaceFile.getSourceString();
            entry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
            entry.ApplyDate = entry.GroupApplyDate;
            entry.DocumentType = GLDocumentTypeEnum.ISAM_ACCRUAL_SALES;
            entry.COA = generalWorker.getEpicorCOA("1311302");
            entry.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
            entry.DC = DCFlag.Debit;
            entry.Amount = logDef.OtherAmount;
            entry.BaseAmount = logDef.BaseAmount;
            entry.Qty = logDef.Quantity * logDef.PiecesPerPack;
            entry.LineDescription = logDef.ContractNo + "-" + logDef.DeliveryNo.ToString() + " #" + ProductWorker.Instance.getProductByKey(logDef.ProductId).ItemNo;
            if (t0 == "TKMF") entry.Office = "TK1F";
            else if (t0 == "TK5F") entry.Office = "TK1F";
            else entry.Office = t0;
            EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);

            #endregion

            #region sales commission credit entry

            entry = (GLInterfaceEntry)entry.Clone();
            entry.COA = generalWorker.getEpicorCOA("2102191");
            entry.Office = t0;
            entry.SegmentValue3 = getT1Code(logDef);
            entry.SegmentValue4 = generalWorker.getProductCodeDefByKey(logDef.ProductTeamId).Code;
            entry.SegmentValue5 = getSeasonSegmentValue(logDef.SeasonId);
            if (CustomerDef.isNextRetail(logDef.CustomerId)
                || logDef.CustomerId == CustomerDef.Id.smithbrooks.GetHashCode()
                || logDef.CustomerId == CustomerDef.Id.global_licensing.GetHashCode()
                || (logDef.IsSampleOrder && (logDef.CustomerId == CustomerDef.Id.global_licensing.GetHashCode()
                                            || logDef.CustomerId == CustomerDef.Id.fashionUK.GetHashCode()
                                            || logDef.CustomerId == CustomerDef.Id.misirli.GetHashCode()
                                            || logDef.CustomerId == CustomerDef.Id.smithbrooks.GetHashCode()
                                            || logDef.CustomerId == CustomerDef.Id.brand_international.GetHashCode()
                                            || logDef.CustomerId == CustomerDef.Id.brand_alliance.GetHashCode()
                                            || logDef.CustomerId == CustomerDef.Id.blues_clothing.GetHashCode()
                                            || logDef.CustomerId == CustomerDef.Id.tvm_fashion.GetHashCode()
                                            || logDef.CustomerId == CustomerDef.Id.difuzed.GetHashCode()
                                            || logDef.CustomerId == CustomerDef.Id.fabric_flavours.GetHashCode()
                                            || logDef.CustomerId == CustomerDef.Id.william_lamb.GetHashCode())))
                entry.SegmentValue8 = "R";
            else if (logDef.CustomerId == CustomerDef.Id.directory.GetHashCode() || logDef.CustomerId == CustomerDef.Id.ntn_directory.GetHashCode())
                entry.SegmentValue8 = "D";
            else
                entry.SegmentValue8 = "R";
            entry.DC = DCFlag.Credit;
            entry.IsRecordComplete = true;
            EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);

            #endregion
        }

        private void addActualSalesToSAFList(SunInterfaceLogDef logDef, ArrayList safList, bool isReversal)
        {
            this.addActualSalesToSAFList(logDef, safList, isReversal, false);
        }

        private void addActualSalesCommissionToSAFList(SunInterfaceLogDef logDef, ArrayList safList, bool isReversal)
        {
            this.addActualSalesCommissionToSAFList(logDef, safList, isReversal, false);
        }

        private void addActualTemporaryPaymentToSAFList(SunInterfaceLogDef logDef, ArrayList safList, bool isReversal)
        {
            if (logDef.BaseAmount == 0) return;
            VendorRef vendor = vendorWorker.getVendorByKey(logDef.VendorId);
            string t0 = getT0Code(logDef);

            GLInterfaceEntry entry = new GLInterfaceEntry();
            entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
            entry.GroupId = EpicorInterfaceWorker.Instance.GLInterfaceFile.getSourceString();
            entry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
            entry.ApplyDate = entry.GroupApplyDate;

            if (isEnableWeek53Handling(logDef, isReversal))
            {
                entry.GroupApplyDate = WK53_APPLY_DATE;
                entry.ApplyDate = WK53_APPLY_DATE;
            }

            entry.DocumentType = GLDocumentTypeEnum.GL;
            entry.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
            entry.DC = DCFlag.Debit;
            entry.Amount = logDef.OtherAmount;
            entry.BaseAmount = logDef.BaseAmount;
            entry.Qty = logDef.Quantity * logDef.PiecesPerPack;
            entry.LineDescription = logDef.ContractNo + "-" + logDef.DeliveryNo.ToString();
            entry.Office = t0;
            entry.COA = generalWorker.getEpicorCOA("1310502");
            entry.Reverse = true;
            entry.IsRecordComplete = false;
            EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);

            entry = (GLInterfaceEntry)entry.Clone();

            if (logDef.CustomerId == CustomerDef.Id.lm_ted_baker.GetHashCode())
                entry.COA = "3201013";
            else if (logDef.CustomerId == CustomerDef.Id.lm_oasis.GetHashCode())
                entry.COA = "3201014";
            else if (logDef.CustomerId == CustomerDef.Id.lm_label_mix.GetHashCode())
                entry.COA = "3201015";
            else if (logDef.CustomerId == CustomerDef.Id.lm_little_bird.GetHashCode())
                entry.COA = "3201016";
            else if (logDef.CustomerId == CustomerDef.Id.lm_myleene_klass.GetHashCode())
                entry.COA = "3201017";
            else if (logDef.CustomerId == CustomerDef.Id.lm_nine.GetHashCode())
                entry.COA = "3201018";
            else if (logDef.CustomerId == CustomerDef.Id.lm_mintie.GetHashCode())
                entry.COA = "3201019";
            else if (logDef.CustomerId == CustomerDef.Id.lm_fat_face.GetHashCode())
                entry.COA = "3201021";
            else if (logDef.CustomerId == CustomerDef.Id.lm_laura_ashley.GetHashCode())
                entry.COA = "3201022";
            else if (logDef.CustomerId == CustomerDef.Id.lm_mint_velvet.GetHashCode())
                entry.COA = "3201024";
            else if (logDef.CustomerId == CustomerDef.Id.lm_hype.GetHashCode())
                entry.COA = "3201023";
            else
                entry.COA = "3106101";

            entry.COA = generalWorker.getEpicorCOA(entry.COA);
            entry.DC = DCFlag.Credit;
            entry.SegmentValue3 = getT1Code(logDef);
            entry.SegmentValue4 = generalWorker.getProductCodeDefByKey(logDef.ProductTeamId).Code;
            entry.SegmentValue5 = getSeasonSegmentValue(logDef.SeasonId);
            entry.IsRecordComplete = true;
            EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);
        }

        public string getNextMissingSuplierInvoiceNo()
        {
            int counter = 0;
            SystemParameterRef def = commonWorker.getSystemParameterByName("MISSING_SUP_INV_NO_COUNTER");
            counter = int.Parse(def.ParameterValue);
            def.ParameterValue = (counter + 1).ToString();
            commonWorker.updateSystemParameter(def);
            return "MISSING" + counter.ToString().PadLeft(5, '0');
        }

        public int getNextPaymentGroupId()
        {
            int counter = 0;
            SystemParameterRef def = commonWorker.getSystemParameterByName("EPICOR_PAYMENT_GROUP_ID");
            counter = int.Parse(def.ParameterValue);
            def.ParameterValue = (counter + 1).ToString();
            commonWorker.updateSystemParameter(def);
            return counter;
        }

        public int getNextReceiptGroupId()
        {
            int counter = 0;
            SystemParameterRef def = commonWorker.getSystemParameterByName("EPICOR_RECEIPT_GROUP_ID");
            counter = int.Parse(def.ParameterValue);
            def.ParameterValue = (counter + 1).ToString();
            commonWorker.updateSystemParameter(def);
            return counter;
        }

        private int getNextEpicorPaymentNo()
        {
            int counter = 0;
            SystemParameterRef def = commonWorker.getSystemParameterByName("EPICOR_PAYMENT_ID");
            counter = int.Parse(def.ParameterValue);
            def.ParameterValue = (counter + 1).ToString();
            commonWorker.updateSystemParameter(def);
            return counter;
        }

        private int getNextEpicorCheckNo()
        {
            int counter = 0;
            SystemParameterRef def = commonWorker.getSystemParameterByName("EPICOR_CHECK_ID");
            counter = int.Parse(def.ParameterValue);
            def.ParameterValue = (counter + 1).ToString();
            commonWorker.updateSystemParameter(def);
            return counter;
        }

        private void addActualPurchaseToSAFList(SunInterfaceLogDef logDef, ArrayList safList, bool isReversal)
        {
            System.Diagnostics.Debug.WriteLine(logDef.ContractNo + " " + logDef.ShipmentId.ToString());
            if (logDef.BaseAmount == 0) return;
            VendorRef vendor = vendorWorker.getVendorByKey(logDef.VendorId);
            ShipmentDef shipmentDef = OrderSelectWorker.Instance.getShipmentByKey(logDef.ShipmentId);
            ContractDef contractDef = OrderSelectWorker.Instance.getContractByKey(shipmentDef.ContractId);

            string t0 = getT0Code(logDef);

            #region purchase debit entry
            SAFDef def = new SAFDef();
            if (logDef.CustomerId == CustomerDef.Id.japan.GetHashCode())
                def.AccountCode = "3106108";
            else if (logDef.CustomerId == CustomerDef.Id.middleeast.GetHashCode())
                def.AccountCode = "3106109";
            else if (logDef.CustomerId == CustomerDef.Id.lipsy.GetHashCode())
                def.AccountCode = "3106112";
            else if (logDef.CustomerId == CustomerDef.Id.gt.GetHashCode())
                def.AccountCode = "3106124";
            else if (logDef.CustomerId == CustomerDef.Id.days.GetHashCode())
                def.AccountCode = "3106125";
            else if (logDef.CustomerId == CustomerDef.Id.ezibuy.GetHashCode())
                def.AccountCode = "3106126";
            else if (logDef.CustomerId == CustomerDef.Id.bravado.GetHashCode())
                def.AccountCode = "3106160";
            else if (logDef.CustomerId == CustomerDef.Id.global_licensing.GetHashCode())
                def.AccountCode = "3106530";
            /*
            else if (logDef.WithOPRFabric == 1 || logDef.WithOPRFabric == 3)
                def.AccountCode = "1320131";
            */
            else if (logDef.CustomerId == CustomerDef.Id.fashionUK.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    def.AccountCode = "3106101";
                else
                    def.AccountCode = "3106501";
            }
            else if (logDef.CustomerId == CustomerDef.Id.misirli.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    def.AccountCode = "3106101";
                else
                    def.AccountCode = "3106540";
            }
            else if (logDef.CustomerId == CustomerDef.Id.smithbrooks.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    def.AccountCode = "3106101";
                else
                    def.AccountCode = "3106190";
            }
            else if (logDef.CustomerId == CustomerDef.Id.choice.GetHashCode())
                def.AccountCode = "3106130";
            else if (logDef.CustomerId == CustomerDef.Id.hempel.GetHashCode() && logDef.CurrencyId == CurrencyId.USD.Id)
                def.AccountCode = "3106121";
            else
                def.AccountCode = "3106101";

            if (getCutOffStatus(logDef.ShipmentId).CutOffStatusId == CutOffStatus.ACCRUAL.GetHashCode())
                def.Filler1 = "R";
            def.FiscalYear = logDef.FiscalYear;
            def.Period = logDef.Period;
            def.TransactionDate = logDef.TransactionDate;
            def.DebitCreditIndicator = !isReversal ? "D" : "C";
            //if (CustomerDestinationDef.isUTurnOrder(logDef.CustomerDestinationId))
            if (logDef.TermOfPurchaseId == TermOfPurchaseRef.Id.FOB_UT.GetHashCode())
            {
                /*
                if (logDef.VendorId == 608)
                */
                def.AccountCode = "3106121";
                def.JournalType = "Y" + "IP";
                def.BaseAmount = logDef.UTTotalShippedSupplierGmtAmount;
            }
            else
            {
                def.JournalType = getJournalPrefix(logDef.OfficeId, logDef.TradingAgencyId) + "IP";
                def.BaseAmount = logDef.BaseAmount;
            }
            if (logDef.SplitShipmentId > 0)
                def.Description = logDef.ContractNo;
            else
                def.Description = getT9Code(logDef) + " " + vendor.Name;
            def.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
            def.OtherAmount = logDef.OtherAmount;
            //if (CustomerDestinationDef.isUTurnOrder(logDef.CustomerDestinationId))
            if (logDef.TermOfPurchaseId == TermOfPurchaseRef.Id.FOB_UT.GetHashCode())
                def.T0 = "FY1U";
            else
            {
                def.T0 = t0;
                if (t0 == "TK4F" && !isReversal) totalBaseAmt += def.BaseAmount;
                if (t0 == "TK4F" && isReversal) totalReverseBaseAmt += def.BaseAmount;
            }
            def.T1 = getT1Code(logDef);
            def.T2 = generalWorker.getProductCodeDefByKey(logDef.ProductTeamId).Code;
            def.T5 = getT5Code(logDef.SeasonId);
            def.T6 = getT6Code(logDef.PaymentTermId);
            def.T8 = getT8Code(logDef.ProductId);
            def.T9 = getT9Code(logDef);
            def.OfficeCode = OfficeId.getName(logDef.OfficeId);
            def.TradingAgency = TradingAgencyId.getName(logDef.TradingAgencyId);
            def.PaymentTerm = PaymentTermRef.getDescriptionForSAF(logDef.PaymentTermId);
            safList.Add(def);
            #endregion

            if (logDef.OfficeId == OfficeId.SH.Id || logDef.OfficeId == OfficeId.TH.Id || logDef.OfficeId == OfficeId.HK.Id || logDef.OfficeId == OfficeId.DG.Id || logDef.OfficeId == OfficeId.VN.Id || logDef.OfficeId == OfficeId.CA.Id)
            {
                decimal qaBaseAmt = 0;
                decimal qaOtherAmt = 0;
                if (logDef.TermOfPurchaseId == TermOfPurchaseRef.Id.FOB_UT.GetHashCode())
                    def.BaseAmount = logDef.UTTotalShippedSupplierGmtAmount;
                else
                    def.BaseAmount = logDef.BaseAmount;
                def.OtherAmount = logDef.OtherAmount;

                qaBaseAmt = Math.Round((logDef.QACommissionPercent / 100) * logDef.BaseAmount, 2, MidpointRounding.AwayFromZero);
                qaOtherAmt = Math.Round((logDef.QACommissionPercent / 100) * logDef.OtherAmount, 2, MidpointRounding.AwayFromZero);

                #region purchase amt without qa comm credit
                def = (SAFDef)def.Clone();
                def.CreateDate = DateTime.Now;
                def.AccountCode = vendor.SunAccountCode;
                def.DebitCreditIndicator = !isReversal ? "C" : "D";
                def.Description = logDef.SupplierInvoiceNo;

                if (logDef.TermOfPurchaseId == TermOfPurchaseRef.Id.FOB_UT.GetHashCode())
                {
                    def.T0 = "FY1U";
                }
                else
                {
                    if (t0 == "HK1G" || t0 == "FBHK" || t0 == "HKFB") def.T0 = "HK1F";
                    else if (t0 == "FBSH" || t0 == "SHFB") def.T0 = "SH2F";
                    else if (t0 == "FBVN" || t0 == "VNFB") def.T0 = "THV2";
                    else if (t0 == "THV2" && logDef.OfficeId != OfficeId.VN.Id) def.T0 = "TH2F";
                    else if (t0 == "THV2" && logDef.OfficeId == OfficeId.VN.Id && logDef.CurrencyId == CurrencyId.GBP.Id) def.T0 = "THV2";
                    else def.T0 = t0;
                }
                def.BaseAmount = def.BaseAmount - qaBaseAmt;
                def.OtherAmount = def.OtherAmount - qaOtherAmt;
                if (logDef.LabTestIncome > 0)
                {
                    def.OtherAmount = def.OtherAmount - Math.Round(logDef.Quantity * logDef.LabTestIncome, 2, MidpointRounding.AwayFromZero);
                    def.BaseAmount = def.BaseAmount - Math.Round(Math.Round(logDef.Quantity * logDef.LabTestIncome, 2, MidpointRounding.AwayFromZero) * commonWorker.getExchangeRate(ExchangeRateType.INVOICE, logDef.CurrencyId, logDef.TransactionDate) / commonWorker.getExchangeRate(ExchangeRateType.INVOICE, CurrencyId.USD.Id, logDef.TransactionDate), 2, MidpointRounding.AwayFromZero);
                }
                //if ((t0 == "THV2" || t0 == "HK1G") && !isReversal && !CustomerDestinationDef.isUTurnOrder(logDef.CustomerDestinationId) && logDef.OfficeId != OfficeId.VN.Id) totalBaseAmt += def.BaseAmount;
                if ((t0 == "THV2" || t0 == "HK1G") && !isReversal && logDef.TermOfPurchaseId != TermOfPurchaseRef.Id.FOB_UT.GetHashCode() && logDef.OfficeId != OfficeId.VN.Id) totalBaseAmt += def.BaseAmount;
                if (t0 == "THV2" && logDef.OfficeId == OfficeId.VN.Id && !isReversal && logDef.CurrencyId == CurrencyId.GBP.Id) totalBaseAmt += def.BaseAmount;
                if (t0 == "FBHK" && !isReversal) totalFBHKBaseAmt += def.BaseAmount;
                if (t0 == "FBSH" && !isReversal) totalFBSHBaseAmt += def.BaseAmount;
                if (t0 == "FBVN" && !isReversal) totalFBVNBaseAmt += def.BaseAmount;
                if (t0 == "HKFB" && !isReversal) totalHKFBBaseAmt += def.BaseAmount;
                if (t0 == "SHFB" && !isReversal) totalSHFBBaseAmt += def.BaseAmount;
                if (t0 == "VNFB" && !isReversal) totalVNFBBaseAmt += def.BaseAmount;

                //if ((t0 == "THV2" || t0 == "HK1G") && isReversal && !CustomerDestinationDef.isUTurnOrder(logDef.CustomerDestinationId) && logDef.OfficeId != OfficeId.VN.Id) totalReverseBaseAmt += def.BaseAmount;
                if ((t0 == "THV2" || t0 == "HK1G") && isReversal && logDef.TermOfPurchaseId != TermOfPurchaseRef.Id.FOB_UT.GetHashCode() && logDef.OfficeId != OfficeId.VN.Id) totalReverseBaseAmt += def.BaseAmount;
                if (t0 == "THV2" && logDef.OfficeId == OfficeId.VN.Id && isReversal && logDef.CurrencyId == CurrencyId.GBP.Id) totalReverseBaseAmt += def.BaseAmount;
                if (t0 == "FBHK" && isReversal) totalFBHKReverseBaseAmt += def.BaseAmount;
                if (t0 == "FBSH" && isReversal) totalFBSHReverseBaseAmt += def.BaseAmount;
                if (t0 == "FBVN" && isReversal) totalFBVNReverseBaseAmt += def.BaseAmount;
                if (t0 == "HKFB" && isReversal) totalHKFBReverseBaseAmt += def.BaseAmount;
                if (t0 == "SHFB" && isReversal) totalSHFBReverseBaseAmt += def.BaseAmount;
                if (t0 == "VNFB" && isReversal) totalVNFBReverseBaseAmt += def.BaseAmount;

                safList.Add(def);
                #endregion

                #region qa comm credit
                def = (SAFDef)def.Clone();
                def.CreateDate = DateTime.Now;
                def.AccountCode = "2102111";
                def.DebitCreditIndicator = !isReversal ? "C" : "D";
                def.Description = "QA comm " + getT9Code(logDef);
                def.BaseAmount = qaBaseAmt;
                def.OtherAmount = qaOtherAmt;
                //if (CustomerDestinationDef.isUTurnOrder(logDef.CustomerDestinationId))
                if (logDef.TermOfPurchaseId == TermOfPurchaseRef.Id.FOB_UT.GetHashCode())
                    def.T0 = "FY1U";
                else
                    def.T0 = t0;
                if (t0 == "FBHK" || t0 == "FBSH" || t0 == "FBVN" || t0 == "HKFB" || t0 == "SHFB" || t0 == "VNFB")
                    def.T8 = t0;
                safList.Add(def);
                #endregion
            }
            else if (logDef.OfficeId == OfficeId.BD.Id || logDef.OfficeId == OfficeId.IND.Id || logDef.OfficeId == OfficeId.ND.Id || logDef.OfficeId == OfficeId.PK.Id || logDef.OfficeId == OfficeId.SL.Id || logDef.OfficeId == OfficeId.TR.Id || logDef.OfficeId == OfficeId.EG.Id)
            {
                decimal paymentDiscountBaseAmt = Math.Round(logDef.BaseAmount * logDef.VendorPaymentDiscountPercent / 100, 2, MidpointRounding.AwayFromZero);
                decimal paymentDiscountOtherAmt = Math.Round(logDef.OtherAmount * logDef.VendorPaymentDiscountPercent / 100, 2, MidpointRounding.AwayFromZero);


                #region purchase amt without vendor payment discount debit
                def = (SAFDef)def.Clone();
                def.CreateDate = DateTime.Now;
                if (TermOfPurchaseRef.isVM(logDef.TermOfPurchaseId) && logDef.OfficeId == OfficeId.TR.Id && (logDef.TradingAgencyId == TradingAgencyId.NSLVM.AgencyId || logDef.TradingAgencyId == TradingAgencyId.NSLVMOT.AgencyId))
                    def.AccountCode = "1403301";
                else
                    def.AccountCode = vendor.SunAccountCode;
                def.DebitCreditIndicator = !isReversal ? "C" : "D";
                def.Description = logDef.SupplierInvoiceNo;
                def.BaseAmount = def.BaseAmount - paymentDiscountBaseAmt;
                def.OtherAmount = def.OtherAmount - paymentDiscountOtherAmt;
                if (logDef.LabTestIncome > 0)
                {
                    def.OtherAmount = def.OtherAmount - Math.Round(logDef.Quantity * logDef.LabTestIncome, 2, MidpointRounding.AwayFromZero);
                    def.BaseAmount = def.BaseAmount - Math.Round(Math.Round(logDef.Quantity * logDef.LabTestIncome, 2, MidpointRounding.AwayFromZero) * commonWorker.getExchangeRate(ExchangeRateType.INVOICE, logDef.CurrencyId, logDef.TransactionDate) / commonWorker.getExchangeRate(ExchangeRateType.INVOICE, CurrencyId.USD.Id, logDef.TransactionDate), 2, MidpointRounding.AwayFromZero);
                }
                if (t0 == "TKMF") def.T0 = "TK1F";
                else if (t0 == "TK5F") def.T0 = "TK1F";
                else def.T0 = t0;

                safList.Add(def);
                #endregion

                #region actual purchase discount credit entry
                if (logDef.VendorPaymentDiscountPercent > 0)
                {
                    def = (SAFDef)def.Clone();
                    def.CreateDate = DateTime.Now;
                    if (logDef.OfficeId == OfficeId.TR.Id || logDef.OfficeId == OfficeId.EG.Id || logDef.OfficeId == OfficeId.PK.Id || logDef.OfficeId == OfficeId.SL.Id || logDef.OfficeId == OfficeId.MA.Id)
                        def.AccountCode = "2102301";
                    else
                        def.AccountCode = "2102301";
                    def.DebitCreditIndicator = !isReversal ? "C" : "D";
                    def.OtherAmount = paymentDiscountOtherAmt;
                    def.BaseAmount = paymentDiscountBaseAmt;
                    def.Description = vendor.SunAccountCode + "-" + PaymentTermRef.getDescription(logDef.PaymentTermId);
                    def.T0 = t0;
                    safList.Add(def);
                }
                #endregion
            }
            else
            {
                #region purchase credit entry
                def = (SAFDef)def.Clone();
                def.CreateDate = DateTime.Now;
                if (TermOfPurchaseRef.isVM(logDef.TermOfPurchaseId) && logDef.OfficeId == OfficeId.TR.Id && (logDef.TradingAgencyId == TradingAgencyId.NSLVM.AgencyId || logDef.TradingAgencyId == TradingAgencyId.NSLVMOT.AgencyId))
                    def.AccountCode = "1403301";
                else
                    def.AccountCode = vendor.SunAccountCode;
                def.DebitCreditIndicator = !isReversal ? "C" : "D";
                def.Description = logDef.SupplierInvoiceNo;
                if (logDef.LabTestIncome > 0)
                {
                    def.OtherAmount = def.OtherAmount - Math.Round(logDef.Quantity * logDef.LabTestIncome, 2, MidpointRounding.AwayFromZero);
                    def.BaseAmount = def.BaseAmount - Math.Round(Math.Round(logDef.Quantity * logDef.LabTestIncome, 2, MidpointRounding.AwayFromZero) * commonWorker.getExchangeRate(ExchangeRateType.INVOICE, logDef.CurrencyId, logDef.TransactionDate) / commonWorker.getExchangeRate(ExchangeRateType.INVOICE, CurrencyId.USD.Id, logDef.TransactionDate), 2, MidpointRounding.AwayFromZero);
                }
                if (t0 == "TKMF") def.T0 = "TK1F";
                else if (t0 == "TK5F") def.T0 = "TK1F";
                else def.T0 = t0;

                safList.Add(def);
                #endregion
            }

            /*
            if (CustomerDestinationDef.isUTurnOrder(logDef.CustomerDestinationId) && (logDef.SplitShipmentId == 0 || (logDef.SplitShipmentId != 0 && logDef.ContractNo.EndsWith("A"))))
            */

            if (logDef.TermOfPurchaseId == TermOfPurchaseRef.Id.FOB_UT.GetHashCode() && (logDef.SplitShipmentId == 0 || (logDef.SplitShipmentId != 0 && logDef.ContractNo.EndsWith("A"))))
            {
                #region ut vat input debit entry
                def = (SAFDef)def.Clone();
                def.CreateDate = DateTime.Now;
                def.AccountCode = "1506105";
                def.DebitCreditIndicator = !isReversal ? "D" : "C";
                def.BaseAmount = logDef.UTInputVATAmount;
                def.OtherAmount = logDef.UTInputVATAmount;
                def.CurrencyCode = "CNY";
                def.T0 = "FY1U";
                def.Description = "VAT Payable " + logDef.ContractNo;
                safList.Add(def);
                #endregion

                #region ut vat input credit entry
                def = (SAFDef)def.Clone();
                def.CreateDate = DateTime.Now;
                def.AccountCode = "1410996";
                def.DebitCreditIndicator = !isReversal ? "C" : "D";
                def.T0 = "FY1U";
                safList.Add(def);
                #endregion

                #region ut import duty debit entry
                def = (SAFDef)def.Clone();
                def.CreateDate = DateTime.Now;
                def.AccountCode = "3106306";
                def.DebitCreditIndicator = !isReversal ? "D" : "C";
                def.BaseAmount = logDef.UTImportDuty;
                def.OtherAmount = logDef.UTImportDuty;
                def.CurrencyCode = "CNY";
                def.Description = "Import Duty " + logDef.ContractNo;
                def.T0 = "FY1U";
                safList.Add(def);
                #endregion

                #region ut vat input credit entry
                def = (SAFDef)def.Clone();
                def.CreateDate = DateTime.Now;
                def.AccountCode = "1410996";
                def.DebitCreditIndicator = !isReversal ? "C" : "D";
                def.T0 = "FY1U";
                safList.Add(def);
                #endregion
            }


            if (logDef.LabTestIncome > 0)
            {
                #region actual purchase lab test credit entry
                def = (SAFDef)def.Clone();
                def.CreateDate = DateTime.Now;
                def.AccountCode = "2102114";
                def.OtherAmount = Math.Round(logDef.Quantity * logDef.LabTestIncome, 2, MidpointRounding.AwayFromZero);
                def.BaseAmount = Math.Round(def.OtherAmount * commonWorker.getExchangeRate(ExchangeRateType.INVOICE, logDef.CurrencyId, logDef.TransactionDate) / commonWorker.getExchangeRate(ExchangeRateType.INVOICE, CurrencyId.USD.Id, logDef.TransactionDate), 2, MidpointRounding.AwayFromZero);
                def.Description = "LAB TEST FOR P" + logDef.Period.ToString();
                def.DebitCreditIndicator = !isReversal ? "C" : "D";
                def.T0 = t0;
                def.T9 = def.T9 + "D";
                safList.Add(def);
                #endregion
            }

            bool isDuty = false;
            /* TODO:EPICOR */
            string splitSuffix = string.Empty;
            if (logDef.SplitShipmentId > 0)
                splitSuffix = OrderSelectWorker.Instance.getSplitShipmentByKey(logDef.SplitShipmentId).SplitSuffix;

            APInvoiceInterfaceEntry coreEntry = new APInvoiceInterfaceEntry();
            APInvoiceInterfaceEntry entry = new APInvoiceInterfaceEntry();
            if (logDef.CustomerId == CustomerDef.Id.japan.GetHashCode())
                entry.COA = "3106108";
            else if (logDef.CustomerId == CustomerDef.Id.middleeast.GetHashCode())
                entry.COA = "3106109";
            else if (logDef.CustomerId == CustomerDef.Id.lipsy.GetHashCode())
                entry.COA = "3106112";
            else if (logDef.CustomerId == CustomerDef.Id.gt.GetHashCode())
                entry.COA = "3106124";
            else if (logDef.CustomerId == CustomerDef.Id.days.GetHashCode())
                entry.COA = "3106125";
            else if (logDef.CustomerId == CustomerDef.Id.blues_clothing.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "3106101";
                else
                    entry.COA = "3101140";
            }
            else if (logDef.CustomerId == CustomerDef.Id.william_lamb.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "3106101";
                else
                    entry.COA = "3101150";
            }
            else if (logDef.CustomerId == CustomerDef.Id.bioworld.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "3106101";
                else
                    entry.COA = "3101190";
            }
            else if (logDef.CustomerId == CustomerDef.Id.paul_dennicci.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "3106101";
                else
                    entry.COA = "3101210";
            }
            else if (logDef.CustomerId == CustomerDef.Id.cortina.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "3106101";
                else
                    entry.COA = "3101260";
            }
            else if (logDef.CustomerId == CustomerDef.Id.sicem.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "3106101";
                else
                    entry.COA = "3101270";
            }
            else if (logDef.CustomerId == CustomerDef.Id.cooneen.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "3106101";
                else
                    entry.COA = "3101280";
            }
            else if (logDef.CustomerId == CustomerDef.Id.forever_new.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "3106101";
                else
                    entry.COA = "3101250";
            }
            else if (logDef.CustomerId == CustomerDef.Id.poetic_brands.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "3106101";
                else
                    entry.COA = "3101240";
            }
            else if (logDef.CustomerId == CustomerDef.Id.difuzed.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "3106101";
                else
                    entry.COA = "3101220";
            }
            else if (logDef.CustomerId == CustomerDef.Id.fabric_flavours.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "3106101";
                else
                    entry.COA = "3101160";
            }
            else if (logDef.CustomerId == CustomerDef.Id.arnold_wills.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "3106101";
                else
                    entry.COA = "3101180";
            }
            else if (logDef.CustomerId == CustomerDef.Id.tvm_fashion.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "3106101";
                else
                    entry.COA = "3101170";
            }
            else if (logDef.CustomerId == CustomerDef.Id.ezibuy.GetHashCode())
                entry.COA = "3106126";
            else if (logDef.CustomerId == CustomerDef.Id.bravado.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "3106101";
                else
                    entry.COA = "3106160";
            }
            else if (logDef.CustomerId == CustomerDef.Id.brand_international.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "3106101";
                else
                    entry.COA = "3101200";
            }
            else if (logDef.CustomerId == CustomerDef.Id.brand_design.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "3106101";
                else
                    entry.COA = "3101230";
            }
            else if (logDef.CustomerId == CustomerDef.Id.brand_alliance.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "3106101";
                else
                    entry.COA = "3101130";
            }
            else if (logDef.CustomerId == CustomerDef.Id.global_licensing.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "3106101";
                else
                    entry.COA = "3106530";
            }
            /*
            else if (logDef.WithOPRFabric == 1 || logDef.WithOPRFabric == 3)
                entry.COA = "1320131";
            */
            else if (logDef.CustomerId == CustomerDef.Id.fashionUK.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "3106101";
                else
                    entry.COA = "3106501";
            }
            else if (logDef.CustomerId == CustomerDef.Id.misirli.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "3106101";
                else
                    entry.COA = "3106540";
            }
            else if (logDef.CustomerId == CustomerDef.Id.smithbrooks.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "3106101";
                else
                    entry.COA = "3106190";
            }
            else if (logDef.CustomerId == CustomerDef.Id.aykroyd_sons.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "3106101";
                else
                    entry.COA = "3101120";
            }
            else if (logDef.CustomerId == CustomerDef.Id.lm_ted_baker.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "3106101";
                else
                    entry.COA = "3201013";
            }
            else if (logDef.CustomerId == CustomerDef.Id.lm_oasis.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "3106101";
                else
                    entry.COA = "3201014";
            }
            else if (logDef.CustomerId == CustomerDef.Id.lm_label_mix.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "3106101";
                else
                    entry.COA = "3201015";
            }
            else if (logDef.CustomerId == CustomerDef.Id.lm_little_bird.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "3106101";
                else
                    entry.COA = "3201016";
            }
            else if (logDef.CustomerId == CustomerDef.Id.lm_myleene_klass.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "3106101";
                else
                    entry.COA = "3201017";
            }
            else if (logDef.CustomerId == CustomerDef.Id.lm_nine.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "3106101";
                else
                    entry.COA = "3201018";
            }
            else if (logDef.CustomerId == CustomerDef.Id.lm_mintie.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "3106101";
                else
                    entry.COA = "3201019";
            }
            else if (logDef.CustomerId == CustomerDef.Id.lm_fat_face.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "3106101";
                else
                    entry.COA = "3201021";
            }
            else if (logDef.CustomerId == CustomerDef.Id.lm_laura_ashley.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "3106101";
                else
                    entry.COA = "3201022";
            }
            else if (logDef.CustomerId == CustomerDef.Id.lm_mint_velvet.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "3106101";
                else
                    entry.COA = "3201024";
            }
            else if (logDef.CustomerId == CustomerDef.Id.lm_hype.GetHashCode())
            {
                if (logDef.IsSampleOrder)
                    entry.COA = "3106101";
                else
                    entry.COA = "3201023";
            }

            else if (logDef.CustomerId == CustomerDef.Id.choice.GetHashCode())
                entry.COA = "3106130";
            else if (logDef.CustomerId == CustomerDef.Id.hempel.GetHashCode() && logDef.CurrencyId == CurrencyId.USD.Id)
                entry.COA = "3106121";
            else if (logDef.CustomerId == CustomerDef.Id.ns_led.GetHashCode() || logDef.CustomerId == CustomerDef.Id.manu_led.GetHashCode())
            {
                /*
                if (commonWorker.getNSLedSelfBilledSupplierCodeList().Contains(contractDef.UKSupplierCode))
                    entry.COA = "3201012";
                else
                    entry.COA = "1210011";
                */
                isDuty = commonWorker.getNSLedSelfBilledSupplierCodeList().Contains(contractDef.UKSupplierCode);
                if (logDef.IsSampleOrder)
                    entry.COA = "3106101";
                else
                    entry.COA = "1210011"; // duty same as non-duty 2021-05-18
            }
            else if (this.isNextLEDOrder(logDef))
                entry.COA = "3201011";
            else
                entry.COA = "3106101";

            if (logDef.TermOfPurchaseId == TermOfPurchaseRef.Id.FOB_UT.GetHashCode())
                entry.COA = "3106121";

            decimal qaAmt = 0;
            decimal discountAmt = 0;
            decimal ltAmt = 0;

            if (logDef.OfficeId == OfficeId.SH.Id || logDef.OfficeId == OfficeId.TH.Id || logDef.OfficeId == OfficeId.HK.Id || logDef.OfficeId == OfficeId.DG.Id || logDef.OfficeId == OfficeId.VN.Id || logDef.OfficeId == OfficeId.CA.Id)
                qaAmt = Math.Round((logDef.QACommissionPercent / 100) * logDef.OtherAmount, 2, MidpointRounding.AwayFromZero);

            if (logDef.OfficeId == OfficeId.BD.Id || logDef.OfficeId == OfficeId.IND.Id || logDef.OfficeId == OfficeId.ND.Id || logDef.OfficeId == OfficeId.PK.Id || logDef.OfficeId == OfficeId.SL.Id || logDef.OfficeId == OfficeId.TR.Id || logDef.OfficeId == OfficeId.EG.Id)
                discountAmt = Math.Round(logDef.OtherAmount * logDef.VendorPaymentDiscountPercent / 100, 2, MidpointRounding.AwayFromZero);

            if (logDef.LabTestIncome > 0)
                ltAmt = Math.Round(logDef.Quantity * logDef.LabTestIncome, 2, MidpointRounding.AwayFromZero);

            entry.COA = generalWorker.getEpicorCOA(entry.COA);
            entry.GroupId = EpicorInterfaceWorker.Instance.APInvoiceInterfaceFile.getSourceString();
            entry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
            entry.ApplyDate = entry.GroupApplyDate;

            if (isEnableWeek53Handling(logDef, isReversal))
            {
                entry.GroupApplyDate = WK53_APPLY_DATE;
                entry.ApplyDate = WK53_APPLY_DATE;
            }

            string itemNo = ProductWorker.Instance.getProductByKey(logDef.ProductId).ItemNo;

            entry.DocumentType = APInvoiceDocumentTypeEnum.ISAM_PURCHASE;
            entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
            entry.Office = getT0Code(logDef);
            entry.SupplierId = vendorWorker.getVendorByKey(logDef.VendorId).EpicorSupplierId;
            if (logDef.CustomerId == CustomerDef.Id.ns_led.GetHashCode() || logDef.CustomerId == CustomerDef.Id.manu_led.GetHashCode())
                entry.LineDescription = logDef.ContractNo + "-" + logDef.DeliveryNo.ToString() + " #" + itemNo + " " + (isDuty ? "DUTY" : "NON-DUTY") + " QTY " + (logDef.Quantity * logDef.PiecesPerPack).ToString();
            else
                entry.LineDescription = logDef.ContractNo + "-" + logDef.DeliveryNo.ToString() + " #" + itemNo;
            entry.Currency = CurrencyId.getCommonName(logDef.CurrencyId);
            entry.UnitCost = logDef.OtherAmount;
            entry.Amount = logDef.OtherAmount - qaAmt - ltAmt - discountAmt;
            entry.Qty = logDef.Quantity * logDef.PiecesPerPack;
            entry.ItemNo = itemNo;
            entry.PaymentTerm = logDef.PaymentTermId == PaymentTermRef.eTerm.OPENACCOUNT.GetHashCode() ? "IN14" : "IN30";
            entry.SegmentValue3 = getT1Code(logDef);
            entry.SegmentValue4 = generalWorker.getProductCodeDefByKey(logDef.ProductTeamId).Code;
            entry.SegmentValue5 = getSeasonSegmentValue(logDef.SeasonId);
            entry.RealInvoiceNo = (logDef.SupplierInvoiceNo.StartsWith("MISSING") && logDef.SupplierInvoiceNo.Length == 12) ? string.Empty : logDef.SupplierInvoiceNo;

            if (logDef.DebitCreditNoteNo != string.Empty)
                logDef.SupplierInvoiceNo = logDef.DebitCreditNoteNo;

            entry.InvoiceDate = logDef.TransactionDate;

            string reverseSuffix = getReversalSuffix(logDef.SunInterfaceLogId);

            if (isReversal)
            {
                entry.DocumentType = APInvoiceDocumentTypeEnum.ISAM_RELEASE_LOCK;
                entry.InvoiceNo = logDef.SupplierInvoiceNo.Trim() + (reverseSuffix != string.Empty ? "-" + reverseSuffix : string.Empty) + "D";
                entry.LegalNumber = getT9Code(logDef) + "P" + splitSuffix + (reverseSuffix != string.Empty ? "-" + reverseSuffix : string.Empty) + "D";
                entry.RealLegalNumber = getT9Code(logDef) + "P" + splitSuffix + (reverseSuffix != string.Empty ? "-" + reverseSuffix : string.Empty);
                entry.IsDebitNote = true;
                if (logDef.TermOfPurchaseId == TermOfPurchaseRef.Id.FOB_UT.GetHashCode())
                    entry.ExchangeRate = Math.Round(logDef.UTTotalShippedSupplierGmtAmount / logDef.OtherAmount, 10, MidpointRounding.AwayFromZero);
                else
                    entry.ExchangeRate = Math.Round(logDef.BaseAmount / logDef.OtherAmount, 10, MidpointRounding.AwayFromZero);
            }
            else
            {
                string suffix = (logDef.CategoryId == CategoryType.REVERSAL.Id ? "-" + reverseSuffix : string.Empty);
                entry.InvoiceNo = logDef.SupplierInvoiceNo + (logDef.CategoryId == CategoryType.REVERSAL.Id ? "-" + reverseSuffix : string.Empty);
                entry.LegalNumber = getT9Code(logDef) + "P" + splitSuffix + (logDef.CategoryId == CategoryType.REVERSAL.Id ? "-" + reverseSuffix : string.Empty);
            }

            if (entry.InvoiceNo.Length > 20)
                entry.InvoiceNo = (entry.InvoiceNo.Substring(0, 17) + entry.InvoiceNo.Substring(entry.InvoiceNo.Length - 3, 3));

            entry.IsRecordComplete = false;

            string purchaseCOA = entry.COA;
            /*
            if (((t0 == "THV2" && logDef.OfficeId == OfficeId.VN.Id)) && logDef.CurrencyId == CurrencyId.GBP.Id)
            {
                entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, OfficeId.TH.Id).EpicorCompanyId;
                entry.Office = "HK1F";
                entry.IsMultiCompany = true;
                entry.ExternalCompany = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
                entry.ExternalCOA = entry.COA;
                entry.ExternalSegmentValue3 = entry.SegmentValue3;
                entry.ExternalSegmentValue4 = entry.SegmentValue4;
                entry.ExternalSegmentValue5 = entry.SegmentValue5;
                entry.SegmentValue3 = string.Empty;
                entry.SegmentValue4 = string.Empty;
                entry.SegmentValue5 = string.Empty;
                entry.COA = "1302013";
            }
            */

            /*
            if (t0 == "THV2" && logDef.OfficeId == OfficeId.VN.Id && logDef.CurrencyId == CurrencyId.GBP.Id)
            {
                entry.Office = "HK1F";
                entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, OfficeId.HK.Id).EpicorCompanyId;
                entry.COA = "1302013";
            }
            */
            if (t0 == "CA1F" && logDef.OfficeId == OfficeId.CA.Id && logDef.CurrencyId == CurrencyId.GBP.Id)
            {
                entry.Office = "HK1F";
                entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, OfficeId.HK.Id).EpicorCompanyId;
                entry.COA = "1302010";
            }
            else
                entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;

            coreEntry = entry;

            if (qaAmt > 0)
            {
                qaAmt = Math.Round((logDef.QACommissionPercent / 100) * logDef.OtherAmount, 2, MidpointRounding.AwayFromZero);

                entry = (APInvoiceInterfaceEntry)entry.Clone();
                entry.UnitCost = qaAmt * -1;
                /*
                if ((t0 == "THV2" && logDef.OfficeId == OfficeId.VN.Id) && logDef.CurrencyId == CurrencyId.GBP.Id)
                    //entry.ExternalCOA = generalWorker.getEpicorCOA("2102111");
                    entry.COA = "1302013";
                */
                if ((t0 == "CA1F" && logDef.OfficeId == OfficeId.CA.Id) && logDef.CurrencyId == CurrencyId.GBP.Id)
                    entry.COA = "1302010";
                else if (logDef.CustomerId == CustomerDef.Id.lm_ted_baker.GetHashCode())
                    entry.COA = "2511014";
                else if (logDef.CustomerId == CustomerDef.Id.lm_oasis.GetHashCode())
                    entry.COA = "2511015";
                else if (logDef.CustomerId == CustomerDef.Id.lm_label_mix.GetHashCode())
                    entry.COA = "2511016";
                else if (logDef.CustomerId == CustomerDef.Id.lm_little_bird.GetHashCode())
                    entry.COA = "2511017";
                else if (logDef.CustomerId == CustomerDef.Id.lm_myleene_klass.GetHashCode())
                    entry.COA = "2511018";
                else if (logDef.CustomerId == CustomerDef.Id.lm_nine.GetHashCode())
                    entry.COA = "2511019";
                else if (logDef.CustomerId == CustomerDef.Id.lm_mintie.GetHashCode())
                    entry.COA = "2511020";
                else if (logDef.CustomerId == CustomerDef.Id.lm_fat_face.GetHashCode())
                    entry.COA = "2511021";
                else if (logDef.CustomerId == CustomerDef.Id.lm_laura_ashley.GetHashCode())
                    entry.COA = "2511022";
                else if (logDef.CustomerId == CustomerDef.Id.lm_mint_velvet.GetHashCode())
                    entry.COA = "2511024";
                else if (logDef.CustomerId == CustomerDef.Id.lm_hype.GetHashCode())
                    entry.COA = "2511023";

                else if (logDef.CustomerId == CustomerDef.Id.ns_led.GetHashCode() || logDef.CustomerId == CustomerDef.Id.manu_led.GetHashCode())
                {
                    /*
                    if (commonWorker.getNSLedSelfBilledSupplierCodeList().Contains(contractDef.UKSupplierCode))
                        entry.COA = "2511013";
                    else
                        entry.COA = "1452044";
                    */
                    if (logDef.IsSampleOrder)
                        entry.COA = generalWorker.getEpicorCOA("2102111");
                    else
                        entry.COA = "1452044"; // duty same as non-duty 2021-05-18
                }
                else
                    entry.COA = generalWorker.getEpicorCOA("2102111");
                /*
                entry.LineDescription = "QA comm " + getT9Code(logDef);
                if (isReversal)
                    entry.ExchangeRate = Math.Round(Math.Round((logDef.QACommissionPercent / 100) * logDef.BaseAmount, 2, MidpointRounding.AwayFromZero) / qaAmt, 10, MidpointRounding.AwayFromZero);
                */
                EpicorInterfaceWorker.Instance.APInvoiceInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);
            }

            if (discountAmt > 0)
            {
                // TODO: 20160727 BD Armana Group Special Handling 4% Vendor Payment Discount, of which 1% goes to Provision

                if (logDef.OfficeId == OfficeId.BD.Id && logDef.VendorPaymentDiscountPercent == 4 && (shipmentDef.Vendor.VendorId == 7000 || shipmentDef.Vendor.VendorId == 10592 || shipmentDef.Vendor.VendorId == 8056 || shipmentDef.Vendor.VendorId == 8055))
                {
                    decimal totalPaymentDiscountAmt = Math.Round(logDef.OtherAmount * (logDef.VendorPaymentDiscountPercent) / 100, 2, MidpointRounding.AwayFromZero);

                    discountAmt = Math.Round(logDef.OtherAmount * (logDef.VendorPaymentDiscountPercent - 1) / 100, 2, MidpointRounding.AwayFromZero);

                    entry = (APInvoiceInterfaceEntry)entry.Clone();
                    /*
                    entry.UnitCost = Math.Round(logDef.OtherAmount * 1 / 100, 2, MidpointRounding.AwayFromZero) * -1;
                    */
                    entry.UnitCost = (totalPaymentDiscountAmt - discountAmt) * -1;
                    entry.COA = generalWorker.getEpicorCOA("1452029");
                    entry.LineDescription = "add 1% for claim recovery";
                    entry.SegmentValue7 = "AR";
                    entry.SegmentValue8 = "S";
                    EpicorInterfaceWorker.Instance.APInvoiceInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);

                }
                else
                    discountAmt = Math.Round(logDef.OtherAmount * logDef.VendorPaymentDiscountPercent / 100, 2, MidpointRounding.AwayFromZero);

                entry = (APInvoiceInterfaceEntry)entry.Clone();
                if (logDef.CustomerId == CustomerDef.Id.ns_led.GetHashCode() || logDef.CustomerId == CustomerDef.Id.manu_led.GetHashCode())
                    entry.LineDescription = logDef.ContractNo + "-" + logDef.DeliveryNo.ToString() + " #" + itemNo + " " + (isDuty ? "DUTY" : "NON-DUTY") + " QTY " + (logDef.Quantity * logDef.PiecesPerPack).ToString();
                else
                    entry.LineDescription = logDef.ContractNo + "-" + logDef.DeliveryNo.ToString() + " #" + itemNo;

                entry.SegmentValue7 = string.Empty;
                entry.SegmentValue8 = string.Empty;

                entry.UnitCost = discountAmt * -1;
                /*
                if ((t0 == "THV2" && logDef.OfficeId == OfficeId.VN.Id) && logDef.CurrencyId == CurrencyId.GBP.Id)
                    //entry.ExternalCOA = generalWorker.getEpicorCOA("2102301");
                    entry.COA = "1302013";
                */
                if ((t0 == "CA1F" && logDef.OfficeId == OfficeId.CA.Id) && logDef.CurrencyId == CurrencyId.GBP.Id)
                    entry.COA = "1302010";
                else if (logDef.CustomerId == CustomerDef.Id.lm_ted_baker.GetHashCode())
                    entry.COA = "2515040";
                else if (logDef.CustomerId == CustomerDef.Id.lm_oasis.GetHashCode())
                    entry.COA = "2515041";
                else if (logDef.CustomerId == CustomerDef.Id.lm_label_mix.GetHashCode())
                    entry.COA = "2515042";
                else if (logDef.CustomerId == CustomerDef.Id.lm_little_bird.GetHashCode())
                    entry.COA = "2515043";
                else if (logDef.CustomerId == CustomerDef.Id.lm_myleene_klass.GetHashCode())
                    entry.COA = "2515044";
                else if (logDef.CustomerId == CustomerDef.Id.lm_nine.GetHashCode())
                    entry.COA = "2515045";
                else if (logDef.CustomerId == CustomerDef.Id.lm_mintie.GetHashCode())
                    entry.COA = "2515046";
                else if (logDef.CustomerId == CustomerDef.Id.lm_fat_face.GetHashCode())
                    entry.COA = "2515047";
                else if (logDef.CustomerId == CustomerDef.Id.lm_laura_ashley.GetHashCode())
                    entry.COA = "2515048";
                else if (logDef.CustomerId == CustomerDef.Id.lm_mint_velvet.GetHashCode())
                    entry.COA = "2515050";
                else if (logDef.CustomerId == CustomerDef.Id.lm_hype.GetHashCode())
                    entry.COA = "2515049";

                else if (logDef.CustomerId == CustomerDef.Id.ns_led.GetHashCode() || logDef.CustomerId == CustomerDef.Id.manu_led.GetHashCode())
                {
                    /*
                    if (commonWorker.getNSLedSelfBilledSupplierCodeList().Contains(contractDef.UKSupplierCode))
                        entry.COA = "2515030";
                    else
                        entry.COA = "1452039";
                    */
                    if (logDef.IsSampleOrder)
                        entry.COA = generalWorker.getEpicorCOA("2102301");
                    else
                        entry.COA = "1452039"; // duty same as non-duty 2021-05-18
                }
                else if (logDef.OfficeId == OfficeId.TR.Id || logDef.OfficeId == OfficeId.EG.Id || logDef.OfficeId == OfficeId.PK.Id || logDef.OfficeId == OfficeId.SL.Id || logDef.OfficeId == OfficeId.MA.Id)
                    entry.COA = generalWorker.getEpicorCOA("2102301");
                else
                    entry.COA = generalWorker.getEpicorCOA("2102301");

                /*
                entry.LineDescription = "Vendor Discount " + getT9Code(logDef);
                if (isReversal)
                    entry.ExchangeRate = Math.Round(Math.Round(logDef.BaseAmount * logDef.VendorPaymentDiscountPercent / 100, 2, MidpointRounding.AwayFromZero) / discountAmt, 10, MidpointRounding.AwayFromZero);
                */

                EpicorInterfaceWorker.Instance.APInvoiceInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);
            }

            if (ltAmt > 0)
            {
                entry = (APInvoiceInterfaceEntry)entry.Clone();
                entry.UnitCost = ltAmt * -1;
                /*
                if ((t0 == "THV2" && logDef.OfficeId == OfficeId.VN.Id) && logDef.CurrencyId == CurrencyId.GBP.Id)
                    //entry.ExternalCOA = generalWorker.getEpicorCOA("2102114");
                    entry.COA = "1302013";
                */
                if ((t0 == "CA1F" && logDef.OfficeId == OfficeId.CA.Id) && logDef.CurrencyId == CurrencyId.GBP.Id)
                    entry.COA = "1302010";
                else if (logDef.CustomerId == CustomerDef.Id.lm_ted_baker.GetHashCode())
                    entry.COA = "2510040";
                else if (logDef.CustomerId == CustomerDef.Id.lm_oasis.GetHashCode())
                    entry.COA = "2510041";
                else if (logDef.CustomerId == CustomerDef.Id.lm_label_mix.GetHashCode())
                    entry.COA = "2510042";
                else if (logDef.CustomerId == CustomerDef.Id.lm_little_bird.GetHashCode())
                    entry.COA = "2510043";
                else if (logDef.CustomerId == CustomerDef.Id.lm_myleene_klass.GetHashCode())
                    entry.COA = "2510044";
                else if (logDef.CustomerId == CustomerDef.Id.lm_nine.GetHashCode())
                    entry.COA = "2510045";
                else if (logDef.CustomerId == CustomerDef.Id.lm_mintie.GetHashCode())
                    entry.COA = "2510046";
                else if (logDef.CustomerId == CustomerDef.Id.lm_fat_face.GetHashCode())
                    entry.COA = "2510047";
                else if (logDef.CustomerId == CustomerDef.Id.lm_laura_ashley.GetHashCode())
                    entry.COA = "2510048";
                else if (logDef.CustomerId == CustomerDef.Id.lm_mint_velvet.GetHashCode())
                    entry.COA = "2510050";
                else if (logDef.CustomerId == CustomerDef.Id.lm_hype.GetHashCode())
                    entry.COA = "2510049";

                else if (logDef.CustomerId == CustomerDef.Id.ns_led.GetHashCode() || logDef.CustomerId == CustomerDef.Id.manu_led.GetHashCode())
                {
                    /*
                    if (commonWorker.getNSLedSelfBilledSupplierCodeList().Contains(contractDef.UKSupplierCode))
                        entry.COA = "2510030";
                    else
                        entry.COA = "1452043";
                    */
                    if (logDef.IsSampleOrder)
                        entry.COA = generalWorker.getEpicorCOA("2102114");
                    else
                        entry.COA = "1452043"; // duty same as non-duty 2021-05-18
                }
                else
                    entry.COA = generalWorker.getEpicorCOA("2102114");
                /*
                entry.LineDescription = "LAB TEST FOR P" + logDef.Period.ToString();
                
                if (isReversal)
                    entry.ExchangeRate = Math.Round(Math.Round(ltAmt * commonWorker.getExchangeRate(ExchangeRateType.INVOICE, logDef.CurrencyId, logDef.TransactionDate) / commonWorker.getExchangeRate(ExchangeRateType.INVOICE, CurrencyId.USD.Id, logDef.TransactionDate), 2, MidpointRounding.AwayFromZero) / ltAmt, 10, MidpointRounding.AwayFromZero);
                */
                EpicorInterfaceWorker.Instance.APInvoiceInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);
            }

            if (!isReversal) coreEntry.IsRecordComplete = true;
            EpicorInterfaceWorker.Instance.APInvoiceInterfaceFile.Entries.Add((IEpicorInterfaceEntry)coreEntry);

            GLInterfaceEntry glEntry = new GLInterfaceEntry();
            /*
            if (t0 == "THV2" && logDef.OfficeId == OfficeId.VN.Id && logDef.CurrencyId == CurrencyId.GBP.Id)
            {
                glEntry = new GLInterfaceEntry();
                glEntry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, OfficeId.VN.Id).EpicorCompanyId;
                glEntry.GroupId = EpicorInterfaceWorker.Instance.GLInterfaceFile.getSourceString();
                glEntry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                glEntry.ApplyDate = glEntry.GroupApplyDate;

                if (isEnableWeek53Handling(logDef, isReversal))
                {
                    glEntry.GroupApplyDate = WK53_APPLY_DATE;
                    glEntry.ApplyDate = WK53_APPLY_DATE;
                }

                glEntry.DocumentType = GLDocumentTypeEnum.GL;
                glEntry.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
                glEntry.DC = !isReversal ? DCFlag.Credit : DCFlag.Debit;
                glEntry.Qty = logDef.Quantity * logDef.PiecesPerPack;
                glEntry.Amount = logDef.OtherAmount;
                glEntry.BaseAmount = logDef.BaseAmount;
                glEntry.LineDescription = logDef.ContractNo + "-" + logDef.DeliveryNo.ToString();
                glEntry.Office = "THV2";
                glEntry.COA = "1302013";
                glEntry.IsRecordComplete = false;
                glEntry.SegmentValue3 = getT1Code(logDef);
                glEntry.SegmentValue4 = generalWorker.getProductCodeDefByKey(logDef.ProductTeamId).Code;
                glEntry.SegmentValue5 = getSeasonSegmentValue(logDef.SeasonId);
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                glEntry = (GLInterfaceEntry)glEntry.Clone();
                glEntry.DC = !isReversal ? DCFlag.Debit : DCFlag.Credit;
                glEntry.COA = purchaseCOA;
                glEntry.IsRecordComplete = true;
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                if (qaAmt > 0)
                {
                    glEntry = (GLInterfaceEntry)glEntry.Clone();
                    glEntry.DC = !isReversal ? DCFlag.Debit : DCFlag.Credit;
                    glEntry.COA = "1302013";
                    glEntry.Amount = Math.Round((logDef.QACommissionPercent / 100) * logDef.OtherAmount, 2, MidpointRounding.AwayFromZero);
                    glEntry.BaseAmount = Math.Round(glEntry.Amount * commonWorker.getExchangeRate(ExchangeRateType.INVOICE, logDef.CurrencyId, logDef.TransactionDate) / commonWorker.getExchangeRate(ExchangeRateType.INVOICE, CurrencyId.USD.Id, logDef.TransactionDate), 2, MidpointRounding.AwayFromZero);
                    glEntry.IsRecordComplete = false;
                    EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                    glEntry = (GLInterfaceEntry)glEntry.Clone();
                    glEntry.DC = !isReversal ? DCFlag.Credit :DCFlag.Debit;
                    if (logDef.CustomerId == CustomerDef.Id.ns_led.GetHashCode())
                        entry.COA = "1452044";
                    else
                        glEntry.COA = generalWorker.getEpicorCOA("2102111");
                    glEntry.IsRecordComplete = true;
                    EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);
                }


                if (discountAmt > 0)
                {
                    glEntry = (GLInterfaceEntry)glEntry.Clone();
                    glEntry.DC = !isReversal ? DCFlag.Debit : DCFlag.Credit;
                    glEntry.COA = "1302013";
                    glEntry.Amount = Math.Round(logDef.OtherAmount * logDef.VendorPaymentDiscountPercent / 100, 2, MidpointRounding.AwayFromZero);
                    glEntry.BaseAmount = Math.Round(glEntry.Amount * commonWorker.getExchangeRate(ExchangeRateType.INVOICE, logDef.CurrencyId, logDef.TransactionDate) / commonWorker.getExchangeRate(ExchangeRateType.INVOICE, CurrencyId.USD.Id, logDef.TransactionDate), 2, MidpointRounding.AwayFromZero);
                    glEntry.IsRecordComplete = false;
                    EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                    glEntry = (GLInterfaceEntry)glEntry.Clone();
                    glEntry.DC = !isReversal ? DCFlag.Credit : DCFlag.Debit;
                    if (logDef.CustomerId == CustomerDef.Id.ns_led.GetHashCode())
                        entry.COA = "1452039";
                    else
                        glEntry.COA = generalWorker.getEpicorCOA("2102301");
                    glEntry.IsRecordComplete = true;
                    EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);
                }

                if (ltAmt > 0)
                {
                    glEntry = (GLInterfaceEntry)glEntry.Clone();
                    glEntry.DC = !isReversal ? DCFlag.Debit : DCFlag.Credit;
                    glEntry.COA = "1302013";
                    glEntry.Amount = ltAmt;
                    glEntry.BaseAmount = Math.Round(glEntry.Amount * commonWorker.getExchangeRate(ExchangeRateType.INVOICE, logDef.CurrencyId, logDef.TransactionDate) / commonWorker.getExchangeRate(ExchangeRateType.INVOICE, CurrencyId.USD.Id, logDef.TransactionDate), 2, MidpointRounding.AwayFromZero);
                    glEntry.IsRecordComplete = false;
                    EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                    glEntry = (GLInterfaceEntry)glEntry.Clone();
                    glEntry.DC = !isReversal ? DCFlag.Credit :DCFlag.Debit;
                    if (logDef.CustomerId == CustomerDef.Id.ns_led.GetHashCode())
                        entry.COA = "1452043";
                    else
                        glEntry.COA = generalWorker.getEpicorCOA("2102114");
                    glEntry.IsRecordComplete = true;
                    EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);
                }
            }
            */
            if (t0 == "CA1F" && logDef.OfficeId == OfficeId.CA.Id && logDef.CurrencyId == CurrencyId.GBP.Id)
            {
                glEntry = new GLInterfaceEntry();
                glEntry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, OfficeId.CA.Id).EpicorCompanyId;
                glEntry.GroupId = EpicorInterfaceWorker.Instance.GLInterfaceFile.getSourceString();
                glEntry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                glEntry.ApplyDate = glEntry.GroupApplyDate;

                if (isEnableWeek53Handling(logDef, isReversal))
                {
                    glEntry.GroupApplyDate = WK53_APPLY_DATE;
                    glEntry.ApplyDate = WK53_APPLY_DATE;
                }

                glEntry.DocumentType = GLDocumentTypeEnum.GL;
                glEntry.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
                glEntry.DC = !isReversal ? DCFlag.Credit : DCFlag.Debit;
                glEntry.Qty = logDef.Quantity * logDef.PiecesPerPack;
                glEntry.Amount = logDef.OtherAmount;
                glEntry.BaseAmount = logDef.BaseAmount;
                if (logDef.CustomerId == CustomerDef.Id.ns_led.GetHashCode() || logDef.CustomerId == CustomerDef.Id.manu_led.GetHashCode())
                    glEntry.LineDescription = logDef.ContractNo + "-" + logDef.DeliveryNo.ToString() + " #" + itemNo + " " + (isDuty ? "DUTY" : "NON-DUTY") + " QTY " + (logDef.Quantity * logDef.PiecesPerPack).ToString();
                else
                    glEntry.LineDescription = logDef.ContractNo + "-" + logDef.DeliveryNo.ToString() + " #" + itemNo;

                //glEntry.LineDescription = logDef.ContractNo + "-" + logDef.DeliveryNo.ToString();
                glEntry.Office = "CA1F";
                glEntry.COA = "1302010";
                glEntry.IsRecordComplete = false;
                glEntry.SegmentValue3 = getT1Code(logDef);
                glEntry.SegmentValue4 = generalWorker.getProductCodeDefByKey(logDef.ProductTeamId).Code;
                glEntry.SegmentValue5 = getSeasonSegmentValue(logDef.SeasonId);
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                glEntry = (GLInterfaceEntry)glEntry.Clone();
                glEntry.DC = !isReversal ? DCFlag.Debit : DCFlag.Credit;
                glEntry.COA = purchaseCOA;
                glEntry.IsRecordComplete = true;
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                if (qaAmt > 0)
                {
                    glEntry = (GLInterfaceEntry)glEntry.Clone();
                    glEntry.DC = !isReversal ? DCFlag.Debit : DCFlag.Credit;
                    glEntry.COA = "1302010";
                    glEntry.Amount = Math.Round((logDef.QACommissionPercent / 100) * logDef.OtherAmount, 2, MidpointRounding.AwayFromZero);
                    glEntry.BaseAmount = Math.Round(glEntry.Amount * commonWorker.getExchangeRate(ExchangeRateType.INVOICE, logDef.CurrencyId, logDef.TransactionDate) / commonWorker.getExchangeRate(ExchangeRateType.INVOICE, CurrencyId.USD.Id, logDef.TransactionDate), 2, MidpointRounding.AwayFromZero);
                    glEntry.IsRecordComplete = false;
                    EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                    glEntry = (GLInterfaceEntry)glEntry.Clone();
                    glEntry.DC = !isReversal ? DCFlag.Credit : DCFlag.Debit;

                    if (logDef.CustomerId == CustomerDef.Id.lm_ted_baker.GetHashCode())
                        entry.COA = "2511014";
                    else if (logDef.CustomerId == CustomerDef.Id.lm_oasis.GetHashCode())
                        entry.COA = "2511015";
                    else if (logDef.CustomerId == CustomerDef.Id.lm_label_mix.GetHashCode())
                        entry.COA = "2511016";
                    else if (logDef.CustomerId == CustomerDef.Id.lm_little_bird.GetHashCode())
                        entry.COA = "2511017";
                    else if (logDef.CustomerId == CustomerDef.Id.lm_myleene_klass.GetHashCode())
                        entry.COA = "2511018";
                    else if (logDef.CustomerId == CustomerDef.Id.lm_nine.GetHashCode())
                        entry.COA = "2511019";
                    else if (logDef.CustomerId == CustomerDef.Id.lm_mintie.GetHashCode())
                        entry.COA = "2511020";
                    else if (logDef.CustomerId == CustomerDef.Id.lm_fat_face.GetHashCode())
                        entry.COA = "2511021";
                    else if (logDef.CustomerId == CustomerDef.Id.lm_laura_ashley.GetHashCode())
                        entry.COA = "2511022";
                    else if (logDef.CustomerId == CustomerDef.Id.lm_mint_velvet.GetHashCode())
                        entry.COA = "2511024";
                    else if (logDef.CustomerId == CustomerDef.Id.lm_hype.GetHashCode())
                        entry.COA = "2511023";

                    else if (logDef.CustomerId == CustomerDef.Id.ns_led.GetHashCode() || logDef.CustomerId == CustomerDef.Id.manu_led.GetHashCode())
                    {
                        /*
                        if (commonWorker.getNSLedSelfBilledSupplierCodeList().Contains(contractDef.UKSupplierCode))
                            entry.COA = "2511013";
                        else
                            entry.COA = "1452044";
                        */
                        if (logDef.IsSampleOrder)
                            entry.COA = generalWorker.getEpicorCOA("2102111");
                        else
                            entry.COA = "1452044"; // duty same as non-duty 2021-05-18
                    }
                    else
                        glEntry.COA = generalWorker.getEpicorCOA("2102111");
                    glEntry.IsRecordComplete = true;
                    EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);
                }


                if (discountAmt > 0)
                {
                    glEntry = (GLInterfaceEntry)glEntry.Clone();
                    glEntry.DC = !isReversal ? DCFlag.Debit : DCFlag.Credit;
                    glEntry.COA = "1302010";
                    glEntry.Amount = Math.Round(logDef.OtherAmount * logDef.VendorPaymentDiscountPercent / 100, 2, MidpointRounding.AwayFromZero);
                    glEntry.BaseAmount = Math.Round(glEntry.Amount * commonWorker.getExchangeRate(ExchangeRateType.INVOICE, logDef.CurrencyId, logDef.TransactionDate) / commonWorker.getExchangeRate(ExchangeRateType.INVOICE, CurrencyId.USD.Id, logDef.TransactionDate), 2, MidpointRounding.AwayFromZero);
                    glEntry.IsRecordComplete = false;
                    EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                    glEntry = (GLInterfaceEntry)glEntry.Clone();
                    glEntry.DC = !isReversal ? DCFlag.Credit : DCFlag.Debit;
                    if (logDef.CustomerId == CustomerDef.Id.lm_ted_baker.GetHashCode())
                        entry.COA = "2515040";
                    else if (logDef.CustomerId == CustomerDef.Id.lm_oasis.GetHashCode())
                        entry.COA = "2515041";
                    else if (logDef.CustomerId == CustomerDef.Id.lm_label_mix.GetHashCode())
                        entry.COA = "2515042";
                    else if (logDef.CustomerId == CustomerDef.Id.lm_little_bird.GetHashCode())
                        entry.COA = "2515043";
                    else if (logDef.CustomerId == CustomerDef.Id.lm_myleene_klass.GetHashCode())
                        entry.COA = "2515044";
                    else if (logDef.CustomerId == CustomerDef.Id.lm_nine.GetHashCode())
                        entry.COA = "2515045";
                    else if (logDef.CustomerId == CustomerDef.Id.lm_mintie.GetHashCode())
                        entry.COA = "2515046";
                    else if (logDef.CustomerId == CustomerDef.Id.lm_fat_face.GetHashCode())
                        entry.COA = "2515047";
                    else if (logDef.CustomerId == CustomerDef.Id.lm_laura_ashley.GetHashCode())
                        entry.COA = "2515048";
                    else if (logDef.CustomerId == CustomerDef.Id.lm_mint_velvet.GetHashCode())
                        entry.COA = "2515050";
                    else if (logDef.CustomerId == CustomerDef.Id.lm_hype.GetHashCode())
                        entry.COA = "2515049";

                    else if (logDef.CustomerId == CustomerDef.Id.ns_led.GetHashCode() || logDef.CustomerId == CustomerDef.Id.manu_led.GetHashCode())
                    {
                        /*
                        if (commonWorker.getNSLedSelfBilledSupplierCodeList().Contains(contractDef.UKSupplierCode))
                            entry.COA = "2515030";
                        else
                            entry.COA = "1452039";
                        */
                        if (logDef.IsSampleOrder)
                            entry.COA = generalWorker.getEpicorCOA("2102301");
                        else
                            entry.COA = "1452039"; // duty same as non-duty 2021-05-18
                    }
                    else
                        glEntry.COA = generalWorker.getEpicorCOA("2102301");
                    glEntry.IsRecordComplete = true;
                    EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);
                }

                if (ltAmt > 0)
                {
                    glEntry = (GLInterfaceEntry)glEntry.Clone();
                    glEntry.DC = !isReversal ? DCFlag.Debit : DCFlag.Credit;
                    glEntry.COA = "1302010";
                    glEntry.Amount = ltAmt;
                    glEntry.BaseAmount = Math.Round(glEntry.Amount * commonWorker.getExchangeRate(ExchangeRateType.INVOICE, logDef.CurrencyId, logDef.TransactionDate) / commonWorker.getExchangeRate(ExchangeRateType.INVOICE, CurrencyId.USD.Id, logDef.TransactionDate), 2, MidpointRounding.AwayFromZero);
                    glEntry.IsRecordComplete = false;
                    EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                    glEntry = (GLInterfaceEntry)glEntry.Clone();
                    glEntry.DC = !isReversal ? DCFlag.Credit : DCFlag.Debit;
                    if (logDef.CustomerId == CustomerDef.Id.lm_ted_baker.GetHashCode())
                        entry.COA = "2510040";
                    else if (logDef.CustomerId == CustomerDef.Id.lm_oasis.GetHashCode())
                        entry.COA = "2510041";
                    else if (logDef.CustomerId == CustomerDef.Id.lm_label_mix.GetHashCode())
                        entry.COA = "2510042";
                    else if (logDef.CustomerId == CustomerDef.Id.lm_little_bird.GetHashCode())
                        entry.COA = "2510043";
                    else if (logDef.CustomerId == CustomerDef.Id.lm_myleene_klass.GetHashCode())
                        entry.COA = "2510044";
                    else if (logDef.CustomerId == CustomerDef.Id.lm_nine.GetHashCode())
                        entry.COA = "2510045";
                    else if (logDef.CustomerId == CustomerDef.Id.lm_mintie.GetHashCode())
                        entry.COA = "2510046";
                    else if (logDef.CustomerId == CustomerDef.Id.lm_fat_face.GetHashCode())
                        entry.COA = "2510047";
                    else if (logDef.CustomerId == CustomerDef.Id.lm_laura_ashley.GetHashCode())
                        entry.COA = "2510048";
                    else if (logDef.CustomerId == CustomerDef.Id.lm_mint_velvet.GetHashCode())
                        entry.COA = "2510050";
                    else if (logDef.CustomerId == CustomerDef.Id.lm_hype.GetHashCode())
                        entry.COA = "2510049";

                    else if (logDef.CustomerId == CustomerDef.Id.ns_led.GetHashCode() || logDef.CustomerId == CustomerDef.Id.manu_led.GetHashCode())
                    {
                        /*
                        if (commonWorker.getNSLedSelfBilledSupplierCodeList().Contains(contractDef.UKSupplierCode))
                            entry.COA = "2510030";
                        else
                            entry.COA = "1452043";
                        */
                        if (logDef.IsSampleOrder)
                            entry.COA = generalWorker.getEpicorCOA("2102114");
                        else
                            entry.COA = "1452043"; // duty same as non-duty 2021-05-18
                    }
                    else
                        glEntry.COA = generalWorker.getEpicorCOA("2102114");
                    glEntry.IsRecordComplete = true;
                    EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);
                }
            }

            /* should be placed in actual ns-led sales for non-duty
            if (logDef.CustomerId == CustomerDef.Id.ns_led.GetHashCode() && !commonWorker.getNSLedSelfBilledSupplierCodeList().Contains(contractDef.UKSupplierCode))
            {
                string itemNo = ProductWorker.Instance.getProductByKey(logDef.ProductId).ItemNo;
                NSLedRangePlanDef rangePlanDef = this.getNSLedRangePlan(logDef.OfficeId, entry.ItemNo);

                AccountFinancialCalenderDef calDef = GeneralWorker.Instance.getAccountPeriodByYearPeriod(AppId.NSS.Code, logDef.FiscalYear, logDef.Period);

                glEntry = new GLInterfaceEntry();
                glEntry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
                glEntry.GroupId = EpicorInterfaceWorker.Instance.GLInterfaceFile.getSourceString();
                glEntry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                glEntry.ApplyDate = glEntry.GroupApplyDate;

                if (isEnableWeek53Handling(logDef, false))
                {
                    glEntry.GroupApplyDate = WK53_APPLY_DATE;
                    glEntry.ApplyDate = WK53_APPLY_DATE;
                }

                glEntry.DocumentType = GLDocumentTypeEnum.GL;
                glEntry.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
                glEntry.DC = DCFlag.Debit;
                glEntry.Qty = logDef.Quantity;
                glEntry.Amount = Math.Round(rangePlanDef.TotalFOBCost / rangePlanDef.TotalQty * logDef.Quantity, 2, MidpointRounding.AwayFromZero);
                glEntry.BaseAmount = Math.Round(glEntry.Amount
                                                * commonWorker.getExchangeRate(ExchangeRateType.INVOICE, rangePlanDef.SupplierCurrencyId, calDef.EndDate)
                                                / commonWorker.getExchangeRate(ExchangeRateType.INVOICE, CurrencyId.USD.Id, calDef.EndDate)
                                    , 2, MidpointRounding.AwayFromZero);

                glEntry.LineDescription = itemNo + "#" + contractDef.ContractNo + "-" + shipmentDef.DeliveryNo.ToString() + " " + logDef.FiscalYear.ToString();
                glEntry.Office = getT0Code(logDef);
                if (logDef.OfficeId == OfficeId.SH.Id)
                {
                    glEntry.Office = "SHMY";
                }
                else if (logDef.OfficeId == OfficeId.HK.Id)
                {
                    glEntry.Office = "HKMY";
                }
                glEntry.COA = "3201012";
                glEntry.SegmentValue3 = getT1Code(logDef);
                glEntry.SegmentValue4 = generalWorker.getProductCodeDefByKey(contractDef.ProductTeam.ProductCodeId).Code;
                glEntry.SegmentValue5 = getSeasonSegmentValue(contractDef.Season.SeasonId);
                glEntry.IsRecordComplete = false;
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                glEntry = (GLInterfaceEntry)glEntry.Clone();
                glEntry.DC = DCFlag.Credit;
                glEntry.COA = "1210011";
                glEntry.IsRecordComplete = true;
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);


                glEntry = (GLInterfaceEntry)glEntry.Clone();
                glEntry.DC = DCFlag.Debit;

                if (logDef.OfficeId == OfficeId.SH.Id || logDef.OfficeId == OfficeId.TH.Id || logDef.OfficeId == OfficeId.HK.Id || logDef.OfficeId == OfficeId.DG.Id || logDef.OfficeId == OfficeId.VN.Id || logDef.OfficeId == OfficeId.CA.Id)
                    glEntry.COA = "1452044";
                else if (logDef.OfficeId == OfficeId.BD.Id || logDef.OfficeId == OfficeId.IND.Id || logDef.OfficeId == OfficeId.ND.Id || logDef.OfficeId == OfficeId.PK.Id || logDef.OfficeId == OfficeId.TR.Id || logDef.OfficeId == OfficeId.EG.Id)
                    glEntry.COA = "1452039";
                else if (logDef.OfficeId == OfficeId.SL.Id)
                    glEntry.COA = "1452043";
                else
                    glEntry.COA = string.Empty;

                if (logDef.OfficeId != OfficeId.SL.Id || logDef.FiscalYear < 2020)
                    glEntry.Amount = Math.Round(rangePlanDef.TotalFOBCost * 0.03m / rangePlanDef.TotalQty * logDef.Quantity, 2, MidpointRounding.AwayFromZero);
                else
                    glEntry.Amount = Math.Round(logDef.Quantity * 0.03m, 2, MidpointRounding.AwayFromZero);
                glEntry.BaseAmount = Math.Round(glEntry.Amount
                                                * commonWorker.getExchangeRate(ExchangeRateType.INVOICE, rangePlanDef.SupplierCurrencyId, calDef.EndDate)
                                                / commonWorker.getExchangeRate(ExchangeRateType.INVOICE, CurrencyId.USD.Id, calDef.EndDate)
                                    , 2, MidpointRounding.AwayFromZero);

                glEntry.IsRecordComplete = false;
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                glEntry = (GLInterfaceEntry)glEntry.Clone();
                glEntry.DC = DCFlag.Credit;
                if (glEntry.COA == "1452044") // QA
                    glEntry.COA = "2511013";
                else if (glEntry.COA == "1452039")  // discount
                    glEntry.COA = "2515030";
                else if (glEntry.COA == "1452043")  // lt
                    glEntry.COA = "2510030";
                else
                    glEntry.COA = "N/A";

                glEntry.IsRecordComplete = true;
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                glEntry = (GLInterfaceEntry)glEntry.Clone();
                glEntry.DC = DCFlag.Debit;
                glEntry.COA = "3202056";
                glEntry.CurrencyCode = CurrencyId.getCommonName(CurrencyId.USD.Id);
                glEntry.Amount = Math.Round(rangePlanDef.ActualFreightUnitCostUSD * logDef.Quantity, 2, MidpointRounding.AwayFromZero);
                glEntry.BaseAmount = glEntry.Amount;
                glEntry.IsRecordComplete = false;
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                glEntry = (GLInterfaceEntry)glEntry.Clone();
                glEntry.DC = DCFlag.Credit;
                glEntry.COA = "1210012";
                glEntry.IsRecordComplete = true;
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);
            }
            */

            // ns-led freight & stock provision one-off when shipped
            //if ((logDef.CustomerId == CustomerDef.Id.ns_led.GetHashCode() || logDef.CustomerId == CustomerDef.Id.manu_led.GetHashCode()) && !commonWorker.getNSLedSelfBilledSupplierCodeList().Contains(contractDef.UKSupplierCode))
            if ((logDef.CustomerId == CustomerDef.Id.ns_led.GetHashCode() || logDef.CustomerId == CustomerDef.Id.manu_led.GetHashCode()))
            {
                decimal actualFreightUnitCostInUSD = this.getRangePlanActualFreightUnitCostInUSD(logDef.OfficeId, entry.ItemNo, this.getNSLedRangePlanSeasonIdByDeliveryDate(logDef.OfficeId, entry.ItemNo, shipmentDef.CustomerAgreedAtWarehouseDate));

                glEntry = new GLInterfaceEntry();
                glEntry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
                glEntry.GroupId = EpicorInterfaceWorker.Instance.GLInterfaceFile.getSourceString();
                glEntry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                glEntry.ApplyDate = glEntry.GroupApplyDate;

                if (isEnableWeek53Handling(logDef, isReversal))
                {
                    glEntry.GroupApplyDate = WK53_APPLY_DATE;
                    glEntry.ApplyDate = WK53_APPLY_DATE;
                }

                glEntry.DocumentType = GLDocumentTypeEnum.GL;
                glEntry.CurrencyCode = CurrencyId.getCommonName(CurrencyId.USD.Id);
                glEntry.DC = !isReversal ? DCFlag.Debit : DCFlag.Credit;
                glEntry.Qty = logDef.Quantity * logDef.PiecesPerPack;
                glEntry.Amount = Math.Round(actualFreightUnitCostInUSD * logDef.Quantity, 2, MidpointRounding.AwayFromZero);
                glEntry.BaseAmount = glEntry.Amount;
                glEntry.LineDescription = entry.ItemNo + " #" + logDef.ContractNo + "-" + logDef.DeliveryNo.ToString() + " P" + logDef.FiscalYear.ToString() + " " + logDef.Period.ToString().PadLeft(2, '0') + " SALES SETUP " + (isDuty ? "DUTY" : "NON-DUTY");
                glEntry.Office = getT0Code(logDef);
                glEntry.COA = "1210012";
                glEntry.IsRecordComplete = false;
                glEntry.SegmentValue3 = getT1Code(logDef);
                glEntry.SegmentValue4 = generalWorker.getProductCodeDefByKey(logDef.ProductTeamId).Code;
                glEntry.SegmentValue5 = getSeasonSegmentValue(logDef.SeasonId);
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                glEntry = (GLInterfaceEntry)glEntry.Clone();
                glEntry.DC = !isReversal ? DCFlag.Credit : DCFlag.Debit;
                glEntry.COA = "1452040";
                glEntry.IsRecordComplete = true;
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                decimal dutyPercent = this.getRangePlanDutyPercent(logDef.OfficeId, entry.ItemNo, this.getNSLedRangePlanSeasonIdByDeliveryDate(logDef.OfficeId, entry.ItemNo, shipmentDef.CustomerAgreedAtWarehouseDate));

                if (isDuty)
                {
                    glEntry = (GLInterfaceEntry)glEntry.Clone();
                    glEntry.DC = !isReversal ? DCFlag.Debit : DCFlag.Credit;
                    glEntry.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
                    glEntry.COA = "1210013";
                    glEntry.Amount = logDef.OtherAmount * dutyPercent / 100.0m;
                    glEntry.BaseAmount = Math.Round(glEntry.Amount * commonWorker.getExchangeRate(ExchangeRateType.INVOICE, logDef.CurrencyId, glEntry.ApplyDate) / commonWorker.getExchangeRate(ExchangeRateType.INVOICE, CurrencyId.USD.Id, glEntry.ApplyDate), 2, MidpointRounding.AwayFromZero);
                    glEntry.IsRecordComplete = false;
                    EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                    glEntry = (GLInterfaceEntry)glEntry.Clone();
                    glEntry.DC = !isReversal ? DCFlag.Credit : DCFlag.Debit;
                    glEntry.COA = "1452041";
                    glEntry.IsRecordComplete = true;
                    EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);
                }

                if (logDef.VendorId == 3154 && ltAmt == 0) // NML , requested by winnie @2021-04-27
                {
                    ltAmt = Math.Round(logDef.Quantity * 0.03m, 2, MidpointRounding.AwayFromZero);
                }

                glEntry = (GLInterfaceEntry)glEntry.Clone();
                glEntry.DC = !isReversal ? DCFlag.Debit : DCFlag.Credit;
                glEntry.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
                glEntry.COA = "3403020";
                glEntry.Amount = logDef.OtherAmount - qaAmt - ltAmt - discountAmt + (logDef.OtherAmount * dutyPercent / 100.0m)
                                + Math.Round(actualFreightUnitCostInUSD * logDef.Quantity
                                            * commonWorker.getExchangeRate(ExchangeRateType.INVOICE, CurrencyId.USD.Id, glEntry.ApplyDate)
                                            / commonWorker.getExchangeRate(ExchangeRateType.INVOICE, logDef.CurrencyId, glEntry.ApplyDate), 2, MidpointRounding.AwayFromZero);


                //

                int period = 0;
                if (isReversal)
                {
                    SunInterfaceLogDef historyLogDef = this.getReversalLogHistoryByShipmentId(logDef.SunInterfaceTypeId, logDef.ShipmentId, logDef.SplitShipmentId, logDef.SunInterfaceLogId);
                    period = (historyLogDef.FiscalYear * 100) + historyLogDef.Period;
                }
                else
                    period = (logDef.FiscalYear * 100) + logDef.Period;

                if (period < 202105)
                    glEntry.Amount = Math.Round(glEntry.Amount * 0.15m, 2, MidpointRounding.AwayFromZero); // 15 % stock provision
                else
                    glEntry.Amount = Math.Round(glEntry.Amount * OfficeId.getStockProvisionRate(logDef.OfficeId) / 100.0m, 2, MidpointRounding.AwayFromZero); // 15 % stock provision

                glEntry.BaseAmount = Math.Round(glEntry.Amount * commonWorker.getExchangeRate(ExchangeRateType.INVOICE, logDef.CurrencyId, logDef.TransactionDate) / commonWorker.getExchangeRate(ExchangeRateType.INVOICE, CurrencyId.USD.Id, logDef.TransactionDate), 2, MidpointRounding.AwayFromZero);
                glEntry.IsRecordComplete = false;
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                glEntry = (GLInterfaceEntry)glEntry.Clone();
                glEntry.DC = !isReversal ? DCFlag.Credit : DCFlag.Debit;
                glEntry.COA = "1210091";
                glEntry.IsRecordComplete = true;
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);
            }

        }

        private void addActualNSLedStockProvisionToSAFList(SunInterfaceLogDef logDef, ArrayList safList, bool isReversal)
        {
            System.Diagnostics.Debug.WriteLine(logDef.ContractNo + " " + logDef.ShipmentId.ToString());
            if (logDef.BaseAmount == 0) return;
            VendorRef vendor = vendorWorker.getVendorByKey(logDef.VendorId);
            ShipmentDef shipmentDef = OrderSelectWorker.Instance.getShipmentByKey(logDef.ShipmentId);
            ContractDef contractDef = OrderSelectWorker.Instance.getContractByKey(shipmentDef.ContractId);

            string t0 = getT0Code(logDef);

            decimal qaAmt = 0;
            decimal discountAmt = 0;
            decimal ltAmt = 0;

            if (logDef.OfficeId == OfficeId.SH.Id || logDef.OfficeId == OfficeId.TH.Id || logDef.OfficeId == OfficeId.HK.Id || logDef.OfficeId == OfficeId.DG.Id || logDef.OfficeId == OfficeId.VN.Id || logDef.OfficeId == OfficeId.CA.Id)
                qaAmt = Math.Round((logDef.QACommissionPercent / 100) * logDef.OtherAmount, 2, MidpointRounding.AwayFromZero);

            if (logDef.OfficeId == OfficeId.BD.Id || logDef.OfficeId == OfficeId.IND.Id || logDef.OfficeId == OfficeId.ND.Id || logDef.OfficeId == OfficeId.PK.Id || logDef.OfficeId == OfficeId.SL.Id || logDef.OfficeId == OfficeId.TR.Id || logDef.OfficeId == OfficeId.EG.Id)
                discountAmt = Math.Round(logDef.OtherAmount * logDef.VendorPaymentDiscountPercent / 100, 2, MidpointRounding.AwayFromZero);

            if (logDef.LabTestIncome > 0)
                ltAmt = Math.Round(logDef.Quantity * logDef.LabTestIncome, 2, MidpointRounding.AwayFromZero);

            GLInterfaceEntry glEntry = new GLInterfaceEntry();

            // ns-led freight & stock provision one-off when shipped
            if ((logDef.CustomerId == CustomerDef.Id.ns_led.GetHashCode() || logDef.CustomerId == CustomerDef.Id.manu_led.GetHashCode()))
            {
                bool isDuty = commonWorker.getNSLedSelfBilledSupplierCodeList().Contains(contractDef.UKSupplierCode);
                ProductDef product = ProductWorker.Instance.getProductByKey(logDef.ProductId);

                decimal actualFreightUnitCostInUSD = this.getRangePlanActualFreightUnitCostInUSD(logDef.OfficeId, product.ItemNo, this.getNSLedRangePlanSeasonIdByDeliveryDate(logDef.OfficeId, product.ItemNo, shipmentDef.CustomerAgreedAtWarehouseDate));

                glEntry = new GLInterfaceEntry();
                glEntry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
                glEntry.GroupId = EpicorInterfaceWorker.Instance.GLInterfaceFile.getSourceString();
                glEntry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                glEntry.ApplyDate = glEntry.GroupApplyDate;

                if (isEnableWeek53Handling(logDef, isReversal))
                {
                    glEntry.GroupApplyDate = WK53_APPLY_DATE;
                    glEntry.ApplyDate = WK53_APPLY_DATE;
                }

                glEntry.DocumentType = GLDocumentTypeEnum.GL;
                glEntry.CurrencyCode = CurrencyId.getCommonName(CurrencyId.USD.Id);
                glEntry.DC = !isReversal ? DCFlag.Debit : DCFlag.Credit;
                glEntry.Qty = logDef.Quantity * logDef.PiecesPerPack;
                glEntry.Amount = Math.Round(actualFreightUnitCostInUSD * logDef.Quantity, 2, MidpointRounding.AwayFromZero);
                glEntry.BaseAmount = glEntry.Amount;
                glEntry.LineDescription = product.ItemNo + " #" + logDef.ContractNo + "-" + logDef.DeliveryNo.ToString() + " P" + logDef.FiscalYear.ToString() + " " + logDef.Period.ToString().PadLeft(2, '0') + " SALES SETUP " + (isDuty ? "DUTY" : "NON-DUTY");
                glEntry.Office = getT0Code(logDef);
                glEntry.COA = "1210012";
                glEntry.IsRecordComplete = false;
                glEntry.SegmentValue3 = getT1Code(logDef);
                glEntry.SegmentValue4 = generalWorker.getProductCodeDefByKey(logDef.ProductTeamId).Code;
                glEntry.SegmentValue5 = getSeasonSegmentValue(logDef.SeasonId);
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                glEntry = (GLInterfaceEntry)glEntry.Clone();
                glEntry.DC = !isReversal ? DCFlag.Credit : DCFlag.Debit;
                glEntry.COA = "1452040";
                glEntry.IsRecordComplete = true;
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                decimal dutyPercent = this.getRangePlanDutyPercent(logDef.OfficeId, product.ItemNo, this.getNSLedRangePlanSeasonIdByDeliveryDate(logDef.OfficeId, product.ItemNo, shipmentDef.CustomerAgreedAtWarehouseDate));

                if (isDuty)
                {
                    glEntry = (GLInterfaceEntry)glEntry.Clone();
                    glEntry.DC = !isReversal ? DCFlag.Debit : DCFlag.Credit;
                    glEntry.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
                    glEntry.COA = "1210013";
                    glEntry.Amount = logDef.OtherAmount * dutyPercent / 100.0m;
                    glEntry.BaseAmount = Math.Round(glEntry.Amount * commonWorker.getExchangeRate(ExchangeRateType.INVOICE, logDef.CurrencyId, glEntry.ApplyDate) / commonWorker.getExchangeRate(ExchangeRateType.INVOICE, CurrencyId.USD.Id, glEntry.ApplyDate), 2, MidpointRounding.AwayFromZero);
                    glEntry.IsRecordComplete = false;
                    EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                    glEntry = (GLInterfaceEntry)glEntry.Clone();
                    glEntry.DC = !isReversal ? DCFlag.Credit : DCFlag.Debit;
                    glEntry.COA = "1452041";
                    glEntry.IsRecordComplete = true;
                    EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);
                }

                if (logDef.VendorId == 3154 && ltAmt == 0) // NML , requested by winnie @2021-04-27
                {
                    ltAmt = Math.Round(logDef.Quantity * 0.03m, 2, MidpointRounding.AwayFromZero);
                }

                glEntry = (GLInterfaceEntry)glEntry.Clone();
                glEntry.DC = !isReversal ? DCFlag.Debit : DCFlag.Credit;
                glEntry.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
                glEntry.COA = "3403020";
                glEntry.Amount = logDef.OtherAmount - qaAmt - ltAmt - discountAmt + (logDef.OtherAmount * dutyPercent / 100.0m)
                                + Math.Round(actualFreightUnitCostInUSD * logDef.Quantity
                                            * commonWorker.getExchangeRate(ExchangeRateType.INVOICE, CurrencyId.USD.Id, glEntry.ApplyDate)
                                            / commonWorker.getExchangeRate(ExchangeRateType.INVOICE, logDef.CurrencyId, glEntry.ApplyDate), 2, MidpointRounding.AwayFromZero);

                //

                int period = 0;
                if (isReversal)
                {
                    SunInterfaceLogDef historyLogDef = this.getReversalLogHistoryByShipmentId(logDef.SunInterfaceTypeId, logDef.ShipmentId, logDef.SplitShipmentId, logDef.SunInterfaceLogId);
                    period = (historyLogDef.FiscalYear * 100) + historyLogDef.Period;
                }
                else
                    period = (logDef.FiscalYear * 100) + logDef.Period;

                if (period < 202105)
                    glEntry.Amount = Math.Round(glEntry.Amount * 0.15m, 2, MidpointRounding.AwayFromZero); // 15 % stock provision
                else
                    glEntry.Amount = Math.Round(glEntry.Amount * OfficeId.getStockProvisionRate(logDef.OfficeId) / 100.0m, 2, MidpointRounding.AwayFromZero); // 15 % stock provision

                glEntry.BaseAmount = Math.Round(glEntry.Amount * commonWorker.getExchangeRate(ExchangeRateType.INVOICE, logDef.CurrencyId, logDef.TransactionDate) / commonWorker.getExchangeRate(ExchangeRateType.INVOICE, CurrencyId.USD.Id, logDef.TransactionDate), 2, MidpointRounding.AwayFromZero);
                glEntry.IsRecordComplete = false;
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                glEntry = (GLInterfaceEntry)glEntry.Clone();
                glEntry.DC = !isReversal ? DCFlag.Credit : DCFlag.Debit;
                glEntry.COA = "1210091";
                glEntry.IsRecordComplete = true;
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);
            }

        }


        private void addAccrualPurchaseToSAFList(SunInterfaceLogDef logDef, ArrayList safList)
        {
            if (logDef.BaseAmount == 0) return;
            VendorRef vendor = vendorWorker.getVendorByKey(logDef.VendorId);
            string t0 = getT0Code(logDef);
            GLInterfaceEntry entry = new GLInterfaceEntry();

            #region accrual purchase debit entry
            entry.Reverse = true;
            entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
            entry.GroupId = EpicorInterfaceWorker.Instance.GLInterfaceFile.getSourceString();
            entry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
            entry.ApplyDate = entry.GroupApplyDate;
            entry.DocumentType = GLDocumentTypeEnum.ISAM_ACCRUAL_PURCHASE;
            entry.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
            entry.DC = DCFlag.Debit;
            entry.Amount = logDef.OtherAmount;
            entry.BaseAmount = logDef.BaseAmount;
            entry.Qty = logDef.Quantity * logDef.PiecesPerPack;
            entry.LineDescription = logDef.ContractNo + "-" + logDef.DeliveryNo.ToString() + " #" + ProductWorker.Instance.getProductByKey(logDef.ProductId).ItemNo;
            entry.Office = t0;
            entry.COA = generalWorker.getEpicorCOA("3106901");
            entry.SegmentValue3 = getT1Code(logDef);
            entry.SegmentValue4 = generalWorker.getProductCodeDefByKey(logDef.ProductTeamId).Code;
            entry.SegmentValue5 = getSeasonSegmentValue(logDef.SeasonId);
            EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);

            #endregion

            decimal paymentDiscountOtherAmt = Math.Round(logDef.OtherAmount * logDef.VendorPaymentDiscountPercent / 100, 2, MidpointRounding.AwayFromZero);
            decimal paymentDiscountBaseAmt = Math.Round(logDef.BaseAmount * logDef.VendorPaymentDiscountPercent / 100, 2, MidpointRounding.AwayFromZero);

            #region accrual purchase credit entry

            entry = (GLInterfaceEntry)entry.Clone();
            entry.COA = generalWorker.getEpicorCOA("1410998");
            if (t0 == "TKMF") entry.Office = "TK1F";
            else if (t0 == "TK5F") entry.Office = "TK1F";
            else entry.Office = t0;

            entry.SegmentValue3 = string.Empty;
            entry.SegmentValue4 = string.Empty;
            entry.SegmentValue5 = string.Empty;
            entry.DC = DCFlag.Credit;

            if (logDef.VendorPaymentDiscountPercent > 0)
            {
                entry.BaseAmount = entry.BaseAmount - paymentDiscountBaseAmt;
                entry.Amount = entry.Amount - paymentDiscountOtherAmt;

                #region accrual purchase discount credit entry
                GLInterfaceEntry discountEntry = (GLInterfaceEntry)entry.Clone();
                discountEntry.COA = generalWorker.getEpicorCOA("2102301");
                discountEntry.Office = t0;
                discountEntry.SegmentValue3 = getT1Code(logDef);
                discountEntry.SegmentValue4 = generalWorker.getProductCodeDefByKey(logDef.ProductTeamId).Code;
                discountEntry.SegmentValue5 = getSeasonSegmentValue(logDef.SeasonId);
                discountEntry.Amount = paymentDiscountOtherAmt;
                discountEntry.BaseAmount = paymentDiscountBaseAmt;
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)discountEntry);

                #endregion
            }

            entry.IsRecordComplete = true;
            EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);

            #endregion
        }

        private void addActualOtherCostToSAFList(SunInterfaceLogDef logDef, ArrayList safList, bool isReversal)
        {
            if (logDef.BaseAmount == 0) return;
            VendorRef vendor = vendorWorker.getVendorByKey(logDef.VendorId);
            string t0 = getT0Code(logDef);

            #region other cost debit entry
            SAFDef def = new SAFDef();
            if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.AirFreightCost.GetHashCode())
            {
                if (logDef.CustomerId == CustomerDef.Id.lm_ted_baker.GetHashCode())
                    def.AccountCode = "3202070";
                else if (logDef.CustomerId == CustomerDef.Id.lm_oasis.GetHashCode())
                    def.AccountCode = "3202094";
                else if (logDef.CustomerId == CustomerDef.Id.lm_label_mix.GetHashCode())
                    def.AccountCode = "3202120";
                else if (logDef.CustomerId == CustomerDef.Id.lm_little_bird.GetHashCode())
                    def.AccountCode = "3202146";
                else if (logDef.CustomerId == CustomerDef.Id.lm_myleene_klass.GetHashCode())
                    def.AccountCode = "3202172";
                else if (logDef.CustomerId == CustomerDef.Id.lm_nine.GetHashCode())
                    def.AccountCode = "3202212";
                else if (logDef.CustomerId == CustomerDef.Id.lm_mintie.GetHashCode())
                    def.AccountCode = "3202238";
                else if (logDef.CustomerId == CustomerDef.Id.lm_fat_face.GetHashCode())
                    def.AccountCode = "3202264";
                else if (logDef.CustomerId == CustomerDef.Id.lm_laura_ashley.GetHashCode())
                    def.AccountCode = "3202290";
                else if (logDef.CustomerId == CustomerDef.Id.lm_mint_velvet.GetHashCode())
                    def.AccountCode = "3202342";
                else if (logDef.CustomerId == CustomerDef.Id.lm_hype.GetHashCode())
                    def.AccountCode = "3202316";
                else
                    def.AccountCode = "3106310";
            }
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.ClaimsRecovery.GetHashCode())
            {
                if (logDef.CustomerId == CustomerDef.Id.lm_ted_baker.GetHashCode())
                    def.AccountCode = "3202083";
                else if (logDef.CustomerId == CustomerDef.Id.lm_oasis.GetHashCode())
                    def.AccountCode = "3202107";
                else if (logDef.CustomerId == CustomerDef.Id.lm_label_mix.GetHashCode())
                    def.AccountCode = "3202133";
                else if (logDef.CustomerId == CustomerDef.Id.lm_little_bird.GetHashCode())
                    def.AccountCode = "3202159";
                else if (logDef.CustomerId == CustomerDef.Id.lm_myleene_klass.GetHashCode())
                    def.AccountCode = "3202185";
                else if (logDef.CustomerId == CustomerDef.Id.lm_nine.GetHashCode())
                    def.AccountCode = "3202213";
                else if (logDef.CustomerId == CustomerDef.Id.lm_mintie.GetHashCode())
                    def.AccountCode = "3202239";
                else if (logDef.CustomerId == CustomerDef.Id.lm_fat_face.GetHashCode())
                    def.AccountCode = "3202265";
                else if (logDef.CustomerId == CustomerDef.Id.lm_laura_ashley.GetHashCode())
                    def.AccountCode = "3202291";
                else if (logDef.CustomerId == CustomerDef.Id.lm_mint_velvet.GetHashCode())
                    def.AccountCode = "3202343";
                else if (logDef.CustomerId == CustomerDef.Id.lm_hype.GetHashCode())
                    def.AccountCode = "3202317";
                else
                    def.AccountCode = "3106317";
            }
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.CourierCostForSample.GetHashCode())
                def.AccountCode = "3106508";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.CoverForQuenbyFabric.GetHashCode())
                def.AccountCode = "3106314";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.DesignFee.GetHashCode())
                def.AccountCode = "3106207";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.DevelopmentSampleCost.GetHashCode())
            {
                if (logDef.CustomerId == CustomerDef.Id.lm_ted_baker.GetHashCode())
                    def.AccountCode = "3202065";
                else if (logDef.CustomerId == CustomerDef.Id.lm_oasis.GetHashCode())
                    def.AccountCode = "3202089";
                else if (logDef.CustomerId == CustomerDef.Id.lm_label_mix.GetHashCode())
                    def.AccountCode = "3202115";
                else if (logDef.CustomerId == CustomerDef.Id.lm_little_bird.GetHashCode())
                    def.AccountCode = "3202141";
                else if (logDef.CustomerId == CustomerDef.Id.lm_myleene_klass.GetHashCode())
                    def.AccountCode = "3202167";
                else if (logDef.CustomerId == CustomerDef.Id.lm_nine.GetHashCode())
                    def.AccountCode = "3202195";
                else if (logDef.CustomerId == CustomerDef.Id.lm_mintie.GetHashCode())
                    def.AccountCode = "3202221";
                else if (logDef.CustomerId == CustomerDef.Id.lm_fat_face.GetHashCode())
                    def.AccountCode = "3202247";
                else if (logDef.CustomerId == CustomerDef.Id.lm_laura_ashley.GetHashCode())
                    def.AccountCode = "3202273";
                else if (logDef.CustomerId == CustomerDef.Id.lm_mint_velvet.GetHashCode())
                    def.AccountCode = "3202325";
                else if (logDef.CustomerId == CustomerDef.Id.lm_hype.GetHashCode())
                    def.AccountCode = "3202299";

                else
                    def.AccountCode = "3106119";
            }
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.DutyCost.GetHashCode())
                def.AccountCode = "3106206";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.ProvisionForFabricLiabilities.GetHashCode())
            {
                if (logDef.CustomerId == CustomerDef.Id.lm_ted_baker.GetHashCode())
                    def.AccountCode = "3202064";
                else if (logDef.CustomerId == CustomerDef.Id.lm_oasis.GetHashCode())
                    def.AccountCode = "3202088";
                else if (logDef.CustomerId == CustomerDef.Id.lm_label_mix.GetHashCode())
                    def.AccountCode = "3202114";
                else if (logDef.CustomerId == CustomerDef.Id.lm_little_bird.GetHashCode())
                    def.AccountCode = "3202140";
                else if (logDef.CustomerId == CustomerDef.Id.lm_myleene_klass.GetHashCode())
                    def.AccountCode = "3202166";
                else if (logDef.CustomerId == CustomerDef.Id.lm_nine.GetHashCode())
                    def.AccountCode = "3202194";
                else if (logDef.CustomerId == CustomerDef.Id.lm_mintie.GetHashCode())
                    def.AccountCode = "3202220";
                else if (logDef.CustomerId == CustomerDef.Id.lm_fat_face.GetHashCode())
                    def.AccountCode = "3202246";
                else if (logDef.CustomerId == CustomerDef.Id.lm_laura_ashley.GetHashCode())
                    def.AccountCode = "3202272";
                else if (logDef.CustomerId == CustomerDef.Id.lm_mint_velvet.GetHashCode())
                    def.AccountCode = "3202324";
                else if (logDef.CustomerId == CustomerDef.Id.lm_hype.GetHashCode())
                    def.AccountCode = "3202298";

                else
                    def.AccountCode = "3106312";
            }
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.FinanceCost.GetHashCode())
                def.AccountCode = "3106311";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.FragranceCost.GetHashCode())
                def.AccountCode = "3106208";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.FreightCost.GetHashCode())
                def.AccountCode = "3106205";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.FreightForBodycare.GetHashCode())
                def.AccountCode = "3108106";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.GTCommission.GetHashCode())
                def.AccountCode = "3106401";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.Recovery.GetHashCode())
                def.AccountCode = "3106316";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.KitDevelopmentCost.GetHashCode())
                def.AccountCode = "3106180";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.OutsideLabTestCost.GetHashCode())
                def.AccountCode = "3106307";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.MarginDifference.GetHashCode())
                def.AccountCode = "3106304";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.OtherFabricCost.GetHashCode())
            {
                if (logDef.CustomerId == CustomerDef.Id.lm_ted_baker.GetHashCode())
                    def.AccountCode = "3202068";
                else if (logDef.CustomerId == CustomerDef.Id.lm_oasis.GetHashCode())
                    def.AccountCode = "3202092";
                else if (logDef.CustomerId == CustomerDef.Id.lm_label_mix.GetHashCode())
                    def.AccountCode = "3202118";
                else if (logDef.CustomerId == CustomerDef.Id.lm_little_bird.GetHashCode())
                    def.AccountCode = "3202144";
                else if (logDef.CustomerId == CustomerDef.Id.lm_myleene_klass.GetHashCode())
                    def.AccountCode = "3202170";
                else if (logDef.CustomerId == CustomerDef.Id.lm_nine.GetHashCode())
                    def.AccountCode = "3202198";
                else if (logDef.CustomerId == CustomerDef.Id.lm_mintie.GetHashCode())
                    def.AccountCode = "3202224";
                else if (logDef.CustomerId == CustomerDef.Id.lm_fat_face.GetHashCode())
                    def.AccountCode = "3202250";
                else if (logDef.CustomerId == CustomerDef.Id.lm_laura_ashley.GetHashCode())
                    def.AccountCode = "3202276";
                else if (logDef.CustomerId == CustomerDef.Id.lm_mint_velvet.GetHashCode())
                    def.AccountCode = "3202328";
                else if (logDef.CustomerId == CustomerDef.Id.lm_hype.GetHashCode())
                    def.AccountCode = "3202302";

                else
                    def.AccountCode = "3106102";
            }
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.PrintDevCost.GetHashCode())
            {
                if (logDef.CustomerId == CustomerDef.Id.lm_ted_baker.GetHashCode())
                    def.AccountCode = "3202073";
                else if (logDef.CustomerId == CustomerDef.Id.lm_oasis.GetHashCode())
                    def.AccountCode = "3202097";
                else if (logDef.CustomerId == CustomerDef.Id.lm_label_mix.GetHashCode())
                    def.AccountCode = "3202123";
                else if (logDef.CustomerId == CustomerDef.Id.lm_little_bird.GetHashCode())
                    def.AccountCode = "3202149";
                else if (logDef.CustomerId == CustomerDef.Id.lm_myleene_klass.GetHashCode())
                    def.AccountCode = "3202175";
                else if (logDef.CustomerId == CustomerDef.Id.lm_nine.GetHashCode())
                    def.AccountCode = "3202203";
                else if (logDef.CustomerId == CustomerDef.Id.lm_mintie.GetHashCode())
                    def.AccountCode = "3202229";
                else if (logDef.CustomerId == CustomerDef.Id.lm_fat_face.GetHashCode())
                    def.AccountCode = "3202255";
                else if (logDef.CustomerId == CustomerDef.Id.lm_laura_ashley.GetHashCode())
                    def.AccountCode = "3202281";
                else if (logDef.CustomerId == CustomerDef.Id.lm_mint_velvet.GetHashCode())
                    def.AccountCode = "3202333";
                else if (logDef.CustomerId == CustomerDef.Id.lm_hype.GetHashCode())
                    def.AccountCode = "3202307";

                else
                    def.AccountCode = "3106303";
            }
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.SampleLengthCost.GetHashCode())
            {
                if (logDef.CustomerId == CustomerDef.Id.lm_ted_baker.GetHashCode())
                    def.AccountCode = "3202077";
                else if (logDef.CustomerId == CustomerDef.Id.lm_oasis.GetHashCode())
                    def.AccountCode = "3202101";
                else if (logDef.CustomerId == CustomerDef.Id.lm_label_mix.GetHashCode())
                    def.AccountCode = "3202127";
                else if (logDef.CustomerId == CustomerDef.Id.lm_little_bird.GetHashCode())
                    def.AccountCode = "3202153";
                else if (logDef.CustomerId == CustomerDef.Id.lm_myleene_klass.GetHashCode())
                    def.AccountCode = "3202179";
                else if (logDef.CustomerId == CustomerDef.Id.lm_nine.GetHashCode())
                    def.AccountCode = "3202207";
                else if (logDef.CustomerId == CustomerDef.Id.lm_mintie.GetHashCode())
                    def.AccountCode = "3202233";
                else if (logDef.CustomerId == CustomerDef.Id.lm_fat_face.GetHashCode())
                    def.AccountCode = "3202259";
                else if (logDef.CustomerId == CustomerDef.Id.lm_laura_ashley.GetHashCode())
                    def.AccountCode = "3202285";
                else if (logDef.CustomerId == CustomerDef.Id.lm_mint_velvet.GetHashCode())
                    def.AccountCode = "3202337";
                else if (logDef.CustomerId == CustomerDef.Id.lm_hype.GetHashCode())
                    def.AccountCode = "3202311";

                else
                    def.AccountCode = "3106118";
            }
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.ToolingCost.GetHashCode())
                def.AccountCode = "3106207";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.TransportationCost.GetHashCode())
                def.AccountCode = "3202044";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.PackageCost.GetHashCode())
                def.AccountCode = "3106107";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.QCC.GetHashCode())
            {
                if (logDef.CustomerId == CustomerDef.Id.lm_ted_baker.GetHashCode())
                    def.AccountCode = "3202084";
                else if (logDef.CustomerId == CustomerDef.Id.lm_oasis.GetHashCode())
                    def.AccountCode = "3202108";
                else if (logDef.CustomerId == CustomerDef.Id.lm_label_mix.GetHashCode())
                    def.AccountCode = "3202134";
                else if (logDef.CustomerId == CustomerDef.Id.lm_little_bird.GetHashCode())
                    def.AccountCode = "3202160";
                else if (logDef.CustomerId == CustomerDef.Id.lm_myleene_klass.GetHashCode())
                    def.AccountCode = "3202186";
                else if (logDef.CustomerId == CustomerDef.Id.lm_nine.GetHashCode())
                    def.AccountCode = "3202214";
                else if (logDef.CustomerId == CustomerDef.Id.lm_mintie.GetHashCode())
                    def.AccountCode = "3202240";
                else if (logDef.CustomerId == CustomerDef.Id.lm_fat_face.GetHashCode())
                    def.AccountCode = "3202266";
                else if (logDef.CustomerId == CustomerDef.Id.lm_laura_ashley.GetHashCode())
                    def.AccountCode = "3202292";
                else if (logDef.CustomerId == CustomerDef.Id.lm_mint_velvet.GetHashCode())
                    def.AccountCode = "3202344";
                else if (logDef.CustomerId == CustomerDef.Id.lm_hype.GetHashCode())
                    def.AccountCode = "3202318";

                else
                    def.AccountCode = "3106318";
            }
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.QCCMyanmar.GetHashCode())
            {
                if (logDef.CustomerId == CustomerDef.Id.lm_ted_baker.GetHashCode())
                    def.AccountCode = "3202086";
                else if (logDef.CustomerId == CustomerDef.Id.lm_oasis.GetHashCode())
                    def.AccountCode = "3202110";
                else if (logDef.CustomerId == CustomerDef.Id.lm_label_mix.GetHashCode())
                    def.AccountCode = "3202136";
                else if (logDef.CustomerId == CustomerDef.Id.lm_little_bird.GetHashCode())
                    def.AccountCode = "3202162";
                else if (logDef.CustomerId == CustomerDef.Id.lm_myleene_klass.GetHashCode())
                    def.AccountCode = "3202188";
                else if (logDef.CustomerId == CustomerDef.Id.lm_nine.GetHashCode())
                    def.AccountCode = "3202216";
                else if (logDef.CustomerId == CustomerDef.Id.lm_mintie.GetHashCode())
                    def.AccountCode = "3202242";
                else if (logDef.CustomerId == CustomerDef.Id.lm_fat_face.GetHashCode())
                    def.AccountCode = "3202268";
                else if (logDef.CustomerId == CustomerDef.Id.lm_laura_ashley.GetHashCode())
                    def.AccountCode = "3202294";
                else if (logDef.CustomerId == CustomerDef.Id.lm_mint_velvet.GetHashCode())
                    def.AccountCode = "3202346";
                else if (logDef.CustomerId == CustomerDef.Id.lm_hype.GetHashCode())
                    def.AccountCode = "3202320";

                else
                    def.AccountCode = "3202049";
            }
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.RepairCost.GetHashCode())
            {
                if (logDef.CustomerId == CustomerDef.Id.lm_ted_baker.GetHashCode())
                    def.AccountCode = "3202076";
                else if (logDef.CustomerId == CustomerDef.Id.lm_oasis.GetHashCode())
                    def.AccountCode = "3202100";
                else if (logDef.CustomerId == CustomerDef.Id.lm_label_mix.GetHashCode())
                    def.AccountCode = "3202126";
                else if (logDef.CustomerId == CustomerDef.Id.lm_little_bird.GetHashCode())
                    def.AccountCode = "3202152";
                else if (logDef.CustomerId == CustomerDef.Id.lm_myleene_klass.GetHashCode())
                    def.AccountCode = "3202178";
                else if (logDef.CustomerId == CustomerDef.Id.lm_nine.GetHashCode())
                    def.AccountCode = "3202206";
                else if (logDef.CustomerId == CustomerDef.Id.lm_mintie.GetHashCode())
                    def.AccountCode = "3202232";
                else if (logDef.CustomerId == CustomerDef.Id.lm_fat_face.GetHashCode())
                    def.AccountCode = "3202258";
                else if (logDef.CustomerId == CustomerDef.Id.lm_laura_ashley.GetHashCode())
                    def.AccountCode = "3202284";
                else if (logDef.CustomerId == CustomerDef.Id.lm_mint_velvet.GetHashCode())
                    def.AccountCode = "3202336";
                else if (logDef.CustomerId == CustomerDef.Id.lm_hype.GetHashCode())
                    def.AccountCode = "3202310";

                else
                    def.AccountCode = "3106305";
            }
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.SellingPriceDiscount.GetHashCode())
            {
                if (logDef.CustomerId == CustomerDef.Id.lm_ted_baker.GetHashCode())
                    def.AccountCode = "3202067";
                else if (logDef.CustomerId == CustomerDef.Id.lm_oasis.GetHashCode())
                    def.AccountCode = "3202091";
                else if (logDef.CustomerId == CustomerDef.Id.lm_label_mix.GetHashCode())
                    def.AccountCode = "3202117";
                else if (logDef.CustomerId == CustomerDef.Id.lm_little_bird.GetHashCode())
                    def.AccountCode = "3202143";
                else if (logDef.CustomerId == CustomerDef.Id.lm_myleene_klass.GetHashCode())
                    def.AccountCode = "3202169";
                else if (logDef.CustomerId == CustomerDef.Id.lm_nine.GetHashCode())
                    def.AccountCode = "3202197";
                else if (logDef.CustomerId == CustomerDef.Id.lm_mintie.GetHashCode())
                    def.AccountCode = "3202223";
                else if (logDef.CustomerId == CustomerDef.Id.lm_fat_face.GetHashCode())
                    def.AccountCode = "3202249";
                else if (logDef.CustomerId == CustomerDef.Id.lm_laura_ashley.GetHashCode())
                    def.AccountCode = "3202275";
                else if (logDef.CustomerId == CustomerDef.Id.lm_mint_velvet.GetHashCode())
                    def.AccountCode = "3202327";
                else if (logDef.CustomerId == CustomerDef.Id.lm_hype.GetHashCode())
                    def.AccountCode = "3202301";

                else
                    def.AccountCode = "3106309";
            }
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.NTN_Recovery.GetHashCode())
                def.AccountCode = "3106509";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.MOB.GetHashCode())
                def.AccountCode = "3106320";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.ForwardingCharge.GetHashCode())
            {
                if (logDef.CustomerId == CustomerDef.Id.lm_ted_baker.GetHashCode())
                    def.AccountCode = "3202071";
                else if (logDef.CustomerId == CustomerDef.Id.lm_oasis.GetHashCode())
                    def.AccountCode = "3202095";
                else if (logDef.CustomerId == CustomerDef.Id.lm_label_mix.GetHashCode())
                    def.AccountCode = "3202121";
                else if (logDef.CustomerId == CustomerDef.Id.lm_little_bird.GetHashCode())
                    def.AccountCode = "3202147";
                else if (logDef.CustomerId == CustomerDef.Id.lm_myleene_klass.GetHashCode())
                    def.AccountCode = "3202173";
                else if (logDef.CustomerId == CustomerDef.Id.lm_nine.GetHashCode())
                    def.AccountCode = "3202201";
                else if (logDef.CustomerId == CustomerDef.Id.lm_mintie.GetHashCode())
                    def.AccountCode = "3202227";
                else if (logDef.CustomerId == CustomerDef.Id.lm_fat_face.GetHashCode())
                    def.AccountCode = "3202253";
                else if (logDef.CustomerId == CustomerDef.Id.lm_laura_ashley.GetHashCode())
                    def.AccountCode = "3202279";
                else if (logDef.CustomerId == CustomerDef.Id.lm_mint_velvet.GetHashCode())
                    def.AccountCode = "3202331";
                else if (logDef.CustomerId == CustomerDef.Id.lm_hype.GetHashCode())
                    def.AccountCode = "3202305";

                else
                    def.AccountCode = "3106321";
            }
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.LicenseCost.GetHashCode())
                def.AccountCode = "3202040";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.TradingAirFreight.GetHashCode())
            {
                if (logDef.CustomerId == CustomerDef.Id.lm_ted_baker.GetHashCode())
                    def.AccountCode = "3202072";
                else if (logDef.CustomerId == CustomerDef.Id.lm_oasis.GetHashCode())
                    def.AccountCode = "3202096";
                else if (logDef.CustomerId == CustomerDef.Id.lm_label_mix.GetHashCode())
                    def.AccountCode = "3202122";
                else if (logDef.CustomerId == CustomerDef.Id.lm_little_bird.GetHashCode())
                    def.AccountCode = "3202148";
                else if (logDef.CustomerId == CustomerDef.Id.lm_myleene_klass.GetHashCode())
                    def.AccountCode = "3202174";
                else if (logDef.CustomerId == CustomerDef.Id.lm_nine.GetHashCode())
                    def.AccountCode = "3202202";
                else if (logDef.CustomerId == CustomerDef.Id.lm_mintie.GetHashCode())
                    def.AccountCode = "3202228";
                else if (logDef.CustomerId == CustomerDef.Id.lm_fat_face.GetHashCode())
                    def.AccountCode = "3202254";
                else if (logDef.CustomerId == CustomerDef.Id.lm_laura_ashley.GetHashCode())
                    def.AccountCode = "3202280";
                else if (logDef.CustomerId == CustomerDef.Id.lm_mint_velvet.GetHashCode())
                    def.AccountCode = "3202332";
                else if (logDef.CustomerId == CustomerDef.Id.lm_hype.GetHashCode())
                    def.AccountCode = "3202306";

                else
                    def.AccountCode = "3202041";
            }
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.ClaimsRecovery_Specific.GetHashCode())
            {
                if (logDef.CustomerId == CustomerDef.Id.lm_ted_baker.GetHashCode())
                    def.AccountCode = "3202075";
                else if (logDef.CustomerId == CustomerDef.Id.lm_oasis.GetHashCode())
                    def.AccountCode = "3202099";
                else if (logDef.CustomerId == CustomerDef.Id.lm_label_mix.GetHashCode())
                    def.AccountCode = "3202125";
                else if (logDef.CustomerId == CustomerDef.Id.lm_little_bird.GetHashCode())
                    def.AccountCode = "3202151";
                else if (logDef.CustomerId == CustomerDef.Id.lm_myleene_klass.GetHashCode())
                    def.AccountCode = "3202177";
                else if (logDef.CustomerId == CustomerDef.Id.lm_nine.GetHashCode())
                    def.AccountCode = "3202205";
                else if (logDef.CustomerId == CustomerDef.Id.lm_mintie.GetHashCode())
                    def.AccountCode = "3202231";
                else if (logDef.CustomerId == CustomerDef.Id.lm_fat_face.GetHashCode())
                    def.AccountCode = "3202257";
                else if (logDef.CustomerId == CustomerDef.Id.lm_laura_ashley.GetHashCode())
                    def.AccountCode = "3202283";
                else if (logDef.CustomerId == CustomerDef.Id.lm_mint_velvet.GetHashCode())
                    def.AccountCode = "3202335";
                else if (logDef.CustomerId == CustomerDef.Id.lm_hype.GetHashCode())
                    def.AccountCode = "3202309";

                else
                    def.AccountCode = "3202042";
            }
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.CoatingCost.GetHashCode())
                def.AccountCode = "3202043";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.FabricCostDiscount.GetHashCode())
                def.AccountCode = "1415202";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.CMPOrderProcessing.GetHashCode())
                def.AccountCode = "3202190";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.CMPQAComm.GetHashCode())
                def.AccountCode = "3202191";

            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.Slippage.GetHashCode())
            {
                if (logDef.CustomerId == CustomerDef.Id.lm_ted_baker.GetHashCode())
                    def.AccountCode = "3202079";
                else if (logDef.CustomerId == CustomerDef.Id.lm_oasis.GetHashCode())
                    def.AccountCode = "3202103";
                else if (logDef.CustomerId == CustomerDef.Id.lm_label_mix.GetHashCode())
                    def.AccountCode = "3202129";
                else if (logDef.CustomerId == CustomerDef.Id.lm_little_bird.GetHashCode())
                    def.AccountCode = "3202155";
                else if (logDef.CustomerId == CustomerDef.Id.lm_myleene_klass.GetHashCode())
                    def.AccountCode = "3202181";
                else if (logDef.CustomerId == CustomerDef.Id.lm_nine.GetHashCode())
                    def.AccountCode = "3202209";
                else if (logDef.CustomerId == CustomerDef.Id.lm_mintie.GetHashCode())
                    def.AccountCode = "3202235";
                else if (logDef.CustomerId == CustomerDef.Id.lm_fat_face.GetHashCode())
                    def.AccountCode = "3202261";
                else if (logDef.CustomerId == CustomerDef.Id.lm_laura_ashley.GetHashCode())
                    def.AccountCode = "3202287";
                else if (logDef.CustomerId == CustomerDef.Id.lm_mint_velvet.GetHashCode())
                    def.AccountCode = "3202339";
                else if (logDef.CustomerId == CustomerDef.Id.lm_hype.GetHashCode())
                    def.AccountCode = "3202313";

                else
                    def.AccountCode = "3202051";
            }
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.SlippageReversal.GetHashCode())
                def.AccountCode = "1452038";

            def.FiscalYear = logDef.FiscalYear;
            def.Period = logDef.Period;
            def.TransactionDate = logDef.TransactionDate;
            def.DebitCreditIndicator = !isReversal ? "D" : "C";
            def.BaseAmount = logDef.BaseAmount;
            def.JournalType = getJournalPrefix(logDef.OfficeId, logDef.TradingAgencyId) + "IN";
            def.Description = logDef.ContractNo + " " + (logDef.Quantity * logDef.PiecesPerPack).ToString() + " PCS";

            if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.ProvisionForFabricLiabilities.GetHashCode())
            {
                def.JournalType = getJournalPrefix(logDef.OfficeId, logDef.TradingAgencyId) + "VJ";
                def.Description = logDef.ContractNo + "-" + logDef.DeliveryNo.ToString().PadLeft(2, '0') + " FL PROV";
            }
            if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.SellingPriceDiscount.GetHashCode())
            {
                def.JournalType = getJournalPrefix(logDef.OfficeId, logDef.TradingAgencyId) + "VJ";
                def.Description = getT9Code(logDef);
            }

            if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.SampleLengthCost.GetHashCode())
                def.Description = "SAMPLELENGTH " + logDef.Quantity.ToString() + " PCS";
            if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.TransportationCost.GetHashCode())
                def.Description = "AIRFREIGHT " + logDef.Quantity.ToString() + " PCS";
            if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.OtherFabricCost.GetHashCode())
                def.Description = getT9Code(logDef) + " " + logDef.ContractNo;
            if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.FinanceCost.GetHashCode())
                def.Description = logDef.ContractNo + " " + vendor.Name;
            if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.GTCommission.GetHashCode())
                def.Description = "GT COMM. " + logDef.Quantity.ToString() + " PCS";
            if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.PackageCost.GetHashCode())
                def.Description = logDef.ContractNo + " " + logDef.Quantity + " " + commonWorker.getPackingUnitByKey(logDef.PackingUnitId).OPSKey;
            if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.DevelopmentSampleCost.GetHashCode()
                || logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.PrintDevCost.GetHashCode())
                def.Description = logDef.ContractNo + " " + logDef.Quantity.ToString() + " PCS";

            if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.ToolingCost.GetHashCode()
                || logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.FragranceCost.GetHashCode()
                || logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.DutyCost.GetHashCode()
                || logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.FreightCost.GetHashCode()
                || logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.DesignFee.GetHashCode())
                def.Description = logDef.ContractNo + "-" + logDef.DeliveryNo.ToString().PadLeft(2, '0');
            def.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
            def.OtherAmount = logDef.OtherAmount;
            if (logDef.OfficeId == OfficeId.SH.Id
                    && (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.MOB.GetHashCode()
                        || logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.QCC.GetHashCode()))
                def.T0 = "SH3F";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.ProvisionForFabricLiabilities.GetHashCode())
                def.T0 = "SL1F";
            else def.T0 = t0;
            def.T1 = getT1Code(logDef);
            def.T2 = generalWorker.getProductCodeDefByKey(logDef.ProductTeamId).Code;
            def.T5 = getT5Code(logDef.SeasonId);
            def.T8 = getT8Code(logDef.ProductId);
            def.T9 = getT9Code(logDef);

            if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.FinanceCost.GetHashCode())
                def.T5 = string.Empty;

            if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.DutyCost.GetHashCode()
                || logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.FreightCost.GetHashCode())
                def.T8 = string.Empty;

            def.OfficeCode = OfficeId.getName(logDef.OfficeId);
            def.TradingAgency = TradingAgencyId.getName(logDef.TradingAgencyId);
            def.PaymentTerm = PaymentTermRef.getDescriptionForSAF(logDef.PaymentTermId);
            safList.Add(def);
            #endregion

            /* TODO:EPICOR */
            GLInterfaceEntry entry = new GLInterfaceEntry();
            entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
            entry.GroupId = EpicorInterfaceWorker.Instance.GLInterfaceFile.getSourceString();
            entry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
            entry.ApplyDate = entry.GroupApplyDate;

            if (isEnableWeek53Handling(logDef, isReversal))
            {
                entry.GroupApplyDate = WK53_APPLY_DATE;
                entry.ApplyDate = WK53_APPLY_DATE;
            }

            entry.DocumentType = GLDocumentTypeEnum.ISAM_OTHER_COST;
            entry.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
            if (logDef.BaseAmount > 0)
                entry.DC = !isReversal ? DCFlag.Debit : DCFlag.Credit;
            else
                entry.DC = !isReversal ? DCFlag.Credit : DCFlag.Debit;
            entry.Amount = Math.Abs(logDef.OtherAmount);
            entry.BaseAmount = Math.Abs(logDef.BaseAmount);
            entry.Qty = logDef.Quantity * logDef.PiecesPerPack;
            entry.LineDescription = logDef.ContractNo + "-" + logDef.DeliveryNo.ToString() + " #" + ProductWorker.Instance.getProductByKey(logDef.ProductId).ItemNo + " " + getT9Code(logDef);
            if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.FabricCostDiscount.GetHashCode())
            {
                ShipmentDef shipmentDef = OrderSelectWorker.Instance.getShipmentByKey(logDef.ShipmentId);
                entry.LineDescription += ("\n" + shipmentDef.NSLRefNo + " FABRIC COST DISCOUNT");
            }

            if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.ClaimsRecovery.GetHashCode()
                || logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.ClaimsRecovery_Specific.GetHashCode()
                || logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.OtherFabricCost.GetHashCode()
                || (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.AirFreightCost.GetHashCode() && logDef.VendorId == 12522)) // Oxford Shirts (BD)
                entry.LineDescription += ("\n" + VendorWorker.Instance.getVendorByKey(logDef.VendorId).Name);

            if (def.AccountCode == "3106318" && logDef.OfficeId == OfficeId.SH.Id)
                //entry.Office = "SH3F";
                entry.Office = "SHCQ"; // 2018-11-15 Teresa Wong
            else
                entry.Office = getT0Code(logDef);
            entry.COA = generalWorker.getEpicorCOA(def.AccountCode);
            entry.IsRecordComplete = false;
            entry.SegmentValue3 = getT1Code(logDef);
            entry.SegmentValue4 = generalWorker.getProductCodeDefByKey(logDef.ProductTeamId).Code;
            entry.SegmentValue5 = getSeasonSegmentValue(logDef.SeasonId);
            if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.FabricCostDiscount.GetHashCode())
                entry.SegmentValue7 = "U";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.SlippageReversal.GetHashCode())
                entry.SegmentValue7 = "RM";
            else
                entry.SegmentValue7 = "NP";

            if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.ClaimsRecovery.GetHashCode() && (logDef.OfficeId == OfficeId.HK.Id || logDef.OfficeId == OfficeId.VN.Id))
                entry.SegmentValue8 = "S";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.ClaimsRecovery_Specific.GetHashCode())
                entry.SegmentValue8 = "S";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.SellingPriceDiscount.GetHashCode())
                entry.SegmentValue8 = "S";
            else
                entry.SegmentValue8 = "G";


            if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.QCC.GetHashCode())
            {
                if (logDef.OfficeId == OfficeId.BD.Id)
                {
                    entry.SegmentValue3 = "383";
                    entry.Office = "BAQH";
                }
                else if (logDef.OfficeId == OfficeId.CA.Id)
                    entry.Office = "HAQH";
                else if (logDef.OfficeId == OfficeId.SH.Id && logDef.CountryOfOriginId == CountryOfOriginRef.eCountryId.Myanmar.GetHashCode())
                {
                    entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, OfficeId.HK.Id).EpicorCompanyId;
                    entry.Office = "HKQH";
                    entry.COA = "1302011"; // C/A NS SH
                    entry.SegmentValue7 = string.Empty;
                }
            }
            if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.QCCMyanmar.GetHashCode())
            {
                if (logDef.OfficeId == OfficeId.HK.Id)
                    entry.Office = "HKQH";
            }


            if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.ProvisionForFabricLiabilities.GetHashCode())
                entry.IsRecordComplete = true;
            EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);


            #region other cost credit entry
            def = (SAFDef)def.Clone();
            def.CreateDate = DateTime.Now;
            if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.AirFreightCost.GetHashCode())
            {
                def.AccountCode = "1412221";
                def.T2 = String.Empty;
                def.T5 = String.Empty;
                def.T8 = String.Empty;
            }
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.ClaimsRecovery.GetHashCode())
            {
                def.AccountCode = "1415201";
                def.T5 = String.Empty;
                def.T8 = vendor.Name;
                def.T9 = logDef.OfficeId == OfficeId.HK.Id ? "Specific" : "General";
            }
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.SellingPriceDiscount.GetHashCode())
            {
                def.T9 = logDef.ContractNo;
                def.AccountCode = "1311306";
            }
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.CourierCostForSample.GetHashCode())
                //def.AccountCode = "4103114";
                def.AccountCode = "3305911";
            // TODO:2016CODE def.AccountCode = "3305911";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.CoverForQuenbyFabric.GetHashCode())
                def.AccountCode = "1415204";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.DesignFee.GetHashCode())
                def.AccountCode = "1412111";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.DevelopmentSampleCost.GetHashCode())
                def.AccountCode = "1412114";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.DutyCost.GetHashCode())
                def.AccountCode = "1412108";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.ProvisionForFabricLiabilities.GetHashCode())
                def.AccountCode = "1415202";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.FinanceCost.GetHashCode())
                def.AccountCode = "1412223";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.FragranceCost.GetHashCode())
                def.AccountCode = "1412112";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.FreightCost.GetHashCode())
                def.AccountCode = "1412107";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.FreightForBodycare.GetHashCode())
                def.AccountCode = "1412115";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.GTCommission.GetHashCode())
                def.AccountCode = "1411161";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.Recovery.GetHashCode())
            {
                def.AccountCode = "1412118";
                def.T8 = vendor.Name;
                def.T9 = "SPECIFIC";
            }
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.KitDevelopmentCost.GetHashCode())
            {
                def.AccountCode = "1412222";
                def.T2 = String.Empty;
                def.T5 = String.Empty;
                def.T8 = String.Empty;
            }
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.OutsideLabTestCost.GetHashCode())
                def.AccountCode = "1412104";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.MarginDifference.GetHashCode())
                def.AccountCode = "1310501";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.OtherFabricCost.GetHashCode())
            {
                def.AccountCode = "1411133";
                def.T1 = String.Empty;
                def.T2 = String.Empty;
                def.T5 = String.Empty;
                def.T8 = String.Empty;
            }
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.PrintDevCost.GetHashCode())
                def.AccountCode = "1412225";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.SampleLengthCost.GetHashCode())
                //def.AccountCode = "4103113";
                def.AccountCode = "3305910";
            //TODO:2016CODE def.AccountCode = "3305910";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.ToolingCost.GetHashCode())
                def.AccountCode = "1412111";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.TransportationCost.GetHashCode())
                def.AccountCode = "1452035";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.PackageCost.GetHashCode())
                def.AccountCode = "1412109";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.QCC.GetHashCode())
                def.AccountCode = "1412224";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.QCCMyanmar.GetHashCode())
                def.AccountCode = "1452037";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.RepairCost.GetHashCode())
                def.AccountCode = "1412105";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.NTN_Recovery.GetHashCode())
                def.AccountCode = "1412117";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.MOB.GetHashCode())
                def.AccountCode = "1412119";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.ForwardingCharge.GetHashCode())
                def.AccountCode = "1412226";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.LicenseCost.GetHashCode())
                def.AccountCode = "1452027";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.TradingAirFreight.GetHashCode())
                def.AccountCode = "1452028";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.ClaimsRecovery_Specific.GetHashCode())
                def.AccountCode = "1452029";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.CoatingCost.GetHashCode())
                def.AccountCode = "1452034";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.FabricCostDiscount.GetHashCode())
            {
                if (logDef.CustomerId == CustomerDef.Id.lm_ted_baker.GetHashCode())
                    def.AccountCode = "3202078";
                else if (logDef.CustomerId == CustomerDef.Id.lm_oasis.GetHashCode())
                    def.AccountCode = "3202102";
                else if (logDef.CustomerId == CustomerDef.Id.lm_label_mix.GetHashCode())
                    entry.COA = "3202128";
                else if (logDef.CustomerId == CustomerDef.Id.lm_little_bird.GetHashCode())
                    entry.COA = "3202154";
                else if (logDef.CustomerId == CustomerDef.Id.lm_myleene_klass.GetHashCode())
                    entry.COA = "3202180";
                else if (logDef.CustomerId == CustomerDef.Id.lm_nine.GetHashCode())
                    entry.COA = "3202208";
                else if (logDef.CustomerId == CustomerDef.Id.lm_mintie.GetHashCode())
                    entry.COA = "3202234";
                else if (logDef.CustomerId == CustomerDef.Id.lm_fat_face.GetHashCode())
                    entry.COA = "3202260";
                else if (logDef.CustomerId == CustomerDef.Id.lm_laura_ashley.GetHashCode())
                    entry.COA = "3202286";
                else if (logDef.CustomerId == CustomerDef.Id.lm_mint_velvet.GetHashCode())
                    entry.COA = "3202338";
                else if (logDef.CustomerId == CustomerDef.Id.lm_hype.GetHashCode())
                    entry.COA = "3202312";

                else
                    def.AccountCode = "3202050";
            }
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.CMPOrderProcessing.GetHashCode())
                def.AccountCode = "1452046";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.CMPQAComm.GetHashCode())
                def.AccountCode = "1452047";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.Slippage.GetHashCode())
                def.AccountCode = "1452038";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.SlippageReversal.GetHashCode())
            {
                if (logDef.CustomerId == CustomerDef.Id.lm_ted_baker.GetHashCode())
                    def.AccountCode = "3202080";
                else if (logDef.CustomerId == CustomerDef.Id.lm_oasis.GetHashCode())
                    def.AccountCode = "3202104";
                else if (logDef.CustomerId == CustomerDef.Id.lm_label_mix.GetHashCode())
                    def.AccountCode = "3202130";
                else if (logDef.CustomerId == CustomerDef.Id.lm_little_bird.GetHashCode())
                    def.AccountCode = "3202156";
                else if (logDef.CustomerId == CustomerDef.Id.lm_myleene_klass.GetHashCode())
                    def.AccountCode = "3202182";
                else if (logDef.CustomerId == CustomerDef.Id.lm_nine.GetHashCode())
                    def.AccountCode = "3202210";
                else if (logDef.CustomerId == CustomerDef.Id.lm_mintie.GetHashCode())
                    def.AccountCode = "3202236";
                else if (logDef.CustomerId == CustomerDef.Id.lm_fat_face.GetHashCode())
                    def.AccountCode = "3202262";
                else if (logDef.CustomerId == CustomerDef.Id.lm_laura_ashley.GetHashCode())
                    def.AccountCode = "3202288";
                else if (logDef.CustomerId == CustomerDef.Id.lm_mint_velvet.GetHashCode())
                    def.AccountCode = "3202340";
                else if (logDef.CustomerId == CustomerDef.Id.lm_hype.GetHashCode())
                    def.AccountCode = "3202314";

                else
                    def.AccountCode = "3202052";
            }

            def.DebitCreditIndicator = !isReversal ? "C" : "D";
            safList.Add(def);
            #endregion

            /* TODO:EPICOR */
            entry = (GLInterfaceEntry)entry.Clone();
            entry.COA = generalWorker.getEpicorCOA(def.AccountCode);

            if (logDef.BaseAmount > 0)
                entry.DC = !isReversal ? DCFlag.Credit : DCFlag.Debit;
            else
                entry.DC = !isReversal ? DCFlag.Debit : DCFlag.Credit;

            if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.QCC.GetHashCode())
            {
                if (logDef.OfficeId == OfficeId.SH.Id)
                {
                    /* 2016-09-20 add new product teams
                    if (shipmentDef.CountryOfOrigin.Code == "KH" && generalWorker.getProductCodeDefByKey(logDef.ProductTeamId).Code == "WJN")
                    */
                    string productTeamCode = generalWorker.getProductCodeDefByKey(logDef.ProductTeamId).Code;
                    //if (logDef.CountryOfOriginId == CountryOfOriginRef.eCountryId.Cambodia.GetHashCode() && (productTeamCode == "WJN" || productTeamCode == "WJEAN"))
                    if (logDef.CountryOfOriginId == CountryOfOriginRef.eCountryId.Cambodia.GetHashCode()) // Requested By Teresa 2017-10-06
                    {
                        entry.COA = "1302110";
                        entry.IsMultiCompany = true;
                        entry.ExternalCompany = "NSCA";
                        entry.ExternalCOA = "1452023";
                        entry.ExternalOffice = "HAQH";
                        entry.ExternalSegmentValue3 = entry.SegmentValue3;
                        entry.ExternalSegmentValue4 = entry.SegmentValue4;
                        entry.ExternalSegmentValue5 = entry.SegmentValue5;
                        entry.ExternalSegmentValue7 = "AR";
                        entry.ExternalSegmentValue8 = "G";
                    }
                    else if (logDef.CountryOfOriginId == CountryOfOriginRef.eCountryId.Myanmar.GetHashCode())
                    {
                        entry.COA = "1452037"; // QCCMyanmar
                        entry.Office = "HKQH";
                        entry.SegmentValue7 = "AR";
                    }
                }

                if (logDef.OfficeId == OfficeId.HK.Id)
                {
                    entry.COA = "1302016";
                    entry.IsMultiCompany = true;
                    entry.ExternalCompany = "NSBD";
                    entry.ExternalCOA = "1452023";
                    entry.ExternalOffice = "BA1F";
                    entry.ExternalSegmentValue3 = entry.SegmentValue3;
                    entry.ExternalSegmentValue4 = entry.SegmentValue4;
                    entry.ExternalSegmentValue5 = entry.SegmentValue5;
                    entry.ExternalSegmentValue7 = "AR";
                    entry.ExternalSegmentValue8 = "G";
                }


            }

            if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.QCCMyanmar.GetHashCode())
            {
                entry.Office = "HKQH";
                if (logDef.OfficeId == OfficeId.HK.Id)
                    entry.SegmentValue7 = "NP";
            }


            if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.Slippage.GetHashCode() && logDef.OfficeId != OfficeId.ND.Id)
            {
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);

                entry = (GLInterfaceEntry)entry.Clone();
                entry.COA = "1452038 ";
                if (logDef.BaseAmount > 0)
                    entry.DC = !isReversal ? DCFlag.Debit : DCFlag.Credit;
                else
                    entry.DC = !isReversal ? DCFlag.Credit : DCFlag.Debit;
                entry.SegmentValue7 = "RM";
                entry.SegmentValue8 = "G";
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);

                entry = (GLInterfaceEntry)entry.Clone();
                entry.COA = "3202052 ";
                if (logDef.BaseAmount > 0)
                    entry.DC = !isReversal ? DCFlag.Credit : DCFlag.Debit;
                else
                    entry.DC = !isReversal ? DCFlag.Debit : DCFlag.Credit;
            }


            if (logDef.OfficeId == OfficeId.SH.Id && logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.QCC.GetHashCode() && logDef.CountryOfOriginId == CountryOfOriginRef.eCountryId.Myanmar.GetHashCode())
            {
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);

                entry = (GLInterfaceEntry)entry.Clone();
                entry.COA = "3202049";
                if (logDef.BaseAmount > 0)
                    entry.DC = !isReversal ? DCFlag.Debit : DCFlag.Credit;
                else
                    entry.DC = !isReversal ? DCFlag.Credit : DCFlag.Debit;
                entry.Office = "HKQH";
                entry.SegmentValue7 = "NP";
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);

                entry = (GLInterfaceEntry)entry.Clone();
                entry.COA = "3202049";
                if (logDef.BaseAmount > 0)
                    entry.DC = !isReversal ? DCFlag.Credit : DCFlag.Debit;
                else
                    entry.DC = !isReversal ? DCFlag.Debit : DCFlag.Credit;
                entry.Office = "HKQC";
                entry.SegmentValue7 = "NP";
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);

                entry = (GLInterfaceEntry)entry.Clone();
                entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, OfficeId.SH.Id).EpicorCompanyId;
                entry.COA = "3202033";
                if (logDef.BaseAmount > 0)
                    entry.DC = !isReversal ? DCFlag.Debit : DCFlag.Credit;
                else
                    entry.DC = !isReversal ? DCFlag.Credit : DCFlag.Debit;
                //entry.Office = "SH2F"; 
                entry.Office = "SHMQ"; // 2018-11-15 Teresa Wong
                entry.SegmentValue7 = "AR";
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);

                entry = (GLInterfaceEntry)entry.Clone();
                entry.IsRecordComplete = true;
                entry.COA = "1302011";
                if (logDef.BaseAmount > 0)
                    entry.DC = !isReversal ? DCFlag.Credit : DCFlag.Debit;
                else
                    entry.DC = !isReversal ? DCFlag.Debit : DCFlag.Credit;
                entry.SegmentValue7 = string.Empty;
                //entry.Office = "SH2F"; 
                entry.Office = "SHMQ"; // 2018-11-15 Teresa Wong
            }

            entry.IsRecordComplete = true;
            if (def.AccountCode == "1311306")
            {
                entry.LineDescription = logDef.ContractNo + "-" + logDef.DeliveryNo.ToString() + "|#" + ProductWorker.Instance.getProductByKey(logDef.ProductId).ItemNo + "|" + getT9Code(logDef) + "|" + vendor.Name;
                /*
                entry.LineDescription += ("\n" + vendor.Name);
                */
            }


            if ((logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.DevelopmentSampleCost.GetHashCode()
                || logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.Recovery.GetHashCode()) && (logDef.OfficeId == OfficeId.CA.Id || logDef.OfficeId == OfficeId.TH.Id))
            {
                entry.COA = logDef.OfficeId == OfficeId.CA.Id ? "1302010" : "1302012";
                entry.SegmentValue3 = string.Empty;
                entry.SegmentValue4 = string.Empty;
                entry.SegmentValue5 = string.Empty;
                entry.SegmentValue6 = string.Empty;
                entry.SegmentValue7 = string.Empty;
                EpicorInterfaceWorker.Instance.addToGLTable(logDef.OfficeId.ToString() + "|" + logDef.CurrencyId.ToString() + "|" + logDef.FiscalYear.ToString() + "|" + logDef.Period.ToString() + "|" + (isReversal ? "True" : "False"), logDef.BaseAmount, logDef.OtherAmount);
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);

                entry = (GLInterfaceEntry)entry.Clone();
                entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, OfficeId.HK.Id).EpicorCompanyId;
                entry.Office = "HK1F";
                if (logDef.BaseAmount > 0)
                    entry.DC = !isReversal ? DCFlag.Credit : DCFlag.Debit;
                else
                    entry.DC = !isReversal ? DCFlag.Debit : DCFlag.Credit;
                entry.COA = generalWorker.getEpicorCOA(logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.DevelopmentSampleCost.GetHashCode() ? "1412114" : "1412118");
                entry.SegmentValue3 = getT1Code(logDef);
                entry.SegmentValue4 = generalWorker.getProductCodeDefByKey(logDef.ProductTeamId).Code;
                entry.SegmentValue5 = getSeasonSegmentValue(logDef.SeasonId);
                entry.SegmentValue7 = "NP";
                if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.ClaimsRecovery.GetHashCode() && (logDef.OfficeId == OfficeId.HK.Id || logDef.OfficeId == OfficeId.VN.Id))
                    entry.SegmentValue8 = "S";
                else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.ClaimsRecovery_Specific.GetHashCode())
                    entry.SegmentValue8 = "S";
                else
                    entry.SegmentValue8 = "G";
                /*
                if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.QCC.GetHashCode() && logDef.OfficeId == OfficeId.BD.Id)
                {
                    ShipmentDef shipmentDef = OrderSelectWorker.Instance.getShipmentByKey(logDef.ShipmentId);
                    entry.SegmentValue6 = shipmentDef.CountryOfOrigin.Code;
                }
                */
                entry.Deferred = 1;
                entry.IsRecordComplete = false;
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);
            }
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.ProvisionForFabricLiabilities.GetHashCode())
            {
                EpicorInterfaceWorker.Instance.addToGLTable(logDef.OfficeId.ToString() + "|" + logDef.CurrencyId.ToString() + "|" + logDef.FiscalYear.ToString() + "|" + logDef.Period.ToString() + "|" + (isReversal ? "True" : "False"), logDef.BaseAmount, logDef.OtherAmount);
            }
            else
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);
        }

        private void addAccrualOtherCostToSAFList(SunInterfaceLogDef logDef, ArrayList safList)
        {
            if (logDef.BaseAmount == 0) return;
            VendorRef vendor = vendorWorker.getVendorByKey(logDef.VendorId);
            string t0 = getT0Code(logDef);
            GLInterfaceEntry entry = new GLInterfaceEntry();

            #region other cost debit entry
            if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.AirFreightCost.GetHashCode())
            {
                if (logDef.CustomerId == CustomerDef.Id.lm_ted_baker.GetHashCode())
                    entry.COA = "3202070";
                else if (logDef.CustomerId == CustomerDef.Id.lm_oasis.GetHashCode())
                    entry.COA = "3202094";
                else
                    entry.COA = "3106310";
            }
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.ClaimsRecovery.GetHashCode())
            {
                if (logDef.CustomerId == CustomerDef.Id.lm_ted_baker.GetHashCode())
                    entry.COA = "3202083";
                else if (logDef.CustomerId == CustomerDef.Id.lm_oasis.GetHashCode())
                    entry.COA = "3202107";
                else
                    entry.COA = "3106317";
            }
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.CourierCostForSample.GetHashCode())
                entry.COA = "3106508";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.CoverForQuenbyFabric.GetHashCode())
                entry.COA = "3106314";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.DesignFee.GetHashCode())
                entry.COA = "3106207";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.DevelopmentSampleCost.GetHashCode())
            {
                if (logDef.CustomerId == CustomerDef.Id.lm_ted_baker.GetHashCode())
                    entry.COA = "3202065";
                else if (logDef.CustomerId == CustomerDef.Id.lm_oasis.GetHashCode())
                    entry.COA = "3202089";
                else
                    entry.COA = "3106119";
            }
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.DutyCost.GetHashCode())
                entry.COA = "3106206";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.ProvisionForFabricLiabilities.GetHashCode())
            {
                if (logDef.CustomerId == CustomerDef.Id.lm_ted_baker.GetHashCode())
                    entry.COA = "3202064";
                else if (logDef.CustomerId == CustomerDef.Id.lm_oasis.GetHashCode())
                    entry.COA = "3202088";
                else
                    entry.COA = "3106312";
            }
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.FinanceCost.GetHashCode())
                entry.COA = "3106311";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.FragranceCost.GetHashCode())
                entry.COA = "3106208";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.FreightCost.GetHashCode())
                entry.COA = "3106205";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.FreightForBodycare.GetHashCode())
                entry.COA = "3108106";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.GTCommission.GetHashCode())
                entry.COA = "3106401";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.Recovery.GetHashCode())
                entry.COA = "3106316";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.KitDevelopmentCost.GetHashCode())
                entry.COA = "3106180";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.OutsideLabTestCost.GetHashCode())
                entry.COA = "3106307";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.MarginDifference.GetHashCode())
                entry.COA = "3106304";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.MOB.GetHashCode())
                entry.COA = "3106320";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.NTN_Recovery.GetHashCode())
                entry.COA = "3106509";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.OtherFabricCost.GetHashCode())
            {
                if (logDef.CustomerId == CustomerDef.Id.lm_ted_baker.GetHashCode())
                    entry.COA = "3202068";
                else if (logDef.CustomerId == CustomerDef.Id.lm_oasis.GetHashCode())
                    entry.COA = "3202092";
                else
                    entry.COA = "3106102";
            }
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.PackageCost.GetHashCode())
                entry.COA = "3106107";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.PrintDevCost.GetHashCode())
            {
                if (logDef.CustomerId == CustomerDef.Id.lm_ted_baker.GetHashCode())
                    entry.COA = "3202073";
                else if (logDef.CustomerId == CustomerDef.Id.lm_oasis.GetHashCode())
                    entry.COA = "3202097";
                else
                    entry.COA = "3106303";
            }
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.QCC.GetHashCode())
            {
                if (logDef.CustomerId == CustomerDef.Id.lm_ted_baker.GetHashCode())
                    entry.COA = "3202084";
                else if (logDef.CustomerId == CustomerDef.Id.lm_oasis.GetHashCode())
                    entry.COA = "3202108";
                else
                    entry.COA = "3106318";
            }
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.QCCMyanmar.GetHashCode())
            {
                if (logDef.CustomerId == CustomerDef.Id.lm_ted_baker.GetHashCode())
                    entry.COA = "3202086";
                else if (logDef.CustomerId == CustomerDef.Id.lm_oasis.GetHashCode())
                    entry.COA = "3202110";
                else
                    entry.COA = "3202049";
            }
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.RepairCost.GetHashCode())
            {
                if (logDef.CustomerId == CustomerDef.Id.lm_ted_baker.GetHashCode())
                    entry.COA = "3202076";
                else if (logDef.CustomerId == CustomerDef.Id.lm_oasis.GetHashCode())
                    entry.COA = "3202100";
                else
                    entry.COA = "3106305";
            }
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.SampleLengthCost.GetHashCode())
            {
                if (logDef.CustomerId == CustomerDef.Id.lm_ted_baker.GetHashCode())
                    entry.COA = "3202077";
                else if (logDef.CustomerId == CustomerDef.Id.lm_oasis.GetHashCode())
                    entry.COA = "3202101";
                else
                    entry.COA = "3106118";
            }
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.ToolingCost.GetHashCode())
                entry.COA = "3106207";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.TransportationCost.GetHashCode())
                entry.COA = "3202044";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.SellingPriceDiscount.GetHashCode())
            {
                if (logDef.CustomerId == CustomerDef.Id.lm_ted_baker.GetHashCode())
                    entry.COA = "3202067";
                else if (logDef.CustomerId == CustomerDef.Id.lm_oasis.GetHashCode())
                    entry.COA = "3202091";
                else
                    entry.COA = "3106309";
            }
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.ForwardingCharge.GetHashCode())
            {
                if (logDef.CustomerId == CustomerDef.Id.lm_ted_baker.GetHashCode())
                    entry.COA = "3202071";
                else if (logDef.CustomerId == CustomerDef.Id.lm_oasis.GetHashCode())
                    entry.COA = "3202095";
                else
                    entry.COA = "3106321";
            }
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.LicenseCost.GetHashCode())
                entry.COA = "3202040";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.TradingAirFreight.GetHashCode())
            {
                if (logDef.CustomerId == CustomerDef.Id.lm_ted_baker.GetHashCode())
                    entry.COA = "3202072";
                else if (logDef.CustomerId == CustomerDef.Id.lm_oasis.GetHashCode())
                    entry.COA = "3202096";
                else
                    entry.COA = "3202041";
            }
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.ClaimsRecovery_Specific.GetHashCode())
            {
                if (logDef.CustomerId == CustomerDef.Id.lm_ted_baker.GetHashCode())
                    entry.COA = "3202075";
                else if (logDef.CustomerId == CustomerDef.Id.lm_oasis.GetHashCode())
                    entry.COA = "3202099";
                else
                    entry.COA = "3202042";
            }
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.CoatingCost.GetHashCode())
                entry.COA = "3202043";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.FabricCostDiscount.GetHashCode())
                entry.COA = "1415202";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.Slippage.GetHashCode())
            {
                if (logDef.CustomerId == CustomerDef.Id.lm_ted_baker.GetHashCode())
                    entry.COA = "3202079";
                else if (logDef.CustomerId == CustomerDef.Id.lm_oasis.GetHashCode())
                    entry.COA = "3202103";
                else
                    entry.COA = "3202051";
            }
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.CMPOrderProcessing.GetHashCode())
                entry.COA = "3202190";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.CMPQAComm.GetHashCode())
                entry.COA = "3202191";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.SlippageReversal.GetHashCode())
                entry.COA = "1452038";

            entry.Reverse = true;
            entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
            entry.GroupId = EpicorInterfaceWorker.Instance.GLInterfaceFile.getSourceString();
            entry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
            entry.ApplyDate = entry.GroupApplyDate;
            entry.DocumentType = GLDocumentTypeEnum.ISAM_OTHER_COST;
            entry.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
            if (logDef.BaseAmount > 0)
                entry.DC = DCFlag.Debit;
            else
                entry.DC = DCFlag.Credit;
            entry.Amount = Math.Abs(logDef.OtherAmount);
            entry.BaseAmount = Math.Abs(logDef.BaseAmount);
            entry.Qty = logDef.Quantity * logDef.PiecesPerPack;
            entry.LineDescription = logDef.ContractNo + "-" + logDef.DeliveryNo.ToString();
            if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.FabricCostDiscount.GetHashCode())
            {
                ShipmentDef shipmentDef = OrderSelectWorker.Instance.getShipmentByKey(logDef.ShipmentId);
                entry.LineDescription = logDef.ContractNo + "-" + logDef.DeliveryNo.ToString() + " " + shipmentDef.NSLRefNo + " FABRIC COST DISCOUNT";
            }

            if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.ClaimsRecovery.GetHashCode()
                || logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.ClaimsRecovery_Specific.GetHashCode()
                || (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.AirFreightCost.GetHashCode() && logDef.VendorId == 12522)) // Oxford Shirts (BD)
                entry.LineDescription += ("\n" + VendorWorker.Instance.getVendorByKey(logDef.VendorId).Name);

            if (entry.COA == "3106318" && logDef.OfficeId == OfficeId.SH.Id)
                //entry.Office = "SH3F";
                entry.Office = "SHCQ"; // 2018-11-15 Teresa WOng
            else
                entry.Office = getT0Code(logDef);
            entry.COA = generalWorker.getEpicorCOA(entry.COA);
            entry.IsRecordComplete = false;
            entry.SegmentValue3 = getT1Code(logDef);
            entry.SegmentValue4 = generalWorker.getProductCodeDefByKey(logDef.ProductTeamId).Code;
            entry.SegmentValue5 = getSeasonSegmentValue(logDef.SeasonId);
            if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.FabricCostDiscount.GetHashCode())
                entry.SegmentValue7 = "U";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.SlippageReversal.GetHashCode())
                entry.SegmentValue7 = "RM";
            else
                entry.SegmentValue7 = "NP";

            if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.ClaimsRecovery.GetHashCode() && (logDef.OfficeId == OfficeId.HK.Id || logDef.OfficeId == OfficeId.VN.Id))
                entry.SegmentValue8 = "S";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.ClaimsRecovery_Specific.GetHashCode())
                entry.SegmentValue8 = "S";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.SellingPriceDiscount.GetHashCode())
                entry.SegmentValue8 = "S";
            else
                entry.SegmentValue8 = "G";

            if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.QCC.GetHashCode())
            {
                if (logDef.OfficeId == OfficeId.BD.Id)
                {
                    entry.SegmentValue3 = "383";
                    entry.Office = "BAQH";
                }
                else if (logDef.OfficeId == OfficeId.CA.Id)
                    entry.Office = "HAQH";
                else if (logDef.OfficeId == OfficeId.SH.Id && logDef.CountryOfOriginId == CountryOfOriginRef.eCountryId.Myanmar.GetHashCode())
                {
                    entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, OfficeId.HK.Id).EpicorCompanyId;
                    entry.Office = "HKQH";
                    entry.COA = "1302011"; // C/A NS SH
                    entry.SegmentValue7 = string.Empty;
                }
            }

            if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.QCCMyanmar.GetHashCode())
            {
                if (logDef.OfficeId == OfficeId.HK.Id)
                    entry.Office = "HKQH";
            }

            EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);
            #endregion


            #region other cost credit entry
            entry = (GLInterfaceEntry)entry.Clone();
            if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.AirFreightCost.GetHashCode())
                entry.COA = "1412221";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.ClaimsRecovery.GetHashCode())
                entry.COA = "1415201";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.CourierCostForSample.GetHashCode())
                entry.COA = "3305911";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.CoverForQuenbyFabric.GetHashCode())
                entry.COA = "1415204";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.DesignFee.GetHashCode())
                entry.COA = "1412111";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.DevelopmentSampleCost.GetHashCode())
                entry.COA = "1412114";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.DutyCost.GetHashCode())
                entry.COA = "1412108";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.ProvisionForFabricLiabilities.GetHashCode())
                entry.COA = "1415202";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.FinanceCost.GetHashCode())
                entry.COA = "1412223";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.FragranceCost.GetHashCode())
                entry.COA = "1412112";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.FreightCost.GetHashCode())
                entry.COA = "1412107";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.FreightForBodycare.GetHashCode())
                entry.COA = "1412115";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.GTCommission.GetHashCode())
                entry.COA = "1411161";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.ForwardingCharge.GetHashCode())
                entry.COA = "1412226";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.LicenseCost.GetHashCode())
                entry.COA = "1452027";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.TradingAirFreight.GetHashCode())
                entry.COA = "1452028";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.ClaimsRecovery_Specific.GetHashCode())
                entry.COA = "1452029";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.CoatingCost.GetHashCode())
                entry.COA = "1452034";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.Recovery.GetHashCode())
                entry.COA = "1412118";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.KitDevelopmentCost.GetHashCode())
                entry.COA = "1412222";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.OutsideLabTestCost.GetHashCode())
                entry.COA = "1412104";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.MarginDifference.GetHashCode())
                entry.COA = "1310501";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.MOB.GetHashCode())
                entry.COA = "1412119";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.NTN_Recovery.GetHashCode())
                entry.COA = "1412117";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.OtherFabricCost.GetHashCode())
                entry.COA = "1411133";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.PackageCost.GetHashCode())
                entry.COA = "1412109";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.PrintDevCost.GetHashCode())
                entry.COA = "1412225";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.QCC.GetHashCode())
                entry.COA = "1412224";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.QCCMyanmar.GetHashCode())
                entry.COA = "1452037";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.RepairCost.GetHashCode())
                entry.COA = "1412105";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.SampleLengthCost.GetHashCode())
                entry.COA = "3305910";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.ToolingCost.GetHashCode())
                entry.COA = "1412111";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.TransportationCost.GetHashCode())
                entry.COA = "1452035";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.SellingPriceDiscount.GetHashCode())
                entry.COA = "1412106";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.FabricCostDiscount.GetHashCode())
            {
                if (logDef.CustomerId == CustomerDef.Id.lm_ted_baker.GetHashCode())
                    entry.COA = "3202078";
                else if (logDef.CustomerId == CustomerDef.Id.lm_oasis.GetHashCode())
                    entry.COA = "3202102";
                else if (logDef.CustomerId == CustomerDef.Id.lm_label_mix.GetHashCode())
                    entry.COA = "3202128";
                else if (logDef.CustomerId == CustomerDef.Id.lm_little_bird.GetHashCode())
                    entry.COA = "3202154";
                else if (logDef.CustomerId == CustomerDef.Id.lm_myleene_klass.GetHashCode())
                    entry.COA = "3202180";
                else if (logDef.CustomerId == CustomerDef.Id.lm_nine.GetHashCode())
                    entry.COA = "3202208";
                else if (logDef.CustomerId == CustomerDef.Id.lm_mintie.GetHashCode())
                    entry.COA = "3202234";
                else if (logDef.CustomerId == CustomerDef.Id.lm_fat_face.GetHashCode())
                    entry.COA = "3202260";
                else if (logDef.CustomerId == CustomerDef.Id.lm_laura_ashley.GetHashCode())
                    entry.COA = "3202286";
                else if (logDef.CustomerId == CustomerDef.Id.lm_mint_velvet.GetHashCode())
                    entry.COA = "3202338";
                else if (logDef.CustomerId == CustomerDef.Id.lm_hype.GetHashCode())
                    entry.COA = "3202312";

                else
                    entry.COA = "3202050";
            }
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.CMPOrderProcessing.GetHashCode())
                entry.COA = "1452046";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.CMPQAComm.GetHashCode())
                entry.COA = "1452047";

            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.Slippage.GetHashCode())
                entry.COA = "1452038";
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.SlippageReversal.GetHashCode())
            {
                if (logDef.CustomerId == CustomerDef.Id.lm_ted_baker.GetHashCode())
                    entry.COA = "3202080";
                else if (logDef.CustomerId == CustomerDef.Id.lm_oasis.GetHashCode())
                    entry.COA = "3202104";
                else if (logDef.CustomerId == CustomerDef.Id.lm_label_mix.GetHashCode())
                    entry.COA = "3202130";
                else if (logDef.CustomerId == CustomerDef.Id.lm_little_bird.GetHashCode())
                    entry.COA = "3202156";
                else if (logDef.CustomerId == CustomerDef.Id.lm_myleene_klass.GetHashCode())
                    entry.COA = "3202182";
                else if (logDef.CustomerId == CustomerDef.Id.lm_nine.GetHashCode())
                    entry.COA = "3202210";
                else if (logDef.CustomerId == CustomerDef.Id.lm_mintie.GetHashCode())
                    entry.COA = "3202236";
                else if (logDef.CustomerId == CustomerDef.Id.lm_fat_face.GetHashCode())
                    entry.COA = "3202262";
                else if (logDef.CustomerId == CustomerDef.Id.lm_laura_ashley.GetHashCode())
                    entry.COA = "3202288";
                else if (logDef.CustomerId == CustomerDef.Id.lm_mint_velvet.GetHashCode())
                    entry.COA = "3202340";
                else if (logDef.CustomerId == CustomerDef.Id.lm_hype.GetHashCode())
                    entry.COA = "3202314";

                else
                    entry.COA = "3202052";
            }

            entry.COA = generalWorker.getEpicorCOA(entry.COA);
            if (logDef.BaseAmount > 0)
                entry.DC = DCFlag.Credit;
            else
                entry.DC = DCFlag.Debit;

            if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.QCC.GetHashCode())
            {
                if (logDef.OfficeId == OfficeId.SH.Id)
                {
                    if (logDef.CountryOfOriginId == CountryOfOriginRef.eCountryId.Cambodia.GetHashCode())
                    {
                        entry.COA = "1302110";
                    }
                    else if (logDef.CountryOfOriginId == CountryOfOriginRef.eCountryId.Myanmar.GetHashCode())
                    {
                        entry.COA = "1452037"; // QCCMyanmar
                        entry.Office = "HKQH";
                        entry.SegmentValue7 = "AR";
                    }
                }
            }

            if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.QCCMyanmar.GetHashCode())
            {
                entry.Office = "HKQH";
                if (logDef.OfficeId == OfficeId.HK.Id)
                    entry.SegmentValue7 = "NP";
            }

            if (logDef.OfficeId == OfficeId.SH.Id && logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.QCC.GetHashCode() && logDef.CountryOfOriginId == CountryOfOriginRef.eCountryId.Myanmar.GetHashCode())
            {
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);

                entry = (GLInterfaceEntry)entry.Clone();
                entry.COA = "3202049";
                if (logDef.BaseAmount > 0)
                    entry.DC = DCFlag.Debit;
                else
                    entry.DC = DCFlag.Credit;
                entry.Office = "HKQH";
                entry.SegmentValue7 = "NP";
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);

                entry = (GLInterfaceEntry)entry.Clone();
                entry.COA = "3202049";
                if (logDef.BaseAmount > 0)
                    entry.DC = DCFlag.Credit;
                else
                    entry.DC = DCFlag.Debit;
                entry.Office = "HKQC";
                entry.SegmentValue7 = "NP";
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);

                entry = (GLInterfaceEntry)entry.Clone();
                entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, OfficeId.SH.Id).EpicorCompanyId;
                entry.COA = "3202033";
                if (logDef.BaseAmount > 0)
                    entry.DC = DCFlag.Debit;
                else
                    entry.DC = DCFlag.Credit;
                //entry.Office = "SH2F";
                entry.Office = "SHMQ"; // 2018-11-15 Teresa Wong
                entry.SegmentValue7 = "AR";
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);

                entry = (GLInterfaceEntry)entry.Clone();
                entry.COA = "1302011";
                if (logDef.BaseAmount > 0)
                    entry.DC = DCFlag.Credit;
                else
                    entry.DC = DCFlag.Debit;
                //entry.Office = "SH2F";
                entry.Office = "SHMQ"; // 2018-11-15 Teresa Wong
                entry.SegmentValue7 = string.Empty;
            }

            if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.Slippage.GetHashCode() && logDef.OfficeId != OfficeId.ND.Id)
            {
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);

                entry = (GLInterfaceEntry)entry.Clone();
                entry.COA = "1452038 ";
                if (logDef.BaseAmount > 0)
                    entry.DC = DCFlag.Debit;
                else
                    entry.DC = DCFlag.Credit;

                entry.SegmentValue7 = "RM";
                entry.SegmentValue8 = "G";
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);

                entry = (GLInterfaceEntry)entry.Clone();
                entry.COA = "3202052 ";
                if (logDef.BaseAmount > 0)
                    entry.DC = DCFlag.Credit;
                else
                    entry.DC = DCFlag.Debit;
            }

            entry.IsRecordComplete = true;
            EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);

            #endregion
        }

        private void addActualAPAdjustmentToSAFList(SunInterfaceLogDef logDef, ArrayList safList)
        {
            VendorRef vendor = vendorWorker.getVendorByKey(logDef.VendorId);
            string t0 = getT0Code(logDef);

            AdjustmentDetailDef adjDetailDef = this.getAdjustmentDetailByKey(int.Parse(logDef.ReferenceNo));
            AdjustmentNoteDef adjNoteDef = this.GetAdjustmentNoteByKey(adjDetailDef.AdjustmentNoteId);
            InvoiceDef invoiceDef = ShippingWorker.Instance.getInvoiceByKey(adjDetailDef.ShipmentId);
            ShipmentDef shipmentDef = OrderSelectWorker.Instance.getShipmentByKey(adjDetailDef.ShipmentId);
            ContractDef contractDef = OrderSelectWorker.Instance.getContractByKey(shipmentDef.ContractId);

            APInvoiceInterfaceEntry coreEntry = new APInvoiceInterfaceEntry();
            APInvoiceInterfaceEntry entry = new APInvoiceInterfaceEntry();
            if (logDef.CustomerId == CustomerDef.Id.japan.GetHashCode())
                entry.COA = "3106108";
            else if (logDef.CustomerId == CustomerDef.Id.middleeast.GetHashCode())
                entry.COA = "3106109";
            else if (logDef.CustomerId == CustomerDef.Id.lipsy.GetHashCode())
                entry.COA = "3106112";
            else if (logDef.CustomerId == CustomerDef.Id.gt.GetHashCode())
                entry.COA = "3106124";
            else if (logDef.CustomerId == CustomerDef.Id.days.GetHashCode())
                entry.COA = "3106125";
            else if (logDef.CustomerId == CustomerDef.Id.ezibuy.GetHashCode())
                entry.COA = "3106126";
            else if (logDef.CustomerId == CustomerDef.Id.bravado.GetHashCode())
                entry.COA = "3106160";
            else if (logDef.TermOfPurchaseId == TermOfPurchaseRef.Id.FOB_UT.GetHashCode())
                entry.COA = "3106121";
            else if (logDef.CustomerId == CustomerDef.Id.choice.GetHashCode())
                entry.COA = "3106130";
            else if (logDef.CustomerId == CustomerDef.Id.fabric_flavours.GetHashCode())
                entry.COA = "3101160";
            else if (logDef.CustomerId == CustomerDef.Id.global_licensing.GetHashCode())
                entry.COA = "3106530";
            else if (logDef.CustomerId == CustomerDef.Id.blues_clothing.GetHashCode())
                entry.COA = "3101140";
            else if (logDef.CustomerId == CustomerDef.Id.william_lamb.GetHashCode())
                entry.COA = "3101150";
            else if (logDef.CustomerId == CustomerDef.Id.bioworld.GetHashCode())
                entry.COA = "3101190";
            else if (logDef.CustomerId == CustomerDef.Id.paul_dennicci.GetHashCode())
                entry.COA = "3101210";
            else if (logDef.CustomerId == CustomerDef.Id.cortina.GetHashCode())
                entry.COA = "3101260";
            else if (logDef.CustomerId == CustomerDef.Id.sicem.GetHashCode())
                entry.COA = "3101270";
            else if (logDef.CustomerId == CustomerDef.Id.cooneen.GetHashCode())
                entry.COA = "3101280";
            else if (logDef.CustomerId == CustomerDef.Id.forever_new.GetHashCode())
                entry.COA = "3101250";
            else if (logDef.CustomerId == CustomerDef.Id.poetic_brands.GetHashCode())
                entry.COA = "3101240";
            else if (logDef.CustomerId == CustomerDef.Id.difuzed.GetHashCode())
                entry.COA = "3101220";
            else if (logDef.CustomerId == CustomerDef.Id.difuzed.GetHashCode())
                entry.COA = "3101180";
            else if (logDef.CustomerId == CustomerDef.Id.tvm_fashion.GetHashCode())
                entry.COA = "3101170";
            else if (logDef.CustomerId == CustomerDef.Id.brand_international.GetHashCode())
                entry.COA = "3101200";
            else if (logDef.CustomerId == CustomerDef.Id.brand_design.GetHashCode())
                entry.COA = "3101230";
            else if (logDef.CustomerId == CustomerDef.Id.brand_alliance.GetHashCode())
                entry.COA = "3101130";
            else if (logDef.CustomerId == CustomerDef.Id.fashionUK.GetHashCode())
                entry.COA = "3106501";
            else if (logDef.CustomerId == CustomerDef.Id.misirli.GetHashCode())
                entry.COA = "3106540";
            else if (logDef.CustomerId == CustomerDef.Id.smithbrooks.GetHashCode())
                entry.COA = "3106190";
            else if (logDef.CustomerId == CustomerDef.Id.aykroyd_sons.GetHashCode())
                entry.COA = "3101120";
            else if (logDef.CustomerId == CustomerDef.Id.lm_ted_baker.GetHashCode())
                entry.COA = "3201013";
            else if (logDef.CustomerId == CustomerDef.Id.lm_oasis.GetHashCode())
                entry.COA = "3201014";
            else if (logDef.CustomerId == CustomerDef.Id.lm_label_mix.GetHashCode())
                entry.COA = "3201015";
            else if (logDef.CustomerId == CustomerDef.Id.lm_little_bird.GetHashCode())
                entry.COA = "3201016";
            else if (logDef.CustomerId == CustomerDef.Id.lm_myleene_klass.GetHashCode())
                entry.COA = "3201017";
            else if (logDef.CustomerId == CustomerDef.Id.lm_nine.GetHashCode())
                entry.COA = "3201018";
            else if (logDef.CustomerId == CustomerDef.Id.lm_mintie.GetHashCode())
                entry.COA = "3201019";
            else if (logDef.CustomerId == CustomerDef.Id.lm_fat_face.GetHashCode())
                entry.COA = "3201021";
            else if (logDef.CustomerId == CustomerDef.Id.lm_laura_ashley.GetHashCode())
                entry.COA = "3201022";
            else if (logDef.CustomerId == CustomerDef.Id.lm_mint_velvet.GetHashCode())
                entry.COA = "3201024";
            else if (logDef.CustomerId == CustomerDef.Id.lm_hype.GetHashCode())
                entry.COA = "3201023";


            /*
            else if (logDef.WithOPRFabric == 1 || logDef.WithOPRFabric == 3)
                entry.COA = "1320131";
            */
            else if (logDef.CustomerId == CustomerDef.Id.hempel.GetHashCode() && logDef.CurrencyId == CurrencyId.USD.Id)
                entry.COA = "3106121";

            else if (logDef.CustomerId == CustomerDef.Id.ns_led.GetHashCode() || logDef.CustomerId == CustomerDef.Id.manu_led.GetHashCode())
            {
                /*
                if (commonWorker.getNSLedSelfBilledSupplierCodeList().Contains(contractDef.UKSupplierCode))
                    entry.COA = "3201012";
                else
                    entry.COA = "1210011";
                */
                if (logDef.IsSampleOrder)
                    entry.COA = "3106101";
                else
                    entry.COA = "1210011"; // same as non-duty 2021-05-18
            }
            else
                entry.COA = "3106101";

            entry.COA = generalWorker.getEpicorCOA(entry.COA);
            entry.GroupId = EpicorInterfaceWorker.Instance.APInvoiceInterfaceFile.getSourceString();
            entry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
            entry.ApplyDate = entry.GroupApplyDate;

            if (isEnableWeek53Handling(logDef, false))
            {
                entry.GroupApplyDate = WK53_APPLY_DATE;
                entry.ApplyDate = WK53_APPLY_DATE;
            }

            entry.DocumentType = logDef.BaseAmount > 0 ? APInvoiceDocumentTypeEnum.ISAM_DEBIT_NOTE : APInvoiceDocumentTypeEnum.ISAM_CREDIT_NOTE;
            entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
            entry.Office = getT0Code(logDef);
            entry.SupplierId = vendorWorker.getVendorByKey(logDef.VendorId).EpicorSupplierId;
            entry.LineDescription = logDef.ContractNo + "-" + logDef.DeliveryNo.ToString() + " " + getT9Code(logDef);
            entry.Currency = CurrencyId.getCommonName(logDef.CurrencyId);
            entry.Amount = Math.Abs(logDef.OtherAmount);
            entry.UnitCost = Math.Abs(logDef.OtherAmount) + Math.Abs(adjDetailDef.QACommissionAmount) + Math.Abs(adjDetailDef.VendorPaymentDiscountAmount) + Math.Abs(adjDetailDef.LabTestIncome);
            entry.ItemNo = ProductWorker.Instance.getProductByKey(logDef.ProductId).ItemNo;
            entry.PaymentTerm = PaymentTermRef.getDescriptionForSAF(logDef.PaymentTermId) == "OA" ? "IN14" : "IN30";
            entry.SegmentValue3 = getT1Code(logDef);
            entry.SegmentValue4 = generalWorker.getProductCodeDefByKey(logDef.ProductTeamId).Code;
            entry.SegmentValue5 = getSeasonSegmentValue(logDef.SeasonId);
            entry.InvoiceNo = logDef.DebitCreditNoteNo;
            entry.RealInvoiceNo = entry.InvoiceNo;
            entry.LegalNumber = entry.InvoiceNo;
            entry.InvoiceDate = logDef.TransactionDate;
            entry.IsDebitNote = (logDef.BaseAmount > 0);
            entry.IsRecordComplete = false;
            coreEntry = entry;

            if (Math.Abs(adjDetailDef.QACommissionAmount) > 0)
            {
                entry = (APInvoiceInterfaceEntry)entry.Clone();
                entry.UnitCost = Math.Abs(adjDetailDef.QACommissionAmount) * ((adjDetailDef.SettledAmount != adjDetailDef.LatestAmount) ? -1 : 1);
                entry.COA = generalWorker.getEpicorCOA("2102111");
                if ((contractDef.Customer.CustomerId == CustomerDef.Id.ns_led.GetHashCode() || contractDef.Customer.CustomerId == CustomerDef.Id.manu_led.GetHashCode())
                    && logDef.IsSampleOrder == false)
                {
                    entry.COA = "1452044";
                }
                EpicorInterfaceWorker.Instance.APInvoiceInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);
            }

            if (Math.Abs(adjDetailDef.VendorPaymentDiscountAmount) > 0)
            {
                entry = (APInvoiceInterfaceEntry)entry.Clone();
                entry.UnitCost = Math.Abs(adjDetailDef.VendorPaymentDiscountAmount) * ((adjDetailDef.SettledAmount != adjDetailDef.LatestAmount) ? -1 : 1);

                if (logDef.OfficeId == OfficeId.TR.Id || logDef.OfficeId == OfficeId.EG.Id || logDef.OfficeId == OfficeId.PK.Id || logDef.OfficeId == OfficeId.MA.Id)
                    entry.COA = generalWorker.getEpicorCOA("2102301");
                else
                    entry.COA = generalWorker.getEpicorCOA("2102301");

                if ((contractDef.Customer.CustomerId == CustomerDef.Id.ns_led.GetHashCode() || contractDef.Customer.CustomerId == CustomerDef.Id.manu_led.GetHashCode())
                    && logDef.IsSampleOrder == false)
                {
                    /*
                    if (commonWorker.getNSLedSelfBilledSupplierCodeList().Contains(contractDef.UKSupplierCode))
                        entry.COA = "2515030";
                    else
                        entry.COA = "1452039";
                    */
                    entry.COA = "1452039"; // duty same as non-duty 2021-05-18
                }
                EpicorInterfaceWorker.Instance.APInvoiceInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);
            }

            if (Math.Abs(adjDetailDef.LabTestIncome) > 0)
            {
                entry = (APInvoiceInterfaceEntry)entry.Clone();
                entry.UnitCost = Math.Abs(adjDetailDef.LabTestIncome) * ((adjDetailDef.SettledAmount != adjDetailDef.LatestAmount) ? -1 : 1);
                entry.COA = generalWorker.getEpicorCOA("2102114");
                if ((contractDef.Customer.CustomerId == CustomerDef.Id.ns_led.GetHashCode() || contractDef.Customer.CustomerId == CustomerDef.Id.manu_led.GetHashCode())
                    && logDef.IsSampleOrder == false)
                {
                    entry.COA = "1452043";
                }
                EpicorInterfaceWorker.Instance.APInvoiceInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);
            }

            coreEntry.IsRecordComplete = true;
            if (adjDetailDef.SettledAmount != adjDetailDef.LatestAmount)
                EpicorInterfaceWorker.Instance.APInvoiceInterfaceFile.Entries.Add((IEpicorInterfaceEntry)coreEntry);

            bool isReversal = adjNoteDef.DebitCreditIndicator == "C" ? false : true;
            GLInterfaceEntry glEntry = new GLInterfaceEntry();

            // ns-led freight & stock provision one-off when shipped
            if ((logDef.CustomerId == CustomerDef.Id.ns_led.GetHashCode() || logDef.CustomerId == CustomerDef.Id.manu_led.GetHashCode()))
            {
                bool isDuty = commonWorker.getNSLedSelfBilledSupplierCodeList().Contains(contractDef.UKSupplierCode);
                ProductDef product = ProductWorker.Instance.getProductByKey(logDef.ProductId);

                decimal actualFreightUnitCostInUSD = this.getRangePlanActualFreightUnitCostInUSD(logDef.OfficeId, product.ItemNo, this.getNSLedRangePlanSeasonIdByDeliveryDate(logDef.OfficeId, product.ItemNo, shipmentDef.CustomerAgreedAtWarehouseDate));

                glEntry = new GLInterfaceEntry();
                glEntry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
                glEntry.GroupId = EpicorInterfaceWorker.Instance.GLInterfaceFile.getSourceString();
                glEntry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                glEntry.ApplyDate = glEntry.GroupApplyDate;

                if (isEnableWeek53Handling(logDef, isReversal))
                {
                    glEntry.GroupApplyDate = WK53_APPLY_DATE;
                    glEntry.ApplyDate = WK53_APPLY_DATE;
                }

                glEntry.DocumentType = GLDocumentTypeEnum.GL;
                glEntry.CurrencyCode = CurrencyId.getCommonName(CurrencyId.USD.Id);
                glEntry.DC = !isReversal ? DCFlag.Debit : DCFlag.Credit;
                glEntry.Qty = logDef.Quantity * logDef.PiecesPerPack;
                glEntry.Amount = Math.Round(actualFreightUnitCostInUSD * logDef.Quantity, 2, MidpointRounding.AwayFromZero);
                glEntry.BaseAmount = glEntry.Amount;
                glEntry.LineDescription = product.ItemNo + " #" + logDef.ContractNo + "-" + logDef.DeliveryNo.ToString() + " P" + logDef.FiscalYear.ToString() + " " + logDef.Period.ToString().PadLeft(2, '0') + " SALES SETUP " + (isDuty ? "DUTY" : "NON-DUTY");
                glEntry.Office = getT0Code(logDef);
                glEntry.COA = "1210012";
                glEntry.IsRecordComplete = false;
                glEntry.SegmentValue3 = getT1Code(logDef);
                glEntry.SegmentValue4 = generalWorker.getProductCodeDefByKey(logDef.ProductTeamId).Code;
                glEntry.SegmentValue5 = getSeasonSegmentValue(logDef.SeasonId);
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                glEntry = (GLInterfaceEntry)glEntry.Clone();
                glEntry.DC = !isReversal ? DCFlag.Credit : DCFlag.Debit;
                glEntry.COA = "1452040";
                glEntry.IsRecordComplete = true;
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                decimal dutyPercent = this.getRangePlanDutyPercent(logDef.OfficeId, product.ItemNo, this.getNSLedRangePlanSeasonIdByDeliveryDate(logDef.OfficeId, product.ItemNo, shipmentDef.CustomerAgreedAtWarehouseDate));

                if (isDuty)
                {
                    glEntry = (GLInterfaceEntry)glEntry.Clone();
                    glEntry.DC = !isReversal ? DCFlag.Debit : DCFlag.Credit;
                    glEntry.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
                    glEntry.COA = "1210013";
                    glEntry.Amount = logDef.OtherAmount * dutyPercent / 100.0m;
                    glEntry.BaseAmount = Math.Round(glEntry.Amount * commonWorker.getExchangeRate(ExchangeRateType.INVOICE, logDef.CurrencyId, glEntry.ApplyDate) / commonWorker.getExchangeRate(ExchangeRateType.INVOICE, CurrencyId.USD.Id, glEntry.ApplyDate), 2, MidpointRounding.AwayFromZero);
                    glEntry.IsRecordComplete = false;
                    EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                    glEntry = (GLInterfaceEntry)glEntry.Clone();
                    glEntry.DC = !isReversal ? DCFlag.Credit : DCFlag.Debit;
                    glEntry.COA = "1452041";
                    glEntry.IsRecordComplete = true;
                    EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);
                }

                if (logDef.VendorId == 3154 && adjDetailDef.LabTestIncome == 0) // NML , requested by winnie @2021-04-27
                {
                    adjDetailDef.LabTestIncome = Math.Round(logDef.Quantity * 0.03m, 2, MidpointRounding.AwayFromZero);
                }

                glEntry = (GLInterfaceEntry)glEntry.Clone();
                glEntry.DC = !isReversal ? DCFlag.Debit : DCFlag.Credit;
                glEntry.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
                glEntry.COA = "3403020";
                glEntry.Amount = Math.Abs(adjDetailDef.LatestAmount) - Math.Abs(adjDetailDef.QACommissionAmount) - Math.Abs(adjDetailDef.VendorPaymentDiscountAmount) - Math.Abs(adjDetailDef.LatestAmount)
                                + (adjDetailDef.LatestAmount * dutyPercent / 100.0m)
                                + Math.Round(actualFreightUnitCostInUSD * logDef.Quantity
                                            * commonWorker.getExchangeRate(ExchangeRateType.INVOICE, CurrencyId.USD.Id, glEntry.ApplyDate)
                                            / commonWorker.getExchangeRate(ExchangeRateType.INVOICE, logDef.CurrencyId, glEntry.ApplyDate), 2, MidpointRounding.AwayFromZero);


                int period = 0;
                if (isReversal)
                {
                    SunInterfaceLogDef historyLogDef = this.getReversalLogHistoryByShipmentId(logDef.SunInterfaceTypeId, logDef.ShipmentId, logDef.SplitShipmentId, logDef.SunInterfaceLogId);
                    period = (historyLogDef.FiscalYear * 100) + historyLogDef.Period;
                }
                else
                    period = (logDef.FiscalYear * 100) + logDef.Period;

                if (period < 202105)
                    glEntry.Amount = Math.Round(glEntry.Amount * 0.15m, 2, MidpointRounding.AwayFromZero); // 15 % stock provision
                else
                    glEntry.Amount = Math.Round(glEntry.Amount * OfficeId.getStockProvisionRate(logDef.OfficeId) / 100.0m, 2, MidpointRounding.AwayFromZero); // 15 % stock provision

                glEntry.BaseAmount = Math.Round(glEntry.Amount * commonWorker.getExchangeRate(ExchangeRateType.INVOICE, logDef.CurrencyId, logDef.TransactionDate) / commonWorker.getExchangeRate(ExchangeRateType.INVOICE, CurrencyId.USD.Id, logDef.TransactionDate), 2, MidpointRounding.AwayFromZero);
                glEntry.IsRecordComplete = false;
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                glEntry = (GLInterfaceEntry)glEntry.Clone();
                glEntry.DC = !isReversal ? DCFlag.Credit : DCFlag.Debit;
                glEntry.COA = "1210091";
                glEntry.IsRecordComplete = true;
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);
            }


        }


        private void addActualQACommissionToSAFList(SunInterfaceLogDef logDef, ArrayList safList)
        {
            VendorRef vendor = vendorWorker.getVendorByKey(logDef.VendorId);
            string t0 = getT0Code(logDef);

            QACommissionDNDef dnDef = this.getQACommissionDNByShipmentId(logDef.ShipmentId);
            InvoiceDef invoiceDef = ShippingWorker.Instance.getInvoiceByKey(logDef.ShipmentId);

            APInvoiceInterfaceEntry entry = new APInvoiceInterfaceEntry();
            entry.COA = generalWorker.getEpicorCOA("2511011");
            entry.GroupId = EpicorInterfaceWorker.Instance.APInvoiceInterfaceFile.getSourceString();
            entry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
            entry.ApplyDate = entry.GroupApplyDate;

            if (isEnableWeek53Handling(logDef, false))
            {
                entry.GroupApplyDate = WK53_APPLY_DATE;
                entry.ApplyDate = WK53_APPLY_DATE;
            }

            entry.DocumentType = logDef.BaseAmount > 0 ? APInvoiceDocumentTypeEnum.ISAM_DEBIT_NOTE : APInvoiceDocumentTypeEnum.ISAM_CREDIT_NOTE;
            entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
            entry.Office = getT0Code(logDef);
            entry.SupplierId = vendorWorker.getVendorByKey(logDef.VendorId).EpicorSupplierId;
            //entry.LineDescription = logDef.ContractNo + "-" + logDef.DeliveryNo.ToString() + " " + getT9Code(logDef);
            entry.LineDescription = logDef.ContractNo + "-" + logDef.DeliveryNo.ToString();
            entry.Currency = CurrencyId.getCommonName(logDef.CurrencyId);
            entry.Amount = dnDef.TotalQACommission;
            entry.UnitCost = logDef.OtherAmount;
            entry.ItemNo = ProductWorker.Instance.getProductByKey(logDef.ProductId).ItemNo;
            entry.PaymentTerm = PaymentTermRef.getDescriptionForSAF(logDef.PaymentTermId) == "OA" ? "IN14" : "IN30";
            entry.SegmentValue3 = getT1Code(logDef);
            entry.SegmentValue4 = generalWorker.getProductCodeDefByKey(logDef.ProductTeamId).Code;
            entry.SegmentValue5 = getSeasonSegmentValue(logDef.SeasonId);
            entry.InvoiceNo = logDef.DebitCreditNoteNo;
            entry.RealInvoiceNo = logDef.DebitCreditNoteNo;
            entry.LegalNumber = logDef.DebitCreditNoteNo;
            entry.InvoiceDate = logDef.TransactionDate;
            entry.IsDebitNote = (logDef.BaseAmount > 0);
            entry.IsRecordComplete = true;

            EpicorInterfaceWorker.Instance.APInvoiceInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);
        }

        private void addActualAdvancePaymentInterestToSAFList(SunInterfaceLogDef logDef, ArrayList safList)
        {
            VendorRef vendor = vendorWorker.getVendorByKey(logDef.VendorId);
            string t0 = getT0Code(logDef);
            int paymentId = int.Parse(logDef.ReferenceNo.Split('|')[0]);
            DateTime paymentDate = DateTimeUtility.getDate(logDef.ReferenceNo.Split('|')[1]);

            AdvancePaymentDef advDef = advancePaymentWorker.getAdvancePaymentByKey(paymentId);
            AdvancePaymentInstalmentDetailDef detailDef = advancePaymentWorker.getAdvancePaymentInstalmentDetailByKey(paymentId, paymentDate);
            int noOfDays = detailDef.InterestToDate.Subtract(detailDef.InterestFromDate).Days + 1;

            List<AdvancePaymentInstalmentDetailDef> detailList = advancePaymentWorker.getAdvancePaymentInstalmentDetailList(paymentId);
            int seqId = 0;
            foreach (AdvancePaymentInstalmentDetailDef dtl in detailList)
            {
                if (dtl.Remark.ToLower().IndexOf("interest charge") != -1)
                {
                    if (dtl.PaymentDate < paymentDate)
                    {
                        seqId += 1;
                        continue;
                    }
                    break;
                }
            }

            APInvoiceInterfaceEntry entry = new APInvoiceInterfaceEntry();
            entry.COA = "2514020";
            entry.GroupId = EpicorInterfaceWorker.Instance.APInvoiceInterfaceFile.getSourceString();
            entry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
            entry.ApplyDate = entry.GroupApplyDate;

            if (isEnableWeek53Handling(logDef, false))
            {
                entry.GroupApplyDate = WK53_APPLY_DATE;
                entry.ApplyDate = WK53_APPLY_DATE;
            }

            entry.DocumentType = logDef.BaseAmount > 0 ? APInvoiceDocumentTypeEnum.ISAM_DEBIT_NOTE : APInvoiceDocumentTypeEnum.ISAM_CREDIT_NOTE;
            entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
            entry.Office = getT0Code(logDef);
            entry.SupplierId = vendorWorker.getVendorByKey(logDef.VendorId).EpicorSupplierId;
            entry.HeaderDescription = String.Format("{0}% interest on advance payment", Convert.ToInt32(detailDef.InterestRate).ToString());
            entry.LineDescription = String.Format("{0}% interest on advance payment {1}{2} Period {3} to {4} ({5}) - {6}",
                                                    Convert.ToInt32(detailDef.InterestRate).ToString(),
                                                    CurrencyId.getCommonName(logDef.CurrencyId),
                                                    detailDef.RemainingTotalAmt.ToString("#,##0"),
                                                    DateTimeUtility.getDateString(detailDef.InterestFromDate),
                                                    DateTimeUtility.getDateString(detailDef.InterestToDate),
                                                    noOfDays + " day" + (noOfDays > 1 ? "s" : string.Empty),
                                                    advDef.PaymentNo);

            entry.Currency = CurrencyId.getCommonName(logDef.CurrencyId);
            entry.Amount = logDef.OtherAmount;
            entry.UnitCost = logDef.OtherAmount;
            entry.PaymentTerm = "COD";
            if (logDef.OfficeId == OfficeId.HK.Id)
                entry.SegmentValue3 = "711";
            else
                entry.SegmentValue3 = "721";
            entry.InvoiceNo = logDef.DebitCreditNoteNo;
            entry.RealInvoiceNo = logDef.DebitCreditNoteNo;
            entry.LegalNumber = logDef.DebitCreditNoteNo;
            entry.InvoiceDate = logDef.TransactionDate;
            entry.IsDebitNote = (logDef.OtherAmount > 0);
            entry.IsRecordComplete = true;

            EpicorInterfaceWorker.Instance.APInvoiceInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);
        }


        private void addActualOtherChargeDCNoteToSAFList(SunInterfaceLogDef logDef, ArrayList safList)
        {
            string t0 = getT0Code(logDef);
            int dcNoteId = int.Parse(logDef.ReferenceNo);
            GenericDCNoteDef dcNoteDef = this.getGenericDCNoteById(dcNoteId);

            if (dcNoteDef.IssueTypeId == 1)
            {
                VendorRef vendor = vendorWorker.getVendorByKey(dcNoteDef.VendorId);
                NTVendorDef ntVendor = NonTradeWorker.Instance.getNTVendorByKey(dcNoteDef.NTVendorId);

                APInvoiceInterfaceEntry entry = new APInvoiceInterfaceEntry();
                entry.COA = dcNoteDef.COA;

                entry.GroupId = EpicorInterfaceWorker.Instance.APInvoiceInterfaceFile.getSourceString();
                entry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                entry.ApplyDate = entry.GroupApplyDate;

                if (isEnableWeek53Handling(logDef, false))
                {
                    entry.GroupApplyDate = WK53_APPLY_DATE;
                    entry.ApplyDate = WK53_APPLY_DATE;
                }

                entry.DocumentType = dcNoteDef.DebitCreditIndicator == "D" ? APInvoiceDocumentTypeEnum.ISAM_DEBIT_NOTE : APInvoiceDocumentTypeEnum.ISAM_CREDIT_NOTE;
                entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, dcNoteDef.OfficeId).EpicorCompanyId;

                if (dcNoteDef.OfficeId != dcNoteDef.PaymentOfficeId)
                {
                    entry.COA = generalWorker.getCurrentAccountCOA(dcNoteDef.OfficeId, dcNoteDef.PaymentOfficeId);
                }

                entry.Office = t0;
                entry.SupplierId = (vendor != null ? vendor.EpicorSupplierId : ntVendor.EPVendorCode);
                if (entry.SupplierId == "NM00465T")
                    entry.SupplierId = "NM00055N";

                entry.HeaderDescription = dcNoteDef.Description;
                entry.LineDescription = dcNoteDef.DCNoteNo + " " + dcNoteDef.Description;

                entry.Currency = CurrencyId.getCommonName(logDef.CurrencyId);
                entry.Amount = logDef.OtherAmount;
                entry.UnitCost = logDef.OtherAmount;
                entry.PaymentTerm = "COD";
                entry.InvoiceNo = logDef.DebitCreditNoteNo;
                entry.RealInvoiceNo = logDef.DebitCreditNoteNo;
                entry.LegalNumber = logDef.DebitCreditNoteNo;
                entry.InvoiceDate = logDef.TransactionDate;
                entry.IsDebitNote = (dcNoteDef.DebitCreditIndicator == "D");
                entry.IsRecordComplete = true;

                EpicorInterfaceWorker.Instance.APInvoiceInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);
            }
            else if (dcNoteDef.IssueTypeId == 2)
            {
                ARCustomerDef customer = this.getARCustomerByCode(dcNoteDef.CustomerCode);

                ARInvoiceInterfaceEntry entry = new ARInvoiceInterfaceEntry();

                entry.COA = dcNoteDef.COA;
                entry.CustomerId = dcNoteDef.CustomerCode;

                entry.GroupId = EpicorInterfaceWorker.Instance.ARInvoiceInterfaceFile.getSourceString();
                entry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                entry.ApplyDate = entry.GroupApplyDate;

                if (isEnableWeek53Handling(logDef, false))
                {
                    entry.GroupApplyDate = WK53_APPLY_DATE;
                    entry.ApplyDate = WK53_APPLY_DATE;
                }

                entry.DocumentType = dcNoteDef.DebitCreditIndicator == "D" ? ARInvoiceDocumentTypeEnum.MANUAL_INV : ARInvoiceDocumentTypeEnum.MANUAL_CN;
                entry.Office = t0;
                entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, dcNoteDef.OfficeId).EpicorCompanyId;
                if (dcNoteDef.OfficeId != dcNoteDef.PaymentOfficeId)
                {
                    entry.COA = generalWorker.getCurrentAccountCOA(dcNoteDef.OfficeId, dcNoteDef.PaymentOfficeId);
                }

                entry.LineDescription = dcNoteDef.DCNoteNo + " " + dcNoteDef.Description;

                entry.Currency = CurrencyId.getCommonName(logDef.CurrencyId);
                entry.UnitCost = logDef.OtherAmount;
                entry.Amount = logDef.OtherAmount;
                entry.Qty = logDef.Quantity;
                entry.ItemNo = string.Empty;
                entry.Terms = "COD";

                entry.RealInvoiceNo = dcNoteDef.DCNoteNo;
                entry.InvoiceNo = dcNoteDef.DCNoteNo;
                entry.LegalNumber = dcNoteDef.DCNoteNo;
                entry.InvoiceDate = logDef.TransactionDate;
                entry.IsCreditNote = (dcNoteDef.DebitCreditIndicator == "C");

                EpicorInterfaceWorker.Instance.ARInvoiceInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);
            }
            else if (dcNoteDef.IssueTypeId == 3)
            {
                GLInterfaceEntry glEntry = new GLInterfaceEntry();
                glEntry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, dcNoteDef.PaymentOfficeId).EpicorCompanyId;
                glEntry.GroupId = EpicorInterfaceWorker.Instance.GLInterfaceFile.getSourceString();
                glEntry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                glEntry.ApplyDate = glEntry.GroupApplyDate;

                if (isEnableWeek53Handling(logDef, false))
                {
                    glEntry.GroupApplyDate = WK53_APPLY_DATE;
                    glEntry.ApplyDate = WK53_APPLY_DATE;
                }

                glEntry.DocumentType = GLDocumentTypeEnum.GL;
                glEntry.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
                if (dcNoteDef.DebitCreditIndicator == "D")
                    glEntry.DC = DCFlag.Debit;
                else
                    glEntry.DC = DCFlag.Credit;
                glEntry.Qty = logDef.Quantity;
                glEntry.Amount = logDef.OtherAmount;
                glEntry.BaseAmount = logDef.BaseAmount;
                glEntry.LineDescription = dcNoteDef.DCNoteNo + " " + dcNoteDef.Description;
                glEntry.Office = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, dcNoteDef.PaymentOfficeId).InterComT0Code;
                glEntry.COA = dcNoteDef.GLCode;
                glEntry.IsRecordComplete = false;
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                glEntry = (GLInterfaceEntry)glEntry.Clone();
                if (dcNoteDef.DebitCreditIndicator == "D")
                    glEntry.DC = DCFlag.Credit;
                else
                    glEntry.DC = DCFlag.Debit;
                glEntry.COA = dcNoteDef.COA;
                if (dcNoteDef.OfficeId != dcNoteDef.PaymentOfficeId)
                    glEntry.COA = generalWorker.getCurrentAccountCOA(dcNoteDef.OfficeId, dcNoteDef.PaymentOfficeId);

                glEntry.IsRecordComplete = true;
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);
            }


            if (dcNoteDef.OfficeId != dcNoteDef.PaymentOfficeId)
            {
                GLInterfaceEntry glEntry = new GLInterfaceEntry();
                glEntry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, dcNoteDef.PaymentOfficeId).EpicorCompanyId;
                glEntry.GroupId = EpicorInterfaceWorker.Instance.GLInterfaceFile.getSourceString();
                glEntry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                glEntry.ApplyDate = glEntry.GroupApplyDate;

                if (isEnableWeek53Handling(logDef, false))
                {
                    glEntry.GroupApplyDate = WK53_APPLY_DATE;
                    glEntry.ApplyDate = WK53_APPLY_DATE;
                }

                glEntry.DocumentType = GLDocumentTypeEnum.GL;
                glEntry.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
                if (dcNoteDef.DebitCreditIndicator == "D")
                    glEntry.DC = DCFlag.Debit;
                else
                    glEntry.DC = DCFlag.Credit;
                glEntry.Qty = logDef.Quantity;
                glEntry.Amount = logDef.OtherAmount;
                glEntry.BaseAmount = logDef.BaseAmount;
                glEntry.LineDescription = dcNoteDef.DCNoteNo + " " + dcNoteDef.Description;
                glEntry.Office = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, dcNoteDef.PaymentOfficeId).InterComT0Code;
                glEntry.COA = generalWorker.getCurrentAccountCOA(dcNoteDef.OfficeId, dcNoteDef.PaymentOfficeId);
                glEntry.IsRecordComplete = false;
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                glEntry = (GLInterfaceEntry)glEntry.Clone();
                if (dcNoteDef.DebitCreditIndicator == "D")
                    glEntry.DC = DCFlag.Credit;
                else
                    glEntry.DC = DCFlag.Debit;
                glEntry.COA = dcNoteDef.COA;

                glEntry.IsRecordComplete = true;
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);
            }

        }

        /*
        private void addActualILSSalesDiscrepancyToSAFList(SunInterfaceLogDef logDef, ArrayList safList)
        {
            string t0 = getT0Code(logDef);

            if (logDef.OtherAmount != 0)
            {
                SAFDef def = new SAFDef();
                if (logDef.BaseAmount <= 1 && logDef.BaseAmount >= -1)
                {
                    def.AccountCode = "4104803";
                    def.T1 = (logDef.OfficeId == OfficeId.HK.Id) ? "711" : "721";
                }
                else
                    def.AccountCode = "1411132";
                def.FiscalYear = logDef.FiscalYear;
                def.Period = logDef.Period;
                def.TransactionDate = logDef.TransactionDate;
                if (logDef.BaseAmount > 0)
                    def.DebitCreditIndicator = "D";
                else
                    def.DebitCreditIndicator = "C";
                def.BaseAmount = Math.Abs(logDef.BaseAmount);
                def.JournalType = getJournalPrefix(logDef.OfficeId, logDef.TradingAgencyId) + "IN";
                def.Description = "DIFF ON " + getT9Code(logDef);
                def.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
                def.OtherAmount = Math.Abs(logDef.OtherAmount);
                def.T0 = (t0 == "THV2" ? "TH2F" : t0);
                if (t0 == "HK1G" || t0 == "FBHK" || t0 == "HKFB") def.T0 = "HK1F";
                else if (t0 == "FBSH" || t0 == "SHFB") def.T0 = "SH2F";
                else if (t0 == "FBVN" || t0 == "VNFB") def.T0 = "THV2";
                def.T9 = getT9Code(logDef);
                def.OfficeCode = OfficeId.getName(logDef.OfficeId);
                def.TradingAgency = TradingAgencyId.getName(logDef.TradingAgencyId);
                def.PaymentTerm = PaymentTermRef.getDescriptionForSAF(logDef.PaymentTermId);
                safList.Add(def);
            }
        }

        private void addActualILSSalesCommissionDiscrepancyToSAFList(SunInterfaceLogDef logDef, ArrayList safList)
        {
            string t0 = getT0Code(logDef);
            if (logDef.OtherAmount != 0)
            {
                SAFDef def = new SAFDef();
                if (logDef.BaseAmount <= 1 && logDef.BaseAmount >= -1)
                {
                    def.AccountCode = "4104803";
                    def.T1 = (logDef.OfficeId == OfficeId.HK.Id) ? "711" : "721";
                }
                else
                    def.AccountCode = "1411132";

                def.FiscalYear = logDef.FiscalYear;
                def.Period = logDef.Period;
                def.TransactionDate = logDef.TransactionDate;
                if (logDef.BaseAmount > 0)
                    def.DebitCreditIndicator = "D";
                else
                    def.DebitCreditIndicator = "C";
                def.BaseAmount = Math.Abs(logDef.BaseAmount);
                def.JournalType = getJournalPrefix(logDef.OfficeId, logDef.TradingAgencyId) + "IN";
                def.Description = "COMM DIFF " + getT9Code(logDef) + 'C';
                def.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
                def.OtherAmount = Math.Abs(logDef.OtherAmount);
                def.T0 = (t0 == "THV2" ? "TH2F" : t0);
                if (t0 == "HK1G" || t0 == "FBHK" || t0 == "HKFB") def.T0 = "HK1F";
                else if (t0 == "FBSH" || t0 == "SHFB") def.T0 = "SH2F";
                else if (t0 == "FBVN" || t0 == "VNFB") def.T0 = "THV2";
                def.T9 = getT9Code(logDef) + 'C';
                def.OfficeCode = OfficeId.getName(logDef.OfficeId);
                def.TradingAgency = TradingAgencyId.getName(logDef.TradingAgencyId);
                def.PaymentTerm = PaymentTermRef.getDescriptionForSAF(logDef.PaymentTermId);
                safList.Add(def);
            }
        }
        */

        private void addActualARAdjustmentForNextToSAFList(SunInterfaceLogDef logDef, ArrayList safList)
        {
            string t0 = getT0Code(logDef);

            #region debit entry
            SAFDef def = new SAFDef();
            if (logDef.CustomerId == CustomerDef.Id.japan.GetHashCode())
                def.AccountCode = "1306401";
            else if (logDef.CustomerId == CustomerDef.Id.middleeast.GetHashCode())
                def.AccountCode = "1303001";
            else if (logDef.CustomerId == CustomerDef.Id.choice.GetHashCode())
                def.AccountCode = "1320301";
            else if (logDef.CustomerId == CustomerDef.Id.gt.GetHashCode())
                def.AccountCode = "1303701";
            else if (logDef.CustomerId == CustomerDef.Id.lipsy.GetHashCode())
                def.AccountCode = "1320117";
            else if (logDef.CustomerId == CustomerDef.Id.days.GetHashCode())
                def.AccountCode = "1303401";
            else if (logDef.CustomerId == CustomerDef.Id.global_licensing.GetHashCode())
                def.AccountCode = "1320111";
            else if (logDef.CustomerId == CustomerDef.Id.fashionUK.GetHashCode())
                def.AccountCode = "1303405";
            else if (logDef.CustomerId == CustomerDef.Id.misirli.GetHashCode())
                def.AccountCode = "1303407";
            else if (logDef.TermOfPurchaseId == TermOfPurchaseRef.Id.FOB_UT.GetHashCode())
                def.AccountCode = "1320182";
            else
                def.AccountCode = "1320111";
            def.FiscalYear = logDef.FiscalYear;
            def.Period = logDef.Period;
            def.TransactionDate = logDef.TransactionDate;
            if (logDef.BaseAmount > 0)
                def.DebitCreditIndicator = "D";
            else
                def.DebitCreditIndicator = "C";
            def.BaseAmount = Math.Abs(logDef.BaseAmount);
            def.JournalType = getJournalPrefix(logDef.OfficeId, logDef.TradingAgencyId) + "DN";
            def.Description = def.Description = (logDef.ContractNo.Length <= 15 ? logDef.ContractNo : logDef.ContractNo.Substring(0, 15)) + " " + (logDef.Quantity * logDef.PiecesPerPack).ToString() + " PCS";
            def.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
            def.OtherAmount = Math.Abs(logDef.OtherAmount);
            def.T0 = getT0Code(logDef);
            def.T1 = getT1Code(logDef);
            def.T2 = generalWorker.getProductCodeDefByKey(logDef.ProductTeamId).Code;
            def.T5 = getT5Code(logDef.SeasonId);
            def.T8 = getT8Code(logDef.ProductId);
            def.T9 = getT9Code(logDef);
            def.OfficeCode = OfficeId.getName(logDef.OfficeId);
            def.TradingAgency = TradingAgencyId.getName(logDef.TradingAgencyId);
            def.PaymentTerm = PaymentTermRef.getDescriptionForSAF(logDef.PaymentTermId);
            safList.Add(def);
            #endregion

            #region credit entry
            def = (SAFDef)def.Clone();
            def.CreateDate = DateTime.Now;
            def.AccountCode = "1411132";
            if (logDef.BaseAmount > 0)
                def.DebitCreditIndicator = "C";
            else
                def.DebitCreditIndicator = "D";
            safList.Add(def);
            #endregion
        }

        private void addActualARAdjustmentForEziBuyToSAFList(SunInterfaceLogDef logDef, ArrayList safList)
        {
            AdjustmentDetailDef detailDef = this.getAdjustmentDetailByKey(int.Parse(logDef.ReferenceNo));
            InvoiceDef invoiceDef = ShippingWorker.Instance.getInvoiceByKey(logDef.ShipmentId);
            decimal exRate = commonWorker.getExchangeRate(ExchangeRateType.INVOICE, logDef.CurrencyId, invoiceDef.InvoiceDate);
            decimal usExRate = commonWorker.getExchangeRate(ExchangeRateType.INVOICE, CurrencyId.USD.Id, invoiceDef.InvoiceDate);
            string t0 = getT0Code(logDef);

            #region reverse crebit entry
            SAFDef def = new SAFDef();
            def.AccountCode = "1303402";
            def.FiscalYear = logDef.FiscalYear;
            def.Period = logDef.Period;
            def.TransactionDate = logDef.TransactionDate;
            def.DebitCreditIndicator = "C";
            def.BaseAmount = Math.Round(detailDef.SettledAmount * exRate / usExRate, 2, MidpointRounding.AwayFromZero);
            def.JournalType = getJournalPrefix(logDef.OfficeId, logDef.TradingAgencyId) + logDef.DebitCreditNoteNo.Substring(1, 1) + "N";
            def.Description = getT9Code(logDef);
            def.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
            def.OtherAmount = detailDef.SettledAmount;
            def.T0 = getT0Code(logDef);
            def.T1 = getT1Code(logDef);
            def.T2 = generalWorker.getProductCodeDefByKey(logDef.ProductTeamId).Code;
            def.T5 = getT5Code(logDef.SeasonId);
            def.T8 = getT8Code(logDef.ProductId);
            def.T9 = logDef.DebitCreditNoteNo;
            def.OfficeCode = OfficeId.getName(logDef.OfficeId);
            def.TradingAgency = TradingAgencyId.getName(logDef.TradingAgencyId);
            def.PaymentTerm = PaymentTermRef.getDescriptionForSAF(logDef.PaymentTermId);
            safList.Add(def);
            #endregion

            #region reverse debit entry
            def = (SAFDef)def.Clone();
            def.CreateDate = DateTime.Now;
            def.AccountCode = "2101405";
            def.DebitCreditIndicator = "D";
            def.Description = (logDef.ContractNo.Length <= 15 ? logDef.ContractNo : logDef.ContractNo.Substring(0, 15)) + " " + (logDef.Quantity * logDef.PiecesPerPack).ToString() + " PCS";
            def.T9 = getT9Code(logDef);
            safList.Add(def);
            #endregion

            #region debit entry
            def = (SAFDef)def.Clone();
            def.CreateDate = DateTime.Now;
            def.AccountCode = "1303402";
            def.DebitCreditIndicator = "D";
            def.BaseAmount = Math.Round(detailDef.LatestAmount * exRate / usExRate, 2, MidpointRounding.AwayFromZero);
            def.OtherAmount = detailDef.LatestAmount;
            def.Description = getT9Code(logDef);
            def.T9 = logDef.DebitCreditNoteNo;
            safList.Add(def);
            #endregion

            #region credit entry
            def = (SAFDef)def.Clone();
            def.CreateDate = DateTime.Now;
            def.AccountCode = "2101405";
            def.DebitCreditIndicator = "C";
            def.Description = (logDef.ContractNo.Length <= 15 ? logDef.ContractNo : logDef.ContractNo.Substring(0, 15)) + " " + (logDef.Quantity * logDef.PiecesPerPack).ToString() + " PCS";
            def.T9 = getT9Code(logDef);
            safList.Add(def);
            #endregion
        }

        private bool isHKFBExpense(NTInvoiceDetailDef def)
        {
            bool b = false;

            if (def.Department != null && def.Department.CostCenter.Code.Trim() == "262" && def.Office != null && def.Office.OfficeId == OfficeId.HK.Id)
            {
                /* 2016-09-20 add new product teams
                if (def.ProductTeam != null && (def.ProductTeam.Code == "NCBM" || def.ProductTeam.Code == "NCFBL" || def.ProductTeam.Code == "NCFWB"))
                */
                if (def.ProductTeam != null && (def.ProductTeam.Code == "NCBM" || def.ProductTeam.Code == "NCFBL" || def.ProductTeam.Code == "NCFWB" || def.ProductTeam.Code == "NCWBAG" || def.ProductTeam.Code == "NCWACC"))
                    b = true;
            }
            return b;
        }

        private bool isSHFBExpense(NTInvoiceDetailDef def)
        {
            bool b = false;

            if (def.Department != null && def.Department.CostCenter.Code.Trim() == "264" && def.Office != null && def.Office.OfficeId == OfficeId.SH.Id)
            {
                /* 2016-09-20 add nre product teams
                if (def.ProductTeam != null && (def.ProductTeam.Code == "NCFBCA" || def.ProductTeam.Code == "NCFBPR" || def.ProductTeam.Code == "NCFBSA"
                    || def.ProductTeam.Code == "NCFBVU" || def.ProductTeam.Code == "NCFGCA" || def.ProductTeam.Code == "NCFGPR" || def.ProductTeam.Code == "NCFM"))
                */
                if (def.ProductTeam != null && (def.ProductTeam.Code == "NCFBCA" || def.ProductTeam.Code == "NCFBPR" || def.ProductTeam.Code == "NCFBSA"
                    || def.ProductTeam.Code == "NCFBVU" || def.ProductTeam.Code == "NCFGCA" || def.ProductTeam.Code == "NCFGPR" || def.ProductTeam.Code == "NCFM"
                    || def.ProductTeam.Code == "FTBBTS" || def.ProductTeam.Code == "FTBCRA" || def.ProductTeam.Code == "FTBOTH"
                    || def.ProductTeam.Code == "FTBPRM" || def.ProductTeam.Code == "FTBSAN" || def.ProductTeam.Code == "FTBVUL" || def.ProductTeam.Code == "FTMEN"))
                    b = true;
            }
            return b;
        }

        private string[] getNonTradeSegmentValues(NTInvoiceDetailDef detailDef)
        {
            string[] list = new string[8];
            for (int i = 0; i < list.Length; i++)
                list[i] = string.Empty;

            if (detailDef.ExpenseType.IsDepartmentCode == 1) list[0] = detailDef.CostCenter.Code.Length > 3 ? detailDef.CostCenter.Code.Substring(0, 3) : detailDef.CostCenter.Code;
            if (detailDef.ExpenseType.IsProductCode == 1) list[1] = detailDef.ProductTeam.Code;
            if (detailDef.ExpenseType.IsStaffCode == 1)
            {
                if (detailDef.User.UserId == -1)
                {
                    if (detailDef.ExpenseType.SUNAccountCode == "4104104" && list[0] == "714")
                        list[1] = "DL714";
                    else
                        list[1] = "UNCAT";
                }
                else
                {
                    UserInfoDef userDef = generalWorker.getUserInfoByKey(detailDef.User.UserId);
                    list[1] = userDef.SunStaffCode;
                }
            }
            if (detailDef.ExpenseType.IsSeasonCode == 1) list[2] = getSeasonSegmentValue(detailDef.Season.SeasonId);
            if (detailDef.ExpenseType.IsDevSampleCostType == 1) list[3] = NTDevSampleCostType.getType(detailDef.DevSampleCostTypeId).SampleCostTypeCode;
            if (detailDef.ExpenseType.SUNAccountCode == "1311303" || detailDef.ExpenseType.SUNAccountCode == "1311307")
            {
                if (detailDef.ExpenseType.SUNAccountCode == "1311303")
                    list[0] = "341";
                else if (detailDef.ExpenseType.SUNAccountCode == "1311307")
                    list[0] = "342";

                if (detailDef.ExpenseType.SUNAccountCode == "1311303" && (detailDef.User == null || detailDef.User.UserId == -1))
                    list[1] = "COP";
                else if (detailDef.ExpenseType.SUNAccountCode == "1311307" && (detailDef.User == null || detailDef.User.UserId == -1))
                    list[1] = "PAT";
                else
                {
                    UserInfoDef userDef = generalWorker.getUserInfoByKey(detailDef.User.UserId);
                    list[1] = userDef.SunStaffCode;
                }
                list[3] = detailDef.ExpenseType.Description.Substring(25, 3);
            }
            if (detailDef.ExpenseType.SUNAccountCode == "1412101") list[3] = ExpenseNature.getType(detailDef.NatureIdForAccrual).AnalysisCode;

            if (detailDef.ExpenseType.IsSegmentValue == 1)
            {
                list[4] = detailDef.SegmentValue7.SegmentValue;
                list[5] = detailDef.SegmentValue8.SegmentValue;
            }

            return list;
        }

        private void addActualNonTradeExpenseInvoiceToSAFList(SunInterfaceLogDef logDef, ArrayList safList)
        {
            ArrayList detailList = NonTradeWorker.Instance.getNTInvoiceDetailListByInvoiceIdAndType(int.Parse(logDef.ReferenceNo), NTInvoiceDetailType.getTypeCollector());
            NTInvoiceDef invoiceDef = NonTradeWorker.Instance.getNTInvoiceByKey(int.Parse(logDef.ReferenceNo));

            CompanyOfficeMappingRef companyOfficeMappingDef = generalWorker.getCompanyOfficeMappingByCriteria(invoiceDef.Company.Id, invoiceDef.Office.OfficeId);
            int baseCurrencyId = generalWorker.getAccountDatabaseByKey(companyOfficeMappingDef.ReportingDatabaseId).ReportingCurrencyId;
            ICollection coll = generalWorker.getAccountPeriodListByYearPeriod(9, logDef.FiscalYear, logDef.Period);
            AccountFinancialCalenderDef calcDef = null;
            foreach (AccountFinancialCalenderDef cd in coll)
            {
                calcDef = cd;
                break;
            }

            decimal exRate = commonWorker.getExchangeRate(ExchangeRateType.INVOICE, invoiceDef.Currency.CurrencyId, calcDef.StartDate);
            decimal baseExRate = commonWorker.getExchangeRate(ExchangeRateType.INVOICE, baseCurrencyId, calcDef.StartDate);

            int i = 0;

            APInvoiceInterfaceEntry entry = new APInvoiceInterfaceEntry();

            foreach (NTInvoiceDetailDef detailDef in detailList)
            {
                bool isIntercommRequired = false;

                if (detailDef.IsPayByHK == 0)
                {
                    entry = new APInvoiceInterfaceEntry();

                    CompanyOfficeMappingRef detailCompanyOfficeMappingDef = null;
                    i += 1;

                    if (detailDef.IsRecharge == 0)  // || detailDef.IsRecharge == 1 && invoiceDef.CompanyOffice = SHSH
                    {
                        entry.assignSegmentValues(this.getNonTradeSegmentValues(detailDef));
                        entry.COA = generalWorker.getEpicorCOA(detailDef.ExpenseType.SUNAccountCode);
                    }
                    else
                    {
                        if (detailDef.ExpenseType.SUNAccountCode == "1311308" && detailDef.IntercommOfficeId != -1 && invoiceDef.Office.OfficeId != detailDef.IntercommOfficeId)
                            isIntercommRequired = true;

                        if (detailDef.Office != null && detailDef.Company != null)
                            detailCompanyOfficeMappingDef = generalWorker.getCompanyOfficeMappingByCriteria(detailDef.Company.Id, detailDef.Office.OfficeId);

                        if (detailDef.InvoiceDetailType == NTInvoiceDetailType.FABRIC_VENDOR || detailDef.InvoiceDetailType == NTInvoiceDetailType.GARMENT_VENDOR || detailDef.InvoiceDetailType == NTInvoiceDetailType.NON_CLOTHING_VENDOR || detailDef.InvoiceDetailType == NTInvoiceDetailType.LAUNDRY_VENDOR || detailDef.InvoiceDetailType == NTInvoiceDetailType.PACKAGING_VENDOR || detailDef.InvoiceDetailType == NTInvoiceDetailType.TRIM_VENDOR || detailDef.InvoiceDetailType == NTInvoiceDetailType.NT_VENDOR)
                        {
                            entry.COA = generalWorker.getEpicorCOA("1311308");
                        }
                        else if (detailDef.InvoiceDetailType == NTInvoiceDetailType.USER)
                        {
                            entry.COA = generalWorker.getEpicorCOA("1311305");
                            UserInfoDef userDef = generalWorker.getUserInfoByKey(detailDef.User.UserId);
                            entry.SegmentValue4 = userDef.SunStaffCode;
                        }
                        else if (detailDef.InvoiceDetailType == NTInvoiceDetailType.CUSTOMER)
                        {
                            if (detailDef.ExpenseType.SUNAccountCode == "1311303" || detailDef.ExpenseType.SUNAccountCode == "1311307")
                            {
                                if (invoiceDef.Office.OfficeId == OfficeId.VN.Id && invoiceDef.Company.Id == CompanyType.NEXT_SOURCING.Id)
                                {
                                    entry.IsMultiCompany = true;
                                    entry.ExternalCompany = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, OfficeId.HK.Id).EpicorCompanyId;
                                    entry.ExternalOffice = "HK1F";
                                    entry.ExternalCOA = generalWorker.getEpicorCOA(detailDef.ExpenseType.SUNAccountCode);
                                    entry.COA = generalWorker.getCurrentAccountCOA(OfficeId.HK.Id, OfficeId.VN.Id);
                                }
                                else
                                {
                                    entry.COA = generalWorker.getEpicorCOA(detailDef.ExpenseType.SUNAccountCode);

                                    if (detailDef.ExpenseType.IsSegmentValue == 1)
                                    {
                                        entry.SegmentValue7 = detailDef.SegmentValue7.SegmentValue;
                                        entry.SegmentValue8 = detailDef.SegmentValue8.SegmentValue;
                                    }
                                }

                                if (detailDef.ExpenseType.SUNAccountCode == "1311303")
                                {
                                    string t3 = string.Empty;
                                    if (detailDef.User == null || detailDef.User.UserId == -1)
                                        t3 = "COP";
                                    else
                                    {
                                        UserInfoDef userDef = generalWorker.getUserInfoByKey(detailDef.User.UserId);
                                        t3 = userDef.SunStaffCode;
                                    }

                                    if (entry.IsMultiCompany)
                                    {
                                        entry.ExternalSegmentValue3 = "341";
                                        entry.ExternalSegmentValue4 = t3;
                                    }
                                    else
                                    {
                                        entry.SegmentValue3 = "341";
                                        entry.SegmentValue4 = t3;
                                    }
                                }
                                else if (detailDef.ExpenseType.SUNAccountCode == "1311307")
                                {
                                    string t3 = string.Empty;
                                    if (detailDef.User == null || detailDef.User.UserId == -1)
                                        t3 = "PAT";
                                    else
                                    {
                                        UserInfoDef userDef = generalWorker.getUserInfoByKey(detailDef.User.UserId);
                                        t3 = userDef.SunStaffCode;
                                    }

                                    if (entry.IsMultiCompany)
                                    {
                                        entry.ExternalSegmentValue3 = "342";
                                        entry.ExternalSegmentValue4 = t3;
                                    }
                                    else
                                    {
                                        entry.SegmentValue3 = "342";
                                        entry.SegmentValue4 = t3;
                                    }
                                }
                                else
                                {
                                    UserInfoDef userDef = generalWorker.getUserInfoByKey(detailDef.User.UserId);
                                    if (entry.IsMultiCompany)
                                        entry.ExternalSegmentValue4 = userDef.SunStaffCode;
                                    else
                                        entry.SegmentValue4 = userDef.SunStaffCode;
                                }
                                if (entry.IsMultiCompany)
                                    entry.ExternalSegmentValue6 = detailDef.ExpenseType.Description.Substring(25, 3);
                                else
                                    entry.SegmentValue6 = detailDef.ExpenseType.Description.Substring(25, 3);
                            }
                            else
                            {
                                entry.COA = generalWorker.getEpicorCOA("1311308");
                            }
                        }

                        else if (detailDef.InvoiceDetailType == NTInvoiceDetailType.OFFICE)
                        {
                            if (invoiceDef.Company.Id != detailDef.Company.Id)
                            {
                                entry.COA = generalWorker.getEpicorCOA("1311308");

                                // TKTK Recharge
                                if (invoiceDef.Company == CompanyType.NSL_TK && detailDef.Company == CompanyType.NEXT_SOURCING && detailDef.Office.OfficeId != OfficeId.TR.Id)
                                    entry.COA = generalWorker.getEpicorCOA("1302520");
                                else if (invoiceDef.Company == CompanyType.NEXT_SOURCING && invoiceDef.Office.OfficeId != OfficeId.TR.Id & detailDef.Company == CompanyType.NSL_TK)
                                    entry.COA = generalWorker.getCurrentAccountCOA(invoiceDef.Office.OfficeId, OfficeId.TR.Id);

                            }
                            else if (invoiceDef.Company.Id == detailDef.Company.Id)
                            {
                                entry.IsMultiCompany = true;
                                entry.ExternalCompany = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, detailCompanyOfficeMappingDef.OfficeId).EpicorCompanyId;
                                entry.ExternalOffice = detailCompanyOfficeMappingDef.InterComT0Code;
                                entry.COA = generalWorker.getCurrentAccountCOA(invoiceDef.Office.OfficeId, detailDef.Office.OfficeId);
                                entry.ExternalCOA = generalWorker.getEpicorCOA(detailDef.ExpenseType.SUNAccountCode);

                                entry.assignExternalSegmentValues(getNonTradeSegmentValues(detailDef));
                            }
                        }

                        // 2019-03-20 Requested By Carmen [ Intercomm]
                        if (isIntercommRequired)
                            entry.COA = generalWorker.getCurrentAccountCOA(detailDef.IntercommOfficeId, invoiceDef.Office.OfficeId);
                    }

                    string[] descList = this.getNTExpenseTypeDescListforSUN(detailDef.ExpenseType.SUNAccountCode, detailDef, invoiceDef);

                    /* TODO:EPICOR */
                    if (invoiceDef.Office.OfficeId == OfficeId.TH.Id)
                        entry.Company = "NSHK";
                    else
                        entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(invoiceDef.Company.Id, invoiceDef.Office.OfficeId).EpicorCompanyId;
                    entry.GroupId = NonTradeEpicorInterfaceWorker.Instance.APInvoiceInterfaceFile.getSourceString();
                    entry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                    entry.ApplyDate = entry.GroupApplyDate;

                    if (isEnableWeek53Handling(logDef, false))
                    {
                        entry.GroupApplyDate = WK53_APPLY_DATE;
                        entry.ApplyDate = WK53_APPLY_DATE;
                    }

                    if (invoiceDef.DCIndicator == "D")
                        entry.DocumentType = APInvoiceDocumentTypeEnum.NON_TRADE;
                    else
                    {
                        entry.DocumentType = APInvoiceDocumentTypeEnum.NON_TRADE_DEBIT_NOTE;
                        entry.IsDebitNote = true;
                    }

                    entry.SupplierId = NonTradeWorker.Instance.getNTVendorByKey(logDef.VendorId).EPVendorCode;
                    entry.LegalNumber = invoiceDef.NSLInvoiceNo;
                    entry.RealInvoiceNo = (invoiceDef.InvoiceNo.Trim() != string.Empty ? invoiceDef.InvoiceNo : invoiceDef.CustomerNo + logDef.TransactionDate.ToString("yyMM"));
                    entry.InvoiceNo = (entry.RealInvoiceNo.Length > 20 ? entry.RealInvoiceNo.Substring(0, 20) : entry.RealInvoiceNo);
                    entry.InvoiceDate = logDef.TransactionDate;
                    entry.Amount = Math.Abs(invoiceDef.Amount + invoiceDef.TotalVAT);
                    entry.UnitCost = detailDef.Amount;
                    if (generalWorker.getEpicorCOA(detailDef.ExpenseType.SUNAccountCode) == "1225111")
                        entry.Qty = detailDef.Quantity;
                    entry.PaymentTerm = PaymentTermRef.getDescriptionForSAF(logDef.PaymentTermId) == "OA" ? "IN14" : "IN30";
                    entry.Currency = CurrencyId.getCommonName(logDef.CurrencyId);
                    if (descList.Length > 0)
                        entry.LineDescription = String.Join("\n", descList);
                    entry.IsRecordComplete = false;

                    if (this.isHKFBExpense(detailDef))
                        entry.Office = "HK1F";
                    else if (invoiceDef.Office.OfficeId == OfficeId.TH.Id)
                        entry.Office = "HKTH";
                    else if (this.isSHFBExpense(detailDef))
                        entry.Office = "SH2F";
                    else if (detailDef.CostCenter != null && detailDef.CostCenter.Code.Trim() == "252" && detailDef.Office != null && detailDef.Office.OfficeId == OfficeId.HK.Id)
                        entry.Office = "HK1F";
                    else if (detailDef.CostCenter != null && detailDef.CostCenter.Code.Trim() == "253" && detailDef.Office != null && detailDef.Office.OfficeId == OfficeId.HK.Id)
                        entry.Office = "HFSD";
                    else if (detailDef.CostCenter != null && detailDef.CostCenter.Code.Trim() == "383" && detailDef.Office != null && detailDef.Office.OfficeId == OfficeId.BD.Id)
                        entry.Office = "BAQC";
                    else if (detailDef.CostCenter != null && detailDef.CostCenter.Code.Trim() == "383" && detailDef.Office != null && detailDef.Office.OfficeId == OfficeId.HK.Id)
                    {
                        entry.Office = "HKQC";

                        GLInterfaceEntry glEntry = new GLInterfaceEntry();
                        glEntry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
                        glEntry.GroupId = NonTradeEpicorInterfaceWorker.Instance.GLInterfaceFile.getSourceString();
                        glEntry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                        glEntry.ApplyDate = glEntry.GroupApplyDate;
                        glEntry.DocumentType = GLDocumentTypeEnum.GL;
                        glEntry.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
                        glEntry.COA = "1452037";
                        if (invoiceDef.DCIndicator == "D")
                            glEntry.DC = (detailDef.Amount >= 0 ? DCFlag.Debit : DCFlag.Credit);
                        else
                            glEntry.DC = (detailDef.Amount >= 0 ? DCFlag.Credit : DCFlag.Debit);
                        glEntry.LineDescription = entry.LineDescription;
                        glEntry.BaseAmount = Math.Abs(Math.Round((detailDef.Amount + detailDef.VAT) * exRate / baseExRate, 2, MidpointRounding.AwayFromZero));
                        glEntry.Amount = Math.Abs(detailDef.Amount + detailDef.VAT);

                        glEntry.SegmentValue3 = entry.SegmentValue3;
                        glEntry.SegmentValue4 = "OTHERS";
                        glEntry.SegmentValue5 = "UNC";
                        glEntry.SegmentValue6 = string.Empty;
                        glEntry.SegmentValue7 = "U";
                        glEntry.SegmentValue8 = "G";
                        glEntry.Office = "HKQH";

                        NonTradeEpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                        glEntry = (GLInterfaceEntry)glEntry.Clone();
                        glEntry.COA = entry.COA;
                        glEntry.DC = (glEntry.DC == DCFlag.Debit ? DCFlag.Credit : DCFlag.Debit);
                        glEntry.IsRecordComplete = true;
                        NonTradeEpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);
                    }
                    else if (detailDef.CostCenter != null && detailDef.CostCenter.Code.Trim() == "383" && detailDef.Office != null && detailDef.Office.OfficeId == OfficeId.CA.Id && entry.COA.Substring(0, 1) == "4")
                    {
                        if (invoiceDef.Company == CompanyType.NEXT_SOURCING)
                            entry.Office = "CAQC";
                        else
                            entry.Office = "HBQC";
                    }
                    else if (detailDef.Office != null && detailDef.Office.OfficeId == OfficeId.CA.Id && invoiceDef.NTVendor.NTVendorId == 900076) // 2017-05-23 Requested By Cathy Tse -- LEE APARTMENT
                        entry.Office = "CA2F";

                    else if (detailDef.InvoiceDetailType == NTInvoiceDetailType.OFFICE && invoiceDef.Company.Id != detailDef.Company.Id
                             && ((invoiceDef.Company == CompanyType.NSL_TK && detailDef.Company == CompanyType.NEXT_SOURCING && detailDef.Office.OfficeId != OfficeId.TR.Id)
                                 || (detailDef.Company == CompanyType.NSL_TK && invoiceDef.Company == CompanyType.NEXT_SOURCING && invoiceDef.Office.OfficeId != OfficeId.TR.Id)))
                    {
                        if (invoiceDef.Company == CompanyType.NSL_TK && detailDef.Company == CompanyType.NEXT_SOURCING && detailDef.Office.OfficeId != OfficeId.TR.Id)
                        {
                            entry.Office = "TRRC";
                            entry.IsMultiCompany = true;
                            entry.ExternalCompany = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, detailDef.Office.OfficeId).EpicorCompanyId;
                            entry.ExternalCOA = generalWorker.getEpicorCOA(detailDef.ExpenseType.SUNAccountCode);
                            entry.assignExternalSegmentValues(getNonTradeSegmentValues(detailDef));

                            GLInterfaceEntry glEntry = new GLInterfaceEntry();
                            glEntry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
                            glEntry.GroupId = NonTradeEpicorInterfaceWorker.Instance.GLInterfaceFile.getSourceString();
                            glEntry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                            glEntry.ApplyDate = glEntry.GroupApplyDate;
                            glEntry.DocumentType = GLDocumentTypeEnum.GL;
                            glEntry.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
                            glEntry.Office = "TK1F";
                            glEntry.COA = generalWorker.getCurrentAccountCOA(detailDef.Office.OfficeId, OfficeId.TR.Id);
                            if (invoiceDef.DCIndicator == "D")
                                glEntry.DC = (detailDef.Amount >= 0 ? DCFlag.Debit : DCFlag.Credit);
                            else
                                glEntry.DC = (detailDef.Amount >= 0 ? DCFlag.Credit : DCFlag.Debit);
                            glEntry.LineDescription = entry.LineDescription;
                            glEntry.BaseAmount = Math.Abs(Math.Round((detailDef.Amount) * exRate / baseExRate, 2, MidpointRounding.AwayFromZero));
                            glEntry.Amount = Math.Abs(detailDef.Amount);
                            NonTradeEpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                            glEntry = (GLInterfaceEntry)glEntry.Clone();
                            glEntry.COA = "1302520";
                            glEntry.DC = (glEntry.DC == DCFlag.Debit ? DCFlag.Credit : DCFlag.Debit);
                            glEntry.IsRecordComplete = true;
                            NonTradeEpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                        }
                        else if (invoiceDef.Company == CompanyType.NEXT_SOURCING && invoiceDef.Office.OfficeId != OfficeId.TR.Id && detailDef.Company == CompanyType.NSL_TK)
                        {
                            entry.Office = companyOfficeMappingDef.T0Code;
                            entry.IsMultiCompany = true;
                            entry.ExternalCompany = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NSL_TK.Id, detailDef.Office.OfficeId).EpicorCompanyId;
                            entry.ExternalCOA = generalWorker.getEpicorCOA(detailDef.ExpenseType.SUNAccountCode);
                            entry.assignExternalSegmentValues(getNonTradeSegmentValues(detailDef));

                            GLInterfaceEntry glEntry = new GLInterfaceEntry();
                            glEntry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
                            glEntry.GroupId = NonTradeEpicorInterfaceWorker.Instance.GLInterfaceFile.getSourceString();
                            glEntry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                            glEntry.ApplyDate = glEntry.GroupApplyDate;
                            glEntry.DocumentType = GLDocumentTypeEnum.GL;
                            glEntry.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
                            glEntry.Office = "TK1F";
                            glEntry.COA = "1302520";
                            if (invoiceDef.DCIndicator == "D")
                                glEntry.DC = (detailDef.Amount >= 0 ? DCFlag.Debit : DCFlag.Credit);
                            else
                                glEntry.DC = (detailDef.Amount >= 0 ? DCFlag.Credit : DCFlag.Debit);
                            glEntry.LineDescription = entry.LineDescription;
                            glEntry.BaseAmount = Math.Abs(Math.Round((detailDef.Amount) * exRate / baseExRate, 2, MidpointRounding.AwayFromZero));
                            glEntry.Amount = Math.Abs(detailDef.Amount);
                            NonTradeEpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                            glEntry = (GLInterfaceEntry)glEntry.Clone();
                            glEntry.COA = generalWorker.getCurrentAccountCOA(detailDef.Office.OfficeId, OfficeId.TR.Id);
                            glEntry.DC = (glEntry.DC == DCFlag.Debit ? DCFlag.Credit : DCFlag.Debit);
                            glEntry.clearSegmentValues();
                            glEntry.IsRecordComplete = true;
                            NonTradeEpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                        }
                    }
                    else if (invoiceDef.Company == CompanyType.NEXT_SOURCING && invoiceDef.Office.OfficeId == OfficeId.SL.Id && invoiceDef.Currency.CurrencyId == CurrencyId.PKR.Id)
                    {
                        entry.Office = "LP1F";
                    }
                    else
                        entry.Office = companyOfficeMappingDef.T0Code;

                    NonTradeEpicorInterfaceWorker.Instance.APInvoiceInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);

                    if (detailDef.CostCenter != null && detailDef.CostCenter.Code.Trim() == "383" && detailDef.Office != null && detailDef.Office.OfficeId == OfficeId.CA.Id && entry.COA.Substring(0, 1) == "4")
                        transferToHAQH(entry, exRate, baseExRate);

                    if (detailDef.CostCenter != null && detailDef.CostCenter.Code.Trim() == "383" && detailDef.Office != null && detailDef.Office.OfficeId == OfficeId.BD.Id && entry.COA.Substring(0, 1) == "4")
                        transferTOBAQH(entry);

                    if (detailDef.VAT > 0)
                    {
                        entry = (APInvoiceInterfaceEntry)entry.Clone();
                        entry.UnitCost = detailDef.VAT;
                        entry.COA = (logDef.OfficeId == OfficeId.TR.Id ? "1530080" : "1530020");
                        if (entry.IsMultiCompany)
                            entry.disableMultiCompany();

                        NonTradeEpicorInterfaceWorker.Instance.APInvoiceInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);
                    }

                    // TODO 2019-03-20 Requested By Carmen Cheung [Intercomm]

                    if (isIntercommRequired)
                    {
                        GLInterfaceEntry glEntry = new GLInterfaceEntry();
                        glEntry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, detailDef.IntercommOfficeId).EpicorCompanyId;
                        glEntry.GroupId = NonTradeEpicorInterfaceWorker.Instance.GLInterfaceFile.getSourceString();
                        glEntry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                        glEntry.ApplyDate = glEntry.GroupApplyDate;

                        if (isEnableWeek53Handling(logDef, false))
                        {
                            glEntry.GroupApplyDate = WK53_APPLY_DATE;
                            glEntry.ApplyDate = WK53_APPLY_DATE;
                        }

                        glEntry.DocumentType = GLDocumentTypeEnum.GL;
                        glEntry.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);

                        if (invoiceDef.DCIndicator == "D")
                            glEntry.DC = (detailDef.Amount >= 0 ? DCFlag.Debit : DCFlag.Credit);
                        else
                            glEntry.DC = (detailDef.Amount >= 0 ? DCFlag.Credit : DCFlag.Debit);

                        glEntry.BaseAmount = Math.Abs(Math.Round((detailDef.Amount) * exRate / baseExRate, 2, MidpointRounding.AwayFromZero));
                        glEntry.Amount = Math.Abs(detailDef.Amount);

                        glEntry.LineDescription = entry.LineDescription;
                        glEntry.Office = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, detailDef.IntercommOfficeId).InterComT0Code;

                        glEntry.COA = generalWorker.getEpicorCOA("1311308");
                        glEntry.IsRecordComplete = false;
                        NonTradeEpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                        glEntry = (GLInterfaceEntry)glEntry.Clone();
                        glEntry.DC = (glEntry.DC == DCFlag.Debit ? DCFlag.Credit : DCFlag.Debit);
                        glEntry.COA = generalWorker.getCurrentAccountCOA(invoiceDef.Office.OfficeId, detailDef.IntercommOfficeId);

                        glEntry.IsRecordComplete = true;
                        NonTradeEpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);
                    }
                }
            }

        }

        private void transferToHAQH(APInvoiceInterfaceEntry apEntry, decimal exRate, decimal baseExRate)
        {
            GLInterfaceEntry glEntry = new GLInterfaceEntry();
            glEntry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, OfficeId.CA.Id).EpicorCompanyId;
            glEntry.Office = "HAQH";
            glEntry.GroupId = apEntry.GroupId;
            glEntry.GroupApplyDate = apEntry.GroupApplyDate;
            glEntry.ApplyDate = apEntry.ApplyDate;
            glEntry.DocumentType = GLDocumentTypeEnum.GL;
            glEntry.CurrencyCode = apEntry.Currency;
            glEntry.COA = "1452023";
            if (!apEntry.IsDebitNote)
                glEntry.DC = (apEntry.UnitCost >= 0 ? DCFlag.Debit : DCFlag.Credit);
            else
                glEntry.DC = (apEntry.UnitCost >= 0 ? DCFlag.Credit : DCFlag.Debit);
            glEntry.LineDescription = apEntry.LineDescription;
            glEntry.BaseAmount = Math.Round(Math.Abs(apEntry.UnitCost) * exRate / baseExRate, 2, MidpointRounding.AwayFromZero);
            glEntry.Amount = Math.Abs(apEntry.UnitCost);
            glEntry.SegmentValue3 = apEntry.SegmentValue3;
            glEntry.SegmentValue4 = "DL383";
            glEntry.SegmentValue5 = "UNC";
            glEntry.SegmentValue6 = string.Empty;
            glEntry.SegmentValue7 = "U";
            glEntry.SegmentValue8 = "G";
            glEntry.SegmentValue9 = string.Empty;
            glEntry.SegmentValue10 = string.Empty;
            NonTradeEpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

            glEntry = (GLInterfaceEntry)glEntry.Clone();
            glEntry.COA = apEntry.COA;
            glEntry.DC = (glEntry.DC == DCFlag.Debit ? DCFlag.Credit : DCFlag.Debit);
            glEntry.clearSegmentValues();
            glEntry.SegmentValue3 = apEntry.SegmentValue3;
            NonTradeEpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);
        }

        private void transferTOBAQH(APInvoiceInterfaceEntry apEntry)
        {
            APInvoiceInterfaceEntry entry = (APInvoiceInterfaceEntry)apEntry.Clone();
            entry.UnitCost *= -1;
            entry.Office = "BAQH";
            NonTradeEpicorInterfaceWorker.Instance.APInvoiceInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);

            entry = (APInvoiceInterfaceEntry)entry.Clone();
            entry.UnitCost *= -1;
            entry.Office = "BAQH";
            entry.COA = "1452023";
            entry.SegmentValue4 = (entry.SegmentValue4 == string.Empty ? "LBD001" : entry.SegmentValue4);
            entry.SegmentValue5 = "UNC";
            entry.SegmentValue6 = string.Empty;
            entry.SegmentValue7 = "U";
            entry.SegmentValue8 = "G";
            entry.SegmentValue9 = string.Empty;
            entry.SegmentValue10 = string.Empty;
            NonTradeEpicorInterfaceWorker.Instance.APInvoiceInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);
        }

        private string[] getNTExpenseTypeDescListforSUN(string accountCode, NTInvoiceDetailDef detailDef, NTInvoiceDef def)
        {
            string text = detailDef.ExpenseType.SUNDescription;
            string pattern = @"{(\w+)}";
            MatchCollection matches = Regex.Matches(text, pattern);

            bool isNormal = !(accountCode == "1320113" || accountCode == "1320114" || accountCode == "1320115");

            foreach (Match m in matches)
            {
                if (m.ToString() == "{InvDesc}")
                {
                    string tmp = string.Empty;
                    if (detailDef.ItemDescription1.Trim() != string.Empty) tmp += (detailDef.ItemDescription1 + "|^|");
                    if (detailDef.ItemDescription2.Trim() != string.Empty) tmp += (detailDef.ItemDescription2 + "|^|");
                    if (detailDef.ItemDescription3.Trim() != string.Empty) tmp += (detailDef.ItemDescription3 + "|^|");
                    if (detailDef.ItemDescription4.Trim() != string.Empty) tmp += (detailDef.ItemDescription4 + "|^|");
                    if (detailDef.ItemDescription5.Trim() != string.Empty) tmp += (detailDef.ItemDescription5 + "|^|");
                    text = text.Replace(m.ToString(), tmp);
                    text = text.Replace("|^||^|", "|^|");
                }
                else
                {
                    if (m.ToString() == "{PaymentFromDate}")
                    {
                        text = text.Replace(m.ToString(), def.PaymentFromDate.ToString("yy/MM"));
                    }
                    if (m.ToString() == "{VendorName}")
                        text = text.Replace(m.ToString(), (def.NTVendor == null && detailDef.IsRecharge == 1) ? string.Empty : def.NTVendor.VendorName);
                    if (m.ToString() == "{StaffName}")
                        text = text.Replace(m.ToString(), (detailDef.User == null && detailDef.IsRecharge == 1) ? string.Empty : detailDef.User.DisplayName);
                    if (m.ToString() == "{StaffCode}")
                    {
                        UserInfoDef userDef = generalWorker.getUserInfoByKey(detailDef.User.UserId);
                        text = text.Replace(m.ToString(), (userDef == null && detailDef.IsRecharge == 1) ? string.Empty : (userDef == null ? "NIL" : userDef.SunStaffCode));
                    }
                    if (m.ToString() == "{Department}")
                        text = text.Replace(m.ToString(), (detailDef.Department == null && detailDef.IsRecharge == 1) ? string.Empty : detailDef.Department.Description);
                    if (!isNormal)
                        text += "***TO-BE-REMOVED***";
                }
            }

            if (text.Length > 3)
            {
                if (text.Substring(text.Length - 3, 3) == "|^|")
                    text = text.Substring(0, text.Length - 3);
            }

            pattern = @"\|\^\|";
            string[] sp = Regex.Split(text, pattern);
            List<string> list = new List<string>();
            for (int i = 0; i <= sp.GetUpperBound(0); i++)
            {
                if (sp[i].IndexOf("***TO-BE-REMOVED***") == -1)
                    list.Add(sp[i]);
            }

            return list.ToArray();
        }

        private void addActualNonTradeAccrualToSAFList(SunInterfaceLogDef logDef, ArrayList safList)
        {
            ArrayList detailList = NonTradeWorker.Instance.getNTInvoiceDetailListByInvoiceIdAndType(int.Parse(logDef.ReferenceNo), NTInvoiceDetailType.getTypeCollector());
            NTInvoiceDef invoiceDef = NonTradeWorker.Instance.getNTInvoiceByKey(int.Parse(logDef.ReferenceNo));

            Debug.WriteLine("NT Invoice Id: " + invoiceDef.InvoiceId.ToString());
            CompanyOfficeMappingRef companyOfficeMappingDef = generalWorker.getCompanyOfficeMappingByCriteria(invoiceDef.Company.Id, invoiceDef.Office.OfficeId);
            int baseCurrencyId = generalWorker.getAccountDatabaseByKey(companyOfficeMappingDef.ReportingDatabaseId).ReportingCurrencyId;
            ICollection coll = generalWorker.getAccountPeriodListByYearPeriod(AppId.NSS.Code, logDef.FiscalYear, logDef.Period);
            AccountFinancialCalenderDef calcDef = null;
            foreach (AccountFinancialCalenderDef cd in coll)
            {
                calcDef = cd;
                break;
            }

            string targetDB = generalWorker.getAccountDatabaseByKey(companyOfficeMappingDef.ReportingDatabaseId).DbCode;

            decimal exRate = commonWorker.getExchangeRate(ExchangeRateType.INVOICE, invoiceDef.Currency.CurrencyId, calcDef.StartDate);
            decimal baseExRate = commonWorker.getExchangeRate(ExchangeRateType.INVOICE, baseCurrencyId, calcDef.StartDate);
            int i = 0;
            GLInterfaceEntry entry = new GLInterfaceEntry();

            foreach (NTInvoiceDetailDef detailDef in detailList)
            {
                if ((detailDef.IsPayByHK == 0 && detailDef.IsRecharge == 0 && detailDef.ExpenseType.IsAllowAccrual == 1))
                {
                    i += 1;
                    entry = new GLInterfaceEntry();

                    if (detailDef.ExpenseType.IsDepartmentCode == 1)
                        entry.SegmentValue3 = detailDef.CostCenter.Code.Length > 3 ? detailDef.CostCenter.Code.Substring(0, 3) : detailDef.CostCenter.Code;
                    if (detailDef.ExpenseType.IsProductCode == 1)
                        entry.SegmentValue4 = detailDef.ProductTeam.Code;
                    if (detailDef.ExpenseType.IsStaffCode == 1)
                    {
                        if (detailDef.User.UserId == -1)
                            entry.SegmentValue4 = "UNCAT";
                        else
                        {
                            UserInfoDef userDef = generalWorker.getUserInfoByKey(detailDef.User.UserId);
                            entry.SegmentValue4 = userDef.SunStaffCode;
                        }
                    }
                    if (detailDef.ExpenseType.IsSeasonCode == 1)
                        entry.SegmentValue5 = getT5Code(detailDef.Season.SeasonId);
                    if (detailDef.ExpenseType.IsDevSampleCostType == 1)
                        entry.SegmentValue6 = NTDevSampleCostType.getType(detailDef.DevSampleCostTypeId).SampleCostTypeCode;

                    string[] descList = this.getNTExpenseTypeDescListforSUN(detailDef.ExpenseType.SUNAccountCode, detailDef, invoiceDef);

                    entry.Reverse = true;
                    if (invoiceDef.Office.OfficeId == OfficeId.TH.Id)
                        entry.Company = "NSHK";
                    else
                        entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
                    entry.GroupId = NonTradeEpicorInterfaceWorker.Instance.GLInterfaceFile.getSourceString();
                    entry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                    entry.ApplyDate = entry.GroupApplyDate;
                    entry.DocumentType = GLDocumentTypeEnum.NON_TRADE_ACCRUAL;
                    entry.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
                    if (invoiceDef.DCIndicator == "D")
                        entry.DC = (detailDef.Amount >= 0 ? DCFlag.Debit : DCFlag.Credit);
                    else
                        entry.DC = (detailDef.Amount >= 0 ? DCFlag.Credit : DCFlag.Debit);
                    entry.BaseAmount = Math.Abs(Math.Round((detailDef.Amount + detailDef.VAT) * exRate / baseExRate, 2, MidpointRounding.AwayFromZero));
                    entry.Amount = Math.Abs(detailDef.Amount + detailDef.VAT);
                    if (descList.Length > 0)
                        entry.LineDescription = String.Join("\n", descList);

                    if (detailDef.Department != null && detailDef.Department.CostCenter.Code.Trim() == "252" && detailDef.Office != null && detailDef.Office.OfficeId == OfficeId.HK.Id)
                        entry.Office = "HK1F";
                    else if (invoiceDef.Office.OfficeId == OfficeId.TH.Id)
                        entry.Office = "HKTH";
                    else if (detailDef.Department != null && detailDef.Department.CostCenter.Code.Trim() == "253" && detailDef.Office != null && detailDef.Office.OfficeId == OfficeId.HK.Id)
                        entry.Office = "HFSD";
                    else if (detailDef.Department != null && detailDef.CostCenter.Code.Trim() == "383" && detailDef.Office != null && detailDef.Office.OfficeId == OfficeId.BD.Id)
                        entry.Office = "BAQC";
                    else if (detailDef.Department != null && detailDef.CostCenter.Code.Trim() == "383" && detailDef.Office != null && detailDef.Office.OfficeId == OfficeId.CA.Id)
                        entry.Office = "CAQC";
                    else if (detailDef.CostCenter != null && detailDef.CostCenter.Code.Trim() == "383" && detailDef.Office != null && detailDef.Office.OfficeId == OfficeId.HK.Id)
                    {
                        entry.Office = "HKQC";

                        GLInterfaceEntry glEntry = new GLInterfaceEntry();
                        glEntry.Reverse = true;
                        glEntry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
                        glEntry.GroupId = NonTradeEpicorInterfaceWorker.Instance.GLInterfaceFile.getSourceString();
                        glEntry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                        glEntry.ApplyDate = glEntry.GroupApplyDate;
                        glEntry.DocumentType = GLDocumentTypeEnum.GL;
                        glEntry.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
                        glEntry.COA = "1452037";
                        if (invoiceDef.DCIndicator == "D")
                            glEntry.DC = (detailDef.Amount >= 0 ? DCFlag.Debit : DCFlag.Credit);
                        else
                            glEntry.DC = (detailDef.Amount >= 0 ? DCFlag.Credit : DCFlag.Debit);
                        glEntry.LineDescription = entry.LineDescription;
                        glEntry.BaseAmount = Math.Abs(Math.Round((detailDef.Amount + detailDef.VAT) * exRate / baseExRate, 2, MidpointRounding.AwayFromZero));
                        glEntry.Amount = Math.Abs(detailDef.Amount + detailDef.VAT);

                        glEntry.SegmentValue3 = entry.SegmentValue3;
                        glEntry.SegmentValue4 = "OTHERS";
                        glEntry.SegmentValue5 = "UNC";
                        glEntry.SegmentValue6 = string.Empty;
                        glEntry.SegmentValue7 = "U";
                        glEntry.SegmentValue8 = "G";
                        glEntry.Office = "HKQH";

                        NonTradeEpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                        glEntry = (GLInterfaceEntry)glEntry.Clone();
                        glEntry.COA = entry.COA;
                        glEntry.DC = (glEntry.DC == DCFlag.Debit ? DCFlag.Credit : DCFlag.Debit);
                        NonTradeEpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);
                    }
                    else if (invoiceDef.Company == CompanyType.NEXT_SOURCING && invoiceDef.Office.OfficeId == OfficeId.SL.Id && invoiceDef.Currency.CurrencyId == CurrencyId.PKR.Id)
                    {
                        entry.Office = "LP1F";
                    }
                    else
                        entry.Office = companyOfficeMappingDef.T0Code;

                    entry.COA = generalWorker.getEpicorCOA(detailDef.ExpenseType.SUNAccountCode);

                    if (detailDef.ExpenseType.IsSegmentValue == 1)
                    {
                        entry.SegmentValue7 = "U";
                        entry.SegmentValue7 = "G";
                        detailDef.SegmentValue7.SegmentValue = "U";
                        detailDef.SegmentValue8.SegmentValue = "G";
                        if (detailDef.SegmentValue7 != null)
                            entry.SegmentValue7 = detailDef.SegmentValue7.SegmentValue;
                        if (detailDef.SegmentValue8 != null)
                            entry.SegmentValue8 = detailDef.SegmentValue8.SegmentValue;
                    }

                    NonTradeEpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);

                    entry = (GLInterfaceEntry)entry.Clone();
                    entry.SegmentValue7 = string.Empty;
                    entry.SegmentValue3 = string.Empty;
                    entry.SegmentValue4 = string.Empty;
                    entry.SegmentValue5 = string.Empty;
                    if (detailDef.ExpenseType.SUNAccountCode == "1412101" && detailDef.ExpenseType.NatureId != -1)
                        entry.SegmentValue6 = ExpenseNature.getType(detailDef.ExpenseType.NatureId).AnalysisCode;
                    entry.COA = generalWorker.getEpicorCOA("1412101");

                    if (detailDef.ExpenseType.IsSegmentValue == 1)
                    {
                        entry.SegmentValue7 = "U";
                        entry.SegmentValue7 = "G";
                        detailDef.SegmentValue7.SegmentValue = "U";
                        detailDef.SegmentValue8.SegmentValue = "G";
                        if (detailDef.SegmentValue7 != null)
                            entry.SegmentValue7 = detailDef.SegmentValue7.SegmentValue;
                        if (detailDef.SegmentValue8 != null)
                            entry.SegmentValue8 = detailDef.SegmentValue8.SegmentValue;
                    }

                    if (invoiceDef.DCIndicator == "D")
                        entry.DC = (invoiceDef.Amount >= 0 ? DCFlag.Credit : DCFlag.Debit);
                    else
                        entry.DC = (invoiceDef.Amount >= 0 ? DCFlag.Debit : DCFlag.Credit);
                    entry.IsRecordComplete = true;
                    NonTradeEpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);

                }
            }
        }

        private void addActualNonTradePaymentOnBehalfDebitNoteToSAFList(SunInterfaceLogDef logDef, ArrayList safList)
        {
            List<NTInvoiceDetailDef> detailList = NonTradeWorker.Instance.getNTInvoiceDetailByRechargeDCNoteId(int.Parse(logDef.ReferenceNo));
            NTRechargeDCNoteDef dcNoteDef = NonTradeWorker.Instance.getNTRechargeDCNoteByDCNoteNo(logDef.DebitCreditNoteNo);

            CompanyOfficeMappingRef companyOfficeMappingDef = generalWorker.getCompanyOfficeMappingByCriteria(dcNoteDef.Company.Id, dcNoteDef.Office.OfficeId);
            int baseCurrencyId = generalWorker.getAccountDatabaseByKey(companyOfficeMappingDef.ReportingDatabaseId).ReportingCurrencyId;
            ICollection coll = generalWorker.getAccountPeriodListByYearPeriod(9, logDef.FiscalYear, logDef.Period);
            AccountFinancialCalenderDef calcDef = null;
            foreach (AccountFinancialCalenderDef cd in coll)
            {
                calcDef = cd;
                break;
            }


            decimal exRate = commonWorker.getExchangeRate(ExchangeRateType.INVOICE, dcNoteDef.RechargeCurrencyId, calcDef.StartDate);
            decimal baseExRate = commonWorker.getExchangeRate(ExchangeRateType.INVOICE, baseCurrencyId, calcDef.StartDate);
            SAFDef def = null;
            int i = 0;
            decimal runningTtlAmt = 0;

            foreach (NTInvoiceDetailDef detailDef in detailList)
            {
                i += 1;
                NTInvoiceDef invoiceDef = NonTradeWorker.Instance.getNTInvoiceByKey(detailDef.InvoiceId);
                CompanyOfficeMappingRef detailCompanyOfficeMappingDef = generalWorker.getCompanyOfficeMappingByCriteria(invoiceDef.Company.Id, invoiceDef.Office.OfficeId);

                def = new SAFDef();

                def.T1 = string.Empty;
                def.T2 = string.Empty;
                def.T3 = string.Empty;
                def.T4 = string.Empty;
                def.T5 = string.Empty;

                decimal detailExRate = commonWorker.getExchangeRate(ExchangeRateType.INVOICE, invoiceDef.Currency.CurrencyId, calcDef.StartDate);

                def.AccountCode = "1311308";
                def.TargetDB = generalWorker.getAccountDatabaseByKey(companyOfficeMappingDef.ReportingDatabaseId).DbCode;
                string journalType = (def.TargetDB == "1NI" ? "N" : getJournalPrefix(logDef.OfficeId, logDef.TradingAgencyId)) + "ND";

                def.FiscalYear = logDef.FiscalYear;
                def.Period = logDef.Period;
                def.TransactionDate = logDef.TransactionDate;
                def.DebitCreditIndicator = "C";
                def.BaseAmount = Math.Round((detailDef.Amount + detailDef.VAT) * detailExRate / baseExRate, 2, MidpointRounding.AwayFromZero);
                runningTtlAmt += def.BaseAmount;
                /*
                def.JournalType = (def.TargetDB == "1NI" ? "N" : getJournalPrefix(logDef.OfficeId, logDef.TradingAgencyId)) + "DN";
                */
                def.JournalType = journalType;
                def.Description = "Paid on behalf of";
                def.CurrencyCode = CurrencyId.getCommonName(invoiceDef.Currency.CurrencyId);
                def.OtherAmount = (detailDef.Amount + detailDef.VAT);
                def.T0 = companyOfficeMappingDef.T0Code;
                def.T9 = dcNoteDef.RechargeDCNoteNo;
                def.OfficeCode = OfficeId.getName(logDef.OfficeId);
                def.TradingAgency = TradingAgencyId.getName(logDef.TradingAgencyId);
                def.PaymentTerm = PaymentTermRef.getDescriptionForSAF(logDef.PaymentTermId);

                if (i == detailList.Count && Math.Round(dcNoteDef.RechargeAmount * exRate / baseExRate, 2, MidpointRounding.AwayFromZero) != runningTtlAmt)
                    def.BaseAmount = def.BaseAmount + (Math.Round(dcNoteDef.RechargeAmount * exRate / baseExRate, 2, MidpointRounding.AwayFromZero) - runningTtlAmt);

                safList.Add(def);
            }

            #region debit entry
            def = (SAFDef)def.Clone();
            def.CreateDate = DateTime.Now;
            CompanyOfficeMappingRef tmpMappingDef = generalWorker.getCompanyOfficeMappingByCriteria(dcNoteDef.ToCompanyId, dcNoteDef.ToOfficeId);
            def.AccountCode = tmpMappingDef.SUNAccountCode;

            def.DebitCreditIndicator = "D";
            def.Description = string.Empty;
            def.BaseAmount = Math.Round(dcNoteDef.RechargeAmount * exRate / baseExRate, 2, MidpointRounding.AwayFromZero);
            def.CurrencyCode = CurrencyId.getCommonName(dcNoteDef.RechargeCurrencyId);
            def.OtherAmount = dcNoteDef.RechargeAmount;
            def.T0 = companyOfficeMappingDef.T0Code;
            def.T9 = dcNoteDef.RechargeDCNoteNo;
            safList.Add(def);
            #endregion

            #region part 2 debit entry
            i = 0;
            runningTtlAmt = 0;

            foreach (NTInvoiceDetailDef detailDef in detailList)
            {
                i += 1;
                NTInvoiceDef invoiceDef = NonTradeWorker.Instance.getNTInvoiceByKey(detailDef.InvoiceId);
                CompanyOfficeMappingRef detailCompanyOfficeMappingDef = generalWorker.getCompanyOfficeMappingByCriteria(invoiceDef.Company.Id, invoiceDef.Office.OfficeId);
                def = new SAFDef();

                def.T1 = string.Empty;
                def.T2 = string.Empty;
                def.T3 = string.Empty;
                def.T4 = string.Empty;
                def.T5 = string.Empty;

                decimal detailExRate = commonWorker.getExchangeRate(ExchangeRateType.INVOICE, invoiceDef.Currency.CurrencyId, calcDef.StartDate);

                def.AccountCode = invoiceDef.NTVendor.SUNAccountCode;
                def.TargetDB = generalWorker.getAccountDatabaseByKey(tmpMappingDef.ReportingDatabaseId).DbCode;
                def.FiscalYear = logDef.FiscalYear;
                def.Period = logDef.Period;
                def.TransactionDate = logDef.TransactionDate;
                def.DebitCreditIndicator = "D";
                def.BaseAmount = Math.Round((detailDef.Amount + detailDef.VAT) * detailExRate / baseExRate, 2, MidpointRounding.AwayFromZero);
                runningTtlAmt += def.BaseAmount;
                //def.JournalType = (def.TargetDB == "1NI" ? "N" : getJournalPrefix(logDef.OfficeId, logDef.TradingAgencyId)) + "DN";
                def.JournalType = (def.TargetDB == "1NI" ? "N" : getJournalPrefix(dcNoteDef.ToOfficeId, logDef.TradingAgencyId)) + "ND";
                def.Description = "Settlement of";
                def.CurrencyCode = CurrencyId.getCommonName(invoiceDef.Currency.CurrencyId);
                def.OtherAmount = (detailDef.Amount + detailDef.VAT);
                def.T0 = tmpMappingDef.T0Code;
                def.T4 = invoiceDef.PaymentFromDate.ToString("yyMM");

                /* 2014-04-23
                if (tmpMappingDef.ReportingDatabaseId == CompanyType.NEXT_SOURCING_INDIA.Id)
                    def.T5 = invoiceDef.NTVendor.TallyCode;
                */

                def.T6 = invoiceDef.NTVendor.PaymentMethod.T6Code;
                def.T9 = dcNoteDef.RechargeDCNoteNo;
                def.OfficeCode = OfficeId.getName(dcNoteDef.ToOfficeId);
                def.TradingAgency = TradingAgencyId.getName(logDef.TradingAgencyId);
                def.PaymentTerm = PaymentTermRef.getDescriptionForSAF(logDef.PaymentTermId);

                if (i == detailList.Count && Math.Round(dcNoteDef.RechargeAmount * exRate / baseExRate, 2, MidpointRounding.AwayFromZero) != runningTtlAmt)
                    def.BaseAmount = def.BaseAmount + (Math.Round(dcNoteDef.RechargeAmount * exRate / baseExRate, 2, MidpointRounding.AwayFromZero) - runningTtlAmt);

                safList.Add(def);
            }
            #endregion

            #region part 2 credit entry
            def = (SAFDef)def.Clone();
            def.CreateDate = DateTime.Now;
            def.AccountCode = dcNoteDef.Company.SUNAccountCode;
            def.DebitCreditIndicator = "C";
            def.BaseAmount = Math.Round(dcNoteDef.RechargeAmount * exRate / baseExRate, 2, MidpointRounding.AwayFromZero);
            def.CurrencyCode = CurrencyId.getCommonName(dcNoteDef.RechargeCurrencyId);
            def.OtherAmount = dcNoteDef.RechargeAmount;
            def.T4 = string.Empty;
            safList.Add(def);
            #endregion


        }


        private void addActualNonTradeRechargeDebitNoteToSAFList(SunInterfaceLogDef logDef, ArrayList safList)
        {
            List<NTInvoiceDetailDef> detailList = NonTradeWorker.Instance.getNTInvoiceDetailByRechargeDCNoteId(int.Parse(logDef.ReferenceNo));
            NTRechargeDCNoteDef dcNoteDef = NonTradeWorker.Instance.getNTRechargeDCNoteByDCNoteNo(logDef.DebitCreditNoteNo);

            CompanyOfficeMappingRef companyOfficeMappingDef = generalWorker.getCompanyOfficeMappingByCriteria(dcNoteDef.Company.Id, dcNoteDef.Office.OfficeId);
            int baseCurrencyId = generalWorker.getAccountDatabaseByKey(companyOfficeMappingDef.ReportingDatabaseId).ReportingCurrencyId;
            ICollection coll = generalWorker.getAccountPeriodListByYearPeriod(9, logDef.FiscalYear, logDef.Period);
            AccountFinancialCalenderDef calcDef = null;
            decimal detailExRate;
            ARInvoiceInterfaceEntry arEntry = new ARInvoiceInterfaceEntry();
            APInvoiceInterfaceEntry apEntry = new APInvoiceInterfaceEntry();

            foreach (AccountFinancialCalenderDef cd in coll)
            {
                calcDef = cd;
                break;
            }

            decimal exRate = commonWorker.getExchangeRate(ExchangeRateType.INVOICE, dcNoteDef.RechargeCurrencyId, calcDef.StartDate);
            decimal baseExRate = commonWorker.getExchangeRate(ExchangeRateType.INVOICE, baseCurrencyId, calcDef.StartDate);
            SAFDef def = null;
            int i = 0;
            decimal runningTtlAmt = 0;
            decimal runningTtlOtherAmt = 0;
            decimal runningEpicorAmt = 0;
            CompanyOfficeMappingRef detailCompanyOfficeMappingDef;
            NTInvoiceDef invoiceDef;

            foreach (NTInvoiceDetailDef detailDef in detailList)
            {
                i += 1;
                invoiceDef = NonTradeWorker.Instance.getNTInvoiceByKey(detailDef.InvoiceId);
                detailCompanyOfficeMappingDef = generalWorker.getCompanyOfficeMappingByCriteria(invoiceDef.Company.Id, invoiceDef.Office.OfficeId);
                def = new SAFDef();

                def.T1 = string.Empty;
                def.T2 = string.Empty;
                def.T3 = string.Empty;
                def.T4 = string.Empty;
                def.T5 = string.Empty;

                detailExRate = commonWorker.getExchangeRate(ExchangeRateType.INVOICE, invoiceDef.Currency.CurrencyId, calcDef.StartDate);

                def.AccountCode = "1311308";
                def.TargetDB = generalWorker.getAccountDatabaseByKey(companyOfficeMappingDef.ReportingDatabaseId).DbCode;
                def.FiscalYear = logDef.FiscalYear;
                def.Period = logDef.Period;
                def.TransactionDate = logDef.TransactionDate;
                def.DebitCreditIndicator = (dcNoteDef.DCIndicator == "D" ? "C" : "D");
                def.BaseAmount = Math.Round((detailDef.Amount + detailDef.VAT) * detailExRate / baseExRate, 2, MidpointRounding.AwayFromZero);
                runningTtlAmt += def.BaseAmount;
                def.JournalType = (def.TargetDB == "1NI" ? "N" : getJournalPrefix(logDef.OfficeId, logDef.TradingAgencyId)) + "N" + dcNoteDef.DCIndicator;
                /*
                def.JournalType = (def.TargetDB == "1NI" ? "N" : getJournalPrefix(logDef.OfficeId, logDef.TradingAgencyId)) + "DN";
                */
                def.Description = (invoiceDef.InvoiceNo.Trim() != string.Empty ? invoiceDef.InvoiceNo : invoiceDef.CustomerNo) + " " + logDef.DebitCreditNoteNo;
                def.CurrencyCode = CurrencyId.getCommonName(invoiceDef.Currency.CurrencyId);
                def.OtherAmount = (detailDef.Amount + detailDef.VAT);
                runningTtlOtherAmt += def.OtherAmount;
                def.T0 = detailCompanyOfficeMappingDef.T0Code;
                def.T9 = (invoiceDef.InvoiceNo.Trim() != string.Empty ? invoiceDef.InvoiceNo : invoiceDef.CustomerNo);
                def.OfficeCode = OfficeId.getName(logDef.OfficeId);
                def.TradingAgency = TradingAgencyId.getName(logDef.TradingAgencyId);
                def.PaymentTerm = PaymentTermRef.getDescriptionForSAF(logDef.PaymentTermId);
                /*
                if (i == detailList.Count && Math.Round(dcNoteDef.RechargeAmount * exRate / baseExRate, 2, MidpointRounding.AwayFromZero) != runningTtlAmt)
                    def.BaseAmount = def.BaseAmount + (Math.Round(dcNoteDef.RechargeAmount * exRate / baseExRate, 2, MidpointRounding.AwayFromZero) - runningTtlAmt);
                */
                safList.Add(def);
                SAFDef.addOverSizeDescAsSAFDefs(safList, def);
            }

            #region debit entry part 1
            i = 1;
            foreach (NTInvoiceDetailDef detailDef in detailList)
            {
                invoiceDef = NonTradeWorker.Instance.getNTInvoiceByKey(detailDef.InvoiceId);
                /*
                detailCompanyOfficeMappingDef = generalWorker.getCompanyOfficeMappingByCriteria(invoiceDef.Company.Id, invoiceDef.Office.OfficeId);
                */
                detailCompanyOfficeMappingDef = generalWorker.getCompanyOfficeMappingByCriteria(invoiceDef.Company.Id, detailDef.IntercommOfficeId == -1 ? invoiceDef.Office.OfficeId : detailDef.IntercommOfficeId);
                string[] descList = this.getNTExpenseTypeDescListforSUN(def.AccountCode, detailDef, invoiceDef);
                detailExRate = commonWorker.getExchangeRate(ExchangeRateType.INVOICE, invoiceDef.Currency.CurrencyId, calcDef.StartDate);

                def = (SAFDef)def.Clone();
                def.CreateDate = DateTime.Now;
                if (dcNoteDef.ToVendorId != 0)
                {
                    def.AccountCode = VendorWorker.Instance.getVendorByKey(dcNoteDef.ToVendorId).SunAccountCode;

                    if (companyOfficeMappingDef.ReportingDatabaseId == CompanyType.NEXT_SOURCING_INDIA.Id)
                        def.T5 = "000";

                    /* TODO:EPICOR */
                    apEntry = (APInvoiceInterfaceEntry)apEntry.Clone();
                    apEntry.SupplierId = VendorWorker.Instance.getVendorByKey(dcNoteDef.ToVendorId).EpicorSupplierId;
                    if (dcNoteDef.DCIndicator == "D")
                    {
                        apEntry.DocumentType = APInvoiceDocumentTypeEnum.NON_TRADE_DEBIT_NOTE;
                        apEntry.IsDebitNote = true;
                    }
                    apEntry.COA = generalWorker.getEpicorCOA("1311308");
                    apEntry.InvoiceDate = logDef.TransactionDate;
                    apEntry.GroupId = NonTradeEpicorInterfaceWorker.Instance.APInvoiceInterfaceFile.getSourceString();
                    apEntry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                    apEntry.ApplyDate = apEntry.GroupApplyDate;

                    if (isEnableWeek53Handling(logDef, false))
                    {
                        apEntry.GroupApplyDate = WK53_APPLY_DATE;
                        apEntry.ApplyDate = WK53_APPLY_DATE;
                    }

                    if (logDef.OfficeId == OfficeId.TH.Id)
                    {
                        apEntry.Company = "NSTH";
                        apEntry.Office = "HKTH";
                    }
                    else
                    {
                        /*
                        apEntry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
                        */
                        apEntry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, detailDef.IntercommOfficeId == -1 ? logDef.OfficeId : detailDef.IntercommOfficeId).EpicorCompanyId;
                        apEntry.Office = detailCompanyOfficeMappingDef.T0Code;
                    }

                    if (def.AccountCode == "1320113" && def.T0 == "BA2F")
                        apEntry.Office = "BA1F";
                    apEntry.LineDescription = (invoiceDef.InvoiceNo.Trim() != string.Empty ? invoiceDef.InvoiceNo : invoiceDef.CustomerNo) + " " + logDef.DebitCreditNoteNo;

                    if (descList.Length > 0)
                        apEntry.LineDescription += " \n" + String.Join(" \n", descList);

                    apEntry.Currency = CurrencyId.getCommonName(logDef.CurrencyId);
                    apEntry.UnitCost = Math.Round(Math.Abs(detailDef.Amount + detailDef.VAT) * detailExRate / exRate, 2, MidpointRounding.AwayFromZero);
                    runningEpicorAmt += apEntry.UnitCost;
                    if (i == detailList.Count) apEntry.UnitCost += (dcNoteDef.RechargeAmount - runningEpicorAmt);
                    if ((invoiceDef.DCIndicator == dcNoteDef.DCIndicator && detailDef.Amount < 0) || (invoiceDef.DCIndicator != dcNoteDef.DCIndicator && detailDef.Amount > 0))
                        arEntry.UnitCost *= -1;
                    apEntry.Amount = dcNoteDef.RechargeAmount;
                    apEntry.PaymentTerm = "IN14";
                    apEntry.RealInvoiceNo = dcNoteDef.RechargeDCNoteNo;
                    apEntry.LegalNumber = apEntry.RealInvoiceNo;
                    apEntry.InvoiceNo = apEntry.RealInvoiceNo;

                    apEntry.IsRecordComplete = (i == detailList.Count);
                    NonTradeEpicorInterfaceWorker.Instance.APInvoiceInterfaceFile.Entries.Add((IEpicorInterfaceEntry)apEntry);

                }
                if (dcNoteDef.ToNTVendorId != 0)
                {
                    def.AccountCode = NonTradeWorker.Instance.getNTVendorByKey(dcNoteDef.ToNTVendorId).SUNAccountCode;

                    if (companyOfficeMappingDef.ReportingDatabaseId == CompanyType.NEXT_SOURCING_INDIA.Id)
                        def.T5 = "000";

                    /* TODO:EPICOR */
                    apEntry = (APInvoiceInterfaceEntry)apEntry.Clone();
                    apEntry.SupplierId = NonTradeWorker.Instance.getNTVendorByKey(dcNoteDef.ToNTVendorId).EPVendorCode;
                    if (dcNoteDef.DCIndicator == "D")
                    {
                        apEntry.DocumentType = APInvoiceDocumentTypeEnum.NON_TRADE_DEBIT_NOTE;
                        apEntry.IsDebitNote = true;
                    }
                    apEntry.COA = generalWorker.getEpicorCOA("1311308");
                    apEntry.InvoiceDate = logDef.TransactionDate;
                    apEntry.GroupId = NonTradeEpicorInterfaceWorker.Instance.APInvoiceInterfaceFile.getSourceString();
                    apEntry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                    apEntry.ApplyDate = apEntry.GroupApplyDate;

                    if (isEnableWeek53Handling(logDef, false))
                    {
                        apEntry.GroupApplyDate = WK53_APPLY_DATE;
                        apEntry.ApplyDate = WK53_APPLY_DATE;
                    }

                    if (logDef.OfficeId == OfficeId.TH.Id)
                    {
                        apEntry.Company = "NSTH";
                        apEntry.Office = "HKTH";
                    }
                    else
                    {
                        /*
                        apEntry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
                        */
                        apEntry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, detailDef.IntercommOfficeId == -1 ? logDef.OfficeId : detailDef.IntercommOfficeId).EpicorCompanyId;
                        apEntry.Office = detailCompanyOfficeMappingDef.T0Code;
                    }
                    if (def.AccountCode == "1320113" && def.T0 == "BA2F")
                        apEntry.Office = "BA1F";
                    apEntry.LineDescription = (invoiceDef.InvoiceNo.Trim() != string.Empty ? invoiceDef.InvoiceNo : invoiceDef.CustomerNo) + " " + logDef.DebitCreditNoteNo;
                    if (descList.Length > 0)
                        apEntry.LineDescription += " \n" + String.Join(" \n", descList);

                    apEntry.Currency = CurrencyId.getCommonName(logDef.CurrencyId);
                    apEntry.UnitCost = Math.Round(Math.Abs(detailDef.Amount + detailDef.VAT) * detailExRate / exRate, 2, MidpointRounding.AwayFromZero);
                    runningEpicorAmt += apEntry.UnitCost;
                    if (i == detailList.Count) apEntry.UnitCost += (dcNoteDef.RechargeAmount - runningEpicorAmt);
                    if ((invoiceDef.DCIndicator == dcNoteDef.DCIndicator && detailDef.Amount < 0) || (invoiceDef.DCIndicator != dcNoteDef.DCIndicator && detailDef.Amount > 0))
                        arEntry.UnitCost *= -1;
                    apEntry.Amount = dcNoteDef.RechargeAmount;
                    apEntry.PaymentTerm = "IN14";
                    apEntry.RealInvoiceNo = dcNoteDef.RechargeDCNoteNo;
                    apEntry.LegalNumber = apEntry.RealInvoiceNo;
                    apEntry.InvoiceNo = apEntry.RealInvoiceNo;

                    apEntry.IsRecordComplete = (i == detailList.Count);
                    NonTradeEpicorInterfaceWorker.Instance.APInvoiceInterfaceFile.Entries.Add((IEpicorInterfaceEntry)apEntry);

                }
                else if (dcNoteDef.ToCustomerId != 0)
                {
                    if (detailDef.RechargePartyDept != null && detailDef.RechargePartyDept == NTRechargePartyDeptType.BRAND_FINANCE)
                        def.AccountCode = "1320115";
                    else
                        def.AccountCode = commonWorker.getCustomerByKey(dcNoteDef.ToCustomerId).SUNAccountCode;

                    /* TODO:EPICOR */
                    if (!(detailDef.RechargePartyDept != null && (detailDef.RechargePartyDept == NTRechargePartyDeptType.BRAND_FINANCE || detailDef.RechargePartyDept == NTRechargePartyDeptType.GROUP_FINANCE)))
                    {
                        arEntry = (ARInvoiceInterfaceEntry)arEntry.Clone();
                        arEntry.CustomerId = commonWorker.getCustomerByKey(dcNoteDef.ToCustomerId).EpicorCustomerId;
                        if (dcNoteDef.DCIndicator == "D")
                            arEntry.DocumentType = ARInvoiceDocumentTypeEnum.NON_TRADE_DEBIT_NOTE;
                        else
                        {
                            arEntry.DocumentType = ARInvoiceDocumentTypeEnum.NON_TRADE_CREDIT_NOTE;
                            arEntry.IsCreditNote = true;
                        }
                        arEntry.COA = generalWorker.getEpicorCOA("1311308");
                        arEntry.GroupId = NonTradeEpicorInterfaceWorker.Instance.ARInvoiceInterfaceFile.getSourceString();
                        arEntry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                        arEntry.ApplyDate = arEntry.GroupApplyDate;

                        if (isEnableWeek53Handling(logDef, false))
                        {
                            arEntry.GroupApplyDate = WK53_APPLY_DATE;
                            arEntry.ApplyDate = WK53_APPLY_DATE;
                        }

                        if (logDef.OfficeId == OfficeId.TH.Id)
                        {
                            arEntry.Company = "NSTH";
                            arEntry.Office = "HKTH";
                        }
                        else
                        {
                            arEntry.Office = detailCompanyOfficeMappingDef.T0Code;
                            /*
                            arEntry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
                            */
                            arEntry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, detailDef.IntercommOfficeId == -1 ? logDef.OfficeId : detailDef.IntercommOfficeId).EpicorCompanyId;
                        }
                        arEntry.LineDescription = logDef.DebitCreditNoteNo;
                        if (descList.Length > 0)
                            arEntry.LineDescription += (" \n" + String.Join(" \n", descList) + " \nex." + invoiceDef.NTVendor.VendorName);
                        arEntry.Currency = CurrencyId.getCommonName(logDef.CurrencyId);

                        arEntry.UnitCost = Math.Round(Math.Abs(detailDef.Amount + detailDef.VAT) * detailExRate / exRate, 2, MidpointRounding.AwayFromZero);
                        runningEpicorAmt += arEntry.UnitCost;
                        if (i == detailList.Count) arEntry.UnitCost += (dcNoteDef.RechargeAmount - runningEpicorAmt);
                        if ((invoiceDef.DCIndicator == dcNoteDef.DCIndicator && detailDef.Amount < 0) || (invoiceDef.DCIndicator != dcNoteDef.DCIndicator && detailDef.Amount > 0))
                            arEntry.UnitCost *= -1;
                        arEntry.Amount = dcNoteDef.RechargeAmount;
                        arEntry.InvoiceDate = logDef.TransactionDate;
                        arEntry.RealInvoiceNo = dcNoteDef.RechargeDCNoteNo;
                        arEntry.LegalNumber = arEntry.RealInvoiceNo;
                        arEntry.InvoiceNo = arEntry.RealInvoiceNo;

                        arEntry.IsRecordComplete = (i == detailList.Count);
                        NonTradeEpicorInterfaceWorker.Instance.ARInvoiceInterfaceFile.Entries.Add((IEpicorInterfaceEntry)arEntry);
                    }
                    else
                    {
                        GLInterfaceEntry glEntry = new GLInterfaceEntry();

                        if (logDef.OfficeId == OfficeId.TH.Id)
                        {
                            glEntry.Company = "NSTH";
                            glEntry.Office = "HKTH";
                        }
                        else
                        {
                            glEntry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
                            glEntry.Office = detailCompanyOfficeMappingDef.T0Code;
                        }
                        glEntry.GroupId = NonTradeEpicorInterfaceWorker.Instance.GLInterfaceFile.getSourceString();
                        glEntry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                        glEntry.ApplyDate = glEntry.GroupApplyDate;

                        if (isEnableWeek53Handling(logDef, false))
                        {
                            glEntry.GroupApplyDate = WK53_APPLY_DATE;
                            glEntry.ApplyDate = WK53_APPLY_DATE;
                        }

                        glEntry.DocumentType = GLDocumentTypeEnum.GL;
                        glEntry.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
                        glEntry.DC = (dcNoteDef.DCIndicator == "D" ? DCFlag.Debit : DCFlag.Credit);
                        glEntry.Amount = Math.Round(Math.Abs(detailDef.Amount + detailDef.VAT) * detailExRate / exRate, 2, MidpointRounding.AwayFromZero);

                        decimal usdRate = commonWorker.getExchangeRate(ExchangeRateType.INVOICE, CurrencyId.USD.Id, calcDef.StartDate);

                        glEntry.BaseAmount = Math.Round((detailDef.Amount + detailDef.VAT) * detailExRate / usdRate, 2, MidpointRounding.AwayFromZero);

                        glEntry.LineDescription = logDef.DebitCreditNoteNo;
                        if (descList.Length > 0)
                            glEntry.LineDescription += (" \n" + String.Join(" \n", descList) + " \nex." + invoiceDef.NTVendor.VendorName);
                        if (detailDef.RechargePartyDept == NTRechargePartyDeptType.BRAND_FINANCE)
                            glEntry.COA = "1301020";
                        else
                            glEntry.COA = "1301410";
                        glEntry.IsRecordComplete = false;
                        NonTradeEpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                        glEntry = (GLInterfaceEntry)glEntry.Clone();
                        glEntry.DC = (dcNoteDef.DCIndicator == "D" ? DCFlag.Credit : DCFlag.Debit);
                        glEntry.COA = generalWorker.getEpicorCOA("1311308");
                        glEntry.CurrencyCode = CurrencyId.getCommonName(invoiceDef.Currency.CurrencyId);
                        glEntry.Amount = Math.Round(Math.Abs(detailDef.Amount + detailDef.VAT), 2, MidpointRounding.AwayFromZero);
                        glEntry.LineDescription = (String.Join(" \n", descList) + " \nex." + invoiceDef.NTVendor.VendorName);
                        glEntry.IsRecordComplete = true;
                        NonTradeEpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);
                    }
                }
                else if (dcNoteDef.ToOfficeId != 0 && dcNoteDef.ToCompanyId != 0 && dcNoteDef.Company.Id != dcNoteDef.ToCompanyId && dcNoteDef.ToCompanyId == 4)
                {
                    CompanyOfficeMappingRef tmpMappingDef = generalWorker.getCompanyOfficeMappingByCriteria(dcNoteDef.ToCompanyId, dcNoteDef.ToOfficeId);
                    def.AccountCode = tmpMappingDef.SUNAccountCode;

                    GLInterfaceEntry glEntry = new GLInterfaceEntry();

                    if (logDef.OfficeId == OfficeId.TH.Id)
                    {
                        glEntry.Company = "NSTH";
                        glEntry.Office = "HKTH";
                    }
                    else
                    {
                        glEntry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
                        glEntry.Office = detailCompanyOfficeMappingDef.T0Code;
                    }

                    glEntry.GroupId = NonTradeEpicorInterfaceWorker.Instance.GLInterfaceFile.getSourceString();
                    glEntry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                    glEntry.ApplyDate = glEntry.GroupApplyDate;

                    if (isEnableWeek53Handling(logDef, false))
                    {
                        glEntry.GroupApplyDate = WK53_APPLY_DATE;
                        glEntry.ApplyDate = WK53_APPLY_DATE;
                    }

                    glEntry.DocumentType = GLDocumentTypeEnum.GL;
                    glEntry.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
                    glEntry.DC = (dcNoteDef.DCIndicator == "D" ? DCFlag.Debit : DCFlag.Credit);
                    glEntry.Amount = Math.Round(Math.Abs(detailDef.Amount + detailDef.VAT) * detailExRate / exRate, 2, MidpointRounding.AwayFromZero);

                    decimal usdRate = commonWorker.getExchangeRate(ExchangeRateType.INVOICE, CurrencyId.USD.Id, calcDef.StartDate);

                    glEntry.BaseAmount = Math.Round((detailDef.Amount + detailDef.VAT) * detailExRate / usdRate, 2, MidpointRounding.AwayFromZero);

                    glEntry.LineDescription = logDef.DebitCreditNoteNo;
                    if (descList.Length > 0)
                        glEntry.LineDescription += (" \n" + String.Join(" \n", descList) + " \nex." + invoiceDef.NTVendor.VendorName);
                    glEntry.COA = "1301120";
                    glEntry.IsMultiCompany = true;
                    glEntry.ExternalCompany = "UKUK";
                    glEntry.ExternalCOA = "1226011";
                    glEntry.ExternalOffice = "UK1F";
                    glEntry.IsRecordComplete = false;
                    NonTradeEpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                    glEntry = (GLInterfaceEntry)glEntry.Clone();
                    glEntry.DC = (dcNoteDef.DCIndicator == "D" ? DCFlag.Credit : DCFlag.Debit);
                    glEntry.COA = generalWorker.getEpicorCOA("1311308");
                    glEntry.CurrencyCode = CurrencyId.getCommonName(invoiceDef.Currency.CurrencyId);
                    glEntry.Amount = Math.Round(Math.Abs(detailDef.Amount + detailDef.VAT), 2, MidpointRounding.AwayFromZero);
                    glEntry.LineDescription = (String.Join(" \n", descList) + " \nex." + invoiceDef.NTVendor.VendorName);

                    glEntry.IsMultiCompany = false;
                    glEntry.ExternalCompany = string.Empty;
                    glEntry.ExternalCOA = string.Empty;
                    glEntry.ExternalOffice = string.Empty;

                    glEntry.IsRecordComplete = true;
                    NonTradeEpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);
                }

                def.DebitCreditIndicator = (dcNoteDef.DCIndicator == "D" ? "D" : "C");
                def.Description = logDef.DebitCreditNoteNo;

                /*
                if (def.AccountCode == "1320113" || def.AccountCode == "1320114")
                    def.Description = logDef.DebitCreditNoteNo;
                else
                    def.Description = string.Empty;
                */

                /*
                def.BaseAmount = dcNoteDef.RechargeAmount;
                def.OtherAmount = Math.Round(dcNoteDef.RechargeAmount * baseExRate / exRate, 2, MidpointRounding.AwayFromZero);
                */
                def.BaseAmount = runningTtlAmt;
                def.CurrencyCode = CurrencyId.getCommonName(dcNoteDef.RechargeCurrencyId);
                def.OtherAmount = dcNoteDef.RechargeAmount;

                /*
                def.BaseAmount = runningTtlAmt;
                def.OtherAmount = runningTtlOtherAmt;
                */
                def.T0 = companyOfficeMappingDef.T0Code;
                if (def.AccountCode == "1320113" && def.T0 == "BA2F")
                    def.T0 = "BA1F";
                def.T9 = dcNoteDef.RechargeDCNoteNo;
                if (i == 1) safList.Add(def);

                /*
                if (def.AccountCode == "1320113" || def.AccountCode == "1320114")
                {
                    def = (SAFDef)def.Clone();
                    SAFDef.setDescOnlySAFDef(def);
                    string[] descList = this.getNTExpenseTypeDescListforSUN(detailDef, invoiceDef);
                    if (descList.Length > 0) def.Description = descList[0];
                    safList.Add(def);
                    SAFDef.addDescArrayAsSAFDefs(safList, def, descList);

                    def = (SAFDef)def.Clone();
                    SAFDef.setDescOnlySAFDef(def);
                    def.Description = "ex. " + invoiceDef.NTVendor.VendorName.Replace(',', ' ');
                    safList.Add(def);
                }
                */
                if (i == 1)
                {
                    def = (SAFDef)def.Clone();
                    SAFDef.setDescOnlySAFDef(def);
                    if (descList.Length > 0) def.Description = descList[0];
                    safList.Add(def);
                    SAFDef.addDescArrayAsSAFDefs(safList, def, descList);

                    def = (SAFDef)def.Clone();
                    SAFDef.setDescOnlySAFDef(def);
                    def.Description = "ex. " + invoiceDef.NTVendor.VendorName.Replace(',', ' ');
                    safList.Add(def);
                }

                i++;
            }
            #endregion

            i = 0;
            runningTtlAmt = 0;
            runningTtlOtherAmt = 0;
            GLInterfaceEntry entry = new GLInterfaceEntry();

            foreach (NTInvoiceDetailDef detailDef in detailList)
            {
                i += 1;
                if (dcNoteDef.ToOfficeId != 0 && dcNoteDef.ToCompanyId != 0 && dcNoteDef.Company.Id != dcNoteDef.ToCompanyId)
                {
                    invoiceDef = NonTradeWorker.Instance.getNTInvoiceByKey(detailDef.InvoiceId);
                    detailCompanyOfficeMappingDef = generalWorker.getCompanyOfficeMappingByCriteria(invoiceDef.Company.Id, invoiceDef.Office.OfficeId);
                    CompanyOfficeMappingRef tmpMappingDef = generalWorker.getCompanyOfficeMappingByCriteria(dcNoteDef.ToCompanyId, dcNoteDef.ToOfficeId);
                    decimal detailBaseExRate = commonWorker.getExchangeRate(ExchangeRateType.INVOICE, generalWorker.getAccountDatabaseByKey(tmpMappingDef.ReportingDatabaseId).ReportingCurrencyId, calcDef.StartDate);

                    def = new SAFDef();

                    def.T1 = string.Empty;
                    def.T2 = string.Empty;
                    def.T3 = string.Empty;
                    def.T4 = string.Empty;
                    def.T5 = string.Empty;

                    detailExRate = commonWorker.getExchangeRate(ExchangeRateType.INVOICE, invoiceDef.Currency.CurrencyId, calcDef.StartDate);

                    def.AccountCode = detailDef.ExpenseType.SUNAccountCode;
                    def.TargetDB = generalWorker.getAccountDatabaseByKey(tmpMappingDef.ReportingDatabaseId).DbCode;
                    def.FiscalYear = logDef.FiscalYear;
                    def.Period = logDef.Period;
                    def.TransactionDate = logDef.TransactionDate;
                    def.DebitCreditIndicator = "D";
                    def.BaseAmount = Math.Round((detailDef.Amount + detailDef.VAT) * detailExRate / detailBaseExRate, 2, MidpointRounding.AwayFromZero);
                    runningTtlAmt += def.BaseAmount;
                    def.JournalType = (def.TargetDB == "1NI" ? "N" : getJournalPrefix(dcNoteDef.ToOfficeId, logDef.TradingAgencyId)) + "N" + dcNoteDef.DCIndicator;  // 2014-06-04
                    /*
                    def.JournalType = (def.TargetDB == "1NI" ? "N" : getJournalPrefix(dcNoteDef.ToOfficeId, logDef.TradingAgencyId)) + "DN";
                    */
                    def.Description = string.Empty;
                    def.CurrencyCode = CurrencyId.getCommonName(invoiceDef.Currency.CurrencyId);
                    def.OtherAmount = (detailDef.Amount + detailDef.VAT);
                    runningTtlOtherAmt += def.OtherAmount;
                    def.T0 = tmpMappingDef.T0Code;
                    if (detailDef.ExpenseType.IsDepartmentCode == 1) def.T1 = detailDef.CostCenter.Code;
                    if (detailDef.ExpenseType.IsProductCode == 1) def.T2 = detailDef.ProductTeam.Code;
                    if (detailDef.ExpenseType.IsStaffCode == 1)
                    {
                        UserInfoDef userDef = generalWorker.getUserInfoByKey(detailDef.User.UserId);

                        def.T3 = (userDef == null ? string.Empty : userDef.SunStaffCode);
                    }

                    if (detailDef.ExpenseType.IsSeasonCode == 1)
                        def.T5 = getT5Code(detailDef.Season.SeasonId);
                    if (detailDef.ExpenseType.IsDevSampleCostType == 1)
                        def.T5 = NTDevSampleCostType.getType(detailDef.DevSampleCostTypeId).SampleCostTypeCode;
                    if (detailDef.ExpenseType.SUNAccountCode == "1412101")
                        def.T5 = ExpenseNature.getType(detailDef.NatureIdForAccrual).AnalysisCode;

                    if (companyOfficeMappingDef.ReportingDatabaseId == CompanyType.NEXT_SOURCING_INDIA.Id)
                        def.T5 = detailDef.ExpenseType.TallyCode;

                    def.T9 = dcNoteDef.RechargeDCNoteNo;
                    def.OfficeCode = OfficeId.getName(dcNoteDef.ToOfficeId);
                    def.TradingAgency = TradingAgencyId.getName(logDef.TradingAgencyId);
                    def.PaymentTerm = PaymentTermRef.getDescriptionForSAF(logDef.PaymentTermId);
                    /*
                    if (i == detailList.Count && Math.Round(dcNoteDef.RechargeAmount * exRate / baseExRate, 2, MidpointRounding.AwayFromZero) != runningTtlAmt)
                        def.BaseAmount = def.BaseAmount + (Math.Round(dcNoteDef.RechargeAmount * exRate / baseExRate, 2, MidpointRounding.AwayFromZero) - runningTtlAmt);
                    */
                    safList.Add(def);

                    /*
                    entry = new GLInterfaceEntry();
                    entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
                    entry.GroupId = NonTradeEpicorInterfaceWorker.Instance.GLInterfaceFile.getSourceString();
                    entry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                    entry.ApplyDate = entry.GroupApplyDate;
                    entry.DocumentType = GLDocumentTypeEnum.GL;
                    entry.CurrencyCode = CurrencyId.getCommonName(invoiceDef.Currency.CurrencyId);
                    entry.DC = DCFlag.Debit;
                    entry.Amount = (detailDef.Amount + detailDef.VAT);
                    entry.BaseAmount = Math.Round((detailDef.Amount + detailDef.VAT) * detailExRate / detailBaseExRate, 2, MidpointRounding.AwayFromZero);
                    entry.LineDescription = logDef.ContractNo + "-" + logDef.DeliveryNo.ToString() + " #" + ProductWorker.Instance.getProductByKey(logDef.ProductId).ItemNo + " " + getT9Code(logDef);
                    entry.Office = getT0Code(logDef);
                    entry.COA = generalWorker.getEpicorCOA(def.AccountCode);
                    entry.IsRecordComplete = false;
                    entry.SegmentValue3 = getT1Code(logDef);
                    entry.SegmentValue4 = generalWorker.getProductCodeDefByKey(logDef.ProductTeamId).Code;
                    entry.SegmentValue5 = getSeasonSegmentValue(logDef.SeasonId);
                    EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);
                    */
                }
            }

            if (dcNoteDef.ToOfficeId != 0 && dcNoteDef.ToCompanyId != 0 && dcNoteDef.Company.Id != dcNoteDef.ToCompanyId)
            {
                CompanyOfficeMappingRef tmpMappingDef = generalWorker.getCompanyOfficeMappingByCriteria(dcNoteDef.ToCompanyId, dcNoteDef.ToOfficeId);
                decimal detailBaseExRate = commonWorker.getExchangeRate(ExchangeRateType.INVOICE, generalWorker.getAccountDatabaseByKey(tmpMappingDef.ReportingDatabaseId).ReportingCurrencyId, calcDef.StartDate);

                #region credit entry part 2
                def = (SAFDef)def.Clone();
                def.CreateDate = DateTime.Now;
                def.AccountCode = generalWorker.getCompanyByKey(dcNoteDef.ToCompanyId).SUNAccountCode;

                def.DebitCreditIndicator = "C";
                def.Description = string.Empty;

                def.BaseAmount = runningTtlAmt;
                def.CurrencyCode = CurrencyId.getCommonName(dcNoteDef.RechargeCurrencyId);
                def.OtherAmount = dcNoteDef.RechargeAmount;

                /*
                def.BaseAmount = runningTtlAmt;
                def.OtherAmount = runningTtlOtherAmt;
                */

                def.T1 = string.Empty;
                def.T2 = string.Empty;
                def.T3 = string.Empty;
                def.T4 = string.Empty;
                def.T5 = string.Empty;
                safList.Add(def);
                #endregion
            }

        }


        private void addActualNonTradeBankPaymentToSAFList(SunInterfaceLogDef logDef, ArrayList safList)
        {
            NTInvoiceDef invoiceDef = NonTradeWorker.Instance.getNTInvoiceByKey(int.Parse(logDef.ReferenceNo));

            CompanyOfficeMappingRef companyOfficeMappingDef = generalWorker.getCompanyOfficeMappingByCriteria(invoiceDef.Company.Id, invoiceDef.Office.OfficeId);
            int baseCurrencyId = generalWorker.getAccountDatabaseByKey(companyOfficeMappingDef.ReportingDatabaseId).ReportingCurrencyId;

            ICollection coll = generalWorker.getAccountPeriodListByYearPeriod(9, logDef.FiscalYear, logDef.Period);
            AccountFinancialCalenderDef calcDef = null;
            foreach (AccountFinancialCalenderDef cd in coll)
            {
                calcDef = cd;
                break;
            }

            decimal exRate = commonWorker.getExchangeRate(ExchangeRateType.INVOICE, invoiceDef.Currency.CurrencyId, calcDef.StartDate);
            decimal baseExRate = commonWorker.getExchangeRate(ExchangeRateType.INVOICE, baseCurrencyId, calcDef.StartDate);
            decimal baseUSExRate = commonWorker.getExchangeRate(ExchangeRateType.INVOICE, CurrencyId.USD.Id, calcDef.StartDate);
            SAFDef def = new SAFDef(); ;

            if (invoiceDef.IsPayByHK == 1 && invoiceDef.Company.Id != CompanyType.NEXT_SOURCING.Id)
            {
                def.AccountCode = "1311308"; // other receivable
                def.Filler1 = "OTHER RECEIVABLE - RECHARGE";
            }
            else
            {
                def.AccountCode = invoiceDef.NTVendor.SUNAccountCode;
                def.Filler1 = invoiceDef.NTVendor.VendorName.Replace(',', ' ');
                def.T6 = invoiceDef.NTVendor.PaymentMethod.T6Code;

                /* 2014-04-23
                if (companyOfficeMappingDef.ReportingDatabaseId == CompanyType.NEXT_SOURCING_INDIA.Id)
                    def.T5 = invoiceDef.NTVendor.TallyCode;
                */
            }
            def.TargetDB = generalWorker.getAccountDatabaseByKey(companyOfficeMappingDef.ReportingDatabaseId).DbCode;
            def.FiscalYear = logDef.FiscalYear;
            def.Period = logDef.Period;
            def.TransactionDate = logDef.TransactionDate;
            def.DebitCreditIndicator = (invoiceDef.DCIndicator == "D" ? "D" : "C");
            def.BaseAmount = Math.Round((invoiceDef.Amount + invoiceDef.TotalVAT) * exRate / (invoiceDef.IsPayByHK == 1 ? baseUSExRate : baseExRate), 2, MidpointRounding.AwayFromZero);
            /*
            def.JournalType = (def.TargetDB == "1NI" ? "N" : getJournalPrefix(logDef.OfficeId, logDef.TradingAgencyId)) + "PV";
            */
            def.JournalType = (def.TargetDB == "1NI" ? "N" : getJournalPrefix(logDef.OfficeId, logDef.TradingAgencyId)) + "NP"; // 2014-06-04
            def.Description = "Settlement of " + (invoiceDef.InvoiceNo.Trim() != string.Empty ? invoiceDef.InvoiceNo : invoiceDef.CustomerNo);
            def.CurrencyCode = invoiceDef.Currency.CurrencyCode;
            def.OtherAmount = invoiceDef.Amount + invoiceDef.TotalVAT;
            def.T0 = invoiceDef.IsPayByHK == 0 ? companyOfficeMappingDef.T0Code : companyOfficeMappingDef.InterComT0Code;
            def.T4 = invoiceDef.PaymentFromDate.ToString("yyMM");
            def.T6 = invoiceDef.PaymentMethod.T6Code;
            def.T9 = (invoiceDef.InvoiceNo.Trim() != string.Empty ? invoiceDef.InvoiceNo : invoiceDef.CustomerNo);
            def.OfficeCode = OfficeId.getName(logDef.OfficeId);
            def.TradingAgency = TradingAgencyId.getName(logDef.TradingAgencyId);
            def.PaymentTerm = PaymentTermRef.getDescriptionForSAF(logDef.PaymentTermId);
            safList.Add(def);
            SAFDef.addOverSizeDescAsSAFDefs(safList, def);

            def = (SAFDef)def.Clone();
            SAFDef.setDescOnlySAFDef(def);
            def.Description = invoiceDef.PaymentMethod.Name + " " + invoiceDef.NTVendor.VendorName.Replace(',', ' ');
            safList.Add(def);
            SAFDef.addOverSizeDescAsSAFDefs(safList, def);

        }

        private void addActualARToSAFList(SunInterfaceLogDef logDef, ArrayList safList)
        {
            string t0 = getT0Code(logDef);
            System.Diagnostics.Debug.WriteLine("Shipment Id: " + logDef.ShipmentId.ToString());

            ReceiptInterfaceEntry entry = new ReceiptInterfaceEntry();

            if (logDef.CustomerId == CustomerDef.Id.choice.GetHashCode())
                entry.CustomerId = "NAR005";
            else if (logDef.CustomerId == CustomerDef.Id.lipsy.GetHashCode())
                entry.CustomerId = "NAR004";
            else if (logDef.CustomerId == CustomerDef.Id.global_licensing.GetHashCode())
                entry.CustomerId = "NAR008";
            else if (logDef.CustomerId == CustomerDef.Id.blues_clothing.GetHashCode())
                entry.CustomerId = "NAR018";
            else if (logDef.CustomerId == CustomerDef.Id.william_lamb.GetHashCode())
                entry.CustomerId = "NAR019";
            else if (logDef.CustomerId == CustomerDef.Id.fabric_flavours.GetHashCode())
                entry.CustomerId = "NAR020";
            else if (logDef.CustomerId == CustomerDef.Id.brand_alliance.GetHashCode())
                entry.CustomerId = "NAR017";
            else if (logDef.CustomerId == CustomerDef.Id.brand_international.GetHashCode())
                entry.CustomerId = "NAR014";
            else if (logDef.CustomerId == CustomerDef.Id.gt.GetHashCode())
                entry.CustomerId = "UNDEFINED";
            else
                entry.CustomerId = "NAR001";

            string curVal = (string)receiptGrpTbl[CurrencyId.getCommonName(logDef.CurrencyId)];

            entry.GroupId = curVal.Split('|')[0];
            entry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
            entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;

            //if (t0 == "THV2") entry.Office = "TH2F"; removed 2018-10-31 , request by wing choy
            if (t0 == "HK1G" || t0 == "FBHK" || t0 == "HKFB") entry.Office = "HK1F";
            else if (t0 == "FBSH" || t0 == "SHFB") entry.Office = "SH2F";
            else if (t0 == "FBVN" || t0 == "VNFB") entry.Office = "THV2";
            else if (t0 == "TKEF" || t0 == "TK5F") entry.Office = "TK1F";
            else if (t0 == "THV2" && logDef.OfficeId == OfficeId.VN.Id && logDef.CurrencyId == CurrencyId.USD.Id) entry.Office = "THV2";
            else entry.Office = t0;

            if (logDef.CurrencyId == CurrencyId.USD.Id)
                entry.BankAccount = "DMUSD";
            else if (logDef.CurrencyId == CurrencyId.GBP.Id)
                entry.BankAccount = "DMGBP";
            else if (logDef.CurrencyId == CurrencyId.EUR.Id)
                entry.BankAccount = "DMEUR";
            else
                entry.BankAccount = "UNDEFINED";
            entry.InvoiceAmount = logDef.OtherAmount;
            entry.ReceiptAmount = Convert.ToDecimal(curVal.Split('|')[1]);

            SunInterfaceLogDef latestLog = this.getLatestLogByShipmentId(SunInterfaceTypeRef.Id.Sales.GetHashCode(), logDef.ShipmentId, logDef.SplitShipmentId);

            string suffix = string.Empty;
            suffix = this.getReversalSuffix(latestLog.SunInterfaceLogId);
            entry.InvoiceNo = getT9Code(logDef) + (suffix != string.Empty ? "-" + suffix : string.Empty);
            entry.CheckNo = Convert.ToInt32(curVal.Split('|')[2]);
            EpicorInterfaceWorker.Instance.ReceiptInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);

            if (logDef.OtherTax != 0)
            {
                GLInterfaceEntry glEntry = new GLInterfaceEntry();
                glEntry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
                glEntry.GroupId = EpicorInterfaceWorker.Instance.GLInterfaceFile.getSourceString();
                glEntry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                glEntry.ApplyDate = entry.GroupApplyDate;
                glEntry.DocumentType = GLDocumentTypeEnum.GL;
                glEntry.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
                if (logDef.BaseTax > 0)
                    glEntry.DC = DCFlag.Debit;
                else
                    glEntry.DC = DCFlag.Credit;
                glEntry.Amount = Math.Abs(logDef.OtherTax);
                glEntry.BaseAmount = Math.Abs(logDef.BaseTax);
                glEntry.Qty = logDef.Quantity * logDef.PiecesPerPack;
                glEntry.LineDescription = getT9Code(logDef);
                glEntry.LineComment = DateTimeUtility.getDateString(latestLog.TransactionDate) + "|" + ProductWorker.Instance.getProductByKey(logDef.ProductId).ItemNo + "|" + generalWorker.getProductCodeDefByKey(logDef.ProductTeamId).Code + "|" + logDef.ContractNo + "|" + logDef.Quantity.ToString() + "|" + logDef.OtherAmount.ToString() + "|" + (logDef.OtherAmount - logDef.OtherTax).ToString();
                if (t0 == "SHV2") glEntry.Office = "SH2F";
                else glEntry.Office = entry.Office;

                if (logDef.BaseTax <= 1 && logDef.BaseTax >= -1)
                {
                    glEntry.COA = generalWorker.getEpicorCOA("4104803");

                    if (logDef.OfficeId == OfficeId.TR.Id)
                    {
                        if (logDef.CurrencyId == CurrencyId.GBP.Id)
                            glEntry.COA = "2516010";
                        else if (logDef.CurrencyId == CurrencyId.EUR.Id)
                            glEntry.COA = "2516011";
                    }
                    glEntry.SegmentValue3 = (logDef.OfficeId == OfficeId.HK.Id) ? "711" : "721";
                }
                else
                {
                    ShipmentDef shipmentDef = OrderSelectWorker.Instance.getShipmentByKey(logDef.ShipmentId);
                    ContractDef contractDef = OrderSelectWorker.Instance.getContractByKey(shipmentDef.ContractId);

                    if ((logDef.CustomerId == CustomerDef.Id.ns_led.GetHashCode() || logDef.CustomerId == CustomerDef.Id.manu_led.GetHashCode()) && commonWorker.getNSLedSelfBilledSupplierCodeList().Contains(contractDef.UKSupplierCode))
                        glEntry.COA = "1450070";
                    else
                        glEntry.COA = "1450020";

                    addNewILSDiffDCNoteShipment(logDef);
                }
                glEntry.IsRecordComplete = true;
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);
            }
        }

        private void addNewILSDiffDCNoteShipment(SunInterfaceLogDef logDef)
        {
            int ilsType = 0;
            if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.AccountReceivable.GetHashCode())
                ilsType = 1;
            else if (logDef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.SalesCommissionSettlement.GetHashCode())
                ilsType = 2;
            if (ilsType > 0)
            {
                ILSDiffDCNoteShipmentDef df = new ILSDiffDCNoteShipmentDef();
                df.FiscalYear = logDef.FiscalYear;
                df.Period = logDef.Period;
                df.ILSType = ilsType;
                df.ShipmentId = logDef.ShipmentId;
                df.OfficeId = logDef.OfficeId;
                df.DeptId = logDef.DeptId;
                df.ProductTeamId = logDef.ProductTeamId;
                df.ContractId = OrderSelectWorker.Instance.getShipmentByKey(logDef.ShipmentId).ContractId;
                df.ProductId = logDef.ProductId;
                df.CurrencyId = logDef.CurrencyId;
                df.NSSAmt = logDef.OtherAmount;
                df.ReceivedAmt = logDef.OtherAmount - logDef.OtherTax;
                df.ILSDiffAmt = logDef.OtherTax;
                df.DCNoteId = -1;
                df.Status = 1;
                updateILSDiffDCNoteShipment(df, 99999);
            }
        }

        private void addActualSalesCommissionSettlementToSAFList(SunInterfaceLogDef logDef, ArrayList safList)
        {
            string t0 = getT0Code(logDef);

            ReceiptInterfaceEntry entry = new ReceiptInterfaceEntry();
            string curVal = (string)receiptGrpTbl[CurrencyId.getCommonName(logDef.CurrencyId)];

            entry.GroupId = curVal.Split('|')[0];
            entry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
            entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;

            if (t0 == "THV2") entry.Office = "TH2F";
            if (t0 == "HK1G" || t0 == "FBHK" || t0 == "HKFB") entry.Office = "HK1F";
            else if (t0 == "FBSH" || t0 == "SHFB") entry.Office = "SH2F";
            else if (t0 == "FBVN" || t0 == "VNFB") entry.Office = "THV2";
            else if (t0 == "TKEF" || t0 == "TK5F") entry.Office = "TK1F";
            else if (t0 == "THV2" && logDef.OfficeId == OfficeId.VN.Id && logDef.CurrencyId == CurrencyId.USD.Id) entry.Office = "THV2";
            else entry.Office = t0;

            if (logDef.CurrencyId == CurrencyId.USD.Id)
                entry.BankAccount = "DMUSD";
            else if (logDef.CurrencyId == CurrencyId.GBP.Id)
                entry.BankAccount = "DMGBP";
            else if (logDef.CurrencyId == CurrencyId.EUR.Id)
                entry.BankAccount = "DMEUR";
            else
                entry.BankAccount = "UNDEFINED";
            entry.InvoiceAmount = logDef.OtherAmount;
            entry.ReceiptAmount = Convert.ToDecimal(curVal.Split('|')[1]);

            if (logDef.TermOfPurchaseId == TermOfPurchaseRef.Id.FOB_UT.GetHashCode())
                entry.CustomerId = "UNDEFINED";
            else if (logDef.CustomerId == CustomerDef.Id.hempel.GetHashCode() && logDef.CurrencyId == CurrencyId.USD.Id)
                entry.CustomerId = "UNDEFINED";
            else if (logDef.CustomerId == CustomerDef.Id.choice.GetHashCode())
                entry.CustomerId = "NAR005";
            else if (logDef.CustomerId == CustomerDef.Id.fashionUK.GetHashCode())
                entry.CustomerId = "NAR007";
            else if (logDef.CustomerId == CustomerDef.Id.bioworld.GetHashCode())
                entry.CustomerId = "NAR002";
            else if (logDef.CustomerId == CustomerDef.Id.misirli.GetHashCode())
                entry.CustomerId = "NAR009";
            else if (logDef.CustomerId == CustomerDef.Id.global_licensing.GetHashCode())
                entry.CustomerId = "NAR002";
            else if (logDef.CustomerId == CustomerDef.Id.lipsy.GetHashCode())
                entry.CustomerId = "NAR004";
            else if (CustomerDef.isNextUK(logDef.CustomerId))
                entry.CustomerId = "NAR002";

            SunInterfaceLogDef latestLog = this.getLatestLogByShipmentId(SunInterfaceTypeRef.Id.SalesCommission.GetHashCode(), logDef.ShipmentId, logDef.SplitShipmentId);

            string suffix = this.getReversalSuffix(latestLog.SunInterfaceLogId);
            entry.InvoiceNo = getT9Code(logDef) + "C" + (suffix != string.Empty ? "-" + suffix : string.Empty);
            entry.CheckNo = Convert.ToInt32(curVal.Split('|')[2]);
            EpicorInterfaceWorker.Instance.ReceiptInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);

            if (logDef.OtherTax != 0)
            {
                GLInterfaceEntry glEntry = new GLInterfaceEntry();
                glEntry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
                glEntry.GroupId = EpicorInterfaceWorker.Instance.GLInterfaceFile.getSourceString();
                glEntry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                glEntry.ApplyDate = glEntry.GroupApplyDate;
                glEntry.DocumentType = GLDocumentTypeEnum.GL;
                glEntry.Qty = logDef.Quantity * logDef.PiecesPerPack;
                glEntry.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
                if (logDef.BaseTax > 0)
                    glEntry.DC = DCFlag.Debit;
                else
                    glEntry.DC = DCFlag.Credit;
                glEntry.Amount = Math.Abs(logDef.OtherTax);
                glEntry.BaseAmount = Math.Abs(logDef.BaseTax);
                glEntry.LineDescription = getT9Code(logDef) + "C";
                glEntry.LineComment = DateTimeUtility.getDateString(latestLog.TransactionDate) + "|" + ProductWorker.Instance.getProductByKey(logDef.ProductId).ItemNo + "|" + generalWorker.getProductCodeDefByKey(logDef.ProductTeamId).Code + "|" + logDef.ContractNo + "|" + logDef.Quantity.ToString() + "|" + logDef.OtherAmount.ToString() + "|" + (logDef.OtherAmount - logDef.OtherTax).ToString();

                if (t0 == "SHV2") glEntry.Office = "SH2F";
                else glEntry.Office = entry.Office;

                if (logDef.BaseTax <= 1 && logDef.BaseTax >= -1)
                {
                    glEntry.COA = generalWorker.getEpicorCOA("4104803");
                    if (logDef.OfficeId == OfficeId.TR.Id)
                    {
                        if (logDef.CurrencyId == CurrencyId.GBP.Id)
                            glEntry.COA = "2516010";
                        else if (logDef.CurrencyId == CurrencyId.EUR.Id)
                            glEntry.COA = "2516011";
                    }

                    glEntry.SegmentValue3 = (logDef.OfficeId == OfficeId.HK.Id) ? "711" : "721";
                }
                else
                {
                    ShipmentDef shipmentDef = OrderSelectWorker.Instance.getShipmentByKey(logDef.ShipmentId);
                    ContractDef contractDef = OrderSelectWorker.Instance.getContractByKey(shipmentDef.ContractId);

                    if ((logDef.CustomerId == CustomerDef.Id.ns_led.GetHashCode() || logDef.CustomerId == CustomerDef.Id.manu_led.GetHashCode()) && commonWorker.getNSLedSelfBilledSupplierCodeList().Contains(contractDef.UKSupplierCode))
                        glEntry.COA = "1450070";
                    else
                        glEntry.COA = "1450020";

                    addNewILSDiffDCNoteShipment(logDef);
                }
                glEntry.IsRecordComplete = true;
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);
            }

        }

        private void createILSSalesDiscrepancySummary(ArrayList logList, ArrayList safList)
        {
            bool isFirst = true;
            int currencyId = 0;
            int officeId = 0;

            decimal ttlNSLBaseAmt = 0;
            decimal ttlNSLOtherAmt = 0;
            decimal ttlNUKBaseAmt = 0;
            decimal ttlNUKOtherAmt = 0;

            SunInterfaceLogDef lastLogDef = null;
            ShipmentDef shipmentDef = null;
            InvoiceDef invoiceDef = null;

            foreach (SunInterfaceLogDef logDef in logList)
            {
                shipmentDef = OrderSelectWorker.Instance.getShipmentByKey(logDef.ShipmentId);
                invoiceDef = ShippingWorker.Instance.getInvoiceByKey(logDef.ShipmentId);

                if (isFirst)
                {
                    currencyId = logDef.CurrencyId;
                    officeId = logDef.OfficeId;
                }

                if (currencyId == logDef.CurrencyId &&
                    officeId == logDef.OfficeId)
                {
                    /*
                    ttlNSLBaseAmt += Math.Round(shipmentDef.TotalShippedAmount * invoiceDef.ARExchangeRate / commonWorker.getExchangeRate(ExchangeRateType.PAYABLE_RECEIVABLE, CurrencyId.USD.Id, logDef.TransactionDate), 2, MidpointRounding.AwayFromZero);
                    ttlNSLOtherAmt += shipmentDef.TotalShippedAmount;
                    ttlNUKBaseAmt += Math.Round(invoiceDef.ARAmt * invoiceDef.ARExchangeRate / commonWorker.getExchangeRate(ExchangeRateType.PAYABLE_RECEIVABLE, CurrencyId.USD.Id, logDef.TransactionDate), 2, MidpointRounding.AwayFromZero);
                    ttlNUKOtherAmt += invoiceDef.ARAmt;
                    */
                    ttlNSLBaseAmt += Math.Round(shipmentDef.TotalShippedAmount * invoiceDef.ARExchangeRate / commonWorker.getExchangeRate(ExchangeRateType.INVOICE, CurrencyId.USD.Id, logDef.TransactionDate), 2, MidpointRounding.AwayFromZero);
                    ttlNSLOtherAmt += shipmentDef.TotalShippedAmount;
                    ttlNUKBaseAmt += Math.Round(invoiceDef.ARAmt * invoiceDef.ARExchangeRate / commonWorker.getExchangeRate(ExchangeRateType.INVOICE, CurrencyId.USD.Id, logDef.TransactionDate), 2, MidpointRounding.AwayFromZero);
                    ttlNUKOtherAmt += invoiceDef.ARAmt;
                }
                else
                {
                    addILSSalesDiscrepancySummaryToSAFList(safList, currencyId, officeId, ttlNUKBaseAmt, ttlNUKOtherAmt, lastLogDef);
                    addILSSalesDiscrepancySummaryToSAFList(safList, currencyId, officeId, ttlNSLBaseAmt * -1, ttlNSLOtherAmt * -1, lastLogDef);

                    ttlNSLBaseAmt = 0;
                    ttlNSLOtherAmt = 0;
                    ttlNUKBaseAmt = 0;
                    ttlNUKOtherAmt = 0;
                    /*
                    ttlNSLBaseAmt = Math.Round(shipmentDef.TotalShippedAmount * invoiceDef.ARExchangeRate / commonWorker.getExchangeRate(ExchangeRateType.PAYABLE_RECEIVABLE, CurrencyId.USD.Id, logDef.TransactionDate), 2, MidpointRounding.AwayFromZero);
                    ttlNSLOtherAmt = shipmentDef.TotalShippedAmount;
                    ttlNUKBaseAmt = Math.Round(invoiceDef.ARAmt * invoiceDef.ARExchangeRate / commonWorker.getExchangeRate(ExchangeRateType.PAYABLE_RECEIVABLE, CurrencyId.USD.Id, logDef.TransactionDate), 2, MidpointRounding.AwayFromZero);
                    ttlNUKOtherAmt = invoiceDef.ARAmt;
                    */
                    ttlNSLBaseAmt = Math.Round(shipmentDef.TotalShippedAmount * invoiceDef.ARExchangeRate / commonWorker.getExchangeRate(ExchangeRateType.INVOICE, CurrencyId.USD.Id, logDef.TransactionDate), 2, MidpointRounding.AwayFromZero);
                    ttlNSLOtherAmt = shipmentDef.TotalShippedAmount;
                    ttlNUKBaseAmt = Math.Round(invoiceDef.ARAmt * invoiceDef.ARExchangeRate / commonWorker.getExchangeRate(ExchangeRateType.INVOICE, CurrencyId.USD.Id, logDef.TransactionDate), 2, MidpointRounding.AwayFromZero);
                    ttlNUKOtherAmt = invoiceDef.ARAmt;
                }
                currencyId = logDef.CurrencyId;
                officeId = logDef.OfficeId;
                isFirst = false;
                lastLogDef = logDef;
            }
            addILSSalesDiscrepancySummaryToSAFList(safList, currencyId, officeId, ttlNUKBaseAmt, ttlNUKOtherAmt, lastLogDef);
            addILSSalesDiscrepancySummaryToSAFList(safList, currencyId, officeId, ttlNSLBaseAmt * -1, ttlNSLOtherAmt * -1, lastLogDef);
        }

        private void addILSSalesDiscrepancySummaryToSAFList(ArrayList safList, int currencyId, int officeId, decimal ttlBaseAmt, decimal ttlOtherAmt, SunInterfaceLogDef logDef)
        {
            SunInterfaceLogDef dummyLog = new SunInterfaceLogDef();
            dummyLog.OfficeId = officeId;
            if (logDef.CountryOfOriginId == CountryOfOriginRef.eCountryId.Vietnam.GetHashCode() && officeId == OfficeId.TH.Id)
                dummyLog.CountryOfOriginId = logDef.CountryOfOriginId;
            else
                dummyLog.CountryOfOriginId = 0;
            dummyLog.CustomerId = 0;
            dummyLog.ContractNo = String.Empty;

            logDef.TermOfPurchaseId = 1;
            string t0 = getT0Code(logDef);

            SAFDef def = new SAFDef();
            def.AccountCode = (ttlBaseAmt >= 0 ? "1308103" : "1308101");
            def.FiscalYear = logDef.FiscalYear;
            def.Period = logDef.Period;
            def.TransactionDate = logDef.TransactionDate;
            def.DebitCreditIndicator = (ttlBaseAmt >= 0 ? "D" : "C");
            def.BaseAmount = Math.Abs(ttlBaseAmt);
            def.JournalType = getJournalPrefix(officeId, 0) + "IN";
            def.Description = "BILL REC'D P" + logDef.Period.ToString() + "/" + logDef.FiscalYear.ToString().Substring(2);
            def.CurrencyCode = CurrencyId.getCommonName(currencyId);
            def.OtherAmount = Math.Abs(ttlOtherAmt);
            def.T0 = (t0 == "THV2" ? "TH2F" : t0);
            if (t0 == "HK1G" || t0 == "FBHK" || t0 == "HKFB") def.T0 = "HK1F";
            else if (t0 == "FBSH" || t0 == "SHFB") def.T0 = "SH2F";
            else if (t0 == "FBVN" || t0 == "VNFB") def.T0 = "THV2";

            def.T9 = "P" + logDef.Period.ToString();
            def.OfficeCode = OfficeId.getName(officeId);
            def.TradingAgency = string.Empty;
            safList.Add(def);
        }


        private void createILSSalesCommissionDiscrepancySummary(ArrayList logList, ArrayList safList)
        {
            bool isFirst = true;
            int currencyId = 0;
            int officeId = 0;

            decimal ttlNSLBaseAmt = 0;
            decimal ttlNSLOtherAmt = 0;
            decimal ttlNUKBaseAmt = 0;
            decimal ttlNUKOtherAmt = 0;

            SunInterfaceLogDef lastLogDef = null;
            InvoiceDef invoiceDef = null;

            foreach (SunInterfaceLogDef logDef in logList)
            {
                invoiceDef = ShippingWorker.Instance.getInvoiceByKey(logDef.ShipmentId);

                if (isFirst)
                {
                    currencyId = logDef.CurrencyId;
                    officeId = logDef.OfficeId;
                }

                if (currencyId == logDef.CurrencyId &&
                    officeId == logDef.OfficeId)
                {
                    /*
                    ttlNSLBaseAmt += Math.Round(invoiceDef.NSLCommissionAmt * invoiceDef.NSLCommissionSettlementExchangeRate / commonWorker.getExchangeRate(ExchangeRateType.PAYABLE_RECEIVABLE, CurrencyId.USD.Id, logDef.TransactionDate), 2, MidpointRounding.AwayFromZero);
                    ttlNSLOtherAmt += invoiceDef.NSLCommissionAmt;
                    ttlNUKBaseAmt += Math.Round(invoiceDef.NSLCommissionSettlementAmt * invoiceDef.NSLCommissionSettlementExchangeRate / commonWorker.getExchangeRate(ExchangeRateType.PAYABLE_RECEIVABLE, CurrencyId.USD.Id, logDef.TransactionDate), 2, MidpointRounding.AwayFromZero);
                    ttlNUKOtherAmt += invoiceDef.NSLCommissionSettlementAmt;
                    */
                    ttlNSLBaseAmt += Math.Round(invoiceDef.NSLCommissionAmt * invoiceDef.NSLCommissionSettlementExchangeRate / commonWorker.getExchangeRate(ExchangeRateType.INVOICE, CurrencyId.USD.Id, logDef.TransactionDate), 2, MidpointRounding.AwayFromZero);
                    ttlNSLOtherAmt += invoiceDef.NSLCommissionAmt;
                    ttlNUKBaseAmt += Math.Round(invoiceDef.NSLCommissionSettlementAmt * invoiceDef.NSLCommissionSettlementExchangeRate / commonWorker.getExchangeRate(ExchangeRateType.INVOICE, CurrencyId.USD.Id, logDef.TransactionDate), 2, MidpointRounding.AwayFromZero);
                    ttlNUKOtherAmt += invoiceDef.NSLCommissionSettlementAmt;
                }
                else
                {
                    addILSSalesCommissionDiscrepancySummaryToSAFList(safList, currencyId, officeId, ttlNUKBaseAmt, ttlNUKOtherAmt, lastLogDef);
                    addILSSalesCommissionDiscrepancySummaryToSAFList(safList, currencyId, officeId, ttlNSLBaseAmt * -1, ttlNSLOtherAmt * -1, lastLogDef);

                    ttlNSLBaseAmt = 0;
                    ttlNSLOtherAmt = 0;
                    ttlNUKBaseAmt = 0;
                    ttlNUKOtherAmt = 0;
                    /*
                    ttlNSLBaseAmt = Math.Round(invoiceDef.NSLCommissionAmt * invoiceDef.NSLCommissionSettlementExchangeRate / commonWorker.getExchangeRate(ExchangeRateType.PAYABLE_RECEIVABLE, CurrencyId.USD.Id, logDef.TransactionDate), 2, MidpointRounding.AwayFromZero);
                    ttlNSLOtherAmt = invoiceDef.NSLCommissionAmt;
                    ttlNUKBaseAmt = Math.Round(invoiceDef.NSLCommissionSettlementAmt * invoiceDef.NSLCommissionSettlementExchangeRate / commonWorker.getExchangeRate(ExchangeRateType.PAYABLE_RECEIVABLE, CurrencyId.USD.Id, logDef.TransactionDate), 2, MidpointRounding.AwayFromZero);
                    ttlNUKOtherAmt = invoiceDef.NSLCommissionSettlementAmt;
                    */
                    ttlNSLBaseAmt = Math.Round(invoiceDef.NSLCommissionAmt * invoiceDef.NSLCommissionSettlementExchangeRate / commonWorker.getExchangeRate(ExchangeRateType.INVOICE, CurrencyId.USD.Id, logDef.TransactionDate), 2, MidpointRounding.AwayFromZero);
                    ttlNSLOtherAmt = invoiceDef.NSLCommissionAmt;
                    ttlNUKBaseAmt = Math.Round(invoiceDef.NSLCommissionSettlementAmt * invoiceDef.NSLCommissionSettlementExchangeRate / commonWorker.getExchangeRate(ExchangeRateType.INVOICE, CurrencyId.USD.Id, logDef.TransactionDate), 2, MidpointRounding.AwayFromZero);
                    ttlNUKOtherAmt = invoiceDef.NSLCommissionSettlementAmt;

                }
                currencyId = logDef.CurrencyId;
                officeId = logDef.OfficeId;
                isFirst = false;
                lastLogDef = logDef;
            }
            addILSSalesCommissionDiscrepancySummaryToSAFList(safList, currencyId, officeId, ttlNUKBaseAmt, ttlNUKOtherAmt, lastLogDef);
            addILSSalesCommissionDiscrepancySummaryToSAFList(safList, currencyId, officeId, ttlNSLBaseAmt * -1, ttlNSLOtherAmt * -1, lastLogDef);
        }

        private void addILSSalesCommissionDiscrepancySummaryToSAFList(ArrayList safList, int currencyId, int officeId, decimal ttlBaseAmt, decimal ttlOtherAmt, SunInterfaceLogDef logDef)
        {
            SunInterfaceLogDef dummyLog = new SunInterfaceLogDef();
            dummyLog.OfficeId = officeId;
            if (logDef.CountryOfOriginId == CountryOfOriginRef.eCountryId.Vietnam.GetHashCode() && officeId == OfficeId.TH.Id)
                dummyLog.CountryOfOriginId = logDef.CountryOfOriginId;
            else
                dummyLog.CountryOfOriginId = 0;
            dummyLog.CustomerId = 0;
            dummyLog.ContractNo = String.Empty;

            logDef.TermOfPurchaseId = 1;
            string t0 = getT0Code(logDef);

            SAFDef def = new SAFDef();
            def.AccountCode = (ttlBaseAmt >= 0 ? "1308104" : "1308102");
            def.FiscalYear = logDef.FiscalYear;
            def.Period = logDef.Period;
            def.TransactionDate = logDef.TransactionDate;
            def.DebitCreditIndicator = (ttlBaseAmt >= 0 ? "D" : "C");
            def.BaseAmount = Math.Abs(ttlBaseAmt);
            def.JournalType = getJournalPrefix(officeId, 0) + "IN";
            def.Description = "BILL REC'D COMM P" + logDef.Period.ToString() + "/" + logDef.FiscalYear.ToString().Substring(2);
            def.CurrencyCode = CurrencyId.getCommonName(currencyId);
            def.OtherAmount = Math.Abs(ttlOtherAmt);
            def.T0 = (t0 == "THV2" ? "TH2F" : t0);
            if (t0 == "HK1G" || t0 == "FBHK" || t0 == "HKFB") def.T0 = "HK1F";
            else if (t0 == "FBSH" || t0 == "SHFB") def.T0 = "SH2F";
            else if (t0 == "FBVN" || t0 == "VNFB") def.T0 = "THV2";
            def.T9 = "P" + logDef.Period.ToString();
            def.OfficeCode = OfficeId.getName(officeId);
            def.TradingAgency = string.Empty;
            safList.Add(def);
        }

        private void createActualSalesCommissionSettlementSummary(ArrayList logList, ArrayList safList)
        {
            bool isFirst = true;
            int currencyId = 0;
            int officeId = 0;
            decimal ttlBaseAmt = 0;
            decimal ttlOtherAmt = 0;
            decimal ttlILS = 0;
            decimal ttlBaseILS = 0;
            SunInterfaceLogDef lastLogDef = null;
            Hashtable grpTbl = new Hashtable();

            foreach (SunInterfaceLogDef logDef in logList)
            {
                if (isFirst)
                {
                    currencyId = logDef.CurrencyId;
                    officeId = logDef.OfficeId;
                }

                if (currencyId == logDef.CurrencyId &&
                    officeId == logDef.OfficeId)
                {
                    ttlBaseAmt += (logDef.BaseAmount - logDef.BaseTax); //logDef.BaseAmount;
                    ttlOtherAmt += (logDef.OtherAmount - logDef.OtherTax);  //logDef.OtherAmount;
                    ttlILS += logDef.OtherTax;
                    ttlBaseILS += logDef.BaseTax;
                }
                else
                {
                    if (!grpTbl.ContainsKey(CurrencyId.getCommonName(currencyId)))
                        grpTbl.Add(CurrencyId.getCommonName(currencyId), "IR" + this.getNextReceiptGroupId().ToString().PadLeft(6, '0'));

                    if (!receiptGrpTbl.ContainsKey(CurrencyId.getCommonName(currencyId)))
                        receiptGrpTbl.Add(CurrencyId.getCommonName(currencyId), grpTbl[CurrencyId.getCommonName(currencyId)].ToString() + "|" + (ttlOtherAmt + ttlILS).ToString() + "|" + getNextEpicorCheckNo().ToString() + "|" + ttlILS.ToString() + "|" + ttlBaseILS.ToString());

                    addActualSalesCommissionSettlementSummaryToSAFList(safList, currencyId, officeId, ttlBaseAmt, ttlOtherAmt, ttlILS, ttlBaseILS, lastLogDef);
                    ttlBaseAmt = (logDef.BaseAmount - logDef.BaseTax);  // logDef.BaseAmount;
                    ttlOtherAmt = (logDef.OtherAmount - logDef.OtherTax);  //logDef.OtherAmount;
                    ttlILS = logDef.OtherTax;
                    ttlBaseILS = logDef.BaseTax;
                }
                currencyId = logDef.CurrencyId;
                officeId = logDef.OfficeId;
                isFirst = false;
                lastLogDef = logDef;
            }
            if (!grpTbl.ContainsKey(CurrencyId.getCommonName(currencyId)))
                grpTbl.Add(CurrencyId.getCommonName(currencyId), "IR" + this.getNextReceiptGroupId().ToString().PadLeft(6, '0'));

            if (!receiptGrpTbl.ContainsKey(CurrencyId.getCommonName(currencyId)))
                receiptGrpTbl.Add(CurrencyId.getCommonName(currencyId), grpTbl[CurrencyId.getCommonName(currencyId)].ToString() + "|" + (ttlOtherAmt + ttlILS).ToString() + "|" + getNextEpicorCheckNo().ToString() + "|" + ttlILS.ToString() + "|" + ttlBaseILS.ToString());
            addActualSalesCommissionSettlementSummaryToSAFList(safList, currencyId, officeId, ttlBaseAmt, ttlOtherAmt, ttlILS, ttlBaseILS, lastLogDef);
        }

        private void addActualSalesCommissionSettlementSummaryToSAFList(ArrayList safList, int currencyId, int officeId, decimal ttlBaseAmt, decimal ttlOtherAmt, decimal ttlILS, decimal ttlBaseILS, SunInterfaceLogDef logDef)
        {
            SunInterfaceLogDef dummyLog = new SunInterfaceLogDef();
            dummyLog.OfficeId = officeId;
            if (logDef.CountryOfOriginId == CountryOfOriginRef.eCountryId.Vietnam.GetHashCode() && officeId == OfficeId.TH.Id)
                dummyLog.CountryOfOriginId = logDef.CountryOfOriginId;
            else
                dummyLog.CountryOfOriginId = 0;
            dummyLog.CustomerId = 0;
            dummyLog.ContractNo = String.Empty;

            logDef.TermOfPurchaseId = 1;
            string t0 = getT0Code(logDef);

            #region sales comm A/R debit entry
            SAFDef def = new SAFDef();
            def.AccountCode = "1308104";
            def.FiscalYear = logDef.FiscalYear;
            def.Period = logDef.Period;
            def.TransactionDate = AccountFinancialCalenderDef.getDefaultEndDate(logDef.FiscalYear, logDef.Period);
            def.DebitCreditIndicator = "D";
            def.BaseAmount = ttlBaseAmt;
            def.JournalType = getJournalPrefix(officeId, 0) + "IS";
            def.Description = "Receipt Comm " + logDef.Period.ToString().PadLeft(2, '0') + "/" + logDef.FiscalYear.ToString().Substring(2);
            def.CurrencyCode = CurrencyId.getCommonName(currencyId);
            def.OtherAmount = ttlOtherAmt;
            def.T0 = (t0 == "THV2" ? "TH2F" : t0);
            if (t0 == "HK1G" || t0 == "FBHK" || t0 == "HKFB") def.T0 = "HK1F";
            else if (t0 == "FBSH" || t0 == "SHFB" || t0 == "SHV2") def.T0 = "SH2F";
            else if (t0 == "FBVN" || t0 == "VNFB") def.T0 = "THV2";
            else if (t0 == "TKEF" || t0 == "TK5F") def.T0 = "TK1F";
            else if (t0 == "THV2" && logDef.OfficeId == OfficeId.VN.Id && logDef.CurrencyId == CurrencyId.USD.Id) def.T0 = "THV2";
            def.OfficeCode = OfficeId.getName(officeId);
            /*
            def.TradingAgency = TradingAgencyId.getName(tradingAgencyId);
            */
            def.TradingAgency = string.Empty;
            /*
            def.RefNo = refNo;
            */
            safList.Add(def);
            #endregion

            /* TODO:EPICOR */
            if (ttlILS != 0)
            {
                GLInterfaceEntry glEntry = new GLInterfaceEntry();
                glEntry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
                glEntry.GroupId = EpicorInterfaceWorker.Instance.GLInterfaceFile.getSourceString();
                glEntry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                glEntry.ApplyDate = glEntry.GroupApplyDate;
                glEntry.DocumentType = GLDocumentTypeEnum.GL;
                glEntry.CurrencyCode = CurrencyId.getCommonName(currencyId);
                if (ttlILS > 0)
                    glEntry.DC = DCFlag.Credit;
                else
                    glEntry.DC = DCFlag.Debit;
                glEntry.Amount = ttlILS;
                glEntry.BaseAmount = ttlBaseILS;
                glEntry.LineDescription = "RECEIPT COMM " + logDef.Period.ToString().PadLeft(2, '0') + "/" + logDef.FiscalYear.ToString().Substring(2);
                glEntry.Office = def.T0;
                glEntry.COA = "1290010";
                glEntry.IsRecordComplete = true;
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);
            }

        }

        private void createActualARSummary(ArrayList logList, ArrayList safList)
        {
            bool isFirst = true;
            string refNo = String.Empty;
            int currencyId = 0;
            int officeId = 0;
            int tradingAgencyId = 0;
            int termOfPurchaseId = 0;

            decimal ttlBaseAmt = 0;
            decimal ttlOtherAmt = 0;
            decimal curVal = 0;
            decimal curBaseVal = 0;
            decimal ttlILS = 0;
            decimal ttlBaseILS = 0;
            SunInterfaceLogDef lastLogDef = null;
            string curGrpId = string.Empty, curChkId = string.Empty;
            Hashtable grpTbl = new Hashtable();

            foreach (SunInterfaceLogDef logDef in logList)
            {
                if (isFirst)
                {
                    refNo = logDef.ReferenceNo;
                    currencyId = logDef.CurrencyId;
                    officeId = logDef.OfficeId;
                    tradingAgencyId = logDef.TradingAgencyId;
                    termOfPurchaseId = logDef.TermOfPurchaseId;
                }

                if (refNo == logDef.ReferenceNo &&
                    currencyId == logDef.CurrencyId &&
                    officeId == logDef.OfficeId &&
                    tradingAgencyId == logDef.TradingAgencyId &&
                    termOfPurchaseId == logDef.TermOfPurchaseId)
                {
                    ttlBaseAmt += (logDef.BaseAmount - logDef.BaseTax);  //logDef.BaseAmount;
                    ttlOtherAmt += (logDef.OtherAmount - logDef.OtherTax); // logDef.OtherAmount;
                    ttlILS += logDef.OtherTax;
                    ttlBaseILS += logDef.BaseTax;
                }
                else
                {
                    if (!grpTbl.ContainsKey(CurrencyId.getCommonName(currencyId)))
                        grpTbl.Add(CurrencyId.getCommonName(currencyId), "IR" + this.getNextReceiptGroupId().ToString().PadLeft(6, '0'));

                    if (!receiptGrpTbl.ContainsKey(CurrencyId.getCommonName(currencyId)))
                        receiptGrpTbl.Add(CurrencyId.getCommonName(currencyId), grpTbl[CurrencyId.getCommonName(currencyId)].ToString() + "|" + (ttlOtherAmt + ttlILS).ToString() + "|" + getNextEpicorCheckNo().ToString() + "|" + (ttlBaseAmt + ttlBaseILS).ToString());
                    else
                    {
                        curGrpId = Convert.ToString(((string)receiptGrpTbl[CurrencyId.getCommonName(currencyId)]).Split('|')[0]);
                        curVal = Convert.ToDecimal(((string)receiptGrpTbl[CurrencyId.getCommonName(currencyId)]).Split('|')[1]);
                        curChkId = Convert.ToString(((string)receiptGrpTbl[CurrencyId.getCommonName(currencyId)]).Split('|')[2]);
                        curBaseVal = Convert.ToDecimal(((string)receiptGrpTbl[CurrencyId.getCommonName(currencyId)]).Split('|')[3]);
                        receiptGrpTbl[CurrencyId.getCommonName(currencyId)] = curGrpId + "|" + (curVal + ttlOtherAmt + ttlILS).ToString() + "|" + curChkId + "|" + (curBaseVal + ttlBaseAmt + ttlBaseILS).ToString();
                    }

                    addActualARSummaryToSAFList(safList, refNo, currencyId, officeId, tradingAgencyId, termOfPurchaseId, ttlBaseAmt, ttlOtherAmt, ttlILS, ttlBaseILS, lastLogDef);
                    ttlBaseAmt = logDef.BaseAmount - logDef.BaseTax; // logDef.BaseAmount;
                    ttlOtherAmt = logDef.OtherAmount - logDef.OtherTax; // logDef.OtherAmount;
                    ttlILS = logDef.OtherTax;
                    ttlBaseILS = logDef.BaseTax;
                }
                refNo = logDef.ReferenceNo;
                currencyId = logDef.CurrencyId;
                officeId = logDef.OfficeId;
                tradingAgencyId = logDef.TradingAgencyId;
                termOfPurchaseId = logDef.TermOfPurchaseId;
                isFirst = false;
                lastLogDef = logDef;
            }
            if (!grpTbl.ContainsKey(CurrencyId.getCommonName(currencyId)))
                grpTbl.Add(CurrencyId.getCommonName(currencyId), "IR" + this.getNextReceiptGroupId().ToString().PadLeft(6, '0'));

            if (!receiptGrpTbl.ContainsKey(CurrencyId.getCommonName(currencyId)))
                receiptGrpTbl.Add(CurrencyId.getCommonName(currencyId), grpTbl[CurrencyId.getCommonName(currencyId)].ToString() + "|" + (ttlOtherAmt + ttlILS).ToString() + "|" + getNextEpicorCheckNo().ToString() + "|" + (ttlBaseAmt + ttlBaseILS).ToString());
            else
            {
                curGrpId = Convert.ToString(((string)receiptGrpTbl[CurrencyId.getCommonName(currencyId)]).Split('|')[0]);
                curVal = Convert.ToDecimal(((string)receiptGrpTbl[CurrencyId.getCommonName(currencyId)].ToString()).Split('|')[1]);
                curChkId = Convert.ToString(((string)receiptGrpTbl[CurrencyId.getCommonName(currencyId)].ToString()).Split('|')[2]);
                curBaseVal = Convert.ToDecimal(((string)receiptGrpTbl[CurrencyId.getCommonName(currencyId)]).Split('|')[3]);
                receiptGrpTbl[CurrencyId.getCommonName(currencyId)] = curGrpId + "|" + (curVal + ttlOtherAmt + ttlILS).ToString() + "|" + curChkId + "|" + (curBaseVal + ttlBaseAmt + ttlBaseILS).ToString();
            }
            addActualARSummaryToSAFList(safList, refNo, currencyId, officeId, tradingAgencyId, termOfPurchaseId, ttlBaseAmt, ttlOtherAmt, ttlILS, ttlBaseILS, lastLogDef);
        }

        private void addActualARSummaryToSAFList(ArrayList safList, string refNo, int currencyId, int officeId, int tradingAgencyId, int termOfPurchaseId, decimal ttlBaseAmt, decimal ttlOtherAmt, decimal ttlILS, decimal ttlBaseILS, SunInterfaceLogDef logDef)
        {
            SunInterfaceLogDef dummyLog = new SunInterfaceLogDef();
            dummyLog.OfficeId = officeId;
            dummyLog.TradingAgencyId = tradingAgencyId;
            dummyLog.TermOfPurchaseId = termOfPurchaseId;
            if (logDef.CountryOfOriginId == CountryOfOriginRef.eCountryId.Vietnam.GetHashCode() && officeId == OfficeId.TH.Id)
                dummyLog.CountryOfOriginId = logDef.CountryOfOriginId;
            else
                dummyLog.CountryOfOriginId = 0;
            dummyLog.CustomerId = 0;
            dummyLog.ContractNo = String.Empty;

            logDef.TermOfPurchaseId = 1;
            string t0 = getT0Code(logDef);
            logDef.TermOfPurchaseId = termOfPurchaseId;


            if (ttlILS != 0)
            {
                GLInterfaceEntry glEntry = new GLInterfaceEntry();
                glEntry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
                glEntry.GroupId = EpicorInterfaceWorker.Instance.GLInterfaceFile.getSourceString();
                glEntry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                glEntry.ApplyDate = glEntry.GroupApplyDate;
                glEntry.DocumentType = GLDocumentTypeEnum.GL;
                glEntry.CurrencyCode = CurrencyId.getCommonName(currencyId);
                if (ttlILS > 0)
                    glEntry.DC = DCFlag.Credit;
                else
                    glEntry.DC = DCFlag.Debit;
                glEntry.Amount = ttlILS;
                glEntry.BaseAmount = ttlBaseILS;
                glEntry.LineDescription = "RECEIPT FROM UK - " + logDef.Period.ToString().PadLeft(2, '0') + "/" + logDef.FiscalYear.ToString().Substring(2);

                /*
                if (t0 == "THV2")
                    glEntry.Office = "TH2F";
                */
                if (t0 == "HK1G" || t0 == "FBHK" || t0 == "HKFB") glEntry.Office = "HK1F";
                else if (t0 == "FBSH" || t0 == "SHFB" || t0 == "SHV2") glEntry.Office = "SH2F";
                else if (t0 == "FBVN" || t0 == "VNFB") glEntry.Office = "THV2";
                else if (t0 == "TKEF" || t0 == "TK5F") glEntry.Office = "TK1F";
                else if (t0 == "THV2" && logDef.OfficeId == OfficeId.VN.Id && logDef.CurrencyId == CurrencyId.USD.Id) glEntry.Office = "THV2";
                else glEntry.Office = t0;

                glEntry.COA = "1290010";
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);
            }

        }

        private string getSettlementBankIdByAPRefNo(string refNo, out int officeId, out string epicorCOA)
        {
            string bankCode = "UNDEFINED";
            officeId = 0;
            epicorCOA = "UNDEFINED";
            if (refNo == "LHK-HKB-USD" || refNo == "AHK-HKB-USD")
            {
                bankCode = "HKHU1";
                officeId = OfficeId.HK.Id;
                epicorCOA = "1231010";
            }
            else if (refNo == "LHK-HKB-GBP" || refNo == "AHK-HKB-GBP")
            {
                bankCode = "HKHG1";
                officeId = OfficeId.HK.Id;
                epicorCOA = "1232030";
            }
            else if (refNo == "LHK-SCB-USD" || refNo == "AHK-SCB-USD")
            {
                bankCode = "HKSU1";
                officeId = OfficeId.HK.Id;
                epicorCOA = "1241010";
            }
            else if (refNo == "LBD-HKB-USD" || refNo == "ABD-HKB-USD")
            {
                bankCode = "BDHU1";
                officeId = OfficeId.BD.Id;
                epicorCOA = "1231013";
            }
            else if (refNo == "LBD-SCB-USD" || refNo == "ABD-SCB-USD")
            {
                bankCode = "BDSU1";
                officeId = OfficeId.BD.Id;
                epicorCOA = "1241011";
            }
            else if (refNo == "ACA-SCB-USD" || refNo == "LCA-SCB-USD")
            {
                bankCode = "CASU1";
                officeId = OfficeId.CA.Id;
                epicorCOA = "1242013";
            }
            else if (refNo == "AND-HKB-USD")
            {
                bankCode = "INHU1";
                officeId = OfficeId.ND.Id;
                epicorCOA = "1232013";
            }
            else if (refNo == "AIN-HKB-GBP")
            {
                bankCode = "INHG2";
                officeId = OfficeId.IND.Id;
                epicorCOA = "1231032";
            }
            else if (refNo == "AIN-HKB-USD")
            {
                bankCode = "INHU2";
                officeId = OfficeId.IND.Id;
                epicorCOA = "1232010";
            }
            else if (refNo == "AND-HKB-GBP")
            {
                bankCode = "INHG1";
                officeId = OfficeId.ND.Id;
                epicorCOA = "1232032";
            }
            else if (refNo == "LSL-HKB-USD" || refNo == "ASL-HKB-USD")
            {
                bankCode = "LKHU1";
                officeId = OfficeId.SL.Id;
                epicorCOA = "1232011";
            }
            else if (refNo == "LSL-HKB-GBP" || refNo == "ASL-HKB-GBP")
            {
                bankCode = "LKHG1";
                officeId = OfficeId.SL.Id;
                epicorCOA = "1232033";
            }
            else if (refNo == "LPK-HKB-USD" || refNo == "APK-HKB-USD")
            {
                bankCode = "PKHU1";
                officeId = OfficeId.PK.Id;
                epicorCOA = "1231015";
            }
            else if (refNo == "APK-HKB-GBP")
            {
                bankCode = "PKHG1";
                officeId = OfficeId.PK.Id;
                epicorCOA = "1231031";
            }
            else if (refNo == "LSH-HKB-USD" || refNo == "ASH-HKB-USD")
            {
                bankCode = "SHHU1";
                officeId = OfficeId.SH.Id;
                epicorCOA = "1232012";
            }
            else if (refNo == "ATH-SCB-USD")
            {
                bankCode = "THSU1";
                officeId = OfficeId.TH.Id;
                epicorCOA = "1242012";
            }
            else if (refNo == "LTH-SCB-GBP" || refNo == "ATH-SCB-GBP")
            {
                bankCode = "THSG1";
                officeId = OfficeId.TH.Id;
                epicorCOA = "1242030";
            }
            else if (refNo == "ATK-HKB-USD")
            {
                bankCode = "TKHU1";
                officeId = OfficeId.TR.Id;
                epicorCOA = "1231014";
            }
            else if (refNo == "ATK-HKB-EUR")
            {
                bankCode = "TKHE1";
                officeId = OfficeId.TR.Id;
                epicorCOA = "1231040";
            }
            else if (refNo == "ATK-HKB-GBP")
            {
                bankCode = "TKHG1";
                officeId = OfficeId.TR.Id;
                epicorCOA = "1232031";
            }
            else if (refNo == "AVN-SCB-USD" || refNo == "LVN-SCB-USD")
            {
                bankCode = "VNSU1";
                officeId = OfficeId.VN.Id;
                epicorCOA = "1242011";
            }
            else if (refNo == "AVN-SCB-GBP" || refNo == "LVN-SCB-GBP")
            {
                bankCode = "VNSG1";
                officeId = OfficeId.VN.Id;
                epicorCOA = "1242030";
            }
            else if (refNo == "AHK-SCB-GBP" || refNo == "LHK-SCB-GBP")
            {
                bankCode = "HKSG1";
                officeId = OfficeId.HK.Id;
                epicorCOA = "1231034";
            }
            else if (refNo == "AIN-SCB-GBP" || refNo == "LIN-SCB-GBP")
            {
                bankCode = "INSG1";
                officeId = OfficeId.IND.Id;
                epicorCOA = "1231037";
            }
            else if (refNo == "AIN-SCB-USD" || refNo == "LIN-SCB-USD")
            {
                bankCode = "INSU1";
                officeId = OfficeId.IND.Id;
                epicorCOA = "1231123";
            }
            else if (refNo == "ASL-SCB-GBP" || refNo == "LSL-SCB-GBP")
            {
                bankCode = "LKSG1";
                officeId = OfficeId.SL.Id;
                epicorCOA = "1231035";
            }
            else if (refNo == "ASL-SCB-USD" || refNo == "LSL-SCB-USD")
            {
                bankCode = "LKSU1";
                officeId = OfficeId.SL.Id;
                epicorCOA = "1231120";
            }
            else if (refNo == "AND-SCB-GBP" || refNo == "LND-SCB-GBP")
            {
                bankCode = "NDSG1";
                officeId = OfficeId.ND.Id;
                epicorCOA = "1231036";
            }
            else if (refNo == "AND-SCB-USD" || refNo == "LND-SCB-USD")
            {
                bankCode = "NDSU1";
                officeId = OfficeId.ND.Id;
                epicorCOA = "1231122";
            }
            else if (refNo == "ASH-SCB-USD" || refNo == "LSH-SCB-USD")
            {
                bankCode = "SHSU1";
                officeId = OfficeId.SH.Id;
                epicorCOA = "1231121";
            }
            else if (refNo == "ATK-SCB-GBP" || refNo == "LTK-SCB-GBP")
            {
                bankCode = "TKSG1";
                officeId = OfficeId.TR.Id;
                epicorCOA = "1231038";
            }
            else if (refNo == "ATK-SCB-USD" || refNo == "LTK-SCB-USD")
            {
                bankCode = "TKSU1";
                officeId = OfficeId.TR.Id;
                epicorCOA = "1231124";
            }
            
            return bankCode;
        }

        private void addActualAPToSAFList(SunInterfaceLogDef logDef, ArrayList safList)
        {
            VendorRef vendor = vendorWorker.getVendorByKey(logDef.VendorId);
            InvoiceDef invoiceDef = ShippingWorker.Instance.getInvoiceByKey(logDef.ShipmentId);
            string t0 = getT0Code(logDef);
            decimal vendorPaymentDiscountBaseAmt = 0;
            decimal vendorPaymentDiscountOtherAmt = 0;

            Debug.WriteLine("ActualAPToSAFList " + invoiceDef.ShipmentId.ToString());

            if (logDef.VendorPaymentDiscountPercent > 0)
            {
                vendorPaymentDiscountBaseAmt = Math.Round(logDef.BaseTax * logDef.VendorPaymentDiscountPercent / 100, 2, MidpointRounding.AwayFromZero);
                vendorPaymentDiscountOtherAmt = Math.Round(logDef.OtherTax * logDef.VendorPaymentDiscountPercent / 100, 2, MidpointRounding.AwayFromZero);
            }

            int bankOfficeId = 0;
            string epicorBankCOA = string.Empty;

            PaymentInterfaceEntry entry = new PaymentInterfaceEntry();

            entry.BankAccount = this.getSettlementBankIdByAPRefNo(logDef.ReferenceNo, out bankOfficeId, out epicorBankCOA);
            string curVal = (string)paymentGrpTbl[CurrencyId.getCommonName(logDef.CurrencyId) + "-" + logDef.VendorId.ToString() + "-" + invoiceDef.LCBillRefNo.ToUpper() + "-" + bankOfficeId.ToString() + "-" + logDef.OfficeId.ToString()];

            entry.GroupId = curVal.Split('|')[0];
            entry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
            entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
            entry.Office = t0;

            /*
            if (bankOfficeId != logDef.OfficeId)
            {
                GLInterfaceEntry glEntry = new GLInterfaceEntry();
                glEntry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, bankOfficeId).EpicorCompanyId;
                glEntry.GroupId = EpicorInterfaceWorker.Instance.GLInterfaceFile.getSourceString();
                glEntry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                glEntry.ApplyDate = glEntry.GroupApplyDate;
                glEntry.DocumentType = GLDocumentTypeEnum.GL;
                glEntry.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
                glEntry.DC = DCFlag.Debit;
                glEntry.Qty = logDef.Quantity * logDef.PiecesPerPack;
                glEntry.Amount = logDef.OtherAmount;
                glEntry.BaseAmount = logDef.BaseAmount;
                glEntry.LineDescription = logDef.ContractNo + "-" + logDef.DeliveryNo.ToString();

                if (logDef.OfficeId == OfficeId.VN.Id && bankOfficeId == OfficeId.HK.Id)
                {
                    entry.BankAccount = "VNHKU";
                    glEntry.Office = "HK1F";
                    glEntry.COA = "1302013";
                }
                else if (logDef.OfficeId == OfficeId.TH.Id && bankOfficeId == OfficeId.HK.Id)
                {
                    entry.BankAccount = "THHKU";
                    glEntry.Office = "HK1F";
                    glEntry.COA = "1302012";
                }
                else if (logDef.OfficeId == OfficeId.SH.Id && bankOfficeId == OfficeId.HK.Id)
                {
                    glEntry.Office = "HK1F";
                    glEntry.COA = "1302011";
                    if (logDef.CurrencyId == CurrencyId.USD.Id)
                        entry.BankAccount = "SHHKU";
                    else if (logDef.CurrencyId == CurrencyId.HKD.Id)
                        entry.BankAccount = "SHHKH";
                    else if (logDef.CurrencyId == CurrencyId.GBP.Id)
                        entry.BankAccount = "SHHKG";
                }
                else if (logDef.OfficeId == OfficeId.SH.Id && bankOfficeId == OfficeId.TR.Id)
                {
                    entry.BankAccount = "SHTKE";
                    glEntry.Office = "TK1F";
                    glEntry.COA = "1302213";
                }
                else if (logDef.OfficeId == OfficeId.HK.Id && bankOfficeId == OfficeId.TR.Id)
                {
                    entry.BankAccount = "HKTKE";
                    glEntry.Office = "TK1F";
                    glEntry.COA = "1302014";
                }
                else if (logDef.OfficeId == OfficeId.CA.Id && bankOfficeId == OfficeId.HK.Id)
                {
                    glEntry.Office = "HK1F";
                    glEntry.COA = "1302010";
                    if (logDef.CurrencyId == CurrencyId.USD.Id)
                        entry.BankAccount = "CAHKU";
                    else if (logDef.CurrencyId == CurrencyId.HKD.Id)
                        entry.BankAccount = "CAHKH";
                }
                
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                glEntry = (GLInterfaceEntry)glEntry.Clone();
                glEntry.DC = DCFlag.Credit;
                glEntry.COA = epicorBankCOA;
                glEntry.IsRecordComplete = true;
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);
            }
            */

            if (bankOfficeId != logDef.OfficeId)
            {

                if (logDef.OfficeId == OfficeId.VN.Id && bankOfficeId == OfficeId.HK.Id)
                    entry.BankAccount = "VNHKU";
                else if (logDef.OfficeId == OfficeId.TH.Id && bankOfficeId == OfficeId.HK.Id)
                    entry.BankAccount = "THHKU";
                else if (logDef.OfficeId == OfficeId.SH.Id && bankOfficeId == OfficeId.HK.Id)
                {
                    if (logDef.CurrencyId == CurrencyId.USD.Id)
                        entry.BankAccount = "SHHKU";
                    else if (logDef.CurrencyId == CurrencyId.HKD.Id)
                        entry.BankAccount = "SHHKH";
                    else if (logDef.CurrencyId == CurrencyId.GBP.Id)
                        entry.BankAccount = "SHHKG";
                }
                else if (logDef.OfficeId == OfficeId.SH.Id && bankOfficeId == OfficeId.TR.Id)
                    entry.BankAccount = "SHTKE";
                else if (logDef.OfficeId == OfficeId.HK.Id && bankOfficeId == OfficeId.TR.Id)
                    entry.BankAccount = "HKTKE";
                else if (logDef.OfficeId == OfficeId.CA.Id && bankOfficeId == OfficeId.HK.Id)
                {
                    if (logDef.CurrencyId == CurrencyId.USD.Id)
                        entry.BankAccount = "CAHKU";
                    else if (logDef.CurrencyId == CurrencyId.HKD.Id)
                        entry.BankAccount = "CAHKH";
                }

            }

            entry.SupplierId = vendor.EpicorSupplierId;
            SunInterfaceLogDef latestLog = this.getLatestLogByShipmentId(SunInterfaceTypeRef.Id.Purchase.GetHashCode(), logDef.ShipmentId, logDef.SplitShipmentId);
            string reverseSuffix = this.getReversalSuffix(latestLog.SunInterfaceLogId);

            string s = latestLog.SupplierInvoiceNo;
            if (latestLog.DebitCreditNoteNo.Trim() != string.Empty)
                s = latestLog.DebitCreditNoteNo;

            s += (reverseSuffix != string.Empty ? "-" + reverseSuffix : string.Empty);

            entry.InvoiceNo = s;

            if (s.Length > 20)
                entry.InvoiceNo = (s.Substring(0, 17) + s.Substring(s.Length - 3, 3));

            /*
            entry.InvoiceNo = (s.Length > 20 ? s.Substring(s.Length - 20, 20) : s) + (reverseSuffix != string.Empty ? "-" + reverseSuffix : string.Empty);
            */

            entry.RealInvoiceNo = logDef.SupplierInvoiceNo;
            entry.PaymentMethod = logDef.PaymentTermId == PaymentTermRef.eTerm.LCATSIGHT.GetHashCode() ? NTPaymentMethodRef.LC.EpicorPaymentMethodId.ToString() : NTPaymentMethodRef.TT.EpicorPaymentMethodId.ToString();
            entry.PaymentNo = Convert.ToInt32(curVal.Split('|')[1]);
            entry.PaymentDate = logDef.TransactionDate;
            entry.LCBillRef = invoiceDef.LCBillRefNo.ToUpper();
            entry.Currency = generalWorker.getCurrencyByKey(logDef.CurrencyId).CurrencyCode;
            entry.PaymentAmt = logDef.OtherAmount;
            EpicorInterfaceWorker.Instance.PaymentInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);
        }

        private void createActualAPSummary(ArrayList logList, ArrayList safList)
        {
            bool isFirst = true;
            string refNo = String.Empty;
            int currencyId = 0;
            int officeId = 0;
            int vendorId = 0;
            string lcRefNo = string.Empty;

            decimal ttlBaseAmt = 0;
            decimal ttlOtherAmt = 0;
            SunInterfaceLogDef lastLogDef = null;
            Hashtable grpTbl = new Hashtable();
            InvoiceDef invoiceDef = null;

            string epicorBankCOA = string.Empty;
            int bankOfficeId = 0;
            int tmpBankOfficeId = 0;
            string bankAccount = string.Empty;

            foreach (SunInterfaceLogDef logDef in logList)
            {
                bankAccount = this.getSettlementBankIdByAPRefNo(logDef.ReferenceNo, out tmpBankOfficeId, out epicorBankCOA);

                invoiceDef = ShippingWorker.Instance.getInvoiceByKey(logDef.ShipmentId);
                if (isFirst)
                {
                    refNo = logDef.ReferenceNo;
                    currencyId = logDef.CurrencyId;
                    officeId = logDef.OfficeId;
                    vendorId = logDef.VendorId;
                    lcRefNo = invoiceDef.LCBillRefNo.ToUpper();
                    bankOfficeId = tmpBankOfficeId;
                }

                if (refNo == logDef.ReferenceNo &&
                    currencyId == logDef.CurrencyId &&
                    officeId == logDef.OfficeId &&
                    vendorId == logDef.VendorId &&
                    lcRefNo == invoiceDef.LCBillRefNo.ToUpper() &&
                    bankOfficeId == tmpBankOfficeId)
                {
                    ttlBaseAmt += logDef.BaseAmount;
                    ttlOtherAmt += logDef.OtherAmount;
                }
                else
                {
                    if (!grpTbl.ContainsKey(refNo + CurrencyId.getCommonName(currencyId)))
                        grpTbl.Add(refNo + CurrencyId.getCommonName(currencyId), "IP" + this.getNextPaymentGroupId().ToString().PadLeft(6, '0'));

                    if (!paymentGrpTbl.ContainsKey(CurrencyId.getCommonName(currencyId) + "-" + vendorId.ToString() + "-" + lcRefNo))
                        paymentGrpTbl.Add(CurrencyId.getCommonName(currencyId) + "-" + vendorId.ToString() + "-" + lcRefNo + "-" + bankOfficeId.ToString() + "-" + officeId.ToString(), grpTbl[refNo + CurrencyId.getCommonName(currencyId)].ToString() + "|" + this.getNextEpicorPaymentNo().ToString() + "|0");

                    addActualAPSummaryToSAFList(safList, refNo, lcRefNo, currencyId, officeId, bankOfficeId, ttlBaseAmt, ttlOtherAmt, lastLogDef);
                    ttlBaseAmt = logDef.BaseAmount;
                    ttlOtherAmt = logDef.OtherAmount;
                }
                refNo = logDef.ReferenceNo;
                currencyId = logDef.CurrencyId;
                vendorId = logDef.VendorId;
                lcRefNo = invoiceDef.LCBillRefNo.ToUpper();
                officeId = logDef.OfficeId;
                bankOfficeId = tmpBankOfficeId;
                isFirst = false;
                lastLogDef = logDef;
            }
            if (!grpTbl.ContainsKey(refNo + CurrencyId.getCommonName(currencyId)))
                grpTbl.Add(refNo + CurrencyId.getCommonName(currencyId), "IP" + this.getNextPaymentGroupId().ToString().PadLeft(6, '0'));

            if (!paymentGrpTbl.ContainsKey(CurrencyId.getCommonName(currencyId) + "-" + vendorId.ToString() + "-" + lcRefNo))
                paymentGrpTbl.Add(CurrencyId.getCommonName(currencyId) + "-" + vendorId.ToString() + "-" + lcRefNo + "-" + bankOfficeId.ToString() + "-" + officeId.ToString(), grpTbl[refNo + CurrencyId.getCommonName(currencyId)].ToString() + "|" + this.getNextEpicorPaymentNo().ToString() + "|0");
            addActualAPSummaryToSAFList(safList, refNo, lcRefNo, currencyId, officeId, bankOfficeId, ttlBaseAmt, ttlOtherAmt, lastLogDef);
        }

        private void createActualNonTradeBankPaymentSummary(ArrayList logList, ArrayList safList)
        {
            bool isFirst = true;
            int settlementBankAccountId = 0;
            int paymentMethodId = 0;
            int currencyId = 0;
            int officeId = 0;
            int companyId = 0;
            int isPayByHK = 0;
            int vendorId = 0;
            string chequeNo = string.Empty;
            DateTime settlementDate = DateTime.MinValue;

            decimal apBaseAmt = 0;
            decimal ttlBaseAmt = 0;
            decimal ttlOtherAmt = 0;
            decimal exRateDiff = 0;
            decimal bankChargeBaseAmt = 0;
            decimal bankChargeOtherAmt = 0;
            string curGrpId = string.Empty;
            decimal curVal = 0;
            string curPayNo = string.Empty;
            decimal curChg = 0;
            Hashtable grpTbl = new Hashtable();

            SunInterfaceLogDef lastLogDef = null;
            NSLBankAccountDef bankDef = null;

            foreach (SunInterfaceLogDef logDef in logList)
            {
                NTInvoiceDef invoiceDef = NonTradeWorker.Instance.getNTInvoiceByKey(int.Parse(logDef.ReferenceNo));
                CompanyOfficeMappingRef companyOfficeMappingDef = generalWorker.getCompanyOfficeMappingByCriteria(invoiceDef.Company.Id, invoiceDef.Office.OfficeId);
                int baseCurrencyId = generalWorker.getAccountDatabaseByKey(companyOfficeMappingDef.ReportingDatabaseId).ReportingCurrencyId;
                /*
                ICollection coll = generalWorker.getAccountPeriodListByYearPeriod(9, invoiceDef.FiscalYear, invoiceDef.FiscalPeriod);
                */
                ICollection coll = generalWorker.getAccountPeriodListByYearPeriod(9, logDef.FiscalYear, logDef.Period);

                AccountFinancialCalenderDef calcDef = null;
                foreach (AccountFinancialCalenderDef cd in coll)
                {
                    calcDef = cd;
                    break;
                }

                decimal exRate = commonWorker.getExchangeRate(ExchangeRateType.INVOICE, invoiceDef.Currency.CurrencyId, calcDef.StartDate);
                decimal baseExRate = commonWorker.getExchangeRate(ExchangeRateType.INVOICE, baseCurrencyId, calcDef.StartDate);
                decimal bankExRate = 0;

                if (isFirst)
                {
                    settlementBankAccountId = invoiceDef.SettlementBankAccountId;
                    paymentMethodId = invoiceDef.PaymentMethod.Id;
                    currencyId = invoiceDef.Currency.CurrencyId;
                    officeId = invoiceDef.Office.OfficeId;
                    companyId = invoiceDef.Company.Id;
                    isPayByHK = invoiceDef.IsPayByHK;
                    chequeNo = invoiceDef.ChequeNo;
                    vendorId = invoiceDef.NTVendor.NTVendorId;
                    settlementDate = invoiceDef.SettlementDate;
                    bankDef = NonTradeWorker.Instance.getNSLBankAccountByKey(settlementBankAccountId);
                }

                if (settlementBankAccountId == invoiceDef.SettlementBankAccountId && paymentMethodId == invoiceDef.PaymentMethod.Id
                    && currencyId == invoiceDef.Currency.CurrencyId && officeId == invoiceDef.Office.OfficeId && companyId == invoiceDef.Company.Id
                    && isPayByHK == invoiceDef.IsPayByHK && chequeNo == invoiceDef.ChequeNo && vendorId == invoiceDef.NTVendor.NTVendorId && settlementDate == invoiceDef.SettlementDate)
                {
                    ttlBaseAmt += logDef.BaseAmount * (invoiceDef.DCIndicator == "C" ? -1 : 1);
                    ttlOtherAmt += logDef.OtherAmount * (invoiceDef.DCIndicator == "C" ? -1 : 1);
                    apBaseAmt += Math.Round(((invoiceDef.Amount + invoiceDef.TotalVAT) * (invoiceDef.DCIndicator == "C" ? -1 : 1) * exRate / baseExRate), 2, MidpointRounding.AwayFromZero);
                    bankExRate = commonWorker.getExchangeRate(ExchangeRateType.INVOICE, bankDef.Currency.CurrencyId, calcDef.StartDate);
                    bankChargeBaseAmt += Math.Round(invoiceDef.BankCharge * bankExRate / baseExRate, 2, MidpointRounding.AwayFromZero);
                    bankChargeOtherAmt += invoiceDef.BankCharge;
                }
                else
                {
                    if (!grpTbl.ContainsKey(settlementBankAccountId.ToString()))
                        grpTbl.Add(settlementBankAccountId.ToString(), "NT" + this.getNextPaymentGroupId().ToString().PadLeft(6, '0'));

                    if (!paymentGrpTbl.ContainsKey(CurrencyId.getCommonName(currencyId) + "-" + vendorId.ToString()))
                        paymentGrpTbl.Add(CurrencyId.getCommonName(currencyId) + "-" + vendorId.ToString(), grpTbl[settlementBankAccountId.ToString()].ToString() + "|" + this.getNextEpicorPaymentNo().ToString() + "|" + bankChargeOtherAmt.ToString() + "|" + settlementBankAccountId.ToString());
                    else
                    {
                        curGrpId = Convert.ToString(((string)paymentGrpTbl[CurrencyId.getCommonName(currencyId) + "-" + vendorId.ToString()]).Split('|')[0]);
                        curPayNo = Convert.ToString(((string)paymentGrpTbl[CurrencyId.getCommonName(currencyId) + "-" + vendorId.ToString()]).Split('|')[1]);
                        curChg = Convert.ToDecimal(((string)paymentGrpTbl[CurrencyId.getCommonName(currencyId) + "-" + vendorId.ToString()]).Split('|')[2]);
                        paymentGrpTbl[CurrencyId.getCommonName(currencyId) + "-" + vendorId.ToString()] = curGrpId + "|" + curPayNo + "|" + (curChg + bankChargeOtherAmt).ToString() + "|" + settlementBankAccountId.ToString();
                    }

                    exRateDiff = (bankDef == null || (bankDef != null && bankDef.Currency.CurrencyId == currencyId)) ? 0 : ttlBaseAmt - apBaseAmt;
                    this.addActualNonTradeBankPaymentSummaryToSAFList(safList, settlementBankAccountId, paymentMethodId, currencyId, officeId, companyId, isPayByHK, chequeNo, vendorId, settlementDate, ttlBaseAmt, ttlOtherAmt, exRateDiff, bankChargeBaseAmt, bankChargeOtherAmt, lastLogDef);
                    ttlBaseAmt = logDef.BaseAmount * (invoiceDef.DCIndicator == "C" ? -1 : 1);
                    ttlOtherAmt = logDef.OtherAmount * (invoiceDef.DCIndicator == "C" ? -1 : 1);
                    apBaseAmt = Math.Round(((invoiceDef.Amount + invoiceDef.TotalVAT) * (invoiceDef.DCIndicator == "C" ? -1 : 1) * exRate / baseExRate), 2, MidpointRounding.AwayFromZero);
                    bankExRate = commonWorker.getExchangeRate(ExchangeRateType.INVOICE, bankDef.Currency.CurrencyId, calcDef.StartDate);
                    bankChargeBaseAmt += Math.Round(invoiceDef.BankCharge * bankExRate / baseExRate, 2, MidpointRounding.AwayFromZero);
                    bankChargeOtherAmt += invoiceDef.BankCharge;
                }
                settlementBankAccountId = invoiceDef.SettlementBankAccountId;
                paymentMethodId = invoiceDef.PaymentMethod.Id;
                currencyId = invoiceDef.Currency.CurrencyId;
                officeId = invoiceDef.Office.OfficeId;
                companyId = invoiceDef.Company.Id;
                isPayByHK = invoiceDef.IsPayByHK;
                chequeNo = invoiceDef.ChequeNo;
                vendorId = invoiceDef.NTVendor.NTVendorId;
                settlementDate = invoiceDef.SettlementDate;
                bankDef = NonTradeWorker.Instance.getNSLBankAccountByKey(settlementBankAccountId);

                isFirst = false;
                lastLogDef = logDef;
            }
            exRateDiff = (bankDef == null || (bankDef != null && bankDef.Currency.CurrencyId == currencyId)) ? 0 : ttlBaseAmt - apBaseAmt;

            if (!grpTbl.ContainsKey(settlementBankAccountId.ToString()))
                grpTbl.Add(settlementBankAccountId.ToString(), "NT" + this.getNextPaymentGroupId().ToString().PadLeft(6, '0'));

            if (!paymentGrpTbl.ContainsKey(CurrencyId.getCommonName(currencyId) + "-" + vendorId.ToString()))
                paymentGrpTbl.Add(CurrencyId.getCommonName(currencyId) + "-" + vendorId.ToString(), grpTbl[settlementBankAccountId.ToString()].ToString() + "|" + this.getNextEpicorPaymentNo().ToString() + "|" + bankChargeOtherAmt.ToString() + "|" + settlementBankAccountId.ToString());
            else
            {
                curGrpId = Convert.ToString(((string)paymentGrpTbl[CurrencyId.getCommonName(currencyId) + "-" + vendorId.ToString()]).Split('|')[0]);
                curPayNo = Convert.ToString(((string)paymentGrpTbl[CurrencyId.getCommonName(currencyId) + "-" + vendorId.ToString()]).Split('|')[1]);
                curChg = Convert.ToDecimal(((string)paymentGrpTbl[CurrencyId.getCommonName(currencyId) + "-" + vendorId.ToString()]).Split('|')[2]);
                paymentGrpTbl[CurrencyId.getCommonName(currencyId) + "-" + vendorId.ToString()] = curGrpId + "|" + curPayNo + "|" + (curChg + bankChargeOtherAmt).ToString() + "|" + settlementBankAccountId.ToString();
            }

            addActualNonTradeBankPaymentSummaryToSAFList(safList, settlementBankAccountId, paymentMethodId, currencyId, officeId, companyId, isPayByHK, chequeNo, vendorId, settlementDate, ttlBaseAmt, ttlOtherAmt, exRateDiff, bankChargeBaseAmt, bankChargeOtherAmt, lastLogDef);
        }

        private void addActualAPSummaryToSAFList(ArrayList safList, string refNo, string lcRefNo, int currencyId, int officeId, int bankOfficeId, decimal ttlBaseAmt, decimal ttlOtherAmt, SunInterfaceLogDef logDef)
        {
            if (bankOfficeId != officeId)
            {
                GLInterfaceEntry glEntry = new GLInterfaceEntry();
                glEntry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, bankOfficeId).EpicorCompanyId;
                glEntry.GroupId = EpicorInterfaceWorker.Instance.GLInterfaceFile.getSourceString();
                /*
                glEntry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                */
                glEntry.GroupApplyDate = generalWorker.getAccountPeriodByDate(AppId.ISAM.Code, logDef.TransactionDate).EndDate;
                glEntry.ApplyDate = glEntry.GroupApplyDate;
                glEntry.DocumentType = GLDocumentTypeEnum.GL;
                glEntry.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
                glEntry.DC = DCFlag.Debit;
                glEntry.Qty = 0;
                glEntry.Amount = ttlOtherAmt;
                glEntry.BaseAmount = ttlBaseAmt;
                glEntry.LineDescription = lcRefNo;

                if (officeId == OfficeId.VN.Id && bankOfficeId == OfficeId.HK.Id)
                {
                    glEntry.Office = "HK1F";
                    glEntry.COA = "1302013";
                }
                else if (officeId == OfficeId.TH.Id && bankOfficeId == OfficeId.HK.Id)
                {
                    glEntry.Office = "HK1F";
                    glEntry.COA = "1302012";
                }
                else if (officeId == OfficeId.SH.Id && bankOfficeId == OfficeId.HK.Id)
                {
                    glEntry.Office = "HK1F";
                    glEntry.COA = "1302011";
                }
                else if (officeId == OfficeId.SH.Id && bankOfficeId == OfficeId.TR.Id)
                {
                    glEntry.Office = "TK1F";
                    glEntry.COA = "1302213";
                }
                else if (officeId == OfficeId.HK.Id && bankOfficeId == OfficeId.TR.Id)
                {
                    glEntry.Office = "TK1F";
                    glEntry.COA = "1302014";
                }
                else if (officeId == OfficeId.CA.Id && bankOfficeId == OfficeId.HK.Id)
                {
                    glEntry.Office = "HK1F";
                    glEntry.COA = "1302010";
                }

                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                string epicorBankCOA = string.Empty;
                int tmpBankOfficeId = 0;
                string bankAccount = string.Empty;

                bankAccount = this.getSettlementBankIdByAPRefNo(refNo, out tmpBankOfficeId, out epicorBankCOA);

                glEntry = (GLInterfaceEntry)glEntry.Clone();
                glEntry.DC = DCFlag.Credit;
                glEntry.COA = epicorBankCOA;
                glEntry.IsRecordComplete = true;
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);
            }
        }

        private void addActualNonTradeBankPaymentSummaryToSAFList(ArrayList safList, int settlementBankAccountId, int paymentMethodId, int currencyId, int officeId, int companyId, int isPayByHK, string chequeNo, int vendorId, DateTime settlementDate, decimal ttlBaseAmt, decimal ttlOtherAmt, decimal exRateDiff, decimal bankChargeBaseAmt, decimal bankChargeOtherAmt, SunInterfaceLogDef logDef)
        {
            #region non-trade bank payment credit entry
            SAFDef def = new SAFDef();
            CompanyOfficeMappingRef companyOfficeMappingDef = generalWorker.getCompanyOfficeMappingByCriteria(companyId, officeId);
            NSLBankAccountDef bankDef = NonTradeWorker.Instance.getNSLBankAccountByKey(settlementBankAccountId);
            NTVendorDef vendorDef = NonTradeWorker.Instance.getNTVendorByKey(vendorId);
            GLInterfaceEntry glEntry = new GLInterfaceEntry();

            def.TargetDB = generalWorker.getAccountDatabaseByKey(companyOfficeMappingDef.ReportingDatabaseId).DbCode;
            def.FiscalYear = logDef.FiscalYear;
            def.Period = logDef.Period;
            /*
            def.TransactionDate = AccountFinancialCalenderDef.getDefaultEndDate(logDef.FiscalYear, logDef.Period);
            */
            def.TransactionDate = settlementDate;
            if (paymentMethodId == NTPaymentMethodRef.CASH.Id)
            {
                def.AccountCode = CurrencyId.getPettyCashAccountCode(currencyId);
                def.Filler1 = "CASH";
            }
            else
            {
                def.AccountCode = bankDef.SUNAccountCode;
                def.Filler1 = bankDef.AccountNo;
            }
            def.DebitCreditIndicator = (ttlBaseAmt > 0 ? "C" : "D");

            // todo: remove companyId == CompanyType.NEXT_SOURCING.Id and need to fill in NSLDB.CompanyOfficeMapping.IntercommT0
            if (companyId == CompanyType.NEXT_SOURCING.Id && bankDef != null && companyOfficeMappingDef.InterComT0Code != bankDef.T0Code)
            {
                def.JournalType = (def.TargetDB == "1NI" ? "N" : getJournalPrefix(bankDef.BankOfficeId, logDef.TradingAgencyId)) + "NP";
                def.OfficeCode = OfficeId.getName(bankDef.OfficeId);
                def.T0 = bankDef.T0Code;
            }
            else
            {
                def.JournalType = (def.TargetDB == "1NI" ? "N" : getJournalPrefix(officeId, logDef.TradingAgencyId)) + "NP";
                def.OfficeCode = OfficeId.getName(officeId);
                def.T0 = (isPayByHK == 0 ? companyOfficeMappingDef.T0Code : companyOfficeMappingDef.InterComT0Code);
            }
            if (companyId == CompanyType.NEXT_SOURCING_INDIA.Id && (officeId == OfficeId.IND.Id || officeId == OfficeId.ND.Id))
                def.T5 = bankDef.TallyCode;

            if (paymentMethodId == NTPaymentMethodRef.CHEQUE.Id)
                def.Description = NTPaymentMethodRef.getType(paymentMethodId).Name + " " + chequeNo.Replace(',', ' ') + " " + NonTradeWorker.Instance.getNTVendorByKey(vendorId).VendorName.Replace(',', ' ');
            else
                def.Description = NTPaymentMethodRef.getType(paymentMethodId).Name + " " + vendorDef.VendorName.Replace(',', ' ');
            def.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
            def.BaseAmount = ttlBaseAmt;
            def.OtherAmount = ttlOtherAmt;

            def.TradingAgency = TradingAgencyId.getName(logDef.TradingAgencyId);
            def.PaymentTerm = PaymentTermRef.getDescriptionForSAF(logDef.PaymentTermId);
            def.CreateDate = DateTime.Now;
            safList.Add(def);
            SAFDef.addOverSizeDescAsSAFDefs(safList, def);
            #endregion

            if (exRateDiff != 0)
            {
                CurrencyRef reportingCurreny = generalWorker.getCurrencyByKey(generalWorker.getAccountDatabaseByKey(companyOfficeMappingDef.ReportingDatabaseId).ReportingCurrencyId);

                def = (SAFDef)def.Clone();
                def.AccountCode = "4104803";
                def.Filler1 = string.Empty;
                def.DebitCreditIndicator = (exRateDiff > 0 ? "D" : "C");
                def.CurrencyCode = reportingCurreny.CurrencyCode;
                def.BaseAmount = Math.Abs(exRateDiff);
                def.OtherAmount = Math.Abs(exRateDiff);
                def.JournalType = (def.TargetDB == "1NI" ? "N" : getJournalPrefix(officeId, logDef.TradingAgencyId)) + "NP";
                def.T1 = "711";
                def.Description = "EX DIFF FOR PAYMENT";
                def.CreateDate = DateTime.Now;
                safList.Add(def);
            }

            if (bankChargeOtherAmt > 0)
            {
                def = (SAFDef)def.Clone();
                def.AccountCode = "4106101";
                def.Filler1 = string.Empty;
                def.DebitCreditIndicator = "D";
                def.JournalType = (def.TargetDB == "1NI" ? "N" : getJournalPrefix(officeId, logDef.TradingAgencyId)) + "NP";
                def.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
                def.BaseAmount = bankChargeBaseAmt;
                def.OtherAmount = bankChargeOtherAmt;
                def.Description = "BANK CHARGE FOR TT";
                def.T1 = "711";
                def.CreateDate = DateTime.Now;
                safList.Add(def);

                def = (SAFDef)def.Clone();
                def.AccountCode = bankDef.SUNAccountCode;
                def.Filler1 = bankDef.AccountNo;
                def.DebitCreditIndicator = "C";
                def.CreateDate = DateTime.Now;
                safList.Add(def);
            }

            // todo: remove companyId == CompanyType.NEXT_SOURCING.Id
            if (companyId == CompanyType.NEXT_SOURCING.Id && bankDef != null && (isPayByHK == 0 ? companyOfficeMappingDef.T0Code : companyOfficeMappingDef.InterComT0Code) != bankDef.T0Code)
            {
                def = (SAFDef)def.Clone();
                //def.AccountCode = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, bankDef.OfficeId).SUNAccountCode; // bank originate id
                def.AccountCode = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, bankDef.BankOfficeId).SUNAccountCode; // bank originate id
                //def.Filler1 = "C/A of " + OfficeId.getName(bankDef.OfficeId);  // bank originate id
                def.Filler1 = "C/A of " + OfficeId.getName(bankDef.BankOfficeId);
                def.DebitCreditIndicator = (ttlBaseAmt > 0 ? "C" : "D");
                def.JournalType = (def.TargetDB == "1NI" ? "N" : getJournalPrefix(officeId, logDef.TradingAgencyId)) + "NP";
                def.BaseAmount = ttlBaseAmt;
                def.OtherAmount = ttlOtherAmt;
                def.Description = "S/S " + vendorDef.VendorName.Replace(',', ' ');
                def.T0 = (isPayByHK == 0 ? companyOfficeMappingDef.T0Code : companyOfficeMappingDef.InterComT0Code);
                def.T1 = string.Empty;
                def.OfficeCode = OfficeId.getName(officeId);
                def.CreateDate = DateTime.Now;
                safList.Add(def);
                SAFDef.addOverSizeDescAsSAFDefs(safList, def);

                /* TODO:EPICOR 
                glEntry = new GLInterfaceEntry();
                glEntry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, bankDef.OfficeId).EpicorCompanyId;
                glEntry.GroupId = EpicorInterfaceWorker.Instance.GLInterfaceFile.getSourceString();
                glEntry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                glEntry.ApplyDate = glEntry.GroupApplyDate;
                glEntry.DocumentType = GLDocumentTypeEnum.GL;
                glEntry.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
                glEntry.DC = (ttlBaseAmt > 0 ? DCFlag.Credit : DCFlag.Debit);
                glEntry.Amount = ttlOtherAmt + bankChargeOtherAmt;
                glEntry.BaseAmount = ttlBaseAmt + bankChargeBaseAmt;
                glEntry.LineDescription = "C/A of " + OfficeId.getName(bankDef.BankOfficeId);
                glEntry.Office = bankDef.T0Code;
                glEntry.COA = generalWorker.getEpicorCOA(generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, bankDef.BankOfficeId).SUNAccountCode);
                glEntry.IsRecordComplete = false;
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);
                */

                def = (SAFDef)def.Clone();
                def.AccountCode = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, officeId).SUNAccountCode;  // correct
                def.Filler1 = "C/A of " + OfficeId.getName(officeId);
                def.DebitCreditIndicator = (ttlBaseAmt > 0 ? "D" : "C");
                def.Description = "S/S " + vendorDef.VendorName.Replace(',', ' ');
                def.JournalType = (def.TargetDB == "1NI" ? "N" : getJournalPrefix(bankDef.BankOfficeId, logDef.TradingAgencyId)) + "NP";
                def.T0 = bankDef.T0Code;
                //def.OfficeCode = OfficeId.getName(bankDef.OfficeId); // bank originate id
                def.OfficeCode = OfficeId.getName(bankDef.BankOfficeId); // bank originate id
                def.CreateDate = DateTime.Now;
                safList.Add(def);
                SAFDef.addOverSizeDescAsSAFDefs(safList, def);

                /* TODO:EPICOR
                glEntry = (GLInterfaceEntry)glEntry.Clone();
                glEntry.DC = (ttlBaseAmt > 0 ? DCFlag.Debit : DCFlag.Credit);
                glEntry.COA = generalWorker.getEpicorCOA(generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, officeId).SUNAccountCode);
                glEntry.Office = bankDef.T0Code;
                glEntry.IsRecordComplete = true;
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);
                */
            }

        }

        private void addActualUKClaimToSAFList(SunInterfaceLogDef logDef, ArrayList safList)
        {
            string t0 = getT0Code(logDef);

            UKClaimDef ukClaimDef = null;
            UKClaimRefundDef ukClaimRefundDef = null;

            if (int.Parse(logDef.ReferenceNo) > 0)
                ukClaimDef = UKClaimWorker.Instance.getUKClaimByKey(int.Parse(logDef.ReferenceNo));
            else
            {
                ukClaimRefundDef = UKClaimWorker.Instance.getUKClaimRefundByKey(Math.Abs(int.Parse(logDef.ReferenceNo)));
                ukClaimDef = UKClaimWorker.Instance.getUKClaimByKey(ukClaimRefundDef.ClaimId);
            }

            ARInvoiceInterfaceEntry entry = new ARInvoiceInterfaceEntry();
            if (int.Parse(logDef.ReferenceNo) > 0)
            {
                entry.DocumentType = ARInvoiceDocumentTypeEnum.NEXT_CLAIM_DEBIT_NOTE;
                entry.IsCreditNote = true;
                entry.InvoiceNo = "NC-" + ukClaimDef.ClaimId.ToString().PadLeft(7, '0');
            }
            else
            {
                if (logDef.OtherAmount < 0)
                {
                    entry.DocumentType = ARInvoiceDocumentTypeEnum.NEXT_CLAIM_DEBIT_NOTE;
                    entry.IsCreditNote = true;
                }
                else
                    entry.DocumentType = ARInvoiceDocumentTypeEnum.NEXT_CLAIM_REFUND;

                entry.InvoiceNo = "NCR-" + ukClaimRefundDef.ClaimRefundId.ToString().PadLeft(7, '0');
            }
            entry.LegalNumber = entry.InvoiceNo;
            entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
            entry.Office = t0;
            entry.CustomerId = "NAR003";
            entry.COA = "1227040";

            /*
            if ((t0 == "THV2" && logDef.OfficeId == OfficeId.VN.Id) && logDef.CurrencyId == CurrencyId.GBP.Id) 
            {
                entry.Office = logDef.OfficeId == OfficeId.VN.Id ? "HK1F" : "IN2F";
                entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId == OfficeId.VN.Id ? OfficeId.TH.Id : OfficeId.IND.Id).EpicorCompanyId;
                entry.COA = logDef.OfficeId == OfficeId.VN.Id ? "1302013" : "1302612";
            }
            else if ((t0 == "CA1F" && logDef.OfficeId == OfficeId.CA.Id) && logDef.CurrencyId == CurrencyId.GBP.Id)
            {
                entry.Office = "HK1F";
                entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, OfficeId.HK.Id).EpicorCompanyId;
                entry.COA = "1302010";
            }
            */
            if (ukClaimDef.OfficeId != ukClaimDef.PaymentOfficeId)
            {
                entry.Office = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, ukClaimDef.PaymentOfficeId).InterComT0Code;
                entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, ukClaimDef.PaymentOfficeId).EpicorCompanyId;
                entry.COA = generalWorker.getCurrentAccountCOA(ukClaimDef.OfficeId, ukClaimDef.PaymentOfficeId);
            }
            else
                entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;

            entry.GroupId = EpicorInterfaceWorker.Instance.ARInvoiceInterfaceFile.getSourceString();
            entry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
            entry.ApplyDate = entry.GroupApplyDate;

            if (isEnableWeek53Handling(logDef, false))
            {
                entry.GroupApplyDate = WK53_APPLY_DATE;
                entry.ApplyDate = WK53_APPLY_DATE;
            }

            if (int.Parse(logDef.ReferenceNo) > 0)
                entry.LineDescription = "REC'D " + ukClaimDef.UKDebitNoteNo + " UK " + logDef.TransactionDate.ToString("dd/MM");
            else
                entry.LineDescription = "REFUND " + ukClaimDef.UKDebitNoteNo + " " + logDef.TransactionDate.ToString("dd/MM");

            entry.Currency = CurrencyId.getCommonName(logDef.CurrencyId);
            entry.UnitCost = Math.Abs(logDef.OtherAmount);
            entry.Amount = Math.Abs(logDef.OtherAmount);
            entry.Qty = logDef.Quantity;
            entry.ItemNo = ukClaimDef.ItemNo;
            if (ukClaimDef.Type == UKClaimType.AUDIT_FEE)
            {
                entry.SegmentValue4 = "OTHERS";
                entry.SegmentValue6 = "AUD";
            }
            else
            {
                entry.SegmentValue4 = (ukClaimDef.ProductTeamId != 0 ? generalWorker.getProductCodeDefByKey(logDef.ProductTeamId).Code : "Others");
                entry.SegmentValue6 = ukClaimDef.T5Code;
            }

            entry.RealInvoiceNo = ukClaimDef.UKDebitNoteNo;
            entry.InvoiceDate = logDef.TransactionDate;
            EpicorInterfaceWorker.Instance.ARInvoiceInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);

            /*
            if ((t0 == "THV2" && logDef.OfficeId == OfficeId.VN.Id) && logDef.CurrencyId == CurrencyId.GBP.Id)  
            {
                GLInterfaceEntry glEntry = new GLInterfaceEntry();
                glEntry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
                glEntry.GroupId = EpicorInterfaceWorker.Instance.GLInterfaceFile.getSourceString();
                glEntry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                glEntry.ApplyDate = glEntry.GroupApplyDate;

                if (isEnableWeek53Handling(logDef, false))
                {
                    glEntry.GroupApplyDate = WK53_APPLY_DATE;
                    glEntry.ApplyDate = WK53_APPLY_DATE;
                }

                glEntry.DocumentType = GLDocumentTypeEnum.GL;
                glEntry.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
                if (logDef.OtherAmount < 0)
                    glEntry.DC = int.Parse(logDef.ReferenceNo) > 0 ? DCFlag.Debit : DCFlag.Credit;
                else
                    glEntry.DC = int.Parse(logDef.ReferenceNo) > 0 ? DCFlag.Credit : DCFlag.Debit;
                glEntry.Qty = logDef.Quantity;
                glEntry.Amount = Math.Abs(logDef.OtherAmount);
                glEntry.BaseAmount = Math.Abs(logDef.BaseAmount);
                glEntry.LineDescription = logDef.OfficeId == OfficeId.VN.Id ? "C/A - TH2F/THV2" : "C/A - SL1F/IN2F";
                glEntry.Office = logDef.OfficeId == OfficeId.VN.Id ? "THV2" : "SL1F";
                glEntry.COA = logDef.OfficeId == OfficeId.VN.Id ? "1302013" : "1302612";
                glEntry.IsRecordComplete = false;
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                glEntry = (GLInterfaceEntry)glEntry.Clone();
                if (logDef.OtherAmount < 0)
                    glEntry.DC = int.Parse(logDef.ReferenceNo) > 0 ? DCFlag.Credit : DCFlag.Debit;
                else
                    glEntry.DC = int.Parse(logDef.ReferenceNo) > 0 ? DCFlag.Debit : DCFlag.Credit;
                glEntry.COA = "1227040";
                glEntry.LineDescription = "REC'D " + ukClaimDef.UKDebitNoteNo + " UK " + ukClaimDef.UKDebitNoteReceivedDate.ToString("dd/MM");

                if (ukClaimDef.Type == UKClaimType.AUDIT_FEE)
                {
                    glEntry.SegmentValue4 = "OTHERS";
                    glEntry.SegmentValue6 = "AUD";
                }
                else
                {
                    glEntry.SegmentValue4 = (ukClaimDef.ProductTeamId != 0 ? generalWorker.getProductCodeDefByKey(logDef.ProductTeamId).Code : "Others");
                    glEntry.SegmentValue6 = ukClaimDef.T5Code;
                }

                glEntry.IsRecordComplete = true;
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);
            }
            else if ((t0 == "CA1F" && logDef.OfficeId == OfficeId.CA.Id) && logDef.CurrencyId == CurrencyId.GBP.Id)
            {
                GLInterfaceEntry glEntry = new GLInterfaceEntry();
                glEntry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
                glEntry.GroupId = EpicorInterfaceWorker.Instance.GLInterfaceFile.getSourceString();
                glEntry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                glEntry.ApplyDate = glEntry.GroupApplyDate;

                if (isEnableWeek53Handling(logDef, false))
                {
                    glEntry.GroupApplyDate = WK53_APPLY_DATE;
                    glEntry.ApplyDate = WK53_APPLY_DATE;
                }

                glEntry.DocumentType = GLDocumentTypeEnum.GL;
                glEntry.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
                if (logDef.OtherAmount < 0)
                    glEntry.DC = int.Parse(logDef.ReferenceNo) > 0 ? DCFlag.Debit : DCFlag.Credit;
                else
                    glEntry.DC = int.Parse(logDef.ReferenceNo) > 0 ? DCFlag.Credit : DCFlag.Debit;
                glEntry.Qty = logDef.Quantity;
                glEntry.Amount = Math.Abs(logDef.OtherAmount);
                glEntry.BaseAmount = Math.Abs(logDef.BaseAmount);
                glEntry.LineDescription = "C/A - HK1F/CA1F";
                glEntry.Office = "CA1F";
                glEntry.COA = "1302010";
                glEntry.IsRecordComplete = false;
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                glEntry = (GLInterfaceEntry)glEntry.Clone();
                if (logDef.OtherAmount < 0)
                    glEntry.DC = int.Parse(logDef.ReferenceNo) > 0 ? DCFlag.Credit : DCFlag.Debit;
                else
                    glEntry.DC = int.Parse(logDef.ReferenceNo) > 0 ? DCFlag.Debit : DCFlag.Credit;
                glEntry.COA = "1227040";
                glEntry.LineDescription = "REC'D " + ukClaimDef.UKDebitNoteNo + " UK " + ukClaimDef.UKDebitNoteReceivedDate.ToString("dd/MM");

                if (ukClaimDef.Type == UKClaimType.AUDIT_FEE)
                {
                    glEntry.SegmentValue4 = "OTHERS";
                    glEntry.SegmentValue6 = "AUD";
                }
                else
                {
                    glEntry.SegmentValue4 = (ukClaimDef.ProductTeamId != 0 ? generalWorker.getProductCodeDefByKey(logDef.ProductTeamId).Code : "Others");
                    glEntry.SegmentValue6 = ukClaimDef.T5Code;
                }

                glEntry.IsRecordComplete = true;
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);
            }
            */
            if (ukClaimDef.OfficeId != ukClaimDef.PaymentOfficeId)
            {
                GLInterfaceEntry glEntry = new GLInterfaceEntry();
                glEntry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
                glEntry.GroupId = EpicorInterfaceWorker.Instance.GLInterfaceFile.getSourceString();
                glEntry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                glEntry.ApplyDate = glEntry.GroupApplyDate;

                if (isEnableWeek53Handling(logDef, false))
                {
                    glEntry.GroupApplyDate = WK53_APPLY_DATE;
                    glEntry.ApplyDate = WK53_APPLY_DATE;
                }

                glEntry.DocumentType = GLDocumentTypeEnum.GL;
                glEntry.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
                if (logDef.OtherAmount < 0)
                    glEntry.DC = int.Parse(logDef.ReferenceNo) > 0 ? DCFlag.Debit : DCFlag.Credit;
                else
                    glEntry.DC = int.Parse(logDef.ReferenceNo) > 0 ? DCFlag.Credit : DCFlag.Debit;
                glEntry.Qty = logDef.Quantity;
                glEntry.Amount = logDef.OtherAmount;
                glEntry.BaseAmount = logDef.BaseAmount;
                glEntry.LineDescription = ("C/A - " + generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, ukClaimDef.PaymentOfficeId).InterComT0Code + "/" + generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, ukClaimDef.OfficeId).InterComT0Code);
                glEntry.Office = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, ukClaimDef.OfficeId).InterComT0Code;
                glEntry.COA = generalWorker.getCurrentAccountCOA(ukClaimDef.OfficeId, ukClaimDef.PaymentOfficeId);
                glEntry.IsRecordComplete = false;
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                glEntry = (GLInterfaceEntry)glEntry.Clone();
                if (logDef.OtherAmount < 0)
                    glEntry.DC = int.Parse(logDef.ReferenceNo) > 0 ? DCFlag.Credit : DCFlag.Debit;
                else
                    glEntry.DC = int.Parse(logDef.ReferenceNo) > 0 ? DCFlag.Debit : DCFlag.Credit;
                glEntry.COA = "1227040";
                glEntry.LineDescription = "REC'D " + ukClaimDef.UKDebitNoteNo + " UK " + ukClaimDef.UKDebitNoteReceivedDate.ToString("dd/MM");

                if (ukClaimDef.Type == UKClaimType.AUDIT_FEE)
                {
                    glEntry.SegmentValue4 = "OTHERS";
                    glEntry.SegmentValue6 = "AUD";
                }
                else
                {
                    glEntry.SegmentValue4 = (ukClaimDef.ProductTeamId != 0 ? generalWorker.getProductCodeDefByKey(logDef.ProductTeamId).Code : "Others");
                    glEntry.SegmentValue6 = ukClaimDef.T5Code;
                }

                glEntry.IsRecordComplete = true;
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);
            }


        }

        private void addActualAPAdjustment_ChangeCurrencyToSAFList(SunInterfaceLogDef logDef, ArrayList safList)
        {
            APInvoiceInterfaceEntry entry;
            AdjustmentDetailDef adjDetail = this.getAdjustmentDetailByKey(int.Parse(logDef.ReferenceNo));
            AdjustmentNoteDef adjNote = GetAdjustmentNoteByKey(adjDetail.AdjustmentNoteId);
            VendorRef vendor = vendorWorker.getVendorByKey(logDef.VendorId);

            decimal usdExRate = commonWorker.getExchangeRate(ExchangeRateType.INVOICE, CurrencyId.USD.Id, logDef.TransactionDate);
            decimal oldExRate = commonWorker.getExchangeRate(ExchangeRateType.INVOICE, adjNote.CurrencyId, logDef.TransactionDate);
            decimal newExRate = commonWorker.getExchangeRate(ExchangeRateType.INVOICE, adjNote.RevisedCurrencyId, logDef.TransactionDate);

            entry = new APInvoiceInterfaceEntry();
            entry.COA = "4326010";
            entry.Office = getT0Code(logDef);
            entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
            entry.GroupId = EpicorInterfaceWorker.Instance.APInvoiceInterfaceFile.getSourceString();
            entry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
            entry.ApplyDate = entry.GroupApplyDate;
            if (isEnableWeek53Handling(logDef, false))
            {
                entry.GroupApplyDate = WK53_APPLY_DATE;
                entry.ApplyDate = WK53_APPLY_DATE;
            }
            entry.SupplierId = vendor.EpicorSupplierId;
            entry.LineDescription = logDef.ContractNo + "-" + logDef.DeliveryNo.ToString() + " " + getT9Code(logDef);
            entry.LineComment = entry.LineDescription;
            entry.ItemNo = ProductWorker.Instance.getProductByKey(logDef.ProductId).ItemNo;
            entry.InvoiceDate = logDef.TransactionDate;
            entry.PaymentTerm = "COD";
            entry.SegmentValue3 = "721";
            entry.IsMultiCompany = false;
            entry.Qty = 0;
            entry.QtyUnit = QtyUnitEnum.PC;

            // reverse entry
            entry.IsDebitNote = !(adjNote.DebitCreditIndicator == "D");
            entry.DocumentType = (entry.IsDebitNote ? APInvoiceDocumentTypeEnum.ISAM_DEBIT_NOTE : APInvoiceDocumentTypeEnum.ISAM_CREDIT_NOTE);
            entry.Currency = CurrencyId.getCommonName(adjNote.CurrencyId);
            entry.ExchangeRate = Math.Round(oldExRate / usdExRate, 10, MidpointRounding.AwayFromZero);
            entry.LegalNumber = logDef.DebitCreditNoteNo + "#1";
            entry.InvoiceNo = entry.LegalNumber;
            entry.RealInvoiceNo = entry.LegalNumber;
            entry.RealLegalNumber = logDef.DebitCreditNoteNo;
            entry.Amount = Math.Abs(adjNote.Amount);
            entry.UnitCost = entry.Amount;
            entry.IsRecordComplete = false;
            EpicorInterfaceWorker.Instance.APInvoiceInterfaceFile.Entries.Add(entry);

            // new Entry
            entry = (APInvoiceInterfaceEntry)entry.Clone();
            entry.IsDebitNote = (adjNote.DebitCreditIndicator == "D");
            entry.DocumentType = (entry.IsDebitNote ? APInvoiceDocumentTypeEnum.ISAM_DEBIT_NOTE : APInvoiceDocumentTypeEnum.ISAM_CREDIT_NOTE);
            entry.Currency = CurrencyId.getCommonName(adjNote.RevisedCurrencyId);
            entry.ExchangeRate = Math.Round(newExRate / usdExRate, 10, MidpointRounding.AwayFromZero);
            entry.LegalNumber = logDef.DebitCreditNoteNo + "#2";
            entry.InvoiceNo = entry.LegalNumber;
            entry.RealInvoiceNo = entry.LegalNumber;
            entry.RealLegalNumber = string.Empty;
            entry.Amount = Math.Round(adjNote.Amount
                            * commonWorker.getExchangeRate(ExchangeRateType.INVOICE, adjNote.CurrencyId, adjNote.IssueDate)
                            / commonWorker.getExchangeRate(ExchangeRateType.INVOICE, adjNote.RevisedCurrencyId, adjNote.IssueDate)
                            , 2, MidpointRounding.AwayFromZero);
            entry.UnitCost = entry.Amount;
            entry.IsRecordComplete = true;
            EpicorInterfaceWorker.Instance.APInvoiceInterfaceFile.Entries.Add(entry);
        }

        private void addActualUKClaimRechargeToSupplier_ChangeCurrencyToSAFList(SunInterfaceLogDef logDef, ArrayList safList)
        {
            decimal totalAmt = 0;
            APInvoiceInterfaceEntry entry;
            VendorRef vendor = vendorWorker.getVendorByKey(logDef.VendorId);

            int dcNoteId = int.Parse(logDef.ReferenceNo);
            UKClaimDCNoteDef dcNote = UKClaimWorker.Instance.getUKClaimDCNoteByKey(dcNoteId);

            decimal usdExRate = commonWorker.getExchangeRate(ExchangeRateType.INVOICE, CurrencyId.USD.Id, logDef.TransactionDate);
            decimal oldExRate = commonWorker.getExchangeRate(ExchangeRateType.INVOICE, dcNote.CurrencyId, logDef.TransactionDate);
            decimal newExRate = commonWorker.getExchangeRate(ExchangeRateType.INVOICE, dcNote.RevisedCurrencyId, logDef.TransactionDate);

            UKClaimDef firstClaim = null;
            foreach (UKClaimDCNoteDetailDef detail in UKClaimWorker.Instance.getUKClaimDCNoteDetailListByDCNoteId(dcNoteId))
            {
                if (firstClaim == null)
                    firstClaim = UKClaimWorker.Instance.getUKClaimByKey(detail.ClaimId);
                totalAmt += detail.Amount;
            }

            entry = new APInvoiceInterfaceEntry();
            entry.COA = "4326010";
            entry.Office = getT0Code(logDef);
            entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
            entry.GroupId = EpicorInterfaceWorker.Instance.APInvoiceInterfaceFile.getSourceString();
            entry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
            entry.ApplyDate = entry.GroupApplyDate;
            if (isEnableWeek53Handling(logDef, false))
            {
                entry.GroupApplyDate = WK53_APPLY_DATE;
                entry.ApplyDate = WK53_APPLY_DATE;
            }
            entry.SupplierId = vendor.EpicorSupplierId;
            entry.Description = firstClaim.UKDebitNoteNo;
            entry.LineDescription = firstClaim.UKDebitNoteNo;
            entry.LineComment = firstClaim.UKDebitNoteNo;
            entry.ItemNo = entry.COA; ;
            entry.Amount = Math.Abs(totalAmt);
            entry.UnitCost = Math.Abs(totalAmt);
            entry.InvoiceDate = logDef.TransactionDate;
            entry.PaymentTerm = "COD";
            entry.SegmentValue3 = "721";
            entry.SegmentValue6 = "OTH";
            entry.Qty = 0;
            entry.QtyUnit = QtyUnitEnum.PC;
            entry.IsMultiCompany = false;

            // reverse Entry
            entry.Currency = CurrencyId.getCommonName(dcNote.CurrencyId);
            entry.ExchangeRate = Math.Round(oldExRate / usdExRate, 10, MidpointRounding.AwayFromZero);
            entry.IsDebitNote = !(dcNote.DebitCreditIndicator == "D");
            entry.DocumentType = (entry.IsDebitNote ? APInvoiceDocumentTypeEnum.NEXT_CLAIM_DEBIT_NOTE : APInvoiceDocumentTypeEnum.NEXT_CLAIM_CREDIT_NOTE);
            entry.LegalNumber = logDef.DebitCreditNoteNo + "#1";
            entry.RealLegalNumber = logDef.DebitCreditNoteNo;
            entry.InvoiceNo = entry.LegalNumber;
            entry.RealInvoiceNo = entry.LegalNumber;
            entry.IsRecordComplete = false;
            EpicorInterfaceWorker.Instance.APInvoiceInterfaceFile.Entries.Add(entry);

            // new entry
            entry = (APInvoiceInterfaceEntry)entry.Clone();
            entry.Currency = CurrencyId.getCommonName(dcNote.RevisedCurrencyId);
            entry.ExchangeRate = Math.Round(newExRate / usdExRate, 10, MidpointRounding.AwayFromZero);
            entry.IsDebitNote = (dcNote.DebitCreditIndicator == "D");
            entry.DocumentType = (entry.IsDebitNote ? APInvoiceDocumentTypeEnum.NEXT_CLAIM_DEBIT_NOTE : APInvoiceDocumentTypeEnum.NEXT_CLAIM_CREDIT_NOTE);
            entry.LegalNumber = logDef.DebitCreditNoteNo + "#2";
            entry.InvoiceNo = entry.LegalNumber;
            entry.RealInvoiceNo = entry.LegalNumber;
            entry.RealLegalNumber = string.Empty;
            entry.IsRecordComplete = true;
            entry.Amount = Math.Round(entry.Amount
                            * commonWorker.getExchangeRate(ExchangeRateType.INVOICE, dcNote.CurrencyId, dcNote.DCNoteDate)
                            / commonWorker.getExchangeRate(ExchangeRateType.INVOICE, dcNote.RevisedCurrencyId, dcNote.DCNoteDate)
                            , 2, MidpointRounding.AwayFromZero);
            entry.UnitCost = entry.Amount;
            EpicorInterfaceWorker.Instance.APInvoiceInterfaceFile.Entries.Add(entry);
        }

        private void addActualUKClaimRechargeToSupplierToSAFList(SunInterfaceLogDef logDef, ArrayList safList)
        {
            string t0 = getT0Code(logDef);
            VendorRef vendor = vendorWorker.getVendorByKey(logDef.VendorId);
            UKClaimDCNoteDef noteDef = UKClaimWorker.Instance.getUKClaimDCNoteByDCNoteNo(logDef.DebitCreditNoteNo);
            List<UKClaimDCNoteDetailDef> dcNoteDetailList = null;
            dcNoteDetailList = UKClaimWorker.Instance.getUKClaimDCNoteDetailListByDCNoteId(noteDef.DCNoteId);
            QAIS.ClaimRequestService svc = new QAIS.ClaimRequestService();
            APInvoiceInterfaceEntry entry = new APInvoiceInterfaceEntry();
            GLInterfaceEntry glEntry = new GLInterfaceEntry();

            UKClaimDef ukClaimDef = null;
            UKClaimRefundDef ukClaimRefundDef = null;
            int cnt = 1;
            bool isVoidAsNSCost = false;
            bool isVoidAsNSProvision = false;
            bool isVoidAsSupplierCost = false;
            string voidNo = string.Empty;
            UKClaimDCNoteDef orginalDCNoteDef = null;

            foreach (UKClaimDCNoteDetailDef dcNoteDetailDef in dcNoteDetailList)
            {
                ukClaimDef = UKClaimWorker.Instance.getUKClaimByKey(dcNoteDetailDef.ClaimId);
                isVoidAsNSCost = (noteDef.isVoidAsNSCost);
                isVoidAsNSProvision = (noteDef.isVoidAsNSProvision);
                isVoidAsSupplierCost = (noteDef.isVoidAsSupplierCost);
                if (isVoidAsNSCost || isVoidAsNSProvision || isVoidAsSupplierCost)
                {
                    voidNo = noteDef.Remark.Split('|')[1];
                    orginalDCNoteDef = UKClaimWorker.Instance.getUKClaimDCNoteByDCNoteNo(voidNo.Split('-')[0]);
                }

                if (noteDef.SettledAmount != 0 || isVoidAsNSCost || isVoidAsNSProvision || isVoidAsSupplierCost)
                {
                    entry = new APInvoiceInterfaceEntry();
                    entry.COA = generalWorker.getEpicorCOA("1311304");
                    if (isVoidAsNSCost || isVoidAsNSProvision) entry.COA = "1452030";
                    entry.GroupId = EpicorInterfaceWorker.Instance.APInvoiceInterfaceFile.getSourceString();
                    entry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                    entry.ApplyDate = entry.GroupApplyDate;

                    if (isEnableWeek53Handling(logDef, false))
                    {
                        entry.GroupApplyDate = WK53_APPLY_DATE;
                        entry.ApplyDate = WK53_APPLY_DATE;
                    }

                    if ((noteDef.SettledAmount < 0 && !isVoidAsSupplierCost) || isVoidAsNSCost || (isVoidAsSupplierCost && noteDef.SettledAmount > 0))
                    {
                        entry.DocumentType = APInvoiceDocumentTypeEnum.NEXT_CLAIM_CREDIT_NOTE;
                        entry.IsDebitNote = false;
                    }
                    else
                    {
                        entry.DocumentType = APInvoiceDocumentTypeEnum.NEXT_CLAIM_DEBIT_NOTE;
                        entry.IsDebitNote = true;
                    }
                    entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
                    entry.Office = t0;
                    if (isVoidAsSupplierCost)
                        entry.SupplierId = vendorWorker.getVendorByKey(orginalDCNoteDef.VendorId).EpicorSupplierId;
                    else
                        entry.SupplierId = vendor.EpicorSupplierId;
                    entry.LineDescription = ukClaimDef.UKDebitNoteNo;
                    entry.Currency = CurrencyId.getCommonName(logDef.CurrencyId);
                    if (isVoidAsNSCost)
                    {
                        entry.UnitCost = Math.Abs(dcNoteDetailDef.Amount);
                        entry.Amount = Math.Abs(noteDef.TotalAmount);
                    }
                    else
                    {
                        entry.UnitCost = Math.Abs(dcNoteDetailDef.RechargeableAmount);
                        entry.Amount = Math.Abs(noteDef.SettledAmount);
                    }
                    entry.ItemNo = ukClaimDef.ItemNo;
                    entry.Qty = ukClaimDef.Quantity;
                    entry.PaymentTerm = "COD";
                    entry.InvoiceDate = noteDef.DCNoteDate;
                    entry.RealInvoiceNo = logDef.DebitCreditNoteNo;
                    entry.InvoiceNo = logDef.DebitCreditNoteNo;
                    entry.LegalNumber = logDef.DebitCreditNoteNo;

                    if (isVoidAsNSCost || isVoidAsNSProvision || isVoidAsSupplierCost)
                    {
                        entry.RealInvoiceNo = voidNo;
                        entry.InvoiceNo = voidNo;
                        entry.LegalNumber = voidNo;
                    }

                    if (ukClaimDef.Type == UKClaimType.AUDIT_FEE)
                    {
                        entry.SegmentValue4 = "OTHERS";
                        entry.SegmentValue6 = "AUD";
                    }
                    else
                    {
                        entry.SegmentValue4 = (ukClaimDef.ProductTeamId != 0 ? generalWorker.getProductCodeDefByKey(ukClaimDef.ProductTeamId).Code : "OTHERS");
                        entry.SegmentValue6 = ukClaimDef.T5Code;
                    }

                    if (entry.COA == "1452030")
                    {
                        entry.SegmentValue3 = getT1Code(logDef);
                        entry.SegmentValue4 = logDef.ProductTeamId == 0 ? string.Empty : generalWorker.getProductCodeDefByKey(logDef.ProductTeamId).Code;
                    }

                    /*
                    if ((t0 == "THV2" && logDef.OfficeId == OfficeId.VN.Id) && logDef.CurrencyId == CurrencyId.GBP.Id)
                    {
                        entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId == OfficeId.VN.Id ? OfficeId.TH.Id : OfficeId.IND.Id).EpicorCompanyId;
                        entry.Office = "TH2F";
                        entry.IsMultiCompany = true;
                        entry.ExternalCompany = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
                        entry.ExternalOffice = "THV2";
                        entry.ExternalCOA = entry.COA;
                        entry.ExternalSegmentValue4 = entry.SegmentValue4;
                        entry.ExternalSegmentValue6 = entry.SegmentValue6;
                        entry.SegmentValue4 = string.Empty;
                        entry.SegmentValue6 = string.Empty;
                        entry.COA = (logDef.OfficeId == OfficeId.VN.Id ? "1302013" : "1302612");
                    }
                    else if ((t0 == "CA1F" && logDef.OfficeId == OfficeId.CA.Id) && logDef.CurrencyId == CurrencyId.GBP.Id)
                    {
                        entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, OfficeId.HK.Id).EpicorCompanyId;
                        entry.Office = "HK1F";
                        entry.IsMultiCompany = true;
                        entry.ExternalCompany = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
                        entry.ExternalOffice = "CA1F";
                        entry.ExternalCOA = entry.COA;
                        entry.ExternalSegmentValue4 = entry.SegmentValue4;
                        entry.ExternalSegmentValue6 = entry.SegmentValue6;
                        entry.SegmentValue4 = string.Empty;
                        entry.SegmentValue6 = string.Empty;
                        entry.COA = "1302010";
                    }
                    */

                    /* removed @2018-08-06
                    if (ukClaimDef.OfficeId != ukClaimDef.PaymentOfficeId)
                    {
                        entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, ukClaimDef.PaymentOfficeId).EpicorCompanyId;
                        entry.Office = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, ukClaimDef.PaymentOfficeId).InterComT0Code;
                        entry.IsMultiCompany = true;
                        entry.ExternalCompany = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
                        entry.ExternalOffice = t0;
                        entry.ExternalCOA = entry.COA;
                        entry.ExternalSegmentValue4 = entry.SegmentValue4;
                        entry.ExternalSegmentValue6 = entry.SegmentValue6;
                        entry.SegmentValue4 = string.Empty;
                        entry.SegmentValue6 = string.Empty;
                        entry.COA = generalWorker.getCurrentAccountCOA(ukClaimDef.OfficeId, ukClaimDef.PaymentOfficeId);
                    }
                    */

                    entry.IsRecordComplete = (cnt == dcNoteDetailList.Count && noteDef.SettledAmount == noteDef.TotalAmount && noteDef.SettledAmount != 0) ? true : false;
                    EpicorInterfaceWorker.Instance.APInvoiceInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);
                }
                cnt += 1;
            }

            cnt = 1;

            if (isVoidAsSupplierCost)
            {
                foreach (UKClaimDCNoteDetailDef dcNoteDetailDef in dcNoteDetailList)
                {
                    ukClaimDef = UKClaimWorker.Instance.getUKClaimByKey(dcNoteDetailDef.ClaimId);

                    entry = new APInvoiceInterfaceEntry();
                    entry.COA = generalWorker.getEpicorCOA("1311304");
                    entry.GroupId = EpicorInterfaceWorker.Instance.APInvoiceInterfaceFile.getSourceString();
                    entry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                    entry.ApplyDate = entry.GroupApplyDate;

                    if (isEnableWeek53Handling(logDef, false))
                    {
                        entry.GroupApplyDate = WK53_APPLY_DATE;
                        entry.ApplyDate = WK53_APPLY_DATE;
                    }

                    if (noteDef.SettledAmount < 0)
                    {
                        entry.DocumentType = APInvoiceDocumentTypeEnum.NEXT_CLAIM_CREDIT_NOTE;
                        entry.IsDebitNote = false;
                    }
                    else
                    {
                        entry.DocumentType = APInvoiceDocumentTypeEnum.NEXT_CLAIM_DEBIT_NOTE;
                        entry.IsDebitNote = true;
                    }
                    entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
                    entry.Office = t0;
                    entry.SupplierId = vendor.EpicorSupplierId;
                    entry.LineDescription = ukClaimDef.UKDebitNoteNo;
                    entry.Currency = CurrencyId.getCommonName(logDef.CurrencyId);
                    entry.UnitCost = Math.Abs(dcNoteDetailDef.RechargeableAmount);
                    entry.Amount = Math.Abs(noteDef.SettledAmount);
                    entry.ItemNo = ukClaimDef.ItemNo;
                    entry.Qty = ukClaimDef.Quantity;
                    entry.PaymentTerm = "COD";
                    entry.InvoiceDate = noteDef.DCNoteDate;
                    entry.RealInvoiceNo = logDef.DebitCreditNoteNo;
                    entry.InvoiceNo = logDef.DebitCreditNoteNo;
                    entry.LegalNumber = logDef.DebitCreditNoteNo;

                    if (ukClaimDef.Type == UKClaimType.AUDIT_FEE)
                    {
                        entry.SegmentValue4 = "OTHERS";
                        entry.SegmentValue6 = "AUD";
                    }
                    else
                    {
                        entry.SegmentValue4 = (ukClaimDef.ProductTeamId != 0 ? generalWorker.getProductCodeDefByKey(ukClaimDef.ProductTeamId).Code : "OTHERS");
                        entry.SegmentValue6 = ukClaimDef.T5Code;
                    }
                    /*
                    if ((t0 == "THV2" && logDef.OfficeId == OfficeId.VN.Id) && logDef.CurrencyId == CurrencyId.GBP.Id)
                    {
                        entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId == OfficeId.VN.Id ? OfficeId.TH.Id : OfficeId.IND.Id).EpicorCompanyId;
                        entry.Office = "TH2F";
                        entry.IsMultiCompany = true;
                        entry.ExternalCompany = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
                        entry.ExternalOffice = "THV2";
                        entry.ExternalCOA = entry.COA;
                        entry.ExternalSegmentValue4 = entry.SegmentValue4;
                        entry.ExternalSegmentValue6 = entry.SegmentValue6;
                        entry.SegmentValue4 = string.Empty;
                        entry.SegmentValue6 = string.Empty;
                        entry.COA = (logDef.OfficeId == OfficeId.VN.Id ? "1302013" : "1302612");
                    }
                    else if ((t0 == "CA1F" && logDef.OfficeId == OfficeId.CA.Id) && logDef.CurrencyId == CurrencyId.GBP.Id)
                    {
                        entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, OfficeId.HK.Id).EpicorCompanyId;
                        entry.Office = "HK1F";
                        entry.IsMultiCompany = true;
                        entry.ExternalCompany = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
                        entry.ExternalOffice = "CA1F";
                        entry.ExternalCOA = entry.COA;
                        entry.ExternalSegmentValue4 = entry.SegmentValue4;
                        entry.ExternalSegmentValue6 = entry.SegmentValue6;
                        entry.SegmentValue4 = string.Empty;
                        entry.SegmentValue6 = string.Empty;
                        entry.COA = "1302010";
                    }
                    */
                    /* removed 2018-08-06
                    if (ukClaimDef.OfficeId != ukClaimDef.PaymentOfficeId)
                    {
                        entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, ukClaimDef.PaymentOfficeId).EpicorCompanyId;
                        entry.Office = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, ukClaimDef.PaymentOfficeId).InterComT0Code;
                        entry.IsMultiCompany = true;
                        entry.ExternalCompany = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
                        entry.ExternalOffice = t0;
                        entry.ExternalCOA = entry.COA;
                        entry.ExternalSegmentValue4 = entry.SegmentValue4;
                        entry.ExternalSegmentValue6 = entry.SegmentValue6;
                        entry.SegmentValue4 = string.Empty;
                        entry.SegmentValue6 = string.Empty;
                        entry.COA = generalWorker.getCurrentAccountCOA(ukClaimDef.OfficeId, ukClaimDef.PaymentOfficeId);
                    }
                    */

                    entry.IsRecordComplete = (cnt == dcNoteDetailList.Count && noteDef.SettledAmount == noteDef.TotalAmount && noteDef.SettledAmount != 0) ? true : false;
                    EpicorInterfaceWorker.Instance.APInvoiceInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);

                    cnt += 1;
                }
            }


            bool isFirst = true;
            ukClaimDef = null;
            ukClaimRefundDef = null;
            string coa = string.Empty;
            string remark = string.Empty;
            string dnNoStr = string.Empty;
            string comment = string.Empty;
            string segment7Value = string.Empty;
            string desc = string.Empty;

            if (noteDef.SettledAmount != noteDef.TotalAmount && !isVoidAsNSCost && !isVoidAsNSProvision && !isVoidAsSupplierCost)
            {
                foreach (UKClaimDCNoteDetailDef dcNoteDetailDef in dcNoteDetailList)
                {
                    ukClaimDef = UKClaimWorker.Instance.getUKClaimByKey(dcNoteDetailDef.ClaimId);

                    if (dcNoteDetailDef.ClaimRefundId > 0)
                        ukClaimRefundDef = UKClaimWorker.Instance.getUKClaimRefundByKey(dcNoteDetailDef.ClaimRefundId);

                    QAIS.ClaimRequestDef requestDef = svc.GetClaimRequestByKey(ukClaimDef.ClaimRequestId);
                    if (isFirst)
                    {
                        if (ukClaimDef.Vendor.VendorId == 1221 || ukClaimDef.Vendor.VendorId == 1930 || ukClaimDef.Vendor.VendorId == 1163)
                        {
                            ukClaimDef.PnLAccountCode = "1452030,SPECIFIC,U";
                            if (dcNoteDetailDef.ClaimRefundId > 0)
                                ukClaimRefundDef.PnLAccountCode = "1452030,SPECIFIC,U";
                        }
                        /*
                        Requested by Candice to remove below logic : 05/03/2021
                        if (ukClaimDef.Vendor.VendorId == 8516 || ukClaimDef.Vendor.VendorId == 7468 || ukClaimDef.Vendor.VendorId == 7000 || ukClaimDef.Vendor.VendorId == 8055 || ukClaimDef.Vendor.VendorId == 8056 || ukClaimDef.Vendor.VendorId == 10592)

                        {
                            ukClaimDef.PnLAccountCode = "1452029,SPECIFIC,U";
                            if (dcNoteDetailDef.ClaimRefundId > 0)
                                ukClaimRefundDef.PnLAccountCode = "1452030,SPECIFIC,U";
                        }
                        */

                        if (dcNoteDetailDef.ClaimRefundId > 0)
                        {
                            coa = (ukClaimRefundDef.PnLAccountCode != string.Empty ? ukClaimRefundDef.PnLAccountCode.Split(',')[0] : "3301010");
                            remark = (ukClaimRefundDef.PnLAccountCode != string.Empty ? ukClaimRefundDef.PnLAccountCode.Split(',')[1] : string.Empty);
                            segment7Value = (ukClaimRefundDef.PnLAccountCode != string.Empty ? ukClaimRefundDef.PnLAccountCode.Split(',')[2] : string.Empty);
                        }
                        else
                        {
                            coa = (ukClaimDef.PnLAccountCode != string.Empty ? ukClaimDef.PnLAccountCode.Split(',')[0] : "3301010");
                            remark = (ukClaimDef.PnLAccountCode != string.Empty ? ukClaimDef.PnLAccountCode.Split(',')[1] : string.Empty);
                            segment7Value = (ukClaimDef.PnLAccountCode != string.Empty ? ukClaimDef.PnLAccountCode.Split(',')[2] : string.Empty);
                        }

                        if (dcNoteDetailDef.ClaimRefundId == -1)
                        {
                            UKClaimBIADiscrepancyDef discrepancyDef = UKClaimWorker.Instance.getUKClaimBIADiscrepancyByKey(ukClaimDef.ClaimId);
                            if (discrepancyDef.ActionType.Id == BIAActionType.NS_PROVISION.Id)
                            {
                                coa = "1452030";
                            }
                        }

                        if (dcNoteDetailDef.ClaimRefundId > 0)
                            desc = (ukClaimRefundDef.SettlementOption == UKClaimSettlemtType.PROVISION ? "100% " : (requestDef != null && ukClaimRefundDef.SettlementOption == UKClaimSettlemtType.DEFAULT ? requestDef.NSRechargePercent.ToString("#,##0") + "% " : string.Empty)) + "NS COST APP BY SIMON (" + remark + ")";
                        else
                            desc = (ukClaimDef.SettlementOption == UKClaimSettlemtType.PROVISION ? "100% " : (requestDef != null && ukClaimDef.SettlementOption == UKClaimSettlemtType.DEFAULT ? requestDef.NSRechargePercent.ToString("#,##0") + "% " : string.Empty)) + "NS COST APP BY SIMON (" + remark + ")";

                        comment += ((comment == string.Empty ? string.Empty : "\n") + desc);

                        if (segment7Value == "AR")
                            comment += ((comment == string.Empty ? string.Empty : "\n") + "Transferred from #1227040 to " + coa);

                        comment += ((comment == string.Empty ? string.Empty : "\n") + "ex. " + ukClaimDef.Vendor.Name);
                        comment += ((comment == string.Empty ? string.Empty : "\n") + "--------------------------------");

                        dnNoStr = ((dnNoStr == string.Empty ? string.Empty : "\n") + ukClaimDef.UKDebitNoteNo + (dcNoteDetailDef.ClaimRefundId > 0 ? "-REFUND" : string.Empty));
                    }
                    else
                    {
                        comment += ((comment == string.Empty ? string.Empty : "\n") + "W/O " + ukClaimDef.UKDebitNoteNo);

                        if (dcNoteDetailDef.ClaimRefundId > 0)
                        {
                            desc = (ukClaimRefundDef.SettlementOption == UKClaimSettlemtType.PROVISION ? "100% " : (requestDef != null && ukClaimRefundDef.SettlementOption == UKClaimSettlemtType.DEFAULT ? requestDef.NSRechargePercent.ToString("#,##0") + "% " : string.Empty)) + "NS COST APP BY SIMON (" + remark + ")";
                            segment7Value = (ukClaimRefundDef.PnLAccountCode != string.Empty ? ukClaimRefundDef.PnLAccountCode.Split(',')[2] : string.Empty);
                        }
                        else
                        {
                            desc = (ukClaimDef.SettlementOption == UKClaimSettlemtType.PROVISION ? "100% " : (requestDef != null && ukClaimDef.SettlementOption == UKClaimSettlemtType.DEFAULT ? requestDef.NSRechargePercent.ToString("#,##0") + "% " : string.Empty)) + "NS COST APP BY SIMON (" + remark + ")";
                            segment7Value = (ukClaimDef.PnLAccountCode != string.Empty ? ukClaimDef.PnLAccountCode.Split(',')[2] : string.Empty);
                        }

                        comment += ((comment == string.Empty ? string.Empty : "\n") + desc);

                        if (segment7Value == "AR")
                            comment += ((comment == string.Empty ? string.Empty : "\n") + "Transferred from #1227040 to " + coa);

                        comment += ((comment == string.Empty ? string.Empty : "\n") + "ex. " + ukClaimDef.Vendor.Name);

                        comment += ((comment == string.Empty ? string.Empty : "\n") + "--------------------------------");
                        dnNoStr = ((dnNoStr == string.Empty ? string.Empty : "\n") + ukClaimDef.UKDebitNoteNo + (dcNoteDetailDef.ClaimRefundId > 0 ? "-REFUND" : string.Empty));
                    }
                    isFirst = false;

                    if (dcNoteDetailDef.RechargeableAmount != dcNoteDetailDef.Amount)
                    {
                        glEntry = new GLInterfaceEntry();
                        glEntry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
                        glEntry.GroupId = EpicorInterfaceWorker.Instance.GLInterfaceFile.getSourceString();
                        glEntry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                        glEntry.ApplyDate = glEntry.GroupApplyDate;

                        if (isEnableWeek53Handling(logDef, false))
                        {
                            glEntry.GroupApplyDate = WK53_APPLY_DATE;
                            glEntry.ApplyDate = WK53_APPLY_DATE;
                        }

                        glEntry.DocumentType = GLDocumentTypeEnum.GL;
                        glEntry.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
                        glEntry.Amount = Math.Abs(dcNoteDetailDef.Amount) - Math.Abs(dcNoteDetailDef.RechargeableAmount);
                        glEntry.BaseAmount = Math.Round(glEntry.Amount * commonWorker.getExchangeRate(ExchangeRateType.INVOICE, logDef.CurrencyId, logDef.TransactionDate) / commonWorker.getExchangeRate(ExchangeRateType.INVOICE, CurrencyId.USD.Id, logDef.TransactionDate), 2, MidpointRounding.AwayFromZero);
                        glEntry.Qty = ukClaimDef.Quantity;
                        glEntry.LineDescription = (dcNoteDetailDef.ClaimRefundId > 0 ? "REFUND - " : string.Empty) + ukClaimDef.UKDebitNoteNo + " NS COST";
                        glEntry.COA = generalWorker.getEpicorCOA("1311304");
                        glEntry.Office = getT0Code(logDef);
                        glEntry.IsRecordComplete = false;
                        if (ukClaimDef.Type == UKClaimType.AUDIT_FEE)
                        {
                            glEntry.SegmentValue4 = "OTHERS";
                            glEntry.SegmentValue6 = "AUD";
                        }
                        else
                        {
                            glEntry.SegmentValue4 = (ukClaimDef.ProductTeamId != 0 ? generalWorker.getProductCodeDefByKey(ukClaimDef.ProductTeamId).Code : "OTHERS");
                            glEntry.SegmentValue6 = ukClaimDef.T5Code;
                        }

                        if (dcNoteDetailDef.Amount > 0)
                            glEntry.DC = DCFlag.Credit;
                        else
                            glEntry.DC = DCFlag.Debit;
                        glEntry.IsRecordComplete = false;
                        EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                        glEntry = new GLInterfaceEntry();
                        glEntry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
                        glEntry.GroupId = EpicorInterfaceWorker.Instance.GLInterfaceFile.getSourceString();
                        glEntry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                        glEntry.ApplyDate = glEntry.GroupApplyDate;

                        if (isEnableWeek53Handling(logDef, false))
                        {
                            glEntry.GroupApplyDate = WK53_APPLY_DATE;
                            glEntry.ApplyDate = WK53_APPLY_DATE;
                        }

                        glEntry.DocumentType = GLDocumentTypeEnum.GL;
                        glEntry.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
                        glEntry.Amount = Math.Abs(dcNoteDetailDef.Amount) - Math.Abs(dcNoteDetailDef.RechargeableAmount);
                        glEntry.BaseAmount = Math.Round(glEntry.Amount * commonWorker.getExchangeRate(ExchangeRateType.INVOICE, logDef.CurrencyId, logDef.TransactionDate) / commonWorker.getExchangeRate(ExchangeRateType.INVOICE, CurrencyId.USD.Id, logDef.TransactionDate), 2, MidpointRounding.AwayFromZero);
                        glEntry.LineDescription = comment;
                        glEntry.LineComment = dnNoStr;
                        glEntry.COA = coa;
                        if (coa == "1452030" || coa == "1452029")
                        {
                            if (dcNoteDetailDef.ClaimRefundId > 0)
                                glEntry.SegmentValue7 = (ukClaimRefundDef.PnLAccountCode != string.Empty ? ukClaimRefundDef.PnLAccountCode.Split(',')[2] : string.Empty);
                            else
                                glEntry.SegmentValue7 = (ukClaimDef.PnLAccountCode != string.Empty ? ukClaimDef.PnLAccountCode.Split(',')[2] : string.Empty);

                            if (coa == "1452030")
                            {
                                glEntry.SegmentValue3 = getT1Code(logDef);
                                glEntry.SegmentValue4 = logDef.ProductTeamId == 0 ? string.Empty : generalWorker.getProductCodeDefByKey(logDef.ProductTeamId).Code;
                            }
                        }

                        if (dcNoteDetailDef.ClaimRefundId > 0)
                        {
                            if (ukClaimRefundDef.PnLAccountCode != string.Empty && ukClaimRefundDef.PnLAccountCode.Split(',')[1] == "SPECIFIC")
                                glEntry.SegmentValue8 = "S";
                            else if (ukClaimRefundDef.PnLAccountCode != string.Empty && ukClaimRefundDef.PnLAccountCode.Split(',')[1] == "GENERAL")
                                glEntry.SegmentValue8 = "G";
                        }
                        else
                        {
                            if (ukClaimDef.PnLAccountCode != string.Empty && ukClaimDef.PnLAccountCode.Split(',')[1] == "SPECIFIC")
                                glEntry.SegmentValue8 = "S";
                            else if (ukClaimDef.PnLAccountCode != string.Empty && ukClaimDef.PnLAccountCode.Split(',')[1] == "GENERAL")
                                glEntry.SegmentValue8 = "G";
                        }

                        glEntry.Office = getT0Code(logDef);
                        glEntry.IsRecordComplete = true;

                        if (dcNoteDetailDef.Amount > 0)
                            glEntry.DC = DCFlag.Debit;
                        else
                            glEntry.DC = DCFlag.Credit;
                        glEntry.IsRecordComplete = true;

                        EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);
                    }

                }
            }
        }

        private void addActualUKDiscountClaimToSAFList(SunInterfaceLogDef logDef, ArrayList safList)
        {
            string t0 = getT0Code(logDef);

            UKDiscountClaimDef ukDiscountClaimDef = null;
            UKDiscountClaimRefundDef ukDiscountClaimRefundDef = null;

            if (int.Parse(logDef.ReferenceNo) > 0)
                ukDiscountClaimDef = UKClaimWorker.Instance.getUKDiscountClaimByKey(int.Parse(logDef.ReferenceNo));
            else
            {
                ukDiscountClaimRefundDef = UKClaimWorker.Instance.getUKDiscountClaimRefundByKey(Math.Abs(int.Parse(logDef.ReferenceNo)));
                ukDiscountClaimDef = UKClaimWorker.Instance.getUKDiscountClaimByKey(ukDiscountClaimRefundDef.ClaimId);
            }

            ARInvoiceInterfaceEntry entry = new ARInvoiceInterfaceEntry();
            if (int.Parse(logDef.ReferenceNo) > 0)
            {
                entry.DocumentType = ARInvoiceDocumentTypeEnum.NEXT_CLAIM_DEBIT_NOTE;
                entry.IsCreditNote = true;
                entry.InvoiceNo = "UDC-" + ukDiscountClaimDef.ClaimId.ToString().PadLeft(7, '0');
            }
            else
            {
                if (logDef.OtherAmount < 0)
                {
                    entry.DocumentType = ARInvoiceDocumentTypeEnum.NEXT_CLAIM_DEBIT_NOTE;
                    entry.IsCreditNote = true;
                }
                else
                    entry.DocumentType = ARInvoiceDocumentTypeEnum.NEXT_CLAIM_REFUND;

                entry.InvoiceNo = "NDCR-" + ukDiscountClaimRefundDef.ClaimRefundId.ToString().PadLeft(7, '0');
            }
            entry.LegalNumber = entry.InvoiceNo;
            entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
            entry.Office = t0;
            entry.CustomerId = "NAR003";
            entry.COA = "1227060";

            if (ukDiscountClaimDef.OfficeId != ukDiscountClaimDef.PaymentOfficeId)
            {
                entry.Office = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, ukDiscountClaimDef.PaymentOfficeId).InterComT0Code;
                entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, ukDiscountClaimDef.PaymentOfficeId).EpicorCompanyId;
                entry.COA = generalWorker.getCurrentAccountCOA(ukDiscountClaimDef.OfficeId, ukDiscountClaimDef.PaymentOfficeId);
            }
            else
                entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;

            entry.GroupId = EpicorInterfaceWorker.Instance.ARInvoiceInterfaceFile.getSourceString();
            entry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
            entry.ApplyDate = entry.GroupApplyDate;

            if (isEnableWeek53Handling(logDef, false))
            {
                entry.GroupApplyDate = WK53_APPLY_DATE;
                entry.ApplyDate = WK53_APPLY_DATE;
            }

            if (int.Parse(logDef.ReferenceNo) > 0)
                entry.LineDescription = "REC'D " + ukDiscountClaimDef.UKDebitNoteNo + " UK " + logDef.TransactionDate.ToString("dd/MM");
            else
                entry.LineDescription = "REFUND " + ukDiscountClaimDef.UKDebitNoteNo + " " + logDef.TransactionDate.ToString("dd/MM");

            entry.Currency = CurrencyId.getCommonName(logDef.CurrencyId);
            entry.UnitCost = Math.Abs(logDef.OtherAmount);
            entry.Amount = Math.Abs(logDef.OtherAmount);
            entry.Qty = logDef.Quantity;
            entry.ItemNo = ukDiscountClaimDef.ItemNo;
            entry.SegmentValue4 = (ukDiscountClaimDef.ProductTeamId != 0 ? generalWorker.getProductCodeDefByKey(logDef.ProductTeamId).Code : "Others");
            entry.SegmentValue6 = "DS";
            entry.SegmentValue7 = "U";
            entry.SegmentValue8 = "S";

            entry.RealInvoiceNo = ukDiscountClaimDef.ContractNo;
            entry.InvoiceDate = logDef.TransactionDate;
            EpicorInterfaceWorker.Instance.ARInvoiceInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);

            if (ukDiscountClaimDef.OfficeId != ukDiscountClaimDef.PaymentOfficeId)
            {
                GLInterfaceEntry glEntry = new GLInterfaceEntry();
                glEntry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
                glEntry.GroupId = EpicorInterfaceWorker.Instance.GLInterfaceFile.getSourceString();
                glEntry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                glEntry.ApplyDate = glEntry.GroupApplyDate;

                if (isEnableWeek53Handling(logDef, false))
                {
                    glEntry.GroupApplyDate = WK53_APPLY_DATE;
                    glEntry.ApplyDate = WK53_APPLY_DATE;
                }

                glEntry.DocumentType = GLDocumentTypeEnum.GL;
                glEntry.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
                if (logDef.OtherAmount < 0)
                    glEntry.DC = int.Parse(logDef.ReferenceNo) > 0 ? DCFlag.Debit : DCFlag.Credit;
                else
                    glEntry.DC = int.Parse(logDef.ReferenceNo) > 0 ? DCFlag.Credit : DCFlag.Debit;
                glEntry.Qty = logDef.Quantity;
                glEntry.Amount = logDef.OtherAmount;
                glEntry.BaseAmount = logDef.BaseAmount;
                glEntry.LineDescription = ("C/A - " + generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, ukDiscountClaimDef.PaymentOfficeId).InterComT0Code + "/" + generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, ukDiscountClaimDef.OfficeId).InterComT0Code);
                glEntry.Office = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, ukDiscountClaimDef.OfficeId).InterComT0Code;
                glEntry.COA = generalWorker.getCurrentAccountCOA(ukDiscountClaimDef.OfficeId, ukDiscountClaimDef.PaymentOfficeId);
                glEntry.IsRecordComplete = false;
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                glEntry = (GLInterfaceEntry)glEntry.Clone();
                if (logDef.OtherAmount < 0)
                    glEntry.DC = int.Parse(logDef.ReferenceNo) > 0 ? DCFlag.Credit : DCFlag.Debit;
                else
                    glEntry.DC = int.Parse(logDef.ReferenceNo) > 0 ? DCFlag.Debit : DCFlag.Credit;
                glEntry.COA = "1227060";
                glEntry.LineDescription = "REC'D " + ukDiscountClaimDef.UKDebitNoteNo + " UK " + ukDiscountClaimDef.UKDebitNoteReceivedDate.ToString("dd/MM");

                glEntry.SegmentValue4 = (ukDiscountClaimDef.ProductTeamId != 0 ? generalWorker.getProductCodeDefByKey(logDef.ProductTeamId).Code : "Others");
                glEntry.SegmentValue6 = "DS";
                glEntry.SegmentValue7 = "U";
                glEntry.SegmentValue8 = "S";

                glEntry.IsRecordComplete = true;
                EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);
            }
        }

        private void addActualUKDiscountClaimClearingToSAFList(SunInterfaceLogDef logDef, ArrayList safList)
        {
            UKDiscountClaimDef claim;
            if (int.Parse(logDef.ReferenceNo) > 0)
                claim = UKClaimWorker.Instance.getUKDiscountClaimByKey(int.Parse(logDef.ReferenceNo));
            else
            {
                UKDiscountClaimRefundDef claimRefund = UKClaimWorker.Instance.getUKDiscountClaimRefundByKey(Math.Abs(int.Parse(logDef.ReferenceNo)));
                claim = UKClaimWorker.Instance.getUKDiscountClaimByKey(claimRefund.ClaimId);
            }

            GLInterfaceEntry glEntry = new GLInterfaceEntry();
            glEntry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
            glEntry.GroupId = EpicorInterfaceWorker.Instance.GLInterfaceFile.getSourceString();
            glEntry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
            glEntry.ApplyDate = glEntry.GroupApplyDate;
            if (isEnableWeek53Handling(logDef, false))
            {
                glEntry.GroupApplyDate = WK53_APPLY_DATE;
                glEntry.ApplyDate = WK53_APPLY_DATE;
            }
            glEntry.DocumentType = GLDocumentTypeEnum.GL;
            glEntry.JournalCode = "IJ";
            glEntry.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
            glEntry.DC = int.Parse(logDef.ReferenceNo) > 0 ? DCFlag.Debit : DCFlag.Credit;
            glEntry.Amount = logDef.OtherAmount;
            glEntry.BaseAmount = logDef.BaseAmount;
            glEntry.Qty = 0;
            glEntry.LineDescription = "CLEAR " + claim.UKDebitNoteNo + " " + logDef.ContractNo;
            glEntry.LineComment = glEntry.LineDescription;
            if ((new ArrayList() { OfficeId.ND.Id, OfficeId.IND.Id, OfficeId.SL.Id }).Contains(logDef.OfficeId))
                glEntry.COA = "3020253";
            else if (new ArrayList() { OfficeId.HK.Id, OfficeId.CA.Id, OfficeId.VN.Id, OfficeId.SH.Id, OfficeId.BD.Id, OfficeId.TR.Id }.Contains(logDef.OfficeId))
                glEntry.COA = "3202025";
            glEntry.Office = getT0Code(logDef);
            glEntry.SegmentValue3 = getT1Code(logDef);
            glEntry.SegmentValue4 = generalWorker.getProductCodeDefByKey(logDef.ProductTeamId).Code;
            glEntry.SegmentValue5 = getSeasonSegmentValue(logDef.SeasonId);
            glEntry.SegmentValue6 = string.Empty;
            glEntry.SegmentValue7 = "SP";
            glEntry.SegmentValue8 = "S";
            glEntry.IsMultiCompany = false;
            glEntry.Reverse = false;
            glEntry.IsRecordComplete = false;
            EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

            glEntry = (GLInterfaceEntry)glEntry.Clone();
            glEntry.DC = int.Parse(logDef.ReferenceNo) > 0 ? DCFlag.Credit : DCFlag.Debit;
            glEntry.COA = "1227060";
            glEntry.IsRecordComplete = true;
            EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

        }

        private void addActualMockShopToSAFList(SunInterfaceLogDef logDef, ArrayList safList)
        {
            MockShopDCNoteDef mockShopDef = this.getMockShopDCNoteByDCNoteNo(logDef.DebitCreditNoteNo);
            ArrayList courierChargeList = this.getMockShopCourierChargeListByDCNoteNo(logDef.DebitCreditNoteNo);
            decimal commissionBaseAmt = mockShopDef.TotalNSLCommissionAmt * commonWorker.getExchangeRate(ExchangeRateType.PAYABLE_RECEIVABLE, logDef.CurrencyId, logDef.TransactionDate) / commonWorker.getExchangeRate(ExchangeRateType.PAYABLE_RECEIVABLE, CurrencyId.USD.Id, logDef.TransactionDate);

            ARInvoiceInterfaceEntry entry = new ARInvoiceInterfaceEntry();
            ArrayList mockShopShipmentList = this.getMockShopDCNoteShipmentByDCNoteId(mockShopDef.DCNoteId);

            foreach (MockShopDCNoteShipmentDef mcShipmentDef in mockShopShipmentList)
            {
                if (mcShipmentDef.TotalCourierCharge != 0)
                {
                    SunInterfaceLogDef salesLog = this.getLatestLogByShipmentId(SunInterfaceTypeRef.Id.MockShopSales.GetHashCode(), mcShipmentDef.ShipmentId, 0);
                    ContractDef contractDef = OrderSelectWorker.Instance.getContractByKey(mcShipmentDef.ContractId);
                    ShipmentDef shipmentDef = OrderSelectWorker.Instance.getShipmentByKey(mcShipmentDef.ShipmentId);
                    entry = new ARInvoiceInterfaceEntry();
                    entry.CustomerId = "NAR003";
                    entry.COA = "3305810";
                    entry.COA = generalWorker.getEpicorCOA(entry.COA);
                    entry.GroupId = EpicorInterfaceWorker.Instance.ARInvoiceInterfaceFile.getSourceString();
                    entry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                    entry.ApplyDate = entry.GroupApplyDate;
                    if (isEnableWeek53Handling(logDef, false))
                    {
                        entry.GroupApplyDate = WK53_APPLY_DATE;
                        entry.ApplyDate = WK53_APPLY_DATE;
                    }

                    entry.DocumentType = ARInvoiceDocumentTypeEnum.ISAM_SALES;
                    entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
                    entry.Office = getT0Code(salesLog);
                    entry.SegmentValue3 = getT1Code(salesLog);
                    entry.SegmentValue4 = generalWorker.getProductCodeDefByKey(contractDef.ProductTeam.ProductCodeId).Code;
                    entry.SegmentValue5 = getSeasonSegmentValue(contractDef.Season.SeasonId);
                    /*
                    entry.LineDescription = contractDef.ContractNo + "-" + shipmentDef.DeliveryNo.ToString();
                    */
                    entry.LineDescription = "Mock Shop Courier for P" + logDef.Period.ToString();
                    entry.Currency = CurrencyId.getCommonName(logDef.CurrencyId);
                    entry.UnitCost = mcShipmentDef.TotalCourierCharge;
                    entry.Amount = mockShopDef.TotalCourierCharge;
                    entry.Qty = mcShipmentDef.TotalShippedQty * contractDef.PiecesPerPack;
                    entry.ItemNo = ProductWorker.Instance.getProductByKey(contractDef.ProductId).ItemNo;
                    entry.RealInvoiceNo = mockShopDef.DCNoteNo + "E";
                    entry.InvoiceDate = logDef.TransactionDate;
                    entry.InvoiceNo = mockShopDef.DCNoteNo + "E";
                    entry.LegalNumber = mockShopDef.DCNoteNo + "E";
                    entry.LineOriginalInvoiceNo = getT9Code(salesLog);
                    entry.IsRecordComplete = false;

                    string salesCOA = entry.COA;

                    /*
                    if (entry.Office == "THV2" && logDef.OfficeId == OfficeId.VN.Id && logDef.CurrencyId == CurrencyId.GBP.Id)
                    {
                        entry.Office = "HK1F";
                        entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, OfficeId.HK.Id).EpicorCompanyId;
                        entry.COA = "1302013";
                    }
                    */
                    if (entry.Office == "CA1F" && logDef.OfficeId == OfficeId.CA.Id && logDef.CurrencyId == CurrencyId.GBP.Id)
                    {
                        entry.Office = "HK1F";
                        entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, OfficeId.HK.Id).EpicorCompanyId;
                        entry.COA = "1302010";
                    }
                    else
                        entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;

                    EpicorInterfaceWorker.Instance.ARInvoiceInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);

                    /*
                    if (getT0Code(salesLog) == "THV2" && logDef.OfficeId == OfficeId.VN.Id && logDef.CurrencyId == CurrencyId.GBP.Id)
                    {
                        GLInterfaceEntry glEntry = new GLInterfaceEntry();
                        glEntry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, OfficeId.VN.Id).EpicorCompanyId;
                        glEntry.GroupId = EpicorInterfaceWorker.Instance.GLInterfaceFile.getSourceString();
                        glEntry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                        glEntry.ApplyDate = glEntry.GroupApplyDate;
                        if (isEnableWeek53Handling(logDef, false))
                        {
                            glEntry.GroupApplyDate = WK53_APPLY_DATE;
                            glEntry.ApplyDate = WK53_APPLY_DATE;
                        }

                        glEntry.DocumentType = GLDocumentTypeEnum.GL;
                        glEntry.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
                        glEntry.DC = DCFlag.Debit;
                        glEntry.Qty = mcShipmentDef.TotalShippedQty * contractDef.PiecesPerPack;
                        glEntry.Amount = mcShipmentDef.TotalCourierCharge;
                        glEntry.BaseAmount = Math.Round(glEntry.Amount * commonWorker.getExchangeRate(ExchangeRateType.PAYABLE_RECEIVABLE, logDef.CurrencyId, logDef.TransactionDate) / commonWorker.getExchangeRate(ExchangeRateType.PAYABLE_RECEIVABLE, CurrencyId.USD.Id, logDef.TransactionDate), 2, MidpointRounding.AwayFromZero);
                        glEntry.LineDescription = "Mock Shop Courier for P" + logDef.Period.ToString();
                        glEntry.Office = "THV2";
                        glEntry.COA = "1302013";
                        glEntry.IsRecordComplete = false;
                        glEntry.SegmentValue3 = getT1Code(salesLog);
                        glEntry.SegmentValue4 = generalWorker.getProductCodeDefByKey(contractDef.ProductTeam.ProductCodeId).Code;
                        glEntry.SegmentValue5 = getSeasonSegmentValue(contractDef.Season.SeasonId);
                        EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                        glEntry = (GLInterfaceEntry)glEntry.Clone();
                        glEntry.DC = DCFlag.Credit;
                        glEntry.COA = salesCOA;
                        glEntry.IsRecordComplete = true;
                        EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);
                    }
                    */
                    if (getT0Code(salesLog) == "CA1F" && logDef.OfficeId == OfficeId.CA.Id && logDef.CurrencyId == CurrencyId.GBP.Id)
                    {
                        GLInterfaceEntry glEntry = new GLInterfaceEntry();
                        glEntry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, OfficeId.CA.Id).EpicorCompanyId;
                        glEntry.GroupId = EpicorInterfaceWorker.Instance.GLInterfaceFile.getSourceString();
                        glEntry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                        glEntry.ApplyDate = glEntry.GroupApplyDate;
                        if (isEnableWeek53Handling(logDef, false))
                        {
                            glEntry.GroupApplyDate = WK53_APPLY_DATE;
                            glEntry.ApplyDate = WK53_APPLY_DATE;
                        }

                        glEntry.DocumentType = GLDocumentTypeEnum.GL;
                        glEntry.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
                        glEntry.DC = DCFlag.Debit;
                        glEntry.Qty = mcShipmentDef.TotalShippedQty * contractDef.PiecesPerPack;
                        glEntry.Amount = mcShipmentDef.TotalCourierCharge;
                        glEntry.BaseAmount = Math.Round(glEntry.Amount * commonWorker.getExchangeRate(ExchangeRateType.PAYABLE_RECEIVABLE, logDef.CurrencyId, logDef.TransactionDate) / commonWorker.getExchangeRate(ExchangeRateType.PAYABLE_RECEIVABLE, CurrencyId.USD.Id, logDef.TransactionDate), 2, MidpointRounding.AwayFromZero);
                        glEntry.LineDescription = "Mock Shop Courier for P" + logDef.Period.ToString();
                        glEntry.Office = "CA1F";
                        glEntry.COA = "1302010";
                        glEntry.IsRecordComplete = false;
                        glEntry.SegmentValue3 = getT1Code(salesLog);
                        glEntry.SegmentValue4 = generalWorker.getProductCodeDefByKey(contractDef.ProductTeam.ProductCodeId).Code;
                        glEntry.SegmentValue5 = getSeasonSegmentValue(contractDef.Season.SeasonId);
                        EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                        glEntry = (GLInterfaceEntry)glEntry.Clone();
                        glEntry.DC = DCFlag.Credit;
                        glEntry.COA = salesCOA;
                        glEntry.IsRecordComplete = true;
                        EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);
                    }

                }
            }
        }


        private void addActualStudioSampleToSAFList(SunInterfaceLogDef logDef, ArrayList safList)
        {
            StudioDCNoteDef studioSampleDef = this.getStudioDCNoteByDCNoteNo(logDef.DebitCreditNoteNo);
            ArrayList courierChargeList = this.getStudioCourierChargeListByDCNoteNo(logDef.DebitCreditNoteNo);
            decimal commissionBaseAmt = studioSampleDef.TotalNSLCommissionAmt * commonWorker.getExchangeRate(ExchangeRateType.PAYABLE_RECEIVABLE, logDef.CurrencyId, logDef.TransactionDate) / commonWorker.getExchangeRate(ExchangeRateType.PAYABLE_RECEIVABLE, CurrencyId.USD.Id, logDef.TransactionDate);

            ARInvoiceInterfaceEntry entry = new ARInvoiceInterfaceEntry();
            ArrayList studioShipmentList = this.getStudioDCNoteShipmentByDCNoteId(studioSampleDef.DCNoteId);

            foreach (StudioDCNoteShipmentDef studioShipmentDef in studioShipmentList)
            {
                if (studioShipmentDef.TotalCourierCharge != 0)
                {
                    SunInterfaceLogDef salesLog = this.getLatestLogByShipmentId(SunInterfaceTypeRef.Id.StudioSampleSales.GetHashCode(), studioShipmentDef.ShipmentId, 0);
                    ContractDef contractDef = OrderSelectWorker.Instance.getContractByKey(studioShipmentDef.ContractId);
                    ShipmentDef shipmentDef = OrderSelectWorker.Instance.getShipmentByKey(studioShipmentDef.ShipmentId);
                    entry = new ARInvoiceInterfaceEntry();
                    entry.CustomerId = "NAR003";
                    entry.COA = "3305820";
                    entry.COA = generalWorker.getEpicorCOA(entry.COA);
                    entry.GroupId = EpicorInterfaceWorker.Instance.ARInvoiceInterfaceFile.getSourceString();
                    entry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                    entry.ApplyDate = entry.GroupApplyDate;
                    if (isEnableWeek53Handling(logDef, false))
                    {
                        entry.GroupApplyDate = WK53_APPLY_DATE;
                        entry.ApplyDate = WK53_APPLY_DATE;
                    }

                    entry.DocumentType = ARInvoiceDocumentTypeEnum.ISAM_SALES;
                    entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
                    entry.Office = getT0Code(salesLog);
                    entry.SegmentValue3 = getT1Code(salesLog);
                    entry.SegmentValue4 = generalWorker.getProductCodeDefByKey(contractDef.ProductTeam.ProductCodeId).Code;
                    entry.SegmentValue5 = getSeasonSegmentValue(contractDef.Season.SeasonId);
                    /*
                    entry.LineDescription = contractDef.ContractNo + "-" + shipmentDef.DeliveryNo.ToString();
                    */
                    entry.LineDescription = "Studio Sample Courier for P" + logDef.Period.ToString();
                    entry.Currency = CurrencyId.getCommonName(logDef.CurrencyId);
                    entry.UnitCost = studioShipmentDef.TotalCourierCharge;
                    entry.Amount = studioSampleDef.TotalCourierCharge;
                    entry.Qty = studioShipmentDef.TotalShippedQty * contractDef.PiecesPerPack;
                    entry.ItemNo = ProductWorker.Instance.getProductByKey(contractDef.ProductId).ItemNo;
                    entry.RealInvoiceNo = studioSampleDef.DCNoteNo + "E";
                    entry.InvoiceDate = logDef.TransactionDate;
                    entry.InvoiceNo = studioSampleDef.DCNoteNo + "E";
                    entry.LegalNumber = studioSampleDef.DCNoteNo + "E";
                    entry.LineOriginalInvoiceNo = getT9Code(salesLog);
                    entry.IsRecordComplete = false;

                    string salesCOA = entry.COA;

                    /*
                    if (entry.Office == "THV2" && logDef.OfficeId == OfficeId.VN.Id && logDef.CurrencyId == CurrencyId.GBP.Id)
                    {
                        entry.Office = "HK1F";
                        entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, OfficeId.HK.Id).EpicorCompanyId;
                        entry.COA = "1302013";
                    }
                    */
                    if (entry.Office == "CA1F" && logDef.OfficeId == OfficeId.CA.Id && logDef.CurrencyId == CurrencyId.GBP.Id)
                    {
                        entry.Office = "HK1F";
                        entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, OfficeId.HK.Id).EpicorCompanyId;
                        entry.COA = "1302010";
                    }
                    else
                        entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;

                    EpicorInterfaceWorker.Instance.ARInvoiceInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);

                    /*
                    if (getT0Code(salesLog) == "THV2" && logDef.OfficeId == OfficeId.VN.Id && logDef.CurrencyId == CurrencyId.GBP.Id)
                    {
                        GLInterfaceEntry glEntry = new GLInterfaceEntry();
                        glEntry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, OfficeId.VN.Id).EpicorCompanyId;
                        glEntry.GroupId = EpicorInterfaceWorker.Instance.GLInterfaceFile.getSourceString();
                        glEntry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                        glEntry.ApplyDate = glEntry.GroupApplyDate;
                        if (isEnableWeek53Handling(logDef, false))
                        {
                            glEntry.GroupApplyDate = WK53_APPLY_DATE;
                            glEntry.ApplyDate = WK53_APPLY_DATE;
                        }

                        glEntry.DocumentType = GLDocumentTypeEnum.GL;
                        glEntry.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
                        glEntry.DC = DCFlag.Debit;
                        glEntry.Qty = studioShipmentDef.TotalShippedQty * contractDef.PiecesPerPack;
                        glEntry.Amount = studioShipmentDef.TotalCourierCharge;
                        glEntry.BaseAmount = Math.Round(glEntry.Amount * commonWorker.getExchangeRate(ExchangeRateType.PAYABLE_RECEIVABLE, logDef.CurrencyId, logDef.TransactionDate) / commonWorker.getExchangeRate(ExchangeRateType.PAYABLE_RECEIVABLE, CurrencyId.USD.Id, logDef.TransactionDate), 2, MidpointRounding.AwayFromZero);
                        glEntry.LineDescription = "Studio Sample Courier for P" + logDef.Period.ToString();
                        glEntry.Office = "THV2";
                        glEntry.COA = "1302013";
                        glEntry.IsRecordComplete = false;
                        glEntry.SegmentValue3 = getT1Code(salesLog);
                        glEntry.SegmentValue4 = generalWorker.getProductCodeDefByKey(contractDef.ProductTeam.ProductCodeId).Code;
                        glEntry.SegmentValue5 = getSeasonSegmentValue(contractDef.Season.SeasonId);
                        EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                        glEntry = (GLInterfaceEntry)glEntry.Clone();
                        glEntry.DC = DCFlag.Credit;
                        glEntry.COA = salesCOA;
                        glEntry.IsRecordComplete = true;
                        EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);
                    }
                    */
                    if (getT0Code(salesLog) == "CA1F" && logDef.OfficeId == OfficeId.CA.Id && logDef.CurrencyId == CurrencyId.GBP.Id)
                    {
                        GLInterfaceEntry glEntry = new GLInterfaceEntry();
                        glEntry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, OfficeId.CA.Id).EpicorCompanyId;
                        glEntry.GroupId = EpicorInterfaceWorker.Instance.GLInterfaceFile.getSourceString();
                        glEntry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                        glEntry.ApplyDate = glEntry.GroupApplyDate;
                        if (isEnableWeek53Handling(logDef, false))
                        {
                            glEntry.GroupApplyDate = WK53_APPLY_DATE;
                            glEntry.ApplyDate = WK53_APPLY_DATE;
                        }

                        glEntry.DocumentType = GLDocumentTypeEnum.GL;
                        glEntry.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
                        glEntry.DC = DCFlag.Debit;
                        glEntry.Qty = studioShipmentDef.TotalShippedQty * contractDef.PiecesPerPack;
                        glEntry.Amount = studioShipmentDef.TotalCourierCharge;
                        glEntry.BaseAmount = Math.Round(glEntry.Amount * commonWorker.getExchangeRate(ExchangeRateType.PAYABLE_RECEIVABLE, logDef.CurrencyId, logDef.TransactionDate) / commonWorker.getExchangeRate(ExchangeRateType.PAYABLE_RECEIVABLE, CurrencyId.USD.Id, logDef.TransactionDate), 2, MidpointRounding.AwayFromZero);
                        glEntry.LineDescription = "Studio Sample Courier for P" + logDef.Period.ToString();
                        glEntry.Office = "CA1F";
                        glEntry.COA = "1302010";
                        glEntry.IsRecordComplete = false;
                        glEntry.SegmentValue3 = getT1Code(salesLog);
                        glEntry.SegmentValue4 = generalWorker.getProductCodeDefByKey(contractDef.ProductTeam.ProductCodeId).Code;
                        glEntry.SegmentValue5 = getSeasonSegmentValue(contractDef.Season.SeasonId);
                        EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                        glEntry = (GLInterfaceEntry)glEntry.Clone();
                        glEntry.DC = DCFlag.Credit;
                        glEntry.COA = salesCOA;
                        glEntry.IsRecordComplete = true;
                        EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);
                    }

                }
            }
        }

        /*
        private void buildMockShopSummary(SunInterfaceLogDef logDef)
        {
            decimal baseAmt;
            decimal otherAmt;
            string currencyCode = CurrencyId.getName(logDef.CurrencyId);

            if (!mockShopSummary.ContainsKey(currencyCode))
                mockShopSummary.Add(CurrencyId.getName(logDef.CurrencyId), logDef.BaseAmount.ToString() + "," + logDef.OtherAmount);
            else
            {
                baseAmt = decimal.Parse(mockShopSummary[currencyCode].ToString().Split(',')[0]);
                otherAmt = decimal.Parse(mockShopSummary[currencyCode].ToString().Split(',')[1]);
                mockShopSummary[currencyCode] = (baseAmt + logDef.BaseAmount).ToString() + "," + (otherAmt + logDef.OtherAmount).ToString();
            }
        }
        */

        private void buildDevelopmentCostSummary(SunInterfaceLogDef logDef)
        {
            decimal baseAmt;
            decimal otherAmt;
            string dept = logDef.DeptId.ToString();

            if (!devCostSummary.ContainsKey(dept))
                devCostSummary.Add(dept, logDef.BaseAmount.ToString() + "," + logDef.OtherAmount);
            else
            {
                baseAmt = decimal.Parse(devCostSummary[dept].ToString().Split(',')[0]);
                otherAmt = decimal.Parse(devCostSummary[dept].ToString().Split(',')[1]);
                devCostSummary[dept] = (baseAmt + logDef.BaseAmount).ToString() + "," + (otherAmt + logDef.OtherAmount).ToString();
            }
        }

        private void buildFabricLiabilitiesProvisionSummary(SunInterfaceLogDef logDef)
        {
            decimal baseAmt;
            decimal otherAmt;
            string dept = logDef.DeptId.ToString();

            if (!devCostSummary.ContainsKey(dept))
                devCostSummary.Add(dept, logDef.BaseAmount.ToString() + "," + logDef.OtherAmount);
            else
            {
                baseAmt = decimal.Parse(devCostSummary[dept].ToString().Split(',')[0]);
                otherAmt = decimal.Parse(devCostSummary[dept].ToString().Split(',')[1]);
                devCostSummary[dept] = (baseAmt + logDef.BaseAmount).ToString() + "," + (otherAmt + logDef.OtherAmount).ToString();
            }
        }

        /*
        private void buildReverseMockShopSummary(SunInterfaceLogDef logDef)
        {
            decimal baseAmt;
            decimal otherAmt;
            string currencyCode = CurrencyId.getName(logDef.CurrencyId);

            if (!reverseMockShopSummary.ContainsKey(currencyCode))
                reverseMockShopSummary.Add(CurrencyId.getName(logDef.CurrencyId), logDef.BaseAmount.ToString() + "," + logDef.OtherAmount);
            else
            {
                baseAmt = decimal.Parse(reverseMockShopSummary[currencyCode].ToString().Split(',')[0]);
                otherAmt = decimal.Parse(reverseMockShopSummary[currencyCode].ToString().Split(',')[1]);
                reverseMockShopSummary[currencyCode] = (baseAmt + logDef.BaseAmount).ToString() + "," + (otherAmt + logDef.OtherAmount).ToString();
            }
        }
        */

        private void addActualUTContractDNToSAFList(SunInterfaceLogDef logDef, ArrayList safList)
        {
            UTContractDCNoteDef dnDef = this.getUTContractDCNoteByKey(int.Parse(logDef.ReferenceNo));
            ArrayList shipmentList = this.getUTContractShipmentList(int.Parse(logDef.ReferenceNo));

            ARInvoiceInterfaceEntry entry = new ARInvoiceInterfaceEntry();

            foreach (UTContractDCNoteShipmentDef dcNoteShipmentDef in shipmentList)
            {
                ShipmentDef shipmentDef = OrderSelectWorker.Instance.getShipmentByKey(dcNoteShipmentDef.ShipmentId);
                ContractDef contractDef = OrderSelectWorker.Instance.getContractByKey(shipmentDef.ContractId);
                InvoiceDef invoiceDef = ShippingWorker.Instance.getInvoiceByKey(shipmentDef.ShipmentId);

                entry = new ARInvoiceInterfaceEntry();
                entry.CustomerId = "NAR021";
                entry.COA = "2503020";
                entry.GroupId = EpicorInterfaceWorker.Instance.ARInvoiceInterfaceFile.getSourceString();
                entry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                entry.ApplyDate = entry.GroupApplyDate;
                if (isEnableWeek53Handling(logDef, false))
                {
                    entry.GroupApplyDate = WK53_APPLY_DATE;
                    entry.ApplyDate = WK53_APPLY_DATE;
                }

                entry.DocumentType = ARInvoiceDocumentTypeEnum.ISAM_SALES;
                entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
                entry.Office = getT0Code(logDef);
                logDef.ProductTeamId = contractDef.ProductTeam.ProductCodeId;
                entry.SegmentValue3 = getT1Code(logDef);
                entry.SegmentValue4 = generalWorker.getProductCodeDefByKey(contractDef.ProductTeam.ProductCodeId).Code;
                entry.SegmentValue5 = getSeasonSegmentValue(contractDef.Season.SeasonId);
                entry.LineDescription = "UT COMM AND SERVICE CHARGE INCOME FOR P" + logDef.Period.ToString() + " " + contractDef.ContractNo + "-" + shipmentDef.DeliveryNo.ToString();
                entry.Currency = CurrencyId.getCommonName(logDef.CurrencyId);
                entry.UnitCost = dcNoteShipmentDef.SupplierCommission;
                entry.Amount = dnDef.TotalSupplierCommission;
                entry.Qty = shipmentDef.TotalShippedQuantity * contractDef.PiecesPerPack;
                entry.ItemNo = ProductWorker.Instance.getProductByKey(contractDef.ProductId).ItemNo;
                entry.RealInvoiceNo = dnDef.DCNoteNo;
                entry.InvoiceDate = logDef.TransactionDate;
                entry.InvoiceNo = dnDef.DCNoteNo;
                entry.LegalNumber = dnDef.DCNoteNo;
                logDef.InvoicePrefix = invoiceDef.InvoicePrefix;
                logDef.InvoiceSequence = invoiceDef.InvoiceSeqNo;
                logDef.InvoiceYear = invoiceDef.InvoiceYear;
                logDef.SequenceNo = invoiceDef.SequenceNo;
                entry.LineOriginalInvoiceNo = getT9Code(logDef);
                //entry.LineOriginalInvoiceNo = "[InvoiceNo]";
                entry.IsRecordComplete = false;

                EpicorInterfaceWorker.Instance.ARInvoiceInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);
            }
        }

        private void addActualNSLedSalesToSAFList(SunInterfaceLogDef logDef, ArrayList safList)
        {
            decimal roundedTotalAmt = 0m;
            decimal maxValue = 0m;
            decimal minValue = 0m;
            decimal diff = 0m;

            NSLedImportFileDef fileDef = getNSLedImportFileByKey(int.Parse(logDef.ReferenceNo));
            List<NSLedSalesDef> salesList = getNSLedSalesDetail(fileDef.FileId);
            List<NSLedItemSummaryDef> list = (from s in salesList
                                              group s by new
                                              {
                                                  s.ItemNo
                                              } into itm
                                              select new NSLedItemSummaryDef
                                              {
                                                  ItemNo = itm.First().ItemNo,
                                                  NetAmt = itm.Sum((NSLedSalesDef c) => c.NetAmt),
                                                  NetQty = itm.Sum((NSLedSalesDef c) => c.NetQty),
                                                  NSCommAmtInUSD = itm.Sum((NSLedSalesDef c) => c.NSCommAmtInUSD),
                                                  NSCommAmt = itm.Sum((NSLedSalesDef c) => c.NSCommAmt)
                                              }).ToList();
            foreach (NSLedItemSummaryDef item in list)
            {
                decimal commAmt = (fileDef.CurrencyId == CurrencyId.USD.Id) ? item.NSCommAmtInUSD : item.NSCommAmt;
                roundedTotalAmt += commAmt;
                if (fileDef.TotalNSCommissionAmt > 0m && commAmt > maxValue)
                {
                    maxValue = commAmt;
                }
                else if (fileDef.TotalNSCommissionAmt < 0m && commAmt < minValue)
                {
                    minValue = commAmt;
                }
            }
            diff = ((!(fileDef.TotalNSCommissionAmt > 0m)) ? (fileDef.TotalNSCommissionAmt - roundedTotalAmt) : (fileDef.TotalNSCommissionAmt - roundedTotalAmt));


            ARInvoiceInterfaceEntry entry = null;
            GLInterfaceEntry glEntry = new GLInterfaceEntry();

            foreach (NSLedItemSummaryDef summaryDef in list)
            {
                decimal lineCommAmt = (fileDef.CurrencyId == CurrencyId.USD.Id) ? summaryDef.NSCommAmtInUSD : summaryDef.NSCommAmt;
                if (summaryDef.NetQty != 0 || lineCommAmt != 0m)
                {
                    int seasonId = this.getNSLedRangePlanSeasonIdByFiscalWeek(logDef.OfficeId, summaryDef.ItemNo, fileDef.FiscalYear, fileDef.FiscalWeek);

                    NSLedRangePlanDef rangePlanDef = this.getNSLedRangePlan(logDef.OfficeId, summaryDef.ItemNo, seasonId);
                    ShipmentDef shipmentDef = OrderSelectWorker.Instance.getShipmentByKey(rangePlanDef.FirstShipmentId);
                    ContractDef contractDef = OrderSelectWorker.Instance.getContractByKey(shipmentDef.ContractId);

                    SunInterfaceLogDef historyLog = this.getLatestLogByShipmentId(SunInterfaceTypeRef.Id.Purchase.GetHashCode(), rangePlanDef.FirstShipmentId, 0);
                    if (historyLog == null && contractDef.SetSplitCount > 1)
                    {
                        foreach (SplitShipmentDef splitShipment in OrderSelectWorker.Instance.getSplitShipmentByShipmentId(rangePlanDef.FirstShipmentId))
                        {
                            if (splitShipment.IsVirtualSetSplit == 0)
                            {
                                historyLog = this.getLatestLogByShipmentId(SunInterfaceTypeRef.Id.Purchase.GetHashCode(), rangePlanDef.FirstShipmentId, splitShipment.SplitShipmentId);
                                break;
                            }

                        }

                    }

                    if (historyLog == null)
                        throw new ApplicationException("NS-Led Sales Interface: COGS Interface has not been generated (item) : " + summaryDef.ItemNo);

                    /*
                    ContractDef contractDef = OrderSelectWorker.Instance.getContractByItemNoAndCustomerId(summaryDef.ItemNo, CustomerDef.Id.ns_led.GetHashCode(), 0, 1);
                    if (contractDef == null)
                    {
                        contractDef = OrderSelectWorker.Instance.getContractByItemNoAndCustomerId(summaryDef.ItemNo, CustomerDef.Id.manu_led.GetHashCode(), 0, 1);
                    }
                    ArrayList arrayList = (ArrayList)OrderSelectWorker.Instance.getShipmentByContractId(contractDef.ContractId);
                    ShipmentDef shipmentDef = null;
                    foreach (ShipmentDef sd in arrayList)
                    {
                        if (sd.WorkflowStatus == ContractWFS.INVOICED)
                        {
                            shipmentDef = sd;
                            break;
                        }
                    }
                    */

                    if (!fileDef.IsDutiable)
                    {
                        entry = new ARInvoiceInterfaceEntry();
                        entry.CustomerId = "NAR001";
                        entry.COA = "2201040";
                        entry.GroupId = EpicorInterfaceWorker.Instance.ARInvoiceInterfaceFile.getSourceString();
                        entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
                        entry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                        entry.ApplyDate = entry.GroupApplyDate;
                        if (isEnableWeek53Handling(logDef, isReversal: false))
                        {
                            entry.GroupApplyDate = WK53_APPLY_DATE;
                            entry.ApplyDate = WK53_APPLY_DATE;
                        }
                        entry.DocumentType = ((fileDef.TotalNSCommissionAmt < 0m) ? ARInvoiceDocumentTypeEnum.MANUAL_CN : ARInvoiceDocumentTypeEnum.ISAM_SALES);
                        entry.IsCreditNote = ((fileDef.TotalNSCommissionAmt < 0m) ? true : false);
                        entry.Currency = CurrencyId.getCommonName(logDef.CurrencyId);
                        entry.Amount = Math.Abs(fileDef.TotalNSCommissionAmt);

                        if (lineCommAmt == 0)
                        {
                            entry.UnitCost = 0.01m;
                            diff = 0m;
                        }
                        else if (fileDef.TotalNSCommissionAmt > 0m && maxValue == lineCommAmt)
                        {
                            entry.UnitCost = lineCommAmt + diff;
                            diff = 0m;
                        }
                        else if (fileDef.TotalNSCommissionAmt < 0m && minValue == lineCommAmt)
                        {
                            entry.UnitCost = Math.Abs(lineCommAmt) - diff;
                            diff = 0m;
                        }
                        else
                        {
                            entry.UnitCost = Math.Abs(lineCommAmt) * (decimal)(((!entry.IsCreditNote || !(lineCommAmt > 0m)) && (entry.IsCreditNote || !(lineCommAmt < 0m))) ? 1 : (-1));
                        }
                        entry.Office = getT0Code(logDef);
                        if (logDef.OfficeId == OfficeId.SH.Id)
                        {
                            entry.Office = "SHMY";
                        }
                        else if (logDef.OfficeId == OfficeId.HK.Id)
                        {
                            entry.Office = "HKMY";
                        }
                        logDef.ProductTeamId = contractDef.ProductTeam.ProductCodeId;
                        entry.SegmentValue3 = getT1Code(logDef);
                        entry.SegmentValue4 = generalWorker.getProductCodeDefByKey(contractDef.ProductTeam.ProductCodeId).Code;
                        entry.SegmentValue5 = getSeasonSegmentValue(contractDef.Season.SeasonId);
                        PeriodWeekInfoDef fiscalWeekByDate = generalWorker.getFiscalWeekByDate(fileDef.InvoiceDate);
                        entry.LineDescription = contractDef.ContractNo + "-" + shipmentDef.DeliveryNo.ToString() + " #" + summaryDef.ItemNo + " " + fileDef.FiscalYear.ToString() + " Week " + fileDef.FiscalWeek.ToString() + " NON-DUTY";
                        entry.Qty = summaryDef.NetQty;
                        entry.ItemNo = ProductWorker.Instance.getProductByKey(contractDef.ProductId).ItemNo;
                        entry.InvoiceDate = logDef.TransactionDate;
                        entry.RealInvoiceNo = fileDef.InvoiceNo;
                        entry.ExchangeRate = 1m;
                        int invCnt = 0;
                        List<NSLedImportFileDef> nSLedImportFileList = getNSLedImportFileList(logDef.OfficeId, fileDef.FiscalYear, fileDef.FiscalWeek);
                        foreach (NSLedImportFileDef item3 in nSLedImportFileList)
                        {
                            invCnt++;
                            if (item3.InvoiceNo == fileDef.InvoiceNo)
                            {
                                break;
                            }
                        }
                        entry.InvoiceNo = OfficeId.getName(logDef.OfficeId) + "L" + logDef.FiscalYear.ToString() + logDef.Period.ToString().PadLeft(2, '0') + fileDef.FiscalWeek.ToString().PadLeft(2, '0') + invCnt.ToString() + (entry.IsCreditNote ? "CN" : string.Empty);
                        entry.LegalNumber = fileDef.InvoiceNo;
                        entry.IsRecordComplete = false;
                        EpicorInterfaceWorker.Instance.ARInvoiceInterfaceFile.Entries.Add(entry);
                    }
                    else // dutiable
                    {
                        glEntry = new GLInterfaceEntry();
                        glEntry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
                        glEntry.GroupId = EpicorInterfaceWorker.Instance.GLInterfaceFile.getSourceString();
                        glEntry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                        glEntry.ApplyDate = glEntry.GroupApplyDate;

                        if (isEnableWeek53Handling(logDef, false))
                        {
                            glEntry.GroupApplyDate = WK53_APPLY_DATE;
                            glEntry.ApplyDate = WK53_APPLY_DATE;
                        }

                        glEntry.DocumentType = GLDocumentTypeEnum.GL;
                        glEntry.CurrencyCode = CurrencyId.getCommonName(logDef.CurrencyId);
                        glEntry.DC = ((lineCommAmt >= 0m) ? DCFlag.Debit : DCFlag.Credit);
                        glEntry.Qty = summaryDef.NetQty;
                        if (lineCommAmt == 0)
                            glEntry.Amount = 0.01m;
                        else
                            glEntry.Amount = Math.Abs(lineCommAmt);

                        glEntry.BaseAmount = Math.Round(glEntry.Amount
                                                        * commonWorker.getExchangeRate(ExchangeRateType.INVOICE, logDef.CurrencyId, glEntry.ApplyDate)
                                                        / commonWorker.getExchangeRate(ExchangeRateType.INVOICE, CurrencyId.USD.Id, glEntry.ApplyDate)
                                            , 2, MidpointRounding.AwayFromZero);

                        glEntry.LineDescription = summaryDef.ItemNo + "#" + contractDef.ContractNo + "-" + shipmentDef.DeliveryNo.ToString() + " " + fileDef.FiscalYear.ToString() + " Week " + fileDef.FiscalWeek.ToString() + " DUTY";
                        glEntry.Office = getT0Code(logDef);
                        glEntry.COA = "1450070";
                        logDef.ProductTeamId = contractDef.ProductTeam.ProductCodeId;
                        glEntry.SegmentValue3 = getT1Code(logDef);
                        glEntry.SegmentValue4 = generalWorker.getProductCodeDefByKey(contractDef.ProductTeam.ProductCodeId).Code;
                        glEntry.SegmentValue5 = getSeasonSegmentValue(contractDef.Season.SeasonId);
                        glEntry.IsRecordComplete = false;
                        EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                        glEntry = (GLInterfaceEntry)glEntry.Clone();
                        glEntry.DC = ((lineCommAmt >= 0m) ? DCFlag.Credit : DCFlag.Debit);
                        glEntry.COA = "2201040";
                        glEntry.IsRecordComplete = true;
                        EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                        // import duty
                        glEntry = (GLInterfaceEntry)glEntry.Clone();
                        glEntry.DC = ((summaryDef.NetQty >= 0) ? DCFlag.Debit : DCFlag.Credit);
                        glEntry.COA = "3202057";

                        if (rangePlanDef.DutyPercent == 0 && logDef.OfficeId == OfficeId.SL.Id && (summaryDef.ItemNo == "751329" || summaryDef.ItemNo == "M05393" || summaryDef.ItemNo == "M05394" || summaryDef.ItemNo == "165879" || summaryDef.ItemNo == "713111" || summaryDef.ItemNo == "M06398" || summaryDef.ItemNo == "859316" ||
                            summaryDef.ItemNo == "M06399" || summaryDef.ItemNo == "M06400" || summaryDef.ItemNo == "M06650" || summaryDef.ItemNo == "M06403" || summaryDef.ItemNo == "M05387" || summaryDef.ItemNo == "M05390" || summaryDef.ItemNo == "711648" ||
                            summaryDef.ItemNo == "M05389" || summaryDef.ItemNo == "795863" || summaryDef.ItemNo == "479332" || summaryDef.ItemNo == "954625" || summaryDef.ItemNo == "480008" || summaryDef.ItemNo == "135913" || summaryDef.ItemNo == "366923" ||
                            summaryDef.ItemNo == "954378" || summaryDef.ItemNo == "366890" || summaryDef.ItemNo == "376178" || summaryDef.ItemNo == "862247" || summaryDef.ItemNo == "546562" || summaryDef.ItemNo == "444094" || summaryDef.ItemNo == "479932"))

                            rangePlanDef.DutyPercent = 12.0m;

                        glEntry.Amount = Math.Round(rangePlanDef.DutyPercent / 100.0m * rangePlanDef.TotalFOBCost / rangePlanDef.TotalQty * summaryDef.NetQty, 2, MidpointRounding.AwayFromZero);
                        glEntry.BaseAmount = Math.Round(glEntry.Amount
                                                        * commonWorker.getExchangeRate(ExchangeRateType.INVOICE, logDef.CurrencyId, glEntry.ApplyDate)
                                                        / commonWorker.getExchangeRate(ExchangeRateType.INVOICE, CurrencyId.USD.Id, glEntry.ApplyDate)
                                            , 2, MidpointRounding.AwayFromZero);

                        glEntry.IsRecordComplete = false;
                        EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                        glEntry = (GLInterfaceEntry)glEntry.Clone();
                        glEntry.DC = ((summaryDef.NetQty >= 0) ? DCFlag.Credit : DCFlag.Debit);
                        glEntry.COA = "1210013";
                        glEntry.IsRecordComplete = true;
                        EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);
                    }


                    if (summaryDef.NetQty != 0)
                    {
                        AccountFinancialCalenderDef calDef = GeneralWorker.Instance.getAccountPeriodByYearPeriod(AppId.NSS.Code, historyLog.FiscalYear, historyLog.Period);

                        glEntry = new GLInterfaceEntry();
                        glEntry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
                        glEntry.GroupId = EpicorInterfaceWorker.Instance.GLInterfaceFile.getSourceString();
                        glEntry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                        glEntry.ApplyDate = glEntry.GroupApplyDate;

                        if (isEnableWeek53Handling(logDef, false))
                        {
                            glEntry.GroupApplyDate = WK53_APPLY_DATE;
                            glEntry.ApplyDate = WK53_APPLY_DATE;
                        }

                        glEntry.DocumentType = GLDocumentTypeEnum.GL;
                        glEntry.CurrencyCode = CurrencyId.getCommonName(rangePlanDef.SupplierCurrencyId);
                        glEntry.DC = ((summaryDef.NetQty >= 0) ? DCFlag.Debit : DCFlag.Credit);
                        glEntry.Qty = summaryDef.NetQty;
                        glEntry.Amount = Math.Round(rangePlanDef.TotalFOBCost / rangePlanDef.TotalQty * summaryDef.NetQty, 2, MidpointRounding.AwayFromZero);
                        glEntry.BaseAmount = Math.Round(glEntry.Amount
                                                        * commonWorker.getExchangeRate(ExchangeRateType.INVOICE, rangePlanDef.SupplierCurrencyId, calDef.EndDate)
                                                        / commonWorker.getExchangeRate(ExchangeRateType.INVOICE, CurrencyId.USD.Id, calDef.EndDate)
                                            , 2, MidpointRounding.AwayFromZero);

                        glEntry.LineDescription = summaryDef.ItemNo + "#" + contractDef.ContractNo + "-" + shipmentDef.DeliveryNo.ToString() + " " + fileDef.FiscalYear.ToString() + " Week " + fileDef.FiscalWeek.ToString() + " " + (fileDef.IsDutiable ? "DUTY" : "NON-DUTY");
                        if (!fileDef.IsDutiable)
                            glEntry.Office = entry.Office;
                        else
                            glEntry.Office = getT0Code(logDef);
                        glEntry.COA = "3201012";
                        glEntry.SegmentValue3 = getT1Code(logDef);
                        glEntry.SegmentValue4 = generalWorker.getProductCodeDefByKey(contractDef.ProductTeam.ProductCodeId).Code;
                        glEntry.SegmentValue5 = getSeasonSegmentValue(contractDef.Season.SeasonId);
                        glEntry.IsRecordComplete = false;
                        EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                        glEntry = (GLInterfaceEntry)glEntry.Clone();
                        glEntry.DC = ((summaryDef.NetQty >= 0) ? DCFlag.Credit : DCFlag.Debit);
                        glEntry.COA = "1210011";
                        glEntry.IsRecordComplete = true;
                        EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);


                        glEntry = (GLInterfaceEntry)glEntry.Clone();
                        glEntry.DC = ((summaryDef.NetQty >= 0) ? DCFlag.Debit : DCFlag.Credit);

                        if (logDef.OfficeId == OfficeId.SH.Id || logDef.OfficeId == OfficeId.TH.Id || logDef.OfficeId == OfficeId.HK.Id || logDef.OfficeId == OfficeId.DG.Id || logDef.OfficeId == OfficeId.VN.Id || logDef.OfficeId == OfficeId.CA.Id)
                            glEntry.COA = "1452044";
                        else if (logDef.OfficeId == OfficeId.BD.Id || logDef.OfficeId == OfficeId.IND.Id || logDef.OfficeId == OfficeId.ND.Id || logDef.OfficeId == OfficeId.PK.Id || logDef.OfficeId == OfficeId.TR.Id || logDef.OfficeId == OfficeId.EG.Id)
                            glEntry.COA = "1452039";
                        else if (logDef.OfficeId == OfficeId.SL.Id && (summaryDef.ItemNo == "307716" || summaryDef.ItemNo == "537016" || summaryDef.ItemNo == "635535"))  // requested by vincent / winnie on 2021-09-02 
                            glEntry.COA = "1452043";
                        else if (logDef.OfficeId == OfficeId.SL.Id && (rangePlanDef.CountryOfOriginId == CountryOfOriginRef.eCountryId.India.GetHashCode() || rangePlanDef.CountryOfOriginId == CountryOfOriginRef.eCountryId.Pakistan.GetHashCode()))
                            glEntry.COA = "1452039";
                        else if (logDef.OfficeId == OfficeId.SL.Id)
                            glEntry.COA = "1452043";
                        else
                            glEntry.COA = string.Empty;

                        if (logDef.OfficeId != OfficeId.SL.Id || historyLog.SeasonId < 38 || (logDef.OfficeId == OfficeId.SL.Id && rangePlanDef.CountryOfOriginId == CountryOfOriginRef.eCountryId.Pakistan.GetHashCode())) // SS20
                        {
                            decimal discountPerc = 3.0m;
                            if (historyLog.QACommissionPercent > 0) discountPerc = historyLog.QACommissionPercent;
                            if (historyLog.VendorPaymentDiscountPercent > 0) discountPerc = historyLog.QACommissionPercent;

                            glEntry.Amount = Math.Round(rangePlanDef.TotalFOBCost * ((discountPerc == 0 ? 3.0m : discountPerc) / 100) / rangePlanDef.TotalQty * summaryDef.NetQty, 2, MidpointRounding.AwayFromZero);
                        }
                        else
                        {
                            decimal lt = historyLog.LabTestIncome;
                            if (shipmentDef.Vendor.VendorId == 3154 && lt == 0) // NML , requested by winnie @2021-04-27
                                lt = 0.03m;
                            glEntry.Amount = Math.Round(summaryDef.NetQty * lt, 2, MidpointRounding.AwayFromZero);
                        }
                        glEntry.BaseAmount = Math.Round(glEntry.Amount
                                                        * commonWorker.getExchangeRate(ExchangeRateType.INVOICE, rangePlanDef.SupplierCurrencyId, calDef.EndDate)
                                                        / commonWorker.getExchangeRate(ExchangeRateType.INVOICE, CurrencyId.USD.Id, calDef.EndDate)
                                            , 2, MidpointRounding.AwayFromZero);

                        glEntry.IsRecordComplete = false;
                        EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                        glEntry = (GLInterfaceEntry)glEntry.Clone();
                        glEntry.DC = ((summaryDef.NetQty >= 0) ? DCFlag.Credit : DCFlag.Debit);
                        if (glEntry.COA == "1452044") // QA
                            glEntry.COA = "2511013";
                        else if (glEntry.COA == "1452039")  // discount
                            glEntry.COA = "2515030";
                        else if (glEntry.COA == "1452043")  // lt
                            glEntry.COA = "2510030";
                        else
                            glEntry.COA = "N/A";

                        glEntry.IsRecordComplete = true;
                        EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                        glEntry = (GLInterfaceEntry)glEntry.Clone();
                        glEntry.DC = ((summaryDef.NetQty >= 0) ? DCFlag.Debit : DCFlag.Credit);
                        glEntry.COA = "3202056";
                        glEntry.CurrencyCode = CurrencyId.getCommonName(CurrencyId.USD.Id);
                        glEntry.Amount = Math.Round(rangePlanDef.ActualFreightUnitCostUSD * summaryDef.NetQty, 2, MidpointRounding.AwayFromZero);
                        glEntry.BaseAmount = glEntry.Amount;
                        glEntry.IsRecordComplete = false;
                        EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                        glEntry = (GLInterfaceEntry)glEntry.Clone();
                        glEntry.DC = ((summaryDef.NetQty >= 0) ? DCFlag.Credit : DCFlag.Debit);
                        glEntry.COA = "1210012";
                        glEntry.IsRecordComplete = true;
                        EpicorInterfaceWorker.Instance.GLInterfaceFile.Entries.Add((IEpicorInterfaceEntry)glEntry);

                    }

                }
            }
        }

        public List<NSLedImportFileDef> getNSLedImportFileList(int officeId, int fiscalYear, int fiscalWeek)
        {
            List<NSLedImportFileDef> list = new List<NSLedImportFileDef>();
            TransactionContext context = TransactionContextFactory.GetContext(TransactionAffinity.Required);
            try
            {
                context.Enter();
                TransactionContext currentContext = TransactionContextFactory.GetCurrentContext();
                IDataSetAdapter dataSetAdapter = getDataSetAdapter("NSLedImportFileApt", "GetNSLedImportFileList");
                dataSetAdapter.SelectCommand.Parameters["@OfficeId"].Value = officeId;
                dataSetAdapter.SelectCommand.Parameters["@FiscalYear"].Value = fiscalYear;
                dataSetAdapter.SelectCommand.Parameters["@FiscalWeek"].Value = fiscalWeek;
                NSLedImportFileDs dataSet = new NSLedImportFileDs();
                int num = dataSetAdapter.Fill(dataSet);
                foreach (NSLedImportFileDs.NSLedImportFileRow row in dataSet.NSLedImportFile.Rows)
                {
                    NSLedImportFileDef def = new NSLedImportFileDef();
                    NSLedImportFileMapping(row, def);
                    list.Add(def);
                }
                context.VoteCommit();
                return list;
            }
            catch (Exception ex)
            {
                Console.WriteLine("ERROR " + ex.Message);
                context.VoteRollback();
                throw ex;
            }
            finally
            {
                context.Exit();
            }
        }

        public List<NSLedRepeatItemParamDef> getNSLedRepeatItemParamRange(string itemNo, int seasonId)
        {
            List<NSLedRepeatItemParamDef> list = new List<NSLedRepeatItemParamDef>();
            TransactionContext context = TransactionContextFactory.GetContext(TransactionAffinity.Required);
            try
            {
                context.Enter();
                TransactionContext currentContext = TransactionContextFactory.GetCurrentContext();
                IDataSetAdapter dataSetAdapter = getDataSetAdapter("NSLedRepeatItemParamApt", "GetNSLedRepeatItemParamRange");
                dataSetAdapter.SelectCommand.Parameters["@ItemNo"].Value = itemNo;
                dataSetAdapter.SelectCommand.Parameters["@SeasonId"].Value = seasonId;

                NSLedRepeatItemParamDs dataSet = new NSLedRepeatItemParamDs();
                int cnt = dataSetAdapter.Fill(dataSet);

                foreach (NSLedRepeatItemParamDs.NSLedRepeatItemParamRow row in dataSet.NSLedRepeatItemParam.Rows)
                {
                    NSLedRepeatItemParamDef def = new NSLedRepeatItemParamDef();
                    def.ItemNo = row.ItemNo;
                    def.DeliveryDate = row.DeliveryDate;
                    def.SeasonId = row.SeasonId;
                    def.FiscalYear = row.FiscalYear;
                    def.FiscalWeek = row.FiscalWeek;
                    list.Add(def);
                }
                context.VoteCommit();
                return list;
            }
            catch (Exception ex)
            {
                Console.WriteLine("ERROR " + ex.Message);
                context.VoteRollback();
                throw ex;
            }
            finally
            {
                context.Exit();
            }
        }

        private void addActualAdvancePaymentToSAFList(SunInterfaceLogDef logDef, ArrayList safList)
        {
            AdvancePaymentDef paymentDef = advancePaymentWorker.getAdvancePaymentByKey(int.Parse(logDef.ReferenceNo));
            List<AdvancePaymentOrderDetailDef> orderDetailList = new List<AdvancePaymentOrderDetailDef>();
            List<AdvancePaymentInstalmentDetailDef> instalmentDetailList = new List<AdvancePaymentInstalmentDetailDef>();
            APInvoiceInterfaceEntry entry = new APInvoiceInterfaceEntry();
            int i = 1;

            if (paymentDef.PaymentTypeId == PaymentType.FABRIC.Id)
            {
                orderDetailList = advancePaymentWorker.getAdvancePaymentOrderDetailList(int.Parse(logDef.ReferenceNo));

                foreach (AdvancePaymentOrderDetailDef orderDetailDef in orderDetailList)
                {
                    ShipmentDef shipmentDef = OrderSelectWorker.Instance.getShipmentByKey(orderDetailDef.ShipmentId);
                    ContractDef contractDef = OrderSelectWorker.Instance.getContractByKey(shipmentDef.ContractId);
                    InvoiceDef invoiceDef = ShippingWorker.Instance.getInvoiceByKey(shipmentDef.ShipmentId);

                    if (i == 1)
                    {
                        entry = new APInvoiceInterfaceEntry();
                        entry.SupplierId = paymentDef.Vendor.EpicorSupplierId;
                        entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
                        entry.Office = getT0Code(logDef);
                        entry.COA = "1226012";
                        entry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                        entry.ApplyDate = entry.GroupApplyDate;
                        if (isEnableWeek53Handling(logDef, false))
                        {
                            entry.GroupApplyDate = WK53_APPLY_DATE;
                            entry.ApplyDate = WK53_APPLY_DATE;
                        }
                        entry.DocumentType = APInvoiceDocumentTypeEnum.ADVPAYINV;
                        entry.GroupId = EpicorInterfaceWorker.Instance.APInvoiceInterfaceFile.getSourceString();
                        entry.LineDescription = paymentDef.PaymentNo + " " + paymentDef.Currency.CurrencyCode + logDef.OtherAmount.ToString("#,##0.00");
                        entry.Currency = paymentDef.Currency.CurrencyCode;
                        entry.UnitCost = logDef.OtherAmount;
                        entry.Amount = logDef.OtherAmount - paymentDef.InterestChargedAmt;
                        entry.ItemNo = string.Empty;
                        entry.PaymentTerm = "IN14";
                        entry.InvoiceNo = paymentDef.PaymentNo + " " + entry.Amount.ToString();
                        entry.RealInvoiceNo = entry.InvoiceNo;
                        entry.LegalNumber = paymentDef.PaymentNo;
                        entry.InvoiceDate = paymentDef.PaymentDate;
                        EpicorInterfaceWorker.Instance.APInvoiceInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);

                        if (paymentDef.InterestChargedAmt != 0)
                        {
                            entry = (APInvoiceInterfaceEntry)entry.Clone();
                            entry.UnitCost = paymentDef.InterestChargedAmt * -1;
                            entry.COA = "2517020";
                            entry.SegmentValue3 = "231";
                            entry.SegmentValue4 = "OTHERS";
                            EpicorInterfaceWorker.Instance.APInvoiceInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);
                        }
                    }

                    entry = (APInvoiceInterfaceEntry)entry.Clone();
                    entry.InvoiceNo = contractDef.ContractNo + "-" + shipmentDef.DeliveryNo.ToString() + " " + paymentDef.PaymentNo;
                    entry.RealInvoiceNo = entry.InvoiceNo;
                    entry.IsDebitNote = true;
                    entry.DocumentType = APInvoiceDocumentTypeEnum.ADVPAYMENT;
                    entry.COA = "1226012";
                    entry.LegalNumber = paymentDef.PaymentNo + "-" + i.ToString();
                    entry.UnitCost = orderDetailDef.ExpectedValue;
                    entry.Amount = orderDetailDef.ExpectedValue;
                    entry.InvoiceDate = paymentDef.PaymentDate;
                    entry.SegmentValue3 = string.Empty;
                    entry.SegmentValue4 = string.Empty;
                    EpicorInterfaceWorker.Instance.APInvoiceInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);
                    i += 1;

                }

            }
            else if (paymentDef.PaymentTypeId == PaymentType.INSTALMENT.Id)
            {
                instalmentDetailList = advancePaymentWorker.getAdvancePaymentInstalmentDetailList(int.Parse(logDef.ReferenceNo));
                foreach (AdvancePaymentInstalmentDetailDef instalmentDetailDef in instalmentDetailList)
                {
                    if (i == 1)
                    {
                        entry = new APInvoiceInterfaceEntry();
                        entry.SupplierId = paymentDef.Vendor.EpicorSupplierId;
                        entry.Company = generalWorker.getCompanyOfficeMappingByCriteria(CompanyType.NEXT_SOURCING.Id, logDef.OfficeId).EpicorCompanyId;
                        entry.Office = getT0Code(logDef);
                        entry.COA = "1226012";
                        entry.GroupApplyDate = generalWorker.getAccountPeriodByYearPeriod(AppId.ISAM.Code, logDef.FiscalYear, logDef.Period).EndDate;
                        entry.ApplyDate = entry.GroupApplyDate;
                        if (isEnableWeek53Handling(logDef, false))
                        {
                            entry.GroupApplyDate = WK53_APPLY_DATE;
                            entry.ApplyDate = WK53_APPLY_DATE;
                        }
                        entry.DocumentType = APInvoiceDocumentTypeEnum.ADVPAYINV;
                        entry.GroupId = EpicorInterfaceWorker.Instance.APInvoiceInterfaceFile.getSourceString();
                        entry.LineDescription = paymentDef.PaymentNo + " " + paymentDef.Currency.CurrencyCode + logDef.OtherAmount.ToString("#,##0.00");
                        entry.Currency = paymentDef.Currency.CurrencyCode;
                        entry.UnitCost = logDef.OtherAmount;
                        entry.Amount = logDef.OtherAmount - paymentDef.InterestChargedAmt;
                        entry.ItemNo = string.Empty;
                        entry.PaymentTerm = "IN14";
                        entry.InvoiceNo = paymentDef.PaymentNo + " " + entry.Amount.ToString();
                        entry.RealInvoiceNo = entry.InvoiceNo;
                        entry.LegalNumber = paymentDef.PaymentNo;
                        entry.InvoiceDate = paymentDef.PaymentDate;
                        EpicorInterfaceWorker.Instance.APInvoiceInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);

                        if (paymentDef.InterestChargedAmt != 0)
                        {
                            entry = (APInvoiceInterfaceEntry)entry.Clone();
                            entry.UnitCost = paymentDef.InterestChargedAmt * -1;
                            entry.COA = "2517020";
                            entry.SegmentValue3 = "231";
                            entry.SegmentValue4 = "OTHERS";
                            EpicorInterfaceWorker.Instance.APInvoiceInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);
                        }

                    }

                    entry = (APInvoiceInterfaceEntry)entry.Clone();
                    entry.InvoiceNo = instalmentDetailDef.PaymentDate.ToString("yyyyMMdd") + " " + paymentDef.PaymentNo;
                    entry.RealInvoiceNo = entry.InvoiceNo;
                    entry.LegalNumber = paymentDef.PaymentNo + "-" + i.ToString();
                    entry.COA = "1226012";
                    entry.IsDebitNote = true;
                    entry.DocumentType = APInvoiceDocumentTypeEnum.ADVPAYMENT;
                    entry.UnitCost = instalmentDetailDef.PaymentAmount;
                    entry.Amount = instalmentDetailDef.PaymentAmount;
                    entry.InvoiceDate = paymentDef.PaymentDate;
                    EpicorInterfaceWorker.Instance.APInvoiceInterfaceFile.Entries.Add((IEpicorInterfaceEntry)entry);
                    i += 1;
                }

            }
        }


        public ArrayList convertToSAFList(ArrayList logList, int sunInterfaceTypeId, int categoryId, int officeGroupId)
        {
            TransactionContext ctx = null;
            /*
            if (officeId == OfficeId.DG.Id)
                officeId = 1;
            else if (officeId == OfficeId.EG.Id)
                officeId = 9;
            else if (officeId == OfficeId.VN.Id)
                officeId = 4;
            */

            if (sunInterfaceTypeId == SunInterfaceTypeRef.Id.MockShop.GetHashCode() || sunInterfaceTypeId == SunInterfaceTypeRef.Id.StudioSample.GetHashCode() || sunInterfaceTypeId == SunInterfaceTypeRef.Id.APAdjustment.GetHashCode())
                ctx = TransactionContextFactory.GetContext(TransactionAffinity.Supported);
            else
                ctx = TransactionContextFactory.GetContext(TransactionAffinity.Supported);
            try
            {
                ctx.Enter();
                TransactionContext currentCtx = TransactionContextFactory.GetCurrentContext();

                ArrayList safList = new ArrayList();
                SunInterfaceLogDef historyLogDef = null;
                SunInterfaceLogDef lastLogDef = null;

                this.resetSummaryVariables();

                if (sunInterfaceTypeId == SunInterfaceTypeRef.Id.AccountReceivable.GetHashCode())
                    this.createActualARSummary(logList, safList);
                else if (sunInterfaceTypeId == SunInterfaceTypeRef.Id.AccountPayable.GetHashCode())
                    this.createActualAPSummary(logList, safList);
                else if (sunInterfaceTypeId == SunInterfaceTypeRef.Id.NonTradeBankPayment.GetHashCode())
                    this.createActualNonTradeBankPaymentSummary(logList, safList);
                else if (sunInterfaceTypeId == SunInterfaceTypeRef.Id.SalesCommissionSettlement.GetHashCode())
                    this.createActualSalesCommissionSettlementSummary(logList, safList);
                else if (sunInterfaceTypeId == SunInterfaceTypeRef.Id.ILSSalesDiscrepancy.GetHashCode())
                    this.createILSSalesDiscrepancySummary(logList, safList);
                else if (sunInterfaceTypeId == SunInterfaceTypeRef.Id.ILSSalesCommissionDiscrepancy.GetHashCode())
                    this.createILSSalesCommissionDiscrepancySummary(logList, safList);

                foreach (SunInterfaceLogDef logDef in logList)
                {
                    if (logDef.CategoryId == CategoryType.REVERSAL.Id)
                    {
                        historyLogDef = this.getReversalLogHistoryByShipmentId(sunInterfaceTypeId, logDef.ShipmentId, logDef.SplitShipmentId, logDef.SunInterfaceLogId);
                        /*
                        if (historyLogDef.OfficeId == OfficeId.DG.Id)
                            historyLogDef.OfficeId = 1;
                        else if (historyLogDef.OfficeId == OfficeId.EG.Id)
                            historyLogDef.OfficeId = 9;
                        else if (historyLogDef.OfficeId == OfficeId.VN.Id)
                            historyLogDef.OfficeId = 4;
                        */

                        if (historyLogDef.OfficeId == OfficeId.PK.Id) // 2019-01-29 Merging PK to LK
                            historyLogDef.OfficeId = OfficeId.SL.Id;

                        historyLogDef.FiscalYear = logDef.FiscalYear;
                        historyLogDef.Period = logDef.Period;
                    }

                    if (logDef.OfficeId == OfficeId.PK.Id) // 2019-01-29 Merging PK to LK
                        logDef.OfficeId = OfficeId.SL.Id;

                    if (sunInterfaceTypeId == SunInterfaceTypeRef.Id.Sales.GetHashCode() || sunInterfaceTypeId == SunInterfaceTypeRef.Id.MockShopSales.GetHashCode() || sunInterfaceTypeId == SunInterfaceTypeRef.Id.StudioSampleSales.GetHashCode())
                    {
                        if (categoryId == CategoryType.ACCRUAL.Id)
                            addAccrualSalesToSAFList(logDef, safList);
                        else
                        {
                            if (logDef.CategoryId == CategoryType.REVERSAL.Id)
                            {
                                InvoiceDef invoiceDef = ShippingWorker.Instance.getInvoiceByKey(logDef.ShipmentId);

                                addActualSalesToSAFList(historyLogDef, safList, true, (CustomerDef.isNextUK(logDef.CustomerId) && (logDef.IsSampleOrder || (!logDef.IsSampleOrder && invoiceDef.ARDate != DateTime.MinValue && this.isSunInterfaceLogExists(SunInterfaceTypeRef.Id.AccountReceivable.GetHashCode(), logDef.ShipmentId, logDef.SplitShipmentId)))) ? true : false);
                                addActualSalesToSAFList(logDef, safList, false, (CustomerDef.isNextUK(logDef.CustomerId) && (logDef.IsSampleOrder || (!logDef.IsSampleOrder && invoiceDef.ARDate != DateTime.MinValue && this.isSunInterfaceLogExists(SunInterfaceTypeRef.Id.AccountReceivable.GetHashCode(), logDef.ShipmentId, logDef.SplitShipmentId)))) ? true : false);
                            }
                            else
                            {
                                addActualSalesToSAFList(logDef, safList, false);
                            }
                        }
                    }
                    else if (sunInterfaceTypeId == SunInterfaceTypeRef.Id.Purchase.GetHashCode())
                    {
                        if (categoryId == CategoryType.ACCRUAL.Id)
                            addAccrualPurchaseToSAFList(logDef, safList);
                        else
                        {
                            if (logDef.CategoryId == CategoryType.REVERSAL.Id)
                            {
                                addActualPurchaseToSAFList(historyLogDef, safList, true);
                                if (historyLogDef.DebitCreditNoteNo != string.Empty)
                                {
                                    logDef.DebitCreditNoteNo = historyLogDef.DebitCreditNoteNo;
                                    this.updateSunInterfaceLog(logDef);
                                }
                            }
                            addActualPurchaseToSAFList(logDef, safList, false);
                        }
                    }
                    else if (sunInterfaceTypeId == SunInterfaceTypeRef.Id.NSLedStockProvision.GetHashCode())
                    {
                        if (logDef.CategoryId == CategoryType.REVERSAL.Id)
                        {
                            addActualNSLedStockProvisionToSAFList(historyLogDef, safList, true);
                        }
                        addActualNSLedStockProvisionToSAFList(logDef, safList, false);
                    }
                    else if (sunInterfaceTypeId == SunInterfaceTypeRef.Id.SalesCommission.GetHashCode() || sunInterfaceTypeId == SunInterfaceTypeRef.Id.MockShopSalesCommission.GetHashCode() || sunInterfaceTypeId == SunInterfaceTypeRef.Id.StudioSampleSalesCommission.GetHashCode())
                    {
                        if (categoryId == CategoryType.ACCRUAL.Id)
                            addAccrualSalesCommissionToSAFList(logDef, safList);
                        else
                        {
                            if (logDef.CategoryId == CategoryType.REVERSAL.Id)
                            {
                                InvoiceDef invoiceDef = ShippingWorker.Instance.getInvoiceByKey(logDef.ShipmentId);

                                addActualSalesCommissionToSAFList(historyLogDef, safList, true, (CustomerDef.isNextUK(logDef.CustomerId) && (logDef.IsSampleOrder || (!logDef.IsSampleOrder && invoiceDef.NSLCommissionSettlementDate != DateTime.MinValue && this.isSunInterfaceLogExists(SunInterfaceTypeRef.Id.SalesCommissionSettlement.GetHashCode(), logDef.ShipmentId, logDef.SplitShipmentId)))) ? true : false);
                                addActualSalesCommissionToSAFList(logDef, safList, false, (CustomerDef.isNextUK(logDef.CustomerId) && (logDef.IsSampleOrder || (!logDef.IsSampleOrder && invoiceDef.NSLCommissionSettlementDate != DateTime.MinValue && this.isSunInterfaceLogExists(SunInterfaceTypeRef.Id.SalesCommissionSettlement.GetHashCode(), logDef.ShipmentId, logDef.SplitShipmentId)))) ? true : false);
                            }
                            else
                            {
                                addActualSalesCommissionToSAFList(logDef, safList, false);
                            }
                        }
                    }
                    else if (SunInterfaceTypeRef.isOtherCost(sunInterfaceTypeId))
                    {
                        if (categoryId == CategoryType.ACCRUAL.Id)
                            addAccrualOtherCostToSAFList(logDef, safList);
                        else
                        {
                            if (logDef.CategoryId == CategoryType.REVERSAL.Id)
                                addActualOtherCostToSAFList(historyLogDef, safList, true);
                            addActualOtherCostToSAFList(logDef, safList, false);
                        }
                    }
                    else if (sunInterfaceTypeId == SunInterfaceTypeRef.Id.DevelopmentCost.GetHashCode())
                        this.buildDevelopmentCostSummary(logDef);
                    else if (sunInterfaceTypeId == SunInterfaceTypeRef.Id.AccountReceivable.GetHashCode())
                        addActualARToSAFList(logDef, safList);
                    else if (sunInterfaceTypeId == SunInterfaceTypeRef.Id.AccountPayable.GetHashCode())
                        addActualAPToSAFList(logDef, safList);
                    else if (sunInterfaceTypeId == SunInterfaceTypeRef.Id.SalesCommissionSettlement.GetHashCode())
                        this.addActualSalesCommissionSettlementToSAFList(logDef, safList);
                    else if (sunInterfaceTypeId == SunInterfaceTypeRef.Id.APAdjustment.GetHashCode())
                        addActualAPAdjustmentToSAFList(logDef, safList);
                    else if (sunInterfaceTypeId == SunInterfaceTypeRef.Id.APAdjustment_ChangeCurrency.GetHashCode())
                        addActualAPAdjustment_ChangeCurrencyToSAFList(logDef, safList);
                    else if (sunInterfaceTypeId == SunInterfaceTypeRef.Id.ARAdjustmentForNext.GetHashCode())
                        addActualARAdjustmentForNextToSAFList(logDef, safList);
                    else if (sunInterfaceTypeId == SunInterfaceTypeRef.Id.ARAdjustmentForEziBuy.GetHashCode())
                        addActualARAdjustmentForEziBuyToSAFList(logDef, safList);
                    else if (sunInterfaceTypeId == SunInterfaceTypeRef.Id.MockShop.GetHashCode())
                        addActualMockShopToSAFList(logDef, safList);
                    else if (sunInterfaceTypeId == SunInterfaceTypeRef.Id.StudioSample.GetHashCode())
                        addActualStudioSampleToSAFList(logDef, safList);
                    else if (sunInterfaceTypeId == SunInterfaceTypeRef.Id.UTContractDN.GetHashCode())
                        addActualUTContractDNToSAFList(logDef, safList);
                    else if (sunInterfaceTypeId == SunInterfaceTypeRef.Id.UKClaim.GetHashCode())
                        addActualUKClaimToSAFList(logDef, safList);
                    else if (sunInterfaceTypeId == SunInterfaceTypeRef.Id.UKDiscountClaim.GetHashCode())
                        addActualUKDiscountClaimToSAFList(logDef, safList);
                    else if (sunInterfaceTypeId == SunInterfaceTypeRef.Id.UKDiscountClaimClearing.GetHashCode())
                        addActualUKDiscountClaimClearingToSAFList(logDef, safList);
                    else if (sunInterfaceTypeId == SunInterfaceTypeRef.Id.QACommission.GetHashCode())
                        addActualQACommissionToSAFList(logDef, safList);
                    else if (sunInterfaceTypeId == SunInterfaceTypeRef.Id.UKClaimRechargeToSupplier.GetHashCode())
                        addActualUKClaimRechargeToSupplierToSAFList(logDef, safList);
                    else if (sunInterfaceTypeId == SunInterfaceTypeRef.Id.UKClaimRechargeToSupplier_ChangeCurrency.GetHashCode())
                        addActualUKClaimRechargeToSupplier_ChangeCurrencyToSAFList(logDef, safList);
                    else if (sunInterfaceTypeId == SunInterfaceTypeRef.Id.NSLedSales_Duty.GetHashCode() || sunInterfaceTypeId == SunInterfaceTypeRef.Id.NSLedSales_NonDuty.GetHashCode())
                        addActualNSLedSalesToSAFList(logDef, safList);
                    /*
                    else if (sunInterfaceTypeId == SunInterfaceTypeRef.Id.ILSSalesDiscrepancy.GetHashCode())
                        addActualILSSalesDiscrepancyToSAFList(logDef, safList);
                    else if (sunInterfaceTypeId == SunInterfaceTypeRef.Id.ILSSalesCommissionDiscrepancy.GetHashCode())
                        addActualILSSalesCommissionDiscrepancyToSAFList(logDef, safList);
                    */
                    else if (sunInterfaceTypeId == SunInterfaceTypeRef.Id.AdvancePayment.GetHashCode())
                        addActualAdvancePaymentToSAFList(logDef, safList);
                    else if (sunInterfaceTypeId == SunInterfaceTypeRef.Id.AdvancePaymentInterest.GetHashCode())
                        addActualAdvancePaymentInterestToSAFList(logDef, safList);
                    else if (sunInterfaceTypeId == SunInterfaceTypeRef.Id.OtherChargeDCNote.GetHashCode())
                        addActualOtherChargeDCNoteToSAFList(logDef, safList);
                    else if (sunInterfaceTypeId == SunInterfaceTypeRef.Id.TemporaryPayment.GetHashCode())
                    {
                        if (logDef.CategoryId == CategoryType.REVERSAL.Id)
                            addActualTemporaryPaymentToSAFList(historyLogDef, safList, true);
                        this.addActualTemporaryPaymentToSAFList(logDef, safList, false);
                    }
                    else if (sunInterfaceTypeId == SunInterfaceTypeRef.Id.NonTradeExpenseInvoice.GetHashCode())
                        this.addActualNonTradeExpenseInvoiceToSAFList(logDef, safList);
                    else if (sunInterfaceTypeId == SunInterfaceTypeRef.Id.NonTradeRechargeDebitNote.GetHashCode())
                        this.addActualNonTradeRechargeDebitNoteToSAFList(logDef, safList);
                    else if (sunInterfaceTypeId == SunInterfaceTypeRef.Id.NonTradePaymentOnBehalfDebitNote.GetHashCode())
                        this.addActualNonTradePaymentOnBehalfDebitNoteToSAFList(logDef, safList);
                    else if (sunInterfaceTypeId == SunInterfaceTypeRef.Id.NonTradeAccrual.GetHashCode())
                        this.addActualNonTradeAccrualToSAFList(logDef, safList);
                    else if (sunInterfaceTypeId == SunInterfaceTypeRef.Id.NonTradeBankPayment.GetHashCode())
                        this.addActualNonTradeBankPaymentToSAFList(logDef, safList);
                    lastLogDef = logDef;
                }

                EpicorInterfaceWorker.Instance.finalize(sunInterfaceTypeId);

                ctx.VoteCommit();

                return safList;
            }
            catch (Exception e)
            {
                ctx.VoteRollback();
                throw e;
            }
            finally
            {
                ctx.Exit();
            }
        }

        public int getTransactionRefNo(string paramName)
        {
            TransactionContext ctx = TransactionContextFactory.GetContext(TransactionAffinity.Required);
            try
            {
                ctx.Enter();
                TransactionContext currentCtx = TransactionContextFactory.GetCurrentContext();

                int i = 0;
                IDataSetAdapter ad = getDataSetAdapter("TransactionRefApt", "GetTransactionRefByKey");
                ad.SelectCommand.Parameters["@paramName"].Value = paramName;

                TXRefParamDs dataSet = new TXRefParamDs();
                TXRefParamDs.TXRefParamRow row = null;

                ad.SelectCommand.DbCommand.CommandTimeout = 120;
                ad.PopulateCommands();
                int recordsAffected = ad.Fill(dataSet);

                if (recordsAffected > 0)
                {
                    row = dataSet.TXRefParam[0];
                    i = row.ParamValue;
                    row.ParamValue = i + 1;
                }
                else
                {
                    i = 1;
                    row = dataSet.TXRefParam.NewTXRefParamRow();
                    row.ParamName = paramName;
                    row.ParamValue = i + 1;
                    dataSet.TXRefParam.AddTXRefParamRow(row);
                }

                recordsAffected = ad.Update(dataSet);
                if (recordsAffected < 1)
                    throw new DataAccessException("Update TX Ref. ERROR");
                ctx.VoteCommit();

                return i;
            }
            catch (Exception e)
            {
                Console.WriteLine("ERROR " + e.Message);
                ctx.VoteRollback();
                throw e;
            }
            finally
            {
                ctx.Exit();
            }
        }

        public string exportToSunInterfaceFile(SunInterfaceQueueDef def, ArrayList safList, int sourceId)
        {
            string fileFolder = WebConfig.getValue("appSettings", "SUN_INTERFACE_OUTPUT_FOLDER");
            string macroFolder = WebConfig.getValue("appSettings", "SUN_INTERFACE_MACRO_FOLDER");
            string fileName = null; ;

            if (sourceId == 1)
            {
                fileName = fileFolder + def.OfficeGroup.ShortName + "_";

                if (def.CategoryType.Id != CategoryType.REVERSAL.Id && def.CategoryType.Id != CategoryType.DAILY.Id)
                    fileName += def.FiscalYear.ToString() + def.Period.ToString().PadLeft(2, '0') + "_" +
                                def.CategoryType.Name + "_" +
                                SunInterfaceTypeRef.getDescription(def.SunInterfaceTypeId) + "_" +
                                def.QueueId.ToString().PadLeft(10, '0') + ".csv";
                else
                    fileName += def.CategoryType.Name + "_" +
                                SunInterfaceTypeRef.getDescription(def.SunInterfaceTypeId) + "_" +
                                def.QueueId.ToString().PadLeft(10, '0') + ".csv";
            }
            else
            {
                if (def.UTurn == 1 && def.SunInterfaceTypeId == SunInterfaceTypeRef.Id.Sales.GetHashCode())
                    fileName = macroFolder + DateTime.Today.ToString("MMdd") + "1SZ_" + def.QueueId.ToString() + ".ndf";
                else if (def.UTurn == 1 && def.SunInterfaceTypeId == SunInterfaceTypeRef.Id.SalesCommission.GetHashCode())
                    fileName = macroFolder + DateTime.Today.ToString("MMdd") + "1CN_" + def.QueueId.ToString() + ".ndf";
                else
                    fileName = macroFolder + DateTime.Today.ToString("MMdd") + "1NS_" + def.QueueId.ToString() + ".ndf";
            }

            if (File.Exists(fileName))
                File.Delete(fileName);
            StreamWriter s = File.CreateText(fileName);

            if (sourceId == 1)
                s.WriteLine("AccountCode,Filler1,AccountingPeriod,TransactionDate,Filler2,RecordType,JournalNo,JournalLineNo,baseamount,DCIndicator,AllocationIndicator,JournalType,JournalSource,TransactionReference,Filler3,Description,EntryDate,EntryPeriod,DueDate,Filler4,PaymentReference,PaymentDate,PaymentPeriod,AssetIndicator,AssetCode,AssetSubCode,ConversionCode,ConversionRate,OtherAmount,OtherAmountDecimal,ClearDownSequenceNo,Filler5,NextPeriodReversal,LossOrGain,RoughBookFlag,InUseFlag,T0,T1,T2,T3,T4,T5,T6,T7,T8,T9,PostingDate,UpdateOrderBalIndicator,AllocationInProgressMaker,JournalHoldReference,OperatorId,BudgetCheckAccount,Filler6,PaymentTerm,PayRefNo,OfficeCode,TradingAgency,AccruedSince");
            else
                s.WriteLine("VERSION                         42601");

            /*
            foreach (SAFDef safDef in safList)
            {
                if (sourceId == 1)
                {
                    System.Diagnostics.Debug.WriteLine(safDef.Description);
                    s.WriteLine(safDef.ToString() + "," + (safDef.IsMockShopSample ? "MS" : String.Empty));
                }
                else
                    s.WriteLine(safDef.ToNDFString());
            }
            

            if (def.SunInterfaceTypeId == SunInterfaceTypeRef.Id.MockShop.GetHashCode())
            {
                StreamReader r = null;
                string l = "";
                r = File.OpenText(fileFolder + "queue\\" + (def.QueueId - 2).ToString() + ".csv");
                l = r.ReadLine();
                while ((l = r.ReadLine()) != null)
                {
                    s.WriteLine(l);
                }
                r = File.OpenText(fileFolder + "queue\\" + (def.QueueId - 1).ToString() + ".csv");
                l = r.ReadLine();
                while ((l = r.ReadLine()) != null)
                {
                    s.WriteLine(l);
                }
            }
            */
            s.Close();
            if (sourceId == 1)
                File.Copy(fileName, fileFolder + "queue\\" + def.QueueId.ToString() + ".csv", true);
            return fileName;
        }

        private decimal getClosedAdjustmentAmount(int shipmentId, int splitShipmentId, int adjustmentTypeId)
        {
            decimal amt = 0;
            ArrayList list = this.getClosedAdjustmentDetailList(shipmentId, 0, AdjustmentType.SALES_ADJUSTMENT.Id);

            foreach (AdjustmentDetailDef def in list)
            {
                amt += def.AdjustmentAmount;
            }
            return amt;
        }


        public void doAdjustmentAfterSettlement(int shipmentId, int splitShipmentId, int userId)
        {
            TransactionContext ctx = TransactionContextFactory.GetContext(TransactionAffinity.Required);
            try
            {
                ctx.Enter();
                TransactionContext currentCtx = TransactionContextFactory.GetCurrentContext();
                decimal closedAdjustmentAmt = 0;
                decimal qaCommission = 0;
                AdjustmentDetailDef adjDetailDef = null;
                bool isDiff = false;
                bool isUTSettled = false;
                UTContractDCNoteDef utContractDCNoteDef = null;
                UTContractDCNoteShipmentDef utContractDCNoteShipmentDef = null;
                decimal latestAmt = 0;
                decimal lastSettledAmt = 0;


                if (splitShipmentId == 0)
                {
                    ShipmentDef shipmentDef = OrderSelectWorker.Instance.getShipmentByKey(shipmentId);
                    InvoiceDef invoiceDef = ShippingWorker.Instance.getInvoiceByKey(shipmentId);
                    ContractDef contractDef = OrderSelectWorker.Instance.getContractByKey(shipmentDef.ContractId);

                    if (shipmentDef.TermOfPurchase.TermOfPurchaseId == TermOfPurchaseRef.Id.FOB_UT.GetHashCode())
                    {
                        utContractDCNoteShipmentDef = this.getUTContractDCNoteShipmentByKey(shipmentId);

                        if (utContractDCNoteDef != null)
                            isUTSettled = true;
                    }

                    if (invoiceDef.ARDate != DateTime.MinValue || isUTSettled)
                    {
                        ILSInvoiceDef ilsInvoiceDef = ILSUploadWorker.Instance.getILSInvoiceByShipmentId(shipmentId);
                        closedAdjustmentAmt = getClosedAdjustmentAmount(shipmentId, 0, AdjustmentType.SALES_ADJUSTMENT.Id);
                        adjDetailDef = this.getOutstandingAdjustmentDetail(shipmentId, 0, AdjustmentType.SALES_ADJUSTMENT.Id);

                        if (ilsInvoiceDef != null)
                        {
                            if (CurrencyId.getCommonName(shipmentDef.SellCurrency.CurrencyId) != ilsInvoiceDef.Currency)
                                isDiff = true;
                        }

                        if (!isUTSettled)
                        {
                            latestAmt = shipmentDef.TotalShippedAmount;
                            lastSettledAmt = invoiceDef.ARAmt;
                        }
                        else
                        {
                            /* 2017-06-14 Jessie mentioned that NCT receives only 10.417% of Supplier Amt
                            latestAmt = invoiceDef.NSLCommissionAmt 
                                        + Math.Round(shipmentDef.TotalShippedAmount * (decimal)(0.01), 2, MidpointRounding.AwayFromZero) 
                                        + (shipmentDef.TotalShippedAmount - shipmentDef.TotalShippedSupplierGarmentAmountAfterDiscount);

                            lastSettledAmt = utContractDCNoteDef.TotalCommission + utContractDCNoteDef.TotalMargin + utContractDCNoteDef.TotalServiceFee;
                            */
                            latestAmt = Math.Round(shipmentDef.TotalShippedNetFOBAmountAfterDiscount * (decimal)10.417 / (decimal)100.0, 2, MidpointRounding.AwayFromZero);
                            lastSettledAmt = utContractDCNoteShipmentDef.SupplierCommission;
                        }

                        if ((lastSettledAmt + closedAdjustmentAmt) != latestAmt)
                            isDiff = true;

                        if (isDiff)
                        {
                            if (adjDetailDef == null)
                            {
                                adjDetailDef = new AdjustmentDetailDef();
                                adjDetailDef.AdjustmentDetailId = -1;
                                adjDetailDef.ShipmentId = shipmentId;
                                adjDetailDef.SplitShipmentId = 0;
                                adjDetailDef.AdjustmentType = AdjustmentType.SALES_ADJUSTMENT;
                            }
                            adjDetailDef.VendorId = -1;
                            adjDetailDef.Currency = (ilsInvoiceDef != null ? generalWorker.getCurrencyByCurrencyCode(ilsInvoiceDef.Currency) : shipmentDef.SellCurrency);
                            adjDetailDef.AdjustmentNoteId = -1;
                            adjDetailDef.LatestAmount = latestAmt;
                            adjDetailDef.SettledAmount = lastSettledAmt + closedAdjustmentAmt;
                            adjDetailDef.AdjustmentAmount = adjDetailDef.LatestAmount - adjDetailDef.SettledAmount;
                            adjDetailDef.DebitCreditIndicator = adjDetailDef.AdjustmentAmount >= 0 ? "D" : "C";
                            adjDetailDef.QACommissionPercent = 0;
                            adjDetailDef.QACommissionAmount = 0;
                            adjDetailDef.VendorPaymentDiscountPercent = 0;
                            adjDetailDef.VendorPaymentDiscountAmount = 0;

                            // TODO: handle currency diff

                            this.updateAdjustmentDetail(adjDetailDef, userId);

                            if (ilsInvoiceDef != null)
                            {
                                decimal usdAmt = commonWorker.getExchangeRate(ExchangeRateType.PAYABLE_RECEIVABLE, shipmentDef.SellCurrency.CurrencyId, DateTime.Today) / commonWorker.getExchangeRate(ExchangeRateType.PAYABLE_RECEIVABLE, CurrencyId.USD.Id, DateTime.Today) * adjDetailDef.AdjustmentAmount;
                                if (invoiceDef.ARAmt != 0)
                                {
                                    int officeId = contractDef.Office.OfficeId;
                                    if ((usdAmt > 0 && usdAmt >= OfficeId.getDebitILSDiscrepancyThreshold(officeId)) || (usdAmt < 0 && Math.Abs(usdAmt) >= OfficeId.getCreditILSDiscrepancyThreshold(officeId)))
                                    {
                                        NoticeHelper.sendOverILSExceptionLimitEmail(contractDef.Merchandiser, shipmentId, ilsInvoiceDef.Currency, adjDetailDef.SettledAmount, invoiceDef.InvoiceNo, null);
                                        ShippingWorker.Instance.updateActionHistory(new ActionHistoryDef(shipmentId, 0, ActionHistoryType.PRICE_DIFF_ALERT, "Price Diff Alert Upon A/R Settlement", GeneralCriteria.TRUE, userId));
                                    }
                                }
                            }
                        }
                        else
                        {
                            if (adjDetailDef != null)
                                this.removeAdjustmentDetail(adjDetailDef);
                        }
                    }

                    /*
                    if ((contractDef.SetSplitCount == 0 || (contractDef.SetSplitCount > 0 && contractDef.IsVirtualSetSplit == 1)) && invoiceDef.APDate != DateTime.MinValue)
                    {
                        closedAdjustmentAmt = getClosedAdjustmentAmount(shipmentId, 0, AdjustmentType.PURCHASE_ADJUSTMENT.Id);
                        adjDetailDef = this.getOutstandingAdjustmentDetail(shipmentId, 0, AdjustmentType.PURCHASE_ADJUSTMENT.Id);
                        qaCommission = Math.Round(shipmentDef.TotalShippedSupplierGarmentAmountAfterDiscount * (shipmentDef.QACommissionPercent / 100), 2, MidpointRounding.AwayFromZero);

                        if ((invoiceDef.APAmt + closedAdjustmentAmt) != (shipmentDef.TotalShippedSupplierGarmentAmountAfterDiscount - qaCommission))
                        {
                            if (adjDetailDef == null)
                            {
                                adjDetailDef = new AdjustmentDetailDef();
                                adjDetailDef.AdjustmentDetailId = -1;
                                adjDetailDef.ShipmentId = shipmentId;
                                adjDetailDef.SplitShipmentId = 0;
                                adjDetailDef.AdjustmentType = AdjustmentType.PURCHASE_ADJUSTMENT;
                            }
                            adjDetailDef.VendorId = shipmentDef.Vendor.VendorId;
                            adjDetailDef.Currency = shipmentDef.BuyCurrency;
                            adjDetailDef.AdjustmentNoteId = -1;
                            adjDetailDef.LatestAmount = shipmentDef.TotalShippedSupplierGarmentAmountAfterDiscount - qaCommission;
                            adjDetailDef.SettledAmount = invoiceDef.APAmt + closedAdjustmentAmt;
                            adjDetailDef.AdjustmentAmount = (invoiceDef.APAmt + closedAdjustmentAmt) - (shipmentDef.TotalShippedSupplierGarmentAmountAfterDiscount - qaCommission);
                            adjDetailDef.DebitCreditIndicator = adjDetailDef.AdjustmentAmount > 0 ? "D" : "C";
                            // TODO: handle currency diff
                            this.updateAdjustmentDetail(adjDetailDef, userId);
                        }
                        else
                        {
                            if (adjDetailDef != null)
                                this.removeAdjustmentDetail(adjDetailDef);
                        }
                    }
                    */
                }
                /*
                else
                {
                    SplitShipmentDef splitDef = OrderSelectWorker.Instance.getSplitShipmentByKey(splitShipmentId);
                    qaCommission = Math.Round(splitDef.TotalShippedSupplierGarmentAmountAfterDiscount * (splitDef.QACommissionPercent / 100), 2, MidpointRounding.AwayFromZero);

                    if (splitDef.APDate != DateTime.MinValue && splitDef.IsVirtualSetSplit == GeneralCriteria.FALSE)
                    {
                        closedAdjustmentAmt = getClosedAdjustmentAmount(shipmentId, splitDef.SplitShipmentId, AdjustmentType.PURCHASE_ADJUSTMENT.Id);
                        adjDetailDef = this.getOutstandingAdjustmentDetail(shipmentId, splitDef.SplitShipmentId, AdjustmentType.PURCHASE_ADJUSTMENT.Id);

                        if ((splitDef.APAmt + closedAdjustmentAmt) != (splitDef.TotalShippedSupplierGarmentAmountAfterDiscount - qaCommission))
                        {
                            if (adjDetailDef == null)
                            {
                                adjDetailDef = new AdjustmentDetailDef();
                                adjDetailDef.AdjustmentDetailId = -1;
                                adjDetailDef.ShipmentId = shipmentId;
                                adjDetailDef.SplitShipmentId = splitDef.SplitShipmentId;
                                adjDetailDef.AdjustmentType = AdjustmentType.PURCHASE_ADJUSTMENT;
                            }
                            adjDetailDef.VendorId = splitDef.Vendor.VendorId;
                            adjDetailDef.Currency = splitDef.BuyCurrency;
                            adjDetailDef.AdjustmentNoteId = -1;
                            adjDetailDef.LatestAmount = splitDef.TotalShippedSupplierGarmentAmountAfterDiscount - qaCommission;
                            adjDetailDef.SettledAmount = (splitDef.APAmt + closedAdjustmentAmt);
                            adjDetailDef.AdjustmentAmount = (splitDef.APAmt + closedAdjustmentAmt) - (splitDef.TotalShippedSupplierGarmentAmountAfterDiscount - qaCommission);
                            adjDetailDef.DebitCreditIndicator = adjDetailDef.AdjustmentAmount > 0 ? "D" : "C";
                            // TODO: handle currency diff
                            this.updateAdjustmentDetail(adjDetailDef, userId);
                        }
                        else
                        {
                            if (adjDetailDef != null)
                                this.removeAdjustmentDetail(adjDetailDef);
                        }
                    }
                }
                */
                ctx.VoteCommit();
            }
            catch (Exception e)
            {
                Console.WriteLine("ERROR " + e.Message);
                ctx.VoteRollback();
                throw e;
            }
            finally
            {
                ctx.Exit();
            }
        }

        public void doReversal(int shipmentId, ArrayList amendmentList)
        {
            TransactionContext ctx = TransactionContextFactory.GetContext(TransactionAffinity.Required);
            try
            {
                ctx.Enter();
                TransactionContext currentCtx = TransactionContextFactory.GetCurrentContext();

                TypeCollector amendmentTypeCollector = TypeCollector.Inclusive;
                foreach (ActionHistoryDef historyDef in amendmentList)
                {
                    appendMissingActualSunInterfaceLogForOtherCost(shipmentId, historyDef);
                    amendmentTypeCollector.append(historyDef.AmendmentType.Id);
                }

                ShipmentDef shipmentDef = OrderSelectWorker.Instance.getShipmentByKey(shipmentId);
                ContractDef contractDef = OrderSelectWorker.Instance.getContractByKey(shipmentDef.ContractId);
                InvoiceDef invoiceDef = ShippingWorker.Instance.getInvoiceByKey(shipmentId);
                ArrayList sunInterfaceTypeList = getSunInterfaceTypeListByAmendmentTypes(amendmentTypeCollector);
                ArrayList splitShipmentList = (ArrayList)OrderSelectWorker.Instance.getSplitShipmentByShipmentId(shipmentId);

                bool isAdjustmentDone = false;

                foreach (SunInterfaceTypeRef typeRef in sunInterfaceTypeList)
                {
                    if (isSunInterfaceLogExists(typeRef.SunInterfaceTypeId, shipmentId, 0) && invoiceDef.InvoiceDate != DateTime.MinValue
                        && (
                                (!(invoiceDef.ARDate != DateTime.MinValue && SunInterfaceTypeRef.isARRelated(typeRef.SunInterfaceTypeId))
                                && !(invoiceDef.APDate != DateTime.MinValue && SunInterfaceTypeRef.isAPRelated(typeRef.SunInterfaceTypeId)))
                                ||
                                ((invoiceDef.IsSelfBilledOrder || !invoiceDef.IsSelfBilledOrder || shipmentDef.IsMockShopSample == 1) && SunInterfaceTypeRef.isARRelated(typeRef.SunInterfaceTypeId))
                            )
                        )
                    {
                        SunInterfaceLogDef reverseDef = getReversalLogByShipmentId(typeRef.SunInterfaceTypeId, shipmentId, 0);
                        if (reverseDef != null)
                        {
                            removeSunInterfaceLog(reverseDef);
                        }
                        SunInterfaceLogDef logDef = getReversalInterfaceDataByShipmentId(typeRef.SunInterfaceTypeId, shipmentId, 0);
                        if (logDef == null)
                        {
                            logDef = this.getLatestLogByShipmentId(typeRef.SunInterfaceTypeId, shipmentId, 0);
                            this.resetReversalEntry(logDef, true);
                        }
                        updateSunInterfaceLog(logDef);
                    }

                    else if ((typeRef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.Sales.GetHashCode() ||
                         typeRef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.Purchase.GetHashCode())
                        && isAdjustmentDone == false)
                    {
                        this.doAdjustmentAfterSettlement(shipmentId, 0, 99999);
                    }

                    foreach (SplitShipmentDef splitDef in splitShipmentList)
                    {
                        if (isSunInterfaceLogExists(typeRef.SunInterfaceTypeId, shipmentId, splitDef.SplitShipmentId) && invoiceDef.InvoiceDate != DateTime.MinValue
                            && ((!(invoiceDef.ARDate != DateTime.MinValue && SunInterfaceTypeRef.isARRelated(typeRef.SunInterfaceTypeId))
                            && !(splitDef.APDate != DateTime.MinValue && SunInterfaceTypeRef.isAPRelated(typeRef.SunInterfaceTypeId)))
                            || ((invoiceDef.IsSelfBilledOrder || shipmentDef.IsMockShopSample == 1) && SunInterfaceTypeRef.isARRelated(typeRef.SunInterfaceTypeId))))
                        {
                            SunInterfaceLogDef reverseDef = getReversalLogByShipmentId(typeRef.SunInterfaceTypeId, shipmentId, splitDef.SplitShipmentId);
                            if (reverseDef != null)
                            {
                                removeSunInterfaceLog(reverseDef);
                            }
                            SunInterfaceLogDef logDef = getReversalInterfaceDataByShipmentId(typeRef.SunInterfaceTypeId, shipmentId, splitDef.SplitShipmentId);
                            if (logDef == null)
                            {
                                logDef = this.getLatestLogByShipmentId(typeRef.SunInterfaceTypeId, shipmentId, splitDef.SplitShipmentId);
                                this.resetReversalEntry(logDef, true);
                            }
                            updateSunInterfaceLog(logDef);
                        }

                        else if (typeRef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.Purchase.GetHashCode() && isAdjustmentDone == false)
                        {
                            this.doAdjustmentAfterSettlement(shipmentId, splitDef.SplitShipmentId, 99999);
                        }
                    }

                    if ((typeRef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.Sales.GetHashCode() ||
                         typeRef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.Purchase.GetHashCode()) &&
                        isAdjustmentDone == false)
                    {
                        isAdjustmentDone = true;
                    }
                }
                ctx.VoteCommit();
            }
            catch (Exception e)
            {
                Console.WriteLine("ERROR " + e.Message);
                ctx.VoteRollback();
                throw e;
            }
            finally
            {
                ctx.Exit();
            }
        }

        private void appendMissingActualSunInterfaceLogForOtherCost(int shipmentId, ActionHistoryDef historyDef)
        {
            if (AmendmentType.isOtherCost(historyDef.AmendmentType.Id) && this.getCutOffStatus(shipmentId).CutOffStatusId == CutOffStatus.ACTUAL.GetHashCode())
            {
                TypeCollector collector = TypeCollector.Inclusive;
                collector.append(historyDef.AmendmentType.Id);

                ArrayList sunTypeList = getSunInterfaceTypeListByAmendmentTypes(collector);

                SunInterfaceLogDef reverseDef = this.getLatestLogByShipmentId(((SunInterfaceTypeRef)sunTypeList[0]).SunInterfaceTypeId, shipmentId, 0);
                if (reverseDef == null)
                {
                    reverseDef = this.getReversalInterfaceDataByShipmentId(((SunInterfaceTypeRef)sunTypeList[0]).SunInterfaceTypeId, shipmentId, 0);
                    if (reverseDef != null)
                    {
                        this.resetReversalEntry(reverseDef, false);
                        this.updateSunInterfaceLog(reverseDef);
                    }
                }
            }
        }

        /*
        public void doReversal(int shipmentId, int splitShipmentId, ArrayList amendmentList)
        {
            TransactionContext ctx = TransactionContextFactory.GetContext(TransactionAffinity.Required);
            try
            {
                ctx.Enter();
                TransactionContext currentCtx = TransactionContextFactory.GetCurrentContext();

                TypeCollector amendmentTypeCollector = TypeCollector.Inclusive;
                foreach (ActionHistoryDef historyDef in amendmentList)
                {
                    amendmentTypeCollector.append(historyDef.AmendmentType.Id);
                }

                ShipmentDef shipmentDef = OrderSelectWorker.Instance.getShipmentByKey(shipmentId);
                ContractDef contractDef = OrderSelectWorker.Instance.getContractByKey(shipmentDef.ContractId);
                InvoiceDef invoiceDef = ShippingWorker.Instance.getInvoiceByKey(shipmentId);
                ArrayList sunInterfaceTypeList = getSunInterfaceTypeListByAmendmentTypes(amendmentTypeCollector);
                ArrayList splitShipmentList = (ArrayList)OrderSelectWorker.Instance.getSplitShipmentByShipmentId(shipmentId);

                bool isAdjustmentDone = false;

                foreach (SunInterfaceTypeRef typeRef in sunInterfaceTypeList)
                {
                    if (isSunInterfaceLogExists(typeRef.SunInterfaceTypeId, shipmentId, 0)
                        && ((!(invoiceDef.ARDate != DateTime.MinValue && SunInterfaceTypeRef.isARRelated(typeRef.SunInterfaceTypeId))
                        && !(invoiceDef.APDate != DateTime.MinValue && SunInterfaceTypeRef.isAPRelated(typeRef.SunInterfaceTypeId)))
                        || ((invoiceDef.IsSelfBilledOrder || shipmentDef.IsMockShopSample == 1) && SunInterfaceTypeRef.isARRelated(typeRef.SunInterfaceTypeId))))
                    {
                        SunInterfaceLogDef reverseDef = getReversalLogByShipmentId(typeRef.SunInterfaceTypeId, shipmentId, 0);
                        if (reverseDef != null)
                        {
                            removeSunInterfaceLog(reverseDef);
                        }
                        SunInterfaceLogDef logDef = getReversalInterfaceDataByShipmentId(typeRef.SunInterfaceTypeId, shipmentId, 0);
                        updateSunInterfaceLog(logDef);
                    }

                    if ((typeRef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.Sales.GetHashCode() ||
                         typeRef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.Purchase.GetHashCode())
                        && isAdjustmentDone == false)
                    {
                        this.doAdjustmentAfterSettlement(shipmentId, 0, 99999);
                    }

                    foreach (SplitShipmentDef splitDef in splitShipmentList)
                    {
                        if (isSunInterfaceLogExists(typeRef.SunInterfaceTypeId, shipmentId, splitDef.SplitShipmentId) && invoiceDef.ARDate == DateTime.MinValue && invoiceDef.APDate == DateTime.MinValue)
                        {
                            SunInterfaceLogDef reverseDef = getReversalLogByShipmentId(typeRef.SunInterfaceTypeId, shipmentId, splitDef.SplitShipmentId);
                            if (reverseDef != null)
                            {
                                removeSunInterfaceLog(reverseDef);
                            }
                            SunInterfaceLogDef logDef = getReversalInterfaceDataByShipmentId(typeRef.SunInterfaceTypeId, shipmentId, splitDef.SplitShipmentId);
                            updateSunInterfaceLog(logDef);
                        }

                        if (typeRef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.Purchase.GetHashCode() && isAdjustmentDone == false)
                        {
                            this.doAdjustmentAfterSettlement(shipmentId, splitDef.SplitShipmentId, 99999);
                        }
                    }

                    if ((typeRef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.Sales.GetHashCode() ||
                         typeRef.SunInterfaceTypeId == SunInterfaceTypeRef.Id.Purchase.GetHashCode()) &&
                        isAdjustmentDone == false)
                    {
                        isAdjustmentDone = true;
                    }
                }
                ctx.VoteCommit();
            }
            catch (Exception e)
            {
                Console.WriteLine("ERROR " + e.Message);
                ctx.VoteRollback();
                throw e;
            }
            finally
            {
                ctx.Exit();
            }
        }
        */

        private void resetSummaryVariables()
        {
            htUniqueKeyList.Clear();
            /*
            mockShopSummary.Clear();
            reverseMockShopSummary.Clear();
            */
            devCostSummary.Clear();
            paymentGrpTbl.Clear();
            receiptGrpTbl.Clear();

            totalBaseAmt = 0;
            totalFBHKBaseAmt = 0;
            totalFBSHBaseAmt = 0;
            totalFBVNBaseAmt = 0;
            totalHKFBBaseAmt = 0;
            totalSHFBBaseAmt = 0;
            totalVNFBBaseAmt = 0;

            totalReverseBaseAmt = 0;
            totalFBHKReverseBaseAmt = 0;
            totalFBSHReverseBaseAmt = 0;
            totalFBVNReverseBaseAmt = 0;
            totalHKFBReverseBaseAmt = 0;
            totalSHFBReverseBaseAmt = 0;
            totalVNFBReverseBaseAmt = 0;

            totalDiscountBaseAmt = 0;
            totalReverseDiscountBaseAmt = 0;
            /*
            totalMockShopBaseAmt = 0;
            totalMockShopOtherAmt = 0;
            totalReverseMockShopBaseAmt = 0;
            totalReverseMockShopOtherAmt = 0;
            */
        }


        public ArrayList getUploadedARAPData(int userId, string sourcePath, string fileType, out ArrayList ccyDiscrepancyList, out ArrayList arrUpdatedList, out bool isFileSplit)
        {
            StreamReader sourceFile = File.OpenText(sourcePath);
            string line = "";
            char[] delimiter = { ',' };
            ArrayList list = new ArrayList();
            ArrayList temp = null;
            string[] fields;
            ContractShipmentListJDef def = null;
            UKClaimDCNoteDef claimDCNoteDef = null;
            ShippingWorker shippingWorker = ShippingWorker.Instance;
            arrUpdatedList = new ArrayList();
            isFileSplit = false;
            int sequenceNo = -1;
            List<string> LCBillRefList = new List<string>();
            List<string> SettleNoList = new List<string>();
            List<DateTime> SettleDateList = new List<DateTime>();
            ccyDiscrepancyList = new ArrayList();

            while (!sourceFile.EndOfStream)
            {
                if (list.Count == 1000)
                {
                    isFileSplit = true;
                    break;
                }

                sequenceNo = -1;
                line = sourceFile.ReadLine();
                if (line.Replace(",", "").Trim() == "")
                    continue;
                fields = line.Split(delimiter);

                if (fileType == "ap2")
                {
                    if (!LCBillRefList.Contains(fields[0].ToUpper()))
                    {
                        LCBillRefList.Add(fields[0].ToUpper());
                        SettleNoList.Add(fields[1].ToUpper());
                        SettleDateList.Add(DateTime.Parse(fields[2].Trim()));
                    }
                }
                else if (fileType == "ap3")
                {
                    temp = shippingWorker.getInvoiceListByInvoiceNo(fields[0], sequenceNo, null);
                    if (temp.Count == 0)
                    {
                        def = null;
                        NoticeHelper.sendReplacementInvoiceEmail(userId, fields[0]);
                    }
                    else
                    {
                        def = (ContractShipmentListJDef)temp[0];
                        def.APDate = DateTime.Parse(fields[1].Trim());
                        def.APRefNo = fields[2].Trim();

                        list.Add(def);
                    }
                }
                else
                {
                    if (fields[0].Contains("/"))
                    {
                        if ((fileType == "salesComm" && !fields[0].EndsWith("c", StringComparison.OrdinalIgnoreCase)) ||
                            (fileType != "salesComm" && fields[0].EndsWith("c", StringComparison.OrdinalIgnoreCase)))
                            continue;

                        if (fields[0].Contains("-"))
                        {
                            sequenceNo = Convert.ToInt32(fields[0].Substring(fields[0].IndexOf('-') + 1));
                        }
                        if (fields[0].EndsWith("C") || fields[0].EndsWith("c"))
                        {
                            fields[0] = fields[0].Remove(fields[0].Length - 1);
                        }
                        temp = shippingWorker.getInvoiceListByInvoiceNo(fields[0], sequenceNo, null);
                        if (temp.Count == 0)
                        {
                            def = null;
                            NoticeHelper.sendReplacementInvoiceEmail(userId, fields[0]);
                        }
                        else
                            def = (ContractShipmentListJDef)temp[0];
                    }
                    else
                    {
                        def = null;
                        if (fields[0].IndexOf("-") > 0)
                            def = shippingWorker.getSplitShipmentByPONo(fields[0].Substring(0, fields[0].IndexOf("-") - 1),
                            fields[0].Substring(fields[0].IndexOf("-") - 1, 1), Convert.ToInt32(fields[0].Substring(fields[0].IndexOf("-") + 1)));
                        if (def != null)
                            def.InvoiceNo = fields[0];
                        else
                            claimDCNoteDef = UKClaimWorker.Instance.getUKClaimDCNoteByDCNoteNo(fields[0]);
                    }

                    if (def != null || claimDCNoteDef != null)
                    {
                        if (fileType == "ar")
                        {
                            if (def != null)
                            {
                                def.ARAmount = Convert.ToDecimal(fields[3]);

                                if (def.ARDate != DateTime.MinValue)
                                {
                                    arrUpdatedList.Add(def.InvoiceNo);
                                }
                                def.ARDate = DateTime.Parse(fields[4].Trim());
                                if (def.ARDate >= DateTime.Now)
                                    throw new ArgumentException(string.Format("Input receipt date in line {0} should not be later than today. Please modify and re-upload the file.", list.Count + 1));

                                def.ARRefNo = fields[5].Trim();
                                if (fields[2].Trim() != def.SellCurrency.CurrencyCode && !(fields[2].Trim() == "GBP" && def.SellCurrency.CurrencyCode == "GB") &&
                                    !(fields[2].Trim() == "EUR" && def.SellCurrency.CurrencyCode == "EU"))
                                    ccyDiscrepancyList.Add(def.ShipmentId);
                            }

                        }
                        else if (fileType == "ap")
                        {
                            if (def != null)
                            {
                                def.APAmount = Convert.ToDecimal(fields[3]);
                                if (def.APDate != DateTime.MinValue)
                                {
                                    arrUpdatedList.Add(def.InvoiceNo);
                                }
                                def.APDate = DateTime.Parse(fields[4].Trim());
                                def.APRefNo = fields[5].Trim();
                                if (fields[2].Trim() != def.BuyCurrency.CurrencyCode
                                    && !(fields[2].Trim() == "GBP" && def.BuyCurrency.CurrencyCode == "GB")
                                    && !(fields[2].Trim() == "EUR" && def.BuyCurrency.CurrencyCode == "EU"))
                                    ccyDiscrepancyList.Add(def.ShipmentId);
                            }

                            if (claimDCNoteDef != null)
                            {
                                if (claimDCNoteDef.SettlementDate != DateTime.MinValue)
                                    arrUpdatedList.Add(claimDCNoteDef.DCNoteNo);
                                claimDCNoteDef.SettlementDate = DateTime.Parse(fields[4].Trim());
                                if (fields[2].Trim() != CurrencyId.getName(claimDCNoteDef.CurrencyId)
                                    && !(fields[2].Trim() == "GBP" && def.BuyCurrency.CurrencyCode == "GB")
                                    && !(fields[2].Trim() == "EUR" && def.BuyCurrency.CurrencyCode == "EU"))
                                    ccyDiscrepancyList.Add(claimDCNoteDef.DCNoteId * -1);
                            }
                        }
                        else if (fileType == "salesComm")
                        {
                            if (def != null)
                            {
                                def.NSLCommissionSettlementAmount = Convert.ToDecimal(fields[3]);
                                if (def.NSLCommissionSettlementDate != DateTime.MinValue)
                                    arrUpdatedList.Add(def.InvoiceNo);
                                def.NSLCommissionSettlementDate = DateTime.Parse(fields[4].Trim());
                                def.NSLCommissionSettlementRefNo = fields[5].Trim();
                                if (fields[2].Trim() != def.SellCurrency.CurrencyCode && !(fields[2].Trim() == "GBP" && def.SellCurrency.CurrencyCode == "GB") &&
                                    !(fields[2].Trim() == "EUR" && def.SellCurrency.CurrencyCode == "EU"))
                                    ccyDiscrepancyList.Add(def.ShipmentId);
                            }
                        }
                        if (def != null)
                            list.Add(def);
                        else
                            if (claimDCNoteDef != null)
                                if (fileType == "ap")
                                    list.Add(claimDCNoteDef);
                    }
                }
            }
            if (fileType == "ap2")
            {
                foreach (string no in LCBillRefList)
                {
                    ArrayList tempList = ShippingWorker.Instance.GetInvoiceListByLcBillRefNo(no, ContractWFS.INVOICED.Id);
                    foreach (ContractShipmentListJDef item in tempList)
                        list.Add(item);
                }
                for (int i = 0; i < list.Count; i++)
                {
                    ContractShipmentListJDef itemReal = (ContractShipmentListJDef)list[i];
                    InvoiceDef invoice = ShippingWorker.Instance.getInvoiceByKey(itemReal.ShipmentId);
                    int pos = LCBillRefList.IndexOf(invoice.LCBillRefNo.Trim().ToUpper());
                    itemReal.APDate = SettleDateList[pos];
                    itemReal.APRefNo = SettleNoList[pos];
                }
            }

            return list;
        }

        public string generateInvoiceBatchFile(EInvoiceBatchDef eInvoiceBatchDef, TradingAgencyDef tradingAgencyDef)
        {
            OrderSelectWorker orderSelectWorker = OrderSelectWorker.Instance;
            ProductWorker productWorker = ProductWorker.Instance;

            ArrayList invoiceList = ShippingWorker.Instance.getInvoiceByEInvoiceBatchId(eInvoiceBatchDef.EInvoiceBatchId);
            ShipmentDef shipment;
            ContractDef contract;
            ProductDef product;
            ArrayList shipmentDetails;
            string fileContent = "";
            string filePath = WebConfig.getValue("appSettings", "eINVOICE_BATCH_Folder") + eInvoiceBatchDef.EInvoiceBatchNo + "_" + DateTime.Now.ToString("yyMMddHHmmss") + ".txt";

            StreamWriter srbody = File.CreateText(filePath);

            //write header           
            if (tradingAgencyDef.TradingAgencyId == 2 || tradingAgencyDef.TradingAgencyId == 4)
                srbody.WriteLine("HDR|SENDER|NEXT SOURCING VM LIMITED");
            else
                srbody.WriteLine("HDR|SENDER|NEXT SOURCING LIMITED");
            srbody.WriteLine("HDR|ADDRESS|SUITES 1404-13");
            srbody.WriteLine("HDR|ADDRESS|1111 KING'S ROAD");
            srbody.WriteLine("HDR|ADDRESS|TAIKOO SHING");
            srbody.WriteLine("HDR|ADDRESS|HONG KONG");

            if (eInvoiceBatchDef.EInvoiceBatchNo[2] == 'R')
                srbody.WriteLine("HDR|NEXT ENTITY|NEXT Retail");
            else
                srbody.WriteLine("HDR|NEXT ENTITY|NEXT Directory");

            srbody.WriteLine("HDR|NEXT ADDRESS|Accounts Payable");
            srbody.WriteLine("HDR|NEXT ADDRESS|Desford Road");
            srbody.WriteLine("HDR|NEXT ADDRESS|Enderby");
            srbody.WriteLine("HDR|NEXT ADDRESS|Leicestershire");
            srbody.WriteLine("HDR|NEXT ADDRESS|LE19 4AT");

            //write content
            if (invoiceList == null)
            {
                fileContent = "0-EOF";
                srbody.WriteLine(fileContent);
            }
            else
            {
                foreach (InvoiceDef invoice in invoiceList)
                {
                    shipment = orderSelectWorker.getShipmentByKey(invoice.ShipmentId);
                    contract = orderSelectWorker.getContractByKey(shipment.ContractId);
                    product = productWorker.getProductByKey(contract.ProductId);

                    fileContent = invoice.InvoiceNo + "|" + DateTimeUtility.getDateString(invoice.InvoiceDate) + "|" + shipment.Vendor.Name + "|"
                        + contract.UKSupplierCode + "|" + contract.ContractNo + "|" + shipment.TotalShippedQuantity.ToString() + "|"
                        + shipment.TotalShippedAmount.ToString() + "|";

                    if (shipment.SellCurrency.CurrencyCode == "GB")
                        fileContent += "GBP|0";
                    else if (shipment.SellCurrency.CurrencyCode == "EU")
                        fileContent += "EUR|0";
                    else
                        fileContent += shipment.SellCurrency.CurrencyCode + "|0";

                    srbody.WriteLine(fileContent);

                    shipmentDetails = (ArrayList)orderSelectWorker.getShipmentDetailByShipmentId(invoice.ShipmentId);

                    foreach (ShipmentDetailDef detail in shipmentDetails)
                    {
                        fileContent = product.ItemNo + detail.SizeOption.SizeOptionNo + "|" + detail.ShippedQuantity.ToString() + "|" + detail.SellingPrice.ToString() + "|N";
                        srbody.WriteLine(fileContent);
                    }
                }

                fileContent = invoiceList.Count.ToString() + "-EOF";
                srbody.WriteLine(fileContent);
            }

            srbody.Close();

            return filePath;
        }

        public UKPaymentSupplierDef getUKPaymentSupplierByKey(string code)
        {
            IDataSetAdapter ad = getDataSetAdapter("UKPaymentSupplierApt", "GetUKPaymentSupplierByKey");
            ad.SelectCommand.Parameters["@SupplierNo"].Value = code;
            ad.SelectCommand.DbCommand.CommandTimeout = 120;

            UKPaymentSupplierDs dataSet = new UKPaymentSupplierDs();
            int recordsAffected = ad.Fill(dataSet);

            if (recordsAffected < 1) return null;

            UKPaymentSupplierDef def = new UKPaymentSupplierDef();
            UKPaymentSupplierMapping(dataSet.UKPaymentSupplier[0], def);

            return def;
        }

        public string getUKPaymentSupplierEpicorCode(int officeId, int currencyId)
        {
            IDataSetAdapter ad = getDataSetAdapter("UKPaymentSupplierApt", "GetUKPaymentSupplierByOfficeIdCurrencyId");
            ad.SelectCommand.Parameters["@OfficeId"].Value = officeId.ToString();
            ad.SelectCommand.Parameters["@CurrencyId"].Value = currencyId.ToString();
            ad.SelectCommand.DbCommand.CommandTimeout = 120;

            UKPaymentSupplierDs dataSet = new UKPaymentSupplierDs();
            int recordsAffected = ad.Fill(dataSet);

            if (recordsAffected < 1) return string.Empty;

            UKPaymentSupplierDef def = new UKPaymentSupplierDef();
            return dataSet.UKPaymentSupplier[0].EpicorAccountCode;
        }

        public string getUKPaymentSupplierNo(int officeId, int currencyId)
        {
            IDataSetAdapter ad = getDataSetAdapter("UKPaymentSupplierApt", "GetUKPaymentSupplierNoByOfficeIdCurrencyId");
            ad.SelectCommand.Parameters["@OfficeId"].Value = officeId.ToString();
            ad.SelectCommand.Parameters["@CurrencyId"].Value = currencyId.ToString();
            ad.SelectCommand.DbCommand.CommandTimeout = 120;

            UKPaymentSupplierDs dataSet = new UKPaymentSupplierDs();
            int recordsAffected = ad.Fill(dataSet);

            if (recordsAffected < 1) return string.Empty;

            UKPaymentSupplierDef def = new UKPaymentSupplierDef();
            return dataSet.UKPaymentSupplier[0].SupplierNo;
        }

        public ArrayList getOutstandingMockShopShipmentList(int officeId, int fiscalYear, int period)
        {
            IDataSetAdapter ad = getDataSetAdapter("MockShopDCNoteShipmentApt", "GetOutstandingMockShopShipmentList");
            ad.SelectCommand.Parameters["@officeId"].Value = officeId;
            ad.SelectCommand.Parameters["@fiscalYear"].Value = fiscalYear;
            ad.SelectCommand.Parameters["@period"].Value = period;
            ad.SelectCommand.DbCommand.CommandTimeout = 120;

            MockShopDCNoteShipmentDs dataSet = new MockShopDCNoteShipmentDs();
            int recordsAffected = ad.Fill(dataSet);

            ArrayList list = new ArrayList();

            foreach (MockShopDCNoteShipmentDs.MockShopDCNoteShipmentRow row in dataSet.MockShopDCNoteShipment)
            {
                MockShopDCNoteShipmentDef def = new MockShopDCNoteShipmentDef();
                MockShopDCNoteShipmentMapping(row, def);
                list.Add(def);
            }
            return list;

        }

        public ArrayList getOutstandingStudioShipmentList(int officeId, int fiscalYear, int period)
        {
            IDataSetAdapter ad = getDataSetAdapter("StudioDCNoteShipmentApt", "GetOutstandingStudioShipmentList");
            ad.SelectCommand.Parameters["@officeId"].Value = officeId;
            ad.SelectCommand.Parameters["@fiscalYear"].Value = fiscalYear;
            ad.SelectCommand.Parameters["@period"].Value = period;
            ad.SelectCommand.DbCommand.CommandTimeout = 120;

            StudioDCNoteShipmentDs dataSet = new StudioDCNoteShipmentDs();
            int recordsAffected = ad.Fill(dataSet);

            ArrayList list = new ArrayList();

            foreach (StudioDCNoteShipmentDs.StudioDCNoteShipmentRow row in dataSet.StudioDCNoteShipment)
            {
                StudioDCNoteShipmentDef def = new StudioDCNoteShipmentDef();
                StudioDCNoteShipmentMapping(row, def);
                list.Add(def);
            }
            return list;

        }

        public ArrayList getOutstandingUTShipmentList(int officeId, int fiscalYear, int period)
        {
            IDataSetAdapter ad = getDataSetAdapter("UTContractDCNoteShipmentApt", "GetOutstandingUTContractShipmentList");
            ad.SelectCommand.Parameters["@OfficeId"].Value = officeId;
            ad.SelectCommand.Parameters["@FiscalYear"].Value = fiscalYear;
            ad.SelectCommand.Parameters["@Period"].Value = period;
            ad.SelectCommand.DbCommand.CommandTimeout = 120;

            UTContractDCNoteShipmentDs dataSet = new UTContractDCNoteShipmentDs();
            int recordsAffected = ad.Fill(dataSet);

            ArrayList list = new ArrayList();

            foreach (UTContractDCNoteShipmentDs.UTContractDCNoteShipmentRow row in dataSet.UTContractDCNoteShipment)
            {
                UTContractDCNoteShipmentDef def = new UTContractDCNoteShipmentDef();
                UTContractDCNoteShipmentMapping(row, def);
                list.Add(def);
            }
            return list;
        }

        public ArrayList getUTContractShipmentList(int dcNoteId)
        {
            IDataSetAdapter ad = getDataSetAdapter("UTContractDCNoteShipmentApt", "GetUTContractShipmentList");
            ad.SelectCommand.Parameters["@DCNoteId"].Value = dcNoteId;
            ad.SelectCommand.DbCommand.CommandTimeout = 120;

            UTContractDCNoteShipmentDs dataSet = new UTContractDCNoteShipmentDs();
            int recordsAffected = ad.Fill(dataSet);

            ArrayList list = new ArrayList();

            foreach (UTContractDCNoteShipmentDs.UTContractDCNoteShipmentRow row in dataSet.UTContractDCNoteShipment)
            {
                UTContractDCNoteShipmentDef def = new UTContractDCNoteShipmentDef();
                UTContractDCNoteShipmentMapping(row, def);
                list.Add(def);
            }
            return list;
        }

        public UTContractDCNoteDef getUTContractDCNoteByLogicalKey(int fiscalYear, int period, int officeId)
        {
            IDataSetAdapter ad = getDataSetAdapter("UTContractDCNoteApt", "GetUTContractDCNoteByLogicalKey");
            ad.SelectCommand.Parameters["@FiscalYear"].Value = fiscalYear;
            ad.SelectCommand.Parameters["@Period"].Value = period;
            ad.SelectCommand.Parameters["@OfficeId"].Value = officeId;
            ad.SelectCommand.DbCommand.CommandTimeout = 120;

            UTContractDCNoteDs dataSet = new UTContractDCNoteDs();
            int recordsAffected = ad.Fill(dataSet);

            if (recordsAffected < 1) return null;

            UTContractDCNoteDef def = new UTContractDCNoteDef();
            UTContractDCNoteMapping(dataSet.UTContractDCNote[0], def);

            return def;
        }

        public QACommissionDNDef getQACommissionDNByLogicalKey(int fiscalYear, int period, int officeId, int vendorId)
        {
            IDataSetAdapter ad = getDataSetAdapter("QACommissionDNApt", "GetQACommissionDNByLogicalKey");
            ad.SelectCommand.Parameters["@FiscalYear"].Value = fiscalYear;
            ad.SelectCommand.Parameters["@Period"].Value = period;
            ad.SelectCommand.Parameters["@OfficeId"].Value = officeId;
            ad.SelectCommand.Parameters["@VendorId"].Value = vendorId;
            ad.SelectCommand.DbCommand.CommandTimeout = 120;

            QACommissionDNDs dataSet = new QACommissionDNDs();
            int recordsAffected = ad.Fill(dataSet);

            if (recordsAffected < 1) return null;

            QACommissionDNDef def = new QACommissionDNDef();
            QACommissionDNMapping(dataSet.QACommissionDN[0], def);

            return def;
        }


        public StudioDCNoteDef getStudioDCNoteByKey(int key)
        {
            IDataSetAdapter ad = getDataSetAdapter("StudioDCNoteApt", "GetStudioDCNoteByKey");
            ad.SelectCommand.Parameters["@DCNoteId"].Value = key;
            ad.SelectCommand.DbCommand.CommandTimeout = 120;

            StudioDCNoteDs dataSet = new StudioDCNoteDs();
            int recordsAffected = ad.Fill(dataSet);

            if (recordsAffected < 1) return null;

            StudioDCNoteDef def = new StudioDCNoteDef();
            StudioDCNoteMapping(dataSet.StudioDCNote[0], def);

            return def;
        }

        public MockShopDCNoteDef getMockShopDCNoteByKey(int key)
        {
            IDataSetAdapter ad = getDataSetAdapter("MockShopDCNoteApt", "GetMockShopDCNoteByKey");
            ad.SelectCommand.Parameters["@DCNoteId"].Value = key;
            ad.SelectCommand.DbCommand.CommandTimeout = 120;

            MockShopDCNoteDs dataSet = new MockShopDCNoteDs();
            int recordsAffected = ad.Fill(dataSet);

            if (recordsAffected < 1) return null;

            MockShopDCNoteDef def = new MockShopDCNoteDef();
            MockShopDCNoteMapping(dataSet.MockShopDCNote[0], def);

            return def;
        }

        public MockShopDCNoteDef getMockShopDCNoteByPeriod(int fiscalYear, int period, int currencyId, int officeId)
        {
            IDataSetAdapter ad = getDataSetAdapter("MockShopDCNoteApt", "GetMockShopDCNoteByPeriod");
            ad.SelectCommand.Parameters["@FiscalYear"].Value = fiscalYear;
            ad.SelectCommand.Parameters["@Period"].Value = period;
            ad.SelectCommand.Parameters["@CurrencyId"].Value = currencyId;
            ad.SelectCommand.Parameters["@OfficeId"].Value = officeId;
            ad.SelectCommand.DbCommand.CommandTimeout = 120;

            MockShopDCNoteDs dataSet = new MockShopDCNoteDs();
            int recordsAffected = ad.Fill(dataSet);

            if (recordsAffected < 1) return null;

            MockShopDCNoteDef def = new MockShopDCNoteDef();
            MockShopDCNoteMapping(dataSet.MockShopDCNote[0], def);

            return def;
        }

        public MockShopDCNoteDef getMockShopDCNoteByShipmentId(int shipmentId)
        {
            IDataSetAdapter ad = getDataSetAdapter("MockShopDCNoteApt", "GetMockShopDCNoteByShipmentId");
            ad.SelectCommand.Parameters["@ShipmentId"].Value = shipmentId;
            ad.SelectCommand.DbCommand.CommandTimeout = 120;

            MockShopDCNoteDs dataSet = new MockShopDCNoteDs();
            int recordsAffected = ad.Fill(dataSet);

            if (recordsAffected < 1) return null;

            MockShopDCNoteDef def = new MockShopDCNoteDef();
            MockShopDCNoteMapping(dataSet.MockShopDCNote[0], def);

            return def;
        }

        public StudioDCNoteDef getStudioDCNoteByShipmentId(int shipmentId)
        {
            IDataSetAdapter ad = getDataSetAdapter("StudioDCNoteApt", "GetStudioDCNoteByShipmentId");
            ad.SelectCommand.Parameters["@ShipmentId"].Value = shipmentId;
            ad.SelectCommand.DbCommand.CommandTimeout = 120;

            StudioDCNoteDs dataSet = new StudioDCNoteDs();
            int recordsAffected = ad.Fill(dataSet);

            if (recordsAffected < 1) return null;

            StudioDCNoteDef def = new StudioDCNoteDef();
            StudioDCNoteMapping(dataSet.StudioDCNote[0], def);

            return def;
        }

        public MockShopDCNoteDef getMockShopDCNoteByDCNoteNo(string key)
        {
            IDataSetAdapter ad = getDataSetAdapter("MockShopDCNoteApt", "GetMockShopDCNoteByDCNoteNo");
            ad.SelectCommand.Parameters["@DCNoteNo"].Value = key;
            ad.SelectCommand.DbCommand.CommandTimeout = 120;

            MockShopDCNoteDs dataSet = new MockShopDCNoteDs();
            int recordsAffected = ad.Fill(dataSet);

            if (recordsAffected < 1) return null;

            MockShopDCNoteDef def = new MockShopDCNoteDef();
            MockShopDCNoteMapping(dataSet.MockShopDCNote[0], def);

            return def;
        }

        public ArrayList getMockShopCourierChargeListByDCNoteNo(string key)
        {
            IDataSetAdapter ad = getDataSetAdapter("MockShopDCNoteApt", "GetCourierChargeListByDCNoteNo");
            ad.SelectCommand.Parameters["@DCNoteNo"].Value = key;
            ad.SelectCommand.DbCommand.CommandTimeout = 120;

            ArrayList list = new ArrayList();
            DataSet dataSet = new DataSet();
            int recordsAffected = ad.Fill(dataSet);

            if (recordsAffected > 0)
            {
                foreach (DataRow r in dataSet.Tables[0].Rows)
                {
                    list.Add(r[0].ToString() + "," + r[1].ToString() + "," + r[2].ToString() + "," + r[3].ToString());
                }
            }
            return list;
        }

        public ArrayList getMockShopDCNoteShipmentByDCNoteId(int dcNoteId)
        {
            IDataSetAdapter ad = getDataSetAdapter("MockShopDCNoteShipmentApt", "GetMockShopShipmentList");
            ad.SelectCommand.Parameters["@DCNoteId"].Value = dcNoteId;
            ad.SelectCommand.DbCommand.CommandTimeout = 120;

            MockShopDCNoteShipmentDs dataSet = new MockShopDCNoteShipmentDs();
            int recordsAffected = ad.Fill(dataSet);

            ArrayList list = new ArrayList();

            foreach (MockShopDCNoteShipmentDs.MockShopDCNoteShipmentRow row in dataSet.MockShopDCNoteShipment)
            {
                MockShopDCNoteShipmentDef def = new MockShopDCNoteShipmentDef();
                MockShopDCNoteShipmentMapping(row, def);
                list.Add(def);
            }
            return list;
        }

        public ArrayList getStudioDCNoteShipmentByDCNoteId(int dcNoteId)
        {
            IDataSetAdapter ad = getDataSetAdapter("StudioDCNoteShipmentApt", "GetStudioShipmentList");
            ad.SelectCommand.Parameters["@DCNoteId"].Value = dcNoteId;
            ad.SelectCommand.DbCommand.CommandTimeout = 120;

            StudioDCNoteShipmentDs dataSet = new StudioDCNoteShipmentDs();
            int recordsAffected = ad.Fill(dataSet);

            ArrayList list = new ArrayList();

            foreach (StudioDCNoteShipmentDs.StudioDCNoteShipmentRow row in dataSet.StudioDCNoteShipment)
            {
                StudioDCNoteShipmentDef def = new StudioDCNoteShipmentDef();
                StudioDCNoteShipmentMapping(row, def);
                list.Add(def);
            }
            return list;
        }

        public ArrayList getMockShopDCNoteShipmentDetailByDCNoteId(int dcNoteId)
        {
            IDataSetAdapter ad = getDataSetAdapter("MockShopDCNoteShipmentDetailApt", "GetMockShopDCNoteShipmentDetailByDCNoteId");
            ad.SelectCommand.Parameters["@DCNoteId"].Value = dcNoteId;
            ad.SelectCommand.DbCommand.CommandTimeout = 120;

            MockShopDCNoteShipmentDetailDs dataSet = new MockShopDCNoteShipmentDetailDs();
            int recordsAffected = ad.Fill(dataSet);

            ArrayList list = new ArrayList();

            foreach (MockShopDCNoteShipmentDetailDs.MockShopDCNoteShipmentDetailRow row in dataSet.MockShopDCNoteShipmentDetail)
            {
                MockShopDCNoteShipmentDetailDef def = new MockShopDCNoteShipmentDetailDef();
                MockShopDCNoteShipmentDetailMapping(row, def);
                list.Add(def);
            }
            return list;
        }

        public ArrayList getStudioDCNoteShipmentDetailByDCNoteId(int dcNoteId)
        {
            IDataSetAdapter ad = getDataSetAdapter("StudioDCNoteShipmentDetailApt", "GetStudioDCNoteShipmentDetailByDCNoteId");
            ad.SelectCommand.Parameters["@DCNoteId"].Value = dcNoteId;
            ad.SelectCommand.DbCommand.CommandTimeout = 120;

            StudioDCNoteShipmentDetailDs dataSet = new StudioDCNoteShipmentDetailDs();
            int recordsAffected = ad.Fill(dataSet);

            ArrayList list = new ArrayList();

            foreach (StudioDCNoteShipmentDetailDs.StudioDCNoteShipmentDetailRow row in dataSet.StudioDCNoteShipmentDetail)
            {
                StudioDCNoteShipmentDetailDef def = new StudioDCNoteShipmentDetailDef();
                StudioDCNoteShipmentDetailMapping(row, def);
                list.Add(def);
            }
            return list;
        }

        public void updateMockShopDCNoteShipment(MockShopDCNoteShipmentDef def, int userId)
        {
            TransactionContext ctx = TransactionContextFactory.GetContext(TransactionAffinity.Required);
            try
            {
                ctx.Enter();
                TransactionContext currentCtx = TransactionContextFactory.GetCurrentContext();

                IDataSetAdapter ad = getDataSetAdapter("MockShopDCNoteShipmentApt", "GetMockShopDCNoteShipmentByKey");
                ad.SelectCommand.Parameters["@DCNoteShipmentId"].Value = def.DCNoteShipmentId;
                ad.PopulateCommands();

                MockShopDCNoteShipmentDs dataSet = new MockShopDCNoteShipmentDs();
                MockShopDCNoteShipmentDs.MockShopDCNoteShipmentRow row = null;

                int recordsAffected = ad.Fill(dataSet);
                if (recordsAffected > 0)
                {
                    row = dataSet.MockShopDCNoteShipment[0];
                    MockShopDCNoteShipmentMapping(def, row);
                }
                else
                {
                    row = dataSet.MockShopDCNoteShipment.NewMockShopDCNoteShipmentRow();
                    def.DCNoteShipmentId = getMaxMockShopDCNoteShipmentId() + 1;
                    MockShopDCNoteShipmentMapping(def, row);
                    dataSet.MockShopDCNoteShipment.AddMockShopDCNoteShipmentRow(row);
                }
                recordsAffected = ad.Update(dataSet);
                if (recordsAffected < 1)
                    throw new DataAccessException("Update MockShopDCNoteShipment ERROR");

                ctx.VoteCommit();
            }
            catch (Exception e)
            {
                Console.WriteLine("ERROR " + e.Message);
                ctx.VoteRollback();
                throw e;
            }
            finally
            {
                ctx.Exit();
            }
        }

        public void updateILSDiffDCNoteShipment(ILSDiffDCNoteShipmentDef def, int userId)
        {
            TransactionContext ctx = TransactionContextFactory.GetContext(TransactionAffinity.Required);
            try
            {
                ctx.Enter();
                TransactionContext currentCtx = TransactionContextFactory.GetCurrentContext();

                IDataSetAdapter ad = getDataSetAdapter("ILSDiffDCNoteShipmentApt", "GetILSDiffDCNoteShipmentByKey");
                ad.SelectCommand.Parameters["@DCNoteShipmentId"].Value = def.DCNoteShipmentId;
                ad.PopulateCommands();

                ILSDiffDCNoteShipmentDs dataSet = new ILSDiffDCNoteShipmentDs();
                ILSDiffDCNoteShipmentDs.ILSDiffDCNoteShipmentRow row = null;

                int recordsAffected = ad.Fill(dataSet);
                if (recordsAffected > 0)
                {
                    row = dataSet.ILSDiffDCNoteShipment[0];
                    ILSDiffDCNoteShipmentMapping(def, row);
                    sealStamp(row, userId, Stamp.UPDATE);
                }
                else
                {
                    row = dataSet.ILSDiffDCNoteShipment.NewILSDiffDCNoteShipmentRow();
                    def.DCNoteShipmentId = getMaxILSDiffDCNoteShipmentId() + 1;
                    ILSDiffDCNoteShipmentMapping(def, row);
                    sealStamp(row, userId, Stamp.INSERT);
                    dataSet.ILSDiffDCNoteShipment.AddILSDiffDCNoteShipmentRow(row);
                }
                recordsAffected = ad.Update(dataSet);
                if (recordsAffected < 1)
                    throw new DataAccessException("Update ILS Diff DC Note Shipment ERROR");

                ctx.VoteCommit();
            }
            catch (Exception e)
            {
                Console.WriteLine("ERROR " + e.Message);
                ctx.VoteRollback();
                throw e;
            }
            finally
            {
                ctx.Exit();
            }
        }

        public StudioDCNoteDef getStudioDCNoteByDCNoteNo(string key)
        {
            IDataSetAdapter ad = getDataSetAdapter("StudioDCNoteApt", "GetStudioDCNoteByDCNoteNo");
            ad.SelectCommand.Parameters["@DCNoteNo"].Value = key;
            ad.SelectCommand.DbCommand.CommandTimeout = 120;

            StudioDCNoteDs dataSet = new StudioDCNoteDs();
            int recordsAffected = ad.Fill(dataSet);

            if (recordsAffected < 1) return null;

            StudioDCNoteDef def = new StudioDCNoteDef();
            StudioDCNoteMapping(dataSet.StudioDCNote[0], def);

            return def;
        }

        public ArrayList getStudioCourierChargeListByDCNoteNo(string key)
        {
            IDataSetAdapter ad = getDataSetAdapter("StudioDCNoteApt", "GetCourierChargeListByDCNoteNo");
            ad.SelectCommand.Parameters["@DCNoteNo"].Value = key;
            ad.SelectCommand.DbCommand.CommandTimeout = 120;

            ArrayList list = new ArrayList();
            DataSet dataSet = new DataSet();
            int recordsAffected = ad.Fill(dataSet);

            if (recordsAffected > 0)
            {
                foreach (DataRow r in dataSet.Tables[0].Rows)
                {
                    list.Add(r[0].ToString() + "," + r[1].ToString() + "," + r[2].ToString() + "," + r[3].ToString());
                }
            }
            return list;
        }

        public void updateStudioDCNoteShipment(StudioDCNoteShipmentDef def, int userId)
        {
            TransactionContext ctx = TransactionContextFactory.GetContext(TransactionAffinity.Required);
            try
            {
                ctx.Enter();
                TransactionContext currentCtx = TransactionContextFactory.GetCurrentContext();

                IDataSetAdapter ad = getDataSetAdapter("StudioDCNoteShipmentApt", "GetStudioDCNoteShipmentByKey");
                ad.SelectCommand.Parameters["@DCNoteShipmentId"].Value = def.DCNoteShipmentId;
                ad.PopulateCommands();

                StudioDCNoteShipmentDs dataSet = new StudioDCNoteShipmentDs();
                StudioDCNoteShipmentDs.StudioDCNoteShipmentRow row = null;

                int recordsAffected = ad.Fill(dataSet);
                if (recordsAffected > 0)
                {
                    row = dataSet.StudioDCNoteShipment[0];
                    StudioDCNoteShipmentMapping(def, row);
                }
                else
                {
                    row = dataSet.StudioDCNoteShipment.NewStudioDCNoteShipmentRow();
                    def.DCNoteShipmentId = getMaxStudioDCNoteShipmentId() + 1;
                    StudioDCNoteShipmentMapping(def, row);
                    dataSet.StudioDCNoteShipment.AddStudioDCNoteShipmentRow(row);
                }
                recordsAffected = ad.Update(dataSet);
                if (recordsAffected < 1)
                    throw new DataAccessException("Update StudioDCNoteShipment ERROR");

                ctx.VoteCommit();
            }
            catch (Exception e)
            {
                Console.WriteLine("ERROR " + e.Message);
                ctx.VoteRollback();
                throw e;
            }
            finally
            {
                ctx.Exit();
            }
        }

        public void updateMockShopDCNoteShipmentDetail(MockShopDCNoteShipmentDetailDef def)
        {
            TransactionContext ctx = TransactionContextFactory.GetContext(TransactionAffinity.Required);
            try
            {
                ctx.Enter();
                TransactionContext currentCtx = TransactionContextFactory.GetCurrentContext();

                IDataSetAdapter ad = getDataSetAdapter("MockShopDCNoteShipmentDetailApt", "GetMockShopDCNoteShipmentDetailByKey");
                ad.SelectCommand.Parameters["@DCNoteShipmentDetailId"].Value = def.DCNoteShipmentDetailId;
                ad.PopulateCommands();

                MockShopDCNoteShipmentDetailDs dataSet = new MockShopDCNoteShipmentDetailDs();
                MockShopDCNoteShipmentDetailDs.MockShopDCNoteShipmentDetailRow row = null;

                int recordsAffected = ad.Fill(dataSet);
                if (recordsAffected > 0)
                {
                    row = dataSet.MockShopDCNoteShipmentDetail[0];
                    this.MockShopDCNoteShipmentDetailMapping(def, row);
                }
                else
                {
                    row = dataSet.MockShopDCNoteShipmentDetail.NewMockShopDCNoteShipmentDetailRow();
                    def.DCNoteShipmentDetailId = this.getMaxMockShopDCNoteShipmentDetailId() + 1;
                    this.MockShopDCNoteShipmentDetailMapping(def, row);
                    dataSet.MockShopDCNoteShipmentDetail.AddMockShopDCNoteShipmentDetailRow(row);
                }
                recordsAffected = ad.Update(dataSet);
                if (recordsAffected < 1)
                    throw new DataAccessException("Update MockShopDCNoteShipmentDetail ERROR");
                ctx.VoteCommit();
            }
            catch (Exception e)
            {
                Console.WriteLine("ERROR " + e.Message);
                ctx.VoteRollback();
                throw e;
            }
            finally
            {
                ctx.Exit();
            }
        }

        public void updateStudioDCNoteShipmentDetail(StudioDCNoteShipmentDetailDef def)
        {
            TransactionContext ctx = TransactionContextFactory.GetContext(TransactionAffinity.Required);
            try
            {
                ctx.Enter();
                TransactionContext currentCtx = TransactionContextFactory.GetCurrentContext();

                IDataSetAdapter ad = getDataSetAdapter("StudioDCNoteShipmentDetailApt", "GetStudioDCNoteShipmentDetailByKey");
                ad.SelectCommand.Parameters["@DCNoteShipmentDetailId"].Value = def.DCNoteShipmentDetailId;
                ad.PopulateCommands();

                StudioDCNoteShipmentDetailDs dataSet = new StudioDCNoteShipmentDetailDs();
                StudioDCNoteShipmentDetailDs.StudioDCNoteShipmentDetailRow row = null;

                int recordsAffected = ad.Fill(dataSet);
                if (recordsAffected > 0)
                {
                    row = dataSet.StudioDCNoteShipmentDetail[0];
                    this.StudioDCNoteShipmentDetailMapping(def, row);
                }
                else
                {
                    row = dataSet.StudioDCNoteShipmentDetail.NewStudioDCNoteShipmentDetailRow();
                    def.DCNoteShipmentDetailId = this.getMaxStudioDCNoteShipmentDetailId() + 1;
                    this.StudioDCNoteShipmentDetailMapping(def, row);
                    dataSet.StudioDCNoteShipmentDetail.AddStudioDCNoteShipmentDetailRow(row);
                }
                recordsAffected = ad.Update(dataSet);
                if (recordsAffected < 1)
                    throw new DataAccessException("Update StudioDCNoteShipmentDetail ERROR");
                ctx.VoteCommit();
            }
            catch (Exception e)
            {
                Console.WriteLine("ERROR " + e.Message);
                ctx.VoteRollback();
                throw e;
            }
            finally
            {
                ctx.Exit();
            }
        }

        public void updateMockShopDCNote(MockShopDCNoteDef def, int officeId, int tradingAgencyId, int userId)
        {
            TransactionContext ctx = TransactionContextFactory.GetContext(TransactionAffinity.Required);
            try
            {
                ctx.Enter();
                TransactionContext currentCtx = TransactionContextFactory.GetCurrentContext();
                MockShopDCNoteDs dataSet = new MockShopDCNoteDs();
                MockShopDCNoteDs.MockShopDCNoteRow row = null;

                IDataSetAdapter ad = getDataSetAdapter("MockShopDCNoteApt", "GetMockShopDCNoteByKey");
                ad.SelectCommand.Parameters["@DCNoteId"].Value = def.DCNoteId;
                ad.PopulateCommands();

                int recordsAffected = ad.Fill(dataSet);

                if (recordsAffected > 0)
                {
                    row = dataSet.MockShopDCNote[0];
                    MockShopDCNoteMapping(def, row);
                }
                else
                {
                    ad.SetSelectCommand("GetMaxDebitNoteId");

                    DataSet ds = new DataSet();
                    recordsAffected = ad.Fill(ds);
                    if (Convert.IsDBNull(ds.Tables[0].Rows[0][0]))
                        def.DCNoteId = 1;
                    else
                        def.DCNoteId = Convert.ToInt32(ds.Tables[0].Rows[0][0]) + 1;

                    ds.Tables.Clear();

                    ad.SetSelectCommand("GetMaxDebitNoteNo");
                    ad.SelectCommand.Parameters["@DCNoteNo"].Value = getDebitNotePrefix(officeId, tradingAgencyId, def.FiscalYear, def.Period);

                    recordsAffected = ad.Fill(ds);
                    if (Convert.IsDBNull(ds.Tables[0].Rows[0][0]))
                        def.DCNoteNo = getDebitNotePrefix(officeId, tradingAgencyId, def.FiscalYear, def.Period) + 1.ToString().PadLeft(3, '0') + "M";
                    else
                        def.DCNoteNo = getDebitNotePrefix(officeId, tradingAgencyId, def.FiscalYear, def.Period) + (Convert.ToInt32(ds.Tables[0].Rows[0][0]) + 1).ToString().PadLeft(3, '0') + "M";

                    row = dataSet.MockShopDCNote.NewMockShopDCNoteRow();
                    MockShopDCNoteMapping(def, row);
                    sealStamp(row, userId, Stamp.INSERT);
                    dataSet.MockShopDCNote.AddMockShopDCNoteRow(row);
                }

                recordsAffected = ad.Update(dataSet);
                if (recordsAffected < 1)
                    throw new DataAccessException("Update Mock Shop Debit Note ERROR");

                ctx.VoteCommit();
            }
            catch (Exception e)
            {
                Console.WriteLine("ERROR " + e.Message);
                ctx.VoteRollback();
                throw e;
            }
            finally
            {
                ctx.Exit();
            }
        }

        public void updateStudioDCNote(StudioDCNoteDef def, int officeId, int tradingAgencyId, int userId)
        {
            TransactionContext ctx = TransactionContextFactory.GetContext(TransactionAffinity.Required);
            try
            {
                ctx.Enter();
                TransactionContext currentCtx = TransactionContextFactory.GetCurrentContext();
                StudioDCNoteDs dataSet = new StudioDCNoteDs();
                StudioDCNoteDs.StudioDCNoteRow row = null;

                IDataSetAdapter ad = getDataSetAdapter("StudioDCNoteApt", "GetStudioDCNoteByKey");
                ad.SelectCommand.Parameters["@DCNoteId"].Value = def.DCNoteId;
                ad.PopulateCommands();

                int recordsAffected = ad.Fill(dataSet);

                if (recordsAffected > 0)
                {
                    row = dataSet.StudioDCNote[0];
                    StudioDCNoteMapping(def, row);
                }
                else
                {
                    ad.SetSelectCommand("GetMaxDebitNoteId");

                    DataSet ds = new DataSet();
                    recordsAffected = ad.Fill(ds);
                    if (Convert.IsDBNull(ds.Tables[0].Rows[0][0]))
                        def.DCNoteId = 1;
                    else
                        def.DCNoteId = Convert.ToInt32(ds.Tables[0].Rows[0][0]) + 1;

                    ds.Tables.Clear();

                    ad.SetSelectCommand("GetMaxDebitNoteNo");
                    ad.SelectCommand.Parameters["@DCNoteNo"].Value = getDebitNotePrefix(officeId, tradingAgencyId, def.FiscalYear, def.Period);

                    recordsAffected = ad.Fill(ds);
                    if (Convert.IsDBNull(ds.Tables[0].Rows[0][0]))
                        def.DCNoteNo = getDebitNotePrefix(officeId, tradingAgencyId, def.FiscalYear, def.Period) + 1.ToString().PadLeft(3, '0') + "X";
                    else
                        def.DCNoteNo = getDebitNotePrefix(officeId, tradingAgencyId, def.FiscalYear, def.Period) + (Convert.ToInt32(ds.Tables[0].Rows[0][0]) + 1).ToString().PadLeft(3, '0') + "X";

                    row = dataSet.StudioDCNote.NewStudioDCNoteRow();
                    StudioDCNoteMapping(def, row);
                    sealStamp(row, userId, Stamp.INSERT);
                    dataSet.StudioDCNote.AddStudioDCNoteRow(row);
                }

                recordsAffected = ad.Update(dataSet);
                if (recordsAffected < 1)
                    throw new DataAccessException("Update Studio Debit Note ERROR");

                ctx.VoteCommit();
            }
            catch (Exception e)
            {
                Console.WriteLine("ERROR " + e.Message);
                ctx.VoteRollback();
                throw e;
            }
            finally
            {
                ctx.Exit();
            }
        }

        public void deleteOutstandingILSDiffDCNoteShipment(int fiscalYear, int period, int officeId, int ilsType)
        {
            TransactionContext ctx = TransactionContextFactory.GetContext(TransactionAffinity.Required);
            try
            {
                ctx.Enter();
                TransactionContext currentCtx = TransactionContextFactory.GetCurrentContext();

                IDataSetAdapter ad = getDataSetAdapter("ILSDiffDCNoteShipmentApt", "DeleteOutstandingILSDiffDCNoteShipment");
                ad.SelectCommand.Parameters["@FiscalYear"].Value = fiscalYear;
                ad.SelectCommand.Parameters["@Period"].Value = period;
                ad.SelectCommand.Parameters["@OfficeId"].Value = officeId;
                ad.SelectCommand.Parameters["@ILSType"].Value = ilsType;
                ad.SelectCommand.ExecuteNonQuery();
                ctx.VoteCommit();
            }
            catch (Exception e)
            {
                Console.WriteLine("ERROR " + e.Message);
                ctx.VoteRollback();
                throw e;
            }
            finally
            {
                ctx.Exit();
            }
        }

        public void updateILSDiffDCNote(ILSDiffDCNoteDef def, int officeId, int userId)
        {
            TransactionContext ctx = TransactionContextFactory.GetContext(TransactionAffinity.Required);
            try
            {
                ctx.Enter();
                TransactionContext currentCtx = TransactionContextFactory.GetCurrentContext();
                ILSDiffDCNoteDs dataSet = new ILSDiffDCNoteDs();
                ILSDiffDCNoteDs.ILSDiffDCNoteRow row = null;

                IDataSetAdapter ad = getDataSetAdapter("ILSDiffDCNoteApt", "GetILSDiffDCNoteByKey");
                ad.SelectCommand.Parameters["@DCNoteId"].Value = def.DCNoteId;
                ad.PopulateCommands();

                int recordsAffected = ad.Fill(dataSet);

                if (recordsAffected > 0)
                {
                    row = dataSet.ILSDiffDCNote[0];
                    ILSDiffDCNoteMapping(def, row);
                }
                else
                {
                    ad.SetSelectCommand("GetMaxDebitNoteId");

                    DataSet ds = new DataSet();
                    recordsAffected = ad.Fill(ds);
                    if (Convert.IsDBNull(ds.Tables[0].Rows[0][0]))
                        def.DCNoteId = 1;
                    else
                        def.DCNoteId = Convert.ToInt32(ds.Tables[0].Rows[0][0]) + 1;

                    ds.Tables.Clear();

                    ad.SetSelectCommand("GetMaxDebitNoteNo");
                    ad.SelectCommand.Parameters["@DCNoteNo"].Value = def.DCNoteIndicator == "D" ? getDebitNotePrefix(officeId, 0, def.FiscalYear, def.Period)
                                                                                                : getCreditNotePrefix(officeId, 0, def.FiscalYear, def.Period);

                    recordsAffected = ad.Fill(ds);
                    if (Convert.IsDBNull(ds.Tables[0].Rows[0][0]))
                        def.DCNoteNo = def.DCNoteIndicator == "D" ? getDebitNotePrefix(officeId, 0, def.FiscalYear, def.Period) + 1.ToString().PadLeft(3, '0') + "S"
                                                                  : getCreditNotePrefix(officeId, 0, def.FiscalYear, def.Period) + 1.ToString().PadLeft(3, '0') + "S";
                    else
                        def.DCNoteNo = def.DCNoteIndicator == "D" ? getDebitNotePrefix(officeId, 0, def.FiscalYear, def.Period) + (Convert.ToInt32(ds.Tables[0].Rows[0][0]) + 1).ToString().PadLeft(3, '0') + "S"
                                                                  : getCreditNotePrefix(officeId, 0, def.FiscalYear, def.Period) + (Convert.ToInt32(ds.Tables[0].Rows[0][0]) + 1).ToString().PadLeft(3, '0') + "S";

                    row = dataSet.ILSDiffDCNote.NewILSDiffDCNoteRow();
                    ILSDiffDCNoteMapping(def, row);
                    sealStamp(row, userId, Stamp.INSERT);
                    dataSet.ILSDiffDCNote.AddILSDiffDCNoteRow(row);
                }

                recordsAffected = ad.Update(dataSet);
                if (recordsAffected < 1)
                    throw new DataAccessException("Update ILS Price Diff DC Note ERROR");

                ctx.VoteCommit();
            }
            catch (Exception e)
            {
                Console.WriteLine("ERROR " + e.Message);
                ctx.VoteRollback();
                throw e;
            }
            finally
            {
                ctx.Exit();
            }
        }

        public string getDebitNotePrefix(int officeId, int tradingAgencyId, int fiscalYear, int period)
        {
            string prefix = "";
            if (officeId == OfficeId.HK.Id)
                prefix = "HD";
            else if (officeId == OfficeId.DG.Id)
                prefix = "FD";
            else if (officeId == OfficeId.SH.Id)
                prefix = "GD";
            else if (officeId == OfficeId.TH.Id)
                prefix = "TD";
            else if (officeId == OfficeId.VN.Id)
                prefix = "VD";
            else if (officeId == OfficeId.SL.Id)
                prefix = "SD";
            else if (officeId == OfficeId.IND.Id)
                prefix = "BD";
            else if (officeId == OfficeId.ND.Id)
                prefix = "ID";
            /* As confirmed by Toby @2011-02-28, no more VM for Turkey Office.
            else if ((officeId == OfficeId.TR.Id || officeId == OfficeId.EG.Id) && (tradingAgencyId == TradingAgencyId.NSLVMOT.AgencyId || tradingAgencyId == TradingAgencyId.NSLVM.AgencyId))
                prefix = "VD";
            */
            else if (officeId == OfficeId.TR.Id)
                prefix = "KD";
            else if (officeId == OfficeId.EG.Id)
                prefix = "ED";
            else if (officeId == OfficeId.PK.Id)
                prefix = "AD";
            else if (officeId == OfficeId.BD.Id)
                prefix = "DD";
            else if (officeId == OfficeId.CA.Id)
                prefix = "CD";
            else
                prefix = "D";

            prefix += fiscalYear.ToString().Substring(2) + period.ToString().PadLeft(2, '0');

            return prefix;
        }

        public string getCreditNotePrefix(int officeId, int tradingAgencyId, int fiscalYear, int period)
        {
            string prefix = "";
            if (officeId == OfficeId.HK.Id)
                prefix = "HC";
            else if (officeId == OfficeId.DG.Id)
                prefix = "FC";
            else if (officeId == OfficeId.SH.Id)
                prefix = "GC";
            else if (officeId == OfficeId.TH.Id)
                prefix = "TC";
            else if (officeId == OfficeId.VN.Id)
                prefix = "VC";
            else if (officeId == OfficeId.SL.Id)
                prefix = "SC";
            else if (officeId == OfficeId.IND.Id)
                prefix = "BC";
            else if (officeId == OfficeId.ND.Id)
                prefix = "IC";
            /* As confirmed by Toby @2011-02-28, no more VM for Turkey Office.
            else if ((officeId == OfficeId.TR.Id || officeId == OfficeId.EG.Id) && (tradingAgencyId == TradingAgencyId.NSLVMOT.AgencyId || tradingAgencyId == TradingAgencyId.NSLVM.AgencyId))
                prefix = "VD";
            */
            else if (officeId == OfficeId.TR.Id)
                prefix = "KC";
            else if (officeId == OfficeId.EG.Id)
                prefix = "EC";
            else if (officeId == OfficeId.PK.Id)
                prefix = "AC";
            else if (officeId == OfficeId.BD.Id)
                prefix = "DC";
            else if (officeId == OfficeId.CA.Id)
                prefix = "CC";
            else
                prefix = "C";

            prefix += fiscalYear.ToString().Substring(2) + period.ToString().PadLeft(2, '0');

            return prefix;
        }

        public void updateUTContractDCNote(UTContractDCNoteDef def, int officeId, int userId)
        {
            TransactionContext ctx = TransactionContextFactory.GetContext(TransactionAffinity.Required);
            try
            {
                ctx.Enter();
                TransactionContext currentCtx = TransactionContextFactory.GetCurrentContext();
                UTContractDCNoteDs dataSet = new UTContractDCNoteDs();
                UTContractDCNoteDs.UTContractDCNoteRow row = null;

                IDataSetAdapter ad = getDataSetAdapter("UTContractDCNoteApt", "GetUTContractDCNoteByKey");
                ad.SelectCommand.Parameters["@DCNoteId"].Value = def.DCNoteId;
                ad.PopulateCommands();

                int recordsAffected = ad.Fill(dataSet);

                if (recordsAffected > 0)
                {
                    row = dataSet.UTContractDCNote[0];
                    UTContractDCNoteMapping(def, row);
                }
                else
                {
                    ad.SetSelectCommand("GetMaxDebitNoteId");

                    DataSet ds = new DataSet();
                    recordsAffected = ad.Fill(ds);
                    if (Convert.IsDBNull(ds.Tables[0].Rows[0][0]))
                        def.DCNoteId = 1;
                    else
                        def.DCNoteId = Convert.ToInt32(ds.Tables[0].Rows[0][0]) + 1;

                    ds.Tables.Clear();

                    ad.SetSelectCommand("GetMaxDebitNoteNo");
                    ad.SelectCommand.Parameters["@DCNoteNo"].Value = getDebitNotePrefix(officeId, 0, def.FiscalYear, def.Period);

                    recordsAffected = ad.Fill(ds);
                    if (Convert.IsDBNull(ds.Tables[0].Rows[0][0]))
                        def.DCNoteNo = getDebitNotePrefix(officeId, 0, def.FiscalYear, def.Period) + 1.ToString().PadLeft(3, '0') + "U";
                    else
                        def.DCNoteNo = getDebitNotePrefix(officeId, 0, def.FiscalYear, def.Period) + (Convert.ToInt32(ds.Tables[0].Rows[0][0]) + 1).ToString().PadLeft(3, '0') + "U";

                    row = dataSet.UTContractDCNote.NewUTContractDCNoteRow();
                    UTContractDCNoteMapping(def, row);
                    sealStamp(row, userId, Stamp.INSERT);
                    dataSet.UTContractDCNote.AddUTContractDCNoteRow(row);
                }

                recordsAffected = ad.Update(dataSet);
                if (recordsAffected < 1)
                    throw new DataAccessException("Update UT Contract Debit Note ERROR");

                ctx.VoteCommit();
            }
            catch (Exception e)
            {
                Console.WriteLine("ERROR " + e.Message);
                ctx.VoteRollback();
                throw e;
            }
            finally
            {
                ctx.Exit();
            }
        }

        public void updateUTContractDCNoteShipment(UTContractDCNoteShipmentDef def, int userId)
        {
            TransactionContext ctx = TransactionContextFactory.GetContext(TransactionAffinity.Required);
            try
            {
                ctx.Enter();
                TransactionContext currentCtx = TransactionContextFactory.GetCurrentContext();

                IDataSetAdapter ad = getDataSetAdapter("UTContractDCNoteShipmentApt", "GetUTContractDCNoteShipmentByKey");
                ad.SelectCommand.Parameters["@DCNoteShipmentId"].Value = def.DCNoteShipmentId;
                ad.PopulateCommands();

                UTContractDCNoteShipmentDs dataSet = new UTContractDCNoteShipmentDs();
                UTContractDCNoteShipmentDs.UTContractDCNoteShipmentRow row = null;

                int recordsAffected = ad.Fill(dataSet);
                if (recordsAffected > 0)
                {
                    row = dataSet.UTContractDCNoteShipment[0];
                    UTContractDCNoteShipmentMapping(def, row);
                }
                else
                {
                    row = dataSet.UTContractDCNoteShipment.NewUTContractDCNoteShipmentRow();
                    def.DCNoteShipmentId = getMaxUTContractDCNoteShipmentId() + 1;
                    UTContractDCNoteShipmentMapping(def, row);
                    dataSet.UTContractDCNoteShipment.AddUTContractDCNoteShipmentRow(row);
                }
                recordsAffected = ad.Update(dataSet);
                if (recordsAffected < 1)
                    throw new DataAccessException("Update UTContractDCNoteShipment ERROR");

                ctx.VoteCommit();
            }
            catch (Exception e)
            {
                Console.WriteLine("ERROR " + e.Message);
                ctx.VoteRollback();
                throw e;
            }
            finally
            {
                ctx.Exit();
            }
        }

        public UTContractDCNoteDef getUTContractDCNoteByShipmentId(int shipmentId)
        {
            IDataSetAdapter ad = getDataSetAdapter("UTContractDCNoteApt", "GetUTContractDCNoteByShipmentId");
            ad.SelectCommand.Parameters["@ShipmentId"].Value = shipmentId;
            ad.SelectCommand.DbCommand.CommandTimeout = 120;

            UTContractDCNoteDs dataSet = new UTContractDCNoteDs();
            int recordsAffected = ad.Fill(dataSet);

            if (recordsAffected < 1) return null;

            UTContractDCNoteDef def = new UTContractDCNoteDef();
            UTContractDCNoteMapping(dataSet.UTContractDCNote[0], def);

            return def;
        }

        public UTContractDCNoteDef getUTContractDCNoteByKey(int id)
        {
            IDataSetAdapter ad = getDataSetAdapter("UTContractDCNoteApt", "GetUTContractDCNoteByKey");
            ad.SelectCommand.Parameters["@DCNoteId"].Value = id;
            ad.SelectCommand.DbCommand.CommandTimeout = 120;

            UTContractDCNoteDs dataSet = new UTContractDCNoteDs();
            int recordsAffected = ad.Fill(dataSet);

            if (recordsAffected < 1) return null;

            UTContractDCNoteDef def = new UTContractDCNoteDef();
            UTContractDCNoteMapping(dataSet.UTContractDCNote[0], def);

            return def;
        }

        public UTContractDCNoteShipmentDef getUTContractDCNoteShipmentByKey(int shipmentId)
        {
            IDataSetAdapter ad = getDataSetAdapter("UTContractDCNoteShipmentApt", "GetUTContractDCNoteShipmentByKey");
            ad.SelectCommand.Parameters["@DCNoteShipmentId"].Value = shipmentId;
            ad.SelectCommand.DbCommand.CommandTimeout = 120;

            UTContractDCNoteShipmentDs dataSet = new UTContractDCNoteShipmentDs();
            int recordsAffected = ad.Fill(dataSet);

            if (recordsAffected < 1) return null;

            UTContractDCNoteShipmentDef def = new UTContractDCNoteShipmentDef();
            UTContractDCNoteShipmentMapping(dataSet.UTContractDCNoteShipment[0], def);

            return def;
        }


        public void updateQACommissionDN(QACommissionDNDef def, int officeId, int userId)
        {
            TransactionContext ctx = TransactionContextFactory.GetContext(TransactionAffinity.Required);
            try
            {
                ctx.Enter();
                TransactionContext currentCtx = TransactionContextFactory.GetCurrentContext();
                QACommissionDNDs dataSet = new QACommissionDNDs();
                QACommissionDNDs.QACommissionDNRow row = null;

                IDataSetAdapter ad = getDataSetAdapter("QACommissionDNApt", "GetQACommissionDNByKey");
                ad.SelectCommand.Parameters["@DNId"].Value = def.DNId;
                ad.PopulateCommands();

                int recordsAffected = ad.Fill(dataSet);

                if (recordsAffected > 0)
                {
                    row = dataSet.QACommissionDN[0];
                    def.CreatedBy = row.CreatedBy;
                    def.CreatedOn = row.CreatedOn;
                    QACommissionDNMapping(def, row);
                }
                else
                {
                    ad.SetSelectCommand("GetMaxDebitNoteId");

                    DataSet ds = new DataSet();
                    recordsAffected = ad.Fill(ds);
                    if (Convert.IsDBNull(ds.Tables[0].Rows[0][0]))
                        def.DNId = 1;
                    else
                        def.DNId = Convert.ToInt32(ds.Tables[0].Rows[0][0]) + 1;

                    ds.Tables.Clear();

                    ad.SetSelectCommand("GetMaxDebitNoteNo");
                    ad.SelectCommand.Parameters["@DNNo"].Value = getDebitNotePrefix(officeId, 0, def.FiscalYear, def.Period);

                    recordsAffected = ad.Fill(ds);
                    if (Convert.IsDBNull(ds.Tables[0].Rows[0][0]))
                        def.DNNo = getDebitNotePrefix(officeId, 0, def.FiscalYear, def.Period) + 1.ToString().PadLeft(3, '0') + "Q";
                    else
                        def.DNNo = getDebitNotePrefix(officeId, 0, def.FiscalYear, def.Period) + (Convert.ToInt32(ds.Tables[0].Rows[0][0]) + 1).ToString().PadLeft(3, '0') + "Q";

                    row = dataSet.QACommissionDN.NewQACommissionDNRow();

                    QACommissionDNMapping(def, row);
                    sealStamp(row, userId, Stamp.INSERT);
                    dataSet.QACommissionDN.AddQACommissionDNRow(row);
                }

                recordsAffected = ad.Update(dataSet);
                if (recordsAffected < 1)
                    throw new DataAccessException("Update QACommissionDN ERROR");

                ctx.VoteCommit();
            }
            catch (Exception e)
            {
                Console.WriteLine("ERROR " + e.Message);
                ctx.VoteRollback();
                throw e;
            }
            finally
            {
                ctx.Exit();
            }
        }

        public void updateQACommissionDNShipment(QACommissionDNShipmentDef def, int userId)
        {
            TransactionContext ctx = TransactionContextFactory.GetContext(TransactionAffinity.Required);
            try
            {
                ctx.Enter();
                TransactionContext currentCtx = TransactionContextFactory.GetCurrentContext();

                IDataSetAdapter ad = getDataSetAdapter("QACommissionDNShipmentApt", "GetQACommissionDNShipmentByKey");
                ad.SelectCommand.Parameters["@ShipmentId"].Value = def.ShipmentId;
                ad.PopulateCommands();

                QACommissionDNShipmentDs dataSet = new QACommissionDNShipmentDs();
                QACommissionDNShipmentDs.QACommissionDNShipmentRow row = null;

                int recordsAffected = ad.Fill(dataSet);
                if (recordsAffected > 0)
                {
                    row = dataSet.QACommissionDNShipment[0];
                    def.CreatedBy = row.CreatedBy;
                    def.CreatedOn = row.CreatedOn;
                    QACommissionDNShipmentMapping(def, row);
                }
                else
                {
                    row = dataSet.QACommissionDNShipment.NewQACommissionDNShipmentRow();
                    QACommissionDNShipmentMapping(def, row);
                    sealStamp(row, userId, Stamp.INSERT);
                    dataSet.QACommissionDNShipment.AddQACommissionDNShipmentRow(row);
                }
                recordsAffected = ad.Update(dataSet);
                if (recordsAffected < 1)
                    throw new DataAccessException("Update QACommissionDNShipment ERROR");

                ctx.VoteCommit();
            }
            catch (Exception e)
            {
                Console.WriteLine("ERROR " + e.Message);
                ctx.VoteRollback();
                throw e;
            }
            finally
            {
                ctx.Exit();
            }
        }

        public QACommissionDNDef getQACommissionDCNoteByKey(int id)
        {
            IDataSetAdapter ad = getDataSetAdapter("QACommissionDNApt", "GetQACommissionDNByKey");
            ad.SelectCommand.Parameters["@DNId"].Value = id;
            ad.SelectCommand.DbCommand.CommandTimeout = 120;

            QACommissionDNDs dataSet = new QACommissionDNDs();
            int recordsAffected = ad.Fill(dataSet);

            if (recordsAffected < 1) return null;

            QACommissionDNDef def = new QACommissionDNDef();
            QACommissionDNMapping(dataSet.QACommissionDN[0], def);

            return def;
        }

        public QACommissionDNDef getQACommissionDNByShipmentId(int shipmentId)
        {
            IDataSetAdapter ad = getDataSetAdapter("QACommissionDNApt", "GetQACommissionDNByShipmentId");
            ad.SelectCommand.Parameters["@ShipmentId"].Value = shipmentId;
            ad.SelectCommand.DbCommand.CommandTimeout = 120;

            QACommissionDNDs dataSet = new QACommissionDNDs();
            int recordsAffected = ad.Fill(dataSet);

            if (recordsAffected < 1) return null;

            QACommissionDNDef def = new QACommissionDNDef();
            QACommissionDNMapping(dataSet.QACommissionDN[0], def);

            return def;
        }

        public QACommissionDNShipmentDef getQACommissionDNShipmentByKey(int shipmentId)
        {
            IDataSetAdapter ad = getDataSetAdapter("QACommissionDNShipmentApt", "GetQACommissionDNShipmentByKey");
            ad.SelectCommand.Parameters["@ShipmentId"].Value = shipmentId;
            ad.SelectCommand.DbCommand.CommandTimeout = 120;

            QACommissionDNShipmentDs dataSet = new QACommissionDNShipmentDs();
            int recordsAffected = ad.Fill(dataSet);

            if (recordsAffected < 1) return null;

            QACommissionDNShipmentDef def = new QACommissionDNShipmentDef();
            QACommissionDNShipmentMapping(dataSet.QACommissionDNShipment[0], def);

            return def;
        }

        public ArrayList getQACommissionDNShipmentByDNId(int id)
        {
            IDataSetAdapter ad = getDataSetAdapter("QACommissionDNShipmentApt", "GetQACommissionDNShipmentList");
            ad.SelectCommand.Parameters["@DNId"].Value = id;
            ad.SelectCommand.DbCommand.CommandTimeout = 120;

            QACommissionDNShipmentDs dataSet = new QACommissionDNShipmentDs();
            int recordsAffected = ad.Fill(dataSet);

            ArrayList list = new ArrayList();

            foreach (QACommissionDNShipmentDs.QACommissionDNShipmentRow row in dataSet.QACommissionDNShipment)
            {
                QACommissionDNShipmentDef def = new QACommissionDNShipmentDef();
                QACommissionDNShipmentMapping(row, def);
                list.Add(def);
            }

            return list;
        }


        public ArrayList getOutstandingQACommissionDNShipmentList(int officeId, int fiscalYear, int period)
        {
            IDataSetAdapter ad = getDataSetAdapter("QACommissionDNShipmentApt", "GetOutstandingQACommissionDNShipmentList");
            ad.SelectCommand.Parameters["@officeId"].Value = officeId;
            ad.SelectCommand.Parameters["@fiscalYear"].Value = fiscalYear;
            ad.SelectCommand.Parameters["@period"].Value = period;
            ad.SelectCommand.DbCommand.CommandTimeout = 120;

            QACommissionDNShipmentDs dataSet = new QACommissionDNShipmentDs();
            int recordsAffected = ad.Fill(dataSet);

            ArrayList list = new ArrayList();

            foreach (QACommissionDNShipmentDs.QACommissionDNShipmentRow row in dataSet.QACommissionDNShipment)
            {
                QACommissionDNShipmentDef def = new QACommissionDNShipmentDef();
                QACommissionDNShipmentMapping(row, def);
                list.Add(def);
            }
            return list;
        }

        public SettlementBankDetailDef getSettlementBankDetail(int officeId, int currencyId, int tradingAgencyId)
        {
            IDataSetAdapter ad = getDataSetAdapter("SettlementBankDetailApt", "GetSettlementBankDetail");
            ad.SelectCommand.Parameters["@OfficeId"].Value = officeId.ToString();
            ad.SelectCommand.Parameters["@CurrencyId"].Value = currencyId;
            ad.SelectCommand.Parameters["@TradingAgencyId"].Value = tradingAgencyId.ToString();
            ad.SelectCommand.DbCommand.CommandTimeout = 120;
            ad.SelectCommand.MailSQL = true;

            SettlementBankDetailDs dataSet = new SettlementBankDetailDs();
            int recordsAffected = ad.Fill(dataSet);

            if (recordsAffected < 1) return null;

            SettlementBankDetailDef def = new SettlementBankDetailDef();
            SettlementBankDetailMapping(dataSet.SettlementBankDetail[0], def);

            return def;
        }

        public ArrayList getOutstandingILSDiffList(int officeId, int fiscalYear, int period)
        {
            IDataSetAdapter ad = getDataSetAdapter("ILSDiffDCNoteApt", "GetOutstandingILSDiffList");
            ad.SelectCommand.Parameters["@officeId"].Value = officeId;
            ad.SelectCommand.Parameters["@fiscalYear"].Value = fiscalYear;
            ad.SelectCommand.Parameters["@period"].Value = period;

            ad.SelectCommand.DbCommand.CommandTimeout = 120;

            ILSDiffDCNoteDs dataSet = new ILSDiffDCNoteDs();
            int recordsAffected = ad.Fill(dataSet);

            if (recordsAffected < 1) return null;

            ArrayList list = new ArrayList();

            foreach (ILSDiffDCNoteDs.ILSDiffDCNoteRow row in dataSet.ILSDiffDCNote)
            {
                ILSDiffDCNoteDef def = new ILSDiffDCNoteDef();
                ILSDiffDCNoteMapping(row, def);
                list.Add(def);
            }
            return list;
        }

        public ArrayList getOutstandingILSDiffShipmentList(int officeId, int fiscalYear, int period)
        {
            IDataSetAdapter ad = getDataSetAdapter("ILSDiffDCNoteShipmentApt", "GetOutstandingILSDiffShipmentList");
            ad.SelectCommand.Parameters["@officeId"].Value = officeId;
            ad.SelectCommand.Parameters["@fiscalYear"].Value = fiscalYear;
            ad.SelectCommand.Parameters["@period"].Value = period;
            ad.SelectCommand.DbCommand.CommandTimeout = 120;

            ILSDiffDCNoteShipmentDs dataSet = new ILSDiffDCNoteShipmentDs();
            int recordsAffected = ad.Fill(dataSet);

            ArrayList list = new ArrayList();

            foreach (ILSDiffDCNoteShipmentDs.ILSDiffDCNoteShipmentRow row in dataSet.ILSDiffDCNoteShipment)
            {
                ILSDiffDCNoteShipmentDef def = new ILSDiffDCNoteShipmentDef();
                ILSDiffDCNoteShipmentMapping(row, def);
                list.Add(def);
            }
            return list;
        }

        #region mapping functions

        internal void LogoInterfaceRequestMapping(Object source, Object target)
        {
            if (source.GetType() == typeof(LogoInterfaceRequestDs.LogoInterfaceRequestRow) &&
                target.GetType() == typeof(LogoInterfaceRequestDef))
            {
                LogoInterfaceRequestDs.LogoInterfaceRequestRow row = (LogoInterfaceRequestDs.LogoInterfaceRequestRow)source;
                LogoInterfaceRequestDef def = (LogoInterfaceRequestDef)target;

                def.RequestId = row.RequestId;
                def.Office = generalWorker.getOfficeRefByKey(row.OfficeId);
                def.FiscalYear = row.FiscalYear;
                def.Period = row.Period;
                def.SubmitUser = generalWorker.getUserByKey(row.CreatedBy);
                def.SubmitTime = row.CreatedOn;
            }
            else if (source.GetType() == typeof(LogoInterfaceRequestDef) &&
                target.GetType() == typeof(LogoInterfaceRequestDs.LogoInterfaceRequestRow))
            {
                LogoInterfaceRequestDef def = (LogoInterfaceRequestDef)source;
                LogoInterfaceRequestDs.LogoInterfaceRequestRow row = (LogoInterfaceRequestDs.LogoInterfaceRequestRow)target;

                row.RequestId = def.RequestId;
                row.OfficeId = def.Office.OfficeId;
                row.FiscalYear = def.FiscalYear;
                row.Period = def.Period;

                row.CreatedOn = def.SubmitTime;
                row.CreatedBy = def.SubmitUser.UserId;

                row.Status = GeneralStatus.ACTIVE.Code;
            }
        }

        internal void SunInterfaceQueueMapping(Object source, Object target)
        {
            if (source.GetType() == typeof(SunInterfaceQueueDs.SunInterfaceQueueRow) &&
                target.GetType() == typeof(SunInterfaceQueueDef))
            {
                SunInterfaceQueueDs.SunInterfaceQueueRow row = (SunInterfaceQueueDs.SunInterfaceQueueRow)source;
                SunInterfaceQueueDef def = (SunInterfaceQueueDef)target;

                def.QueueId = row.QueueId;
                def.OfficeGroup = commonWorker.getReportOfficeGroupByKey(row.OfficeId);
                def.SunInterfaceTypeId = row.SunInterfaceTypeId;
                def.CategoryType = CategoryType.getType(row.CategoryId);
                def.PurchaseTerm = row.PurchaseTerm;
                def.UTurn = row.UTurn;
                def.FiscalYear = row.FiscalYear;
                def.Period = row.Period;
                def.User = generalWorker.getUserByKey(row.UserId);
                def.SourceId = row.SourceId;
                if (!row.IsJournalNoNull())
                    def.JournalNo = row.JournalNo;
                else
                    def.JournalNo = String.Empty;
                def.SubmitTime = row.SubmitTime;
                if (!row.IsCompletedTimeNull())
                    def.CompleteTime = row.CompletedTime;
                def.Status = row.Status;
            }
            else if (source.GetType() == typeof(SunInterfaceQueueDef) &&
                target.GetType() == typeof(SunInterfaceQueueDs.SunInterfaceQueueRow))
            {
                SunInterfaceQueueDef def = (SunInterfaceQueueDef)source;
                SunInterfaceQueueDs.SunInterfaceQueueRow row = (SunInterfaceQueueDs.SunInterfaceQueueRow)target;

                row.QueueId = def.QueueId;
                row.OfficeId = def.OfficeGroup.OfficeGroupId;
                row.SunInterfaceTypeId = def.SunInterfaceTypeId;
                row.CategoryId = def.CategoryType.Id;
                row.PurchaseTerm = def.PurchaseTerm;
                row.UTurn = def.UTurn;
                row.FiscalYear = def.FiscalYear;
                row.Period = def.Period;
                row.UserId = def.User.UserId;
                row.SourceId = def.SourceId;
                if (def.JournalNo != String.Empty)
                    row.JournalNo = def.JournalNo;
                else
                    row.SetJournalNoNull();
                row.SubmitTime = def.SubmitTime;
                if (def.CompleteTime != DateTime.MinValue)
                    row.CompletedTime = def.CompleteTime;
                else
                    row.SetCompletedTimeNull();
                row.Status = def.Status;
            }
        }

        public void SunInterfaceLogMapping(Object source, Object target)
        {
            if (source.GetType() == typeof(SunInterfaceLogDs.SunInterfaceLogRow) &&
                target.GetType() == typeof(SunInterfaceLogDef))
            {
                SunInterfaceLogDs.SunInterfaceLogRow row = (SunInterfaceLogDs.SunInterfaceLogRow)source;
                SunInterfaceLogDef def = (SunInterfaceLogDef)target;

                def.SunInterfaceLogId = row.SunInterfaceLogId;
                def.SunInterfaceTypeId = row.SunInterfaceTypeId;
                def.ShipmentId = row.ShipmentId;
                def.SplitShipmentId = row.SplitShipmentId;
                def.FiscalYear = row.FiscalYear;
                def.Period = row.Period;
                def.TransactionDate = row.TransactionDate;
                def.ContractNo = row.ContractNo;
                def.NSLPONo = row.NSLPONo;
                def.DeliveryNo = row.DeliveryNo;
                def.OfficeId = row.OfficeId;
                def.DeptId = row.DeptId;
                def.ProductTeamId = row.ProductTeamId;
                def.ProductId = row.ProductId;
                def.SeasonId = row.SeasonId;
                def.VendorId = row.VendorId;
                def.CustomerId = row.CustomerId;
                def.TermOfPurchaseId = row.TermOfPurchaseId;
                def.CustomerDestinationId = row.CustomerDestinationId;
                def.TradingAgencyId = row.TradingAgencyId;
                def.CurrencyId = row.CurrencyId;
                def.PaymentTermId = row.PaymentTermId;
                def.CountryOfOriginId = row.CountryOfOriginId;
                def.DesignSourceId = row.DesignSourceId;
                def.WithOPRFabric = row.WithOPRFabric;
                if (!row.IsInvoicePrefixNull())
                    def.InvoicePrefix = row.InvoicePrefix;
                else
                    def.InvoicePrefix = String.Empty;
                if (!row.IsInvoiceSeqNull())
                    def.InvoiceSequence = row.InvoiceSeq;
                else
                    def.InvoiceSequence = 0;
                if (!row.IsInvoiceYearNull())
                    def.InvoiceYear = row.InvoiceYear;
                else
                    def.InvoiceYear = 0;
                if (!row.IsSequenceNoNull())
                    def.SequenceNo = row.SequenceNo;
                else
                    def.SequenceNo = 0;
                if (!row.IsInvoiceUploadDateNull())
                    def.InvoiceUploadDate = row.InvoiceUploadDate;
                else
                    def.InvoiceUploadDate = DateTime.MinValue;
                def.BaseAmount = row.BaseAmt;
                def.OtherAmount = row.OtherAmt;
                def.Quantity = row.Qty;
                def.PiecesPerPack = row.PiecesPerPack;
                def.PackingUnitId = row.PackingUnitId;
                if (!row.IsSupplierInvoiceNoNull())
                    def.SupplierInvoiceNo = row.SupplierInvoiceNo.ToUpper();
                else
                    def.SupplierInvoiceNo = String.Empty;
                if (!row.IsRefNoNull())
                    def.ReferenceNo = row.RefNo;
                else
                    def.ReferenceNo = String.Empty;
                if (!row.IsDCNoteNoNull())
                    def.DebitCreditNoteNo = row.DCNoteNo;
                else
                    def.DebitCreditNoteNo = String.Empty;
                def.BaseTax = row.BaseTax;
                def.OtherTax = row.OtherTax;
                def.SetSplitCount = row.SetSplitCount;
                def.QACommissionPercent = row.QACommissionPercent;
                def.VendorPaymentDiscountPercent = row.VendorPaymentDiscountPercent;
                def.LabTestIncome = row.LabTestIncome;
                def.SalesCommission = row.SalesCommission;
                def.TotalShippedAmount = row.TotalShippedAmt;
                def.TotalShippedNetFOBAmount = row.TotalShippedNetFOBAmt;
                def.TotalShippedSupplierGmtAmount = row.TotalShippedSupplierGmtAmt;
                def.UTInputVATAmount = row.UTInputVATAmt;
                def.UTOutputVATAmount = row.UTOutputVATAmt;
                def.UTImportDuty = row.UTImportDuty;
                def.UTImportDutyInBaseCurrency = row.UTImportDutyInBaseCurrency;
                def.UTTotalShippedAmount = row.UTTotalShippedAmt;
                def.UTTotalShippedNetFOBAmount = row.UTTotalShippedNetFOBAmt;
                def.UTTotalShippedSupplierGmtAmount = row.UTTotalShippedSupplierGmtAmt;
                def.UTSalesCommission = row.UTSalesCommission;
                def.IsNextManufacturingOrder = row.IsNextMfgOrder;
                def.IsPOIssueToNextManufacturing = row.IsPOIssueToNextMfg;
                def.IsMockShopSample = row.IsMockShopSample;
                def.IsStudioSample = row.IsStudioSample;
                def.IsSelfBilledOrder = row.IsSelfBilledOrder;
                def.CategoryId = row.CategoryId;
                def.FullBaseAmount = row.FullBaseAmt;
                def.FullOtherAmount = row.FullOtherAmt;
                def.FullBaseTax = row.FullBaseTax;
                def.FullOtherTax = row.FullOtherTax;
                def.FullQuantity = row.FullQty;
                if (!row.IsUKSupplierCodeNull())
                    def.UKSupplierCode = row.UKSupplierCode;
                else
                    def.UKSupplierCode = String.Empty;
                def.IsReversalEntry = row.IsReversalEntry;
                def.QueueId = row.QueueId;
                def.CreatedOn = row.CreatedOn;
            }
            else if (source.GetType() == typeof(SunInterfaceLogDef) &&
                target.GetType() == typeof(SunInterfaceLogDs.SunInterfaceLogRow))
            {
                SunInterfaceLogDef def = (SunInterfaceLogDef)source;
                SunInterfaceLogDs.SunInterfaceLogRow row = (SunInterfaceLogDs.SunInterfaceLogRow)target;

                row.SunInterfaceLogId = def.SunInterfaceLogId;
                row.SunInterfaceTypeId = def.SunInterfaceTypeId;
                row.ShipmentId = def.ShipmentId;
                row.SplitShipmentId = def.SplitShipmentId;
                row.FiscalYear = def.FiscalYear;
                row.Period = def.Period;
                row.TransactionDate = def.TransactionDate;
                row.ContractNo = def.ContractNo;
                row.NSLPONo = def.NSLPONo;
                row.DeliveryNo = def.DeliveryNo;
                row.OfficeId = def.OfficeId;
                row.DeptId = def.DeptId;
                row.ProductTeamId = def.ProductTeamId;
                row.ProductId = def.ProductId;
                row.SeasonId = def.SeasonId;
                row.VendorId = def.VendorId;
                row.CustomerId = def.CustomerId;
                row.TermOfPurchaseId = def.TermOfPurchaseId;
                row.CustomerDestinationId = def.CustomerDestinationId;
                row.TradingAgencyId = def.TradingAgencyId;
                row.CurrencyId = def.CurrencyId;
                row.PaymentTermId = def.PaymentTermId;
                row.CountryOfOriginId = def.CountryOfOriginId;
                row.DesignSourceId = def.DesignSourceId;
                row.WithOPRFabric = def.WithOPRFabric;
                if (def.InvoicePrefix != String.Empty)
                    row.InvoicePrefix = def.InvoicePrefix;
                else
                    row.SetInvoicePrefixNull();
                if (def.InvoiceSequence != 0)
                    row.InvoiceSeq = def.InvoiceSequence;
                else
                    row.SetInvoiceSeqNull();
                if (def.InvoiceYear != 0)
                    row.InvoiceYear = def.InvoiceYear;
                else
                    row.SetInvoiceYearNull();
                if (def.SequenceNo != 0)
                    row.SequenceNo = def.SequenceNo;
                else
                    row.SetSequenceNoNull();
                if (def.InvoiceUploadDate != DateTime.MinValue)
                    row.InvoiceUploadDate = def.InvoiceUploadDate;
                else
                    row.SetInvoiceUploadDateNull();
                row.BaseAmt = def.BaseAmount;
                row.OtherAmt = def.OtherAmount;
                row.Qty = def.Quantity;
                row.PiecesPerPack = def.PiecesPerPack;
                row.PackingUnitId = def.PackingUnitId;
                if (def.SupplierInvoiceNo != String.Empty)
                    row.SupplierInvoiceNo = def.SupplierInvoiceNo.ToUpper();
                else
                    row.SetSupplierInvoiceNoNull();
                if (def.ReferenceNo != String.Empty)
                    row.RefNo = def.ReferenceNo;
                else
                    row.SetRefNoNull();
                if (def.DebitCreditNoteNo != String.Empty)
                    row.DCNoteNo = def.DebitCreditNoteNo;
                else
                    row.SetDCNoteNoNull();
                row.BaseTax = def.BaseTax;
                row.OtherTax = def.OtherTax;
                row.SetSplitCount = def.SetSplitCount;
                row.QACommissionPercent = def.QACommissionPercent;
                row.VendorPaymentDiscountPercent = def.VendorPaymentDiscountPercent;
                row.LabTestIncome = def.LabTestIncome;
                row.SalesCommission = def.SalesCommission;
                row.TotalShippedAmt = def.TotalShippedAmount;
                row.TotalShippedNetFOBAmt = def.TotalShippedNetFOBAmount;
                row.TotalShippedSupplierGmtAmt = def.TotalShippedSupplierGmtAmount;
                row.UTInputVATAmt = def.UTInputVATAmount;
                row.UTOutputVATAmt = def.UTOutputVATAmount;
                row.UTImportDuty = def.UTImportDuty;
                row.UTImportDutyInBaseCurrency = def.UTImportDutyInBaseCurrency;
                row.UTTotalShippedAmt = def.UTTotalShippedAmount;
                row.UTTotalShippedNetFOBAmt = def.UTTotalShippedNetFOBAmount;
                row.UTTotalShippedSupplierGmtAmt = def.UTTotalShippedSupplierGmtAmount;
                row.UTSalesCommission = def.UTSalesCommission;
                row.IsNextMfgOrder = def.IsNextManufacturingOrder;
                row.IsPOIssueToNextMfg = def.IsPOIssueToNextManufacturing;
                row.IsMockShopSample = def.IsMockShopSample;
                row.IsStudioSample = def.IsStudioSample;
                row.IsSelfBilledOrder = def.IsSelfBilledOrder;
                row.CategoryId = def.CategoryId;
                row.FullBaseAmt = def.FullBaseAmount;
                row.FullOtherAmt = def.FullOtherAmount;
                row.FullBaseTax = def.FullBaseTax;
                row.FullOtherTax = def.FullOtherTax;
                row.FullQty = def.FullQuantity;
                if (def.UKSupplierCode == String.Empty)
                    row.SetUKSupplierCodeNull();
                else
                    row.UKSupplierCode = def.UKSupplierCode;
                row.IsReversalEntry = def.IsReversalEntry;
                row.QueueId = def.QueueId;
                row.CreatedOn = def.CreatedOn;
            }
        }

        private void AdjustmentNoteMapping(Object source, Object target)
        {
            if (source.GetType() == typeof(AdjustmentNoteDs.AdjustmentNoteRow) &&
                target.GetType() == typeof(AdjustmentNoteDef))
            {
                AdjustmentNoteDs.AdjustmentNoteRow row = (AdjustmentNoteDs.AdjustmentNoteRow)source;
                AdjustmentNoteDef def = (AdjustmentNoteDef)target;

                def.AdjustmentNoteId = row.AdjustmentNoteId;
                def.AdjustmentNoteNo = row.AdjustmentNoteNo;
                def.OfficeId = row.OfficeId;
                def.AdjustmentType = AdjustmentType.getType(row.AdjustmentTypeId);
                def.DebitCreditIndicator = row.DebitCreditIndicator;
                def.IssueDate = row.IssueDate;
                def.CurrencyId = row.CurrencyId;
                if (!row.IsRevisedCurrencyIdNull())
                    def.RevisedCurrencyId = row.RevisedCurrencyId;
                else
                    def.RevisedCurrencyId = -1;
                if (!row.IsVendorIdNull())
                    def.VendorId = row.VendorId;
                else
                    def.VendorId = -1;
                if (!row.IsPartyNameNull())
                    def.PartyName = row.PartyName;
                else
                    def.PartyName = String.Empty;
                if (!row.IsPartyAddress1Null())
                    def.PartyAddress1 = row.PartyAddress1;
                else
                    def.PartyAddress1 = String.Empty;
                if (!row.IsPartyAddress2Null())
                    def.PartyAddress2 = row.PartyAddress2;
                else
                    def.PartyAddress2 = String.Empty;
                if (!row.IsPartyAddress3Null())
                    def.PartyAddress3 = row.PartyAddress3;
                else
                    def.PartyAddress3 = String.Empty;
                if (!row.IsPartyAddress4Null())
                    def.PartyAddress4 = row.PartyAddress4;
                else
                    def.PartyAddress4 = String.Empty;
                def.Amount = row.Amount;
                if (!row.IsMailStatusNull())
                    def.MailStatus = row.MailStatus;
                else
                    def.MailStatus = 0;
                def.CreatedOn = row.CreatedOn;
            }
            else if (source.GetType() == typeof(AdjustmentNoteDef) &&
                target.GetType() == typeof(AdjustmentNoteDs.AdjustmentNoteRow))
            {
                AdjustmentNoteDef def = (AdjustmentNoteDef)source;
                AdjustmentNoteDs.AdjustmentNoteRow row = (AdjustmentNoteDs.AdjustmentNoteRow)target;

                row.AdjustmentNoteId = def.AdjustmentNoteId;
                row.AdjustmentNoteNo = def.AdjustmentNoteNo;
                row.OfficeId = def.OfficeId;
                row.AdjustmentTypeId = def.AdjustmentType.Id;
                row.DebitCreditIndicator = def.DebitCreditIndicator;
                row.IssueDate = def.IssueDate;
                row.CurrencyId = def.CurrencyId;
                if (def.RevisedCurrencyId != -1)
                    row.RevisedCurrencyId = def.RevisedCurrencyId;
                else
                    row.SetRevisedCurrencyIdNull();
                if (def.VendorId != -1)
                    row.VendorId = def.VendorId;
                else
                    row.SetVendorIdNull();
                if (def.PartyName != String.Empty)
                    row.PartyName = def.PartyName;
                else
                    row.SetPartyNameNull();
                if (def.PartyAddress1 != String.Empty)
                    row.PartyAddress1 = def.PartyAddress1;
                else
                    row.SetPartyAddress1Null();
                if (def.PartyAddress2 != String.Empty)
                    row.PartyAddress2 = def.PartyAddress2;
                else
                    row.SetPartyAddress2Null();
                if (def.PartyAddress3 != String.Empty)
                    row.PartyAddress3 = def.PartyAddress3;
                else
                    row.SetPartyAddress3Null();
                if (def.PartyAddress4 != String.Empty)
                    row.PartyAddress4 = def.PartyAddress4;
                else
                    row.SetPartyAddress4Null();
                row.Amount = def.Amount;
                if (def.MailStatus != int.MinValue)
                    row.MailStatus = def.MailStatus;
                else
                    row.SetMailStatusNull();
            }
        }

        private void AdjustmentDetailMapping(Object source, Object target)
        {
            if (source.GetType() == typeof(AdjustmentDetailDs.AdjustmentDetailRow) &&
                target.GetType() == typeof(AdjustmentDetailDef))
            {
                AdjustmentDetailDs.AdjustmentDetailRow row = (AdjustmentDetailDs.AdjustmentDetailRow)source;
                AdjustmentDetailDef def = (AdjustmentDetailDef)target;

                def.AdjustmentDetailId = row.AdjustmentDetailId;
                def.ShipmentId = row.ShipmentId;
                def.SplitShipmentId = row.SplitShipmentId;
                def.AdjustmentType = AdjustmentType.getType(row.AdjustmentTypeId);
                def.DebitCreditIndicator = row.DebitCreditIndicator;
                if (!row.IsVendorIdNull())
                    def.VendorId = row.VendorId;
                else
                    def.VendorId = -1;
                def.Currency = generalWorker.getCurrencyByKey(row.CurrencyId);
                def.LatestAmount = row.LatestAmt;
                def.SettledAmount = row.SettledAmt;
                def.AdjustmentAmount = row.AdjustmentAmt;
                if (!row.IsAdjustmentNoteIdNull())
                    def.AdjustmentNoteId = row.AdjustmentNoteId;
                else
                    def.AdjustmentNoteId = -1;
                def.QACommissionPercent = row.QACommissionPercent;
                def.QACommissionAmount = row.QACommissionAmt;
                def.VendorPaymentDiscountPercent = row.VendorPaymentDiscountPercent;
                def.VendorPaymentDiscountAmount = row.VendorPaymentDiscountAmt;
                def.LabTestIncome = row.LabTestIncome;
                def.IsInterfaced = row.IsInterfaced;
            }
            else if (source.GetType() == typeof(AdjustmentDetailDef) &&
                target.GetType() == typeof(AdjustmentDetailDs.AdjustmentDetailRow))
            {
                AdjustmentDetailDef def = (AdjustmentDetailDef)source;
                AdjustmentDetailDs.AdjustmentDetailRow row = (AdjustmentDetailDs.AdjustmentDetailRow)target;

                row.AdjustmentDetailId = def.AdjustmentDetailId;
                row.ShipmentId = def.ShipmentId;
                row.SplitShipmentId = def.SplitShipmentId;
                row.AdjustmentTypeId = def.AdjustmentType.Id;
                row.DebitCreditIndicator = def.DebitCreditIndicator;
                if (def.VendorId != -1)
                    row.VendorId = def.VendorId;
                else
                    row.SetVendorIdNull();
                row.CurrencyId = def.Currency.CurrencyId;
                row.LatestAmt = def.LatestAmount;
                row.SettledAmt = def.SettledAmount;
                row.AdjustmentAmt = def.AdjustmentAmount;
                if (def.AdjustmentNoteId != -1)
                    row.AdjustmentNoteId = def.AdjustmentNoteId;
                else
                    row.SetAdjustmentNoteIdNull();
                row.QACommissionPercent = def.QACommissionPercent;
                row.QACommissionAmt = def.QACommissionAmount;
                row.VendorPaymentDiscountPercent = def.VendorPaymentDiscountPercent;
                row.VendorPaymentDiscountAmt = def.VendorPaymentDiscountAmount;
                row.LabTestIncome = def.LabTestIncome;
                row.IsInterfaced = def.IsInterfaced;
            }
        }

        internal void BankReconciliationRequestMapping(Object source, Object target)
        {
            if (source.GetType() == typeof(BankReconciliationRequestDs.BankReconciliationRequestRow) &&
                target.GetType() == typeof(BankReconciliationRequestDef))
            {
                BankReconciliationRequestDs.BankReconciliationRequestRow row = (BankReconciliationRequestDs.BankReconciliationRequestRow)source;
                BankReconciliationRequestDef def = (BankReconciliationRequestDef)target;

                def.RequestId = row.RequestId;
                def.FileName = row.FileName;
                def.Bank = row.Bank;
                def.SunDB = row.SunDB;
                def.SubmitUser = generalWorker.getUserByKey(row.SubmitUserId);
                def.SubmitDate = row.SubmitDate;
                if (!row.IsProcessDateNull())
                    def.ProcessDate = row.ProcessDate;
                else
                    def.ProcessDate = DateTime.MinValue;
                def.Status = row.Status;
            }
            else if (source.GetType() == typeof(BankReconciliationRequestDef) &&
                target.GetType() == typeof(BankReconciliationRequestDs.BankReconciliationRequestRow))
            {
                BankReconciliationRequestDef def = (BankReconciliationRequestDef)source;
                BankReconciliationRequestDs.BankReconciliationRequestRow row = (BankReconciliationRequestDs.BankReconciliationRequestRow)target;

                row.RequestId = def.RequestId;
                row.FileName = def.FileName;
                row.Bank = def.Bank;
                row.SunDB = def.SunDB;
                row.SubmitUserId = def.SubmitUser.UserId;
                row.SubmitDate = def.SubmitDate;
                if (def.ProcessDate != DateTime.MinValue)
                    row.ProcessDate = def.ProcessDate;
                else
                    row.SetProcessDateNull();
                row.Status = def.Status;
            }
        }

        private void EInvoiceBatchMapping(Object source, Object target)
        {
            if (source.GetType() == typeof(EInvoiceBatchDs.eInvoiceBatchRow) && target.GetType() == typeof(EInvoiceBatchDef))
            {
                EInvoiceBatchDs.eInvoiceBatchRow row = (EInvoiceBatchDs.eInvoiceBatchRow)source;
                EInvoiceBatchDef def = (EInvoiceBatchDef)target;

                def.EInvoiceBatchId = row.eInvoiceBatchId;
                def.EInvoiceBatchNo = row.eInvoiceBatchNo;
                def.SubmittedBy = generalWorker.getUserByKey(row.SubmittedBy);
                def.SubmittedOn = row.SubmittedOn;

            }
            else if (source.GetType() == typeof(EInvoiceBatchDef) && target.GetType() == typeof(EInvoiceBatchDs.eInvoiceBatchRow))
            {
                EInvoiceBatchDef def = (EInvoiceBatchDef)source;
                EInvoiceBatchDs.eInvoiceBatchRow row = (EInvoiceBatchDs.eInvoiceBatchRow)target;

                row.eInvoiceBatchId = def.EInvoiceBatchId;
                row.eInvoiceBatchNo = def.EInvoiceBatchNo;
                row.SubmittedBy = def.SubmittedBy.UserId;
                row.SubmittedOn = def.SubmittedOn;
                row.Status = def.Status;

            }

        }

        private void UKPaymentSupplierMapping(Object source, Object target)
        {
            if (source.GetType() == typeof(UKPaymentSupplierDs.UKPaymentSupplierRow) && target.GetType() == typeof(UKPaymentSupplierDef))
            {
                UKPaymentSupplierDs.UKPaymentSupplierRow row = (UKPaymentSupplierDs.UKPaymentSupplierRow)source;
                UKPaymentSupplierDef def = (UKPaymentSupplierDef)target;

                def.SupplierCode = row.SupplierNo;
                def.BankAccountNo = row.BankAccountNo;
                def.Name = row.Name;
                def.CurrencyId = row.CurrencyId;
                def.OfficeId = row.OfficeId;
                def.SunAccountCode = row.SunAccountCode;
                def.EpicorAccountCode = row.EpicorAccountCode;
                def.T0Code = row.T0Code;
                def.IsNSOffice = row.IsNSOffice;
            }
        }

        private void BankAccountMapping(Object source, Object target)
        {
            if (source.GetType() == typeof(BankAccountDs.BankAccountRow) && target.GetType() == typeof(BankAccountDef))
            {
                BankAccountDs.BankAccountRow row = (BankAccountDs.BankAccountRow)source;
                BankAccountDef def = (BankAccountDef)target;

                def.BankAccountId = row.BankAccountId;
                def.BankAccountNo = row.BankAccountNo;
                def.BankCode = row.BankCode;
                def.BankName = row.BankName;
                def.Currency = generalWorker.getCurrencyByKey(row.CurrencyId);
                def.HexAccountNo = row.HexAccountNo;
                def.PaymentReferenceCode = row.PaymentReferenceCode;
                def.PaymentType = row.PaymentType;
                def.SunCOA = row.SunCOA;
                def.SunT0 = row.SunT0;
            }
        }

        private void MockShopDCNoteMapping(Object source, Object target)
        {
            if (source.GetType() == typeof(MockShopDCNoteDs.MockShopDCNoteRow) &&
                target.GetType() == typeof(MockShopDCNoteDef))
            {
                MockShopDCNoteDs.MockShopDCNoteRow row = (MockShopDCNoteDs.MockShopDCNoteRow)source;
                MockShopDCNoteDef def = (MockShopDCNoteDef)target;

                def.DCNoteId = row.DCNoteId;
                def.DCNoteIndicator = row.DCNoteIndicator;
                def.DCNoteNo = row.DCNoteNo;
                def.DCNoteDate = row.DCNoteDate;
                def.OfficeId = row.OfficeId;
                def.FiscalYear = row.FiscalYear;
                def.Period = row.Period;
                def.SellCurrencyId = row.SellCurrencyId;
                def.TotalCourierCharge = row.TotalCourierCharge;
                def.TotalShippedAmt = row.TotalShippedAmt;
                def.TotalNSLCommissionAmt = row.TotalNSLCommissionAmt;
                def.IsInterfaced = row.IsInterfaced;
                def.Status = row.Status;
            }
            else if (source.GetType() == typeof(MockShopDCNoteDef) &&
                target.GetType() == typeof(MockShopDCNoteDs.MockShopDCNoteRow))
            {
                MockShopDCNoteDef def = (MockShopDCNoteDef)source;
                MockShopDCNoteDs.MockShopDCNoteRow row = (MockShopDCNoteDs.MockShopDCNoteRow)target;

                row.DCNoteId = def.DCNoteId;
                row.DCNoteIndicator = def.DCNoteIndicator;
                row.DCNoteNo = def.DCNoteNo;
                row.DCNoteDate = def.DCNoteDate;
                row.FiscalYear = def.FiscalYear;
                row.Period = def.Period;
                row.OfficeId = def.OfficeId;
                row.SellCurrencyId = def.SellCurrencyId;
                row.TotalCourierCharge = def.TotalCourierCharge;
                row.TotalShippedAmt = def.TotalShippedAmt;
                row.TotalNSLCommissionAmt = def.TotalNSLCommissionAmt;
                row.IsInterfaced = def.IsInterfaced;
                row.Status = def.Status;
            }
        }

        private void MockShopDCNoteShipmentMapping(Object source, Object target)
        {
            if (source.GetType() == typeof(MockShopDCNoteShipmentDs.MockShopDCNoteShipmentRow) &&
                target.GetType() == typeof(MockShopDCNoteShipmentDef))
            {
                MockShopDCNoteShipmentDs.MockShopDCNoteShipmentRow row = (MockShopDCNoteShipmentDs.MockShopDCNoteShipmentRow)source;
                MockShopDCNoteShipmentDef def = (MockShopDCNoteShipmentDef)target;

                def.DCNoteId = row.DCNoteId;
                def.DCNoteShipmentId = row.DCNoteShipmentId;
                def.OfficeId = row.OfficeId;
                def.TradingAgencyId = row.TradingAgencyId;
                def.DeptId = row.DeptId;
                def.ProductTeamId = row.ProductTeamId;
                def.ContractId = row.ContractId;
                def.ProductId = row.ProductId;
                def.ShipmentId = row.ShipmentId;
                def.SeasonId = row.SeasonId;
                def.VendorId = row.VendorId;
                def.CountryOfOriginId = row.CountryOfOriginId;
                def.PackingUnitId = row.PackingUnitId;
                def.SellCurrencyId = row.SellCurrencyId;
                if (!row.IsTermOfPurchaseIdNull())
                    def.TermOfPurchaseId = row.TermOfPurchaseId;
                def.TotalCourierCharge = row.TotalCourierCharge;
                def.TotalShippedAmount = row.TotalShippedAmt;
                def.TotalShippedQty = row.TotalShippedQty;
                def.NSLCommissionPercent = row.NSLCommissionPercent;
                def.NSLCommissionAmt = row.NSLCommissionAmt;
                def.Status = row.Status;
            }
            else if (source.GetType() == typeof(MockShopDCNoteShipmentDef) &&
                target.GetType() == typeof(MockShopDCNoteShipmentDs.MockShopDCNoteShipmentRow))
            {
                MockShopDCNoteShipmentDef def = (MockShopDCNoteShipmentDef)source;
                MockShopDCNoteShipmentDs.MockShopDCNoteShipmentRow row = (MockShopDCNoteShipmentDs.MockShopDCNoteShipmentRow)target;

                row.DCNoteId = def.DCNoteId;
                row.DCNoteShipmentId = def.DCNoteShipmentId;
                row.OfficeId = def.OfficeId;
                row.TradingAgencyId = def.TradingAgencyId;
                row.DeptId = def.DeptId;
                row.ProductTeamId = def.ProductTeamId;
                row.ContractId = def.ContractId;
                row.ProductId = def.ProductId;
                row.ShipmentId = def.ShipmentId;
                row.SeasonId = def.SeasonId;
                row.VendorId = def.VendorId;
                row.CountryOfOriginId = def.CountryOfOriginId;
                row.PackingUnitId = def.PackingUnitId;
                row.SellCurrencyId = def.SellCurrencyId;
                row.TermOfPurchaseId = def.TermOfPurchaseId;
                row.TotalCourierCharge = def.TotalCourierCharge;
                row.TotalShippedQty = def.TotalShippedQty;
                row.TotalShippedAmt = def.TotalShippedAmount;
                row.NSLCommissionPercent = def.NSLCommissionPercent;
                row.NSLCommissionAmt = def.NSLCommissionAmt;
                row.Status = def.Status;
            }
        }

        private void MockShopDCNoteShipmentDetailMapping(Object source, Object target)
        {
            if (source.GetType() == typeof(MockShopDCNoteShipmentDetailDs.MockShopDCNoteShipmentDetailRow) &&
                target.GetType() == typeof(MockShopDCNoteShipmentDetailDef))
            {
                MockShopDCNoteShipmentDetailDs.MockShopDCNoteShipmentDetailRow row = (MockShopDCNoteShipmentDetailDs.MockShopDCNoteShipmentDetailRow)source;
                MockShopDCNoteShipmentDetailDef def = (MockShopDCNoteShipmentDetailDef)target;

                def.DCNoteShipmentId = row.DCNoteShipmentId;
                def.DCNoteShipmentDetailId = row.DCNoteShipmentDetailId;
                def.ShipmentId = row.ShipmentId;
                def.ShipmentDetailId = row.ShipmentDetailId;
                def.SizeOptionId = row.SizeOptionId;
                def.SellingPrice = row.SellingPrice;
                def.ShippedQty = row.ShippedQty;
                def.Status = row.Status;
            }
            else if (source.GetType() == typeof(MockShopDCNoteShipmentDetailDef) &&
                target.GetType() == typeof(MockShopDCNoteShipmentDetailDs.MockShopDCNoteShipmentDetailRow))
            {
                MockShopDCNoteShipmentDetailDef def = (MockShopDCNoteShipmentDetailDef)source;
                MockShopDCNoteShipmentDetailDs.MockShopDCNoteShipmentDetailRow row = (MockShopDCNoteShipmentDetailDs.MockShopDCNoteShipmentDetailRow)target;

                row.DCNoteShipmentId = def.DCNoteShipmentId;
                row.DCNoteShipmentDetailId = def.DCNoteShipmentDetailId;
                row.ShipmentId = def.ShipmentId;
                row.ShipmentDetailId = def.ShipmentDetailId;
                row.SizeOptionId = def.SizeOptionId;
                row.SellingPrice = def.SellingPrice;
                row.ShippedQty = def.ShippedQty;
                row.Status = def.Status;
            }
        }


        private void StudioDCNoteMapping(Object source, Object target)
        {
            if (source.GetType() == typeof(StudioDCNoteDs.StudioDCNoteRow) &&
                target.GetType() == typeof(StudioDCNoteDef))
            {
                StudioDCNoteDs.StudioDCNoteRow row = (StudioDCNoteDs.StudioDCNoteRow)source;
                StudioDCNoteDef def = (StudioDCNoteDef)target;

                def.DCNoteId = row.DCNoteId;
                def.DCNoteIndicator = row.DCNoteIndicator;
                def.DCNoteNo = row.DCNoteNo;
                def.DCNoteDate = row.DCNoteDate;
                def.OfficeId = row.OfficeId;
                def.FiscalYear = row.FiscalYear;
                def.Period = row.Period;
                def.SellCurrencyId = row.SellCurrencyId;
                def.TotalCourierCharge = row.TotalCourierCharge;
                def.TotalShippedAmt = row.TotalShippedAmt;
                def.TotalNSLCommissionAmt = row.TotalNSLCommissionAmt;
                def.IsInterfaced = row.IsInterfaced;
                def.Status = row.Status;
            }
            else if (source.GetType() == typeof(StudioDCNoteDef) &&
                target.GetType() == typeof(StudioDCNoteDs.StudioDCNoteRow))
            {
                StudioDCNoteDef def = (StudioDCNoteDef)source;
                StudioDCNoteDs.StudioDCNoteRow row = (StudioDCNoteDs.StudioDCNoteRow)target;

                row.DCNoteId = def.DCNoteId;
                row.DCNoteIndicator = def.DCNoteIndicator;
                row.DCNoteNo = def.DCNoteNo;
                row.DCNoteDate = def.DCNoteDate;
                row.FiscalYear = def.FiscalYear;
                row.Period = def.Period;
                row.OfficeId = def.OfficeId;
                row.SellCurrencyId = def.SellCurrencyId;
                row.TotalCourierCharge = def.TotalCourierCharge;
                row.TotalShippedAmt = def.TotalShippedAmt;
                row.TotalNSLCommissionAmt = def.TotalNSLCommissionAmt;
                row.IsInterfaced = def.IsInterfaced;
                row.Status = def.Status;
            }
        }

        private void StudioDCNoteShipmentMapping(Object source, Object target)
        {
            if (source.GetType() == typeof(StudioDCNoteShipmentDs.StudioDCNoteShipmentRow) &&
                target.GetType() == typeof(StudioDCNoteShipmentDef))
            {
                StudioDCNoteShipmentDs.StudioDCNoteShipmentRow row = (StudioDCNoteShipmentDs.StudioDCNoteShipmentRow)source;
                StudioDCNoteShipmentDef def = (StudioDCNoteShipmentDef)target;

                def.DCNoteId = row.DCNoteId;
                def.DCNoteShipmentId = row.DCNoteShipmentId;
                def.OfficeId = row.OfficeId;
                def.TradingAgencyId = row.TradingAgencyId;
                def.DeptId = row.DeptId;
                def.ProductTeamId = row.ProductTeamId;
                def.ContractId = row.ContractId;
                def.ProductId = row.ProductId;
                def.ShipmentId = row.ShipmentId;
                def.SeasonId = row.SeasonId;
                def.VendorId = row.VendorId;
                def.CountryOfOriginId = row.CountryOfOriginId;
                def.PackingUnitId = row.PackingUnitId;
                def.SellCurrencyId = row.SellCurrencyId;
                if (!row.IsTermOfPurchaseIdNull())
                    def.TermOfPurchaseId = row.TermOfPurchaseId;
                def.TotalCourierCharge = row.TotalCourierCharge;
                def.TotalShippedAmount = row.TotalShippedAmt;
                def.TotalShippedQty = row.TotalShippedQty;
                def.NSLCommissionPercent = row.NSLCommissionPercent;
                def.NSLCommissionAmt = row.NSLCommissionAmt;
                def.Status = row.Status;
            }
            else if (source.GetType() == typeof(StudioDCNoteShipmentDef) &&
                target.GetType() == typeof(StudioDCNoteShipmentDs.StudioDCNoteShipmentRow))
            {
                StudioDCNoteShipmentDef def = (StudioDCNoteShipmentDef)source;
                StudioDCNoteShipmentDs.StudioDCNoteShipmentRow row = (StudioDCNoteShipmentDs.StudioDCNoteShipmentRow)target;

                row.DCNoteId = def.DCNoteId;
                row.DCNoteShipmentId = def.DCNoteShipmentId;
                row.OfficeId = def.OfficeId;
                row.TradingAgencyId = def.TradingAgencyId;
                row.DeptId = def.DeptId;
                row.ProductTeamId = def.ProductTeamId;
                row.ContractId = def.ContractId;
                row.ProductId = def.ProductId;
                row.ShipmentId = def.ShipmentId;
                row.SeasonId = def.SeasonId;
                row.VendorId = def.VendorId;
                row.CountryOfOriginId = def.CountryOfOriginId;
                row.PackingUnitId = def.PackingUnitId;
                row.SellCurrencyId = def.SellCurrencyId;
                row.TermOfPurchaseId = def.TermOfPurchaseId;
                row.TotalCourierCharge = def.TotalCourierCharge;
                row.TotalShippedQty = def.TotalShippedQty;
                row.TotalShippedAmt = def.TotalShippedAmount;
                row.NSLCommissionPercent = def.NSLCommissionPercent;
                row.NSLCommissionAmt = def.NSLCommissionAmt;
                row.Status = def.Status;
            }
        }

        private void StudioDCNoteShipmentDetailMapping(Object source, Object target)
        {
            if (source.GetType() == typeof(StudioDCNoteShipmentDetailDs.StudioDCNoteShipmentDetailRow) &&
                target.GetType() == typeof(StudioDCNoteShipmentDetailDef))
            {
                StudioDCNoteShipmentDetailDs.StudioDCNoteShipmentDetailRow row = (StudioDCNoteShipmentDetailDs.StudioDCNoteShipmentDetailRow)source;
                StudioDCNoteShipmentDetailDef def = (StudioDCNoteShipmentDetailDef)target;

                def.DCNoteShipmentId = row.DCNoteShipmentId;
                def.DCNoteShipmentDetailId = row.DCNoteShipmentDetailId;
                def.ShipmentId = row.ShipmentId;
                def.ShipmentDetailId = row.ShipmentDetailId;
                def.SizeOptionId = row.SizeOptionId;
                def.SellingPrice = row.SellingPrice;
                def.ShippedQty = row.ShippedQty;
                def.Status = row.Status;
            }
            else if (source.GetType() == typeof(StudioDCNoteShipmentDetailDef) &&
                target.GetType() == typeof(StudioDCNoteShipmentDetailDs.StudioDCNoteShipmentDetailRow))
            {
                StudioDCNoteShipmentDetailDef def = (StudioDCNoteShipmentDetailDef)source;
                StudioDCNoteShipmentDetailDs.StudioDCNoteShipmentDetailRow row = (StudioDCNoteShipmentDetailDs.StudioDCNoteShipmentDetailRow)target;

                row.DCNoteShipmentId = def.DCNoteShipmentId;
                row.DCNoteShipmentDetailId = def.DCNoteShipmentDetailId;
                row.ShipmentId = def.ShipmentId;
                row.ShipmentDetailId = def.ShipmentDetailId;
                row.SizeOptionId = def.SizeOptionId;
                row.SellingPrice = def.SellingPrice;
                row.ShippedQty = def.ShippedQty;
                row.Status = def.Status;
            }
        }

        private void UTContractDCNoteMapping(Object source, Object target)
        {
            if (source.GetType() == typeof(UTContractDCNoteDs.UTContractDCNoteRow) &&
                target.GetType() == typeof(UTContractDCNoteDef))
            {
                UTContractDCNoteDs.UTContractDCNoteRow row = (UTContractDCNoteDs.UTContractDCNoteRow)source;
                UTContractDCNoteDef def = (UTContractDCNoteDef)target;

                def.DCNoteId = row.DCNoteId;
                def.DCNoteIndicator = row.DCNoteIndicator;
                def.DCNoteNo = row.DCNoteNo;
                def.DCNoteDate = row.DCNoteDate;
                def.OfficeId = row.OfficeId;
                def.FiscalYear = row.FiscalYear;
                def.Period = row.Period;
                def.SellCurrencyId = row.SellCurrencyId;
                def.TotalCommission = row.TotalCommission;
                def.TotalMargin = row.TotalMargin;
                def.TotalServiceFee = row.TotalServiceFee;
                def.TotalSupplierCommission = row.TotalSupplierCommission;
                def.TotalSupplierGmtAmt = row.TotalSupplierGmtAmt;
                def.IsInterfaced = row.IsInterfaced;
                def.Status = row.Status;
            }
            else if (source.GetType() == typeof(UTContractDCNoteDef) &&
                target.GetType() == typeof(UTContractDCNoteDs.UTContractDCNoteRow))
            {
                UTContractDCNoteDef def = (UTContractDCNoteDef)source;
                UTContractDCNoteDs.UTContractDCNoteRow row = (UTContractDCNoteDs.UTContractDCNoteRow)target;

                row.DCNoteId = def.DCNoteId;
                row.DCNoteIndicator = def.DCNoteIndicator;
                row.DCNoteNo = def.DCNoteNo;
                row.DCNoteDate = def.DCNoteDate;
                row.FiscalYear = def.FiscalYear;
                row.Period = def.Period;
                row.OfficeId = def.OfficeId;
                row.SellCurrencyId = def.SellCurrencyId;
                row.TotalCommission = def.TotalCommission;
                row.TotalMargin = def.TotalMargin;
                row.TotalServiceFee = def.TotalServiceFee;
                row.TotalSupplierCommission = def.TotalSupplierCommission;
                row.TotalSupplierGmtAmt = def.TotalSupplierGmtAmt;
                row.IsInterfaced = def.IsInterfaced;
                row.Status = def.Status;
            }
        }


        private void UTContractDCNoteShipmentMapping(Object source, Object target)
        {
            if (source.GetType() == typeof(UTContractDCNoteShipmentDs.UTContractDCNoteShipmentRow) &&
                target.GetType() == typeof(UTContractDCNoteShipmentDef))
            {
                UTContractDCNoteShipmentDs.UTContractDCNoteShipmentRow row = (UTContractDCNoteShipmentDs.UTContractDCNoteShipmentRow)source;
                UTContractDCNoteShipmentDef def = (UTContractDCNoteShipmentDef)target;

                def.DCNoteId = row.DCNoteId;
                def.DCNoteShipmentId = row.DCNoteShipmentId;
                def.OfficeId = row.OfficeId;
                def.DeptId = row.DeptId;
                def.ProductTeamId = row.ProductTeamId;
                def.ContractId = row.ContractId;
                def.ProductId = row.ProductId;
                def.ShipmentId = row.ShipmentId;
                def.SeasonId = row.SeasonId;
                def.VendorId = row.VendorId;
                def.CountryOfOriginId = row.CountryOfOriginId;
                def.PackingUnitId = row.PackingUnitId;
                def.SellCurrencyId = row.SellCurrencyId;
                def.TermOfPurchaseId = row.TermOfPurchaseId;
                def.Commission = row.Commission;
                def.Margin = row.Margin;
                def.ServiceFee = row.ServiceFee;
                def.SupplierCommission = row.SupplierCommission;
                def.SupplierGmtAmt = row.SupplierGmtAmt;
                def.CNYExchangeRate = row.CNYExchangeRate;
                def.SupplierGmtAmtInCNY = row.SupplierGmtAmtInCNY;
                def.Status = row.Status;
            }
            else if (source.GetType() == typeof(UTContractDCNoteShipmentDef) &&
                target.GetType() == typeof(UTContractDCNoteShipmentDs.UTContractDCNoteShipmentRow))
            {
                UTContractDCNoteShipmentDef def = (UTContractDCNoteShipmentDef)source;
                UTContractDCNoteShipmentDs.UTContractDCNoteShipmentRow row = (UTContractDCNoteShipmentDs.UTContractDCNoteShipmentRow)target;

                row.DCNoteId = def.DCNoteId;
                row.DCNoteShipmentId = def.DCNoteShipmentId;
                row.OfficeId = def.OfficeId;
                row.DeptId = def.DeptId;
                row.ProductTeamId = def.ProductTeamId;
                row.ContractId = def.ContractId;
                row.ProductId = def.ProductId;
                row.ShipmentId = def.ShipmentId;
                row.SeasonId = def.SeasonId;
                row.VendorId = def.VendorId;
                row.CountryOfOriginId = def.CountryOfOriginId;
                row.PackingUnitId = def.PackingUnitId;
                row.SellCurrencyId = def.SellCurrencyId;
                row.TermOfPurchaseId = def.TermOfPurchaseId;
                row.Commission = def.Commission;
                row.Margin = def.Margin;
                row.ServiceFee = def.ServiceFee;
                row.SupplierCommission = def.SupplierCommission;
                row.SupplierGmtAmt = def.SupplierGmtAmt;
                row.CNYExchangeRate = def.CNYExchangeRate;
                row.SupplierGmtAmtInCNY = def.SupplierGmtAmtInCNY;
                row.Status = def.Status;
            }
        }

        private void QACommissionDNMapping(Object source, Object target)
        {
            if (source.GetType() == typeof(QACommissionDNDs.QACommissionDNRow) &&
                target.GetType() == typeof(QACommissionDNDef))
            {
                QACommissionDNDs.QACommissionDNRow row = (QACommissionDNDs.QACommissionDNRow)source;
                QACommissionDNDef def = (QACommissionDNDef)target;

                def.DNId = row.DNId;
                def.DNNo = row.DNNo;
                def.DNDate = row.DNDate;
                def.OfficeId = row.OfficeId;
                def.FiscalYear = row.FiscalYear;
                def.Period = row.Period;
                def.CurrencyId = row.CurrencyId;
                def.VendorId = row.VendorId;
                def.TotalQACommission = row.TotalQACommission;
                def.IsInterfaced = row.IsInterfaced;
                def.Status = row.Status;
                def.CreatedBy = row.CreatedBy;
                def.CreatedOn = row.CreatedOn;
            }
            else if (source.GetType() == typeof(QACommissionDNDef) &&
                target.GetType() == typeof(QACommissionDNDs.QACommissionDNRow))
            {
                QACommissionDNDef def = (QACommissionDNDef)source;
                QACommissionDNDs.QACommissionDNRow row = (QACommissionDNDs.QACommissionDNRow)target;

                row.DNId = def.DNId;
                row.DNNo = def.DNNo;
                row.DNDate = def.DNDate;
                row.FiscalYear = def.FiscalYear;
                row.Period = def.Period;
                row.OfficeId = def.OfficeId;
                row.CurrencyId = def.CurrencyId;
                row.VendorId = def.VendorId;
                row.TotalQACommission = def.TotalQACommission;
                row.IsInterfaced = def.IsInterfaced;
                row.Status = def.Status;
                row.CreatedBy = def.CreatedBy;
                row.CreatedOn = def.CreatedOn;
            }
        }


        private void QACommissionDNShipmentMapping(Object source, Object target)
        {
            if (source.GetType() == typeof(QACommissionDNShipmentDs.QACommissionDNShipmentRow) &&
                target.GetType() == typeof(QACommissionDNShipmentDef))
            {
                QACommissionDNShipmentDs.QACommissionDNShipmentRow row = (QACommissionDNShipmentDs.QACommissionDNShipmentRow)source;
                QACommissionDNShipmentDef def = (QACommissionDNShipmentDef)target;

                def.DNId = row.DNId;
                def.ShipmentId = row.ShipmentId;
                def.VendorId = row.VendorId;
                def.CurrencyId = row.CurrencyId;
                def.ShippedQty = row.ShippedQty;
                def.SupplierAmount = row.SupplierAmt;
                def.QACommissionPercent = row.QACommissionPercent;
                def.QACommissionAmount = row.QACommissionAmt;
                def.Status = row.Status;
                def.CreatedBy = row.CreatedBy;
                def.CreatedOn = row.CreatedOn;
            }
            else if (source.GetType() == typeof(QACommissionDNShipmentDef) &&
                target.GetType() == typeof(QACommissionDNShipmentDs.QACommissionDNShipmentRow))
            {
                QACommissionDNShipmentDef def = (QACommissionDNShipmentDef)source;
                QACommissionDNShipmentDs.QACommissionDNShipmentRow row = (QACommissionDNShipmentDs.QACommissionDNShipmentRow)target;

                row.DNId = def.DNId;
                row.ShipmentId = def.ShipmentId;
                row.VendorId = def.VendorId;
                row.CurrencyId = def.CurrencyId;
                row.ShippedQty = def.ShippedQty;
                row.SupplierAmt = def.SupplierAmount;
                row.QACommissionPercent = def.QACommissionPercent;
                row.QACommissionAmt = def.QACommissionAmount;
                row.Status = def.Status;
                row.CreatedBy = def.CreatedBy;
                row.CreatedOn = def.CreatedOn;
            }
        }


        private void SettlementBankDetailMapping(Object source, Object target)
        {
            if (source.GetType() == typeof(SettlementBankDetailDs.SettlementBankDetailRow) &&
                    target.GetType() == typeof(SettlementBankDetailDef))
            {
                SettlementBankDetailDs.SettlementBankDetailRow row = (SettlementBankDetailDs.SettlementBankDetailRow)source;
                SettlementBankDetailDef def = (SettlementBankDetailDef)target;

                def.AccountId = row.AccountId;
                def.OfficeId = row.OfficeId;
                def.CurrencyId = row.CurrencyId;
                def.TradingAgencyId = row.TradingAgencyId;
                def.AccountName = row.AccountName;
                def.AccountNo = row.AccountNo;
                def.SwiftCode = row.SwiftCode;
                def.BankName = row.BankName;
                def.BankAddress = row.BankAddress;
            }
            else if (source.GetType() == typeof(SettlementBankDetailDef) &&
                    target.GetType() == typeof(SettlementBankDetailDs.SettlementBankDetailRow))
            {
                SettlementBankDetailDef def = (SettlementBankDetailDef)source;
                SettlementBankDetailDs.SettlementBankDetailRow row = (SettlementBankDetailDs.SettlementBankDetailRow)target;

                row.AccountId = def.AccountId;
                row.OfficeId = def.OfficeId;
                row.CurrencyId = def.CurrencyId;
                row.TradingAgencyId = def.TradingAgencyId;
                row.AccountName = def.AccountName;
                row.AccountNo = def.AccountNo;
                row.SwiftCode = def.SwiftCode;
                row.BankName = def.BankName;
                row.BankAddress = def.BankAddress;
            }

        }

        private void NUKSalesMapping(Object source, Object target)
        {
            if (source.GetType() == typeof(NUKSalesDs.NUKSalesRow) &&
                target.GetType() == typeof(NUKSalesDef))
            {
                NUKSalesDs.NUKSalesRow row = (NUKSalesDs.NUKSalesRow)source;
                NUKSalesDef def = (NUKSalesDef)target;
                def.ContractNo = row.IsContractNoNull() ? string.Empty : row.ContractNo;
                def.DeliveryNo = row.IsDeliveryNoNull() ? 0 : row.DeliveryNo;
                def.NSLValue = row.IsNSLValueNull() ? 0 : row.NSLValue;
                def.Currency = row.IsCurrencyNull() ? string.Empty : row.Currency;
                def.NSLInvoiceNo = row.IsNSLInvoiceNoNull() ? string.Empty : row.NSLInvoiceNo;
                def.OkToMoveDate = row.IsOkToMoveDateNull() ? DateTime.MinValue : row.OkToMoveDate;
                def.ShipmentId = row.IsShipmentIdNull() ? 0 : row.ShipmentId;
                def.FiscalYear = row.IsFiscalYearNull() ? 0 : row.FiscalYear;
                def.Period = row.IsPeriodNull() ? 0 : row.Period;
            }
        }

        /*
        private void ClaimMapping(Object source, Object target)
        {
            if (source.GetType() == typeof(ClaimDs.ClaimRow) &&
                target.GetType() == typeof(ClaimDef))
            {
                ClaimDs.ClaimRow row = (ClaimDs.ClaimRow)source;
                ClaimDef def = (ClaimDef)target;

                def.ClaimId = row.ClaimId;
                if (!row.IsClaimDescriptionNull())
                    def.ClaimDescription = row.ClaimDescription;
                if (!row.IsClaimTypeIdNull())
                    def.ClaimType = ClaimType.getType(row.ClaimTypeId);
                if (!row.IsClaimDocumentNoNull())
                    def.ClaimDocumentNo = row.ClaimDocumentNo;
                if (!row.IsClaimVoucherNoNull())
                    def.ClaimVoucherNo = row.ClaimVoucherNo;
                if (!row.IsClaimDocumentDateNull())
                    def.ClaimDocumentDate = row.ClaimDocumentDate;
                else
                    def.ClaimDocumentDate = DateTime.MinValue;
                if (!row.IsClaimDocumentReceivedDateNull())
                    def.ClaimDocumentReceivedDate = row.ClaimDocumentReceivedDate;
                else
                    def.ClaimDocumentReceivedDate = DateTime.MinValue;
                if (!row.IsCustomerIdNull())
                    def.Customer = commonWorker.getCustomerByKey(row.CustomerId);
                if (!row.IsClaimSettlementDateNull())
                    def.ClaimSettlementDate = row.ClaimSettlementDate;
                else
                    def.ClaimSettlementDate = DateTime.MinValue;
                def.Status = row.Status;
            }
            else if (source.GetType() == typeof(ClaimDef) &&
                target.GetType() == typeof(ClaimDs.ClaimRow))
            {
                ClaimDef def = (ClaimDef)source;
                ClaimDs.ClaimRow row = (ClaimDs.ClaimRow)target;

                row.ClaimId = def.ClaimId;
                if (def.ClaimDescription != string.Empty)
                    row.ClaimDescription = def.ClaimDescription;
                else
                    row.SetClaimDescriptionNull();
                row.ClaimTypeId = def.ClaimType.Id;
                if (def.ClaimDocumentNo != string.Empty)
                    row.ClaimDocumentNo = def.ClaimDocumentNo;
                else
                    row.SetClaimDocumentNoNull();
                if (def.ClaimVoucherNo != string.Empty)
                    row.ClaimVoucherNo = def.ClaimVoucherNo;
                else
                    row.SetClaimVoucherNoNull();
                if (def.ClaimDocumentDate != DateTime.MinValue)
                    row.ClaimDocumentDate = def.ClaimDocumentDate;
                else
                    row.SetClaimDocumentDateNull();
                if (def.ClaimDocumentReceivedDate != DateTime.MinValue)
                    row.ClaimDocumentReceivedDate = def.ClaimDocumentReceivedDate;
                else
                    row.SetClaimDocumentReceivedDateNull();
                row.CustomerId = def.Customer.CustomerId;
                if (def.ClaimSettlementDate != DateTime.MinValue)
                    row.ClaimSettlementDate = def.ClaimSettlementDate;
                else
                    row.SetClaimSettlementDateNull();
                row.Status = def.Status;
            }

        }

        private void ClaimDetailMapping(Object source, Object target)
        {
            if (source.GetType() == typeof(ClaimDetailDs.ClaimDetailRow) &&
                target.GetType() == typeof(ClaimDetailDef))
            {
                ClaimDetailDs.ClaimDetailRow row = (ClaimDetailDs.ClaimDetailRow)source;
                ClaimDetailDef def = (ClaimDetailDef)target;

                def.ClaimDetailId = row.ClaimDetailId;
                def.ClaimId = row.ClaimId;
                def.ClaimDetailType = ClaimDetailType.getType(row.ClaimDetailTypeId);
                if (row.IsRechargeSupplierDebitCreditNoteIdNull())
                    def.RechargeSupplierDebitCreditNoteId = -1;
                else
                    def.RechargeSupplierDebitCreditNoteId = row.RechargeSupplierDebitCreditNoteId;
                if (row.IsShipmentIdNull())
                    def.ShipmentId = -1;
                else
                    def.ShipmentId = row.ShipmentId;
                if (row.IsProductIdNull())
                    def.ProductId = -1;
                else
                    def.ProductId = row.ProductId;
                if (!row.IsVendorIdNull())
                    def.Vendor = vendorWorker.getVendorByKey(row.VendorId);
                else
                    def.Vendor = null;
                if (!row.IsRefundDocumentNoNull())
                    def.RefundDocumentNo = row.RefundDocumentNo;

                def.ClaimCurrency = generalWorker.getCurrencyByKey(row.ClaimCurrencyId);
                def.ClaimAmount = row.ClaimAmt;

                if (row.IsClaimQtyNull())
                    def.ClaimQuantity = -1;
                else
                    def.ClaimQuantity = row.ClaimQty;
                if (row.IsClaimDiscountPercentNull())
                    def.ClaimDiscountPercent = -1;
                else
                    def.ClaimDiscountPercent = row.ClaimDiscountPercent;
                if (row.IsClaimDiscountSellingPriceNull())
                    def.ClaimDiscountSellingPrice = -1;
                else
                    def.ClaimDiscountSellingPrice = row.ClaimDiscountSellingPrice;
                if (row.IsRechargeSupplierCurrencyIdNull())
                    def.RechargeSupplierCurrency = null;
                else
                    def.RechargeSupplierCurrency = generalWorker.getCurrencyByKey(row.RechargeSupplierCurrencyId);
                def.RechargeSupplierAmount = row.RechargeSupplierAmt;
                if (row.IsNSLAbsorbedCurrencyIdNull())
                    def.NSLAbsorbedCurrency = null;
                else
                    def.NSLAbsorbedCurrency = generalWorker.getCurrencyByKey(row.NSLAbsorbedCurrencyId);
                def.NSLAbsorbedAmount = row.NSLAbsorbedAmt;
                if (row.IsNUKRemarkNull())
                    def.NUKRemark = string.Empty;
                else
                    def.NUKRemark = row.NUKRemark;
                if (row.IsNSLRemarkNull())
                    def.NSLRemark = string.Empty;
                else
                    def.NSLRemark = row.NSLRemark;
                if (row.IsAuthorizerRemarkNull())
                    def.AuthorizerRemark = string.Empty;
                else
                    def.AuthorizerRemark = row.AuthorizerRemark;
                if (row.IsAuditDateNull())
                    def.AuditDate = DateTime.MinValue;
                else
                    def.AuditDate = row.AuditDate;
                def.WorkflowStatus = ClaimWFS.getType(row.WorkflowStatusId);
                def.Status = row.Status;
            }
            else if (source.GetType() == typeof(ClaimDetailDef) &&
                target.GetType() == typeof(ClaimDetailDs.ClaimDetailRow))
            {
                ClaimDetailDef def = (ClaimDetailDef)source;
                ClaimDetailDs.ClaimDetailRow row = (ClaimDetailDs.ClaimDetailRow)target;

                row.ClaimDetailId = def.ClaimDetailId;
                row.ClaimId = def.ClaimId;
                row.ClaimDetailTypeId = def.ClaimDetailType.Id;
                if (def.RechargeSupplierDebitCreditNoteId > 0)
                    row.RechargeSupplierDebitCreditNoteId = def.RechargeSupplierDebitCreditNoteId;
                else
                    row.SetRechargeSupplierDebitCreditNoteIdNull();
                if (def.ShipmentId > 0)
                    row.ShipmentId = def.ShipmentId;
                else
                    row.SetShipmentIdNull();
                if (def.ProductId > 0)
                    row.ProductId = def.ProductId;
                else
                    row.SetProductIdNull();
                if (def.Vendor != null)
                    row.VendorId = def.Vendor.VendorId;
                else
                    row.SetVendorIdNull();
                if (def.RefundDocumentNo != null)
                    row.RefundDocumentNo = def.RefundDocumentNo;
                else
                    row.SetRefundDocumentNoNull();
                row.ClaimCurrencyId = def.ClaimCurrency.CurrencyId;
                row.ClaimAmt = def.ClaimAmount;
                if (def.ClaimQuantity != -1)
                    row.ClaimQty = def.ClaimQuantity;
                else
                    row.SetClaimQtyNull();
                if (def.ClaimDiscountPercent != -1)
                    row.ClaimDiscountPercent = def.ClaimDiscountPercent;
                else
                    row.SetClaimDiscountPercentNull();
                if (def.ClaimDiscountSellingPrice != -1)
                    row.ClaimDiscountSellingPrice = def.ClaimDiscountSellingPrice;
                else
                    row.SetClaimDiscountSellingPriceNull();
                if (def.RechargeSupplierCurrency != null)
                    row.RechargeSupplierCurrencyId = def.RechargeSupplierCurrency.CurrencyId;
                else
                    row.SetRechargeSupplierCurrencyIdNull();
                row.RechargeSupplierAmt = def.RechargeSupplierAmount;
                if (def.NSLAbsorbedCurrency != null)
                    row.NSLAbsorbedCurrencyId = def.NSLAbsorbedCurrency.CurrencyId;
                else
                    row.SetNSLAbsorbedCurrencyIdNull();
                row.NSLAbsorbedAmt = def.NSLAbsorbedAmount;
                if (def.NUKRemark != string.Empty)
                    row.NUKRemark = def.NUKRemark;
                else
                    row.SetNUKRemarkNull();
                if (def.NSLRemark != string.Empty)
                    row.NSLRemark = def.NSLRemark;
                else
                    row.SetNSLRemarkNull();
                if (def.AuthorizerRemark != string.Empty)
                    row.AuthorizerRemark = def.AuthorizerRemark;
                else
                    row.SetAuthorizerRemarkNull();
                if (def.AuditDate != DateTime.MinValue)
                    row.AuditDate = def.AuditDate;
                else
                    row.SetAuditDateNull();
                row.WorkflowStatusId = def.WorkflowStatus.Id;
                row.Status = def.Status;
            }
        }
        */

        internal void EpicorGLJournalDetailMapping(Object source, Object target)
        {
            if (source.GetType() == typeof(EpicorGLJournalDetailDs.EpicorGLJournalDetailRow) && target.GetType() == typeof(EpicorGLJournalDetailDef))
            {
                EpicorGLJournalDetailDs.EpicorGLJournalDetailRow row = (EpicorGLJournalDetailDs.EpicorGLJournalDetailRow)source;
                EpicorGLJournalDetailDef def = (EpicorGLJournalDetailDef)target;
                def.RecordId = row.RecordId;
                def.Company = row.Company;
                def.FiscalYear = row.FiscalYear;
                def.FiscalPeriod = row.FiscalPeriod;
                def.JournalNum = row.JournalNum;
                def.JournalLine = row.JournalLine;
                def.GroupID = (row.IsGroupIDNull() ? string.Empty : row.GroupID);
                def.Description = (row.IsDescriptionNull() ? string.Empty : row.Description);
                def.JEDate = (row.IsJEDateNull() ? DateTime.MinValue : row.JEDate);
                def.Number01 = (row.IsNumber01Null() ? 0m : row.Number01);
                def.SegValue1 = (row.IsSegValue1Null() ? string.Empty : row.SegValue1);
                def.SegValue2 = (row.IsSegValue2Null() ? string.Empty : row.SegValue2);
                def.SegValue3 = (row.IsSegValue3Null() ? string.Empty : row.SegValue3);
                def.SegValue4 = (row.IsSegValue4Null() ? string.Empty : row.SegValue4);
                def.SegValue5 = (row.IsSegValue5Null() ? string.Empty : row.SegValue5);
                def.SegValue6 = (row.IsSegValue6Null() ? string.Empty : row.SegValue6);
                def.SegValue7 = (row.IsSegValue7Null() ? string.Empty : row.SegValue7);
                def.SegValue8 = (row.IsSegValue8Null() ? string.Empty : row.SegValue8);
                def.SegValue9 = (row.IsSegValue9Null() ? string.Empty : row.SegValue9);
                def.SegValue10 = (row.IsSegValue10Null() ? string.Empty : row.SegValue10);
                def.DC = row.DC;
                def.CurrencyCode = (row.IsCurrencyCodeNull() ? string.Empty : row.CurrencyCode);
                def.CreditAmount = (row.IsCreditAmountNull() ? 0m : row.CreditAmount);
                def.DebitAmount = (row.IsDebitAmountNull() ? 0m : row.DebitAmount);
                def.BookCreditAmount = (row.IsBookCreditAmountNull() ? 0m : row.BookCreditAmount);
                def.BookDebitAmount = (row.IsBookDebitAmountNull() ? 0m : row.BookDebitAmount);
                def.LegalNumber = row.LegalNumber;
                def.JournalCode = row.JournalCode;
                def.SourceModule = row.SourceModule;
                if (row.IsInvoiceDateNull())
                {
                    def.APInvoiceDate = DateTime.MinValue;
                }
                else
                {
                    def.APInvoiceDate = row.InvoiceDate;
                }
                def.APInvoiceNum = row.APInvoiceNum;
                def.Character05 = row.Character05;
                def.Character01 = row.Character01;
                def.ShortChar01 = row.ShortChar01;
                def.CommentText = row.CommentText;
                def.LegalNumberID = row.LegalNumberID;
                def.OriginalDescription = row.OriginalDescription;
                def.IsBank = row.IsBank;
                def.IsCash = row.IsCash;
            }
        }

        private void ILSDiffDCNoteMapping(Object source, Object target)
        {
            if (source.GetType() == typeof(ILSDiffDCNoteDs.ILSDiffDCNoteRow) &&
                target.GetType() == typeof(ILSDiffDCNoteDef))
            {
                ILSDiffDCNoteDs.ILSDiffDCNoteRow row = (ILSDiffDCNoteDs.ILSDiffDCNoteRow)source;
                ILSDiffDCNoteDef def = (ILSDiffDCNoteDef)target;

                def.DCNoteId = row.DCNoteId;
                def.DCNoteIndicator = row.DCNoteIndicator;
                def.DCNoteNo = row.DCNoteNo;
                def.DCNoteDate = row.DCNoteDate;
                def.OfficeId = row.OfficeId;
                def.FiscalYear = row.FiscalYear;
                def.Period = row.Period;
                def.CurrencyId = row.CurrencyId;
                def.TotalDiffAmt = row.TotalDiffAmt;
                def.TotalSalesDiffAmt = row.TotalSalesDiffAmt;
                def.TotalSalesCommissionDiffAmt = row.TotalSalesCommissionDiffAmt;
                def.IsInterfaced = row.IsInterfaced;
                def.Status = row.Status;
            }
            else if (source.GetType() == typeof(ILSDiffDCNoteDef) &&
                target.GetType() == typeof(ILSDiffDCNoteDs.ILSDiffDCNoteRow))
            {
                ILSDiffDCNoteDef def = (ILSDiffDCNoteDef)source;
                ILSDiffDCNoteDs.ILSDiffDCNoteRow row = (ILSDiffDCNoteDs.ILSDiffDCNoteRow)target;

                row.DCNoteId = def.DCNoteId;
                row.DCNoteIndicator = def.DCNoteIndicator;
                row.DCNoteNo = def.DCNoteNo;
                row.DCNoteDate = def.DCNoteDate;
                row.OfficeId = def.OfficeId;
                row.FiscalYear = def.FiscalYear;
                row.Period = def.Period;
                row.CurrencyId = def.CurrencyId;
                row.TotalDiffAmt = def.TotalDiffAmt;
                row.TotalSalesDiffAmt = def.TotalSalesDiffAmt;
                row.TotalSalesCommissionDiffAmt = def.TotalSalesCommissionDiffAmt;
                row.IsInterfaced = def.IsInterfaced;
                row.Status = def.Status;
            }
        }

        private void ILSDiffDCNoteShipmentMapping(Object source, Object target)
        {
            if (source.GetType() == typeof(ILSDiffDCNoteShipmentDs.ILSDiffDCNoteShipmentRow) &&
                target.GetType() == typeof(ILSDiffDCNoteShipmentDef))
            {
                ILSDiffDCNoteShipmentDs.ILSDiffDCNoteShipmentRow row = (ILSDiffDCNoteShipmentDs.ILSDiffDCNoteShipmentRow)source;
                ILSDiffDCNoteShipmentDef def = (ILSDiffDCNoteShipmentDef)target;

                def.DCNoteShipmentId = row.DCNoteShipmentId;
                def.FiscalYear = row.FiscalYear;
                def.Period = row.Period;
                def.ILSType = row.ILSType;
                def.ShipmentId = row.ShipmentId;
                def.OfficeId = row.OfficeId;
                def.DeptId = row.DeptId;
                def.ProductTeamId = row.ProductTeamId;
                def.ContractId = row.ContractId;
                def.ProductId = row.ProductId;
                def.CurrencyId = row.CurrencyId;
                def.NSSAmt = row.NSSAmt;
                def.ReceivedAmt = row.ReceivedAmt;
                def.ILSDiffAmt = row.ILSDiffAmt;
                if (row.IsDCNoteIdNull())
                    def.DCNoteId = -1;
                else
                    def.DCNoteId = row.DCNoteId;
                def.Status = row.Status;
            }
            else if (source.GetType() == typeof(ILSDiffDCNoteShipmentDef) &&
                target.GetType() == typeof(ILSDiffDCNoteShipmentDs.ILSDiffDCNoteShipmentRow))
            {
                ILSDiffDCNoteShipmentDef def = (ILSDiffDCNoteShipmentDef)source;
                ILSDiffDCNoteShipmentDs.ILSDiffDCNoteShipmentRow row = (ILSDiffDCNoteShipmentDs.ILSDiffDCNoteShipmentRow)target;

                row.DCNoteShipmentId = def.DCNoteShipmentId;
                row.FiscalYear = def.FiscalYear;
                row.Period = def.Period;
                row.ILSType = def.ILSType;
                row.ShipmentId = def.ShipmentId;
                row.OfficeId = def.OfficeId;
                row.DeptId = def.DeptId;
                row.ProductTeamId = def.ProductTeamId;
                row.ContractId = def.ContractId;
                row.ProductId = def.ProductId;
                row.CurrencyId = def.CurrencyId;
                row.NSSAmt = def.NSSAmt;
                row.ReceivedAmt = def.ReceivedAmt;
                row.ILSDiffAmt = def.ILSDiffAmt;
                if (def.DCNoteId == -1)
                    row.SetDCNoteIdNull();
                else
                    row.DCNoteId = def.DCNoteId;
                row.Status = def.Status;
            }
        }

        #endregion

        public ArrayList getOrderCurrencyList()
        {
            ArrayList list = new ArrayList();

            IDataSetAdapter ad = getDataSetAdapter("AccountCurrencyApt", "getOrderCurrencyList");
            CurrencyDs ds = new CurrencyDs();
            int recordsAffected = ad.Fill(ds);

            if (recordsAffected < 1) return null;

            for (int i = 0; i < ds.Tables["CurrencyList"].Rows.Count; i++)
            {
                CurrencyRef rf = new CurrencyRef();
                rf.CurrencyId = int.Parse(ds.Tables["CurrencyList"].Rows[i]["CurrencyId"].ToString());
                rf.CurrencyCode = (ds.Tables["CurrencyList"].Rows[i]["CurrencyCode"].ToString());
                rf.Name = (ds.Tables["CurrencyList"].Rows[i]["Name"].ToString());
                list.Add(rf);
            }
            return list;
        }

        public ArrayList getBaseCurrencyList()
        {
            ArrayList list = new ArrayList();

            IDataSetAdapter ad = getDataSetAdapter("AccountCurrencyApt", "getBaseCurrencyList");
            CurrencyDs ds = new CurrencyDs();
            int recordsAffected = ad.Fill(ds);

            if (recordsAffected < 1) return null;

            for (int i = 0; i < ds.Tables["CurrencyList"].Rows.Count; i++)
            {
                CurrencyRef rf = new CurrencyRef();
                rf.CurrencyId = int.Parse(ds.Tables["CurrencyList"].Rows[i]["CurrencyId"].ToString());
                rf.CurrencyCode = (ds.Tables["CurrencyList"].Rows[i]["CurrencyCode"].ToString());
                rf.Name = (ds.Tables["CurrencyList"].Rows[i]["Name"].ToString());
                list.Add(rf);
            }
            return list;
        }

        public bool isSunInterfaceDisabled(int shipmentId)
        {
            IDataSetAdapter ad = getDataSetAdapter("SunExcludeShipmentApt", "GetSunExcludeShipmentByKey");
            ad.SelectCommand.Parameters["@ShipmentId"].Value = shipmentId;

            DataSet ds = new DataSet();
            int recordsAffected = ad.Fill(ds);

            if (recordsAffected < 1)
                return false;
            else
                return true;
        }

        public bool isReleaseLockOpened(int shipmentId)
        {
            IDataSetAdapter ad = getDataSetAdapter("NssReleaseLockRequestApt", "GetOpenedReleaseLockByShipmentId");
            ad.SelectCommand.Parameters["@ShipmentId"].Value = shipmentId;
            DataSet ds = new DataSet();
            int recordsAffected = ad.Fill(ds);

            if (recordsAffected >= 1)
                return true;
            else
                return false;
        }

        public PaymentStatusEnquiryDs getPaymentStatusEnquiryDataSet(string invoicePrefix, int invoiceSeqFrom, int invoiceSeqTo, int invoiceYear, int officeId, int handlingOfficeId, DateTime invoiceDateFrom, DateTime invoiceDateTo, DateTime subDocDateFrom,
            DateTime subDocDateTo, DateTime interfaceDateFrom, DateTime interfaceDateTo, int paymentTermId, int tradingAgencyId, int vendorId,
            TypeCollector paymentStatusList, string contractNo)
        {
            IDataSetAdapter ad = getDataSetAdapter("PaymentStatusEnquiryApt", "GetPaymentStatusEnquiryList");

            ad.SelectCommand.Parameters["@InvoicePrefix"].Value = invoicePrefix;
            ad.SelectCommand.Parameters["@InvoiceSeqFrom"].Value = invoiceSeqFrom;
            ad.SelectCommand.Parameters["@InvoiceSeqTo"].Value = invoiceSeqTo;
            ad.SelectCommand.Parameters["@InvoiceYear"].Value = invoiceYear;
            ad.SelectCommand.Parameters["@OfficeId"].Value = officeId;
            ad.SelectCommand.Parameters["@HandlingOfficeId"].Value = handlingOfficeId;
            ad.SelectCommand.Parameters["@VendorId"].Value = vendorId;
            ad.SelectCommand.Parameters["@PaymentTermId"].Value = paymentTermId;
            ad.SelectCommand.Parameters["@TradingAgencyId"].Value = tradingAgencyId;

            if (invoiceDateFrom == DateTime.MinValue)
                ad.SelectCommand.Parameters["@InvoiceDateFrom"].Value = DBNull.Value;
            else
                ad.SelectCommand.Parameters["@InvoiceDateFrom"].Value = invoiceDateFrom;
            if (invoiceDateTo == DateTime.MinValue)
                ad.SelectCommand.Parameters["@InvoiceDateTo"].Value = DBNull.Value;
            else
                ad.SelectCommand.Parameters["@InvoiceDateTo"].Value = invoiceDateTo;

            if (subDocDateFrom == DateTime.MinValue)
                ad.SelectCommand.Parameters["@SubDocDateFrom"].Value = DBNull.Value;
            else
                ad.SelectCommand.Parameters["@SubDocDateFrom"].Value = subDocDateFrom;
            if (subDocDateTo == DateTime.MinValue)
                ad.SelectCommand.Parameters["@SubDocDateTo"].Value = DBNull.Value;
            else
                ad.SelectCommand.Parameters["@SubDocDateTo"].Value = subDocDateTo;

            if (interfaceDateFrom == DateTime.MinValue)
                ad.SelectCommand.Parameters["@InterfaceDateFrom"].Value = DBNull.Value;
            else
                ad.SelectCommand.Parameters["@InterfaceDateFrom"].Value = interfaceDateFrom;
            if (interfaceDateTo == DateTime.MinValue)
                ad.SelectCommand.Parameters["@InterfaceDateTo"].Value = DBNull.Value;
            else
                ad.SelectCommand.Parameters["@InterfaceDateTo"].Value = interfaceDateTo;
            ad.SelectCommand.CustomParameters["@PaymentStatus"] = CustomDataParameter.parse(paymentStatusList.IsInclusive, paymentStatusList.Values);
            ad.SelectCommand.Parameters["@ContractNo"].Value = contractNo;

            ad.SelectCommand.DbCommand.CommandText = ad.SelectCommand.DbCommand.CommandText.Replace("TOP 500", "");

            PaymentStatusEnquiryDs dataSet = new PaymentStatusEnquiryDs();
            ad.SelectCommand.DbCommand.CommandTimeout = 120;
            ad.SelectCommand.MailSQL = true;
            int recordsAffected = ad.Fill(dataSet);

            //Fill in the China GB Test Result
            /*
            PaymentStatusEnquiryDs.PaymentStatusEnquiryRow row;
            for (int i = dataSet.PaymentStatusEnquiry.Rows.Count - 1; i >= 0; i--)
            {
                row = (PaymentStatusEnquiryDs.PaymentStatusEnquiryRow)dataSet.PaymentStatusEnquiry.Rows[i];
                if (row.IsChinaGBTestRequired)
                    row.ChinaGBTestResult = GeneralWorker.Instance.getChinaGBTestResult(row.ProductId, row.VendorId);
            }
            */

            return dataSet;
        }

        public ArrayList getPaymentStatusEnquiryList(string invoicePrefix, int invoiceSeqFrom, int invoiceSeqTo, int invoiceYear, int officeId, int handlingOfficeId, DateTime invoiceDateFrom, DateTime invoiceDateTo, DateTime subDocDateFrom,
            DateTime subDocDateTo, DateTime interfaceDateFrom, DateTime interfaceDateTo, int paymentTermId, int tradingAgencyId, int vendorId,
            TypeCollector paymentStatusList, string contractNo)
        {
            IDataSetAdapter ad = getDataSetAdapter("PaymentStatusEnquiryApt", "GetPaymentStatusEnquiryList");

            ad.SelectCommand.Parameters["@InvoicePrefix"].Value = invoicePrefix;
            ad.SelectCommand.Parameters["@InvoiceSeqFrom"].Value = invoiceSeqFrom;
            ad.SelectCommand.Parameters["@InvoiceSeqTo"].Value = invoiceSeqTo;
            ad.SelectCommand.Parameters["@InvoiceYear"].Value = invoiceYear;
            ad.SelectCommand.Parameters["@OfficeId"].Value = officeId;
            ad.SelectCommand.Parameters["@HandlingOfficeId"].Value = handlingOfficeId;
            ad.SelectCommand.Parameters["@VendorId"].Value = vendorId;
            ad.SelectCommand.Parameters["@PaymentTermId"].Value = paymentTermId;
            ad.SelectCommand.Parameters["@TradingAgencyId"].Value = tradingAgencyId;

            if (invoiceDateFrom == DateTime.MinValue)
                ad.SelectCommand.Parameters["@InvoiceDateFrom"].Value = DBNull.Value;
            else
                ad.SelectCommand.Parameters["@InvoiceDateFrom"].Value = invoiceDateFrom;
            if (invoiceDateTo == DateTime.MinValue)
                ad.SelectCommand.Parameters["@InvoiceDateTo"].Value = DBNull.Value;
            else
                ad.SelectCommand.Parameters["@InvoiceDateTo"].Value = invoiceDateTo;

            if (subDocDateFrom == DateTime.MinValue)
                ad.SelectCommand.Parameters["@SubDocDateFrom"].Value = DBNull.Value;
            else
                ad.SelectCommand.Parameters["@SubDocDateFrom"].Value = subDocDateFrom;
            if (subDocDateTo == DateTime.MinValue)
                ad.SelectCommand.Parameters["@SubDocDateTo"].Value = DBNull.Value;
            else
                ad.SelectCommand.Parameters["@SubDocDateTo"].Value = subDocDateTo;

            if (interfaceDateFrom == DateTime.MinValue)
                ad.SelectCommand.Parameters["@InterfaceDateFrom"].Value = DBNull.Value;
            else
                ad.SelectCommand.Parameters["@InterfaceDateFrom"].Value = interfaceDateFrom;
            if (interfaceDateTo == DateTime.MinValue)
                ad.SelectCommand.Parameters["@InterfaceDateTo"].Value = DBNull.Value;
            else
                ad.SelectCommand.Parameters["@InterfaceDateTo"].Value = interfaceDateTo;
            ad.SelectCommand.CustomParameters["@PaymentStatus"] = CustomDataParameter.parse(paymentStatusList.IsInclusive, paymentStatusList.Values);
            ad.SelectCommand.Parameters["@ContractNo"].Value = contractNo;

            PaymentStatusEnquiryDs dataSet = new PaymentStatusEnquiryDs();
            ad.SelectCommand.DbCommand.CommandTimeout = 120;
            ad.SelectCommand.MailSQL = true;
            int recordsAffected = ad.Fill(dataSet);

            ArrayList list = new ArrayList();

            foreach (PaymentStatusEnquiryDs.PaymentStatusEnquiryRow row in dataSet.PaymentStatusEnquiry)
            {
                PaymentStatusEnquiryDef def = new PaymentStatusEnquiryDef();
                def.ShipmentId = row.ShipmentId;
                def.SplitShipmentId = row.SplitShipmentId;
                def.SupplierName = row.VendorName;
                def.ContractNo = row.ContractNo;
                def.ItemNo = row.ItemNo;
                def.InvoiceNo = row.InvoiceNo;
                if (!row.IsSupplierInvoiceNoNull())
                    def.SupplierInvoiceNo = row.SupplierInvoiceNo;
                else
                    def.SupplierInvoiceNo = String.Empty;
                def.CurrencyCode = row.CurrencyCode;
                def.NetAmount = row.NetAmt;
                def.NetAmountInUSD = row.NetAmtInUSD;
                def.EditLock = (row.EditLock == 1 ? true : false);
                def.IsInterfaced = row.IsInterfaced;
                if (!row.IsShippingDocReceiptDateNull())
                    def.ShippingDocReceiptDate = row.ShippingDocReceiptDate;
                else
                    def.ShippingDocReceiptDate = DateTime.MinValue;
                if (!row.IsAPDateNull())
                    def.APDate = row.APDate;
                else
                    def.APDate = DateTime.MinValue;
                def.DMSAttachmentId = 0;
                def.IsPaymentHold = row.IsPaymentHold;
                def.VendorId = row.VendorId;
                if (row.IsReviewUserNull())
                    def.ReviewUser = "N/A";
                else
                    def.ReviewUser = row.ReviewUser;
                if (row.IsReviewDateTimeNull())
                    def.ReviewDateTime = DateTime.MinValue;
                else
                    def.ReviewDateTime = row.ReviewDateTime;
                def.InvoiceDate = row.InvoiceDate;
                def.IsUploadDMSDocument = row.IsUploadDMSDocument;
                def.LabTestIncome = row.LabTestIncome;
                def.TotalShippedQty = row.TotalShippedQty;
                def.IsChinaGBTestRequired = row.IsChinaGBTestRequired;
                def.SeasonId = row.SeasonId;
                def.ProductId = row.ProductId;
                def.ProductTeamCode = row.ProductTeamCode;
                def.ProductTeamDescription = row.ProductTeamDesc;
                def.DeductionAmount = row.DeductionAmt;
                /*
                if (def.APDate != DateTime.MinValue && def.IsInterfaced == 1)
                    def.PaymentStatus = "Settled";
                else if (def.ShippingDocReceiptDate == DateTime.MinValue && def.IsInterfaced == 0)
                    def.PaymentStatus = "Outstanding";
                else if (def.ShippingDocReceiptDate != DateTime.MinValue && def.IsInterfaced == 0)
                    def.PaymentStatus = "Registered";
                else if (def.ShippingDocReceiptDate == DateTime.MinValue && def.IsInterfaced == 1)
                    def.PaymentStatus = "Interfaced (No Ship Doc)";
                else if (def.ShippingDocReceiptDate != DateTime.MinValue && def.IsInterfaced == 1)
                    def.PaymentStatus = "Interfaced (Ready to Pay)";
                */
                def.DMSWorkflowStatusId = row.DMSWorkflowStatusId;
                if (def.DMSWorkflowStatusId == ShippingDocWFS.NOT_READY.Id)
                    def.PaymentStatus = "Not Ready To Check";
                else if (def.DMSWorkflowStatusId == ShippingDocWFS.READY.Id)
                    def.PaymentStatus = "Document Ready To Check";
                else if (def.DMSWorkflowStatusId == ShippingDocWFS.REJECTED.Id)
                    def.PaymentStatus = "Rejected";
                else if (def.DMSWorkflowStatusId == ShippingDocWFS.ACCEPTED.Id)
                    def.PaymentStatus = "Accepted";
                else if (def.DMSWorkflowStatusId == ShippingDocWFS.REVIEWED.Id)
                    def.PaymentStatus = "Reviewed";

                /*
                if (def.SupplierInvoiceNo != String.Empty)
                {
                    ArrayList queryStructs = new ArrayList();
                    queryStructs.Add(new QueryStructDef("DOCUMENTTYPE", "Shipping - UK Contract"));
                    queryStructs.Add(new QueryStructDef("Supplier Invoice no.", def.SupplierInvoiceNo));
                    ArrayList qList = DMSUtil.queryDocument(queryStructs);

                    foreach (DocumentInfoDef docInfoDef in qList)
                    {
                        foreach (AttachmentInfoDef aDef in docInfoDef.AttachmentInfos)
                        {
                            def.DMSAttachmentId = aDef.AttachmentID;
                        }
                    }
                }
                */
                def.LGDate = (row.IsLGDateNull() ? DateTime.MinValue : row.LGDate);
                list.Add(def);
            }
            return list;
        }

        public ArrayList GetSupplierProductByItemNo(string itemNo)
        {
            ArrayList list = new ArrayList();

            IDataSetAdapter ad = getDataSetAdapter("AccountCurrencyApt", "getBaseCurrencyList");
            CurrencyDs ds = new CurrencyDs();
            int recordsAffected = ad.Fill(ds);

            if (recordsAffected < 1) return null;

            for (int i = 0; i < ds.Tables["CurrencyList"].Rows.Count; i++)
            {
                CurrencyRef rf = new CurrencyRef();
                rf.CurrencyId = int.Parse(ds.Tables["CurrencyList"].Rows[i]["CurrencyId"].ToString());
                rf.CurrencyCode = (ds.Tables["CurrencyList"].Rows[i]["CurrencyCode"].ToString());
                rf.Name = (ds.Tables["CurrencyList"].Rows[i]["Name"].ToString());
                list.Add(rf);
            }
            return list;

        }

        public void executeCutoffProcedure(string procedureName, OfficeRef office, int fiscalYear, int period, int userId)
        {
            IDataSetAdapter ad = getDataSetAdapter("MonthEndCutoffApt", procedureName);
            ad.SelectCommand.Parameters["@OfficeCode"].Value = office.OfficeCode;
            ad.SelectCommand.Parameters["@fiscalYear"].Value = fiscalYear;
            ad.SelectCommand.Parameters["@Period"].Value = period;
            ad.SelectCommand.DbCommand.CommandTimeout = 0;
            ad.SelectCommand.ExecuteNonQuery();
        }

        public ArrayList captureNUKSales(int fiscalYear, int fiscalPeriod)
        {
            TransactionContext ctx = TransactionContextFactory.GetContext(TransactionAffinity.Required);
            try
            {
                ctx.Enter();
                TransactionContext currentCtx = TransactionContextFactory.GetCurrentContext();

                IDataSetAdapter ad = getDataSetAdapter("NUKSalesApt", "CaptureNUKSales");
                ad.SelectCommand.Parameters["@FiscalYear"].Value = fiscalYear;
                ad.SelectCommand.Parameters["@Period"].Value = fiscalPeriod;

                NUKSalesDs dataSet = new NUKSalesDs();
                ad.SelectCommand.DbCommand.CommandTimeout = 300;
                int recordsAffected = ad.Fill(dataSet);

                ArrayList list = new ArrayList();

                foreach (NUKSalesDs.NUKSalesRow row in dataSet.NUKSales)
                {
                    NUKSalesDef def = new NUKSalesDef();
                    NUKSalesMapping(row, def);
                    list.Add(def);
                }

                ctx.VoteCommit();

                return list;
            }
            catch (Exception e)
            {
                ctx.VoteRollback();
                throw e;
            }
            finally
            {
                ctx.Exit();
            }
        }

        public EpicorGLJournalDetailListDef getTurkeyEpicorGLJournalDetailList(int fiscalYear, int period, TypeCollector segValueList)
        {
            EpicorGLJournalDetailDs dataSet = new EpicorGLJournalDetailDs();
            IDataSetAdapter ad = getDataSetAdapter("EpicorGLJournalDetailApt", "GetTurkeyGLJournalDetail");

            ad.SelectCommand.DbCommand.CommandTimeout = 120;
            ad.SelectCommand.Parameters["@FiscalYear"].Value = fiscalYear;
            ad.SelectCommand.Parameters["@FiscalPeriod"].Value = period;
            ad.SelectCommand.CustomParameters["@SegValueList"] = CustomDataParameter.parse(segValueList.IsInclusive, segValueList.Values);
            dataSet.EnforceConstraints = false;
            int recordsAffected = ad.Fill(dataSet);

            EpicorGLJournalDetailListDef list = new EpicorGLJournalDetailListDef();

            list.EpicorGLJournalDetailList = new List<EpicorGLJournalDetailDef>();
            foreach (EpicorGLJournalDetailDs.EpicorGLJournalDetailRow row in dataSet.EpicorGLJournalDetail)
            {
                EpicorGLJournalDetailDef def = new EpicorGLJournalDetailDef();
                EpicorGLJournalDetailMapping(row, def);
                list.EpicorGLJournalDetailList.Add(def);
            }
            return list;
        }

        public void insertTurkeyEpicorGLJournalRecord(List<EpicorGLJournalDetailDef> list, int fiscalYear, int period, int userId)
        {
            TransactionContext ctx = TransactionContextFactory.GetContext(TransactionAffinity.Required);
            try
            {
                ctx.Enter();
                TransactionContext currentCtx = TransactionContextFactory.GetCurrentContext();

                IDataSetAdapter ad = getDataSetAdapter("EpicorGLJournalExtractLogApt", "GetEpicorGLExtractLog");
                ad.SelectCommand.Parameters["@FiscalYear"].Value = fiscalYear;
                ad.SelectCommand.Parameters["@FiscalPeriod"].Value = period;
                ad.PopulateCommands();

                EpicorGLExtractLogDs dataSet = new EpicorGLExtractLogDs();
                EpicorGLExtractLogDs.EpicorGLExtractLogRow row = null;

                int recordsAffected = ad.Fill(dataSet);

                foreach (EpicorGLJournalDetailDef temp in list)
                {
                    row = dataSet.EpicorGLExtractLog.NewEpicorGLExtractLogRow();
                    EpicorGLExtractLogMapping(temp, row, userId);
                    sealStamp(row, userId, Stamp.INSERT);
                    dataSet.EpicorGLExtractLog.AddEpicorGLExtractLogRow(row);
                    recordsAffected += ad.Update(dataSet);

                    NTInvoiceDef invoiceDef = NonTradeWorker.Instance.getNTInvoiceByRefNo(temp.LegalNumber);
                    if (invoiceDef != null && invoiceDef.LogoInterfaceDate != DateTime.MinValue)
                    {
                        invoiceDef.LogoInterfaceDate = DateTime.Today;
                        NonTradeWorker.Instance.updateNTInvoice(invoiceDef, new ArrayList(), userId);
                    }
                }

                if (recordsAffected < 1)
                    throw new DataAccessException("Update EpicorGLExtractlog ERROR");

                ctx.VoteCommit();
            }
            catch (Exception e)
            {
                Console.WriteLine("ERROR " + e.Message);
                ctx.VoteRollback();
                throw e;
            }
            finally
            {
                ctx.Exit();
            }
        }

        public SortedList getEpicorVendorByCriteria(int vendorNum, string epicorVendorId, string epicorCompany)
        {
            IDataSetAdapter ad = getDataSetAdapter("EpicorVendorApt", "GetEpicorVendorByCriteria");
            ad.SelectCommand.Parameters["@VendorNum"].Value = vendorNum;
            ad.SelectCommand.Parameters["@VendorId"].Value = epicorVendorId;
            ad.SelectCommand.Parameters["@Company"].Value = epicorCompany;
            ad.SelectCommand.DbCommand.CommandTimeout = 120;
            EpicorVendorDs dataSet = new EpicorVendorDs();
            EpicorVendorDef def = null;
            int recordsAffected = ad.Fill(dataSet);

            SortedList list = new SortedList();
            if (recordsAffected > 0)
                foreach (EpicorVendorDs.EpicorVendorRow row in dataSet.EpicorVendor.Rows)
                {
                    def = new EpicorVendorDef();
                    this.EpicorVendorMapping(row, def);
                    list.Add(def.Key, def);
                }
            return list;
        }

        internal void EpicorGLExtractLogMapping(Object source, Object target, int userId)
        {
            if (source.GetType() == typeof(EpicorGLJournalDetailDef) &&
                target.GetType() == typeof(EpicorGLExtractLogDs.EpicorGLExtractLogRow))
            {
                EpicorGLJournalDetailDef row = (EpicorGLJournalDetailDef)source;
                EpicorGLExtractLogDs.EpicorGLExtractLogRow def = (EpicorGLExtractLogDs.EpicorGLExtractLogRow)target;

                def.Company = row.Company;
                def.FiscalYear = row.FiscalYear;
                def.FiscalPeriod = row.FiscalPeriod;
                def.RecordId = row.RecordId;
                def.CreatedBy = userId;
                def.CreatedOn = DateTime.Now;
            }
        }


        internal void EpicorVendorMapping(Object source, Object target)
        {
            if (source.GetType() == typeof(EpicorVendorDs.EpicorVendorRow) &&
                target.GetType() == typeof(EpicorVendorDef))
            {
                EpicorVendorDs.EpicorVendorRow row = (EpicorVendorDs.EpicorVendorRow)source;
                EpicorVendorDef def = (EpicorVendorDef)target;
                def.VendorNum = (row.IsVendorNumNull() ? 0 : row.VendorNum);
                def.Company = (row.IsCompanyNull() ? string.Empty : row.Company);
                def.VendorID = (row.IsVendorIdNull() ? string.Empty : row.VendorId);
                def.Name = (row.IsNameNull() ? string.Empty : row.Name);
                def.Address1 = (row.IsAddress1Null() ? string.Empty : row.Address1);
                def.Address2 = (row.IsAddress2Null() ? string.Empty : row.Address2);
                def.Address3 = (row.IsAddress3Null() ? string.Empty : row.Address3);
                def.City = (row.IsCityNull() ? string.Empty : row.City);
                def.State = (row.IsStateNull() ? string.Empty : row.State);
                def.ZIP = (row.IsZIPNull() ? string.Empty : row.ZIP);
                def.Country = (row.IsCountryNull() ? string.Empty : row.Country);
                def.Key = def.VendorID + "|" + def.Company;
            }
            else
            {
                EpicorVendorDs.EpicorVendorRow row = (EpicorVendorDs.EpicorVendorRow)target;
                EpicorVendorDef def = (EpicorVendorDef)source;
                if (def.Company != null) def.Company = def.Company; else row.SetCompanyNull();
                if (def.VendorID != null) def.VendorID = def.VendorID; else row.SetVendorIdNull();
                if (def.Name != null) def.Name = def.Name; else row.SetNameNull();
                if (def.VendorNum != int.MinValue) row.VendorNum = def.VendorNum; else row.SetVendorNumNull();
                if (def.Address1 != null) def.Address1 = def.Address1; else row.SetAddress1Null();
                if (def.Address2 != null) def.Address2 = def.Address2; else row.SetAddress2Null();
                if (def.Address3 != null) def.Address3 = def.Address3; else row.SetAddress3Null();
                if (def.City != null) def.City = def.City; else row.SetCityNull();
                if (def.State != null) def.State = def.State; else row.SetStateNull();
                if (def.ZIP != null) def.ZIP = def.ZIP; else row.SetZIPNull();
                if (def.Country != null) def.Country = def.Country; else row.SetCountryNull();
            }
        }

        public EpicorGLExtractLogListDef getTurkeyEpicorGLJournalRecordCount(int fiscalYear, int period)
        {
            EpicorGLExtractLogDs dataSet = new EpicorGLExtractLogDs();
            IDataSetAdapter ad = getDataSetAdapter("EpicorGLJournalExtractLogApt", "GetEpicorGLExtractLog");
            ad.SelectCommand.DbCommand.CommandTimeout = 120;
            ad.SelectCommand.Parameters["@FiscalYear"].Value = fiscalYear;
            ad.SelectCommand.Parameters["@FiscalPeriod"].Value = period;

            int recordsAffected = ad.Fill(dataSet);

            EpicorGLExtractLogListDef list = new EpicorGLExtractLogListDef();

            list.EpicorGLExtractLogList = new List<EpicorGLExtractLogDef>();
            foreach (EpicorGLExtractLogDs.EpicorGLExtractLogRow row in dataSet.EpicorGLExtractLog)
            {
                EpicorGLExtractLogDef def = new EpicorGLExtractLogDef();
                EpicorGLExtractLogMapping(row, def);
                list.EpicorGLExtractLogList.Add(def);
            }
            return list;

        }

        internal void EpicorGLExtractLogMapping(Object source, Object target)
        {
            if (source.GetType() == typeof(EpicorGLExtractLogDs.EpicorGLExtractLogRow) &&
                target.GetType() == typeof(EpicorGLExtractLogDef))
            {
                EpicorGLExtractLogDs.EpicorGLExtractLogRow row = (EpicorGLExtractLogDs.EpicorGLExtractLogRow)source;
                EpicorGLExtractLogDef def = (EpicorGLExtractLogDef)target;

                def.RecordId = row.RecordId;
                def.Company = row.Company;
                def.FiscalYear = row.FiscalYear;
                def.FiscalPeriod = row.FiscalPeriod;
                def.CreatedBy = row.CreatedBy;
                def.CreatedOn = row.CreatedOn;
            }
        }

        public List<NSLedImportFileDef> getNSLedFiscalYearList()
        {
            NSLedImportFileDs dataSet = new NSLedImportFileDs();
            IDataSetAdapter ad = getDataSetAdapter("NSLedImportFileApt", "GetNSLedFiscalYearList");
            ad.SelectCommand.DbCommand.CommandTimeout = 120;

            dataSet.EnforceConstraints = false;
            int recordsAffected = ad.Fill(dataSet);
            List<NSLedImportFileDef> list = new List<NSLedImportFileDef>();
            foreach (NSLedImportFileDs.NSLedImportFileRow row in dataSet.NSLedImportFile)
            {
                NSLedImportFileDef def = new NSLedImportFileDef();
                def.FiscalYear = row.FiscalYear;
                list.Add(def);
            }
            return list;
        }

        public List<NSLedImportFileDef> getNSLedFiscalWeekList(int Year)
        {
            NSLedImportFileDs dataSet = new NSLedImportFileDs();
            IDataSetAdapter ad = getDataSetAdapter("NSLedImportFileApt", "GetNSLedFiscalWeekList");
            ad.SelectCommand.Parameters["@Year"].Value = Year;
            ad.SelectCommand.DbCommand.CommandTimeout = 120;

            dataSet.EnforceConstraints = false;
            int recordsAffected = ad.Fill(dataSet);
            List<NSLedImportFileDef> list = new List<NSLedImportFileDef>();
            foreach (NSLedImportFileDs.NSLedImportFileRow row in dataSet.NSLedImportFile)
            {
                NSLedImportFileDef def = new NSLedImportFileDef();
                def.FiscalWeek = row.FiscalWeek;
                list.Add(def);
            }
            return list;
        }

        public List<NSLedSalesDef> getNSLedSalesCountry()
        {
            NSLedSalesDs dataSet = new NSLedSalesDs();
            IDataSetAdapter ad = getDataSetAdapter("NSLedSalesApt", "GetNSLedSalesCountry");
            ad.SelectCommand.DbCommand.CommandTimeout = 120;

            dataSet.EnforceConstraints = false;
            int recordsAffected = ad.Fill(dataSet);
            List<NSLedSalesDef> list = new List<NSLedSalesDef>();
            foreach (NSLedSalesDs.NSLedSalesRow row in dataSet.NSLedSales)
            {
                NSLedSalesDef def = new NSLedSalesDef();
                def.CountryOfSale = row.CountryOfSale;
                list.Add(def);
            }
            return list;
        }

        public List<NSLedSalesDef> getNSLedSalesDetail(int fileId)
        {
            IDataSetAdapter dataSetAdapter = getDataSetAdapter("NSLedSalesApt", "GetNSLedSalesDetail");
            dataSetAdapter.SelectCommand.Parameters["@FileId"].Value = fileId.ToString();
            NSLedSalesDs dataSet = new NSLedSalesDs();
            dataSetAdapter.SelectCommand.DbCommand.CommandTimeout = 120;
            dataSet.EnforceConstraints = false;
            int num = dataSetAdapter.Fill(dataSet);
            List<NSLedSalesDef> list = new List<NSLedSalesDef>();
            foreach (NSLedSalesDs.NSLedSalesRow row in dataSet.NSLedSales)
            {
                NSLedSalesDef nSLedSalesDef = new NSLedSalesDef();
                NSLedSalesDefMapping(row, nSLedSalesDef);
                list.Add(nSLedSalesDef);
            }
            return list;
        }


        public ArrayList getNSLedSales(int officeId, string invoiceNo, int fiscalYear, int fiscalWeek, string itemNo, string countryOfSale)
        {
            IDataSetAdapter dataSetAdapter = getDataSetAdapter("NSLedSalesApt", "GetNSLedSales");
            dataSetAdapter.SelectCommand.Parameters["@OfficeId"].Value = officeId.ToString();
            dataSetAdapter.SelectCommand.Parameters["@InvoiceNo"].Value = invoiceNo;
            dataSetAdapter.SelectCommand.Parameters["@FiscalYear"].Value = fiscalYear;
            dataSetAdapter.SelectCommand.Parameters["@FiscalWeek"].Value = fiscalWeek;
            dataSetAdapter.SelectCommand.Parameters["@ItemNo"].Value = itemNo;
            dataSetAdapter.SelectCommand.Parameters["@CountryOfSale"].Value = countryOfSale;
            NSLedSalesDs dataSet = new NSLedSalesDs();
            dataSetAdapter.SelectCommand.DbCommand.CommandTimeout = 120;
            dataSet.EnforceConstraints = false;
            int num = dataSetAdapter.Fill(dataSet);
            ArrayList arrayList = new ArrayList();
            foreach (NSLedSalesDs.NSLedSalesRow row in dataSet.NSLedSales)
            {
                NSLedSalesDef def = new NSLedSalesDef();
                NSLedSalesDefMapping(row, def);
                arrayList.Add(def);
            }
            return arrayList;
        }

        public void updateNSLedImportFile(NSLedImportFileDef def, int userId)
        {
            TransactionContext ctx = TransactionContextFactory.GetContext(TransactionAffinity.Required);
            try
            {
                ctx.Enter();
                TransactionContext currentCtx = TransactionContextFactory.GetCurrentContext();

                IDataSetAdapter ad = getDataSetAdapter("NSLedImportFileApt", "GetNSLedImportFileByKey");
                ad.SelectCommand.Parameters["@FileId"].Value = def.FileId;
                ad.PopulateCommands();

                NSLedImportFileDs dataSet = new NSLedImportFileDs();
                NSLedImportFileDs.NSLedImportFileRow row = null;

                int recordsAffected = ad.Fill(dataSet);
                if (recordsAffected > 0)
                {
                    row = dataSet.NSLedImportFile[0];
                    NSLedImportFileMapping(def, row);
                    sealStamp(row, userId, Stamp.UPDATE);
                }
                else
                {
                    row = dataSet.NSLedImportFile.NewNSLedImportFileRow();
                    def.FileId = this.getMaxNSLedImportFileId() + 1;
                    this.NSLedImportFileMapping(def, row);
                    sealStamp(row, userId, Stamp.INSERT);
                    dataSet.NSLedImportFile.AddNSLedImportFileRow(row);
                }
                recordsAffected = ad.Update(dataSet);
                if (recordsAffected < 1)
                    throw new DataAccessException("Update NS-LED Import File ERROR");
                ctx.VoteCommit();
            }
            catch (Exception e)
            {
                Console.WriteLine("ERROR " + e.Message);
                ctx.VoteRollback();
                throw e;
            }
            finally
            {
                ctx.Exit();
            }
        }

        public void updateNSLedSalesDetailList(int fileId, List<NSLedSalesDef> list, int userId)
        {
            TransactionContext ctx = TransactionContextFactory.GetContext(TransactionAffinity.Required);
            try
            {
                ctx.Enter();
                TransactionContext currentCtx = TransactionContextFactory.GetCurrentContext();
                ShippingWorker shippingWorker = ShippingWorker.Instance;
                if (list != null && list.Count > 0)
                    foreach (NSLedSalesDef updateDef in list)
                    {
                        updateDef.FileId = fileId;
                        this.updateNSLedSalesDetail(updateDef, userId);
                    }
                ctx.VoteCommit();
            }
            catch (Exception e)
            {
                Console.WriteLine("ERROR " + e.Message);
                ctx.VoteRollback();
                throw e;
            }
            finally
            {
                ctx.Exit();
            }
        }

        public void updateNSLedSalesDetail(NSLedSalesDef def, int userId)
        {
            TransactionContext ctx = TransactionContextFactory.GetContext(TransactionAffinity.Required);
            try
            {
                ctx.Enter();
                TransactionContext currentCtx = TransactionContextFactory.GetCurrentContext();

                IDataSetAdapter ad = getDataSetAdapter("NSLedSalesApt", "GetNSLedSalesByKey");
                ad.SelectCommand.Parameters["@FileId"].Value = def.FileId;
                ad.SelectCommand.Parameters["@DetailId"].Value = def.DetailId;
                ad.PopulateCommands();

                NSLedSalesDs dataSet = new NSLedSalesDs();
                NSLedSalesDs.NSLedSalesRow row = null;

                int recordsAffected = ad.Fill(dataSet);
                if (recordsAffected <= 0)
                {
                    row = dataSet.NSLedSales.NewNSLedSalesRow();
                    this.NSLedSalesDefMapping(def, row);
                    sealStamp(row, userId, Stamp.INSERT);
                    dataSet.NSLedSales.AddNSLedSalesRow(row);
                    recordsAffected = ad.Update(dataSet);
                    if (recordsAffected < 1)
                        throw new DataAccessException("Add NS-LED Sales Detail ERROR");
                }
                else
                {
                    row = dataSet.NSLedSales[0];
                    if (row.Status == 0)
                    {
                        def.Status = 1;
                    }
                    this.NSLedSalesDefMapping(def, row);
                    sealStamp(row, userId, Stamp.UPDATE);
                    recordsAffected = ad.Update(dataSet);
                    if (recordsAffected < 1)
                        throw new DataAccessException("Re-Add NS-LED Sales Detail ERROR");
                }
                ctx.VoteCommit();
            }
            catch (Exception e)
            {
                Console.WriteLine("ERROR " + e.Message);
                System.Diagnostics.Debug.WriteLine(e.Message);
                MailHelper.sendErrorAlert(e, "");
                ctx.VoteRollback();
                throw e;
            }
            finally
            {
                ctx.Exit();
            }
        }

        public NSLedImportFileDef getNSLedImportFileByKey(int fileId)
        {
            IDataSetAdapter ad = getDataSetAdapter("NSLedImportFileApt", "GetNSLedImportFileByKey");
            ad.SelectCommand.Parameters["@FileId"].Value = fileId;
            NSLedImportFileDs dataSet = new NSLedImportFileDs();
            NSLedImportFileDef def = null;

            ad.SelectCommand.DbCommand.CommandTimeout = 120;
            int recordsAffected = ad.Fill(dataSet);
            if (recordsAffected > 0)
            {
                NSLedImportFileDs.NSLedImportFileRow row = dataSet.NSLedImportFile[0];
                def = new NSLedImportFileDef();
                this.NSLedImportFileMapping(row, def);
            }
            return def;
        }

        public NSLedImportFileDef getNSLedImportFileByInvoiceNo(string invoiceNo)
        {
            IDataSetAdapter ad = getDataSetAdapter("NSLedImportFileApt", "GetNSLedImportFileByInvoiceNo");
            ad.SelectCommand.Parameters["@InvoiceNo"].Value = invoiceNo;
            NSLedImportFileDs dataSet = new NSLedImportFileDs();
            NSLedImportFileDef def = null;

            ad.SelectCommand.DbCommand.CommandTimeout = 120;
            int recordsAffected = ad.Fill(dataSet);
            if (recordsAffected > 0)
            {
                NSLedImportFileDs.NSLedImportFileRow row = dataSet.NSLedImportFile[0];
                def = new NSLedImportFileDef();
                this.NSLedImportFileMapping(row, def);
            }
            return def;
        }


        public NSLedSalesDef getNSLedSalesByKey(int FileId, int DetailId)
        {
            IDataSetAdapter ad = getDataSetAdapter("NSLedSalesApt", "GetNSLedSalesByKey");
            ad.SelectCommand.Parameters["@FileId"].Value = FileId;
            ad.SelectCommand.Parameters["@DetailId"].Value = DetailId;
            NSLedSalesDs dataSet = new NSLedSalesDs();
            NSLedSalesDef def = null;

            ad.SelectCommand.DbCommand.CommandTimeout = 120;
            int recordsAffected = ad.Fill(dataSet);
            if (recordsAffected > 0)
            {
                NSLedSalesDs.NSLedSalesRow row = dataSet.NSLedSales[0];
                def = new NSLedSalesDef();
                this.NSLedSalesDefMapping(row, def);
            }
            return def;
        }

        public int getMaxNSLedImportFileId()
        {
            int fileId = 0;
            NSLedImportFileDs dataSet = new NSLedImportFileDs();
            IDataSetAdapter ad = getDataSetAdapter("NSLedImportFileApt", "GetMaxNSLedImportFileId");
            ad.SelectCommand.DbCommand.CommandTimeout = 120;

            dataSet.EnforceConstraints = false;
            int recordsAffected = ad.Fill(dataSet);

            if (dataSet.NSLedImportFile.Rows[0][0] != DBNull.Value)
                fileId = ((int)dataSet.NSLedImportFile.Rows[0][0]);
            return fileId;
        }

        private void NSLedImportFileMapping(Object source, Object target)
        {
            if (source.GetType() == typeof(NSLedImportFileDs.NSLedImportFileRow) &&
                target.GetType() == typeof(NSLedImportFileDef))
            {
                NSLedImportFileDs.NSLedImportFileRow row = (NSLedImportFileDs.NSLedImportFileRow)source;
                NSLedImportFileDef def = (NSLedImportFileDef)target;

                def.FileId = row.FileId;
                def.Filename = row.Filename;
                def.InvoiceNo = row.InvoiceNo;
                def.InvoiceDate = row.InvoiceDate;
                def.OfficeId = row.OfficeId;
                /*
                def.CustomerType = row.CustomerType;
                */
                def.CurrencyId = row.CurrencyId;
                def.SupplierCode = row.SupplierCode;
                def.IsDutiable = row.IsDutiable;
                def.TotalNSCommissionAmt = row.TotalNSCommAmt;
                def.FiscalWeek = row.FiscalWeek;
                def.FiscalYear = row.FiscalYear;
                def.Period = row.Period;
                def.IsInterfaced = row.IsInterfaced;
                def.CreatedBy = row.CreatedBy;
                def.CreatedOn = row.CreatedOn;
            }
            else if (source.GetType() == typeof(NSLedImportFileDef) &&
                target.GetType() == typeof(NSLedImportFileDs.NSLedImportFileRow))
            {
                NSLedImportFileDef def = (NSLedImportFileDef)source;
                NSLedImportFileDs.NSLedImportFileRow row = (NSLedImportFileDs.NSLedImportFileRow)target;

                row.FileId = def.FileId;
                row.Filename = def.Filename;
                row.InvoiceNo = def.InvoiceNo;
                row.InvoiceDate = def.InvoiceDate;
                row.OfficeId = def.OfficeId;
                /*
                row.CustomerType = def.CustomerType;
                */
                row.CurrencyId = def.CurrencyId;
                row.SupplierCode = def.SupplierCode;
                row.IsDutiable = def.IsDutiable;
                row.TotalNSCommAmt = def.TotalNSCommissionAmt;
                row.FiscalWeek = def.FiscalWeek;
                row.FiscalYear = def.FiscalYear;
                row.Period = def.Period;
                if (def.IsInterfaced == 1)
                    row.IsInterfaced = def.IsInterfaced;
                else if (row.RowState == DataRowState.Detached)
                    row.IsInterfaced = 0;
                row.CreatedBy = def.CreatedBy;
                row.CreatedOn = def.CreatedOn;
            }
        }

        private void NSLedFinanceReportBFValuesMapping(Object source, Object target)
        {
            if (source.GetType() == typeof(NSLedFinanceReportBFValuesDs.NSLedFinanceReportBFValuesRow) &&
                target.GetType() == typeof(NSLedFinanceReportBFValuesDef))
            {
                NSLedFinanceReportBFValuesDs.NSLedFinanceReportBFValuesRow row = (NSLedFinanceReportBFValuesDs.NSLedFinanceReportBFValuesRow)source;
                NSLedFinanceReportBFValuesDef def = (NSLedFinanceReportBFValuesDef)target;

                def.CurrentYear = row.CurrentYear;
                def.OfficeId = row.OfficeId;
                def.SeasonId = row.SeasonId;
                def.ItemNo = row.ItemNo;
                def.SoldQty = row.SoldQty;
                def.NSSales = row.NSSales;
                def.Cost = row.Cost;
                def.Margin = row.Margin;
                def.SettlementDiscountAmount = row.SettlementDiscountAmt;
                def.Provision = row.Provision;
                def.TotalPL = row.TotalPL;
                def.CumulativePL = row.CumPL;
                def.Stock = row.Stock;
                def.SettlementDiscountAmountForStock = row.SettlementDiscountAmtForStock;
                def.ProvisionForStock = row.ProvisionForStock;
                def.TotalBalanceSheet = row.TotalBS;
                def.CumulativeBalanceSheet = row.CumBS;
            }
        }

        private void NSLedFinanceReportCYValuesMapping(Object source, Object target)
        {
            if (source.GetType() == typeof(NSLedFinanceReportCYValuesDs.NSLedFinanceReportCYValuesRow) &&
                target.GetType() == typeof(NSLedFinanceReportCYValuesDef))
            {
                NSLedFinanceReportCYValuesDs.NSLedFinanceReportCYValuesRow row = (NSLedFinanceReportCYValuesDs.NSLedFinanceReportCYValuesRow)source;
                NSLedFinanceReportCYValuesDef def = (NSLedFinanceReportCYValuesDef)target;

                def.CurrentYear = row.CurrentYear;
                def.OfficeId = row.OfficeId;
                def.SeasonId = row.SeasonId;
                def.WeekNo = row.WeekNo;
                def.ItemNo = row.ItemNo;
                def.SoldQty = row.SoldQty;
                def.NSSales = row.NSSales;
                def.Cost = row.Cost;
                def.Margin = row.Margin;
                def.SettlementDiscountAmount = row.SettlementDiscountAmt;
                def.Provision = row.Provision;
                def.TotalPL = row.TotalPL;
                def.CumulativePL = row.CumPL;
                def.Stock = row.Stock;
                def.SettlementDiscountAmountForStock = row.SettlementDiscountAmtForStock;
                def.ProvisionForStock = row.ProvisionForStock;
                def.TotalBalanceSheet = row.TotalBS;
                def.CumulativeBalanceSheet = row.CumBS;
            }
        }

        private void NSLedSalesDefMapping(Object source, Object target)
        {
            if (source.GetType() == typeof(NSLedSalesDs.NSLedSalesRow) &&
                target.GetType() == typeof(NSLedSalesDef))
            {
                NSLedSalesDs.NSLedSalesRow row = (NSLedSalesDs.NSLedSalesRow)source;
                NSLedSalesDef def = (NSLedSalesDef)target;

                def.FileId = row.FileId;
                def.DetailId = row.DetailId;
                def.ItemNo = row.ItemNo;
                def.SizeOptionNo = row.SizeOptionNo;
                if (!row.IsSizeDescNull())
                    def.SizeDesc = row.SizeDesc;
                else
                    def.SizeDesc = string.Empty;
                if (!row.IsItemDescNull())
                    def.ItemDesc = row.ItemDesc;
                else
                    def.ItemDesc = string.Empty;
                def.DespatchQty = row.DespatchQty;
                def.DespatchAmt = row.DespatchAmt;
                def.ReturnQty = row.ReturnQty;
                def.ReturnAmt = row.ReturnAmt;
                def.NetQty = row.NetQty;
                def.NetAmt = row.NetAmt;
                def.CountryOfSale = row.CountryOfSale;
                def.VATPercent = row.VATPercent;
                def.VAT = row.VAT;
                def.NSVE = row.NSVE;
                def.CommPercent = row.CommPercent;
                def.UKCommAmt = row.UKCommAmt;
                def.NSCommAmt = row.NSCommAmt;
                def.USDExRate = row.USDExRate;
                def.UKCommAmtInUSD = row.UKCommAmtInUSD;
                def.NSCommAmtInUSD = row.NSCommAmtInUSD;
                def.CustomerType = row.CustomerType;
                def.Status = row.Status;
                def.CreatedBy = row.CreatedBy;
                def.CreatedOn = row.CreatedOn;
                /*
                def.ModifiedBy = row.ModifiedBy;
                def.ModifiedOn = row.ModifiedOn;
                */
            }
            else if (source.GetType() == typeof(NSLedSalesDef) &&
                target.GetType() == typeof(NSLedSalesDs.NSLedSalesRow))
            {
                NSLedSalesDef def = (NSLedSalesDef)source;
                NSLedSalesDs.NSLedSalesRow row = (NSLedSalesDs.NSLedSalesRow)target;

                row.FileId = def.FileId;
                row.DetailId = def.DetailId;
                row.ItemNo = def.ItemNo;
                row.SizeOptionNo = def.SizeOptionNo;
                if (def.SizeDesc.Trim() == string.Empty)
                    row.SetSizeDescNull();
                else
                    row.SizeDesc = def.SizeDesc;
                if (def.ItemDesc.Trim() == string.Empty)
                    row.SetItemDescNull();
                else
                    row.ItemDesc = def.ItemDesc;
                row.DespatchQty = def.DespatchQty;
                row.DespatchAmt = def.DespatchAmt;
                row.ReturnQty = def.ReturnQty;
                row.ReturnAmt = def.ReturnAmt;
                row.NetQty = def.NetQty;
                row.NetAmt = def.NetAmt;
                row.CountryOfSale = def.CountryOfSale;
                row.VATPercent = def.VATPercent;
                row.VAT = def.VAT;
                row.NSVE = def.NSVE;
                row.CommPercent = def.CommPercent;
                row.UKCommAmt = def.UKCommAmt;
                row.NSCommAmt = def.NSCommAmt;
                row.USDExRate = def.USDExRate;
                row.UKCommAmtInUSD = def.UKCommAmtInUSD;
                row.NSCommAmtInUSD = def.NSCommAmtInUSD;
                row.CustomerType = def.CustomerType;
                row.Status = def.Status;
                row.CreatedBy = def.CreatedBy;
                row.CreatedOn = def.CreatedOn;
                /*
                row.ModifiedBy = def.ModifiedBy;
                row.ModifiedOn = def.ModifiedOn;
                */
            }
        }

        private void NSLedSelfBilledSupplierCodeMapping(Object source, Object target)
        {
            if (source.GetType() == typeof(NSLedSelfBilledSupplierCodeDs.NSLedSelfBilledSupplierCodeRow) &&
                target.GetType() == typeof(NSLedSelfBilledSupplierCodeDef))
            {
                NSLedSelfBilledSupplierCodeDs.NSLedSelfBilledSupplierCodeRow row = (NSLedSelfBilledSupplierCodeDs.NSLedSelfBilledSupplierCodeRow)source;
                NSLedSelfBilledSupplierCodeDef def = (NSLedSelfBilledSupplierCodeDef)target;

                def.SeqId = row.SeqId;
                def.UKSupplierCode = row.UKSupplierCode;
                def.Status = row.Status;
                def.CreatedBy = row.CreatedBy;

                def.CreatedOn = row.CreatedOn;
                def.ModifiedBy = row.IsModifiedByNull() ? -1 : row.ModifiedBy;
                def.ModifiedOn = row.IsModifiedOnNull() ? DateTime.MinValue : row.ModifiedOn;
                def.OfficeId = row.IsOfficeIdNull() ? -1 : row.OfficeId;
                def.Remark = row.IsRemarkNull() ? "" : row.Remark;
            }
            else if (source.GetType() == typeof(NSLedSelfBilledSupplierCodeDef) &&
                target.GetType() == typeof(NSLedSelfBilledSupplierCodeDs.NSLedSelfBilledSupplierCodeRow))
            {
                NSLedSelfBilledSupplierCodeDef def = (NSLedSelfBilledSupplierCodeDef)source;
                NSLedSelfBilledSupplierCodeDs.NSLedSelfBilledSupplierCodeRow row = (NSLedSelfBilledSupplierCodeDs.NSLedSelfBilledSupplierCodeRow)target;

                row.SeqId = def.SeqId;
                row.UKSupplierCode = def.UKSupplierCode;
                row.Status = def.Status;
                row.CreatedBy = def.CreatedBy;
                row.CreatedOn = def.CreatedOn;
                row.ModifiedBy = def.ModifiedBy;
                row.ModifiedOn = def.ModifiedOn;
                row.OfficeId = def.OfficeId;
                row.Remark = def.Remark;
            }
        }

        public List<NSLedFPQtyDef> getFPSellthroughGrowthRate(string ItemNo)
        {
            IDataSetAdapter ad = getDataSetAdapter("NSLedFPQtyApt", "GetFPSellthroughGrowthRate");
            ad.SelectCommand.Parameters["@ItemNo"].Value = ItemNo;
            ad.SelectCommand.MailSQL = true;

            NSLedFPQtyDs dataSet = new NSLedFPQtyDs();
            ad.SelectCommand.DbCommand.CommandTimeout = 120;
            dataSet.EnforceConstraints = false;
            int recordsAffected = ad.Fill(dataSet);

            List<NSLedFPQtyDef> list = new List<NSLedFPQtyDef>();

            foreach (NSLedFPQtyDs.NSLedFPQtyRow row in dataSet.NSLedFPQty)
            {
                NSLedFPQtyDef def = new NSLedFPQtyDef();
                try
                {
                    NSLedFPQtyDefMapping(row, def);
                    list.Add(def);
                }
                catch (Exception ex)
                {
                    continue;
                }
            }
            return list;
        }

        private void NSLedFPQtyDefMapping(Object source, Object target)
        {
            if (source.GetType() == typeof(NSLedFPQtyDs.NSLedFPQtyRow) &&
                target.GetType() == typeof(NSLedFPQtyDef))
            {
                NSLedFPQtyDs.NSLedFPQtyRow row = (NSLedFPQtyDs.NSLedFPQtyRow)source;
                NSLedFPQtyDef def = (NSLedFPQtyDef)target;

                def.LaunchYear = row.LaunchYear;
                def.LaunchWeek = row.LaunchWeek;
                def.FPQty = row.FPQty;
            }
        }

        public List<NSLedProfitabilitiesDef> getNSLedProfitabilities(TypeCollector officeIdList, int fiscalYear, int fiscalWeek, TypeCollector phaseId, bool isStillSelling, bool isNotYetLaunched, bool isEndOfLife, int ukProductTeamId, int isDuty)
        {
            IDataSetAdapter ad = getDataSetAdapter("NSLedProfitabilitiesApt", "GetNSLedProfitabilities");
            ad.SelectCommand.CustomParameters["@OfficeId"] = CustomDataParameter.parse(officeIdList.IsInclusive, officeIdList.Values);
            ad.SelectCommand.Parameters["@FiscalYear"].Value = fiscalYear;
            ad.SelectCommand.Parameters["@FiscalWeek"].Value = fiscalWeek;
            ad.SelectCommand.CustomParameters["@PhaseId"] = CustomDataParameter.parse(phaseId.IsInclusive, phaseId.Values);
            ad.SelectCommand.Parameters["@UKProductTeamId"].Value = ukProductTeamId;
            ad.SelectCommand.Parameters["@IsDuty"].Value = isDuty;
            ad.SelectCommand.MailSQL = true;

            NSLedProfitabilitiesDs dataSet = new NSLedProfitabilitiesDs();
            ad.SelectCommand.DbCommand.CommandTimeout = 240;
            dataSet.EnforceConstraints = false;
            int recordsAffected = ad.Fill(dataSet);
            string itemNo = string.Empty;

            List<NSLedProfitabilitiesDef> list = new List<NSLedProfitabilitiesDef>();
            SortedList<string, NSLedRangePlanDef> rangePlanList = getNSLedRangePlanList(officeIdList, phaseId);
            foreach (NSLedProfitabilitiesDs.NSLedProfitabilitiesRow row in dataSet.NSLedProfitabilities)
            {
                NSLedProfitabilitiesDef def = new NSLedProfitabilitiesDef();
                try
                {
                    itemNo = row.ItemNo;

                    string key = row.OfficeId.ToString() + "/" + row.ItemNo;
                    NSLedProfitabilitiesDefMapping(row, def, fiscalYear, fiscalWeek, rangePlanList.ContainsKey(key) ? rangePlanList[key] : null);
                    if ((isStillSelling && !def.IsEndOfLife && def.IsNotYetLaunched == 0) || (isEndOfLife && def.IsEndOfLife) || (isNotYetLaunched && def.IsNotYetLaunched == 1))
                        list.Add(def);
                }
                catch (Exception ex)
                {
                    //The error most likely come from range plan query and just keep the item if it is failed.
                    //Debug the row for viewing the error.
                    MailHelper.sendGeneralMessage("ISAM: getting ns-led profitabilities error", String.Format("getting profitabilities error fiscal year : {0} week : {1} itemno : {2}", fiscalYear.ToString(), fiscalWeek.ToString(), itemNo));
                    continue;
                }
            }
            return list;
        }

        private void NSLedProfitabilitiesDefMapping(Object source, Object target, int fiscalYear, int fiscalWeek)
        {
            NSLedProfitabilitiesDefMapping(source, target, fiscalYear, fiscalWeek, null);
        }

        private void NSLedProfitabilitiesDefMapping(Object source, Object target, int fiscalYear, int fiscalWeek, NSLedRangePlanDef rangePlanDef)
        {
            if (source.GetType() == typeof(NSLedProfitabilitiesDs.NSLedProfitabilitiesRow) &&
                target.GetType() == typeof(NSLedProfitabilitiesDef))
            {
                NSLedProfitabilitiesDs.NSLedProfitabilitiesRow row = (NSLedProfitabilitiesDs.NSLedProfitabilitiesRow)source;
                NSLedProfitabilitiesDef def = (NSLedProfitabilitiesDef)target;
                System.Globalization.CultureInfo info = System.Globalization.CultureInfo.GetCultureInfo("en-GB");

                def.ItemNo = row.ItemNo;
                def.OfficeId = row.OfficeId;
                def.WeekCount = row.WeekCount;
                def.FPWeekCount = row.FPWeekCount;
                def.QtySold = row.QtySold;

                def.FPQty = row.FPQty;
                def.MDQty = def.QtySold - def.FPQty;

                def.UKQty = row.UKQty;
                def.IntQty = def.QtySold - def.UKQty;

                def.TotalNSCommissionAmt = row.TotalNSCommissionAmt;

                if (def.QtySold > 0)
                {
                    def.UKQtyPct = Convert.ToDecimal(def.UKQty) / Convert.ToDecimal(def.QtySold);
                    def.IntQtyPct = Convert.ToDecimal(def.IntQty) / Convert.ToDecimal(def.QtySold);
                }

                def.SeasonCount = row.SeasonCount;

                def.SeasonId = row.SeasonId;
                def.LaunchYear = row.LaunchYear;
                def.LaunchWeek = row.LaunchWeek;
                def.OfficeSortId = row.OfficeSortId;

                if (rangePlanDef == null || def.SeasonCount > 1)
                    rangePlanDef = getNSLedRangePlan(def.OfficeId, def.ItemNo, def.SeasonId);

                if (row.ShippedPeriod < 0)
                {
                    def.ShippedYear = -1;
                    def.ShippedPeriod = -1;

                    if (rangePlanDef.ShippedPeriod > 0)
                    {
                        def.ShippedYear = int.Parse(rangePlanDef.ShippedPeriod.ToString().Substring(0, 4));
                        def.ShippedPeriod = int.Parse(rangePlanDef.ShippedPeriod.ToString().Substring(4));
                    }
                }
                else
                {
                    def.ShippedYear = int.Parse(row.ShippedPeriod.ToString().Substring(0, 4));
                    def.ShippedPeriod = int.Parse(row.ShippedPeriod.ToString().Substring(4));
                }

                def.RangePlanId = rangePlanDef.RangePlanId;
                def.Description = rangePlanDef.Description;
                def.Picture = rangePlanDef.Picture;
                def.ProductTeamName = rangePlanDef.ProductTeamName;
                def.TotalQty = rangePlanDef.TotalQty;
                def.CustomerId = rangePlanDef.CustomerId;
                def.UKDepartment = rangePlanDef.UKDepartment;
                int saleSeasonId = 999;
                int saleSeasonSplitId = 999;

                int expectedSaleSeasonId = 999;
                int expectedSaleSeasonSplitId = 999;

                if (rangePlanDef.ActualSaleSeason.Contains("-") && rangePlanDef.ActualSaleSeason.Split('-').Length == 2)
                {
                    saleSeasonId = Convert.ToInt32(rangePlanDef.ActualSaleSeason.Split('-')[0]);
                    saleSeasonSplitId = Convert.ToInt32(rangePlanDef.ActualSaleSeason.Split('-')[1]);
                }

                if (rangePlanDef.ExpectedSaleSeason.Contains("-") && rangePlanDef.ExpectedSaleSeason.Split('-').Length == 2)
                {
                    expectedSaleSeasonId = Convert.ToInt32(rangePlanDef.ExpectedSaleSeason.Split('-')[0]);
                    expectedSaleSeasonSplitId = Convert.ToInt32(rangePlanDef.ExpectedSaleSeason.Split('-')[1]);
                }

                def.ExpectedSaleSeasonId = expectedSaleSeasonId;
                def.ExpectedSaleSeasonSplitId = expectedSaleSeasonSplitId;

                int seasonYear = 0;
                def.MDYear = 0;
                def.MDWeek = 0;
                def.IsMD = false;

                if (expectedSaleSeasonId < 999 && expectedSaleSeasonSplitId < 999)
                {
                    SeasonRef season = GeneralWorker.Instance.getSeasonByKey(expectedSaleSeasonId);
                    def.ExpectedSaleSeason = (season.Code + ' ' + (expectedSaleSeasonSplitId == 1 ? "MSS" : "EOS")).Replace("/", "");
                }

                if (saleSeasonId < 999 && saleSeasonSplitId < 999)
                {
                    SeasonRef season = GeneralWorker.Instance.getSeasonByKey(saleSeasonId);
                    def.ActualSaleSeason = (season.Code + ' ' + (saleSeasonSplitId == 1 ? "MSS" : "EOS")).Replace("/", "");
                    def.ActualSaleSeasonWithPhase = def.ActualSaleSeason + " (ph" + SeasonRef.getNSLedPhaseId(saleSeasonId, saleSeasonSplitId).ToString() + ")";

                    string[] seasonString = season.Code.Split(' '); //eg: S/S 2019
                    seasonYear = Convert.ToInt32(seasonString[1]);
                    def.MDYear = seasonYear;
                    def.IsMD = true;

                    def.MDWeek = seasonString[0] == "S/S" ?
                                saleSeasonSplitId == 1 ? 8 : 23 // S/S MSS : EOS
                                :
                                saleSeasonSplitId == 1 ? 34 : 48; // A/W MSS : EOS

                    int seasonEndWeek = Convert.ToInt32(seasonString[1]) * 100 + def.MDWeek;

                    //remain still selling if no MD sales after season end -- this statement not valid anymore 2021-02-04
                    /*
                    def.IsEndOfLife = (fiscalYear * 100 + fiscalWeek >= seasonEndWeek) & row.IsEndOfLife; 
                    */
                    def.IsEndOfLife = (fiscalYear * 100 + fiscalWeek >= seasonEndWeek);
                }
                else
                {
                    def.ActualSaleSeason = "Unknown season";
                    def.ActualSaleSeasonWithPhase = def.ActualSaleSeason;
                    /*
                    def.IsEndOfLife = row.IsEndOfLife;
                    */
                    // unknown season is now treated as still selling 2021-03-02 teresa.
                    def.IsEndOfLife = false;
                    SeasonRef season = GeneralWorker.Instance.getSeasonByKey(expectedSaleSeasonId);
                    string[] seasonString = season.Code.Split(' '); //eg: S/S 2019
                    seasonYear = Convert.ToInt32(seasonString[1]);
                    def.MDYear = seasonYear;
                    def.MDWeek = seasonString[0] == "S/S" ?
                                expectedSaleSeasonSplitId == 1 ? 8 : 23 // S/S MSS : EOS
                                :
                                expectedSaleSeasonSplitId == 1 ? 34 : 48; // A/W MSS : EOS
                }

                /* Logic TBC
                if (!def.IsEndOfLife && seasonYear > 0 && def.WeekCount != 0)
                {
                    def.FPWeekCount = (((fiscalYear - def.LaunchYear) > 1 ? (fiscalYear - def.LaunchYear - 1) : 0) * 52) 
                                        + ((fiscalYear != def.LaunchYear) ? (52 - def.LaunchWeek + 1) : 0)
                                        + fiscalWeek;
                }
                */

                if (rangePlanDef.ActualLaunchedDate != DateTime.MinValue && saleSeasonId != 999)
                    def.NoOfWeekUntilNextMD = 0;
                else if (rangePlanDef.ActualLaunchedDate != DateTime.MinValue && saleSeasonId == 999)
                    def.NoOfWeekUntilNextMD = this.getNSLedWeekDiff(def.MDYear, def.MDWeek, fiscalYear, fiscalWeek);
                else
                {
                    PeriodWeekInfoDef wkInfoDef = generalWorker.getFiscalWeekByDate(rangePlanDef.PlannedLaunchedDate);
                    def.NoOfWeekUntilNextMD = this.getNSLedWeekDiff(def.MDYear, def.MDWeek, wkInfoDef.Year, wkInfoDef.YearWeek);
                }

                if (def.ItemNo == "504390")
                    def.NoOfWeekUntilNextMD = 1; // workaround for wrong figure (sales qty > shipped qty)

                def.ActualSaleSeasonId = saleSeasonId;
                def.ActualSaleSeasonSplitId = saleSeasonSplitId;
                def.IsNotYetLaunched = 0;

                if (def.WeekCount == 0)
                {
                    def.ActualSaleSeasonId = 1000;
                    def.ActualSaleSeasonSplitId = 1000;
                    def.IsNotYetLaunched = 1;
                }

                decimal FobToUSDExRate = 0;
                decimal GBPToUSDExRate = 0;

                def.SeasonId = rangePlanDef.SeasonId;
                if (def.SeasonId > 0)
                {
                    FobToUSDExRate = commonWorker.getSeasonalExchangeRate(def.SeasonId, rangePlanDef.SupplierCurrencyId, CurrencyId.USD.Id);
                    GBPToUSDExRate = commonWorker.getSeasonalExchangeRate(def.SeasonId, CurrencyId.GBP.Id, CurrencyId.USD.Id);
                }
                else
                {
                    FobToUSDExRate = rangePlanDef.SupplierCurrencyId != CurrencyId.USD.Id ?
                        commonWorker.getExchangeRate(ExchangeRateType.INVOICE, rangePlanDef.SupplierCurrencyId, DateTime.Now)
                        /
                        commonWorker.getExchangeRate(ExchangeRateType.INVOICE, CurrencyId.USD.Id, DateTime.Now) : 1;

                    GBPToUSDExRate =
                        commonWorker.getExchangeRate(ExchangeRateType.INVOICE, CurrencyId.GBP.Id, DateTime.Now)
                        /
                        commonWorker.getExchangeRate(ExchangeRateType.INVOICE, CurrencyId.USD.Id, DateTime.Now);
                }


                if (rangePlanDef.USDExchangeRate != 0 && rangePlanDef.GBPExchangeRate != 0 && rangePlanDef.SupplierCurrencyExchangeRate != 0)
                    def.TotalFOBCost = rangePlanDef.TotalFOBCostInUSD;
                else
                    def.TotalFOBCost = rangePlanDef.TotalFOBCost * FobToUSDExRate;

                decimal freightCost = rangePlanDef.ActualFreightUSD > 0 ? rangePlanDef.ActualFreightUSD : rangePlanDef.TotalFreight * GBPToUSDExRate;

                /*
                if (def.OfficeId != OfficeId.SL.Id || def.SeasonId < 38) // SS20
                    def.TotalProductionCost = def.TotalFOBCost * 0.97m
                                + freightCost + (rangePlanDef.DutyPercent / 100m * (def.TotalFOBCost + freightCost));
                else
                    def.TotalProductionCost = def.TotalFOBCost - (def.TotalQty * 0.03m)
                                + freightCost + (rangePlanDef.DutyPercent / 100m * (def.TotalFOBCost + freightCost));
                */

                // requested by teresa on 2020-07-29 that freight cost has to be taken out from duty calculation

                def.TotalFreightCost = freightCost;
                def.TotalDutyCost = (rangePlanDef.DutyPercent / 100m * (def.TotalFOBCost));

                if (def.OfficeId == OfficeId.HK.Id && (def.ItemNo == "M37904" || def.ItemNo == "A16139"))
                    def.TotalSettlementDiscount = def.TotalFOBCost * 0.02m;
                else if ((def.OfficeId != OfficeId.SL.Id || def.SeasonId < 38)) // SS20
                    def.TotalSettlementDiscount = def.TotalFOBCost * 0.03m;
                else if (def.OfficeId == OfficeId.SL.Id && rangePlanDef.CountryOfOriginId == CountryOfOriginRef.eCountryId.Pakistan.GetHashCode())
                    def.TotalSettlementDiscount = def.TotalFOBCost * 0.03m;
                else if (def.OfficeId == OfficeId.SL.Id && rangePlanDef.CountryOfOriginId == CountryOfOriginRef.eCountryId.India.GetHashCode())
                    def.TotalSettlementDiscount = 0;
                else
                    def.TotalSettlementDiscount = (def.TotalQty * (def.SeasonId >= 40 ? 0.035m : 0.03m)); // SS 21

                //if (def.ItemNo == "212064" || def.ItemNo == "764052" || def.ItemNo == "834573" || def.ItemNo == "386821" || def.ItemNo == "483435" || def.ItemNo == "394310" || def.ItemNo == "A19730") // LK shipped from india, exempted.

                if (def.ItemNo == "879851" || def.ItemNo == "478941" || def.ItemNo == "965740")
                    def.TotalDutyCost = 0;

                if (def.OfficeId != OfficeId.SL.Id || def.SeasonId < 38) // SS20
                    def.TotalProductionCost = def.TotalFOBCost - def.TotalSettlementDiscount
                                + freightCost + def.TotalDutyCost;
                else
                    def.TotalProductionCost = def.TotalFOBCost - def.TotalSettlementDiscount
                                + freightCost + def.TotalDutyCost;

                decimal seasonalGBPToUSDExRate = CommonWorker.Instance.getSeasonalExchangeRate(rangePlanDef.SeasonId, CurrencyId.GBP.Id, CurrencyId.USD.Id);
                decimal seasonalUSDExRate = commonWorker.getSeasonalExchangeRate(rangePlanDef.SeasonId, rangePlanDef.SupplierCurrencyId, CurrencyId.USD.Id);


                def.TotalEstimatedComm = rangePlanDef.TotalComm * seasonalGBPToUSDExRate;


                // seasonal production cost in usd

                decimal seasonalFOBCost = (rangePlanDef.TotalFOBCost * seasonalUSDExRate);
                decimal seasonalSettlementDiscount = 0;
                if (def.OfficeId == OfficeId.HK.Id && (def.ItemNo == "M37904" || def.ItemNo == "A16139"))
                    seasonalSettlementDiscount = seasonalFOBCost * 0.02m;
                else if (def.OfficeId != OfficeId.SL.Id || def.SeasonId < 38) // SS20
                    seasonalSettlementDiscount = seasonalFOBCost * 0.03m;
                else if (def.OfficeId == OfficeId.SL.Id && rangePlanDef.CountryOfOriginId == CountryOfOriginRef.eCountryId.Pakistan.GetHashCode())
                    seasonalSettlementDiscount = seasonalFOBCost * 0.03m;
                else if (def.OfficeId == OfficeId.SL.Id && rangePlanDef.CountryOfOriginId == CountryOfOriginRef.eCountryId.India.GetHashCode())
                    seasonalSettlementDiscount = 0;
                else
                    seasonalSettlementDiscount = (def.TotalQty * (def.SeasonId >= 40 ? 0.035m : 0.03m)); // SS 21

                //if (def.ItemNo == "212064" || def.ItemNo == "764052" || def.ItemNo == "834573" || def.ItemNo == "386821" || def.ItemNo == "483435" || def.ItemNo == "394310" || def.ItemNo == "A19730") // LK shipped from india, exempted.

                decimal seasonalFreightCost = freightCost;
                decimal seasonalDutyCost = (rangePlanDef.DutyPercent / 100m * seasonalFOBCost);
                if (def.ItemNo == "879851" || def.ItemNo == "478941" || def.ItemNo == "965740")
                    seasonalDutyCost = 0;

                decimal seasonalTotalProductionCost = seasonalFOBCost - seasonalSettlementDiscount + seasonalFreightCost + seasonalDutyCost;


                // end seasonal production cost

                def.EstimatedProfitPencentage = (1 - seasonalTotalProductionCost / def.TotalEstimatedComm) * 100m;

                def.MinRetailSellingPrice = rangePlanDef.MinRetailSellingPrice;
                def.MaxRetailSellingPrice = rangePlanDef.MaxRetailSellingPrice;

                def.RetailSellingPrice = rangePlanDef.MinRetailSellingPrice.ToString("C", info) +
                    (rangePlanDef.MaxRetailSellingPrice == rangePlanDef.MinRetailSellingPrice ? "" :
                        "-" + rangePlanDef.MaxRetailSellingPrice.ToString("F2"));

                /*
                def.AvgRetailSellingPrice = def.ProductTeamName != "Childrenswear" ? def.RetailSellingPrice
                    : (rangePlanDef.TotalRetailAmt / (rangePlanDef.TotalQty > 0 ? rangePlanDef.TotalQty : 1)).ToString("C", info);
                */
                def.Comment = rangePlanDef.Comment;
                def.SellThruRemark = rangePlanDef.SellThruRemark;
                def.AvgRetailSellingPrice = (rangePlanDef.TotalRetailAmt / (rangePlanDef.TotalQty > 0 ? rangePlanDef.TotalQty : 1));

                int rv = 5;
                while (rv < def.AvgRetailSellingPrice)
                    rv += 5;
                def.PricePoint = string.Format("{0} - {1}", (rv - 4).ToString(), rv.ToString());
                def.PriceStartingPoint = rv - 4;

                rv = 500;
                while (rv < def.TotalQty)
                    rv += 500;
                if (def.TotalQty > 6000)
                {
                    def.QtyRange = "Over 6,000";
                    def.QtyStartingPoint = 6000;
                }
                else
                {
                    def.QtyRange = string.Format("{0} - {1}", (rv - 500 + 1).ToString("#,##0"), rv.ToString("#,##0"));
                    def.QtyStartingPoint = rv - 500 + 1;
                }

                def.MDPrice = def.MDQty > 0 ? (rangePlanDef.MinRetailSellingPrice / 2).ToString("C", info) : "N/A"; //Wait for update

                if (def.TotalQty > 0)
                {
                    def.FPQtyPct = Convert.ToDecimal(def.FPQty) / Convert.ToDecimal(def.TotalQty);
                    def.MDQtyPct = Convert.ToDecimal(def.MDQty) / Convert.ToDecimal(def.TotalQty);
                }

                def.HasDuty = row.HasDuty;
                def.VATFactor = def.ProductTeamName == "CHILDRENSWEAR" ? 1m : 1.2m;
                def.FirstInvoiceDate = rangePlanDef.FirstInvoiceDate;

                if (def.IsEndOfLife)
                {
                    if (def.ActualSaleSeasonId == 999)
                        def.NSLedPhaseId = 999;
                    else
                        def.NSLedPhaseId = SeasonRef.getNSLedPhaseId(def.ActualSaleSeasonId, def.ActualSaleSeasonSplitId);
                }
                else
                {
                    if (def.LaunchYear == 0)
                        def.NSLedPhaseId = -2;
                    else
                        def.NSLedPhaseId = -1;
                }
            }
        }

        private int getNSLedWeekDiff(int fromYear, int fromWeek, int toYear, int toWeek)
        {
            // where from = md, to = report

            if (((toYear * 100) + toWeek) >= ((fromYear * 100) + fromWeek))
                return 0;

            int y = fromYear;
            int noOfWeek = 0;

            while (y > toYear)
            {
                if ((y - toYear) > 1)
                    noOfWeek += 52;
                else
                    noOfWeek += fromWeek;
                y -= 1;
            }

            if (fromYear > toYear)
                noOfWeek += (52 - toWeek);
            else
                noOfWeek += (fromWeek - toWeek);
            return noOfWeek;
        }

        public List<NSLedSalesInfoDef> getNSLedSalesInfo(int FiscalYear, int FiscalWeek)
        {
            IDataSetAdapter ad = getDataSetAdapter("NSLedSalesInfoApt", "GetNSLedSalesInfo");
            ad.SelectCommand.Parameters["@FiscalYear"].Value = FiscalYear;
            ad.SelectCommand.Parameters["@FiscalWeek"].Value = FiscalWeek;

            NSLedSalesInfoDs dataSet = new NSLedSalesInfoDs();
            ad.SelectCommand.DbCommand.CommandTimeout = 120;
            dataSet.EnforceConstraints = false;
            int recordsAffected = ad.Fill(dataSet);

            List<NSLedSalesInfoDef> list = new List<NSLedSalesInfoDef>();

            foreach (NSLedSalesInfoDs.NSLedSalesInfoRow row in dataSet.NSLedSalesInfo)
            {
                NSLedSalesInfoDef def = new NSLedSalesInfoDef();
                try
                {
                    NSLedSalesInfoDefMapping(row, def, FiscalYear, FiscalWeek);
                    list.Add(def);
                }
                catch (Exception ex)
                {
                    continue;
                }
            }
            return list;
        }


        public NSLedCostDataByWeekDef getNSLedCostDataByWeek(string itemNo, int fiscalYear, int fiscalPeriod, int fiscalWeek, int seasonId, int isInitialOnly)
        {
            IDataSetAdapter ad = getDataSetAdapter("NSLedCostDataByWeekApt", "GetNSLedCostDataByWeek");
            ad.SelectCommand.Parameters["@FiscalYear"].Value = fiscalYear;
            ad.SelectCommand.Parameters["@FiscalPeriod"].Value = fiscalPeriod;
            ad.SelectCommand.Parameters["@FiscalWeek"].Value = fiscalWeek;
            ad.SelectCommand.Parameters["@ItemNo"].Value = itemNo;
            ad.SelectCommand.Parameters["@SeasonId"].Value = seasonId.ToString();
            ad.SelectCommand.Parameters["@IsInitialOnly"].Value = isInitialOnly.ToString();
            System.Diagnostics.Debug.WriteLine(itemNo + "|" + fiscalYear.ToString() + "|" + fiscalWeek.ToString() + "|" + fiscalPeriod.ToString() + "|" + seasonId.ToString());

            NSLedCostDataByWeekDs dataSet = new NSLedCostDataByWeekDs();
            ad.SelectCommand.DbCommand.CommandTimeout = 120;
            dataSet.EnforceConstraints = false;
            int recordsAffected = ad.Fill(dataSet);
            NSLedCostDataByWeekDef def = new NSLedCostDataByWeekDef();

            if (recordsAffected > 0)
            {
                NSLedCostDataByWeekDs.NSLedCostDataByWeekRow row = dataSet.NSLedCostDataByWeek[0];
                def.FOBAmtInUSD = row.FOBAmt;
                def.VendorPaymentDiscountInUSD = row.VendorPaymentDiscountAmt;
                def.QACommissionInUSD = row.QACommissionAmt;
                def.LabTestIncomeInUSD = row.LabTestAmt;
                def.ActualFreightCostPerUnitInUSD = row.FreightCPU;
                def.DutyPercent = row.DutyPercent;
                def.Qty = row.Qty;
                def.AdjRequired = row.AdjRequired;
            }

            return def;
        }

        public List<int> getNSLedItemShippedPeriodList(string itemNo, int seasonId)
        {
            IDataSetAdapter ad = getDataSetAdapter("NSLedCostDataByWeekApt", "GetNSLedItemShippedPeriodList");
            ad.SelectCommand.Parameters["@ItemNo"].Value = itemNo;
            ad.SelectCommand.Parameters["@SeasonId"].Value = seasonId.ToString();
            System.Diagnostics.Debug.WriteLine("GetNSLedItemShippedPeriodList - item no " + itemNo);

            DataSet dataSet = new DataSet();
            ad.SelectCommand.DbCommand.CommandTimeout = 120;
            dataSet.EnforceConstraints = false;
            int recordsAffected = ad.Fill(dataSet);

            List<int> list = new List<int>();
            foreach(DataRow r in dataSet.Tables[0].Rows)
            {
                list.Add((int)(r[0]));
            }

            return list;
        }


        public void fillNSLedCostDataByWeek(NSLedSalesInfoDef def, int seasonId)
        {
            IDataSetAdapter ad = getDataSetAdapter("NSLedCostDataByWeekApt", "GetNSLedCostDataByWeek");
            ad.SelectCommand.Parameters["@FiscalYear"].Value = def.FiscalYear;
            ad.SelectCommand.Parameters["@FiscalPeriod"].Value = -1;
            ad.SelectCommand.Parameters["@FiscalWeek"].Value = def.FiscalWeek;
            ad.SelectCommand.Parameters["@ItemNo"].Value = def.ItemNo;
            ad.SelectCommand.Parameters["@SeasonId"].Value = seasonId.ToString();
            ad.SelectCommand.Parameters["@IsInitialOnly"].Value = 0;

            System.Diagnostics.Debug.WriteLine(def.ItemNo + "|" + def.FiscalYear.ToString() + "|" + def.FiscalWeek.ToString() + "|-1|" + seasonId.ToString());
            NSLedCostDataByWeekDs dataSet = new NSLedCostDataByWeekDs();
            ad.SelectCommand.DbCommand.CommandTimeout = 120;
            dataSet.EnforceConstraints = false;
            int recordsAffected = ad.Fill(dataSet);

            if (recordsAffected > 0)
            {
                NSLedCostDataByWeekDs.NSLedCostDataByWeekRow row = dataSet.NSLedCostDataByWeek[0];
                def.FOBAmtInUSD = row.FOBAmt;
                def.VendorPaymentDiscountInUSD = row.VendorPaymentDiscountAmt;
                def.QACommissionInUSD = row.QACommissionAmt;
                def.LabTestIncomeInUSD = row.LabTestAmt;
                def.ActualFreightCostPerUnitInUSD = row.FreightCPU;
                def.DutyPercent = row.DutyPercent;
                def.AdjRequired = row.AdjRequired;
            }

        }

        private void NSLedSalesInfoDefMapping(Object source, Object target, int FiscalYear, int FiscalWeek)
        {
            if (source.GetType() == typeof(NSLedSalesInfoDs.NSLedSalesInfoRow) &&
                target.GetType() == typeof(NSLedSalesInfoDef))
            {
                NSLedSalesInfoDs.NSLedSalesInfoRow row = (NSLedSalesInfoDs.NSLedSalesInfoRow)source;
                NSLedSalesInfoDef def = (NSLedSalesInfoDef)target;

                def.ItemNo = row.ItemNo;
                def.OfficeId = row.OfficeId;
                def.FiscalYear = row.FiscalYear;
                def.FiscalWeek = row.FiscalWeek;
                def.FiscalPeriod = row.Period;
                def.DespatchQty = row.DespatchQty;
                def.ReturnQty = row.ReturnQty;
                def.NetQty = row.NetQty;
                def.NSCommAmtInUSD = row.NSCommAmtInUSD;
                def.MDQty = row.MDQty;
                def.HasDuty = row.HasDuty;
            }
        }

        public string getLatestNSLedRangePlanSeasonSplit()
        {
            IDataSetAdapter ad = getDataSetAdapter("NSledRangePlanApt", "GetLatestRangePlanSeasonSplit");

            NSLedRangePlanDs dataSet = new NSLedRangePlanDs();
            ad.SelectCommand.DbCommand.CommandTimeout = 120;
            dataSet.EnforceConstraints = false;
            int recordsAffected = ad.Fill(dataSet);

            string seasonSplit = "35-2";
            if (recordsAffected > 0)
                seasonSplit = ((NSLedRangePlanDs.NSLedRangePlanRow)dataSet.NSLedRangePlan[0]).ActualSaleSeason;
            return seasonSplit;
        }

        public int getNSLedRangePlanMinSeasonId(int officeId, string itemNo)
        {
            IDataSetAdapter ad = getDataSetAdapter("NSledRangePlanApt", "GetMinSeasonId");
            ad.SelectCommand.Parameters["@OfficeId"].Value = officeId.ToString();
            ad.SelectCommand.Parameters["@ItemNo"].Value = itemNo;

            DataSet dataSet = new DataSet();
            ad.SelectCommand.DbCommand.CommandTimeout = 120;
            dataSet.EnforceConstraints = false;
            int recordsAffected = ad.Fill(dataSet);

            int r = 0;
            if (recordsAffected > 0)
            {
                if (dataSet.Tables[0].Rows[0][0] == DBNull.Value)
                {

                    NoticeHelper.sendNSLedPurchaseUploadAlert("Expected Range Plan for Item# " + itemNo, itemNo, officeId);
                    throw new ApplicationException("Expected Range Plan for Item# " + itemNo + " (" + OfficeId.getName(officeId) + ")");
                }
                else
                    r = (int)(dataSet.Tables[0].Rows[0][0]);
            }
            return r;
        }

        public int getNSLedRangePlanSeasonIdByFiscalWeek(int officeId, string itemNo, int fiscalYear, int fiscalWeek)
        {
            IDataSetAdapter ad = getDataSetAdapter("NSLedProfitabilitiesApt", "GetNSLedRangePlanSeasonIdByFiscalWeek");
            ad.SelectCommand.Parameters["@OfficeId"].Value = officeId.ToString();
            ad.SelectCommand.Parameters["@ItemNo"].Value = itemNo;
            ad.SelectCommand.Parameters["@FiscalYear"].Value = fiscalYear.ToString();
            ad.SelectCommand.Parameters["@FiscalWeek"].Value = fiscalWeek.ToString();

            DataSet dataSet = new DataSet();
            ad.SelectCommand.DbCommand.CommandTimeout = 120;
            dataSet.EnforceConstraints = false;
            int recordsAffected = ad.Fill(dataSet);

            int r = 0;
            if (recordsAffected > 0)
                r = (int)(dataSet.Tables[0].Rows[0][0]);
            else
                r = this.getNSLedRangePlanMinSeasonId(officeId, itemNo);
            return r;
        }


        public int getNSLedRangePlanSeasonIdByDeliveryDate(int officeId, string itemNo, DateTime deliveryDate)
        {
            IDataSetAdapter ad = getDataSetAdapter("NSLedProfitabilitiesApt", "GetNSLedRangePlanSeasonIdByDeliveryDate");
            ad.SelectCommand.Parameters["@OfficeId"].Value = officeId.ToString();
            ad.SelectCommand.Parameters["@ItemNo"].Value = itemNo;
            ad.SelectCommand.Parameters["@DeliveryDate"].Value = deliveryDate;

            DataSet dataSet = new DataSet();
            ad.SelectCommand.DbCommand.CommandTimeout = 120;
            dataSet.EnforceConstraints = false;
            int recordsAffected = ad.Fill(dataSet);

            int r = 0;
            if (recordsAffected > 0)
                r = (int)(dataSet.Tables[0].Rows[0][0]);
            else
                r = this.getNSLedRangePlanMinSeasonId(officeId, itemNo);
            return r;
        }

        private SortedList<string, NSLedRangePlanDef> getNSLedRangePlanList(TypeCollector officeId, TypeCollector phaseId)
        {
            IDataSetAdapter ad = getDataSetAdapter("NSledRangePlanApt", "GetRangePlanByCriteria");
            ad.SelectCommand.CustomParameters["@OfficeId"] = CustomDataParameter.parse(officeId.IsInclusive, officeId.Values);
            ad.SelectCommand.Parameters["@ItemNo"].Value = GeneralCriteria.ALLSTRING;
            ad.SelectCommand.Parameters["@SeasonId"].Value = "-1";
            ad.SelectCommand.CustomParameters["@PhaseId"] = CustomDataParameter.parse(phaseId.IsInclusive, phaseId.Values);
            ad.SelectCommand.MailSQL = true;

            NSLedRangePlanDs dataSet = new NSLedRangePlanDs();
            ad.SelectCommand.DbCommand.CommandTimeout = 120;
            dataSet.EnforceConstraints = false;
            int recordsAffected = ad.Fill(dataSet);

            SortedList<string, NSLedRangePlanDef> list = new SortedList<string, NSLedRangePlanDef>();
            foreach (NSLedRangePlanDs.NSLedRangePlanRow row in dataSet.NSLedRangePlan)
            {
                NSLedRangePlanDef def = new NSLedRangePlanDef();
                NSLedRangePlanDefMapping(row, def);
                list.Add(def.OfficeId.ToString() + "/" + def.ItemNo, def);
            }
            return list;
        }

        public NSLedRangePlanDef getNSLedRangePlan(int officeId, string itemNo, int seasonId)
        {
            return getNSLedRangePlan(TypeCollector.Inclusive.append(officeId), itemNo, seasonId, TypeCollector.Inclusive);
        }


        public NSLedRangePlanDef getNSLedRangePlan(TypeCollector officeId, string itemNo, int seasonId, TypeCollector phaseId)
        {
            TransactionContext ctx = TransactionContextFactory.GetContext(TransactionAffinity.NotSupported);
            try
            {
                ctx.Enter();
                TransactionContext currentCtx = TransactionContextFactory.GetCurrentContext();
                IDataSetAdapter ad = getDataSetAdapter("NSledRangePlanApt", "GetRangePlanByCriteria");
                ad.SelectCommand.CustomParameters["@OfficeId"] = CustomDataParameter.parse(officeId.IsInclusive, officeId.Values);
                ad.SelectCommand.Parameters["@ItemNo"].Value = itemNo;
                ad.SelectCommand.Parameters["@SeasonId"].Value = seasonId.ToString();
                ad.SelectCommand.CustomParameters["@PhaseId"] = CustomDataParameter.parse(phaseId.IsInclusive, phaseId.Values);
                ad.SelectCommand.MailSQL = true;

                NSLedRangePlanDs dataSet = new NSLedRangePlanDs();
                ad.SelectCommand.DbCommand.CommandTimeout = 120;
                dataSet.EnforceConstraints = false;
                int recordsAffected = ad.Fill(dataSet);
                NSLedRangePlanDef def = null;

                if (recordsAffected > 0)
                {
                    def = new NSLedRangePlanDef();
                    NSLedRangePlanDefMapping(dataSet.NSLedRangePlan[0], def);
                }
                ctx.VoteCommit();
                return def;
            }
            catch (Exception e)
            {
                Console.WriteLine("ERROR " + e.Message);
                ctx.VoteRollback();
                throw e;
            }
            finally
            {
                ctx.Exit();
            }

        }

        public decimal getRangePlanActualFreightUnitCostInUSD(int officeId, string itemNo, int seasonId)
        {
            TypeCollector officeIds = TypeCollector.Inclusive.append(officeId);
            TypeCollector phaseId = TypeCollector.Inclusive;

            IDataSetAdapter ad = getDataSetAdapter("NSledRangePlanApt", "GetRangePlanActualFreightUnitCostInUSD");
            ad.SelectCommand.CustomParameters["@OfficeId"] = CustomDataParameter.parse(officeIds.IsInclusive, officeIds.Values);
            ad.SelectCommand.Parameters["@ItemNo"].Value = itemNo;
            ad.SelectCommand.Parameters["@SeasonId"].Value = seasonId.ToString();
            ad.SelectCommand.CustomParameters["@PhaseId"] = CustomDataParameter.parse(phaseId.IsInclusive, phaseId.Values);
            ad.SelectCommand.MailSQL = true;

            DataSet dataSet = new DataSet();
            ad.SelectCommand.DbCommand.CommandTimeout = 120;
            dataSet.EnforceConstraints = false;
            int recordsAffected = ad.Fill(dataSet);

            if (recordsAffected > 0)
            {
                decimal val = (decimal)(dataSet.Tables[0].Rows[0][0]);
                if (val == 0)
                {
                    NoticeHelper.sendNSLedPurchaseUploadAlert("Freight CPU is Empty for Item# " + itemNo + " (" + OfficeId.getName(officeId) + ")", itemNo, officeId);
                    throw new ApplicationException("Freight CPU is Empty for Item# " + itemNo + " (" + OfficeId.getName(officeId) + ")");
                }
                return (decimal)(dataSet.Tables[0].Rows[0][0]);
            }
            else
            {
                NoticeHelper.sendNSLedPurchaseUploadAlert("Expected Range Plan for Item# " + itemNo + " (" + OfficeId.getName(officeId) + ")", itemNo, officeId);
                throw new ApplicationException("Expected Range Plan for Item# " + itemNo + " (" + OfficeId.getName(officeId) + ")");
            }
        }


        public decimal getRangePlanDutyPercent(int officeId, string itemNo, int seasonId)
        {
            TypeCollector officeIds = TypeCollector.Inclusive.append(officeId);
            TypeCollector phaseId = TypeCollector.Inclusive;

            IDataSetAdapter ad = getDataSetAdapter("NSledRangePlanApt", "GetRangePlanDutyPercent");
            ad.SelectCommand.CustomParameters["@OfficeId"] = CustomDataParameter.parse(officeIds.IsInclusive, officeIds.Values);
            ad.SelectCommand.Parameters["@ItemNo"].Value = itemNo;
            ad.SelectCommand.Parameters["@SeasonId"].Value = seasonId.ToString();
            ad.SelectCommand.CustomParameters["@PhaseId"] = CustomDataParameter.parse(phaseId.IsInclusive, phaseId.Values);
            ad.SelectCommand.MailSQL = true;

            DataSet dataSet = new DataSet();
            ad.SelectCommand.DbCommand.CommandTimeout = 120;
            dataSet.EnforceConstraints = false;
            int recordsAffected = ad.Fill(dataSet);

            if (recordsAffected > 0)
                return (decimal)(dataSet.Tables[0].Rows[0][0]);
            else
            {
                NoticeHelper.sendGeneralMessage("Expected Range Plan for Item# " + itemNo, "Expected Range Plan for Item# " + itemNo + " (" + OfficeId.getName(officeId) + ")");
                throw new ApplicationException("Expected Range Plan for Item# " + itemNo + " (" + OfficeId.getName(officeId) + ")");
            }
        }


        private void NSLedRangePlanDefMapping(Object source, Object target)
        {
            if (source.GetType() == typeof(NSLedRangePlanDs.NSLedRangePlanRow) &&
                target.GetType() == typeof(NSLedRangePlanDef))
            {
                NSLedRangePlanDs.NSLedRangePlanRow row = (NSLedRangePlanDs.NSLedRangePlanRow)source;
                NSLedRangePlanDef def = (NSLedRangePlanDef)target;

                ContractDef contractDef = OrderSelectWorker.Instance.getContractByItemNoAndCustomerId(row.ItemNo, CustomerDef.Id.ns_led.GetHashCode(), -1, -1);
                ProductDepartmentRef deptRef = new ProductDepartmentRef();

                if (contractDef == null)
                {
                    contractDef = OrderSelectWorker.Instance.getContractByItemNoAndCustomerId(row.ItemNo, CustomerDef.Id.manu_led.GetHashCode(), -1, -1);
                }
                if (contractDef != null)
                {
                    deptRef = GeneralWorker.Instance.getProductDepartmentByKey(contractDef.DeptId);
                }

                def.RangePlanId = row.RangePlanId;
                def.ItemNo = row.ItemNo;
                def.OfficeId = row.OfficeId;
                def.Description = row.Description;
                def.ProductTeamName = deptRef != null ? Regex.Replace(deptRef.Description.ToUpper(), @"\(.*?\)", "").Trim() : string.Empty;
                def.UKDepartment = row.UKDept;
                def.ActualSaleSeason = row.ActualSaleSeason;
                def.ExpectedSaleSeason = row.ExpectedSaleSeason;
                def.TotalQty = row.TotalQty;
                def.TotalFOBCost = row.TotalFOBCost;
                def.TotalFOBCostInUSD = row.TotalFOBCostInUSD;
                def.USDExchangeRate = row.USDExchangeRate;
                def.GBPExchangeRate = row.GBPExchangeRate;
                def.SupplierCurrencyExchangeRate = row.SupplierCurrencyExchangeRate;

                def.SupplierCurrencyId = row.SupplierCurrencyId;
                def.MaxRetailSellingPrice = row.MaxRetailSellingPrice;
                def.MinRetailSellingPrice = row.MinRetailSellingPrice;
                def.TotalComm = row.TotalComm;
                def.TotalFreight = row.TotalFreight;
                def.ActualFreightUSD = row.ActualFreightUSD;
                def.ActualFreightUnitCostUSD = row.ActualFreightUnitCostUSD;
                def.DutyPercent = row.DutyPercent;
                def.SeasonId = row.SeasonId;
                def.CustomerId = row.CustomerId;
                def.Picture = getNSLedRangePlanPicture(row.RangePlanId);
                def.TotalRetailAmt = row.TotalRetailAmt;
                def.FirstInvoiceDate = row.FirstInvoiceDate;
                def.FirstShipmentId = row.FirstShipmentId;
                if (!row.IsActualLaunchedDateNull())
                    def.ActualLaunchedDate = row.ActualLaunchedDate;
                else
                    def.ActualLaunchedDate = DateTime.MinValue;
                def.PlannedLaunchedDate = row.PlannedLaunchedDate;
                if (!row.IsCommentNull())
                    def.Comment = row.Comment;
                else
                    def.Comment = string.Empty;
                if (!row.IsSellThruRemarkNull())
                    def.SellThruRemark = row.SellThruRemark;
                else
                    def.SellThruRemark = string.Empty;
                def.IsDuty = row.IsDuty;
                def.ShippedPeriod = row.ShippedPeriod;
                def.CountryOfOriginId = row.CountryOfOriginId;
            }
        }

        public byte[] getNSLedRangePlanPicture(int RangePlanId)
        {
            IDataSetAdapter ad = getDataSetAdapter("NSledRangePlanPictureApt", "GetRangePlanListPictureByKey");
            ad.SelectCommand.Parameters["@RangePlanId"].Value = RangePlanId;

            NSLedRangePlanPictureDs dataSet = new NSLedRangePlanPictureDs();
            ad.SelectCommand.DbCommand.CommandTimeout = 120;
            dataSet.EnforceConstraints = false;
            int recordsAffected = ad.Fill(dataSet);

            return dataSet.NSLedRangePlanPicture[0].Picture;
        }

        public Dictionary<string, int> getNSLedRangePlanSizeOption(int rangePlanId)
        {
            IDataSetAdapter ad = getDataSetAdapter("NSledRangePlanSizeOptionApt", "GetRangePlanSizeOptionByKey");
            ad.SelectCommand.Parameters["@RangePlanId"].Value = rangePlanId;

            DataSet dataSet = new DataSet();
            ad.SelectCommand.DbCommand.CommandTimeout = 120;
            dataSet.EnforceConstraints = false;
            int recordsAffected = ad.Fill(dataSet);
            Dictionary<string, int> result = new Dictionary<string, int>();
            foreach (DataRow dr in dataSet.Tables[0].Rows)
            {

                if (!result.ContainsKey(dr["SizeRange"].ToString()))
                    result.Add(dr["SizeRange"].ToString(), Convert.ToInt32(dr["Qty"]));
                else
                    result[dr["SizeRange"].ToString()] = result[dr["SizeRange"].ToString()] + Convert.ToInt32(dr["Qty"]);
            }
            return result;
        }

        public ArrayList getNSLedImportFileByCriteria(string invoiceNo, DateTime invoiceDate, int officeId)
        {
            ArrayList list = new ArrayList();

            TransactionContext ctx = TransactionContextFactory.GetContext(TransactionAffinity.Required);
            try
            {
                ctx.Enter();
                TransactionContext currentCtx = TransactionContextFactory.GetCurrentContext();

                IDataSetAdapter ad = getDataSetAdapter("NSLedImportFileApt", "GetNSLedImportFileByCriteriaForChecking");
                ad.SelectCommand.Parameters["@InvoiceNo"].Value = invoiceNo;

                if (invoiceDate == DateTime.MinValue)
                    ad.SelectCommand.Parameters["@InvoiceDate"].Value = DBNull.Value;
                else
                    ad.SelectCommand.Parameters["@InvoiceDate"].Value = invoiceDate;

                ad.SelectCommand.Parameters["@OfficeId"].Value = officeId;

                NSLedImportFileDs ds = new NSLedImportFileDs();
                int recordsAffected = ad.Fill(ds);

                //if (recordsAffected < 1) return null;

                //for (int i = 0; i < ds.Tables[0].Rows.Count; i++)
                foreach (NSLedImportFileDs.NSLedImportFileRow row in ds.NSLedImportFile.Rows)
                {
                    NSLedImportFileDef df = new NSLedImportFileDef();
                    NSLedImportFileMapping(row, df);
                    list.Add(df);
                }
                ctx.VoteCommit();
                return list;
            }
            catch (Exception e)
            {
                Console.WriteLine("ERROR " + e.Message);
                ctx.VoteRollback();
                throw e;
            }
            finally
            {
                ctx.Exit();
            }
        }

        public ArrayList getNSLedImportFileByCriteria(int uploadUserId, DateTime startDate, DateTime endDate)
        {
            ArrayList list = new ArrayList();

            TransactionContext ctx = TransactionContextFactory.GetContext(TransactionAffinity.Required);
            try
            {
                ctx.Enter();
                TransactionContext currentCtx = TransactionContextFactory.GetCurrentContext();

                IDataSetAdapter ad = getDataSetAdapter("NSLedImportFileApt", "GetNSLedImportFileByCriteria");
                ad.SelectCommand.Parameters["@CreatedBy"].Value = uploadUserId;
                if (startDate == DateTime.MinValue)
                    ad.SelectCommand.Parameters["@StartDate"].Value = DBNull.Value;
                else
                    ad.SelectCommand.Parameters["@StartDate"].Value = startDate;
                if (endDate == DateTime.MinValue)
                    ad.SelectCommand.Parameters["@EndDate"].Value = DBNull.Value;
                else
                    ad.SelectCommand.Parameters["@EndDate"].Value = endDate;

                NSLedImportFileDs ds = new NSLedImportFileDs();
                int recordsAffected = ad.Fill(ds);

                //if (recordsAffected < 1) return null;

                //for (int i = 0; i < ds.Tables[0].Rows.Count; i++)
                foreach (NSLedImportFileDs.NSLedImportFileRow row in ds.NSLedImportFile.Rows)
                {
                    NSLedImportFileDef df = new NSLedImportFileDef();
                    NSLedImportFileMapping(row, df);
                    list.Add(df);
                }
                ctx.VoteCommit();
                return list;
            }
            catch (Exception e)
            {
                Console.WriteLine("ERROR " + e.Message);
                ctx.VoteRollback();
                throw e;
            }
            finally
            {
                ctx.Exit();
            }
        }

        public ArrayList getNSLedSelfBilledSupplierCodeByCriteria(string UKSupplierCode, int officeId)
        {
            ArrayList list = new ArrayList();

            TransactionContext ctx = TransactionContextFactory.GetContext(TransactionAffinity.Required);
            try
            {
                ctx.Enter();
                TransactionContext currentCtx = TransactionContextFactory.GetCurrentContext();

                IDataSetAdapter ad = getDataSetAdapter("NSLedSelfBilledSupplierCodeApt", "GetNSLedSelfBilledSupplierCodeByCriteria");
                ad.SelectCommand.Parameters["@UKSupplierCode"].Value = UKSupplierCode;
                ad.SelectCommand.Parameters["@OfficeId"].Value = officeId;
                NSLedSelfBilledSupplierCodeDs ds = new NSLedSelfBilledSupplierCodeDs();
                int recordsAffected = ad.Fill(ds);

                //if (recordsAffected < 1) return null;

                //for (int i = 0; i < ds.Tables[0].Rows.Count; i++)
                foreach (NSLedSelfBilledSupplierCodeDs.NSLedSelfBilledSupplierCodeRow row in ds.NSLedSelfBilledSupplierCode.Rows)
                {
                    NSLedSelfBilledSupplierCodeDef df = new NSLedSelfBilledSupplierCodeDef();
                    NSLedSelfBilledSupplierCodeMapping(row, df);
                    list.Add(df);
                }
                ctx.VoteCommit();
                return list;
            }
            catch (Exception e)
            {
                Console.WriteLine("ERROR " + e.Message);
                ctx.VoteRollback();
                throw e;
            }
            finally
            {
                ctx.Exit();
            }
        }


        public List<NSLedFinanceReportBFValuesDef> getNSLedFinanceReportBFValuesList(int officeId, int fiscalYear)
        {
            List<NSLedFinanceReportBFValuesDef> list = new List<NSLedFinanceReportBFValuesDef>();
            TransactionContext context = TransactionContextFactory.GetContext(TransactionAffinity.Required);
            try
            {
                context.Enter();
                TransactionContext currentContext = TransactionContextFactory.GetCurrentContext();
                IDataSetAdapter dataSetAdapter = getDataSetAdapter("NSLedFinanceReportBFValuesApt", "GetNSLedFinanceReportBFValuesList");
                dataSetAdapter.SelectCommand.Parameters["@OfficeId"].Value = officeId;
                dataSetAdapter.SelectCommand.Parameters["@CurrentYear"].Value = fiscalYear;
                NSLedFinanceReportBFValuesDs dataSet = new NSLedFinanceReportBFValuesDs();
                int num = dataSetAdapter.Fill(dataSet);
                foreach (NSLedFinanceReportBFValuesDs.NSLedFinanceReportBFValuesRow row in dataSet.NSLedFinanceReportBFValues.Rows)
                {
                    NSLedFinanceReportBFValuesDef def = new NSLedFinanceReportBFValuesDef();
                    NSLedFinanceReportBFValuesMapping(row, def);
                    list.Add(def);
                }
                context.VoteCommit();
                return list;
            }
            catch (Exception ex)
            {
                Console.WriteLine("ERROR " + ex.Message);
                context.VoteRollback();
                throw ex;
            }
            finally
            {
                context.Exit();
            }
        }

        public List<NSLedFinanceReportCYValuesDef> getNSLedFinanceReportCYValuesList(int officeId, int fiscalYear)
        {
            List<NSLedFinanceReportCYValuesDef> list = new List<NSLedFinanceReportCYValuesDef>();
            TransactionContext context = TransactionContextFactory.GetContext(TransactionAffinity.Required);
            try
            {
                context.Enter();
                TransactionContext currentContext = TransactionContextFactory.GetCurrentContext();
                IDataSetAdapter dataSetAdapter = getDataSetAdapter("NSLedFinanceReportCYValuesApt", "GetNSLedFinanceReportCYValuesList");
                dataSetAdapter.SelectCommand.Parameters["@OfficeId"].Value = officeId;
                dataSetAdapter.SelectCommand.Parameters["@CurrentYear"].Value = fiscalYear;
                NSLedFinanceReportCYValuesDs dataSet = new NSLedFinanceReportCYValuesDs();
                int num = dataSetAdapter.Fill(dataSet);
                foreach (NSLedFinanceReportCYValuesDs.NSLedFinanceReportCYValuesRow row in dataSet.NSLedFinanceReportCYValues.Rows)
                {
                    NSLedFinanceReportCYValuesDef def = new NSLedFinanceReportCYValuesDef();
                    NSLedFinanceReportCYValuesMapping(row, def);
                    list.Add(def);
                }
                context.VoteCommit();
                return list;
            }
            catch (Exception ex)
            {
                Console.WriteLine("ERROR " + ex.Message);
                context.VoteRollback();
                throw ex;
            }
            finally
            {
                context.Exit();
            }
        }

        public int getLGDetail(int shipmentId, int splitShipmentId)
        {
            LGDetailDs dataSet = new LGDetailDs();
            IDataSetAdapter ad = getDataSetAdapter("LGDetailApt", "GetLGDetail");
            ad.SelectCommand.Parameters["@shipmentId"].Value = shipmentId;
            ad.SelectCommand.Parameters["@splitShipmentId"].Value = splitShipmentId;
            ad.SelectCommand.DbCommand.CommandTimeout = 120;

            dataSet.EnforceConstraints = false;
            int recordsAffected = ad.Fill(dataSet);
            if (recordsAffected > 0)
                return (int)(dataSet.Tables[0].Rows[0][0]);
            else
                return recordsAffected;

        }

        public LetterOfGuaranteeDef getLetterOfGuaranteeByKey(int key)
        {
            IDataSetAdapter ad = getDataSetAdapter("LetterOfGuaranteeApt", "GetLetterOfGuaranteeByKey");
            ad.SelectCommand.Parameters["@LGId"].Value = key;
            ad.SelectCommand.DbCommand.CommandTimeout = 120;

            LetterOfGuaranteeDs dataSet = new LetterOfGuaranteeDs();
            int recordsAffected = ad.Fill(dataSet);

            if (recordsAffected < 1) return null;

            LetterOfGuaranteeDef def = new LetterOfGuaranteeDef();
            LetterOfGuaranteeMapping(dataSet.LetterOfGuarantee[0], def);

            return def;
        }

        private void LetterOfGuaranteeMapping(Object source, Object target)
        {
            if (source.GetType() == typeof(LetterOfGuaranteeDs.LetterOfGuaranteeRow) &&
                target.GetType() == typeof(LetterOfGuaranteeDef))
            {
                LetterOfGuaranteeDs.LetterOfGuaranteeRow row = (LetterOfGuaranteeDs.LetterOfGuaranteeRow)source;
                LetterOfGuaranteeDef def = (LetterOfGuaranteeDef)target;

                def.LGId = row.LGId;
                def.LGNo = row.LGNo;
                def.LGDate = row.LGDate;
                def.OfficeId = row.OfficeId;
                def.VendorId = row.VendorId;
                if (!row.IsUploadedByNull())
                    def.UploadedBy = row.UploadedBy;
                if (!row.IsUploadedDateNull())
                    def.UploadedDate = row.UploadedDate;
                if (!row.IsSubmittedByNull())
                    def.SubmittedBy = row.SubmittedBy;
                if (!row.IsSubmittedDateNull())
                    def.SubmittedDate = row.SubmittedDate;
                if (!row.IsRemarkNull())
                    def.Remark = row.Remark;
                else
                    def.Remark = string.Empty;
                def.Status = row.Status;
                def.CreatedBy = row.CreatedBy;
                def.CreatedOn = row.CreatedOn;
                if (!row.IsModifiedByNull())
                    def.ModifiedBy = row.ModifiedBy;
                if (!row.IsModifiedOnNull())
                    def.ModifiedOn = row.ModifiedOn;
            }
        }

        public ARCustomerDef getARCustomerByCode(string code)
        {
            IDataSetAdapter ad = getDataSetAdapter("ARCustomerApt", "GetARCustomerByCode");
            ad.SelectCommand.Parameters["@EpicorCode"].Value = code;
            ARCustomerDs dataSet = new ARCustomerDs();
            ARCustomerDef def = null;

            ad.SelectCommand.DbCommand.CommandTimeout = 120;
            int recordsAffected = ad.Fill(dataSet);
            if (recordsAffected > 0)
            {
                ARCustomerDs.ARCustomerRow row = dataSet.ARCustomer[0];
                def = new ARCustomerDef();
                this.ARCustomerDefMapping(row, def);
            }
            return def;
        }

        private void ARCustomerDefMapping(Object source, Object target)
        {
            if (source.GetType() == typeof(ARCustomerDs.ARCustomerRow) &&
                target.GetType() == typeof(ARCustomerDef))
            {
                ARCustomerDs.ARCustomerRow row = (ARCustomerDs.ARCustomerRow)source;
                ARCustomerDef def = (ARCustomerDef)target;

                def.CustomerId = row.CustomerId;
                def.EpicorCode = row.EpicorCode;
                def.Name = row.Name;
                if (!row.IsAddr1Null())
                    def.Addr1 = row.Addr1;
                else
                    def.Addr1 = string.Empty;
                if (!row.IsAddr2Null())
                    def.Addr2 = row.Addr2;
                else
                    def.Addr2 = string.Empty;
                if (!row.IsAddr3Null())
                    def.Addr3 = row.Addr3;
                else
                    def.Addr3 = string.Empty;
                if (!row.IsAddr4Null())
                    def.Addr4 = row.Addr4;
                else
                    def.Addr4 = string.Empty;
            }
            else if (source.GetType() == typeof(ARCustomerDef) &&
                target.GetType() == typeof(ARCustomerDs.ARCustomerRow))
            {
                ARCustomerDef def = (ARCustomerDef)source;
                ARCustomerDs.ARCustomerRow row = (ARCustomerDs.ARCustomerRow)target;

                row.CustomerId = def.CustomerId;
                row.EpicorCode = def.EpicorCode;
                row.Name = def.Name;
                if (def.Addr1.Trim() == string.Empty)
                    row.Addr1 = def.Addr1;
                else
                    row.SetAddr1Null();
                if (def.Addr2.Trim() == string.Empty)
                    row.Addr2 = def.Addr2;
                else
                    row.SetAddr2Null();
                if (def.Addr3.Trim() == string.Empty)
                    row.Addr3 = def.Addr3;
                else
                    row.SetAddr3Null();
                if (def.Addr4.Trim() == string.Empty)
                    row.Addr4 = def.Addr1;
                else
                    row.SetAddr4Null();
            }

        }

        public void updateGenericDCNote(GenericDCNoteDef def, int userId, out string dcNoteNo)
        {
            if (def == null || userId == 0)
            {
                dcNoteNo = string.Empty;
                return;
            }

            TransactionContext ctx = TransactionContextFactory.GetContext(TransactionAffinity.Required);

            try
            {
                ctx.Enter();
                TransactionContext currentCtx = TransactionContextFactory.GetCurrentContext();

                GenericDCNoteDs dataSet = new GenericDCNoteDs();
                GenericDCNoteDs.GenericDCNoteRow row = null;
                IDataSetAdapter ad = getDataSetAdapter("GenericDCNoteApt", "GetGenericDCNoteByKey");
                ad.SelectCommand.Parameters["@DCNoteId"].Value = def.DCNoteId;
                ad.PopulateCommands();

                int recordsAffected = ad.Fill(dataSet);

                if (recordsAffected > 0)
                {
                    row = dataSet.GenericDCNote[0];
                    this.GenericDCNoteMapping(def, row);
                    sealStamp(row, userId, Stamp.UPDATE);
                    dcNoteNo = string.Empty;
                }
                else
                {
                    row = dataSet.GenericDCNote.NewGenericDCNoteRow();
                    def.DCNoteId = getMaxGenericDCNoteId() + 1;
                    def.DCNoteNo = fillNextAdjustmentNoteNo(AdjustmentType.OTHER_CHARGE, def.DCNoteDate, def.OfficeId, def.DebitCreditIndicator);
                    this.GenericDCNoteMapping(def, row);
                    sealStamp(row, userId, Stamp.INSERT);
                    dataSet.GenericDCNote.AddGenericDCNoteRow(row);
                    dcNoteNo = row.DCNoteNo;
                }

                recordsAffected = ad.Update(dataSet);
                if (recordsAffected < 1)
                    throw new DataAccessException("UpdateUKClaim ERROR");

                ctx.VoteCommit();
            }
            catch (Exception e)
            {
                Console.WriteLine("ERROR " + e.Message);
                ctx.VoteRollback();
                throw e;
            }
            finally
            {
                ctx.Exit();
            }
        }

        public GenericDCNoteDef getGenericDCNoteById(int id)
        {
            IDataSetAdapter ad = getDataSetAdapter("GenericDCNoteApt", "GetGenericDCNoteByKey");
            ad.SelectCommand.Parameters["@DCNoteId"].Value = id;
            GenericDCNoteDs dataSet = new GenericDCNoteDs();
            GenericDCNoteDef def = null;

            ad.SelectCommand.DbCommand.CommandTimeout = 120;
            int recordsAffected = ad.Fill(dataSet);
            if (recordsAffected > 0)
            {
                GenericDCNoteDs.GenericDCNoteRow row = dataSet.GenericDCNote[0];
                def = new GenericDCNoteDef();
                this.GenericDCNoteMapping(row, def);
            }
            return def;
        }

        public GenericDCNoteDef getGenericDCNoteByNoteNo(string dcNoteNo)
        {
            IDataSetAdapter ad = getDataSetAdapter("GenericDCNoteApt", "GetGenericDCNoteByNoteNo");
            ad.SelectCommand.Parameters["@DCNoteNo"].Value = dcNoteNo;
            GenericDCNoteDs dataSet = new GenericDCNoteDs();
            GenericDCNoteDef def = null;

            ad.SelectCommand.DbCommand.CommandTimeout = 120;
            int recordsAffected = ad.Fill(dataSet);
            if (recordsAffected > 0)
            {
                GenericDCNoteDs.GenericDCNoteRow row = dataSet.GenericDCNote[0];
                def = new GenericDCNoteDef();
                this.GenericDCNoteMapping(row, def);
            }
            return def;
        }


        private int getMaxGenericDCNoteId()
        {
            IDataSetAdapter ad = getDataSetAdapter("GenericDCNoteApt", "GetMaxGenericDCNoteId");
            DataSet dataSet = new DataSet();
            int recordsAffected = ad.Fill(dataSet);
            if (Convert.IsDBNull(dataSet.Tables[0].Rows[0][0]))
                return 0;
            else
                return (int)(dataSet.Tables[0].Rows[0][0]);
        }

        private void GenericDCNoteMapping(Object source, Object target)
        {
            if (source.GetType() == typeof(GenericDCNoteDs.GenericDCNoteRow) &&
                target.GetType() == typeof(GenericDCNoteDef))
            {
                GenericDCNoteDs.GenericDCNoteRow row = (GenericDCNoteDs.GenericDCNoteRow)source;
                GenericDCNoteDef def = (GenericDCNoteDef)target;

                def.DCNoteId = row.DCNoteId;
                def.DCNoteNo = row.DCNoteNo;
                def.DCNoteDate = row.DCNoteDate;
                def.IssueTypeId = row.IssueTypeId;
                def.OfficeId = row.OfficeId;
                if (!row.IsVendorIdNull())
                    def.VendorId = row.VendorId;
                else
                    def.VendorId = -1;
                if (!row.IsNTVendorIdNull())
                    def.NTVendorId = row.NTVendorId;
                else
                    def.NTVendorId = -1;
                if (!row.IsCustomerCodeNull())
                    def.CustomerCode = row.CustomerCode;
                else
                    def.CustomerCode = string.Empty;
                if (!row.IsGLCodeNull())
                    def.GLCode = row.GLCode;
                else
                    def.GLCode = string.Empty;
                def.OriginalCurrencyId = row.OriginalCurrencyId;
                def.OriginalAmount = row.OriginalAmount;
                def.BillingCurrencyId = row.BillingCurrencyId;
                def.Amount = row.Amount;
                def.DebitCreditIndicator = row.DebitCreditIndicator;
                def.PartyName = row.PartyName;
                if (!row.IsPartyAddress1Null())
                    def.PartyAddress1 = row.PartyAddress1;
                else
                    def.PartyAddress1 = string.Empty;
                if (!row.IsPartyAddress2Null())
                    def.PartyAddress2 = row.PartyAddress2;
                else
                    def.PartyAddress2 = string.Empty;
                if (!row.IsPartyAddress3Null())
                    def.PartyAddress3 = row.PartyAddress3;
                else
                    def.PartyAddress3 = string.Empty;
                if (!row.IsPartyAddress4Null())
                    def.PartyAddress4 = row.PartyAddress4;
                else
                    def.PartyAddress4 = string.Empty;
                def.Description = row.Description;
                def.COA = row.COA;
                if (!row.IsRemarkNull())
                    def.Remark = row.Remark;
                else
                    def.Remark = string.Empty;
                def.IsInterfaced = row.IsInterfaced;
                def.MailStatus = row.MailStatus;
                if (!row.IsSettlementDateNull())
                    def.SettlementDate = row.SettlementDate;
                def.PaymentOfficeId = row.PaymentOfficeId;
                def.Status = row.Status;
                if (!row.IsAttnNull())
                    def.Attn = row.Attn;
                else
                    def.Attn = string.Empty;
            }
            else if (source.GetType() == typeof(GenericDCNoteDef) &&
                target.GetType() == typeof(GenericDCNoteDs.GenericDCNoteRow))
            {
                GenericDCNoteDef def = (GenericDCNoteDef)source;
                GenericDCNoteDs.GenericDCNoteRow row = (GenericDCNoteDs.GenericDCNoteRow)target;

                row.DCNoteId = def.DCNoteId;
                row.DCNoteNo = def.DCNoteNo;
                row.DCNoteDate = def.DCNoteDate;
                row.IssueTypeId = def.IssueTypeId;
                row.OfficeId = def.OfficeId;
                if (def.VendorId != -1)
                    row.VendorId = def.VendorId;
                else
                    row.SetVendorIdNull();
                if (def.NTVendorId != -1)
                    row.NTVendorId = def.NTVendorId;
                else
                    row.SetNTVendorIdNull();
                if (def.CustomerCode.Trim() != string.Empty)
                    row.CustomerCode = def.CustomerCode;
                else
                    row.SetCustomerCodeNull();
                if (def.GLCode.Trim() != string.Empty)
                    row.GLCode = def.GLCode;
                else
                    row.SetGLCodeNull();
                row.OriginalCurrencyId = def.OriginalCurrencyId;
                row.OriginalAmount = def.OriginalAmount;
                row.BillingCurrencyId = def.BillingCurrencyId;
                row.Amount = def.Amount;
                row.DebitCreditIndicator = def.DebitCreditIndicator;
                row.PartyName = def.PartyName;
                if (def.PartyAddress1.Trim() != string.Empty)
                    row.PartyAddress1 = def.PartyAddress1;
                else
                    row.SetPartyAddress1Null();
                if (def.PartyAddress2.Trim() != string.Empty)
                    row.PartyAddress2 = def.PartyAddress2;
                else
                    row.SetPartyAddress2Null();
                if (def.PartyAddress3.Trim() != string.Empty)
                    row.PartyAddress3 = def.PartyAddress3;
                else
                    row.SetPartyAddress3Null();
                if (def.PartyAddress4.Trim() != string.Empty)
                    row.PartyAddress4 = def.PartyAddress4;
                else
                    row.SetPartyAddress4Null();
                row.Description = def.Description;
                row.COA = def.COA;
                if (def.Remark.Trim() != string.Empty)
                    row.Remark = def.Remark;
                else
                    row.SetRemarkNull();
                row.IsInterfaced = def.IsInterfaced;
                row.MailStatus = def.MailStatus;
                if (def.SettlementDate != DateTime.MinValue)
                    row.SettlementDate = def.SettlementDate;
                else
                    row.SetSettlementDateNull();
                row.PaymentOfficeId = def.PaymentOfficeId;
                row.Status = def.Status;
                if (def.Attn.Trim() != string.Empty)
                    row.Attn = def.Attn;
                else
                    row.SetAttnNull();
            }
        }

        public ArrayList getNullImportStatusList()
        {
            IDataSetAdapter ad = getDataSetAdapter("EpicorUploadImportLogApt", "GetNullImportStatusList");
            EpicorUploadImportLogDs dataSet = new EpicorUploadImportLogDs();

            int recordsAffected = ad.Fill(dataSet);

            ArrayList list = new ArrayList();

            foreach (EpicorUploadImportLogDs.EpicorUploadImportLogRow row in dataSet.EpicorUploadImportLog)
            {
                EpicorUploadImportLogDef def = new EpicorUploadImportLogDef();
                EpicorUploadImportLogMapping(row, def);
                list.Add(def);
            }
            return list;
        }

        private void EpicorUploadImportLogMapping(Object source, Object target)
        {
            if (source.GetType() == typeof(EpicorUploadImportLogDs.EpicorUploadImportLogRow) &&
                   target.GetType() == typeof(EpicorUploadImportLogDef))
            {
                EpicorUploadImportLogDs.EpicorUploadImportLogRow row = (EpicorUploadImportLogDs.EpicorUploadImportLogRow)source;
                EpicorUploadImportLogDef def = (EpicorUploadImportLogDef)target;

                def.EpicorUploadImportLogId = row.EpicorUploadImportLogId;
                def.EpicorCompany = row.EpicorCompany;
                def.InterfaceModule = row.InterfaceModule;
                if (!row.IsNSSourceTypeNull())
                    def.NSSourceType = row.NSSourceType;
                if (!row.IsDocumentTypeNull())
                    def.DocumentType = row.DocumentType;
                if (!row.IsGroupIdNull())
                    def.GroupId = row.GroupId;
                def.OriginalFileName = row.OriginalFileName;
                if (!row.IsFileNameNull())
                    def.FileName = row.FileName;
                if (!row.IsLogFilePathNull())
                    def.LogFilePath = row.LogFilePath;
                def.UploadedOn = row.UploadedOn;
                if (!row.IsCompletedOnNull())
                    def.CompletedOn = row.CompletedOn;
                if (!row.IsUploadStatusNull())
                    def.UploadStatus = row.UploadStatus;
                if (!row.IsUploadRejectReasonNull())
                    def.UploadRejectReason = row.UploadRejectReason;
                if (!row.IsImportStatusNull())
                    def.ImportStatus = row.ImportStatus;
                def.Status = row.Status;
                def.CreatedOn = row.CreatedOn;
                def.CreatedBy = row.CreatedBy;
                if (!row.IsProcessQueueNull())
                    def.ProcessQueue = row.ProcessQueue;
            }
            else if (source.GetType() == typeof(EpicorUploadImportLogDef) &&
              target.GetType() == typeof(EpicorUploadImportLogDs.EpicorUploadImportLogRow))
            {
                EpicorUploadImportLogDs.EpicorUploadImportLogRow row = (EpicorUploadImportLogDs.EpicorUploadImportLogRow)target;
                EpicorUploadImportLogDef def = (EpicorUploadImportLogDef)source;

                row.EpicorUploadImportLogId = def.EpicorUploadImportLogId;
                row.EpicorCompany = def.EpicorCompany;
                row.InterfaceModule = def.InterfaceModule;
                if (!string.IsNullOrEmpty(def.NSSourceType))
                    row.NSSourceType = def.NSSourceType;
                else
                    row.SetNSSourceTypeNull();

                if (!string.IsNullOrEmpty(def.DocumentType))
                    row.DocumentType = def.DocumentType;
                else
                    row.SetDocumentTypeNull();
                if (!string.IsNullOrEmpty(def.GroupId))
                    row.GroupId = def.GroupId;
                else
                    row.SetGroupIdNull();

                row.OriginalFileName = def.OriginalFileName;

                if (!string.IsNullOrEmpty(def.FileName))
                    row.FileName = def.FileName;
                else
                    row.SetFileNameNull();
                if (!string.IsNullOrEmpty(def.LogFilePath))
                    row.LogFilePath = def.LogFilePath;
                else
                    row.SetLogFilePathNull();
                row.UploadedOn = def.UploadedOn;
                if (def.CompletedOn != DateTime.MinValue)
                    row.CompletedOn = def.CompletedOn;
                else
                    row.SetCompletedOnNull();
                if (!string.IsNullOrEmpty(def.UploadStatus))
                    row.UploadStatus = def.UploadStatus;
                else
                    row.SetUploadStatusNull();
                if (!string.IsNullOrEmpty(def.UploadRejectReason))
                    row.UploadRejectReason = def.UploadRejectReason;
                else
                    row.SetUploadRejectReasonNull();
                if (!string.IsNullOrEmpty(def.ImportStatus))
                    row.ImportStatus = def.ImportStatus;
                else
                    row.SetImportStatusNull();
                row.Status = def.Status;
                row.CreatedOn = def.CreatedOn;
                row.CreatedBy = def.CreatedBy;
                row.ProcessQueue = def.ProcessQueue;
            }
        }

    }
}
